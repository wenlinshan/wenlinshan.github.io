<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Beanæ³¨å…¥çš„å››ç§æ–¹å¼</title>
    <url>/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="Beanæ³¨å…¥çš„å››ç§æ–¹å¼"><a href="#Beanæ³¨å…¥çš„å››ç§æ–¹å¼" class="headerlink" title="Beanæ³¨å…¥çš„å››ç§æ–¹å¼"></a>Beanæ³¨å…¥çš„å››ç§æ–¹å¼</h1><h2 id="xml-æ–¹å¼"><a href="#xml-æ–¹å¼" class="headerlink" title="xml æ–¹å¼"></a>xml æ–¹å¼</h2><p>ä¾ç¨€è®°å¾—æœ€æ—©æ¥è§¦<code>Spring</code>çš„æ—¶å€™ï¼Œç”¨çš„è¿˜æ˜¯<code>SSH</code>æ¡†æ¶ï¼Œä¸çŸ¥é“å¤§å®¶å¯¹è¿™ä¸ªè¿˜æœ‰å°è±¡å—ï¼Ÿæ‰€æœ‰çš„<code>bean</code>çš„æ³¨å…¥å¾—ä¾é <code>xml</code>æ–‡ä»¶æ¥å®Œæˆã€‚</p>
<p>å®ƒçš„æ³¨å…¥æ–¹å¼åˆ†ä¸ºï¼š<code>set</code>æ–¹æ³•æ³¨å…¥ã€æ„é€ æ–¹æ³•æ³¨å…¥ã€å­—æ®µæ³¨å…¥ï¼Œè€Œæ³¨å…¥ç±»å‹åˆ†ä¸ºå€¼ç±»å‹æ³¨å…¥ï¼ˆ8ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼‰å’Œå¼•ç”¨ç±»å‹æ³¨å…¥ï¼ˆå°†ä¾èµ–å¯¹è±¡æ³¨å…¥ï¼‰ã€‚</p>
<p>ä»¥ä¸‹æ˜¯<code>set</code>æ–¹æ³•æ³¨å…¥çš„ç®€å•æ ·ä¾‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.vipwen.domain.Teacher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vipwen&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„å®ä½“ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>xmlæ–¹å¼å­˜åœ¨çš„ç¼ºç‚¹å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li><code>xml</code>æ–‡ä»¶é…ç½®èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ—¢è¦ç»´æŠ¤ä»£ç åˆè¦ç»´æŠ¤é…ç½®æ–‡ä»¶ï¼Œå¼€å‘æ•ˆç‡ä½ï¼›</li>
<li>é¡¹ç›®ä¸­é…ç½®æ–‡ä»¶è¿‡å¤šï¼Œç»´æŠ¤èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼›</li>
<li>ç¨‹åºç¼–è¯‘æœŸé—´æ— æ³•å¯¹é…ç½®é¡¹çš„æ­£ç¡®æ€§è¿›è¡ŒéªŒè¯ï¼Œåªèƒ½åœ¨è¿è¡ŒæœŸå‘ç°å¹¶ä¸”å‡ºé”™ä¹‹åä¸æ˜“æ’æŸ¥ï¼›</li>
<li>è§£æ<code>xml</code>æ—¶ï¼Œæ— è®ºæ˜¯å°†<code>xml</code>ä¸€æ¬¡æ€§è£…è¿›å†…å­˜ï¼Œè¿˜æ˜¯ä¸€è¡Œä¸€è¡Œè§£æï¼Œéƒ½ä¼šå ç”¨å†…å­˜èµ„æºï¼Œå½±å“æ€§èƒ½ã€‚</li>
</ol>
<h2 id="æ³¨è§£æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼"></a>æ³¨è§£æ–¹å¼</h2><p>éšç€<code>Spring</code>çš„å‘å±•ï¼Œ<code>Spring 2.5</code>å¼€å§‹å‡ºç°äº†ä¸€ç³»åˆ—æ³¨è§£ï¼Œé™¤äº†æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„@Controllerã€@Serviceã€@Repositoryã€@Component ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•äº†è§£ä¸‹ã€‚</p>
<h3 id="Configuration-Bean"><a href="#Configuration-Bean" class="headerlink" title="@Configuration + @Bean"></a>@Configuration + @Bean</h3><p>å½“æˆ‘ä»¬éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„<code>jar</code>åŒ…æ—¶ï¼Œå¯ä»¥ç”¨<code>@Bean</code>æ³¨è§£æ¥æ ‡æ³¨ï¼ŒåŒæ—¶éœ€è¦æ­é…<code>@Configuration</code>æ¥ä½¿ç”¨ã€‚</p>
<ul>
<li><code>@Configuration</code>ç”¨æ¥å£°æ˜ä¸€ä¸ªé…ç½®ç±»ï¼Œå¯ä»¥ç†è§£ä¸º<code>xml</code>çš„&#96;&#96;æ ‡ç­¾</li>
<li><code>@Bean</code> ç”¨æ¥å£°æ˜ä¸€ä¸ª<code>bean</code>ï¼Œå°†å…¶åŠ å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­ï¼Œå¯ä»¥ç†è§£ä¸º<code>xml</code>çš„&#96;&#96;æ ‡ç­¾</li>
</ul>
<p><strong>ç®€å•æ ·ä¾‹ï¼šå°† RedisTemplate æ³¨å…¥ Spring</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼</span></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// key</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">// æŒ‡å®šè¦åºåˆ—åŒ–çš„åŸŸ(field,get,set)ï¼Œè®¿é—®ä¿®é¥°ç¬¦(public,private,protected)</span></span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        <span class="comment">//value</span></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        redisTemplate.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><p>æˆ‘ä»¬åœ¨ç¿»çœ‹<code>Spring</code>æºç çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šçœ‹åˆ°<code>@Import</code>æ³¨è§£ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨æ¥å°†ç¬¬ä¸‰æ–¹<code>jar</code>åŒ…æ³¨å…¥<code>Spring</code>ï¼Œä½†æ˜¯å®ƒåªå¯ä»¥ä½œç”¨åœ¨<strong>ç±»</strong>ä¸Šã€‚</p>
<p>ä¾‹å¦‚åœ¨æ³¨è§£<code>EnableSpringConfigured</code>ä¸Šå°±åŒ…å«äº†<code>@Import</code>æ³¨è§£ï¼Œç”¨äºå°†<code>SpringConfiguredConfiguration</code>é…ç½®æ–‡ä»¶åŠ è½½è¿›<code>Spring</code>å®¹å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(SpringConfiguredConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableSpringConfigured &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Import</code>çš„<code>value</code>å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªä¸€ä¸ªæ³¨å…¥æ¯”è¾ƒç¹çï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ­é…<code>ImportSelector</code>æ¥å£æ¥ä½¿ç”¨ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(MySelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;org.springframework.data.redis.core.RedisTemplate&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>selectImports</code>æ–¹æ³•è¿”å›çš„æ•°ç»„å°±ä¼šé€šè¿‡<code>@Import</code>æ³¨è§£æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­ã€‚</p>
<p>æ— ç‹¬æœ‰å¶ï¼Œ<code>ImportBeanDefinitionRegistrar</code>æ¥å£ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ³¨å…¥<code>bean</code>çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(AspectJAutoProxyRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç‚¹å‡»<code>AspectJAutoProxyRegistrar</code>ç±»ï¼Œå‘ç°å®ƒå®ç°äº†<code>ImportBeanDefinitionRegistrar</code>æ¥å£ï¼Œå®ƒçš„<code>registerBeanDefinitions</code>æ–¹æ³•ä¾¿æ˜¯æ³¨å…¥<code>bean</code>çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒä¸‹ã€‚</p>
<p>å¦‚æœè§‰å¾—æºä»£ç æ¯”è¾ƒéš¾æ‡‚ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(value = &#123;MyImportBeanDefinitionRegistrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span><br><span class="line"><span class="params">                                        BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">            <span class="type">RootBeanDefinition</span> <span class="variable">tDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Teacher.class);</span><br><span class="line">            <span class="comment">// æ³¨å†Œ Beanï¼Œå¹¶æŒ‡å®šbeançš„åç§°å’Œç±»å‹</span></span><br><span class="line">            registry.registerBeanDefinition(<span class="string">&quot;teacher&quot;</span>, tDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±æŠŠ<code>Teacher</code>ç±»æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­äº†ã€‚</p>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><p>æåˆ°<code>FactoryBean</code>ï¼Œå°±ä¸å¾—ä¸ä¸<code>BeanFactory</code>æ¯”è¾ƒä¸€ç•ªã€‚</p>
<ul>
<li><code>BeanFactory</code> : æ˜¯ <code>Factory</code>ï¼Œ <code>IOC</code>å®¹å™¨æˆ–è€…å¯¹è±¡å·¥å‚ï¼Œæ‰€æœ‰çš„<code>Bean</code>éƒ½ç”±å®ƒè¿›è¡Œç®¡ç†</li>
<li><code>FactoryBean</code> : æ˜¯<code>Bean</code> ï¼Œæ˜¯ä¸€ä¸ªèƒ½äº§ç”Ÿæˆ–è€…ä¿®é¥°å¯¹è±¡ç”Ÿæˆçš„å·¥å‚ <code>Bean</code>ï¼Œå®ç°ä¸å·¥å‚æ¨¡å¼å’Œä¿®é¥°å™¨æ¨¡å¼ç±»ä¼¼</li>
</ul>
<p>é‚£ä¹ˆ<code>FactoryBean</code>æ˜¯å¦‚ä½•å®ç°<code>bean</code>æ³¨å…¥çš„å‘¢ï¼Ÿ</p>
<p>å…ˆå®šä¹‰å®ç°äº†<code>FactoryBean</code>æ¥å£çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeacherFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Teacher&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ­¤å·¥å‚ç®¡ç†çš„å¯¹è±¡å®ä¾‹</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Teacher <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Teacher</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ­¤ FactoryBean åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Teacher.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åé€šè¿‡ @Configuration + @Beançš„æ–¹å¼å°†<code>TeacherFactoryBean</code>åŠ å…¥åˆ°å®¹å™¨ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TeacherFactoryBean <span class="title function_">teacherFactoryBean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TeacherFactoryBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰å‘å®¹å™¨ä¸­æ³¨å…¥<code>Teacher</code>, è€Œæ˜¯ç›´æ¥æ³¨å…¥çš„<code>TeacherFactoryBean</code>ï¼Œç„¶åä»å®¹å™¨ä¸­æ‹¿<code>Teacher</code>è¿™ä¸ªç±»å‹çš„<code>bean</code>ï¼ŒæˆåŠŸè¿è¡Œã€‚</p>
<h2 id="BDRegistryPostProcessor"><a href="#BDRegistryPostProcessor" class="headerlink" title="BDRegistryPostProcessor"></a>BDRegistryPostProcessor</h2><p>çœ‹åˆ°è¿™ä¸ªæ¥å£ï¼Œä¸çŸ¥é“å¯¹äºç¿»çœ‹è¿‡<code>Spring</code>æºç çš„ä½ æ¥è¯´ç†Ÿä¸ç†Ÿæ‚‰ã€‚å¦‚æœä¸ç†Ÿæ‚‰çš„è¯è¯·å¾€ä¸‹çœ‹ï¼Œè¦æ˜¯ç†Ÿæ‚‰çš„è¯å°±å†çœ‹ä¸€éå§ğŸ˜ƒã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œbeanåˆ°springå®¹å™¨ä¸­</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BeanFactoryPostProcessor</code>æ¥å£æ˜¯<code>BeanFactory</code>çš„åç½®å¤„ç†å™¨ï¼Œæ–¹æ³•<code>postProcessBeanFactory</code>å¯¹<code>bean</code>çš„å®šä¹‰è¿›è¡Œæ§åˆ¶ã€‚ä»Šå¤©æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ï¼šå®ƒçš„å‚æ•°æ˜¯<code>BeanDefinitionRegistry</code>ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸<code>BeanDefinition</code>æ³¨å†Œç›¸å…³çš„ã€‚</p>
<p><img src="/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/0_jpg-43676f4ff0144f669b179cba83a80b61.jpg" alt="0_jpg"></p>
<p>é€šè¿‡è§‚å¯Ÿè¯¥ç±»ï¼Œæˆ‘ä»¬å‘ç°å®ƒé‡Œè¾¹åŒ…å«äº†<code>registerBeanDefinition</code>æ–¹æ³•ï¼Œè¿™ä¸ªä¸å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„å—ï¼Ÿä¸ºäº†èƒ½æ›´å¥½çš„ä½¿ç”¨è¯¥æ¥å£æ¥è¾¾åˆ°æ³¨å…¥<code>bean</code>çš„ç›®çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>Spring</code>æ˜¯å¦‚ä½•æ“ä½œæ­¤æ¥å£çš„ã€‚</p>
<p><img src="/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/1_jpg-2bc8a40570474895a3ada3f73ac531d4.jpg"></p>
<p>çœ‹ä¸‹<code>invokeBeanFactoryPostProcessors</code>æ–¹æ³•ï¼Œä¼šå‘ç°æ²¡æœ‰å®ç°<code>PriorityOrdered</code>å’Œ<code>Ordered</code>çš„<code>bean</code>ï¼ˆè¿™ç§è·Ÿæˆ‘ä»¬è‡ªå®šä¹‰çš„å®ç°ç±»æœ‰å…³ï¼‰ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">    ......</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥è¯¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanDefinitionRegistryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">    Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, </span></span><br><span class="line"><span class="params">    BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">        postProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°å®ç°äº†<code>BeanDefinitionRegistryPostProcessor</code>æ¥å£çš„<code>bean</code>ï¼Œå…¶<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰æ¥å£å®ç°è¯¥æ¥å£ï¼Œå®ƒçš„<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ä¹Ÿä¼šè¢«æ‰§è¡Œã€‚</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç ã€‚è‡ªå®šä¹‰æ¥å£å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¿‡ç¨‹ä¸­å…ˆæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">rootBeanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Teacher.class);</span><br><span class="line">        <span class="comment">//Teacher çš„å®šä¹‰æ³¨å†Œåˆ°springå®¹å™¨ä¸­</span></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;teacher&quot;</span>, rootBeanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¿‡ç¨‹ä¸­åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">    <span class="type">MyBeanDefinitionRegistryPostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBeanDefinitionRegistryPostProcessor</span>();</span><br><span class="line">    <span class="comment">//å°†è‡ªå®šä¹‰å®ç°ç±»åŠ å…¥ Spring å®¹å™¨</span></span><br><span class="line">    context.addBeanFactoryPostProcessor(postProcessor);</span><br><span class="line">    context.refresh();</span><br><span class="line">    <span class="type">Teacher</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Teacher.class);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨å¹¶æ‰“å°ç»“æœ</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">org.springframework.demo.model.Teacher@2473d930</span><br></pre></td></tr></table></figure>

<p>å‘ç°å·²ç»æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­äº†ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>ClickHouse ä¸­çš„å¸¸ç”¨èšåˆå‡½æ•°(åä¸€)</title>
    <url>/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0(%E5%8D%81%E4%B8%80)/</url>
    <content><![CDATA[<h1 id="ClickHouse-ä¸­çš„å¸¸ç”¨èšåˆå‡½æ•°-åä¸€"><a href="#ClickHouse-ä¸­çš„å¸¸ç”¨èšåˆå‡½æ•°-åä¸€" class="headerlink" title="ClickHouse ä¸­çš„å¸¸ç”¨èšåˆå‡½æ•°(åä¸€)"></a>ClickHouse ä¸­çš„å¸¸ç”¨èšåˆå‡½æ•°(åä¸€)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>è¿™æ¬¡æ¥è¯´ä¸€ä¸‹ ClickHouse ä¸­çš„èšåˆå‡½æ•°ï¼Œå› ä¸ºå’Œå…³ç³»å‹æ•°æ®åº“çš„ç›¸ä¼¼æ€§ï¼Œæœ¬æ¥èšåˆå‡½æ•°ä¸æ‰“ç®—è¯´çš„ï¼Œä½†æ˜¯ ClickHouse æä¾›äº†å¾ˆå¤šå…³ç³»å‹æ•°æ®åº“ä¸­æ²¡æœ‰çš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä»å¤´äº†è§£ä¸€ä¸‹ã€‚</strong></p>
<p><strong>countï¼šè®¡ç®—æ•°æ®çš„è¡Œæ•°ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</strong></p>
<ul>
<li><code>count(å­—æ®µ)ï¼šè®¡ç®—è¯¥å­—æ®µä¸­ä¸ä¸º Null çš„å…ƒç´ æ•°é‡</code></li>
<li><code>count()ã€count(*)ï¼šè®¡ç®—æ•°æ®é›†çš„æ€»è¡Œæ•°</code></li>
</ul>
<p><strong>æ‰€æœ‰å¦‚æœæŸä¸ªå­—æ®µä¸­ä¸åŒ…å« Nullï¼Œé‚£ä¹ˆå¯¹è¯¥å­—æ®µè¿›è¡Œ count å¾—åˆ°çš„ç»“æœå’Œ count()ã€count(*) æ˜¯ç›¸ç­‰çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(), <span class="built_in">count</span>(<span class="operator">*</span>), <span class="built_in">count</span>(product) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€count()â”€â”¬â”€count()â”€â”¬â”€count(product)â”€â”</span></span><br><span class="line"><span class="comment">â”‚    1349 â”‚    1349 â”‚           1349 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œå†æä¸€ä¸‹èšåˆå‡½æ•°ï¼Œèšåˆå‡½æ•°é’ˆå¯¹çš„æ˜¯å¤šè¡Œç»“æœé›†ï¼Œè€Œä¸æ˜¯æ•°ç»„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œå¾—åˆ°çš„æ˜¯ 1ï¼ŒåŸå› åœ¨äºè¿™é‡Œåªæœ‰ä¸€è¡Œæ•°æ®</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€count()â”€â”</span></span><br><span class="line"><span class="comment">â”‚       1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦‚æœå°†å…¶å±•å¼€çš„è¯ï¼Œé‚£ä¹ˆä¼šå¾—åˆ° 3ï¼Œå› ä¸ºå±•å¼€ä¹‹åå˜æˆäº† 3 è¡Œæ•°æ®</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(arrayJoin([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€count(arrayJoin([1, 2, 3]))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                           3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ä½¿ç”¨ count è®¡ç®—æŸä¸ªå­—æ®µçš„å…ƒç´ æ•°é‡æ—¶ï¼Œè¿˜å¯ä»¥è¿›è¡Œå»é‡ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="keyword">DISTINCT</span> product) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€uniqExact(product)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                  3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ ¹æ®è¿”å›çš„å­—æ®µåï¼Œæˆ‘ä»¬å‘ç° ClickHouse åœ¨åº•å±‚å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ uniqExact å‡½æ•°</span></span><br><span class="line"><span class="keyword">SELECT</span> uniqExact(product) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€uniqExact(product)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                  3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- ä¹Ÿå°±æ˜¯ count(DISTINCT) ç­‰ä»·äº uniqExact</span></span><br><span class="line"><span class="comment">-- ä¸è¿‡è¿˜æ˜¯å»ºè®®åƒå…³ç³»å‹æ•°æ®åº“é‚£æ ·ä½¿ç”¨ count(DISTINCT) æ¯”è¾ƒå¥½ï¼Œå› ä¸ºæ›´åŠ ä¹ æƒ¯</span></span><br></pre></td></tr></table></figure>

<p><strong>minã€maxã€sumã€avgï¼šè®¡ç®—æ¯ç»„æ•°æ®çš„æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ€»å’Œã€å¹³å‡å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">min</span>(amount), <span class="built_in">max</span>(amount), <span class="built_in">sum</span>(amount), <span class="built_in">avg</span>(amount) </span><br><span class="line"><span class="keyword">FROM</span> sales_data <span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€min(amount)â”€â”¬â”€max(amount)â”€â”¬â”€sum(amount)â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€avg(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚         547 â”‚        2788 â”‚      248175 â”‚ 1643.5430463576158 â”‚</span></span><br><span class="line"><span class="comment">â”‚         658 â”‚        2805 â”‚      252148 â”‚ 1669.8543046357615 â”‚</span></span><br><span class="line"><span class="comment">â”‚         613 â”‚        2803 â”‚      246198 â”‚ 1652.3355704697988 â”‚</span></span><br><span class="line"><span class="comment">â”‚         709 â”‚        2870 â”‚      256602 â”‚ 1699.3509933774835 â”‚</span></span><br><span class="line"><span class="comment">â”‚         599 â”‚        2869 â”‚      245029 â”‚ 1601.4967320261437 â”‚</span></span><br><span class="line"><span class="comment">â”‚         511 â”‚        2673 â”‚      252908 â”‚ 1686.0533333333333 â”‚</span></span><br><span class="line"><span class="comment">â”‚         564 â”‚        2710 â”‚      252057 â”‚ 1714.6734693877552 â”‚</span></span><br><span class="line"><span class="comment">â”‚         621 â”‚        2832 â”‚      251795 â”‚ 1701.3175675675675 â”‚</span></span><br><span class="line"><span class="comment">â”‚         642 â”‚        2803 â”‚      245904 â”‚ 1650.3624161073826 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªéèšåˆå‡½æ•° leastã€greatest ä¹Ÿæ¯”è¾ƒå®ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿçœ‹ä¸€å¼ å›¾å°±æ˜ç™½äº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0(%E5%8D%81%E4%B8%80)/1229382-20210905001842525-447267760.png" alt="img"></p>
<p><strong>æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> least(A, B), greatest(A, B) <span class="keyword">FROM</span> test_1;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€least(A, B)â”€â”¬â”€greatest(A, B)â”€â”</span></span><br><span class="line"><span class="comment">â”‚          11 â”‚             13 â”‚</span></span><br><span class="line"><span class="comment">â”‚           7 â”‚              8 â”‚</span></span><br><span class="line"><span class="comment">â”‚           5 â”‚              8 â”‚</span></span><br><span class="line"><span class="comment">â”‚          11 â”‚             15 â”‚</span></span><br><span class="line"><span class="comment">â”‚           9 â”‚             13 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜æ¥äº†ï¼Œå¦‚æœ ClickHouse æ²¡æœ‰æä¾› least å’Œ greatest è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•å®ç°æ­¤åŠŸèƒ½å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ arrayMapï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç”±äº arrayMap é’ˆå¯¹çš„æ˜¯æ•°ç»„ï¼Œä¸æ˜¯å¤šè¡Œç»“æœé›†ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ© groupArray å°†å¤šè¡Œç»“æœé›†è½¬æˆæ•°ç»„</span></span><br><span class="line"><span class="comment">-- å¦å¤–åœ¨æ¯”è¾ƒå¤§å°çš„æ—¶å€™ä¹Ÿè¦å°†ä¸¤ä¸ªå…ƒç´ ç»„åˆæˆæ•°ç»„ [x, y]ï¼Œç„¶åä½¿ç”¨ arrayMin æ¯”è¾ƒ</span></span><br><span class="line"><span class="comment">-- æˆ–è€…ä½¿ç”¨ least(x, y) ä¹Ÿå¯ä»¥å¯¹ä¸¤ä¸ªæ ‡é‡è¿›è¡Œæ¯”è¾ƒï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸ºäº†å®ç° leastï¼Œæ‰€ä»¥å°±ä¸ç”¨å®ƒäº†</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x, y <span class="operator">-</span><span class="operator">&gt;</span> arrayMin([x, y]), groupArray(A), groupArray(B)) arr <span class="keyword">FROM</span> test_1;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [11,7,5,11,9] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç»“æœç¡®å®å®ç°äº†ï¼Œä½†ç»“æœæ˜¯æ•°ç»„ï¼Œæˆ‘ä»¬è¿˜è¦å†å°†å…¶å±•å¼€æˆå¤šè¡Œ</span></span><br><span class="line"><span class="comment">-- è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ WITHï¼Œæ³¨æ„ WITH å­å¥é‡Œçš„æŸ¥è¯¢åªå¯ä»¥è¿”å›ä¸€è¡Œç»“æœé›†</span></span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> arrayMap(x, y <span class="operator">-</span><span class="operator">&gt;</span> arrayMin([x, y]), groupArray(A), groupArray(B)) <span class="keyword">FROM</span> test_1</span><br><span class="line">) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayJoin(arr);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayJoin(arr)â”€â”</span></span><br><span class="line"><span class="comment">â”‚             11 â”‚</span></span><br><span class="line"><span class="comment">â”‚              7 â”‚</span></span><br><span class="line"><span class="comment">â”‚              5 â”‚</span></span><br><span class="line"><span class="comment">â”‚             11 â”‚</span></span><br><span class="line"><span class="comment">â”‚              9 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šå°±å®ç°äº† leastï¼Œè‡³äº greatest ä¹Ÿæ˜¯åŒç†ã€‚é‚£ä¹ˆé™¤äº†ä½¿ç”¨æ•°ç»„çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ€ä¹ˆåšå‘¢ï¼Ÿå¦‚æœå°†è¿™ä¸ªé—®é¢˜çš„èƒŒæ™¯å†æ”¹æˆå…³ç³»å‹æ•°æ®åº“çš„è¯ï¼Œä½ ä¸€å®šèƒ½æƒ³åˆ°ï¼Œæ²¡é”™ï¼Œå°±æ˜¯ CASE WHENã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> A <span class="operator">&lt;</span> B <span class="keyword">THEN</span> A <span class="keyword">ELSE</span> B <span class="keyword">END</span> <span class="keyword">FROM</span> test_1;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiIf(less(A, B), A, B)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                        11 â”‚</span></span><br><span class="line"><span class="comment">â”‚                         7 â”‚</span></span><br><span class="line"><span class="comment">â”‚                         5 â”‚</span></span><br><span class="line"><span class="comment">â”‚                        11 â”‚</span></span><br><span class="line"><span class="comment">â”‚                         9 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ•´ä¸ªè¿‡ç¨‹æ˜¾ç„¶å˜å¾—ç®€å•äº†ï¼Œæ‰€ä»¥ä¹Ÿä¸è¦å¿˜è®°å…³ç³»å‹æ•°æ®åº“çš„è¯­æ³•åœ¨ ClickHouse ä¸­ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œå¦å¤–æˆ‘ä»¬çœ‹åˆ°è¿”å›çš„ç»“æœé›†çš„å­—æ®µåå« multiIfâ€¦ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ CASE WHENï¼Œä½†æ˜¯ ClickHouse åœ¨åº•å±‚ä¼šç»™è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨åŠŸèƒ½ä¸å˜çš„å‰æä¸‹ï¼Œå¯»æ‰¾ä¸€ä¸ªåœ¨ ClickHouse ä¸­æ•ˆç‡æ›´é«˜çš„æ›¿ä»£æ–¹æ¡ˆã€‚å› æ­¤ä½ ç›´æ¥ä½¿ç”¨ multiIfâ€¦ ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT multiIf(less(A, B), A, B) FROM test_1</span><br></pre></td></tr></table></figure>

<p><strong>è€Œè‡³äºä¸Šé¢çš„ multiIfï¼Œå®ƒçš„åŠŸèƒ½å’Œ CASE WHEN æ˜¯å®Œå…¨ç±»ä¼¼çš„ã€‚åªä¸è¿‡è¿™é‡Œä¸ªäººæœ‰ä¸€ç‚¹å»ºè®®ï¼Œæ—¢ç„¶ ClickHouse ä¼šè¿›è¡Œè¯­å¥çš„ä¼˜åŒ–ï¼Œé‚£ä¹ˆèƒ½ç”¨å…³ç³»å‹æ•°æ®åº“è¯­æ³•è§£å†³çš„é—®é¢˜ï¼Œå°±ç”¨å…³ç³»å‹æ•°æ®åº“è¯­æ³•å»è§£å†³ã€‚è¿™ä¹ˆåšçš„åŸå› ä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘ SQL è¯­å¥çš„å¯è¯»æ€§ï¼Œå› ä¸ºç›¸æ¯” ClickHouseï¼Œå¤§éƒ¨åˆ†äººå¯¹å…³ç³»å‹æ•°æ®åº“è¯­æ³•æ˜¾ç„¶æ›´ç†Ÿæ‚‰ä¸€äº›ã€‚å¦‚æœä½¿ç”¨è¿™é‡Œçš„ mulitIfâ€¦ï¼Œé‚£ä¹ˆå½“åˆ«äººé˜…è¯»æ—¶ï¼Œå¯èƒ½è¿˜è¦æŸ¥é˜…ä¸€ä¸‹ multiIf å‡½æ•°ã€æˆ–è€… mulitIf é‡Œé¢åˆè°ƒç”¨çš„ less å‡½æ•°æ˜¯åšä»€ä¹ˆçš„ï¼›ä½†å¦‚æœä½¿ç”¨ CASE WHENï¼Œç»å¯¹çš„ä¸€ç›®äº†ç„¶ã€‚</strong></p>
<p><strong>å½“ç„¶ä»¥ä¸Šåªæ˜¯ä¸ªäººçš„å»ºè®®ï¼Œå¦‚æœä½ å¯¹ ClickHouse çš„å‡½æ•°ç”¨çš„éå¸¸ 6ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥ä¸ä¼˜å…ˆä½¿ç”¨å…³ç³»å‹æ•°æ®åº“çš„è¯­æ³•ï¼Œä¸ç„¶è¿™äº›å‡½æ•°ä¸æ˜¯ç™½æŒæ¡äº†å—ã€‚</strong></p>
<p><strong>anyï¼šé€‰æ‹©æ¯ç»„æ•°æ®ä¸­ç¬¬ä¸€ä¸ªå‡ºç°çš„å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŒ‰ç…§ product, channel è¿›è¡Œåˆ†ç»„ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ±‚æ¯ç»„çš„æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ç­‰ç­‰</span></span><br><span class="line"><span class="comment">-- è€Œè¿™é‡Œçš„ any åˆ™è¡¨ç¤ºè·å–æ¯ç»„ç¬¬ä¸€ä¸ªå‡ºç°çš„å€¼</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">any</span>(amount) <span class="keyword">FROM</span> sales_data <span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€any(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        1864 â”‚</span></span><br><span class="line"><span class="comment">â”‚        1573 â”‚</span></span><br><span class="line"><span class="comment">â”‚         847 â”‚</span></span><br><span class="line"><span class="comment">â”‚        1178 â”‚</span></span><br><span class="line"><span class="comment">â”‚        1736 â”‚</span></span><br><span class="line"><span class="comment">â”‚         511 â”‚</span></span><br><span class="line"><span class="comment">â”‚         568 â”‚</span></span><br><span class="line"><span class="comment">â”‚        1329 â”‚</span></span><br><span class="line"><span class="comment">â”‚        1364 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ any çœ‹èµ·æ¥è²Œä¼¼æ²¡æœ‰å®é™…çš„æ„ä¹‰ï¼Œå› ä¸ºèšåˆä¹‹åæ¯ç»„ç¬¬ä¸€ä¸ªå‡ºç°çš„å€¼å¹¶ä¸ä¸€å®šèƒ½ä»£è¡¨ä»€ä¹ˆã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæƒ³é€‰æ‹©åˆ†ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªå€¼ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨ groupArray å˜æˆä¸€ä¸ªæ•°ç»„ï¼Œç„¶åå†é€šè¿‡ç´¢å¼•é€‰æ‹©å³å¯</span></span><br><span class="line"><span class="comment">-- å› ä¸ºæˆ‘ä»¬é€‰æ‹©çš„æ˜¯ç¬¬ 1 ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ­¤æ—¶ç­‰ä»·äº any</span></span><br><span class="line"><span class="keyword">SELECT</span> groupArray(amount)[<span class="number">1</span>] <span class="keyword">FROM</span> sales_data </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(groupArray(amount), 1)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                1864 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                1573 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 847 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                1178 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                1736 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 511 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 568 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                1329 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                1364 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³åˆ†ç»„ä¹‹åé€‰æ‹©ï¼Œé€‰æ‹©æ¯ä¸ªç»„çš„æœ€å°å€¼è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šå†è°ƒç”¨ä¸€ä¸‹ arrayMin å³å¯</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayMin(groupArray(amount)) <span class="keyword">FROM</span> sales_data</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMin(groupArray(amount))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                          547 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          658 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          613 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          709 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          599 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          511 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          564 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          621 â”‚</span></span><br><span class="line"><span class="comment">â”‚                          642 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³åˆ†ç»„ä¹‹åé€‰æ‹©ï¼Œé€‰æ‹©æ¯ä¸ªç»„çš„ç¬¬ N å¤§çš„å€¼è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬é€‰æ‹©ç¬¬ 3 å¤§çš„å€¼ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä»å°åˆ°å¤§æ’ä¸ªåºå³å¯ï¼Œç„¶åé€‰æ‹©ç´¢å¼•ä¸º -3 çš„å…ƒç´ </span></span><br><span class="line"><span class="comment">-- æˆ–è€…ä»å¤§åˆ°å°æ’ä¸ªåºï¼Œç„¶åé€‰æ‹©ç´¢å¼•ä¸º 3 çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">SELECT</span> arraySort(groupArray(amount))[<span class="number">-2</span>] rank3_1, arrayReverseSort(groupArray(amount))[<span class="number">2</span>] rank3_2</span><br><span class="line"><span class="keyword">FROM</span> sales_data <span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€rank3_1â”€â”¬â”€rank3_2â”€â”</span></span><br><span class="line"><span class="comment">â”‚    2784 â”‚    2784 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2804 â”‚    2804 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2650 â”‚    2650 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2856 â”‚    2856 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2865 â”‚    2865 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2610 â”‚    2610 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2632 â”‚    2632 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2754 â”‚    2754 â”‚</span></span><br><span class="line"><span class="comment">â”‚    2694 â”‚    2694 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¡®å®ç»™äººä¸€ç§ pandas çš„æ„Ÿè§‰ï¼Œä¹‹å‰åšæ•°æ®åˆ†æä¸»è¦ç”¨ pandasã€‚ä½†æ˜¯ pandas æœ‰ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜ï¼Œå°±æ˜¯å®ƒè¦æ±‚æ•°æ®èƒ½å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥åœ¨å¤„ç†ä¸­å°å‹æ•°æ®é›†çš„æ—¶å€™ç¡®å®å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¯¹äºå¤§å‹æ•°æ®é›†å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œåªèƒ½å¦è¾Ÿè¹Šå¾„ã€‚ä½†æ˜¯ ClickHouse åˆ™æ˜¯é€šè¿‡åˆ†ç‰‡æœºåˆ¶æ”¯æŒåˆ†å¸ƒå¼è¿ç®—ï¼Œæ‰€ä»¥ä¸ªäººè§‰å¾—å®ƒç®€ç›´å°±æ˜¯åˆ†å¸ƒå¼çš„ pandasã€‚</strong></p>
<p><strong>varPopï¼šè®¡ç®—æ–¹å·®ï¼Œâˆ‘(xâˆ’x^)2nâˆ‘(ï¿½âˆ’ï¿½^)2ï¿½ï¼›stddevPopï¼šè®¡ç®—æ ‡å‡†å·®ï¼Œç­‰äºæ–¹å·®å¼€æ ¹å·</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> varPop(amount) v1, stddevPop(amount) v2, v2 <span class="operator">*</span> v2 </span><br><span class="line"><span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€â”€â”€â”€â”€â”€â”€v2â”€â”¬â”€multiply(stddevPop(amount), stddevPop(amount))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 269907.7 â”‚ 519.5264 â”‚                              269907.7096217908 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜æ¥äº†ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ‰‹åŠ¨å®ç°æ–¹å·®çš„è®¡ç®—è¯¥æ€ä¹ˆåŠï¼Ÿè¯•ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å°†ç»“æœé›†è½¬æˆæ•°ç»„ï¼Œå¹¶å…ˆè®¡ç®—å¥½å¹³å‡å€¼</span></span><br><span class="line"><span class="keyword">WITH</span> (<span class="keyword">SELECT</span> groupArray(amount) <span class="keyword">FROM</span> sales_data) <span class="keyword">AS</span> arr, </span><br><span class="line">      arraySum(arr) <span class="operator">/</span> length(arr) <span class="keyword">AS</span> amount_avg</span><br><span class="line"><span class="comment">-- é€šè¿‡ arrayMap å°†æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å’Œå¹³å‡å€¼åšå‡æ³•ï¼Œç„¶åå†å¹³æ–¹ï¼Œå¾—åˆ°æ–°æ•°ç»„</span></span><br><span class="line"><span class="comment">-- æœ€åå†ç”¨ arrayAvg å¯¹æ–°æ•°ç»„å–å¹³å‡å€¼ï¼Œå³å¯è®¡ç®—å‡ºæ–¹å·®</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayAvg(</span><br><span class="line">    arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> pow(x <span class="operator">-</span> amount_avg, <span class="number">2</span>), arr)</span><br><span class="line">) </span><br></pre></td></tr></table></figure>

<p><strong>covarPopï¼šè®¡ç®—åæ–¹å·®ï¼Œâˆ‘(xâˆ’x^)(yâˆ’y^)nâˆ‘(ï¿½âˆ’ï¿½^)(ï¿½âˆ’ï¿½^)ï¿½</strong></p>
<p><strong>æ¯”è¾ƒå°‘ç”¨ï¼Œè¿™é‡Œä¸æ¼”ç¤ºçš„äº†ï¼Œå¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p><strong>anyHeavyï¼šä½¿ç”¨ <a href="http://www.cs.umd.edu/~samir/498/karp.pdf">heavy hitters</a> ç®—æ³•é€‰æ‹©æ¯ç»„ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> anyHeavy(amount) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€anyHeavy(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚             2369 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>anyLastï¼šé€‰æ‹©æ¯ç»„ä¸­çš„æœ€åä¸€ä¸ªå€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> anyLast(amount) <span class="keyword">FROM</span> sales_data <span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€anyLast(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            1679 â”‚</span></span><br><span class="line"><span class="comment">â”‚            1767 â”‚</span></span><br><span class="line"><span class="comment">â”‚            2369 â”‚</span></span><br><span class="line"><span class="comment">â”‚            2660 â”‚</span></span><br><span class="line"><span class="comment">â”‚            2865 â”‚</span></span><br><span class="line"><span class="comment">â”‚            2422 â”‚</span></span><br><span class="line"><span class="comment">â”‚            1481 â”‚</span></span><br><span class="line"><span class="comment">â”‚            1439 â”‚</span></span><br><span class="line"><span class="comment">â”‚            2443 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŒæ ·å¯ä»¥å€ŸåŠ©æ•°ç»„å®ç°</span></span><br><span class="line"><span class="keyword">SELECT</span> groupArray(amount)[<span class="number">-1</span>] <span class="keyword">FROM</span> sales_data <span class="keyword">GROUP</span> <span class="keyword">BY</span> product, channel;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(groupArray(amount), -1)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                 1679 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 1767 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 2369 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 2660 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 2865 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 2422 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 1481 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 1439 â”‚</span></span><br><span class="line"><span class="comment">â”‚                                 2443 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>argMinï¼šæ¥æ”¶ä¸¤ä¸ªåˆ—ï¼Œæ ¹æ®å¦ä¸€ä¸ªåˆ—é€‰æ‹©å½“å‰åˆ—çš„æœ€å°å€¼ï¼Œæˆ‘ä»¬ç”»ä¸€å¼ å›¾ï¼Œé€šè¿‡å’Œ min è¿›è¡Œæ¯”å¯¹ï¼Œå°±èƒ½çœ‹å‡ºå®ƒçš„ç”¨æ³•äº†</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">Null</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> has(arr, <span class="number">2</span>), has(arr, <span class="number">0</span>), has(arr, <span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€has(arr, 2)â”€â”¬â”€has(arr, 0)â”€â”¬â”€has(arr, NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           1 â”‚           0 â”‚              1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åµŒå¥—æ•°ç»„ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="keyword">SELECT</span> has([[<span class="number">1</span>, <span class="number">2</span>]], [<span class="number">1</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€has([[1, 2]], [1, 2])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                     1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0(%E5%8D%81%E4%B8%80)/1229382-20210905001849615-383206319.png" alt="img"></p>
<p><strong>é¦–å…ˆ min(A) å’Œ min(B) åˆ†åˆ«è¿”å› 5 å’Œ 7 æ— éœ€è§£é‡Šï¼Œè€Œ argMin(A, B) è¡¨ç¤ºæ ¹æ® B çš„æœ€å°å€¼é€‰æ‹© Aï¼ŒB çš„æœ€å°å€¼æ˜¯ 7ï¼Œå¯¹åº” A å°±æ˜¯ 8ï¼›åŒç† argMin(B, A) è¡¨ç¤ºæ ¹æ® A çš„æœ€å°å€¼é€‰æ‹© Bï¼ŒA çš„æœ€å°å€¼æ˜¯ 5ï¼Œå¯¹åº” B å°±æ˜¯ 8ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ argMinï¼ŒåŒç†è¿˜æœ‰ argMaxã€‚</strong></p>
<p><strong>topKï¼šé€‰æ‹©å‡ºç°é¢‘ç‡æœ€é«˜çš„ K ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œé€‰æ‹©å‡ºç°é¢‘ç‡æœ€é«˜çš„ä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="keyword">SELECT</span> topK(<span class="number">2</span>)(arrayJoin([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>]));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€topK(2)(arrayJoin([1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3]))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,3]                                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°ä»¥æ•°ç»„çš„å½¢å¼è¿”å›ï¼Œå› ä¸ºèšåˆå‡½æ•°æœ€ç»ˆæ¯ä¸ªç»„åªä¼šå¯¹åº”ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥å¾—åˆ°çš„æ˜¯æ•°ç»„ã€‚</strong></p>
<p><strong>topK ä¹Ÿæ˜¯éå¸¸å¸¸è§çš„ï¼Œå¦‚æœè®©æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œè™½ç„¶å¯ä»¥åšåˆ°ï¼Œä½†ä¼šæ¯”è¾ƒéº»çƒ¦ï¼ŒClickHouse æ›¿æˆ‘ä»¬è€ƒè™‘çš„è¿˜æ˜¯å¾ˆå‘¨åˆ°çš„ã€‚</strong></p>
<p><strong>groupArrayMovingSumï¼šæ»‘åŠ¨çª—å£ï¼Œæ¯ä¸ªçª—å£å†…çš„æ•°æ®è¿›è¡Œç´¯å’Œã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> groupArray(number), groupArrayMovingSum(<span class="number">4</span>)(number)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArray(number)â”€â”€â”€â”€â”¬â”€groupArrayMovingSum(4)(number)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,4,5,6,7,8,9] â”‚ [0,1,3,6,10,14,18,22,26,30]    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ç”»ä¸€å¼ å›¾ï¼Œæ¥è§£é‡Šä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0(%E5%8D%81%E4%B8%80)/1229382-20210905001856948-1721448098.png" alt="img"></p>
<p><strong>é¦–å…ˆ groupArrayMovingSum(4) è¡¨ç¤ºçª—å£çš„é•¿åº¦ä¸º 4ï¼Œç„¶åä¸æ–­çš„å‘ä¸‹æ»‘åŠ¨ï¼Œè®¡ç®—åŒ…å«å½“å‰å…ƒç´ åœ¨å†…å¾€ä¸Šçš„å››ä¸ªå…ƒç´ ä¹‹å’Œã€‚å¦‚æœå…ƒç´ çš„ä¸ªæ•°ä¸å¤Ÿçª—å£çš„é•¿åº¦ï¼Œé‚£ä¹ˆæœ‰å‡ ä¸ªç®—å‡ ä¸ªï¼Œæ¯”å¦‚å‰ä¸‰ä¸ªå…ƒç´ ã€‚</strong></p>
<p><strong>é‚£ä¹ˆè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœçª—å£é•¿åº¦ç­‰äºæ•°ç»„çš„é•¿åº¦ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸æŒ‡å®šçª—å£é•¿åº¦ï¼Œé‚£ä¹ˆçª—å£é•¿åº¦å°±ç­‰äºæ•°ç»„é•¿åº¦</span></span><br><span class="line"><span class="keyword">SELECT</span> groupArray(number), groupArrayMovingSum(number)</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArray(number)â”€â”€â”€â”€â”¬â”€groupArrayMovingSum(number)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,4,5,6,7,8,9] â”‚ [0,1,3,6,10,15,21,28,36,45] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- æ˜¾ç„¶ç›¸å½“äºè¿›è¡Œäº†ç´¯å’Œ</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿™å°±æ˜¯ ClickHouse æä¾›çš„çª—å£å‡½æ•°ï¼Œä½†å…³ç³»å‹æ•°æ®åº“ä¸­çš„çª—å£å‡½æ•°è¯­æ³•åœ¨ ClickHouse è¿˜æ²¡æœ‰å¾—åˆ°å®Œç¾çš„æ”¯æŒï¼Œä½†å¾ˆæ˜æ˜¾é€šè¿‡è¿™äº›å¼ºå¤§çš„å‡½æ•°æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚</strong></p>
<p><strong>é™¤äº† groupArrayMovingSum ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª groupArrayMovingAvgï¼Œç”¨æ³•å®Œå…¨ä¸€æ ·ï¼Œåªä¸è¿‡è®¡ç®—çš„æ˜¯å¹³å‡å€¼ï¼Œè¿™é‡Œå°±ä¸å•ç‹¬è¯´äº†ã€‚</strong></p>
<p><strong>groupArraySampleï¼šéšæœºé€‰æ‹© N ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- éšæœºé€‰æ‹© 3 ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="keyword">SELECT</span> groupArraySample(<span class="number">3</span>)(amount) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArraySample(3)(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1268,2246,1606]            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬è¿˜å¯ä»¥ç»‘å®šä¸€ä¸ªéšæœºç§å­ï¼Œå¦‚æœç§å­ä¸€æ ·ï¼Œé‚£ä¹ˆæ¯æ¬¡éšæœºé€‰æ‹©çš„æ•°æ®ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> groupArraySample(<span class="number">3</span>, <span class="number">666</span>)(amount) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArraySample(3, 666)(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [635,1290,1846]                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> groupArraySample(<span class="number">3</span>, <span class="number">666</span>)(amount) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArraySample(3, 666)(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [635,1290,1846]                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> groupArraySample(<span class="number">3</span>, <span class="number">661</span>)(amount) <span class="keyword">FROM</span> sales_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArraySample(3, 661)(amount)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2011,2125,1542]                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>deltaSumï¼šå¯¹ç›¸é‚»çš„è¡Œè¿›è¡Œåšå·®ï¼Œç„¶åæ±‚å’Œï¼Œæ³¨æ„ï¼šå°äº 0 ä¸ä¼šè®¡ç®—åœ¨å†…</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 3 - 1 = 2</span></span><br><span class="line"><span class="comment">-- 4 - 3 = 1</span></span><br><span class="line"><span class="comment">-- 1 - 4 = -3</span></span><br><span class="line"><span class="comment">-- 8 - 1 = 7</span></span><br><span class="line"><span class="comment">-- æ‰€ä»¥ç»“æœä¸º 2 + 1 + 7</span></span><br><span class="line"><span class="keyword">SELECT</span> deltaSum(arrayJoin([<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">8</span>]));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€deltaSum(arrayJoin([1, 3, 4, 1, 8]))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                   10 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>ä»¥ä¸Šå°±æ˜¯å…³äº ClickHouse çš„ä¸€äº›èšåˆå‡½æ•°ï¼Œè¿˜æœ‰ç›¸å½“ä¸€éƒ¨åˆ†æ²¡æœ‰ä»‹ç»åˆ°ï¼Œä¸»è¦æ˜¯è§‰å¾—åº”ç”¨çš„åœºæ™¯éå¸¸å°‘è§ï¼Œåç»­å†è¡¥å……ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse ä¸­å…¶å®ƒå¸¸è§çš„è¡¨å¼•æ“(å…«)</title>
    <url>/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/</url>
    <content><![CDATA[<h1 id="ClickHouse-ä¸­å…¶å®ƒå¸¸è§çš„è¡¨å¼•æ“-å…«"><a href="#ClickHouse-ä¸­å…¶å®ƒå¸¸è§çš„è¡¨å¼•æ“-å…«" class="headerlink" title="ClickHouse ä¸­å…¶å®ƒå¸¸è§çš„è¡¨å¼•æ“(å…«)"></a>ClickHouse ä¸­å…¶å®ƒå¸¸è§çš„è¡¨å¼•æ“(å…«)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>Everything is tableï¼ˆä¸‡ç‰©çš†ä¸ºè¡¨ï¼‰æ˜¯ ClickHouse çš„ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„è®¾è®¡æ€è·¯ï¼Œæ­£å› ä¸º ClickHouse æ˜¯ä¸€æ¬¾æ•°æ®åº“ï¼Œæ‰€ä»¥è‡ªç„¶è€Œç„¶æ•°æ®è¡¨å°±æ˜¯å®ƒçš„æ­¦å™¨ï¼Œæ˜¯å®ƒä¸å¤–éƒ¨è¿›è¡Œäº¤äº’çš„æ¥å£å±‚ã€‚åœ¨æ•°æ®è¡¨èƒŒåæ— è®ºè¿æ¥çš„æ˜¯æœ¬åœ°æ–‡ä»¶ã€HDFSã€zookeeperï¼Œè¿˜æ˜¯å…¶å®ƒæœåŠ¡ï¼Œç»ˆç«¯ç”¨æˆ·åªéœ€è¦é¢å¯¹æ•°æ®è¡¨ï¼Œåªéœ€è¦ä½¿ç”¨ SQL æŸ¥è¯¢è¯­è¨€ã€‚</strong></p>
<p><strong>ä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹å…¶å®ƒç±»å‹çš„è¡¨å¼•æ“ï¼Œå®ƒä»¬ä»¥è¡¨ä¸ºæ¥å£ï¼Œæå¤§åœ°ä¸°å¯Œäº† ClickHouse çš„æŸ¥è¯¢èƒ½åŠ›ã€‚è¿™äº›è¡¨å¼•æ“å„è‡ªç‰¹ç‚¹çªå‡ºï¼Œæˆ–æ˜¯ç‹¬ç«‹åœ°åº”ç”¨äºç‰¹å®šåœºæ™¯ï¼Œæˆ–æ˜¯èƒ½å¤Ÿä¸ MergeTree æ­é…ä½¿ç”¨ã€‚ä¾‹å¦‚å¤–éƒ¨å­˜å‚¨ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œèƒ½å¤Ÿç›´æ¥è¯»å–å…¶å®ƒç³»ç»Ÿçš„æ•°æ®ï¼ŒClickHouse è‡ªèº«åªè´Ÿè´£å…ƒæ•°æ®çš„ç®¡ç†ï¼Œç±»ä¼¼ä½¿ç”¨å¤–éƒ¨è¡¨çš„å½¢å¼ï¼›å†…å­˜ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œèƒ½å¤Ÿå……å½“æ•°æ®åˆ†å‘çš„ä¸´æ—¶å­˜å‚¨è½½ä½“æˆ–æ¶ˆæ¯é€šé“ï¼›æ—¥å¿—æ–‡ä»¶ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œæ‹¥æœ‰ç®€å•æ˜“ç”¨çš„ç‰¹ç‚¹ï¼›æ¥å£ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œèƒ½å¤Ÿä¸²è”å·²æœ‰æ•°æ®è¡¨ï¼Œèµ·åˆ°ç²˜åˆå‰‚çš„ä½œç”¨ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†é—¨åˆ«ç±»çš„ä»‹ç»ä¸€ä¸‹ï¼Œè¿™äº›è¡¨å¼•æ“å„è‡ªçš„ä½¿ç”¨ç‰¹ç‚¹ã€‚</strong></p>
<h3 id="å¤–éƒ¨å­˜å‚¨ç±»å‹"><a href="#å¤–éƒ¨å­˜å‚¨ç±»å‹" class="headerlink" title="å¤–éƒ¨å­˜å‚¨ç±»å‹"></a>å¤–éƒ¨å­˜å‚¨ç±»å‹</h3><p><strong>é¡¾åæ€ä¹‰ï¼Œå¤–éƒ¨å­˜å‚¨è¡¨å¼•æ“èƒ½å¤Ÿç›´æ¥ä»å…¶å®ƒçš„å­˜å‚¨ç³»ç»Ÿè¯»å–æ•°æ®ï¼Œä¾‹å¦‚ç›´æ¥è¯»å– HDFS çš„æ–‡ä»¶æˆ–è€… MySQL æ•°æ®åº“çš„è¡¨ï¼Œè¿™äº›è¡¨å¼•æ“åªè´Ÿè´£å…ƒæ•°æ®ç®¡ç†å’Œæ•°æ®æŸ¥è¯¢ï¼Œè€Œå®ƒä»¬è‡ªèº«é€šå¸¸ä¸è´Ÿè´£æ•°æ®çš„å†™å…¥ï¼Œæ•°æ®æ–‡ä»¶ç›´æ¥ç”±å¤–éƒ¨ç³»ç»Ÿæä¾›ã€‚</strong></p>
<h4 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h4><p><strong>HDFS æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥è¯´æ˜¯ Hadoop ç”Ÿæ€çš„åŸºçŸ³ï¼Œè€Œ ClickHouse æä¾›çš„ HDFS è¡¨å¼•æ“åˆ™å¯ä»¥ä¸ä¹‹å¯¹æ¥ï¼Œè¯»å– HDFS å†…çš„æ–‡ä»¶ã€‚å…³äº HDFS çš„å®‰è£…è¿™é‡Œä¸èµ˜è¿°äº†ï¼Œè¿™é‡Œå‡è®¾å·²ç»å®‰è£…å®Œæ¯•ã€‚ä½†æ˜¯æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­ HDFS çš„ Kerberos è®¤è¯ï¼Œå› ä¸º HDFS è¡¨å¼•æ“è¿˜ä¸æ”¯æŒ Kerberosï¼Œç„¶ååœ¨ HDFS ä¸Šåˆ›å»ºç”¨äºå­˜æ”¾æ–‡ä»¶çš„ç›®å½•ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs dfs -mkdir /clickhouse</span><br></pre></td></tr></table></figure>

<p><strong>æœ€ååœ¨ HDFS ä¸Šç»™ clickhouse ç”¨æˆ·æˆæƒï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hdfs dfs -chown -R clickhouse:clickhouse /clickhouse</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæˆ‘ä»¬åˆ›å»º HDFS æ•°æ®è¡¨ï¼Œè€Œ ClickHouse çš„ä¸€å¼  HDFS æ•°æ®è¡¨ï¼Œå¯¹åº” HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hdfs_table1 (</span><br><span class="line">    id UInt32,</span><br><span class="line">    code String,</span><br><span class="line">    name String</span><br><span class="line">) ENGINE <span class="operator">=</span> HDFS(<span class="string">&#x27;hdfs://localhost:6666/clickhouse/hdfs_table1&#x27;</span>, <span class="string">&#x27;CSV&#x27;</span>)</span><br><span class="line"><span class="comment">-- HDFS(&#x27;HDFS çš„æ–‡ä»¶å­˜å‚¨è·¯å¾„&#x27;, &#x27;æ–‡ä»¶æ ¼å¼ï¼Œå¦‚ CSVã€TSVã€JSON ç­‰ç­‰&#x27;)</span></span><br><span class="line"><span class="comment">-- æ³¨ï¼šæ•°æ®è¡¨çš„åå­—å’Œ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶åå¯ä»¥ä¸ä¸€è‡´</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œè™½ç„¶åˆ›å»ºäº†ä¸€å¼ è¡¨ hdfs_table1ï¼Œä½† HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šè¿˜å¹¶æ²¡æœ‰ hdfs_table1 è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œå½“æˆ‘ä»¬å¾€è¡¨ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œè¡¨å¯¹åº”çš„æ–‡ä»¶å°±ä¼šåœ¨ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šåˆ›å»ºã€åŒæ—¶å°†æ•°æ®å†™è¿›å»ã€‚å› æ­¤æˆ‘ä»¬å†™å…¥æ•°æ®è™½ç„¶è¡¨é¢ä¸Šæ˜¯é€šè¿‡ HDFS æ•°æ®è¡¨ï¼Œä½†å®é™…ä¸Šæ•°æ®æ˜¯å­˜å‚¨åœ¨ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ï¼Œè€Œ ClickHouse åœ¨è¿™é‡Œåªè´Ÿè´£å…ƒæ•°æ®çš„ç®¡ç†ã€‚å¯èƒ½æœ‰äººå‘ç°äº†ï¼Œè¿™ä¸å°±æ˜¯ Hive å˜›ï¼Œæ˜¯çš„ï¼ŒClickHouse åœ¨è¿™é‡Œæ‰€å¹²çš„äº‹æƒ…å’Œ Hive æ˜¯ä¸€æ ·çš„ã€‚ä¸‹é¢å†™å…¥ä¸€æ‰¹æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> hdfs_table1 </span><br><span class="line"><span class="keyword">SELECT</span> number, concat(<span class="string">&#x27;code&#x27;</span>, toString(number)), concat(<span class="string">&#x27;n&#x27;</span>, toString(number))</span><br><span class="line"><span class="keyword">FROM</span> numbers(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶åœ¨ HDFS æ–‡ä»¶ç³»ç»Ÿçš„ &#x2F;clickhouse ä¸‹é¢ä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå« hdfs_table1ï¼ŒåŒæ—¶å°†æ•°æ®å†™è¿›å»ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ•°æ®è¡¨æŸ¥è¯¢ï¼Œæ³¨æ„ï¼šå› ä¸ºæ•°æ®å­˜åœ¨ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œæ‰€ä»¥æŸ¥è¯¢å®é™…ä¸Šå°±æ˜¯ ClickHouse è¯»å– HDFS æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªè¿‡ç¨‹ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002619076-698383201.png" alt="img"></p>
<p><strong>ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹ HDFS ä¸Šæ–‡ä»¶ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002626203-1247824117.png" alt="img"></p>
<p><strong>å¯ä»¥å‘ç°é€šè¿‡ HDFS è¡¨å¼•æ“ï¼ŒClickHouse åœ¨ HDFS çš„æŒ‡å®šç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ªåä¸º hdfs_table1 çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æŒ‰ç…§ CSV æ ¼å¼å†™å…¥äº†æ•°æ®ã€‚æ³¨æ„ï¼šè¿™é‡Œåˆ›å»ºçš„æ•°æ®è¡¨ç±»ä¼¼äº hive ä¸­çš„å¤–éƒ¨è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´å°† HDFS æ•°æ®è¡¨åˆ é™¤ï¼ˆåˆ é™¤å…ƒæ•°æ®ï¼‰ï¼Œå¹¶ä¸ä¼šå½±å“ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ ClickHouse å’Œ HDFS ä¹‹é—´çš„äº¤äº’ï¼Œä¸è¿‡æˆ‘ä»¬çŸ¥é“ ClickHouse å…·æœ‰åˆ†ç‰‡åŠŸèƒ½ï¼ˆåé¢è¯´ï¼‰ï¼Œæ‰€ä»¥å®ƒå®Œå…¨ä¸éœ€è¦å€ŸåŠ©äº HDFS å­˜å‚¨ç³»ç»Ÿæ¥å­˜å‚¨æ•°æ®ï¼Œè€Œä¸”ä½¿ç”¨ HDFS çš„è¯ï¼Œé‚£ä¹ˆ ClickHouse çš„åˆ—å¼å­˜å‚¨ã€æ•°æ®å‹ç¼©ã€ç´¢å¼•ç­‰ä¸€ç³»åˆ—é«˜çº§ç‰¹æ€§å°±éƒ½ç”¨ä¸ä¸Šäº†ï¼Œåè€Œä¼šä¸¥é‡æ‹–æ…¢ ClickHouse çš„æ•ˆç‡ã€‚ä½† ClickHouse ä¹‹æ‰€ä»¥è¿˜æä¾›å’Œ HDFS çš„äº¤äº’ï¼Œä¸»è¦æ˜¯è€ƒè™‘åˆ° Hadoop ç”Ÿæ€åœˆå·²ç»å­˜åœ¨å¤šå¹´äº†ï¼Œåœ¨ HDFS ä¹‹ä¸Šå·²ç»å­˜å‚¨äº†å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥æä¾›äº†å’Œ HDFS äº¤äº’çš„æ¥å£ã€‚é€šè¿‡ HDFS æ•°æ®è¡¨å°† HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ•°æ®è¯»å–å‡ºæ¥ä¹‹åï¼Œå¯¼å…¥åˆ° MergeTree æ•°æ®è¡¨ä¸­ï¼Œç„¶åè¿›è¡Œæ•°æ®åˆ†æã€‚</strong></p>
<p><strong>æ‰€ä»¥ HDFS æ•°æ®è¡¨è™½ç„¶æ—¢è´Ÿè´£å†™åˆè´Ÿè´£è¯»ï¼Œå°±åƒæˆ‘ä»¬ä¸Šé¢æ¼”ç¤ºçš„é‚£æ ·ï¼Œä½†å¾ˆæ˜æ˜¾æˆ‘ä»¬åŸºæœ¬ä¸ä¼šç”¨ HDFS æ•°æ®è¡¨å†™æ•°æ®ã€‚å› æ­¤å½“æ¶‰åŠ ClickHouse å’Œ HDFS çš„äº¤äº’æ—¶ï¼Œéƒ½æ˜¯æ•°æ®å·²ç»å­˜åœ¨äº HDFS æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œæˆ‘ä»¬åªæ˜¯åˆ›å»ºä¸€ä¸ª HDFS æ•°æ®è¡¨å°†æ•°æ®ä» HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šè¯»å–å‡ºæ¥ç½¢äº†ã€‚æ‰€ä»¥æ­¤æ—¶åˆ›å»º HDFS æ•°æ®è¡¨å°±éœ€è¦æ ¹æ®æ–‡ä»¶å†…å®¹æ¥åˆ›å»ºäº†ã€‚</strong></p>
<p><strong>æ¯”å¦‚ HDFS ä¸Šå­˜åœ¨ä¸€ä¸ª CSV æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œé¢æœ‰ 4 åˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆ›å»ºçš„æ•°æ®è¡¨å°±åº”è¯¥æœ‰ 4 ä¸ªå­—æ®µã€‚ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002633883-1719103428.png" alt="img"></p>
<p><strong>æ­¤æ—¶ HDFS ä¸Šæœ‰ä¸€ä¸ª TSV æ ¼å¼çš„æ–‡ä»¶ï¼ˆCSV æ–‡ä»¶çš„åˆ†éš”ç¬¦ä¸ºé€—å·ï¼ŒTSV æ–‡ä»¶çš„åˆ†éš”ç¬¦ä¸º \tï¼‰ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨ ClickHouse å°†å…¶è¯»å–å‡ºæ¥ã€‚å…·ä½“åšæ³•æ˜¾ç„¶æ˜¯åˆ›å»ºä¸€å¼  HDFS æ•°æ®è¡¨ï¼Œç„¶åæŒ‡å®šæ•°æ®æ–‡ä»¶åœ¨ HDFS ä¸Šå­˜å‚¨è·¯å¾„å³å¯ï¼Œä½†é—®é¢˜æ˜¯è¡¨å­—æ®µè¦å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿæ²¡é”™ï¼Œæ˜¾ç„¶è¦æ ¹æ®æ–‡ä»¶çš„å­˜å‚¨å†…å®¹æ¥è¿›è¡Œè®¾è®¡ï¼Œæ¯”å¦‚è¿™é‡Œæœ‰ 4 ä¸ªåˆ—ï¼Œé‚£ä¹ˆ HDFS æ•°æ®è¡¨å°±åº”è¯¥è¦æœ‰ 4 ä¸ªå­—æ®µï¼Œç„¶åå†æ ¹æ®å­˜å‚¨çš„å†…å®¹æŒ‡å®šå­—æ®µçš„ç±»å‹ï¼Œé‚£ä¹ˆè¿™ä¸ª HDFS æ•°æ®è¡¨å°±å¯ä»¥è¿™ä¹ˆå®šä¹‰ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hdfs_table2 (</span><br><span class="line">    a UInt32,</span><br><span class="line">    b String,</span><br><span class="line">    c UInt32,</span><br><span class="line">    d String</span><br><span class="line">) ENGINE <span class="operator">=</span> HDFS(<span class="string">&#x27;hdfs://localhost:6666/clickhouse/hdfs_table2&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br><span class="line"><span class="comment">-- æ–‡ä»¶ç±»å‹è¦æŒ‡å®š TSVï¼Œå› ä¸ºåˆ†éš”ç¬¦æ˜¯ \t</span></span><br><span class="line"><span class="comment">-- æ³¨ï¼šè¿™é‡Œå­—æ®µåå«ä»€ä¹ˆå®Œå…¨ç”±æˆ‘ä»¬è‡ªå·±å®šä¹‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hdfs_table2_new (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    age UInt32,</span><br><span class="line">    place String</span><br><span class="line">) ENGINE <span class="operator">=</span> HDFS(<span class="string">&#x27;hdfs://localhost:6666/clickhouse/hdfs_table2&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œæˆ‘ä»¬çš„ä¸¤å¼  HDFS æ•°æ®è¡¨éƒ½æŒ‡å‘ HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šçš„åŒä¸€ä¸ªæ–‡ä»¶ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002641127-2080962518.png" alt="img"></p>
<p><strong>è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œçš„ ClickHouse å®Œå…¨å°±å……å½“äº† Hive çš„è§’è‰²ï¼Œç”šè‡³æ¯” Hive è¿˜è¦å¥½ç”¨ä¸å°‘ã€‚ä¸è¿‡ ClickHouse æ”¯æŒçš„è¿˜ä¸æ­¢è¿™äº›ï¼Œåœ¨æŒ‡å®š HDFS æ–‡ä»¶è·¯å¾„çš„æ—¶å€™ ClickHouse æ”¯æŒå¤šç§æ–¹å¼ï¼š</strong></p>
<ul>
<li><code>ç»å¯¹è·¯å¾„ï¼šä¼šè¯»å–æŒ‡å®šè·¯å¾„çš„å•ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚HDFS(&#39;hdfs://localhost:6666/clickhouse/hdfs_table2&#39;, &#39;TSV&#39;)ï¼Œä¼šè¯»å– clickhouse ç›®å½•ä¸‹çš„ hdfs_table2 æ–‡ä»¶</code></li>
<li><code>* é€šé…ç¬¦ï¼šåŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„å­—ç¬¦ï¼Œæ¯”å¦‚ HDFS(&#39;hdfs://localhost:6666/clickhouse/*&#39;, &#39;TSV&#39;)ï¼Œä¼šè¯»å– clickhouse ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</code></li>
<li><code>? é€šé…ç¬¦ï¼šåŒ¹é…å•ä¸ªä»»æ„å­—ç¬¦ï¼Œæ¯”å¦‚ ENGINE = HDFS(&#39;hdfs://localhost:6666/clickhouse/hdfs_table?&#39;, &#39;TSV&#39;)ï¼Œä¼šè¯»å– clickhouse ç›®å½•ä¸‹æ‰€æœ‰åŒ¹é… hdfs_table? çš„æ–‡ä»¶</code></li>
<li><code>&#123;M..N&#125; æ•°å­—åŒºé—´ï¼šåŒ¹é…æŒ‡å®šæ•°å­—çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ HDFS(&#39;hdfs://localhost:6666/clickhouse/hdfs_table&#123;1..3&#125;&#39;, &#39;TSV&#39;)ï¼Œä¼šè¯»å– clickhouse ç›®å½•ä¸‹çš„ hdfs_table1ã€hdfs_table2ã€hdfs_table3</code></li>
</ul>
<p><strong>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸Šé¢çš„æ–‡ä»¶éƒ½æ²¡æœ‰åç¼€åï¼Œä½†æœ‰åç¼€åä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002647181-598571969.png" alt="img"></p>
<p><strong>è¿™é‡Œæˆ‘ä»¬å°†ä¹‹å‰çš„ hdfs_table2 æ‹·è´ 3 ä»½ï¼Œå¹¶ä¸Šä¼ è‡³ HDFSï¼Œç„¶ååˆ›å»ºæ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> girls (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    age UInt32,</span><br><span class="line">    place String</span><br><span class="line">) ENGINE <span class="operator">=</span> HDFS(<span class="string">&#x27;hdfs://localhost:6666/clickhouse/girls_&#123;1..3&#125;.tsv&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br><span class="line"><span class="comment">-- è¿™é‡Œå†™æˆ girls_?.tsv ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> girls_new (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    age UInt32,</span><br><span class="line">    place String</span><br><span class="line">) ENGINE <span class="operator">=</span> HDFS(<span class="string">&#x27;hdfs://localhost:6666/clickhouse/girls_?.tsv&#x27;</span>, <span class="string">&#x27;TSV&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åè¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002654059-705168788.png" alt="img"></p>
<p><strong>æ˜¾ç„¶ä½¿ç”¨ girls å’Œ girls_new éƒ½æ˜¯å¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®çš„ï¼Œç”±äºæ˜¯ 3 ä¸ªæ–‡ä»¶ï¼Œå› æ­¤ä¼šä»¥ 3 ä¸ªåˆ†åŒºçš„å½¢å¼åˆå¹¶è¿”å›ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ HDFS æ•°æ®è¡¨çš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨èµ·æ¥è¿˜æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œä½†è¿˜æ˜¯åƒæˆ‘ä»¬ä¹‹å‰è¯´çš„é‚£æ ·ï¼ŒClickHouse å®Œå…¨ç‹¬ç«‹äº Hadoop ç”Ÿæ€åœˆï¼Œå¹¶ä¸éœ€è¦å€ŸåŠ© HDFS å­˜å‚¨æ•°æ®ã€‚ä½†ä¹‹æ‰€ä»¥è¿˜æä¾› HDFS æ•°æ®è¡¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†è¯»å– HDFS æ–‡ä»¶ç³»ç»Ÿä¸Šå·²å­˜åœ¨çš„æ•°æ®ï¼Œä¸ç„¶çš„è¯æˆ‘ä»¬éœ€è¦å…ˆæ‰‹åŠ¨å°†æ•°æ®ä» HDFS ä¸Šä¸‹è½½ä¸‹æ¥ï¼Œç„¶åå†å¯¼å…¥åˆ° ClickHouse ä¸­ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤ ClickHouse é€šè¿‡è¡¨å¼•æ“çš„å½¢å¼ç›´æ¥æ”¯æŒæˆ‘ä»¬è®¿é—® HDFS æ–‡ä»¶ç³»ç»Ÿã€‚</strong></p>
<p><strong>å½“ç„¶ä¸å…‰æ˜¯ HDFSï¼ŒClickHouse è¿˜æ”¯æŒå¾ˆå¤šå…¶å®ƒå¸¸è§çš„å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿï¼Œå½“ç„¶æ”¯æŒçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è¯»å–è¿™äº›å­˜å‚¨ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„æ•°æ®ã€‚</strong></p>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><p><strong>MySQL è¡¨å¼•æ“å¯ä»¥å’Œ MySQL æ•°æ®åº“ä¸­çš„æ•°æ®è¡¨å»ºç«‹æ˜ å°„ï¼Œå¹¶é€šè¿‡ SQL å‘å…¶å‘èµ·è¿œç¨‹æŸ¥è¯¢ï¼ŒåŒ…æ‹¬ SELECT å’Œ INSERTï¼Œå£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = MySQL(&#x27;host:port&#x27;, &#x27;database&#x27;, &#x27;table&#x27;, &#x27;user&#x27;, &#x27;password&#x27;[, replace_query, on_duplicate_clause])</span><br></pre></td></tr></table></figure>

<p><strong>å‡è®¾æˆ‘ä»¬è¦è®¿é—® MySQL çš„ default åº“ä¸‹çš„ trade_info è¡¨ï¼Œé‚£ä¹ˆå¯ä»¥è¿™ä¹ˆåšï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> clickhouse_trade_info (</span><br><span class="line">    id UInt32,</span><br><span class="line">    column1 type,</span><br><span class="line">    column2 type,</span><br><span class="line">    ......</span><br><span class="line">) ENGINE <span class="operator">=</span> MySQL(<span class="string">&#x27;localhost:3306&#x27;</span>, <span class="string">&#x27;default&#x27;</span>, <span class="string">&#x27;trade_info&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"><span class="comment">-- æ˜¾ç„¶è¿™å‡ ä¸ªå‚æ•°çš„å«ä¹‰ä¸éœ€è¦å¤šè¯´ï¼Œä½†è¿˜æœ‰ä¸¤ä¸ªå¯é€‰å‚æ•° replace_query å’Œ on_duplicate_clause</span></span><br><span class="line"><span class="comment">-- replace_query é»˜è®¤ä¸º 0ï¼Œå¦‚æœè®¾ç½®ä¸º 1ï¼Œä¼šç”¨ REPLACE INTO ä»£æ›¿ INSERT INTO</span></span><br><span class="line"><span class="comment">-- on_duplicate_clause é»˜è®¤ä¸º 0ï¼Œå¯¹åº” MySQL çš„ ON DUPLICATE KEY è¯­æ³•ï¼Œå¦‚æœæƒ³å¯ç”¨è¯¥è®¾ç½®ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½®ä¸º 1</span></span><br></pre></td></tr></table></figure>

<p><strong>åˆ›å»ºæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ ClickHouse çš„æ•°æ®è¡¨æ¥è¯»å– MySQL æ•°æ®è¡¨çš„æ•°æ®äº†ï¼Œå½“ç„¶æ’å…¥æ•°æ®ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ç”±äº MySQL è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸å®é™…æ¼”ç¤ºäº†ï¼Œå¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p><strong>å½“ç„¶é‡ç‚¹æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æ­é…ç‰©åŒ–è§†å›¾ä¸€èµ·ä½¿ç”¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> trade_info_view</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> clickhouse_trade_info</span><br><span class="line"><span class="comment">-- è¿™é‡ŒæŒ‡å®šæ•°æ®è¡¨çš„æ—¶å€™ä¸€å®šè¦æŒ‡å®š ClickHouse çš„æ•°æ®è¡¨ï¼Œä¸æ˜¯ MySQL çš„</span></span><br><span class="line"><span class="comment">-- æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åˆ»æ„å°†æ•°æ®è¡¨å…¶åä¸º clickhouse_trade_info</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸è¿‡é—æ†¾çš„æ˜¯ï¼Œç›®å‰ MySQL è¡¨å¼•æ“ä¸æ”¯æŒ UPDATE å’Œ DELETE æ“ä½œï¼Œå¦‚æœéœ€è¦æ•°æ®æ›´æ–°çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ CollapsingMergeTree ä½œä¸ºè§†å›¾çš„è¡¨å¼•æ“ã€‚ä¸è¿‡è¿˜æ˜¯ä¹‹å‰æ‰€è¯´ï¼Œä½¿ç”¨å¤–éƒ¨å­˜å‚¨ç³»ç»ŸåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸ºäº†è¯»æ•°æ®ï¼Œå¾ˆå°‘ä¼šæœ‰æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ä¹‹ç±»çš„åœºæ™¯å‡ºç°ã€‚</strong></p>
<h4 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h4><p><strong>ç›¸æ¯” MySQL è¡¨å¼•æ“ï¼ŒJDBC è¡¨å¼•æ“ä¸ä»…å¯ä»¥è¯»å– MySQL æ•°æ®åº“ï¼Œè¿˜èƒ½è¯»å– PostgreSQLã€SQLite å’Œ H2 æ•°æ®åº“ã€‚ä½†æ˜¯å…‰æœ‰ JDBC è¡¨å¼•æ“è¿˜ä¸å¤Ÿï¼Œå®ƒè¿˜éœ€è¦ä¾èµ–ä¸€ä¸ªåŸºäº Java è¯­è¨€å®ç°çš„ SQL ä»£ç†æœåŠ¡ï¼Œåä¸º clickhouse-jdbc-bridgeï¼Œå®ƒå¯ä»¥ä¸º ClickHouse ä»£ç†è®¿é—®æ•°æ®åº“ã€‚</strong></p>
<p><strong>ä½† clickhouse-jdbc-bridge éœ€è¦ä½¿ç”¨ Maven è¿›è¡Œæ„å»ºï¼Œè€Œæˆ‘æœ¬äººä¸æ˜¯ Java æ–¹å‘çš„ï¼ŒåªçŸ¥é“ Java å¦‚ä½•å®‰è£…ï¼Œç”šè‡³ä¸çŸ¥é“å¦‚ä½•ç”¨ Java å†™ä¸€ä¸ª Hello Worldï¼Œæ‰€ä»¥æ›´åˆ«æä½¿ç”¨ Maven æ„å»ºé¡¹ç›®äº†ï¼Œå› æ­¤è¿™éƒ¨åˆ†å†…å®¹æœ‰å…´è¶£å¯ä»¥è‡ªå·±äº†è§£ä¸€ä¸‹ã€‚æ€»ä¹‹åˆ›å»º JDBC è¡¨å¼•æ“å’Œ MySQL è¡¨å¼•æ“æ˜¯ç±»ä¼¼çš„ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = JDBC(&#x27;jdbc:url&#x27;, &#x27;database&#x27;, &#x27;table&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>ä¸åŒçš„æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„ urlï¼Œå¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><p><strong>Kafka æ˜¯å¤§æ•°æ®é¢†åŸŸéå¸¸æµè¡Œçš„ä¸€æ¬¾åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œè€Œ ClickHouse ä¹Ÿæä¾›äº† Kafka è¡¨å¼•æ“ä¸ä¹‹å¯¹æ¥ï¼Œè¿›è€Œè®¢é˜… Kafka ä¸­çš„ä¸»é¢˜å¹¶å®æ—¶æ¥æ”¶æ¶ˆæ¯æ•°æ®ã€‚è€Œæ€»æ‰€å‘¨çŸ¥ï¼Œåœ¨æ¶ˆæ¯ç³»ç»Ÿä¸­å­˜åœ¨ä¸‰å±‚è¯­ä¹‰ï¼š</strong></p>
<ul>
<li><code>æœ€å¤šä¸€æ¬¡ï¼ˆAt Most Onceï¼‰ï¼šå¯èƒ½å‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œä¸€æ¡æ¶ˆæ¯åœ¨æ¶ˆè´¹ç«¯æœ€å¤šè¢«æ¥æ”¶ä¸€æ¬¡</code></li>
<li><code>æœ€å°‘ä¸€æ¬¡ï¼ˆAt Least Onceï¼‰ï¼šå¯èƒ½å‡ºç°æ¶ˆæ¯é‡å¤çš„æƒ…å†µï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œä¸€æ¡æ¶ˆæ¯åœ¨æ¶ˆè´¹ç«¯å…è®¸è¢«æ¥æ”¶å¤šæ¬¡</code></li>
<li><code>ç²¾ç¡®ä¸€æ¬¡ï¼ˆExactly Onceï¼‰ï¼šæ•°æ®ä¸å¤šä¸å°‘ï¼Œä¸€æ¡æ¶ˆæ¯åœ¨æ¶ˆè´¹ç«¯æ°å¥½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œè¿™ä¹Ÿæ˜¯æœ€ç†æƒ³çš„æƒ…å†µï¼Œå› ä¸ºæ¶ˆæ¯ä¸å¯èƒ½ç™¾åˆ†ä¹‹ç™¾ä¸ä¸¢å¤±</code></li>
</ul>
<p><strong>è™½ç„¶ Kafka æœ¬èº«èƒ½å¤Ÿæ”¯æŒä¸Šè¿°ä¸‰ç§è¯­ä¹‰ï¼Œä½†æ˜¯ç›®å‰ ClickHouse è¿˜ä¸æ”¯æŒç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼Œå› ä¸ºè¿™éœ€è¦åº”ç”¨ç«¯å’Œ Kafka æ·±åº¦é…åˆæ‰å¯ä»¥å®ç°ã€‚kafka ä½¿ç”¨ Offset æ ‡å¿—ä½æ¥è®°å½•ä¸»é¢˜æ•°æ®è¢«æ¶ˆè´¹çš„ä½ç½®ä¿¡æ¯ï¼Œå½“åº”ç”¨ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œé€šè¿‡è‡ªåŠ¨æäº¤æˆ–æ‰‹åŠ¨æäº¤å½“å‰çš„ä½ç§»ä¿¡æ¯ï¼Œä»¥ä¿éšœæ¶ˆæ¯çš„è¯­ä¹‰ï¼Œä½† ClickHouse åœ¨è¿™æ–¹é¢è¿˜æœ‰è¿›æ­¥çš„ç©ºé—´ã€‚</strong></p>
<p><strong>Kafka è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ENGINE <span class="operator">=</span> Kafka()</span><br><span class="line">SETTINGS kafka_broker_list <span class="operator">=</span> <span class="string">&#x27;host:port,...&#x27;</span>,</span><br><span class="line">         kafka_topic_list <span class="operator">=</span> <span class="string">&#x27;topic1,topic2&#x27;</span>,</span><br><span class="line">         kafka_group_name <span class="operator">=</span> <span class="string">&#x27;group_name&#x27;</span>,</span><br><span class="line">         kafka_format <span class="operator">=</span> <span class="string">&#x27;data_format[,]&#x27;</span>,</span><br><span class="line">         [kafka_row_delimiter <span class="operator">=</span> <span class="string">&#x27;delimiter_symbol&#x27;</span>,]</span><br><span class="line">         [kafka_schema <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>,]</span><br><span class="line">         [kafka_num_consumers <span class="operator">=</span> N,]</span><br><span class="line">         [kafka_skip_broken_message <span class="operator">=</span> N,]</span><br><span class="line">         [kafka_commit_every_batch <span class="operator">=</span> N]</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­å¸¦æœ‰æ–¹æ‹¬å·çš„è¡¨ç¤ºé€‰å¡«é¡¹ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»è¿™äº›å‚æ•°çš„ä½œç”¨ï¼š</strong></p>
<ul>
<li><strong>kafka_broker_listï¼šè¡¨ç¤º Broker æœåŠ¡çš„åœ°å€åˆ—è¡¨ï¼Œå¤šä¸ªåœ°å€ä¹‹é—´ä½¿ç”¨é€—å·åˆ†å‰²</strong></li>
<li><strong>kafka_topic_listï¼šè¡¨ç¤ºè®¢é˜…çš„æ¶ˆæ¯ä¸»é¢˜çš„åç§°åˆ—è¡¨ï¼Œå¤šä¸ªä¸»é¢˜ä¹‹é—´ä½¿ç”¨é€—å·åˆ†å‰²ï¼Œå¤šä¸ªä¸»é¢˜ä¸­çš„æ•°æ®å‡è¢«æ¶ˆè´¹</strong></li>
<li><strong>kafka_group_nameï¼šè¡¨ç¤ºæ¶ˆè´¹è€…ç»„çš„åç§°ï¼Œè¡¨å¼•æ“ä¼šä¾æ®æ­¤åç§°åˆ›å»ºæ¶ˆè´¹è€…ç»„</strong></li>
<li><strong>kafka_formatï¼šè¡¨ç¤ºç”¨äºè§£ææ¶ˆæ¯çš„æ•°æ®æ ¼å¼ï¼Œåœ¨æ¶ˆæ¯çš„å‘é€ç«¯ï¼Œå¿…é¡»æŒ‰ç…§æ­¤æ ¼å¼å‘é€æ¶ˆæ¯ã€‚è€Œæ•°æ®æ ¼å¼ä¹Ÿå¿…é¡»æ˜¯ ClickHouse æä¾›çš„æ ¼å¼ä¹‹ä¸€ï¼Œä¾‹å¦‚ TSVã€JSONEachRow å’Œ CSV ç­‰</strong></li>
<li><strong>kafka_row_delimiterï¼šè¡¨ç¤ºåˆ¤å®šä¸€è¡Œæ•°æ®çš„ç»“æŸç¬¦ï¼Œé»˜è®¤ä¸º â€˜\0â€™</strong></li>
<li><strong>kafka_schemaï¼šå¯¹åº” Kafka çš„ schema å‚æ•°</strong></li>
<li><strong>kafka_num_consumersï¼šè¡¨ç¤ºæ¶ˆè´¹è€…çš„æ•°æ®é‡ï¼Œé»˜è®¤å€¼ä¸º 1ï¼Œè¡¨å¼•æ“ä¼šä¾æ®æ­¤å‚æ•°åœ¨æ¶ˆè´¹è€…ç»„ä¸­å¼€å¯ç›¸åº”æ•°é‡çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå½“ç„¶çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡åˆ†åŒºæ•°ï¼Œå¦åˆ™æ²¡æœ‰æ„ä¹‰ã€‚å› ä¸ºåœ¨ kafka çš„ä¸»é¢˜ä¸­ï¼Œä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«æŸä¸ªæ¶ˆè´¹è€…ç»„é‡Œé¢çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼ˆå¦‚æœæƒ³è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆè´¹è€…ä¸€å®šè¦éš¶å±äºä¸åŒçš„æ¶ˆè´¹è€…ç»„ï¼‰</strong></li>
<li><strong>kafka_skip_broken_messageï¼šå½“è¡¨å¼•æ“æŒ‰ç…§é¢„å®šæ ¼å¼è§£ææ•°æ®å‡ºç°é”™è¯¯æ—¶ï¼Œå…è®¸è·³è¿‡å¤±è´¥çš„æ•°æ®çš„è¡Œæ•°ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œå³ä¸å…è®¸ä»»ä½•æ ¼å¼é”™è¯¯çš„æƒ…å½¢å‘ç”Ÿã€‚åœ¨æ­¤ç§æƒ…å½¢ä¸‹ï¼Œåªè¦ kafka ä¸»é¢˜ä¸­å­˜åœ¨æ— æ³•è§£æçš„æ•°æ®ï¼Œæ•°æ®è¡¨éƒ½å°†ä¸ä¼šæ¥æ”¶ä»»ä½•æ•°æ®ã€‚å¦‚æœå°†å…¶è®¾ç½®æˆé 0 çš„æ­£æ•´æ•°ï¼Œä¾‹å¦‚è®¾ç½®ä¸º 10ï¼Œåˆ™è¡¨ç¤ºåªè¦ kafka ä¸»é¢˜ä¸­å­˜åœ¨æ— æ³•è§£æçš„æ•°æ®çš„æ€»æ•°å°äº 10ï¼Œæ•°æ®è¡¨å°±èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯æ•°æ®ï¼Œè€Œè§£æé”™è¯¯çš„æ•°æ®ä¼šè¢«è‡ªåŠ¨è·³è¿‡</strong></li>
<li><strong>kafka_commit_every_batchï¼šè¡¨ç¤ºæ‰§è¡Œ kafka commit çš„é¢‘ç‡ï¼Œå› æ­¤è¿™é‡Œæäº¤åç§»é‡çš„æ–¹å¼æ˜¯æ‰‹åŠ¨æäº¤ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œå³å½“ä¸€æ•´ä¸ª Block å—å®Œå…¨å†™å…¥æ•°æ®è¡¨åæ‰æ‰§è¡Œä¸€æ¬¡ commitã€‚å¦‚æœè®¾ç½®ä¸º 1ï¼Œåˆ™æ¯å†™å®Œä¸€ä¸ª Batch æ‰¹æ¬¡çš„æ•°æ®å°±ä¼šæ‰§è¡Œä¸€æ¬¡ kakfa commitï¼ˆä¸€æ¬¡ Block å†™å…¥æ“ä½œï¼Œç”±å¤šæ¬¡ Batch å†™å…¥æ“ä½œè€Œæˆï¼‰</strong></li>
</ul>
<p><strong>å› æ­¤ ClickHouse åœ¨å¯¹æ¥ Kakfa çš„æ—¶å€™æ˜¯ä¼šå°†æ¶ˆæ¯å†™å…¥åˆ°æ•°æ®è¡¨ä¸­çš„ï¼Œæ‰€ä»¥è¿˜æœ‰ä¸€äº›é…ç½®å‚æ•°å¯ä»¥è°ƒæ•´è¡¨å¼•æ“çš„è¡Œä¸ºï¼Œæ¯”å¦‚ stream_poll_timeout_msï¼Œå®ƒè¡¨ç¤ºæ‹‰å–æ•°æ®çš„é—´éš”æ—¶é—´ã€‚é»˜è®¤å€¼ä¸º 500 æ¯«ç§’ï¼Œæ‰€ä»¥ Kafka è¡¨å¼•æ“æ¯éš” 500 æ¯«ç§’æ‹‰å–ä¸€æ¬¡æ•°æ®ï¼Œè€Œæ‹‰å–çš„æ•°æ®ä¼šå…ˆè¢«æ”¾å…¥ç¼“å­˜å½“ä¸­ï¼Œåœ¨æ—¶æœºæˆç†Ÿçš„æ—¶å€™ï¼Œä¼šè¢«åˆ·æ–°åˆ°æ•°æ®è¡¨ã€‚</strong></p>
<p><strong>è€Œè§¦å‘ Kakfa è¡¨å¼•æ“åˆ·æ–°ç¼“å­˜çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œå½“æ»¡è¶³å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ—¶ï¼Œä¾¿ä¼šè§¦å‘åˆ·æ–°åŠ¨ä½œï¼š</strong></p>
<ul>
<li><strong>å½“ä¸€ä¸ªæ•°æ®å—å†™å…¥å®Œæˆçš„æ—¶å€™ï¼Œä¸€ä¸ªæ•°æ®å—çš„å¤§å°ç”± kafka_max_block_size å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å¤§å°ä¸º 65536</strong></li>
<li><strong>ç­‰å¾…é—´éš”è¶…è¿‡ 7500 æ¯«ç§’ï¼Œç”± stream_fush_interval_ms æ§åˆ¶</strong></li>
</ul>
<p><strong>Kafka è¡¨å¼•æ“åº•å±‚è´Ÿè´£å’Œ Kafka é€šä¿¡çš„éƒ¨åˆ†æ˜¯åŸºäº librdkafka å®ç°çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªç”± C++ å®ç°çš„ Kafka åº“ï¼Œé¡¹ç›®åœ°å€ä¸º <a href="https://github.com/edenhill/librdkafka">https://github.com/edenhill/librdkafka</a> ã€‚librdkafka æä¾›äº†è®¸å¤šè‡ªå®šä¹‰çš„é…ç½®å‚æ•°ï¼Œä¾‹å¦‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡åªä¼šè¯»å– kafka ä¸­æœ€æ–°çš„æ•°æ®ï¼Œå¦‚æœå°† auto.offset.reset æ”¹æˆ earliestï¼ˆé»˜è®¤æ˜¯ latestï¼‰ï¼Œæ•°æ®å°†ä»ä¼šä»æœ€è¿‘ä¸€æ¬¡æäº¤çš„åç§»ä½ç½®å¼€å§‹è¯»å–ã€‚å½“ç„¶é‡Œé¢è¿˜æ”¯æŒå¾ˆå¤šå…¶å®ƒçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡é¡¹ç›®ä¸­çš„ CONFIGURATION.md è¿›è¡ŒæŸ¥çœ‹ã€‚</strong></p>
<p><strong>ClickHouse å¯¹ librdkafka çš„è‡ªå®šä¹‰å‚æ•°ä¹Ÿæä¾›äº†è‰¯å¥½çš„æ‰©å±•æ”¯æŒï¼Œåœ¨ ClickHouse çš„å…¨å±€è®¾ç½®ä¸­ï¼Œæä¾›äº†ä¸€ç»„ Kafka æ ‡ç­¾ï¼Œä¸“é—¨ç”¨äºå®šä¹‰ librdkafka çš„è‡ªå®šä¹‰å‚æ•°ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlibrdkafka çš„åŸç”Ÿå‚æ•°ä¸­ä½¿ç”¨äº†ç‚¹è¿æ¥ç¬¦ï¼Œè€Œåœ¨ ClickHouse ä¸­éœ€è¦æ”¹æˆä¸‹åˆ’çº¿çš„å½¢å¼ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">kafka</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- librdkafka ä¸­ï¼Œå‚æ•°åæ˜¯ auto.offset.resetï¼Œåœ¨è¿™é‡Œéœ€è¦ä½¿ç”¨ä¸‹åˆ’çº¿è¿›è¡Œåˆ†å‰² --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">auto_offset_reset</span>&gt;</span>earliest<span class="tag">&lt;/<span class="name">auto_offset_reset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">kafka</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢æˆ‘ä»¬å°±æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œé¦–å…ˆä½¿ç”¨ Go æ¥è¿æ¥ kafkaï¼Œåˆ›å»ºä¸€ä¸ªä¸»é¢˜ï¼Œå¹¶å†™å…¥å‡ æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/Shopify/sarama&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    config := sarama.NewConfig()</span><br><span class="line">    cluster, _ := sarama.NewClusterAdmin([]<span class="type">string</span>&#123;<span class="string">&quot;47.94.174.89:9092&quot;</span>&#125;, config)</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸»é¢˜ï¼Œè¯¥ä¸»é¢˜æœ‰ä¸‰ä¸ªåˆ†åŒº    </span></span><br><span class="line">    _ = cluster.CreateTopic(<span class="string">&quot;heroes&quot;</span>, &amp;sarama.TopicDetail&#123;NumPartitions: <span class="number">3</span>, ReplicationFactor: <span class="number">1</span>&#125;, <span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// å†™å…¥æ¶ˆæ¯ï¼Œæ¯ä¸ªåˆ†åŒºå†™å…¥ä¸¤æ¡    </span></span><br><span class="line">    config.Producer.Return.Successes = <span class="literal">true</span></span><br><span class="line">    config.Producer.Return.Errors = <span class="literal">true</span></span><br><span class="line">    config.Producer.Partitioner = sarama.NewManualPartitioner</span><br><span class="line">    producer, _ := sarama.NewAsyncProducer([]<span class="type">string</span>&#123;<span class="string">&quot;47.94.174.89:9092&quot;</span>&#125;, config)</span><br><span class="line">    messages := []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;éº¦å…‹é›·&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">37</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;ç»´å’Œè€…&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;åˆæ—¶å·²åˆ°&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æºæ°&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">35</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;é•–&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;æ–©&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;åŠè—&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">38</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;å¼“&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;é¾™&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å£«å…µ76&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">55</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;è„‰å†²æ­¥æª&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;æˆ˜æœ¯ç›®é•œ&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;æ­»ç¥(è°æ˜Ÿ)&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">57</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;*å¼¹æª&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;æ­»äº¡ç»½æ”¾&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;è·¯éœ¸&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">48</span>, <span class="string">&quot;weapon&quot;</span>: <span class="string">&quot;çˆ†è£‚æª&quot;</span>, <span class="string">&quot;ultimate&quot;</span>: <span class="string">&quot;é¸¡é£ç‹—è·³&quot;</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i, message := <span class="keyword">range</span> messages &#123;</span><br><span class="line">        value, _ := json.Marshal(message)</span><br><span class="line">        <span class="comment">// å°† map è½¬æˆ json        </span></span><br><span class="line">        <span class="keyword">if</span> i &lt; <span class="number">2</span> &#123;</span><br><span class="line">            producer.Input() &lt;- &amp;sarama.ProducerMessage&#123;Topic: <span class="string">&quot;heroes&quot;</span>, Partition: <span class="number">0</span>,</span><br><span class="line">                Value: sarama.StringEncoder(value)&#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> i &lt; <span class="number">4</span> &#123;</span><br><span class="line">            producer.Input() &lt;- &amp;sarama.ProducerMessage&#123;Topic: <span class="string">&quot;heroes&quot;</span>, Partition: <span class="number">1</span>,</span><br><span class="line">                Value: sarama.StringEncoder(value)&#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            producer.Input() &lt;- &amp;sarama.ProducerMessage&#123;Topic: <span class="string">&quot;heroes&quot;</span>, Partition: <span class="number">2</span>,</span><br><span class="line">                Value: sarama.StringEncoder(value)&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-producer.Successes():</span><br><span class="line">        <span class="keyword">case</span> &lt;-producer.Errors():</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªä¸»é¢˜å« heroesï¼Œè¯¥ä¸»é¢˜æœ‰ä¸‰ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå†™å…¥äº†ä¸¤æ¡æ•°æ®ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒè¯­è¨€æä¾›çš„ API å®ç°ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ kafka æ§åˆ¶å°æŸ¥çœ‹ä¸€ä¸‹æ•°æ®æœ‰æ²¡æœ‰å†™å…¥æˆåŠŸã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002823891-539220090.png" alt="img"></p>
<p><strong>æ˜¾ç„¶å†™å…¥æˆåŠŸäº†ï¼Œä¸Šé¢çš„ 172.24.60.6 æ˜¯æˆ‘çš„å†…ç½‘ IPï¼Œç„¶åæˆ‘ä»¬å°±æ¥åˆ›å»º kafka æ•°æ®è¡¨è·å–æ•°æ®ã€‚ç”±äºæ•°æ®å·²ç»å†™å…¥äº†ï¼Œæ‰€ä»¥åœ¨è¯»å–çš„æ—¶å€™å¿…é¡»æŒ‡å®š auto.offset.reset ä¸º earliestã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">kafka</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">auto_offset_reset</span>&gt;</span>earliest<span class="tag">&lt;/<span class="name">auto_offset_reset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">kafka</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬ä¿®æ”¹ config.xmlï¼Œç„¶å clickhouse restart é‡å¯æœåŠ¡ã€‚ä¸‹é¢å¼€å§‹åˆ›å»º Kakfa æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafka_test (</span><br><span class="line">    id UInt32,    </span><br><span class="line">    name String,    </span><br><span class="line">    age UInt8,   </span><br><span class="line">    weapon String,   </span><br><span class="line">    ultimate String) </span><br><span class="line">ENGINE <span class="operator">=</span> Kafka() <span class="comment">-- ç”±äºå½“å‰ ClickHouse å’Œ Kakfa åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥è¿™é‡Œç”¨å†…ç½‘ IP ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">SETTINGS kafka_broker_list <span class="operator">=</span> <span class="string">&#x27;47.94.174.89:9092&#x27;</span>,         </span><br><span class="line">         kafka_topic_list <span class="operator">=</span> <span class="string">&#x27;heroes&#x27;</span>,         </span><br><span class="line">         kafka_group_name <span class="operator">=</span> <span class="string">&#x27;my_group&#x27;</span>,         </span><br><span class="line">         kafka_format <span class="operator">=</span> <span class="string">&#x27;JSONEachRow&#x27;</span>,         </span><br><span class="line">         kafka_num_consumers <span class="operator">=</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><strong>åˆ›å»ºæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬æ¥æŸ¥è¯¢æ•°æ®ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è¯»å–ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002832713-1985022276.png" alt="img"></p>
<p><strong>æ•´ä½“éƒ½å¾ˆé¡ºåˆ©ï¼Œä½†é—®é¢˜æ˜¯ç¬¬äºŒæ¬¡æŸ¥è¯¢çš„æ—¶å€™å‘ç°æ•°æ®æ²¡äº†ï¼ŒåŸå› å°±æ˜¯ kafka è¡¨å¼•æ“åœ¨æ‰§è¡Œå®ŒæŸ¥è¯¢ä¹‹åå°±ä¼šåˆ é™¤è¡¨å†…çš„æ•°æ®ã€‚æ³¨æ„è¿™é‡Œåˆ é™¤çš„æ•°æ®æ˜¯ Kakfa è¡¨å¼•æ“ä» kafka ä¸­æ‹–ä¸‹æ¥å†™å…¥è¡¨ä¸­çš„æ•°æ®ï¼Œè‡³äº kafka ä¸Šé¢çš„æ•°æ®è¿˜åœ¨ã€‚ä¸è¿‡å¾ˆæ˜æ˜¾è¿™ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ï¼Œå› ä¸ºä¸èƒ½æ¯æ¬¡æŸ¥è¯¢éƒ½ä¸´æ—¶ä» kafka ä¸Šæ‹–å§ã€‚</strong></p>
<p><strong>æ‰€ä»¥çœŸæ­£çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>é¦–å…ˆåˆ›å»º Kafka æ•°æ®è¡¨ Aï¼Œå®ƒå……å½“çš„æ˜¯æ•°æ®ç®¡é“ï¼Œè´Ÿè´£ä» kafka ä¸Šæ‹–æ•°æ®</code></li>
<li><code>ç„¶åæ˜¯å¦å¤–ä¸€å¼ ä»»æ„å¼•æ“çš„æ•°æ®è¡¨ Bï¼Œå®ƒå……å½“çš„è§’è‰²æ˜¯é¢å‘ç»ˆç«¯ç”¨æˆ·çš„æŸ¥è¯¢è¡¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸æ˜¯ MergeTree ç³»åˆ—</code></li>
<li><code>æœ€åæ˜¯ä¸€å¼ ç‰©åŒ–è§†å›¾ Cï¼Œå®ƒè´Ÿè´£å°†è¡¨ A çš„æ•°æ®å®æ—¶åŒæ­¥åˆ°è¡¨ B</code></li>
</ul>
<p><strong>ä¸‹é¢å…·ä½“æ“ä½œä¸€æ³¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafka_queue (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    age UInt8,</span><br><span class="line">    weapon String,</span><br><span class="line">    ultimate String</span><br><span class="line">) ENGINE <span class="operator">=</span> Kafka()</span><br><span class="line">SETTINGS kafka_broker_list <span class="operator">=</span> <span class="string">&#x27;47.94.174.89:9092&#x27;</span>,</span><br><span class="line">         kafka_topic_list <span class="operator">=</span> <span class="string">&#x27;heroes&#x27;</span>,</span><br><span class="line">         kafka_group_name <span class="operator">=</span> <span class="string">&#x27;my_group&#x27;</span>,</span><br><span class="line">         kafka_format <span class="operator">=</span> <span class="string">&#x27;JSONEachRow&#x27;</span>,</span><br><span class="line">         kafka_num_consumers <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">         </span><br><span class="line"><span class="comment">-- ç„¶åæ˜¯é¢å‘ç»ˆç«¯ç”¨æˆ·çš„æŸ¥è¯¢è¡¨ï¼Œè¿™é‡Œä½¿ç”¨ MergeTree å¼•æ“</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> kafka_table (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    age UInt8,</span><br><span class="line">    weapon String,</span><br><span class="line">    ultimate String</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æœ€åæ˜¯ä¸€å¼ ç‰©åŒ–è§†å›¾ï¼Œç”¨äºå°†æ•°æ®ä» kafka_queue åŒæ­¥åˆ° kafka_table</span></span><br><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> queue_to_table_view <span class="keyword">TO</span> kafka_table</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> id, name, age, weapon, ultimate <span class="keyword">FROM</span> kafka_queue</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤å…¨éƒ¨çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œå½“æ•°æ®è¿›å…¥ kafka_queue çš„æ—¶å€™ï¼Œç‰©åŒ–è§†å›¾ queue_to_table_view ä¼šå°†æ•°æ®ä» kafka_queue åŒæ­¥åˆ° kafka_tableï¼Œå³ä½¿ kafka_queue ä¸­çš„æ•°æ®è¢«åˆ æ‰ä¹Ÿä¸å½±å“ï¼Œå› ä¸ºæ•°æ®å·²ç»è¿›å…¥äº† kafka_tableï¼Œè€Œ kafka_table æ‰æ˜¯è´Ÿè´£é¢å‘æ•°æ®æŸ¥è¯¢çš„è¡¨ã€‚</strong></p>
<blockquote>
<p><strong>è¯´ç™½äº†æ•°æ®åˆ é™¤çš„é—®é¢˜å¹¶æ²¡æœ‰å¾—åˆ°æœ¬è´¨ä¸Šçš„è§£å†³ï¼Œåªæ˜¯æ¢äº†ä¸€ç§æ›²çº¿æ•‘å›½çš„æ–¹å¼ï¼Œé€šè¿‡ç‰©åŒ–è§†å›¾å°†æ•°æ®æ”¾åœ¨äº†å¦ä¸€å¼ è¡¨ä¸­ã€‚è‡³äº kafka æ•°æ®è¡¨åœ¨æŸ¥è¯¢ä¹‹åæ•°æ®ä¸ºä»€ä¹ˆè¢«åˆ é™¤ï¼Œæˆ‘ä»¬å°±ä¸æ·±ç©¶äº†ã€‚</strong></p>
</blockquote>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002840055-450004326.png" alt="img"></p>
<blockquote>
<p><strong>æ³¨æ„ï¼šä» kafka ä¸Šé¢æ‹–æ•°æ®æ˜¯æœ‰ä¸€å®šè¿‡ç¨‹çš„ï¼Œå¦‚æœå¾€ kafka å†™å®Œæ•°æ®ä¹‹åå°±ç«‹åˆ»æŸ¥è¯¢ kafka_tableï¼Œä¸ä¸€å®šèƒ½æŸ¥è¯¢å¾—åˆ°æ•°æ®ï¼Œè¿™ä¹‹é—´ä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚</strong></p>
</blockquote>
<p><strong>å¦‚æœæƒ³åœæ­¢æ•°æ®åŒæ­¥ï¼Œå¯ä»¥åˆ é™¤è§†å›¾ï¼šDROP TABEL queue_to_table_viewï¼Œæˆ–è€…å¸è½½è§†å›¾ï¼šDETACH TABLE queue_to_table_viewã€‚è¿™é‡Œæˆ‘ä»¬å°†è§†å›¾å¸è½½æ‰ï¼Œç„¶åå†å°†ä¹‹å‰çš„æ•°æ®é‡æ–°å†™å…¥ä¸€æ¬¡ï¼Œå¹¶è¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002845471-147057865.png" alt="img"></p>
<p><strong>æˆ‘ä»¬å‘ç°æ•°æ®å¹¶æ²¡æœ‰è¢«åŒæ­¥è¿‡æ¥ï¼Œè¿™æ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œå› ä¸ºè§†å›¾è¢«å¸è½½äº†ã€‚å¦‚æœæƒ³ç»§ç»­åŒæ­¥ï¼Œé‚£ä¹ˆå°†å¸è½½ä¹‹åçš„è§†å›¾é‡æ–°è£…è½½è¿›æ¥å³å¯ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ATTACH MATERIALIZED <span class="keyword">VIEW</span> queue_to_table_view <span class="keyword">TO</span> kafka_table</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> id, name, age, weapon, ultimate <span class="keyword">FROM</span> kafka_queue</span><br></pre></td></tr></table></figure>

<p><strong>å’Œåˆ›å»ºè§†å›¾ç±»ä¼¼ï¼Œåªéœ€è¦å°† CREATE æ¢æˆ ATTACH å³å¯ï¼Œç„¶åå†è¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002852594-1910988304.png" alt="img"></p>
<p><strong>æ­¤æ—¶æ•°æ®å°±åˆåŒæ­¥è¿‡æ¥äº†ï¼ˆå¦‚æœæ²¡æœ‰åŒæ­¥è¿‡æ¥å°±ç­‰ä¸€å°ä¼šå„¿ï¼‰ï¼Œä½†æ˜¯åˆ‡è®°ï¼šåœ¨é‡æ–°è£…è½½ç‰©åŒ–è§†å›¾ä¹‹å‰ä¸€å®šä¸è¦æŸ¥è¯¢ kakfa_queueï¼Œå› ä¸ºä¸€æ—¦æŸ¥è¯¢æ•°æ®å°±æ²¡äº†ï¼Œç‰©åŒ–è§†å›¾å°±æ²¡æ³•åŒæ­¥äº†ã€‚</strong></p>
<h4 id="File"><a href="#File" class="headerlink" title="File"></a>File</h4><p><strong>File è¡¨å¼•æ“èƒ½å¤Ÿç›´æ¥è¯»å–æœ¬åœ°æ–‡ä»¶çš„æ•°æ®ï¼Œé€šå¸¸è¢«ä½œä¸ºä¸€ç§æ‰©å±•æ‰‹æ®µæ¥ä½¿ç”¨ï¼Œä¾‹å¦‚å®ƒå¯ä»¥è¯»å–ç”±å…¶å®ƒç³»ç»Ÿç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ï¼Œå¦‚æœå¤–éƒ¨ç³»ç»Ÿç›´æ¥ä¿®æ”¹äº†æ–‡ä»¶ï¼Œåˆ™å˜ç›¸è¾¾åˆ°äº†æ•°æ®æ›´æ–°çš„ç›®çš„ï¼›è¿˜å¯ä»¥å°† ClickHouse æ•°æ®å¯¼å‡ºä¸ºæœ¬åœ°æ–‡ä»¶ï¼›ä»¥åŠç”¨äºæ•°æ®æ ¼å¼è½¬æ¢ç­‰åœºæ™¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒFile è¡¨å¼•æ“ä¹Ÿè¢«åº”ç”¨äº clickhouse-local å·¥å…·ï¼Œä¹‹å‰ä»‹ç»è¿‡ã€‚</strong></p>
<p><strong>File è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = File(format)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ format è¡¨ç¤ºæ–‡ä»¶çš„æ•°æ®æ ¼å¼ï¼ŒåŒæ ·å¿…é¡»æ˜¯ ClickHouse æ”¯æŒçš„æ ¼å¼ï¼Œä¾‹å¦‚ TSVã€CSVã€JSONEachRow ç­‰ã€‚å¯ä»¥å‘ç°åœ¨ File è¡¨å¼•æ“çš„å®šä¹‰å‚æ•°ä¸­ï¼Œå¹¶æ²¡æœ‰åŒ…å«æ–‡ä»¶è·¯å¾„è¿™ä¸€é€‰é¡¹ï¼Œå› æ­¤ File è¡¨å¼•æ“çš„æ•°æ®æ–‡ä»¶åªèƒ½ä¿å­˜åœ¨ config.xml é…ç½®ä¸­ç”± path æŒ‡å®šçš„è·¯å¾„ä¸‹ï¼Œä¹Ÿå°±æ˜¯å’Œå…¶å®ƒçš„æ•°æ®è¡¨åœ¨åŒä¸€ä¸ªè·¯å¾„ä¸‹ã€‚</strong></p>
<p><strong>æ¯å¼  File æ•°æ®è¡¨å‡ç”±ç›®å½•å’Œæ–‡ä»¶ç»„æˆï¼Œå…¶ä¸­ç›®å½•ä»¥è¡¨çš„åç§°å‘½åï¼Œè€Œæ•°æ®æ–‡ä»¶åˆ™ä»¥ data. å‘½åï¼Œæ¯”å¦‚ data.CSVã€data.TSV ç­‰ç­‰ã€‚è€Œåˆ›å»º File è¡¨çš„æ–¹å¼æœ‰è‡ªåŠ¨å’Œæ‰‹åŠ¨ä¸¤ç§ï¼Œé¦–å…ˆä»‹ç»è‡ªåŠ¨åˆ›å»ºçš„æ–¹å¼ï¼Œå³ç”± File è¡¨å¼•æ“å…¨æƒè´Ÿè´£è¡¨ç›®å½•å’Œæ•°æ®æ–‡ä»¶çš„åˆ›å»ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> file_table (  </span><br><span class="line">    name String,    </span><br><span class="line">    <span class="keyword">value</span> UInt32</span><br><span class="line">) ENGINE <span class="operator">=</span> File(<span class="string">&#x27;CSV&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å’Œå…¶å®ƒè¡¨å¼•æ“ä¸€æ ·ï¼Œå½“æ‰§è¡Œå®Œä¸Šé¢çš„è¯­å¥åï¼Œä¼šåœ¨ &#x2F;var&#x2F;lib&#x2F;clickhouse&#x2F;data&#x2F;default ä¸­åˆ›å»ºç›¸åº”çš„ç›®å½•ï¼Œä½†æ˜¯é‡Œé¢è¿˜æ²¡æœ‰æ•°æ®æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥ç€å†™å…¥æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> file_table <span class="keyword">VALUES</span> (<span class="string">&#x27;one&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;two&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;three&#x27;</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨æ•°æ®å†™å…¥ä¹‹åï¼Œfile_table ä¸‹é¢ä¾¿ä¼šç”Ÿæˆä¸€ä¸ª data.CSV æ•°æ®æ–‡ä»¶ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cat /var/lib/clickhouse/data/default/file_table/data.CSV &quot;one&quot;,1&quot;two&quot;,2&quot;three&quot;,3</span></span><br><span class="line">[root@satori ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°æ•°æ®è¢«å†™å…¥äº†æ–‡ä»¶ä¹‹ä¸­ï¼Œä½†è¿™ç§æƒ…å†µæ¯”è¾ƒå°‘è§ï¼Œå› ä¸ºå†™å…¥æ•°æ®æˆ‘ä»¬åŸºæœ¬ä¸Šéƒ½ä¸ä¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œå®ƒä»¬å­˜åœ¨çš„ç›®çš„æ›´å¤šæ˜¯ä¸ºäº†è¯»å–ç°æœ‰çš„æ•°æ®ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ä»‹ç»æ‰‹åŠ¨åˆ›å»ºçš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ç›®å½•å’Œé‡Œé¢çš„æ–‡ä»¶éƒ½å·²ç»å­˜åœ¨äº†ï¼Œå®ƒä»¬æ˜¯ç”± ClickHouse ä¹‹å¤–çš„å…¶å®ƒç³»ç»Ÿåˆ›å»ºçš„ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ ClickHouse è¯»å–å®ƒã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002901308-37798833.png" alt="img"></p>
<p><strong>ä»¥ä¸Šæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è¯»å–å®ƒè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé¦–å…ˆè¦æ ¹æ®å†…éƒ¨æ•°æ®åˆ›å»ºå’Œåˆé€‚è¡¨ç»“æ„ï¼Œè¿™é‡Œæˆ‘ä»¬åº”è¯¥é€‰æ‹© JSONEachRowï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> file_table_new (</span><br><span class="line">    id UInt32,    </span><br><span class="line">    name String,   </span><br><span class="line">    place String</span><br><span class="line">) </span><br><span class="line">ENGINE <span class="operator">=</span> File(<span class="string">&#x27;JSONEachRow&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>åˆ›å»ºå®Œä¹‹åï¼Œå¯ä»¥æŸ¥è¯¢ä¸€ä¸‹è¯•è¯•ï¼Œä¸å‡ºæ„å¤–æ˜¯ä¼šæŠ¥é”™çš„ï¼ŒåŸå› å°±æ˜¯ file_table_new ä¸‹é¢æ²¡æœ‰ data.JSONEachRow æ–‡ä»¶ã€‚ä¸åŒäº MergeTreeï¼ŒMergeTree æ•°æ®è¡¨åˆ›å»ºå®Œä¹‹åå¦‚æœä¸å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆæŸ¥è¯¢ç»“æœæ˜¯ç©ºï¼Œå¹¶ä¸ä¼šæŠ¥é”™ã€‚ä½† File è¡¨å¼•æ“ï¼Œå®ƒè¦æ±‚ç›®å½•ä¸‹å¿…é¡»æœ‰ç›¸åº”çš„ data.format æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åˆšæ‰çš„ girls.txt æ‹·è´è¿‡å»ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cp girls.txt /var/lib/clickhouse/data/default/file_table_new/data.JSONEachRow</span></span><br></pre></td></tr></table></figure>

<p><strong>æ‹·è´çš„æ—¶å€™è®°å¾—é‡å‘½åï¼Œæ–‡ä»¶å¿…é¡»å« data.ï¼Œæ‹·è´ä¹‹åå†æ‰§è¡Œä¸€ä¸‹æŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002907468-1401770015.png" alt="img"></p>
<p><strong>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»§ç»­å‘è¡¨ä¸­è¿½åŠ æ•°æ®ï¼Œéƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰äººå¥½å¥‡ï¼Œå¦‚æœæˆ‘ä»¬ä¸å»ºè¡¨ï¼Œè€Œæ˜¯æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª file_table_new ç›®å½•ï¼Œç„¶åå°†æ–‡ä»¶æ‹·è´è¿‡å»å¯ä¸å¯ä»¥å‘¢ã€‚ç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œå› ä¸ºä¸€å¼ è¡¨é™¤äº†å¯¹åº”ä¸€ä¸ªç‰©ç†ç›®å½•ä¹‹å¤–ï¼Œè¿˜æœ‰éƒ¨åˆ†çš„å…ƒä¿¡æ¯ï¼Œè¿™äº›å…ƒä¿¡æ¯æ˜¯åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™äº§ç”Ÿçš„ã€‚æ‰€ä»¥ä¸€å®šè¦å…ˆå»ºè¡¨ï¼Œç„¶åè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ç›®å½•ä¹‹åï¼Œå†å°†æ–‡ä»¶æ‹·è´è¿‡å»ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ File è¡¨å¼•æ“çš„åŸºç¡€ç”¨æ³•ï¼Œå¯ä»¥çœ‹åˆ° ClickHouse æƒ³çš„è¿˜æ˜¯æ¯”è¾ƒå‘¨å…¨çš„ï¼Œä¸ºäº†å·²ç»å­˜åœ¨çš„æ•°æ®å­˜å‚¨ä¹Ÿæä¾›äº†ç›¸åº”çš„æ¥å£ã€‚</strong></p>
<h3 id="å†…å­˜ç±»å‹"><a href="#å†…å­˜ç±»å‹" class="headerlink" title="å†…å­˜ç±»å‹"></a>å†…å­˜ç±»å‹</h3><p><strong>ä¹‹å‰ä»‹ç»çš„è¡¨å¼•æ“ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼šæ•°æ®æ˜¯åœ¨ç£ç›˜ä¸­è¢«è®¿é—®çš„ï¼Œè€Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»‹ç»å‡ ç§å†…å­˜ç±»å‹çš„è¡¨å¼•æ“ï¼Œæ•°æ®ä¼šä»å†…å­˜ä¸­è¢«ç›´æ¥è®¿é—®ã€‚å½“ç„¶ï¼Œè™½ç„¶å®ƒä»¬æ˜¯å†…å­˜è¡¨å¼•æ“ï¼Œä½†å¹¶ä¸æ„å‘³ç€ä¸æ”¯æŒç‰©ç†å­˜å‚¨ï¼ˆè½ç›˜ï¼‰ï¼Œäº‹å®ä¸Šé™¤äº† Memory è¡¨å¼•æ“ä¹‹å¤–ï¼Œå…¶ä½™çš„å‡ æ¬¾å†…å­˜è¡¨å¼•æ“éƒ½ä¼šå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œå› ä¸ºä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œæ‰€ä»¥ä¹Ÿæä¾›äº†è¿™ç§æ•…éšœæ¢å¤æ‰‹æ®µã€‚è€Œåœ¨æ•°æ®è¡¨è¢«åŠ è½½æ—¶ï¼Œå®ƒä»¬ä¼šå°†æ•°æ®å…¨éƒ¨åŠ è½½è‡³å†…å­˜ï¼Œä»¥ä¾›æŸ¥è¯¢ã€‚è€Œå°†æ•°æ®å…¨é‡æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå› ä¸ºåœ¨æå‡æŸ¥è¯¢æ€§èƒ½çš„åŒæ—¶å¢å¤§äº†å†…å­˜æ¶ˆè€—ã€‚</strong></p>
<h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><p><strong>Memory è¡¨å¼•æ“ç›´æ¥å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®æ—¢ä¸ä¼šè¢«å‹ç¼©ä¹Ÿä¸ä¼šè¢«æ ¼å¼è½¬æ¢ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ä¿å­˜çš„å½¢æ€ä¸æŸ¥è¯¢æ—¶çœ‹åˆ°çš„å¦‚å‡ºä¸€è¾™ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå½“ ClickHouse æœåŠ¡é‡å¯çš„æ—¶å€™ï¼ŒMemory è¡¨å†…çš„æ•°æ®ä¼šå…¨éƒ¨ä¸¢å¤±ã€‚æ‰€ä»¥åœ¨ä¸€äº›åœºåˆï¼Œä¼šå°† Memory ä½œä¸ºæµ‹è¯•è¡¨ä½¿ç”¨ã€‚ç”±äºä¸éœ€è¦ç£ç›˜è¯»å–ã€åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥ Memory è¡¨å¼•æ“æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä¸”åœ¨ç®€å•çš„æŸ¥è¯¢åœºæ™¯ä¸­èƒ½å¤Ÿè¾¾åˆ°ä¸ MergeTree æ——é¼“ç›¸å½“çš„æŸ¥è¯¢æ€§èƒ½ï¼ˆä¸€äº¿è¡Œæ•°æ®ä»¥å†…ï¼‰ã€‚Memory è¡¨åˆ›å»ºæ–¹æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sweet_memory_1 (id UInt64) ENGINE <span class="operator">=</span> Memory()</span><br></pre></td></tr></table></figure>

<p><strong>å½“æ•°æ®è¢«å†™å…¥ä¹‹åï¼Œç£ç›˜ä¸Šä¸ä¼šåˆ›å»ºä»»ä½•æ•°æ®æ–‡ä»¶ï¼Œå¦‚æœæœåŠ¡é‡å¯ï¼Œé‚£ä¹ˆè¿™å¼ è¡¨å°±æ²¡äº†ã€‚æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸æµ‹è¯•äº†ï¼Œä½†æœ€åéœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒMemory æ•°æ®è¡¨ä¸å•å•è¢«ç”¨ä½œæµ‹è¯•ï¼Œå®ƒè¿˜è¢«å¹¿æ³›åº”ç”¨åœ¨ ClickHouse çš„å†…éƒ¨ï¼Œå®ƒä¼šä½œä¸ºé›†ç¾¤é—´åˆ†å‘æ•°æ®çš„å­˜å‚¨è½½ä½“æ¥ä½¿ç”¨ã€‚ä¾‹å¦‚åœ¨åˆ†å¸ƒå¼ IN æŸ¥è¯¢çš„åœºåˆä¸­ï¼Œä¼šåˆ©ç”¨ Memory ä¸´æ—¶è¡¨ä¿å­˜ IN å­—å¥çš„æŸ¥è¯¢ç»“æœï¼Œå¹¶é€šè¿‡ç½‘ç»œå°†å®ƒä¼ è¾“åˆ°è¿œç«¯èŠ‚ç‚¹ï¼Œå…³äºè¿™éƒ¨åˆ†å†…å®¹åç»­ä»‹ç»ã€‚</strong></p>
<h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><p><strong>Set è¡¨å¼•æ“æ˜¯æ‹¥æœ‰ç‰©ç†å­˜å‚¨çš„ï¼Œæ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥å†…å­˜ï¼Œç„¶åè¢«åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚æ‰€ä»¥æœåŠ¡é‡å¯ä¹‹åå®ƒçš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå½“æ•°æ®è¡¨è¢«é‡æ–°çŠ¶æ€æ—¶ï¼Œæ–‡ä»¶æ•°æ®ä¼šå†æ¬¡è¢«å…¨é‡åŠ è½½åˆ°å†…å­˜ã€‚è€Œ Set æˆ‘ä»¬çŸ¥é“å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯å”¯ä¸€çš„ï¼Œå¯¹äºæœ‰ Python ç»éªŒçš„äººåº”è¯¥å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ Set è¡¨å¼•æ“å…·æœ‰æ•°æ®å»é‡çš„åŠŸèƒ½ã€‚åœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œé‡å¤çš„æ•°æ®ä¼šè¢«è‡ªåŠ¨å¿½ç•¥ã€‚ç„¶è€Œ Set è¡¨å¼•æ“çš„ä½¿ç”¨åœºæ™¯å³ç‰¹æ®Šåˆæœ‰é™ï¼Œå®ƒè™½ç„¶æ”¯æŒæ­£å¸¸çš„ INSERT å†™å…¥ï¼Œä½†å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ SELECT è¿›è¡ŒæŸ¥è¯¢ï¼ŒSet è¡¨åªèƒ½é—´æ¥ä½œä¸º IN æŸ¥è¯¢çš„å³ä¾§æ¡ä»¶è¢«æŸ¥è¯¢ä½¿ç”¨ã€‚</strong></p>
<p><strong>Set è¡¨å¼•æ“çš„å­˜å‚¨ç»“æ„ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</strong></p>
<ul>
<li><strong>[num].bin æ•°æ®æ–‡ä»¶ï¼šä¿å­˜äº†æ‰€æœ‰åˆ—å­—æ®µçš„æ•°æ®ï¼Œå…¶ä¸­ num æ˜¯ä¸€ä¸ªè‡ªå¢ idï¼Œä» 1 å¼€å§‹ã€‚ä¼´éšç€æ¯ä¸€æ‰¹æ•°æ®çš„å†™å…¥ï¼ˆæ¯ä¸€æ¬¡ INSERTï¼‰ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ .bin æ–‡ä»¶ï¼Œnum ä¹Ÿä¼šéšä¹‹åŠ  1</strong></li>
<li><strong>tmp ä¸´æ—¶ç›®å½•ï¼šæ•°æ®æ–‡ä»¶é¦–å…ˆä¼šè¢«å†™åˆ°è¿™ä¸ªç›®å½•ï¼Œå½“ä¸€æ‰¹æ•°æ®å†™å…¥å®Œæ¯•ä¹‹åï¼Œæ•°æ®æ–‡ä»¶ä¼šè¢«ç§»å‡ºæ­¤ç›®å½•</strong></li>
</ul>
<p><strong>ä¸‹é¢å°±æ¥åˆ›å»ºä¸€ä¸ª Set æ•°æ®è¡¨æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002915489-338948178.png" alt="img"></p>
<p><strong>æ­£ç¡®çš„åšæ³•æ˜¯å°† Set æ•°æ®è¡¨ä½œä¸º IN æŸ¥è¯¢çš„å³ä¾§æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002921253-215978823.png" alt="img"></p>
<p><strong>å†æ¥æŸ¥è¯¢ä¸€ä¸‹ set_table çš„ç‰©ç†ç›®å½•ç»“æ„ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori set_table]<span class="comment"># ls</span></span><br><span class="line">1.bin  tmp</span><br><span class="line">[root@satori set_table]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>ç»“æœå’Œæˆ‘ä»¬åˆ†æçš„æ˜¯ä¸€æ ·çš„ã€‚</strong></p>
<h4 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h4><p><strong>Join è¡¨å¼•æ“æ˜¾ç„¶æ˜¯ä¸º JOIN æŸ¥è¯¢è€Œç”Ÿçš„ï¼Œå®ƒç­‰åŒäºå°† JOIN æŸ¥è¯¢è¿›è¡Œäº†ä¸€å±‚ç®€å•çš„å°è£…ã€‚åœ¨ Join è¡¨å¼•æ“çš„åº•å±‚å®ç°ä¸­ï¼Œå®ƒä¸ Set è¡¨å¼•æ“å…±ç”¨äº†å¤§éƒ¨åˆ†çš„å¤„ç†é€»è¾‘ï¼Œæ‰€ä»¥ Join å’Œ Set è¡¨å¼•æ“æ‹¥æœ‰ä¼—å¤šç›¸ä¼¼ä¹‹å¤„ã€‚ä¾‹å¦‚ Join è¡¨å¼•æ“çš„ç‰©ç†å­˜å‚¨ä¹Ÿç”± [num].bin æ•°æ®æ–‡ä»¶å’Œ tmp ä¸´æ—¶ç›®å½•ä¸¤éƒ¨åˆ†ç»„æˆï¼›æ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥å†…å­˜ï¼Œç„¶åè¢«åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ï¼Œä½†ç›¸æ¯” Set è¡¨å¼•æ“ï¼ŒJoin è¡¨å¼•æ“æœ‰ç€æ›´åŠ å¹¿æ³›çš„ä½¿ç”¨åœºæ™¯ï¼Œå®ƒæ—¢èƒ½å¤Ÿä½œä¸º JOIN æŸ¥è¯¢çš„è¿æ¥è¡¨ï¼Œä¹Ÿèƒ½å¤Ÿè¢«ç›´æ¥æŸ¥è¯¢ä½¿ç”¨ã€‚</strong></p>
<p><strong>Join è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = Join(join_strictness, join_type, key1[, key2, ...])</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­å„å‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>join_strictnessï¼šè¿æ¥ç²¾åº¦ï¼Œå®ƒå†³å®šäº† JOIN æŸ¥è¯¢åœ¨è¿æ¥æ•°æ®æ—¶æ‰€ä½¿ç”¨çš„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒ ALLã€ANYã€SEMIã€ANTI å››ç§ç±»å‹</code></li>
<li><code>join_typeï¼šè¿æ¥ç±»å‹ï¼Œå®ƒå†³å®šäº† JOIN æŸ¥è¯¢åœ¨ç»„åˆå·¦å³ä¸¤ä¸ªæ•°æ®é›†åˆçš„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒ INNERã€LEFTã€RIGHT å’Œ FULL å››ç§ç±»å‹</code></li>
<li><code>join_keyï¼šè¿æ¥é”®ï¼Œå®ƒå†³å®šäº†ä½¿ç”¨å“ªä¸ªåˆ—å­—æ®µè¿›è¡Œå…³è”</code></li>
</ul>
<p><strong>ä¸Šé¢è¿™äº›å‚æ•°ï¼Œæ¯ä¸€æ¡éƒ½å¯¹åº”äº† JOIN æŸ¥è¯¢å­—å¥çš„è¯­æ³•è§„åˆ™ï¼Œå…³äº JOIN æŸ¥è¯¢åç»­å±•å¼€ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºç›¸å…³æ•°æ®è¡¨æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é¦–å…ˆåˆ›å»ºä¸»è¡¨ï¼Œå¼•æ“ä¸º Logï¼Œå…³äº Log æ•°æ®è¡¨ä¸€ä¼šè¯´</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> join_table (</span><br><span class="line">    id UInt8,</span><br><span class="line">    name String,</span><br><span class="line">    <span class="type">time</span> DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="built_in">Log</span>();</span><br><span class="line"><span class="comment">-- å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> join_table</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;å¤æ˜åœ°è§‰&#x27;</span>, <span class="string">&#x27;2020-05-01 12:00:00&#x27;</span>),</span><br><span class="line">       (<span class="number">2</span>, <span class="string">&#x27;é›¾é›¨é­”ç†æ²™&#x27;</span>, <span class="string">&#x27;2020-05-01 12:30:00&#x27;</span>),</span><br><span class="line">       (<span class="number">3</span>, <span class="string">&#x27;çªéœ²è¯º&#x27;</span>, <span class="string">&#x27;2020-05-01 13:00:00&#x27;</span>);</span><br><span class="line">       </span><br><span class="line"><span class="comment">-- æ¥ç€åˆ›å»º Join è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> id_join_table (</span><br><span class="line">    id UInt8,</span><br><span class="line">    score UInt8,</span><br><span class="line">    <span class="type">time</span> DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="keyword">Join</span>(<span class="keyword">ANY</span>, <span class="keyword">LEFT</span>, id);</span><br><span class="line"><span class="comment">-- å¦‚æœ join_strictness ä¸º ANYï¼Œé‚£ä¹ˆ join_key é‡å¤çš„æ•°æ®ä¼šè‡ªåŠ¨è¢«å¿½ç•¥</span></span><br><span class="line"><span class="comment">-- æ‰€ä»¥ä¸‹é¢è™½ç„¶å†™äº†ä¸¤æ¡ id ä¸º 1 æ•°æ®ï¼Œä½†åªæœ‰ç¬¬ä¸€æ¡ä¼šä¿ç•™ï¼Œå› ä¸ºå†™å…¥ç¬¬äºŒæ¡çš„æ—¶å€™å‘ç° id ä¸º 1 çš„æ•°æ®å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥ä¼šåœæ­¢å†™å…¥</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> id_join_table</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">100</span>, <span class="string">&#x27;2020-05-01 11:55:00&#x27;</span>),</span><br><span class="line">       (<span class="number">1</span>, <span class="number">105</span>, <span class="string">&#x27;2020-05-01 11:10:00&#x27;</span>),</span><br><span class="line">       (<span class="number">2</span>, <span class="number">90</span>, <span class="string">&#x27;2020-05-01 12:01:00&#x27;</span>),</span><br><span class="line">       (<span class="number">3</span>, <span class="number">80</span>, <span class="string">&#x27;2020-05-01 13:10:00&#x27;</span>),</span><br><span class="line">       (<span class="number">5</span>, <span class="number">70</span>, <span class="string">&#x27;2020-05-01 14:00:00&#x27;</span>),</span><br><span class="line">       (<span class="number">6</span>, <span class="number">60</span>, <span class="string">&#x27;2020-05-01 13:50:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002929823-522994560.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°æ˜¯å¯ä»¥æŸ¥è¯¢æˆåŠŸçš„ï¼ŒJoin æ•°æ®è¡¨æ”¯æŒæŸ¥è¯¢ï¼Œä½†è¿™ç§æŸ¥è¯¢æ–¹å¼å¹¶ä¸æ˜¯ Join æ•°æ®è¡¨çš„ä¸»æˆ˜åœºï¼Œå®ƒçš„ä¸»æˆ˜åœºåº”è¯¥æ˜¯ Join æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002935024-890100815.png" alt="img"></p>
<p><strong>å½“ç„¶ Join æ•°æ®è¡¨é™¤äº†å¯ä»¥ç›´æ¥ä½¿ç”¨ SELECT å’Œ JOIN ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ join å‡½æ•°è®¿é—®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002941690-331743065.png" alt="img"></p>
<p><strong>ç›®å‰è¿˜æ²¡æœ‰æ¶‰åŠåˆ° JOIN æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸€äº›ç»†èŠ‚æˆ‘ä»¬è¿˜æ²¡æœ‰è§£é‡Šï¼Œç›®å‰åªéœ€è¦çŸ¥é“æœ‰è¿™ä¹ˆä¸ªå¼•æ“å³å¯ï¼Œå…·ä½“å†…å®¹åœ¨åé¢ä»‹ç»æŸ¥è¯¢çš„æ—¶å€™å†è¯¦ç»†è¯´ã€‚</strong></p>
<h4 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h4><p><strong>Buffer è¡¨å¼•æ“å®Œå…¨ä½¿ç”¨å†…å­˜è£…è½½æ•°æ®ï¼Œä¸æ”¯æŒæ–‡ä»¶çš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ‰€ä»¥å½“æœåŠ¡é‡å¯ä¹‹åï¼Œè¡¨å†…çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚Buffer è¡¨å¼•æ“ä¸æ˜¯ä¸ºäº†é¢å‘æŸ¥è¯¢åœºæ™¯è€Œè®¾è®¡çš„ï¼Œå®ƒçš„ä½œç”¨æ˜¯å……å½“ç¼“å†²åŒºçš„è§’è‰²ã€‚å‡è®¾æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°æ®å†™å…¥ç›®æ ‡ MergeTree è¡¨ Aï¼Œç”±äºå†™å…¥çš„å¹¶å‘æ•°å¾ˆé«˜ï¼Œè¿™å¯èƒ½å¯¼è‡´è¡¨ A çš„åˆå¹¶é€Ÿåº¦æ…¢äºå†™å…¥é€Ÿåº¦ï¼Œå› ä¸ºæ¯æ¬¡ INSERT éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ†åŒºç›®å½•ã€‚æ­¤æ—¶ä¾¿å¯å¼•å…¥ Buffer æ•°æ®è¡¨æ¥ç¼“è§£è¿™ç±»é—®é¢˜ï¼Œå°† Buffer è¡¨ä½œä¸ºæ•°æ®å†™å…¥çš„ç¼“å†²åŒºï¼Œæ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥ Buffer è¡¨ï¼Œå½“æ»¡è¶³é¢„è®¾æ¡ä»¶æ—¶ï¼ŒBuffer è¡¨ä¼šè‡ªåŠ¨å°†æ•°æ®åˆ·æ–°åˆ°ç›®æ ‡è¡¨ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002949593-1004963799.png" alt="img"></p>
<p><strong>Buffer è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = Buffer(database, table, num_layers, min_time, max_time, min_rows, max_rows, min_bytes, max_bytes)</span><br></pre></td></tr></table></figure>

<p><strong>é‡Œé¢å‚æ•°çš„ä½œç”¨å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>databaseï¼šç›®æ ‡è¡¨çš„æ•°æ®åº“</code></li>
<li><code>tableï¼šç›®æ ‡è¡¨ï¼ŒBuffer è¡¨å†…çš„æ•°æ®ä¼šè‡ªåŠ¨åˆ·æ–°åˆ°ç›®æ ‡è¡¨</code></li>
<li><code>num_layersï¼šå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°ï¼ŒBuffer è¡¨ä¼šæŒ‰ç…§ num_layers çš„æ•°é‡å¼€å¯çº¿ç¨‹ï¼Œä»¥å¹¶è¡Œçš„æ–¹å¼å°†æ•°æ®åˆ·æ–°åˆ°ç›®æ ‡è¡¨ï¼Œå®˜æ–¹å»ºè®®è®¾ç½®ä¸º 16</code></li>
</ul>
<p><strong>Buffer è¡¨å¹¶ä¸æ˜¯å®æ—¶åˆ·æ–°æ•°æ®çš„ï¼Œåªæœ‰åœ¨é˜ˆå€¼æ¡ä»¶æ»¡è¶³æ—¶æ‰ä¼šåˆ·æ–°ï¼Œé˜ˆå€¼æ¡ä»¶ç”±ä¸‰ä¸ªæœ€å°å’Œæœ€å¤§å€¼ç»„æˆï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>min_time å’Œ max_timeï¼šæ—¶é—´æ¡ä»¶çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå•ä½ä¸ºç§’ï¼Œä»ç¬¬ä¸€æ¬¡å‘è¡¨å†…å†™å…¥æ•°æ®æ—¶å¼€å§‹è®¡ç®—</code></li>
<li><code>min_rows å’Œ max_rowsï¼šæ•°æ®è¡Œæ•°æ¡ä»¶çš„æœ€å°å€¼å’Œæœ€å¤§å€¼</code></li>
<li><code>min_bytes å’Œ max_bytesï¼šæ•°æ®å¤§å°çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå•ä½ä¸ºå­—èŠ‚</code></li>
</ul>
<p><strong>é’ˆå¯¹ä»¥ä¸Šæ¡ä»¶ï¼ŒBuffer è¡¨åˆ·æ–°æ•°æ®çš„åˆ¤æ–­ä¾æ®æœ‰ä¸‰ä¸ªï¼Œæ»¡è¶³å…¶ä¸­ä»»æ„ä¸€ä¸ªå°±ä¼šåˆ·æ–°æ•°æ®ï¼š</strong></p>
<ul>
<li><code>ä¸‰ç»„æ¡ä»¶ä¸­æ‰€æœ‰æœ€å°é˜ˆå€¼éƒ½å·²æ»¡è¶³ï¼Œåˆ™è§¦å‘åˆ·æ–°åŠ¨ä½œ</code></li>
<li><code>ä¸‰ç»„æ¡ä»¶ä¸­æœ‰ä¸€ä¸ªæœ€å¤§é˜ˆå€¼æ»¡è¶³ï¼ˆè¿™é‡Œæ˜¯è¶…è¿‡æœ€å¤§å€¼ï¼‰ï¼Œåˆ™è§¦å‘åˆ·æ–°åŠ¨ä½œ</code></li>
<li><code>å¦‚æœå†™å…¥ä¸€æ‰¹æ•°æ®çš„è¡Œæ•°å¤§è¿ max_rows æˆ–è€…æ•°æ®å¤§å°å¤§äº max_bytesï¼Œåˆ™æ•°æ®ç›´æ¥å†™å…¥ç›®æ ‡è¡¨</code></li>
</ul>
<p><strong>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œä¸Šè¿°ä¸‰ç»„æ¡ä»¶åœ¨æ¯ä¸€ä¸ª layer ä¸­éƒ½æ˜¯å•ç‹¬çš„è®¡ç®—çš„ï¼Œå‡è®¾ num_layers ä¸º 16ï¼Œåˆ™ Buffer è¡¨æœ€å¤šå¼€å¯ 16 ä¸ªçº¿ç¨‹æ¥å“åº”æ•°æ®çš„å†™å…¥ï¼Œå®ƒä»¬ä»¥è½®è®­çš„æ–¹å¼æ¥æ”¶è¯·æ±‚ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹å†…ä¼šç‹¬ç«‹è¿›è¡Œä¸Šè¿°åˆ¤æ–­çš„è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡è®¾ä¸€å¼  Buffer è¡¨çš„ max_bytes ä¸º 100 MBï¼Œnum_layers ä¸º 16ï¼Œé‚£ä¹ˆè¿™å¼  Buffer è¡¨èƒ½å¤ŸåŒæ—¶å¤„ç†çš„æœ€å¤§æ•°æ®é‡çº¦ä¸º 1600 MBã€‚</strong></p>
<p><strong>ä¸‹é¢æ¥æµ‹è¯•ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª Memory æ•°æ®è¡¨ï¼Œå†åˆ›å»ºä¸€å¼  Buffer æ•°æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> memory_table (id UInt64) ENGINE <span class="operator">=</span> Memory();</span><br><span class="line"><span class="comment">-- åˆ›å»º Buffer è¡¨ï¼Œç”¨äºå¾€ Memory è¡¨é‡Œé¢å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">-- æ³¨æ„è¿™é‡Œ Buffer è¡¨çš„åˆ›å»ºè¯­æ³•ï¼Œåé¢å¿…é¡»è¦æœ‰ ASï¼Œå¹¶ä¸”è¿™é‡Œçš„ AS è¿˜ä¸æ˜¯åˆ«åçš„æ„æ€</span></span><br><span class="line"><span class="comment">-- å› ä¸ºåˆ›å»º Buffer æ•°æ®è¡¨çš„æ—¶å€™æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šå­—æ®µï¼Œé‚£ä¹ˆè¿™å¼ è¡¨çš„ç»“æ„é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿä¸ç”¨æƒ³è‚¯å®šå’Œ Memory æ•°æ®è¡¨ä¸€æ ·</span></span><br><span class="line"><span class="comment">-- å› ä¸ºæ•°æ®å°±æ˜¯è¦å¾€å®ƒé‡Œé¢å¯¼ï¼Œæ‰€ä»¥ AS memory_table è¡¨ç¤ºå°†è¡¨ memory_table çš„ç»“æ„ä½œä¸ºè¡¨ buffer_to_memory_table çš„ç»“æ„</span></span><br><span class="line"><span class="comment">-- å½“ç„¶é™¤äº† memory_table è¿˜å¯ä»¥æ˜¯å…¶å®ƒçš„æ•°æ®è¡¨ï¼Œä¸è¿‡ä¸€èˆ¬å’Œç›®æ ‡è¡¨ä¿æŒä¸€è‡´ï¼Œå› ä¸ºæ•°æ®å°±æ˜¯è¦åˆ·åˆ°ç›®æ ‡è¡¨é‡Œé¢çš„</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> buffer_to_memory_table <span class="keyword">AS</span> memory_table</span><br><span class="line">ENGINE <span class="operator">=</span> Buffer(<span class="keyword">default</span>, memory_table, <span class="number">16</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">10000</span>, <span class="number">1000000</span>, <span class="number">10000000</span>, <span class="number">100000000</span>);</span><br><span class="line"><span class="comment">-- æ¥ä¸‹æ¥å‘ Buffer è¡¨é‡Œé¢å†™å…¥ 100 ä¸‡è¡Œæ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> buffer_to_memory_table <span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">1000000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶ buffer_to_memory_table å†…éƒ¨æœ‰æ•°æ®ï¼Œä½† memory_table é‡Œé¢æ²¡æœ‰ï¼Œå› ä¸ºä¸‰ä¸ªæ¡ä»¶ï¼Œæ²¡æœ‰ä¸€ä¸ªè¾¾åˆ°æœ€å¤§é˜ˆå€¼ï¼ˆå‡†ç¡®çš„è¯´æ˜¯è¶…è¿‡ï¼‰ã€‚è€Œåœ¨ 100 ç§’ä¹‹åæ‰ä¼šæœ‰æ•°æ®ï¼Œå¯ä»¥éªŒè¯ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901002957742-783985999.png" alt="img"></p>
<p><strong>ç„¶åæˆ‘ä»¬å†å†™å…¥ä¸€æ‰¹æ•°æ®ï¼Œæ­¤æ—¶æ•°æ®é‡æ”¹ä¸º 100 ä¸‡é›¶ 1 æ¡ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003004810-426340530.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°æ­¤æ—¶ä¸ä¼šç­‰å¾…ï¼ŒBuffer ä¼šç«‹å³å°†æ•°æ®å†™å…¥ç›®æ ‡è¡¨ã€‚</strong></p>
<h3 id="æ—¥å¿—ç±»å‹"><a href="#æ—¥å¿—ç±»å‹" class="headerlink" title="æ—¥å¿—ç±»å‹"></a>æ—¥å¿—ç±»å‹</h3><p><strong>å¦‚æœä½¿ç”¨çš„æ•°æ®é‡å¾ˆå°ï¼ˆä¾‹å¦‚ 100 ä¸‡ä»¥ä¸‹ï¼‰ï¼Œé¢å¯¹çš„æ•°æ®æŸ¥è¯¢åœºæ™¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”æ˜¯ä¸€æ¬¡å†™å…¥å¤šæ¬¡æŸ¥è¯¢çš„æ¨¡å¼ï¼Œé‚£ä¹ˆä½¿ç”¨æ—¥å¿—å®¶æ—ç³»åˆ—çš„è¡¨å¼•æ“å°†ä¼šæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚ä¸åˆå¹¶æ ‘å®¶æ—è¡¨å¼•æ“ç±»ä¼¼ï¼Œæ—¥å¿—å®¶æ—ç³»åˆ—çš„è¡¨å¼•æ“ä¹Ÿæœ‰ä¸€äº›å…±æ€§ç‰¹å¾ï¼šæ¯”å¦‚å‡ä¸æ”¯æŒç´¢å¼•ã€åˆ†åŒºç­‰é«˜çº§ç‰¹æ€§ï¼Œä¸æ”¯æŒå¹¶å‘è¯»å†™ç­‰ç­‰ã€‚å½“é’ˆå¯¹ä¸€å¼ æ—¥å¿—è¡¨å†™å…¥æ•°æ®æ—¶ï¼Œé’ˆå¯¹è¿™å¼ è¡¨çš„æŸ¥è¯¢ä¼šè¢«é˜»å¡ï¼Œç›´è‡³å†™å…¥åŠ¨ä½œç»“æŸã€‚ä½†å®ƒä»¬åŒæ—¶ä¹Ÿæ‹¥æœ‰åˆ‡å®çš„ç‰©ç†å­˜å‚¨ï¼Œæ•°æ®ä¼šè¢«ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œå½“ç„¶é™¤äº†è¿™äº›å…±åŒçš„ç‰¹å¾èŒä½å•Šå•Šï¼Œæ—¥å¿—å®¶æ—ç³»åˆ—çš„è¡¨å¼•æ“ä¹Ÿæœ‰è¿™å„è‡ªçš„ç‰¹ç‚¹ã€‚æ¥ä¸‹æ¥å°±ä»æ€§èƒ½ç”±ä½åˆ°é«˜çš„é¡ºåºï¼Œä¸€ä¾æ¬¡ä»‹ç»è¿™äº›è¡¨å¼•æ“çš„ä½¿ç”¨æ–¹æ³•ã€‚</strong></p>
<h4 id="TinyLog"><a href="#TinyLog" class="headerlink" title="TinyLog"></a>TinyLog</h4><p><strong>TinyLog æ˜¯æ—¥å¿—å®¶æ—ä¸­æ€§èƒ½æœ€ä½çš„è¡¨å¼•æ“ï¼Œå®ƒçš„å­˜å‚¨ç»“æ„ç”±æ•°æ®æ–‡ä»¶å’Œå…ƒæ•°æ®ä¸¤éƒ¨åˆ†ç»„æˆã€‚å…¶ä¸­æ•°æ®æ–‡ä»¶æ˜¯æŒ‰åˆ—å­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ .bin æ–‡ä»¶ï¼Œè¿™ç§ç»“æ„å’Œ MergeTree æœ‰äº›ç›¸ä¼¼ï¼Œä½† TinyLog æ—¢ä¸æ”¯æŒåˆ†åŒºï¼Œä¹Ÿæ²¡æœ‰ .mrk æ ‡è®°æ–‡ä»¶ã€‚ç”±äºæ²¡æœ‰æ ‡è®°æ–‡ä»¶ï¼Œå®ƒè‡ªç„¶æ— æ³•æ”¯æŒ .bin æ–‡ä»¶çš„å¹¶è¡Œè¯»å–æ“ä½œï¼Œæ‰€ä»¥å®ƒåªé€‚åˆåœ¨éå¸¸ç®€å•çš„åœºæ™¯ä¸‹ä½¿ç”¨ã€‚ä¸‹é¢å°±æ¥åˆ›å»ºä¸€å¼  TinyLog æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tiny_log_table (</span><br><span class="line">    id UInt64,   </span><br><span class="line">    code UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> TinyLog(); </span><br><span class="line"><span class="comment">-- æ¥ç€å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tiny_log_table <span class="keyword">SELECT</span> number, number <span class="operator">+</span> <span class="number">1</span> <span class="keyword">FROM</span> numbers(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®å†™å…¥ä¹‹åå°±èƒ½é€šè¿‡ SELECT è¯­å¥å¯¹å®ƒè¿›è¡ŒæŸ¥è¯¢äº†ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºæŸ¥è¯¢ç»“æœäº†ï¼Œéƒ½èƒ½æƒ³åˆ°æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç‰©ç†å­˜å‚¨ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003011837-135493468.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ° id å’Œ code å„è‡ªç”Ÿæˆäº†å¯¹åº”çš„ .bin æ•°æ®æ–‡ä»¶ï¼Œç„¶åè¿˜æœ‰ä¸€ä¸ª sizes.jsonï¼Œé‡Œé¢é€šè¿‡ JSON æ ¼å¼è®°å½•äº†æ¯ä¸ª .bin æ–‡ä»¶å†…å¯¹åº”çš„æ•°æ®å¤§å°ä¿¡æ¯ã€‚</strong></p>
<h4 id="StripeLog"><a href="#StripeLog" class="headerlink" title="StripeLog"></a>StripeLog</h4><p><strong>StripeLog è¡¨å¼•æ“çš„å­˜å‚¨ç»“æ„ç”±å›ºå®šçš„ä¸‰ä¸ªæ–‡ä»¶ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š</strong></p>
<ul>
<li><code>data.binï¼šæ•°æ®æ–‡ä»¶ï¼Œæ‰€æœ‰çš„åˆ—å­—æ®µä½¿ç”¨åŒä¸€ä¸ªæ–‡ä»¶ä¿å­˜ï¼Œæ‰€æœ‰æ•°æ®å‡ä¼šå†™å…¥ data.binï¼Œç±»ä¼¼äºæ•°æ®é‡æ²¡è¶…è¿‡é˜ˆå€¼çš„ MergeTree è¡¨</code></li>
<li><code>index.mrkï¼šæ•°æ®æ ‡è®°ï¼Œä¿å­˜äº†æ•°æ®åœ¨ data.bin æ–‡ä»¶ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œåˆ©ç”¨æ•°æ®æ ‡è®°èƒ½å¤Ÿä½¿ç”¨å¤šä¸ªçº¿ç¨‹ä»¥å¹¶è¡Œçš„æ–¹å¼è¯»å– data.bin å†…çš„å‹ç¼©æ•°æ®å—ï¼Œä»è€Œæå‡æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½</code></li>
<li><code>sizes.jsonï¼šå…ƒæ•°æ®æ–‡ä»¶ï¼Œè®°å½•äº† data.bin å’Œ index.mrk å¤§å°çš„ä¿¡æ¯</code></li>
</ul>
<p><strong>ä»ä¸Šè¿°ä¿¡æ¯èƒ½å¤Ÿå¾—çŸ¥ï¼Œç›¸æ¯” TinyLog è€Œè¨€ï¼ŒStripeLog æ‹¥æœ‰æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼ˆå› ä¸ºå…·æœ‰ .mrk æ–‡ä»¶ï¼Œæ”¯æŒå¹¶è¡ŒæŸ¥è¯¢ï¼‰ï¼ŒåŒæ—¶å…¶ä½¿ç”¨äº†æ›´å°‘çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ‰€æœ‰åˆ—éƒ½ä½¿ç”¨åŒä¸€ä¸ªæ–‡ä»¶ä¿å­˜ï¼‰ã€‚ä¸‹é¢æ¥åˆ›å»º StripeLog æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> stripe_log_table ( </span><br><span class="line">    id UInt64,    </span><br><span class="line">    code UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> StripeLog();</span><br><span class="line"><span class="comment">-- ç„¶åå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> stripe_log_table <span class="keyword">SELECT</span> number, number <span class="operator">+</span> <span class="number">100</span> <span class="keyword">FROM</span> numbers(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®å†™å…¥ä¹‹åå³å¯è¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç›´æ¥æŸ¥çœ‹ä¸€ä¸‹ç‰©ç†å­˜å‚¨ç›®å½•ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003018972-1358099321.png" alt="img"></p>
<p><strong>é‡Œé¢åªæœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œå…¶ä»£è¡¨çš„å«ä¹‰æ˜¾ç„¶æ— éœ€è§£é‡Šäº†ã€‚</strong></p>
<h4 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h4><p><strong>Log è¡¨å¼•æ“ç»“åˆäº† TinyLog å’Œ StripeLog ä¸¤ä¸ªè¡¨å¼•æ“çš„é•¿å¤„ï¼Œæ˜¯æ—¥å¿—å®¶æ—ç³»åˆ—ä¸­æ€§èƒ½æœ€é«˜çš„è¡¨å¼•æ“ï¼ŒLog è¡¨å¼•æ“çš„å­˜å‚¨ç»“æ„ç”± 3 ä¸ªéƒ¨åˆ†ç»„æˆï¼š</strong></p>
<ul>
<li><code>[column].binï¼šæ•°æ®æ–‡ä»¶ï¼Œæ•°æ®æ–‡ä»¶æŒ‰åˆ—ç‹¬ç«‹å­˜å‚¨ï¼Œæ¯ä¸€ä¸ªåˆ—å­—æ®µéƒ½æ‹¥æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ .bin æ–‡ä»¶</code></li>
<li><code>__marks.mrkï¼šæ•°æ®æ ‡è®°ï¼Œç»Ÿä¸€ä¿å­˜äº†æ•°æ®åœ¨å„ä¸ª [column].bin æ–‡ä»¶ä¸­çš„ä½ç½®ä¿¡æ¯ï¼Œåˆ©ç”¨æ•°æ®æ ‡è®°èƒ½å¤Ÿä½¿ç”¨å¤šä¸ªçº¿ç¨‹ä»¥å¹¶è¡Œçš„æ–¹å¼è¯»å– [column].bin å†…çš„å‹ç¼©æ•°æ®å—ï¼Œä»è€Œæå‡æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½</code></li>
<li><code>sizes.jsonï¼šå…ƒæ•°æ®æ–‡ä»¶ï¼Œè®°å½•äº† [column].bin å’Œ __marks.mrk å¤§å°çš„ä¿¡æ¯</code></li>
</ul>
<p><strong>ä¸‹é¢åˆ›å»º Log æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> log_table (  </span><br><span class="line">    id UInt64,    </span><br><span class="line">    code UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="built_in">Log</span>();</span><br><span class="line"><span class="comment">-- ç„¶åå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> log_table <span class="keyword">SELECT</span> number, number <span class="operator">+</span> <span class="number">100</span> <span class="keyword">FROM</span> numbers(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®å†™å…¥ä¹‹åå³å¯è¿›è¡ŒæŸ¥è¯¢ï¼Œç›¸ä¿¡éƒ½èƒ½çœ‹å‡º TinyLogã€StripeLogã€Log ä¹‹é—´æ˜¯é«˜åº¦ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯åªçœ‹ä¸€ä¸‹ç›®å½•ç»“æ„ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003025726-1365104681.png" alt="img"></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯æ—¥å¿—ç±»å‹çš„è¡¨å¼•æ“ï¼Œä¸ªäººè§‰å¾—ç®—æ˜¯æœ€ç®€å•çš„äº†ï¼Œç”šè‡³æ¯”å†…å­˜ç±»å‹çš„è¡¨å¼•æ“è¿˜è¦ç®€å•ã€‚</strong></p>
<h3 id="æ¥å£ç±»å‹"><a href="#æ¥å£ç±»å‹" class="headerlink" title="æ¥å£ç±»å‹"></a>æ¥å£ç±»å‹</h3><p><strong>æœ‰è¿™ä¹ˆä¸€ç±»è¡¨å¼•æ“ï¼Œå®ƒä»¬è‡ªèº«å¹¶ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯åƒç²˜åˆå‰‚ä¸€æ ·å¯ä»¥æ•´åˆå…¶å®ƒçš„æ•°æ®è¡¨ã€‚åœ¨ä½¿ç”¨è¿™ç±»è¡¨å¼•æ“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒåº•å±‚çš„å¤æ‚æ€§ï¼Œå®ƒä»¬å°±åƒæ¥å£ä¸€æ ·ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç»Ÿä¸€çš„è®¿é—®ç•Œé¢ï¼Œæ‰€ä»¥å°†å®ƒä»¬å½’ä¸ºæ¥å£ç±»è¡¨å¼•æ“ã€‚</strong></p>
<h4 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h4><p><strong>å‡è®¾æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼šåœ¨æ•°æ®ä»“åº“çš„è®¾è®¡ä¸­ï¼Œæ•°æ®æŒ‰å¹´åˆ†è¡¨å­˜å‚¨ï¼Œä¾‹å¦‚ test_table_2018ã€test_table_2019 å’Œ test_table_2020ï¼Œä½†æ˜¯ç°åœ¨éœ€è¦è·¨å¹´åº¦æŸ¥è¯¢è¿™äº›æ•°æ®ï¼Œåº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œä½¿ç”¨ Merge è¡¨å¼•æ“å°±æ˜¯ä¸€ç§å¾ˆåˆé€‚çš„é€‰æ‹©äº†ã€‚</strong></p>
<p><strong>Merge è¡¨å¼•æ“å°±å¦‚åŒä¸€å±‚ä½¿ç”¨äº†é—¨é¢æ¨¡å¼çš„ä»£ç†ï¼Œå®ƒæœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œä¹Ÿä¸æ”¯æŒæ•°æ®å†™å…¥ï¼Œå®ƒçš„ä½œç”¨å°±å¦‚åŒå®ƒçš„åå­—ï¼Œå³è´Ÿè´£åˆå¹¶å¤šä¸ªæŸ¥è¯¢ç»“æœé›†ã€‚Merge è¡¨å¼•æ“å¯ä»¥ä»£ç†æŸ¥è¯¢ä»»æ„æ•°é‡çš„æ•°æ®è¡¨ï¼Œè¿™äº›æŸ¥è¯¢ä¼šå¼‚æ­¥ä¸”å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶æœ€ç»ˆåˆå¹¶æˆä¸€ä¸ªç»“æœé›†è¿”å›ã€‚è¢«ä»£ç†æŸ¥è¯¢çš„æ•°æ®è¡¨è¢«è¦æ±‚å¤„äºåŒä¸€ä¸ªæ•°æ®åº“å†…ï¼Œä¸”æ‹¥æœ‰ç›¸åŒçš„è¡¨ç»“æ„ï¼Œä½†å®ƒä»¬å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¡¨å¼•æ“ä»¥åŠä¸åŒçš„åˆ†åŒºå®šä¹‰ï¼ˆå¯¹äº MergeTree è€Œè¨€ï¼‰ã€‚</strong></p>
<p><strong>Merge è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = Merge(database, table_name)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ database ä¸ºæ•°æ®åº“çš„åç§°ï¼Œtable_name ä¸ºæ•°æ®è¡¨çš„åç§°ï¼Œå®ƒæ”¯æŒä½¿ç”¨æ­£å¼åˆ™è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ ^ è¡¨ç¤ºåˆå¹¶æ‰€æœ‰ä»¥ test ä¸ºå‰ç¼€çš„æ•°æ®è¡¨ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•è¯´æ˜ä¸€ä¸‹ Merge çš„ä½¿ç”¨æ–¹æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- test_table_2018 ä¿å­˜äº† 2018 å¹´çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_table_2018 (</span><br><span class="line">    id String,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    code String</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç„¶åæ˜¯ test_table_2019ï¼Œå®ƒçš„ç»“æ„å’Œ test_table_2018 ç›¸åŒï¼Œä½†ä½¿ç”¨äº†ä¸åŒçš„è¡¨å¼•æ“</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_table_2019 (</span><br><span class="line">    id String,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    code String</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="built_in">Log</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç„¶ååˆ›å»º Merge è¡¨å°†ä¸Šé¢ä¸¤å¼ è¡¨ç»“åˆï¼Œè¿™é‡Œçš„ AS ç›¸å½“äºä¸º merge_test_table_2018_and_2019 æŒ‡å®šè¡¨ç»“æ„</span></span><br><span class="line"><span class="comment">-- æ˜¾ç„¶è¿™é‡Œä¼šå¤åˆ¶ test_table_2018 çš„è¡¨ç»“æ„</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> merge_test_table_2018_and_2019 <span class="keyword">AS</span> test_table_2018</span><br><span class="line">ENGINE <span class="operator">=</span> <span class="keyword">Merge</span>(currentDatabase(), <span class="string">&#x27;^test_table_201&#x27;</span>)</span><br><span class="line"><span class="comment">-- currentDatabase() è¡¨ç¤ºè·å–å½“å‰çš„æ•°æ®åº“</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæˆ‘ä»¬æ¥å†™å…¥ä¸€äº›æ•°æ®ï¼Œç„¶åè¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003033723-71170041.png" alt="img"></p>
<p><strong>é€šè¿‡è¿”å›çš„ç»“æœé›†å¯ä»¥å°è¯ï¼Œæ‰€æœ‰ä»¥ test_table_201 å¼€å¤´çš„æ•°æ®è¡¨éƒ½è¢«åˆ†åˆ«æŸ¥è¯¢ï¼Œç„¶ååˆå¹¶è¿”å›äº†ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹äº Merge æ•°æ®è¡¨è€Œè¨€ï¼Œä¼šæœ‰ä¸€ä¸ªè™šæ‹Ÿå­—æ®µ _tableï¼Œå®ƒè¡¨ç¤ºæŸè¡Œæ•°æ®çš„æ¥æºè¡¨ã€‚æ‰€ä»¥é€šè¿‡ _table æˆ‘ä»¬å¯ä»¥å®ç°è¡¨çš„è¿‡æ»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬æ–°åˆ›å»ºäº† test_table_2017 è¡¨ç¤º 2017 çš„æ•°æ®ï¼Œä½†å½“å‰æˆ‘ä»¬å¹¶ä¸”ä¸éœ€è¦ 2017 çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†å…¶ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ç»™è¿‡æ»¤æ‰ï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> merge_test_table_2018_and_2019 <span class="keyword">WHERE</span> _table <span class="operator">!=</span> <span class="string">&#x27;test_table_2017&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿˜æ˜¯è›®æ–¹ä¾¿çš„ï¼Œæ­¤æ—¶ _table å°†ç­‰åŒäºç´¢å¼•ï¼ŒMerge è¡¨å¿½ç•¥é‚£äº›è¢«æ’é™¤åœ¨å¤–çš„è¡¨ï¼Œä¸ä¼šå‘ä»–ä»¬å‘èµ·æŸ¥è¯¢è¯·æ±‚ã€‚</strong></p>
<h4 id="Dictionary"><a href="#Dictionary" class="headerlink" title="Dictionary"></a>Dictionary</h4><p><strong>è¿™é‡Œæ¶‰åŠåˆ°äº†æ•°æ®å­—å…¸ï¼Œå…³äºæ•°æ®å­—å…¸æˆ‘ä»¬ä¼šä¸“é—¨æ”¾åœ¨åé¢è¯´ï¼Œç›®å‰å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹ã€‚Dictionary è¡¨å¼•æ“æ˜¯æ•°æ®å­—å…¸çš„ä¸€å±‚ä»£ç†å°è£…ï¼Œå®ƒå¯ä»¥å–ä»£å­—å…¸å‡½æ•°ï¼Œè®©ç”¨æˆ·é€šè¿‡æ•°æ®è¡¨æŸ¥è¯¢å­—å…¸ã€‚å­—å…¸å†…çš„æ•°æ®è¢«åŠ è½½åï¼Œä¼šå…¨éƒ¨ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥ä½¿ç”¨ Dictionary å¯¹å­—å…¸æ€§èƒ½æ²¡æœ‰ä»»ä½•å½±å“ã€‚å£°æ˜ Dictionary æ•°æ®è¡¨çš„æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = Dictionary(dict_name)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ dict_name å¯¹åº”ä¸€ä¸ªå·²è¢«åŠ è½½çš„å­—å…¸åç§°ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_test_flat_dict ( </span><br><span class="line">    id UInt64,    </span><br><span class="line">    code String,  </span><br><span class="line">    name String</span><br><span class="line">) ENGINE <span class="operator">=</span> Dictionary(test_flat_dict)  </span><br></pre></td></tr></table></figure>

<p><strong>tb_test_flat_dict ç­‰åŒäºæ•°æ®å­—å…¸ test_flat_dict çš„ä»£ç†è¡¨ï¼Œå¯¹å®ƒè¿›è¡Œ SELECT æŸ¥è¯¢å³å¯è·å–å†…éƒ¨çš„æ•°æ®ã€‚</strong></p>
<h4 id="Distributed"><a href="#Distributed" class="headerlink" title="Distributed"></a>Distributed</h4><p><strong>åœ¨æ•°æ®åº“é¢†åŸŸï¼Œå½“é¢å¯¹æµ·é‡ä¸šåŠ¡æ•°æ®çš„æ—¶å€™ï¼Œä¸€ç§ä¸»æµçš„åšæ³•æ˜¯å®æ–½ Sharding æ–¹æ¡ˆï¼Œå³å°†ä¸€å¼ æ•°æ®è¡¨æ¨ªå‘æ‰©å±•åˆ°å¤šä¸ªæ•°æ®åº“å®ä¾‹ã€‚å…¶ä¸­æ¯ä¸ªæ•°æ®åº“å®ä¾‹ç§°ä¸ºä¸€ä¸ª Shard åˆ†ç‰‡ï¼Œæ•°æ®åœ¨å†™å…¥æ—¶ï¼Œéœ€è¦æŒ‰ç…§é¢„å®šçš„ä¸šåŠ¡è§„åˆ™å‡åŒ€åœ°å†™è‡³å„ä¸ª Shard åˆ†ç‰‡ï¼›è€Œåœ¨æ•°æ®æŸ¥è¯¢æ—¶ï¼Œåˆ™éœ€è¦åœ¨æ¯ä¸ª Shard åˆ†ç‰‡ä¸Šåˆ†åˆ«æŸ¥è¯¢ï¼Œæœ€åå½’å¹¶ç»“æœé›†ã€‚æ‰€ä»¥ä¸ºäº†å®ç° Sharding æ–¹æ¡ˆï¼Œä¸€æ¬¾æ”¯æŒåˆ†å¸ƒå¼æ•°æ®åº“çš„ä¸­é—´ä»¶æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œä¾‹å¦‚ Apache ShardingSphereã€‚</strong></p>
<p><strong>ClickHouse ä½œä¸ºä¸€æ¬¾æ€§èƒ½å“è¶Šçš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè‡ªç„¶ä¹Ÿæ˜¯æ”¯æŒ Sharding æ–¹æ¡ˆçš„ï¼Œè€Œ Distributed è¡¨å¼•æ“å°±ç­‰åŒäº Sharding æ–¹æ¡ˆä¸­çš„æ•°æ®åº“ä¸­é—´ä»¶ã€‚Distributed è¡¨å¼•æ“è‡ªèº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒèƒ½å¤Ÿä½œä¸ºåˆ†å¸ƒå¼è¡¨çš„ä¸€å±‚é€æ˜ä»£ç†ï¼Œåœ¨é›†ç¾¤å†…éƒ¨è‡ªåŠ¨å¼€å±•æ•°æ®çš„å†™å…¥åˆ†å‘ä»¥åŠæŸ¥è¯¢è·¯ç”±å·¥ä½œã€‚å…³äº Distributed è¡¨å¼•æ“çš„è¯¦ç»†ä»‹ç»ï¼Œå°†ä¼šåœ¨åç»­å±•å¼€ã€‚</strong></p>
<h3 id="å…¶å®ƒç±»å‹"><a href="#å…¶å®ƒç±»å‹" class="headerlink" title="å…¶å®ƒç±»å‹"></a>å…¶å®ƒç±»å‹</h3><p><strong>æ¥ä¸‹æ¥å°†è¦ä»‹ç»çš„å‡ æ¬¾è¡¨å¼•æ“ï¼Œç”±äºå„è‡ªç”¨é€”è¿¥å¼‚ï¼Œæ‰€ä»¥åªå¥½æŠŠå®ƒä»¬å½’ä¸ºå…¶å®ƒç±»å‹ã€‚æœ€ç„¶è¿™äº›è¡¨å¼•æ“çš„ä½¿ç”¨åœºæ™¯å¹¶ä¸å¹¿æ³›ï¼Œä½†ä»å»ºè®®äº†è§£å®ƒä»¬çš„ç‰¹æ€§å’Œä½¿ç”¨æ–¹æ³•ï¼Œå› ä¸ºè¿™äº›è¡¨å¼•æ“æ‰©å……äº† ClickHouse çš„èƒ½åŠ›è¾¹ç•Œã€‚åœ¨ä¸€äº›ç‰¹æ®Šçš„åœºåˆï¼Œå®ƒä»¬ä¹Ÿèƒ½å¤Ÿå‘æŒ¥é‡è¦ä½œç”¨ã€‚</strong></p>
<h4 id="Live-View"><a href="#Live-View" class="headerlink" title="Live View"></a>Live View</h4><p><strong>è™½ç„¶ ClickHouse å·²ç»æä¾›äº†å‡†å®æ—¶çš„æ•°æ®å¤„ç†æ‰‹æ®µï¼Œä¾‹å¦‚ Kafka è¡¨å¼•æ“å’Œç‰©åŒ–è§†å›¾ï¼Œä½†æ˜¯åœ¨åº”ç”¨å±‚é¢ï¼Œä¸€ç›´ç¼ºä¹å¼€æ”¾ç»™ç”¨æˆ·çš„äº‹ä»¶ç›‘å¬æœºåˆ¶ã€‚æ‰€ä»¥ä» 19.14 ç‰ˆæœ¬å¼€å§‹ï¼ŒClickHouse æä¾›äº†ä¸€ç§å…¨æ–°çš„è§†å›¾ï¼šLive Viewã€‚</strong></p>
<p><strong>Live View æ˜¯ä¸€ç§ç‰¹æ®Šçš„è§†å›¾ï¼Œè™½ç„¶å®ƒå¹¶ä¸å±äºè¡¨å¼•æ“ï¼Œä½†æ˜¯å› ä¸ºå®ƒä¸æ•°æ®è¡¨æ¯æ¯ç›¸å…³ï¼Œæ‰€ä»¥è¿˜æ˜¯æŠŠ LiveView å½’ç±»åˆ°äº†è¿™é‡Œã€‚Live View çš„ä½œç”¨ç±»ä¼¼äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€æ¡ SQL æŸ¥è¯¢ç»“æœä½œä¸ºç›‘æ§ç›®æ ‡ï¼Œå½“ç›®æ ‡æ•°æ®å¢åŠ æ—¶ï¼ŒLiveView å¯ä»¥åŠæ—¶å‘å‡ºå“åº”ã€‚è‹¥è¦ä½¿ç”¨ Live Viewï¼Œé¦–å…ˆéœ€è¦å°† allow_experimental_live_view å‚æ•°è®¾ç½®ä¸º 1ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥ç¡®è®¤å‚æ•°æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003041543-1642442471.png" alt="img"></p>
<p><strong>ç°åœ¨æ¥ä¸¾ä¾‹è¯´æ˜ï¼Œé¦–å…ˆåˆ›å»ºä¸€å¼ æ•°æ®è¡¨ï¼Œå®ƒå°†ä½œä¸º Live View çš„ç›‘å¬ç›®æ ‡ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> origin_table (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="built_in">Log</span>();</span><br><span class="line"><span class="comment">-- ç´§æ¥ç€åˆ›å»ºä¸€ä¸ª Live View</span></span><br><span class="line"><span class="keyword">CREATE</span> LIVE <span class="keyword">VIEW</span> lv_origin <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> origin_table;</span><br><span class="line"><span class="comment">-- ç„¶åæ‰§è¡Œ watch å‘½ä»¤å¼€å¯ç›‘å¬æ¨¡å¼</span></span><br><span class="line"><span class="comment">-- ä»¥åæ¯å½“ origin_table ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ‰§è¡Œ SELECT COUNT(*)</span></span><br><span class="line">WATCH lv_origin;</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æ­¤ä¸€æ¥ Live View å°±è¿›å…¥ç›‘å¬æ¨¡å¼äº†ï¼Œé¦–å…ˆ origin_table é‡Œé¢æ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œæ‰€ä»¥æ˜¾ç¤ºç»“æœä¸º 0ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003047770-2122133580.png" alt="img"></p>
<p><strong>ç„¶åå†å¼€å¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå‘ origin_table é‡Œé¢å†™å…¥æ•°æ®ï¼Œå‡è®¾å†™å…¥ 10 æ¡ã€‚æ•°æ®å†™å…¥ä¹‹åä¼šå‘ç° Live View åšå‡ºäº†å®æ—¶å“åº”ï¼ŒæŸ¥è¯¢çš„å€¼å˜æˆäº† 10ï¼Œå¹¶ä¸”è™šæ‹Ÿå­—æ®µ _version ä¼šä¼´éšç€æ¯ä¸€æ¬¡çš„å“åº”å¢åŠ  1ã€‚</strong></p>
<h4 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h4><p><strong>Null è¡¨å¼•æ“çš„åŠŸèƒ½ä¸ä½œç”¨ï¼Œä¸ Unix ç³»ç»Ÿçš„ç©ºè®¾å¤‡ &#x2F;dev&#x2F;null å¾ˆç›¸ä¼¼ï¼Œå¦‚æœç”¨æˆ·å‘ Null è¡¨å†™å…¥æ•°æ®ï¼Œç³»ç»Ÿä¼šæ­£ç¡®è¿”å›ï¼Œä½†æ•°æ®ä¼šè¢« Null è¡¨è‡ªåŠ¨å¿½ç•¥ï¼Œæ°¸è¿œä¸ä¼šå°†å®ƒä»¬ä¿å­˜ã€‚å¦‚æœç”¨æˆ·å‘ Null è¡¨å‘èµ·æŸ¥è¯¢ï¼Œé‚£ä¹ˆå®ƒå°†è¿”å›ç©ºã€‚åœ¨ä½¿ç”¨ç‰©åŒ–è§†å›¾çš„æ—¶å€™ï¼Œå¦‚æœä¸å¸Œæœ›ä¿ç•™æºè¡¨çš„æ•°æ®ï¼Œé‚£ä¹ˆå°†æºè¡¨è®¾ç½®æˆ Null å¼•æ“å°†ä¼šæ˜¯éå¸¸å¥½çš„é€‰æ‹©ã€‚ä¸‹é¢å°±æ¥ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é¦–å…ˆåˆ›å»ºä¸€å¼  Null è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> null_table (id UInt8) ENGINE <span class="operator">=</span> <span class="keyword">Null</span>();</span><br><span class="line"><span class="comment">-- æ¥ç€ä»¥ null_table ä¸ºæºè¡¨ï¼Œå»ºç«‹ä¸€å¼ ç‰©åŒ–è§†å›¾</span></span><br><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> view_table</span><br><span class="line">ENGINE <span class="operator">=</span> TinyLog() <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> null_table</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœå¾€ null_table é‡Œé¢å†™æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®ä¼šè¢«é¡ºåˆ©åŒæ­¥åˆ° view_table ä¸­ï¼Œä½†æ˜¯ null_table ä¸­æ˜¯æŸ¥è¯¢ä¸åˆ°æ•°æ®çš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003056841-1947455603.png" alt="img"></p>
<h4 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h4><p><strong>URL è¡¨å¼•æ“çš„ä½œç”¨ç­‰ä»·äº HTTP å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥é€šè¿‡ HTTP&#x2F;HTTPS åè®®ï¼Œç›´æ¥è®¿é—®è¿œç«¯çš„ REST æœåŠ¡ã€‚å½“æ‰§è¡Œ SELECT æŸ¥è¯¢çš„æ—¶å€™ï¼Œåº•å±‚ä¼šå°†å…¶è½¬æ¢ä¸º GET è¯·æ±‚çš„è¿œç¨‹è°ƒç”¨ï¼›è€Œæ‰§è¡Œ INSERT æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šå°†å…¶è½¬æˆ POST è¯·æ±‚çš„è¿œç¨‹è°ƒç”¨ï¼Œå¹¶å°†æ•°æ®ä»¥å­—èŠ‚æµçš„å½¢å¼ä¼ é€’ã€‚URL è¡¨å¼•æ“çš„å£°æ˜æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = URL(&#x27;url&#x27;, format)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ url è¡¨ç¤ºè¿œç«¯çš„æœåŠ¡åœ°å€ï¼Œè€Œ format åˆ™æ˜¯ ClickHouse æ”¯æŒçš„æ•°æ®æ ¼å¼ï¼Œå¦‚ TSVã€CSV å’Œ JSON ç­‰ã€‚</strong></p>
<p><strong>è¿™é‡Œæˆ‘ä»¬ç”¨ Python çš„ FastAPI ç¼–å†™ä¸€ä¸ª web æœåŠ¡ï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request, Response</span><br><span class="line"><span class="keyword">import</span> orjson</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">table = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/girls&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">    response = Response(orjson.dumps(table),</span><br><span class="line">                        media_type=<span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/girls&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">request: Request</span>):</span><br><span class="line">    <span class="comment"># å¦‚æœæ’å…¥å¤šè¡Œæ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¹‹é—´ä¼šä»¥ \n è¿›è¡Œåˆ†å‰²</span></span><br><span class="line">    data = re.split(<span class="string">rb&quot;(?&lt;=&#125;)\n(?=&#123;)&quot;</span>, <span class="keyword">await</span> request.body())</span><br><span class="line">    rows = [orjson.loads(_) <span class="keyword">for</span> _ <span class="keyword">in</span> data]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(rows, <span class="built_in">dict</span>):</span><br><span class="line">        table.append(rows)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.extend(rows)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5555</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å¯åŠ¨ä¹‹åæˆ‘ä»¬æ¥åˆ›å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> url_table (</span><br><span class="line">    id UInt32,</span><br><span class="line">    name String,</span><br><span class="line">    place String</span><br><span class="line">) ENGINE <span class="operator">=</span> URL(<span class="string">&#x27;http://localhost:5555/girls&#x27;</span>, JSONEachRow)</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥åæ¯æ‰§è¡Œä¸€æ¬¡ SELECT éƒ½ç›¸å½“äºå‘èµ·äº†ä¸€æ¬¡ GET è¯·æ±‚ï¼Œæ‰§è¡Œä¸€æ¬¡ INSERT ç›¸å½“äºå‘èµ·äº†ä¸€æ¬¡ POST è¯·æ±‚ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E5%85%B6%E5%AE%83%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E(%E5%85%AB)/1229382-20210901003104903-1326901560.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹å‡º ClickHouse æƒ³çš„çœŸæ˜¯æ— æ¯”å‘¨åˆ°ï¼Œè€ƒè™‘äº†å¤§é‡çš„æ•°æ®æºï¼Œä»¥ä¸Šå°±æ˜¯å…¶å®ƒè¡¨å¼•æ“çš„å…¨éƒ¨å†…å®¹ã€‚è‡³äº Dictionary å’Œ Distributed ä¸¤ä¸ªè¡¨å¼•æ“æˆ‘ä»¬åé¢å†è¯´ï¼Œå› ä¸ºæ¶‰åŠäº†è¿˜æ²¡ä»‹ç»çš„å†…å®¹ã€‚</strong></p>
<p><strong>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çŸ¥é“äº†é™¤äº† MergeTree å®¶æ—è¡¨å¼•æ“ä¹‹å¤–è¿˜æœ‰å¦å¤– 5 ç§è¡¨å¼•æ“ï¼Œè¿™äº›è¡¨å¼•æ“ä¸°å¯Œäº† ClickHouse çš„ä½¿ç”¨åœºæ™¯ï¼Œæ‰©å……äº† ClickHouse çš„ä½¿ç”¨ç•Œé™ã€‚ä¸‹é¢å†æ€»ç»“ä¸€ä¸‹ï¼š</strong></p>
<ul>
<li><strong>å¤–éƒ¨å­˜å‚¨ç±»å‹çš„è¡¨å¼•æ“å’Œ Hive çš„å¤–éƒ¨è¡¨å¾ˆç±»ä¼¼ï¼Œå®ƒä»¬åªè´Ÿè´£å…ƒæ•°æ®çš„ç®¡ç†å’Œæ•°æ®æŸ¥è¯¢ï¼Œè‡ªèº«å¹¶ä¸è´Ÿè´£æ•°æ®çš„ç”Ÿæˆï¼Œæ•°æ®æ–‡ä»¶ç›´æ¥ç”±å¤–éƒ¨ç³»ç»Ÿç»´æŠ¤ã€‚å®ƒä»¬å¯ä»¥ç›´æ¥è¯»å– HDFSã€æœ¬åœ°æ–‡ä»¶ã€å¸¸è§å…³ç³»å‹æ•°æ®åº“ä»¥åŠ Kafka çš„æ•°æ®ã€‚</strong></li>
<li><strong>å†…å­˜ç±»å‹çš„è¡¨å¼•æ“ä¸­çš„æ•°æ®æ˜¯å¸¸é©»å†…å­˜çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ‹¥æœ‰å ªæ¯” MergeTree çš„æŸ¥è¯¢æ€§èƒ½ï¼ˆ1 äº¿æ•°æ®é‡ä»¥å†…ï¼‰ï¼Œå…¶ä¸­ Set å’Œ Join è¡¨å¼•æ“æ‹¥æœ‰ç‰©ç†å­˜å‚¨ï¼Œæ•°æ®åœ¨å†™å…¥å†…å­˜çš„åŒæ—¶ä¹Ÿä¼šè¢«åˆ·åˆ°ç£ç›˜ï¼›è€Œ Memory å’Œ Buffer è¡¨å¼•æ“åœ¨æœåŠ¡é‡å¯ä¹‹åï¼Œæ•°æ®ä¾¿ä¼šè¢«æ¸…ç©ºã€‚å†…å­˜ç±»è¡¨å¼•æ“æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œåœ¨æ•°æ®å¤§äº 1 äº¿çš„åœºæ™¯ä¸‹ä¸å»ºè®®ä½¿ç”¨å†…å­˜ç±»å‹çš„è¡¨å¼•æ“ã€‚</strong></li>
<li><strong>æ¥å£ç±»å‹çš„è¡¨å¼•æ“è‡ªèº«å¹¶ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯åƒç²˜åˆå‰‚ä¸€æ ·å¯ä»¥æ•´åˆå…¶å®ƒçš„æ•°æ®è¡¨ï¼Œå…¶ä¸­ Merge è¡¨å¼•æ“èƒ½å¤Ÿåˆå¹¶æŸ¥è¯¢ä»»æ„ä¸¤å¼ è¡¨ç»“æ„ç›¸åŒçš„æ•°æ®è¡¨ï¼›Dictionary è¡¨å¼•æ“èƒ½å¤Ÿä»£ç†æŸ¥è¯¢æ•°æ®å­—å…¸ï¼›è€Œ Distributed è¡¨å¼•æ“çš„ä½œç”¨ç±»ä¼¼åˆ†å¸ƒå¼æ•°æ®åº“çš„åˆ†è¡¨ä¸­é—´ä»¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·ç®€åŒ–æ•°æ®çš„åˆ†å‘å’Œè·¯ç”±å·¥ä½œã€‚</strong></li>
<li><strong>å…¶å®ƒç±»å‹çš„è¡¨å¼•æ“ç”¨é€”å„ä¸ç›¸åŒï¼Œå…¶ä¸­ Live View æ˜¯ä¸€ç§ç‰¹æ®Šçš„è§†å›¾ï¼Œèƒ½å¤Ÿå¯¹ SQL æŸ¥è¯¢è¿›è¡Œå®æ—¶ç›‘å¬ï¼›Null è¡¨å¼•æ“ç±»ä¼¼äº Linux ç³»ç»Ÿçš„ç©ºè®¾å¤‡ &#x2F;dev&#x2F;nullï¼Œé€šå¸¸å’Œç‰©åŒ–è§†å›¾ä¸€èµ·æ­é…ä½¿ç”¨ï¼›è€Œ URL è¡¨å¼•æ“ç±»ä¼¼äº HTTP å®¢æˆ·ç«¯ï¼Œèƒ½å¤Ÿä»£ç†è°ƒç”¨è¿œç«¯çš„ REST æœåŠ¡ã€‚</strong></li>
</ul>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree çš„æ·±åº¦åŸç†è§£æ(å…­)</title>
    <url>/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/</url>
    <content><![CDATA[<h1 id="ClickHouse-ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree-çš„æ·±åº¦åŸç†è§£æ-å…­"><a href="#ClickHouse-ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree-çš„æ·±åº¦åŸç†è§£æ-å…­" class="headerlink" title="ClickHouse ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree çš„æ·±åº¦åŸç†è§£æ(å…­)"></a>ClickHouse ä¸­æœ€é‡è¦çš„è¡¨å¼•æ“ï¼šMergeTree çš„æ·±åº¦åŸç†è§£æ(å…­)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><p><strong>è¡¨å¼•æ“æ˜¯ ClickHouse ä¸­çš„ä¸€å¤§ç‰¹è‰²ï¼Œå¯ä»¥è¯´è¡¨å¼•æ“å†³å®šäº†ä¸€å¼ è¡¨æœ€ç»ˆçš„æ€§æ ¼ï¼Œæ¯”å¦‚æ•°æ®è¡¨æ‹¥æœ‰ä½•ç§ç‰¹æ€§ã€æ•°æ®ä»¥ä½•ç§å½¢å¼è¢«å­˜å‚¨ä»¥åŠå¦‚ä½•è¢«åŠ è½½ã€‚ClickHouse æ‹¥æœ‰éå¸¸åºå¤§çš„è¡¨å¼•æ“ä½“ç³»ï¼Œæ€»å…±æœ‰åˆå¹¶æ ‘ã€å¤–éƒ¨å­˜å‚¨ã€å†…å­˜ã€æ–‡ä»¶ã€æ¥å£å’Œå…¶å®ƒ 6 å¤§ç±» 20 å¤šç§è¡¨å¼•æ“ï¼Œè€Œåœ¨è¿™ä¼—å¤šçš„è¡¨å¼•æ“ä¸­ï¼Œåˆå±åˆå¹¶æ ‘ï¼ˆMergeTreeï¼‰è¡¨å¼•æ“åŠå…¶å®¶æ—ç³»åˆ—ï¼ˆ*MergeTreeï¼‰æœ€ä¸ºå¼ºå¤§ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç»å¤§éƒ¨åˆ†åœºæ™¯éƒ½ä¼šä½¿ç”¨æ­¤å¼•æ“ã€‚å› ä¸ºåªæœ‰åˆå¹¶æ ‘ç³»åˆ—çš„è¡¨å¼•æ“æ‰æ”¯æŒä¸»é”®ç´¢å¼•ã€æ•°æ®åˆ†åŒºã€æ•°æ®å‰¯æœ¬ã€æ•°æ®é‡‡æ ·ç­‰ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿåªæœ‰æ­¤ç³»åˆ—çš„è¡¨å¼•æ“æ”¯æŒ ALTER ç›¸å…³æ“ä½œã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬ç€é‡ä»‹ç»åˆå¹¶æ ‘ï¼Œå› ä¸ºå®ƒéå¸¸éå¸¸éå¸¸é‡è¦ï¼Œå¹¶ä¸”éš¾åº¦ä¹Ÿæœ€é«˜ï¼Œè‡³äºå…¶å®ƒçš„è¡¨å¼•æ“ç”±äºæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ”¾åˆ°åé¢å†ä»‹ç»ã€‚</strong></p>
<p><strong>å½“ç„¶æˆ‘ä»¬è¯´åˆå¹¶æ ‘å®¶æ—è‡ªèº«ä¹Ÿæœ‰å¾ˆå¤šè¡¨å¼•æ“çš„å˜ç§ï¼Œå…¶ä¸­ MergeTree ä½œä¸ºå®¶æ—ä¸­æœ€ä¸ºåŸºç¡€çš„è¡¨å¼•æ“ï¼Œæä¾›äº†ä¸»é”®ç´¢å¼•ã€æ•°æ®åˆ†åŒºã€æ•°æ®å‰¯æœ¬å’Œæ•°æ®é‡‡æ ·ç­‰åŸºæœ¬èƒ½åŠ›ï¼Œè€Œå®¶æ—ä¸­çš„å…¶å®ƒå…¶å®ƒè¡¨å¼•æ“åˆ™åœ¨ MergeTree çš„åŸºç¡€ä¹‹ä¸Šå„æœ‰æ‰€é•¿ã€‚æ¯”å¦‚ ReplacingMergeTree è¡¨å¼•æ“å…·æœ‰åˆ é™¤é‡å¤æ•°æ®çš„ç‰¹æ€§ï¼Œè€Œ SummingMergeTree è¡¨å¼•æ“åˆ™ä¼šæŒ‰ç…§æ’åºé”®è‡ªåŠ¨èšåˆæ•°æ®ã€‚å¦‚æœå†ç»™åˆå¹¶æ ‘ç³»åˆ—çš„è¡¨å¼•æ“åŠ ä¸Š Replicated å‰ç¼€ï¼Œåˆä¼šå¾—åˆ°ä¸€ç»„æ”¯æŒæ•°æ®å‰¯æœ¬çš„è¡¨å¼•æ“ï¼Œä¾‹å¦‚ ReplicatedMergeTreeã€ReplicatedReplacingMergeTreeã€ReplicatedSummingMergeTreeã€ReplicatedAggregatingMergeTree ç­‰ç­‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121005343-128425369.png" alt="img"></p>
<p><strong>è™½ç„¶åˆå¹¶æ ‘çš„å˜ç§æœ‰å¾ˆå¤šï¼Œä½† MergeTree è¡¨å¼•æ“æ‰æ˜¯æ ¹åŸºã€‚ä½œä¸ºåˆå¹¶æ ‘å®¶æ—æœ€åŸºç¡€çš„è¡¨å¼•æ“ï¼ŒMergeTree å…·å¤‡äº†è¯¥ç³»åˆ—å…¶å®ƒè¡¨å¼•æ“å…±æœ‰çš„åŸºæœ¬ç‰¹å¾ï¼Œåƒé€äº† MergeTree è¡¨å¼•æ“çš„åŸºæœ¬åŸç†ï¼Œå°±æŒæ¡äº†è¯¥ç³»åˆ—è¡¨å¼•æ“çš„ç²¾é«“ã€‚</strong></p>
<h2 id="MergeTree-çš„åˆ›å»ºæ–¹å¼ä¸å­˜å‚¨ç»“æ„"><a href="#MergeTree-çš„åˆ›å»ºæ–¹å¼ä¸å­˜å‚¨ç»“æ„" class="headerlink" title="MergeTree çš„åˆ›å»ºæ–¹å¼ä¸å­˜å‚¨ç»“æ„"></a>MergeTree çš„åˆ›å»ºæ–¹å¼ä¸å­˜å‚¨ç»“æ„</h2><p><strong>MergeTree åœ¨å†™å…¥ä¸€æ‰¹æ•°æ®æ—¶ï¼Œæ•°æ®æ€»ä¼šä»¥æ•°æ®ç‰‡æ®µçš„å½¢å¼å†™å…¥ç£ç›˜ï¼Œä¸”æ•°æ®ç‰‡æ®µä¸å¯ä¿®æ”¹ã€‚è€Œä¸ºäº†é¿å…æ•°æ®ç‰‡æ®µè¿‡å¤šï¼ŒClickHouse ä¼šé€šè¿‡åå°çº¿ç¨‹å®šæœŸçš„åˆå¹¶è¿™äº›æ•°æ®ç‰‡æ®µï¼Œå±äºç›¸åŒåˆ†åŒºçš„æ•°æ®ç‰‡æ®µä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ–°çš„æ•°æ®ç‰‡æ®µï¼Œè¿™ç§æ•°æ®ç‰‡æ®µå¾€å¤åˆå¹¶çš„è¿‡ç¨‹ï¼Œæ­£æ˜¯ MergeTree åç§°çš„ç”±æ¥ã€‚</strong></p>
<h3 id="MergeTree-çš„åˆ›å»ºæ–¹å¼"><a href="#MergeTree-çš„åˆ›å»ºæ–¹å¼" class="headerlink" title="MergeTree çš„åˆ›å»ºæ–¹å¼"></a>MergeTree çš„åˆ›å»ºæ–¹å¼</h3><p><strong>åˆ›å»ºæ•°æ®è¡¨çš„æ–¹æ³•æˆ‘ä»¬ä¸Šé¢ä»‹ç»è¿‡ï¼Œè€Œåˆ›å»º MergeTree æ•°æ®è¡¨åªéœ€è¦åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å°† ENGINE æŒ‡å®šä¸º MergeTree() å³å¯ï¼Œå…¶å®Œæ•´è¯­æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name.]table_name(</span><br><span class="line">    name1 type [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr],</span><br><span class="line">    name2 type [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr],</span><br><span class="line">    ......</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> expr</span><br><span class="line">[<span class="keyword">PRIMARY</span> KEY expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name1<span class="operator">=</span>value1, name2<span class="operator">=</span>value2, ......]</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ° MergeTree è¡¨å¼•æ“é™¤äº†å¸¸è§„çš„å‚æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç‹¬æœ‰çš„é…ç½®é€‰é¡¹ï¼Œä¸€ä¼šå„¿ä¼šè¯¦ç»†ä»‹ç»è¿™å‡ ä¸ªé‡è¦çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•å’Œå·¥ä½œåŸç†ï¼Œç›®å‰å…ˆæ¥å¤§è‡´çœ‹ä¸€ä¸‹å®ƒä»¬çš„ä½œç”¨ã€‚</strong></p>
<p><strong>1ï¼‰ PARTITON BYï¼šé€‰å¡«ï¼Œè¡¨ç¤ºåˆ†åŒºé”®ï¼Œç”¨äºæŒ‡å®šè¡¨æ•°æ®ä»¥ä½•ç§æ ‡å‡†è¿›è¡Œåˆ†åŒºã€‚åˆ†åŒºé”®æ—¢å¯ä»¥æ˜¯å•ä¸ªå­—æ®µã€ä¹Ÿå¯ä»¥é€šè¿‡å…ƒç»„çš„å½¢å¼æŒ‡å®šå¤šä¸ªå­—æ®µï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒä½¿ç”¨åˆ—è¡¨è¾¾å¼ã€‚å¦‚æœä¸æ”¯æŒåˆ†åŒºé”®ï¼Œé‚£ä¹ˆ ClickHouse ä¼šç”Ÿæˆä¸€ä¸ªåç§°ä¸º all çš„åˆ†åŒºï¼Œåˆç†åœ°ä½¿ç”¨åˆ†åŒºå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æŸ¥è¯¢æ—¶æ•°æ®é‡ã€‚æœ€å¸¸è§çš„è«è¿‡äºæŒ‰ç…§æ—¶é—´åˆ†åŒºäº†ï¼Œæ•°æ®é‡éå¸¸å¤§çš„æ—¶å€™å¯ä»¥æŒ‰ç…§å¤©æ¥åˆ†åŒºï¼Œä¸€å¤©ä¸€ä¸ªåˆ†åŒºï¼Œè¿™æ ·æŸ¥æ‰¾æŸä¸€å¤©çš„æ•°æ®æ—¶ç›´æ¥ä»æŒ‡å®šåˆ†åŒºä¸­æŸ¥æ‰¾å³å¯ã€‚</strong></p>
<p><strong>2ï¼‰ORDER BYï¼šå¿…å¡«ï¼Œè¡¨ç¤ºæ’åºé”®ï¼Œç”¨äºæŒ‡å®šåœ¨ä¸€ä¸ªåˆ†åŒºå†…ï¼Œæ•°æ®ä»¥ä½•ç§æ ‡å‡†è¿›è¡Œæ’åºã€‚æ’åºé”®æ—¢å¯ä»¥æ˜¯å•ä¸ªå­—æ®µï¼Œä¾‹å¦‚ ORDER BY CounterIDï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡å…ƒç»„å£°æ˜çš„å¤šä¸ªå­—æ®µï¼Œä¾‹å¦‚ ORDER BY (CounterID, EventDate)ã€‚å¦‚æœæ˜¯å¤šä¸ªå­—æ®µï¼Œé‚£ä¹ˆä¼šå…ˆæŒ‰ç…§ç¬¬ä¸€ä¸ªå­—æ®µæ’åºï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—æ®µä¸­æœ‰ç›¸åŒçš„å€¼ï¼Œé‚£ä¹ˆå†æŒ‰ç…§ç¬¬äºŒä¸ªå­—æ®µæ’åºï¼Œä¾æ¬¡ç±»æ¨ã€‚æ€»ä¹‹åœ¨æ¯ä¸ªåˆ†åŒºå†…ï¼Œæ•°æ®æ˜¯æŒ‰ç…§åˆ†åŒºé”®æ’å¥½åºçš„ï¼Œä½†å¤šä¸ªåˆ†åŒºä¹‹é—´å°±æ²¡æœ‰è¿™ç§å…³ç³»äº†ã€‚</strong></p>
<p><strong>3ï¼‰PRIMARY KEYï¼šé€‰å¡«ï¼Œè¡¨ç¤ºä¸»é”®ï¼Œå£°æ˜ä¹‹åä¼šä¾æ¬¡æŒ‰ç…§ä¸»é”®å­—æ®µç”Ÿæˆä¸€çº§ç´¢å¼•ï¼Œç”¨äºåŠ é€Ÿè¡¨æŸ¥è¯¢ã€‚å¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆä¸»é”®é»˜è®¤å’Œæ’åºé”®ç›¸åŒï¼Œæ‰€ä»¥é€šå¸¸ç›´æ¥ä½¿ç”¨ ORDER BY ä»£ä¸ºæŒ‡å®šä¸»é”®ï¼Œæ— é¡»ä½¿ç”¨ PRIMARY KEY å£°æ˜ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨æ¯ä¸ªåˆ†åŒºå†…ï¼Œæ•°æ®ä¸ä¸€çº§ç´¢å¼•ä»¥ç›¸åŒçš„è§„åˆ™å‡åºæ’åˆ—ï¼ˆå› ä¸ºæ•°æ®æ˜¯æŒ‰ç…§æ’åºé”®æ’åˆ—çš„ï¼Œè€Œä¸€çº§ç´¢å¼•ä¹Ÿæ˜¯æŒ‰æ’åºé”®ã€ä¹Ÿå°±æ˜¯ä¸»é”®è¿›è¡Œæ’åˆ—çš„ï¼‰ã€‚å’Œå…¶å®ƒå…³ç³»å‹æ•°æ®åº“ä¸åŒï¼ŒMergeTree å…è®¸ä¸»é”®æœ‰é‡å¤æ•°æ®ï¼ˆå¯ä»¥é€šè¿‡ ReplacingMergeTree å®ç°å»é‡ï¼‰ã€‚</strong></p>
<p><strong>4ï¼‰SAMPLE KEYï¼šé€‰å¡«ï¼ŒæŠ½æ ·è¡¨è¾¾å¼ã€‚ç”¨äºå£°æ˜æ•°æ®ä»¥ä½•ç§æ ‡å‡†è¿›è¡Œé‡‡æ ·ï¼Œæ³¨æ„ï¼šå¦‚æœå£°æ˜äº†æ­¤é…ç½®é¡¹ï¼Œé‚£ä¹ˆä¸»é”®çš„é…ç½®ä¸­ä¹Ÿè¦å£°æ˜åŒæ ·çš„è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">    ......</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CountID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br><span class="line"><span class="comment">-- æŠ½æ ·è¡¨è¾¾å¼éœ€è¦é…åˆ SAMPLE å­æŸ¥è¯¢ä½¿ç”¨ï¼Œè¯¥åŠŸèƒ½å¯¹é€‰å–æŠ½æ ·æ•°æ®ååˆ†æœ‰ç”¨</span></span><br><span class="line"><span class="comment">-- å…³äºæŠ½æ ·æŸ¥è¯¢ï¼Œåé¢ä¼šåœ¨ä»‹ç»æŸ¥è¯¢çš„æ—¶å€™è¯´</span></span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰SETTINGSï¼šé€‰å¡«ï¼Œç”¨äºæŒ‡å®šä¸€äº›é¢å¤–çš„å‚æ•°ï¼Œä»¥ name&#x3D;value çš„å½¢å¼å‡ºç°ï¼Œname ä¸»è¦åŒ…å« index_granularityã€min_compress_block_sizeã€index_granularity_bytesã€enbale_mixed_granularity_partsã€merge_with_ttl_timeoutã€storage_policyï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">    ......</span><br><span class="line">) ENGINE = MergeTree()</span><br><span class="line">......</span><br><span class="line">SETTINGS index_granularity=8192, min_compress_block_size=6536</span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢è§£é‡Šä¸€ä¸‹è¿™äº›å‚æ•°çš„å«ä¹‰ï¼š</strong></p>
<blockquote>
<p><strong>index_granularityï¼šå¯¹äº MergeTree è€Œè¨€æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œå®ƒè¡¨ç¤ºç´¢å¼•çš„ç²’åº¦ï¼Œé»˜è®¤å€¼ä¸º 8192ã€‚æ‰€ä»¥ ClickHouse æ ¹æ®ä¸»é”®ç”Ÿæˆçš„ç´¢å¼•å®é™…ä¸Šç¨€ç–ç´¢å¼•ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ¯éš” 8192 è¡Œæ•°æ®æ‰ç”Ÿæˆä¸€æ¡ç´¢å¼•ã€‚ç±»ä¼¼äº kafka çš„æ—¥å¿—æ•°æ®æ®µï¼Œkafka çš„æ¯ä¸ªæ•°æ®æ®µæ˜¯ç”±å­˜å‚¨å®é™…æ¶ˆæ¯çš„æ•°æ®æ–‡ä»¶ï¼Œå’Œç”¨äºåŠ é€Ÿæ¶ˆæ¯æŸ¥æ‰¾çš„ç´¢å¼•æ–‡ä»¶ç»„æˆï¼Œè€Œ kafka çš„ç´¢å¼•æ–‡ä»¶å»ºç«‹çš„ä¹Ÿæ˜¯ç¨€ç–ç´¢å¼•ã€‚</strong></p>
<p><strong>min_compress_block_sizeï¼šæˆ‘ä»¬çŸ¥é“ ClickHouse æ˜¯ä¼šå¯¹æ•°æ®è¿›è¡Œå‹ç¼©çš„ï¼Œè€Œ min_compress_block_size è¡¨ç¤ºçš„å°±æ˜¯æœ€å°å‹ç¼©çš„å—å¤§å°ï¼Œé»˜è®¤å€¼ä¸º 65536ã€‚</strong></p>
<p><strong>index_granularity_bytesï¼šåœ¨ 19.11 ç‰ˆæœ¬ä¹‹å‰ ClickHouse åªæ”¯æŒå›ºå®šå¤§å°çš„ç´¢å¼•é—´éš”ï¼Œç”± index_granularity æ§åˆ¶ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ä¸­å¢åŠ äº†è‡ªé€‚åº”é—´éš”å¤§å°çš„ç‰¹æ€§ï¼Œå³æ ¹æ®æ¯æ‰¹æ¬¡å†™å…¥çš„æ•°æ®çš„ä½“é‡å¤§å°ï¼ŒåŠ¨æ€åˆ’åˆ†é—´éš”å¤§å°ã€‚è€Œæ•°æ®çš„ä½“é‡å¤§å°ï¼Œåˆ™ç”± index_granularity_bytes å‚æ•°æ§åˆ¶çš„ï¼Œé»˜è®¤ä¸º 10Mï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºä¸å¯ç”¨è‡ªé€‚åº”åŠŸèƒ½ã€‚</strong></p>
<p><strong>enbale_mixed_granularity_partsï¼šè¡¨ç¤ºæ˜¯å¦å¼€å¯è‡ªé€‚åº”ç´¢å¼•çš„åŠŸèƒ½ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ã€‚</strong></p>
<p><strong>merge_with_ttl_timeoutï¼šä» 19.6 ç‰ˆæœ¬å¼€å§‹ MergeTree æä¾›äº†æ•°æ®çš„ TTL åŠŸèƒ½ï¼Œè¯¥éƒ¨åˆ†åé¢è¯¦ç»†è¯´ã€‚</strong></p>
<p><strong>storage_policyï¼šä» 19.15 ç‰ˆæœ¬å¼€å§‹ MergeTree æä¾›äº†å¤šè·¯å¾„çš„å­˜å‚¨ç­–ç•¥ï¼Œè¯¥éƒ¨åˆ†åŒæ ·ç•™åˆ°åé¢è¯¦ç»†è¯´ã€‚</strong></p>
</blockquote>
<h3 id="MergeTree-æ•°æ®è¡¨çš„å­˜å‚¨ç»“æ„"><a href="#MergeTree-æ•°æ®è¡¨çš„å­˜å‚¨ç»“æ„" class="headerlink" title="MergeTree æ•°æ®è¡¨çš„å­˜å‚¨ç»“æ„"></a>MergeTree æ•°æ®è¡¨çš„å­˜å‚¨ç»“æ„</h3><p><strong>æˆ‘ä»¬è¯´åœ¨ ClickHouse ä¸­ä¸€å¼ è¡¨å¯¹åº”ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆ MergeTree æ•°æ®è¡¨å¯¹åº”çš„ç›®å½•ç»“æ„å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹å‰è¯´è¡¨å¯¹åº”çš„ç›®å½•é‡Œé¢å­˜å‚¨çš„å°±æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ˆæ•°æ®åœ¨ç£ç›˜ä¸Šçš„è½½ä½“ï¼‰ï¼Œä½†å¯¹äº MergeTree æ•°æ®è¡¨è€Œè¨€è¿˜ä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºæˆ‘ä»¬è¯´ MergeTree æ•°æ®è¡¨æ˜¯æœ‰åˆ†åŒºçš„ï¼Œæ‰€ä»¥è¡¨å¯¹åº”çš„ç›®å½•é‡Œé¢å­˜å‚¨çš„è¿˜æ˜¯ç›®å½•ã€‚å¹¶ä¸”æ¯ä¸ªç›®å½•å¯¹åº”ä¸€ä¸ªåˆ†åŒºï¼Œå› æ­¤ä¹Ÿå«åˆ†åŒºç›®å½•ï¼Œè€Œåˆ†åŒºç›®å½•é‡Œé¢å­˜å‚¨çš„æ‰æ˜¯è´Ÿè´£å®¹çº³æ•°æ®çš„æ–‡æœ¬æ–‡ä»¶ã€‚</strong></p>
<p><strong>æ‰€ä»¥ä¸€å¼  MergeTree æ•°æ®è¡¨åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ç»“æ„åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼Œä¾æ¬¡æ˜¯æ•°æ®è¡¨ç›®å½•ã€åˆ†åŒºç›®å½•ã€ä»¥åŠå„åˆ†åŒºç›®å½•ä¸‹çš„æ•°æ®æ–‡ä»¶ã€‚æˆ‘ä»¬ç”»ä¸€å¼ å›¾ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121016351-909176633.png" alt="img"></p>
<p><strong>åˆ†åˆ«è§£é‡Šä¸€ä¸‹å®ƒä»¬çš„ä½œç”¨ï¼š</strong></p>
<p><strong>1ï¼‰partitionï¼šåˆ†åŒºç›®å½•ï¼Œé‡Œé¢çš„å„ç±»æ•°æ®æ–‡ä»¶ï¼ˆprimary.idxã€data.mrkã€data.bin ç­‰ç­‰ï¼‰éƒ½æ˜¯ä»¥åˆ†åŒºç›®å½•çš„å½¢å¼è¢«ç»„ç»‡å­˜æ”¾çš„ï¼Œå±äºç›¸åŒåˆ†åŒºçš„æ•°æ®ï¼Œæœ€ç»ˆä¼šè¢«åˆå¹¶åˆ°åŒä¸€ä¸ªåˆ†åŒºç›®å½•ï¼Œè€Œä¸åŒåˆ†åŒºçš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«åˆå¹¶åœ¨ä¸€èµ·ã€‚å…³äºæ•°æ®åˆ†åŒºçš„ç»†èŠ‚ï¼Œåé¢ä¼šè¯¦ç»†è¯´ã€‚</strong></p>
<p><strong>2ï¼‰checksums.txtï¼šæ ¡éªŒæ–‡ä»¶ï¼Œä½¿ç”¨äºŒè¿›åˆ¶çš„æ ¼å¼è¿›è¡Œå­˜å‚¨ï¼Œå®ƒä¿å­˜äº†ä½™ä¸‹å„ç±»æ–‡ä»¶ï¼ˆprimary.txtã€count.txt ç­‰ç­‰ï¼‰çš„ size å¤§å°ä»¥åŠå“ˆå¸Œå€¼ï¼Œç”¨äºå¿«é€Ÿæ ¡éªŒæ–‡ä»¶çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚</strong></p>
<p><strong>3ï¼‰columns.txtï¼šåˆ—ä¿¡æ¯æ–‡ä»¶ï¼Œä½¿ç”¨æ˜æ–‡æ ¼å¼å­˜å‚¨ï¼Œç”¨äºä¿å­˜æ­¤åˆ†åŒºä¸‹çš„åˆ—å­—æ®µä¿¡æ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¯¥è¡¨è´Ÿè´£å­˜å‚¨ç”¨æˆ·å‚åŠ è¿‡çš„æ´»åŠ¨ï¼Œæ¯å‚åŠ ä¸€ä¸ªæ´»åŠ¨ï¼Œå°±ä¼šç”Ÿæˆä¸€æ¡è®°å½•</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> user_activity_event (</span><br><span class="line">    ID UInt64,  <span class="comment">-- è¡¨çš„ ID</span></span><br><span class="line">    UserName String,  <span class="comment">-- ç”¨æˆ·å</span></span><br><span class="line">    ActivityName String,  <span class="comment">-- æ´»åŠ¨åç§°</span></span><br><span class="line">    ActivityType String,  <span class="comment">-- æ´»åŠ¨ç±»å‹</span></span><br><span class="line">    ActivityLevel Enum(<span class="string">&#x27;Easy&#x27;</span> <span class="operator">=</span> <span class="number">0</span>, <span class="string">&#x27;Medium&#x27;</span> <span class="operator">=</span> <span class="number">1</span>, <span class="string">&#x27;Hard&#x27;</span> <span class="operator">=</span> <span class="number">2</span>),  <span class="comment">-- æ´»åŠ¨éš¾åº¦ç­‰çº§</span></span><br><span class="line">    IsSuccess Int8,  <span class="comment">-- æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    JoinTime <span class="type">DATE</span>  <span class="comment">-- å‚åŠ æ—¶é—´</span></span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(JoinTime)  <span class="comment">-- æŒ‰ç…§ toYYYYMM(JoinTime) è¿›è¡Œåˆ†åŒº</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ID;  <span class="comment">-- æŒ‰ç…§ ID å­—æ®µæ’åº</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ’å…¥ä¸€æ¡æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_activity_event <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;å¼ ä¸‰&#x27;</span>, <span class="string">&#x27;å¯»æ‰¾é—å¤±çš„æ—¶é—´&#x27;</span>, <span class="string">&#x27;å¸‚åœºè¥é”€&#x27;</span>, <span class="string">&#x27;Medium&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2020-05-13&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæŸ¥çœ‹ç›¸å…³ä¿¡æ¯ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cat /var/lib/clickhouse/data/default/user_activity_event/202005_1_1_0/columns.txt </span></span><br><span class="line">columns format version: 1</span><br><span class="line">7 columns:</span><br><span class="line">`ID` UInt64</span><br><span class="line">`UserName` String</span><br><span class="line">`ActivityName` String</span><br><span class="line">`ActivityType` String</span><br><span class="line">`ActivityLevel` Enum8(<span class="string">&#x27;Easy&#x27;</span> = 0, <span class="string">&#x27;Medium&#x27;</span> = 1, <span class="string">&#x27;Hard&#x27;</span> = 2)</span><br><span class="line">`IsSuccess` Int8</span><br><span class="line">`JoinTime` Date</span><br><span class="line">[root@satori ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p><strong>4ï¼‰count.txtï¼šè®¡æ•°æ–‡ä»¶ï¼Œä½¿ç”¨æ˜æ–‡æ ¼å¼å­˜å‚¨ï¼Œç”¨äºè®°å½•å½“å‰åˆ†åŒºä¸‹çš„æ•°æ®æ€»æ•°ã€‚æ‰€ä»¥åç»­åœ¨æŸ¥è¯¢æ•°æ®æ€»é‡çš„æ—¶å€™å¯ä»¥ç¬é—´è¿”å›ï¼Œå› ä¸ºå·²ç»æå‰è®°å½•å¥½äº†ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cat /var/lib/clickhouse/data/default/user_activity_event/202005_1_1_0/count.txt </span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰primary.idxï¼šä¸€çº§ç´¢å¼•æ–‡ä»¶ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨ç¨€ç–ç´¢å¼•ï¼Œä¸€å¼  MergeTree è¡¨åªèƒ½å£°æ˜ä¸€æ¬¡ä¸€çº§ç´¢å¼•ï¼ˆé€šè¿‡ ORDER BY æˆ– PRIMARY KEYï¼‰ã€‚å€ŸåŠ©ç¨€ç–ç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢æ•°æ®æ—¶èƒ½å¤Ÿæ’é™¤ä¸»é”®æ¡ä»¶èŒƒå›´ä¹‹å¤–çš„æ•°æ®æ–‡ä»¶ï¼Œä»è€Œæœ‰æ•ˆå‡å°‘æ•°æ®æ‰«æèŒƒå›´ï¼ŒåŠ é€ŸæŸ¥è¯¢é€Ÿåº¦ã€‚</strong></p>
<p><strong>6ï¼‰data.binï¼šæ•°æ®æ–‡ä»¶ï¼Œä½¿ç”¨å‹ç¼©æ ¼å¼å­˜å‚¨ï¼Œé»˜è®¤ä¸º LZ4 æ ¼å¼ï¼Œç”¨äºå­˜å‚¨è¡¨çš„æ•°æ®ã€‚åœ¨è€ç‰ˆæœ¬ä¸­æ¯ä¸€ä¸ªåˆ—å­—æ®µéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ .bin æ•°æ®æ–‡ä»¶ï¼Œå¹¶ä»¥åˆ—å­—æ®µå‘½åï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ä¸­åªæœ‰ä¸€ä¸ª data.binï¼Œä¹Ÿå°±æ˜¯åˆå¹¶åœ¨ä¸€èµ·äº†ã€‚</strong></p>
<p><strong>7ï¼‰data.mrkï¼šæ ‡è®°æ–‡ä»¶ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ï¼Œæ ‡è®°æ–‡ä»¶ä¸­ä¿å­˜äº† data.bin æ–‡ä»¶ä¸­æ•°æ®çš„åç§»é‡ä¿¡æ¯ï¼Œå¹¶ä¸”æ ‡è®°æ–‡ä»¶ä¸ç¨€ç–ç´¢å¼•å¯¹é½ï¼Œå› æ­¤ MergeTree é€šè¿‡æ ‡è®°æ–‡ä»¶å»ºç«‹äº†ç¨€ç–ç´¢å¼•ï¼ˆprimary.idxï¼‰ä¸æ•°æ®æ–‡ä»¶ï¼ˆdata.binï¼‰ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚è€Œåœ¨è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ç¨€ç–ç´¢å¼•ï¼ˆprimary.idxï¼‰æ‰¾åˆ°å¯¹åº”æ•°æ®çš„åç§»é‡ä¿¡æ¯ï¼ˆdata.mrkï¼‰ï¼Œå› ä¸ºä¸¤è€…æ˜¯å¯¹é½çš„ï¼Œç„¶åå†æ ¹æ®åç§»é‡ä¿¡æ¯ç›´æ¥ä» data.bin æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚</strong></p>
<p><strong>8ï¼‰data.mrk3ï¼šå¦‚æœä½¿ç”¨äº†è‡ªé€‚åº”å¤§å°çš„ç´¢å¼•é—´éš”ï¼Œåˆ™æ ‡è®°æ–‡ä»¶ä¼šä»¥ data.mrk3 ç»“å°¾ï¼Œä½†å®ƒçš„å·¥ä½œåŸç†å’Œ data.mrk æ–‡ä»¶æ˜¯ç›¸åŒçš„ã€‚</strong></p>
<p><strong>9ï¼‰partition.dat å’Œ minmax_[Column].idxï¼šå¦‚æœä½¿ç”¨äº†åˆ†åŒºé”®ï¼Œä¾‹å¦‚ä¸Šé¢çš„ PARTITION BY toYYYYMM(JoinTime)ï¼Œåˆ™ä¼šé¢å¤–ç”Ÿæˆ partition.dat ä¸ minmax_JoinTime.idx ç´¢å¼•æ–‡ä»¶ï¼Œå®ƒä»¬å‡ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ã€‚partition.dat ç”¨äºä¿å­˜å½“å‰åˆ†åŒºä¸‹åˆ†åŒºè¡¨è¾¾å¼æœ€ç»ˆç”Ÿæˆçš„å€¼ï¼Œè€Œ minmax_[Column].idx åˆ™è´Ÿè´£è®°å½•å½“å‰åˆ†åŒºä¸‹åˆ†åŒºå­—æ®µå¯¹åº”åŸå§‹æ•°æ®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚ä¸¾ä¸ªæ —å­ï¼Œå‡è®¾æˆ‘ä»¬å¾€ä¸Šé¢çš„ user_activity_event è¡¨ä¸­æ’å…¥äº† 5 æ¡æ•°æ®ï¼ŒJoinTime åˆ†åˆ« 2020-05-05ã€2020-05-15ã€2020-05-31ã€2020-05-03ã€2020-05-24ï¼Œæ˜¾ç„¶è¿™ 5 æ¡éƒ½ä¼šè¿›å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œå› ä¸º toYYYMM ä¹‹åå®ƒä»¬çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯ 2020-05ï¼Œè€Œ partition.dat ä¸­å­˜å‚¨çš„å°±æ˜¯ 2020-05ï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºè¡¨è¾¾å¼æœ€ç»ˆç”Ÿæˆçš„å€¼ï¼›åŒæ—¶è¿˜ä¼šæœ‰ä¸€ä¸ª minmax_JoinTime.idx æ–‡ä»¶ï¼Œé‡Œé¢å­˜å‚¨çš„å°±æ˜¯ 2020-05-03 2020-05-31ï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºå­—æ®µå¯¹åº”çš„åŸå§‹æ•°æ®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚</strong></p>
<p><strong>åœ¨è¿™äº›åˆ†åŒºç´¢å¼•çš„ä½œç”¨ä¸‹ï¼Œè¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶èƒ½å¤Ÿå¿«é€Ÿè·³è¿‡ä¸å¿…è¦çš„åˆ†åŒºç›®å½•ï¼Œä»è€Œå‡å°‘æœ€ç»ˆéœ€è¦æ‰«æçš„æ•°æ®èŒƒå›´ã€‚æ¯”å¦‚æˆ‘ä»¬å­˜å‚¨äº† JoinTime ä¸º 2020-01-01 åˆ° 2020-12-31 ä¸€æ•´å¹´ç”¨æˆ·å‚åŠ æ´»åŠ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆ toYYYYMM ä¹‹åè‚¯å®šå°±ä¼šæœ‰ 12 ä¸ªåˆ†åŒºï¼Œç„¶åæŒ‰ç…§ JoinTime æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œæ¯”å¦‚è¦æŸ¥æ‰¾ JoinTime ä¸º 2020-06-12 çš„æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥å»æŒ‡å®šçš„åˆ†åŒºï¼ˆ2020-06ï¼‰ä¸­æŸ¥æ‰¾å³å¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡åˆ†åŒºæœºåˆ¶å°†æŸ¥è¯¢èŒƒå›´é™å®šåœ¨ 2020-06ï¼Œå…¶ä½™çš„ 11 ä¸ªæœˆçš„æ•°æ®æˆ‘ä»¬å‹æ ¹ä¸ç”¨çœ‹ï¼Œå› æ­¤å¤§å¤§å‡å°‘äº†æŸ¥è¯¢çš„æ•°æ®é‡ã€‚</strong></p>
<p><strong>10ï¼‰skp_idx_[IndexName].idx å’Œ skp_idx_[IndexName].mrk3ï¼šå¦‚æœåœ¨å»ºè¡¨è¯­å¥ä¸­æŒ‡å®šäº†äºŒçº§ç´¢å¼•ï¼ˆåé¢ä¼šè¯´ï¼‰ï¼Œåˆ™ä¼šé¢å¤–ç”Ÿæˆç›¸åº”çš„äºŒçº§ç´¢å¼•æ–‡ä»¶ä¸æ ‡è®°æ–‡ä»¶ï¼Œå®ƒä»¬åŒæ ·ä½¿ç”¨äºŒè¿›åˆ¶å­˜å‚¨ã€‚äºŒçº§ç´¢å¼•åœ¨ ClickHouse ä¸­åˆè¢«ç§°ä¸ºè·³æ•°ç´¢å¼•ï¼Œç›®å‰æ‹¥æœ‰ minmaxã€setã€ngrambf_v1 å’Œ token_v1 å››ç§ç±»å‹ï¼Œè¿™äº›ç§ç±»çš„è·³æ•°ç´¢å¼•çš„ç›®çš„å’Œä¸€çº§ç´¢å¼•éƒ½ç›¸åŒï¼Œéƒ½æ˜¯ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘æ•°æ®çš„æ‰«æèŒƒå›´ï¼Œä»è€ŒåŠ é€Ÿæ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹ã€‚</strong></p>
<h2 id="æ•°æ®åˆ†åŒº"><a href="#æ•°æ®åˆ†åŒº" class="headerlink" title="æ•°æ®åˆ†åŒº"></a>æ•°æ®åˆ†åŒº</h2><p><strong>é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬å·²ç»çŸ¥é“åœ¨ MergeTree æ•°æ®è¡¨ä¸­ï¼Œæ•°æ®æ˜¯ä»¥åˆ†åŒºç›®å½•çš„å½¢å¼è¿›è¡Œç»„ç»‡çš„ï¼Œæ¯ä¸ªåˆ†åŒºçš„æ•°æ®ç‹¬ç«‹åˆ†å¼€å­˜å‚¨ã€‚å€ŸåŠ©è¿™ç§å½¢å¼ï¼ŒMergeTree åœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œå¯ä»¥è·³è¿‡æ— ç”¨çš„æ•°æ®æ–‡ä»¶ï¼Œåªåœ¨æœ€å°åˆ†åŒºç›®å½•å­é›†ä¸­æŸ¥è¯¢ã€‚è¿™é‡Œå†å¼ºè°ƒä¸€æ¬¡ï¼Œåœ¨ ClickHouse ä¸­å­˜åœ¨æ•°æ®åˆ†åŒºï¼ˆpartitionï¼‰å’Œæ•°æ®åˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œä½†å®ƒä»¬æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚æ•°æ®åˆ†åŒºæ˜¯é’ˆå¯¹æœ¬åœ°æ•°æ®è€Œè¨€çš„ï¼Œç›¸å½“äºæ˜¯å¯¹æ•°æ®çš„ä¸€ç§çºµå‘åˆ‡åˆ†ï¼Œå°±ç±»ä¼¼å°†å…³ç³»å‹æ•°æ®ä¸­çš„ä¸€å¼ å¤§é«˜è¡¨åˆ‡æˆå¤šå¼ ä¸ªå¤´æ²¡é‚£ä¹ˆé«˜çš„å­è¡¨ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121030557-1616523231.png" alt="img"></p>
<p><strong>è€Œæ•°æ®åˆ†ç‰‡åˆ™ä¸ ClickHouse é›†ç¾¤ç›¸å…³ï¼Œæˆ‘ä»¬åé¢ä¼šè¯´ï¼Œæˆ‘ä»¬ç›®å‰éƒ½æ˜¯å•æœºçš„ï¼Œæ‰€ä»¥ä¸æ¶‰åŠæ•°æ®åˆ†ç‰‡ã€‚</strong></p>
<h3 id="æ•°æ®çš„åˆ†åŒºè§„åˆ™"><a href="#æ•°æ®çš„åˆ†åŒºè§„åˆ™" class="headerlink" title="æ•°æ®çš„åˆ†åŒºè§„åˆ™"></a>æ•°æ®çš„åˆ†åŒºè§„åˆ™</h3><p><strong>MergeTree æ•°æ®è¡¨çš„åˆ†åŒºè§„åˆ™ç”±åˆ†åŒº ID å†³å®šï¼Œè€Œå…·ä½“åˆ°æ¯ä¸ªåˆ†åŒºå¯¹åº”çš„ ID åˆ™æ˜¯ç”±åˆ†åŒºé”®çš„å–å€¼å†³å®šçš„ã€‚åˆ†åŒºé”®æ”¯æŒä½¿ç”¨ä»»ä½•ä¸€ä¸ªæˆ–ä¸€ç»„å­—æ®µè¡¨è¾¾å¼å£°æ˜ï¼Œå…¶ä¸šåŠ¡è¯­ä¹‰å¯ä»¥æ˜¯å¹´ã€æœˆã€æ—¥æˆ–è€…ç»„ç»‡å•ä½ç­‰ä»»ä½•ä¸€ç§è§„åˆ™ï¼Œè€Œé’ˆå¯¹å–å€¼æ•°æ®çš„ç±»å‹ä¸åŒï¼Œåˆ†åŒº ID çš„ç”Ÿæˆé€»è¾‘ç›®å‰æ‹¥æœ‰å››ç§è§„åˆ™ï¼š</strong></p>
<ul>
<li><code>1. ä¸æŒ‡å®šåˆ†åŒºé”®ï¼šå¦‚æœä¸ä½¿ç”¨åˆ†åŒºé”®ï¼Œå³ä¸ä½¿ç”¨ PARTITION BY å£°æ˜ä»»ä½•åˆ†åŒºè¡¨è¾¾å¼ï¼Œåˆ™åˆ†åŒº ID é»˜è®¤ä¸º allï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«å†™å…¥ all è¿™ä¸ªåˆ†åŒº</code></li>
<li><code>2. ä½¿ç”¨æ•´å‹ï¼šå¦‚æœåˆ†åŒºé”®çš„å–å€¼ä¸ºæ•´å‹ï¼ˆUInt64ã€Int8 ç­‰ç­‰éƒ½ç®—ï¼‰ï¼Œä¸”æ— æ³•è½¬æˆæ—¥æœŸç±»å‹ YYYYMMDD æ ¼å¼ï¼Œåˆ™ç›´æ¥æŒ‰ç…§è¯¥æ•´å‹çš„å­—ç¬¦ä¸²å½¢å¼ä½œä¸ºåˆ†åŒº ID çš„å–å€¼</code></li>
<li><code>3. ä½¿ç”¨æ—¥æœŸç±»å‹ï¼šå¦‚æœåˆ†åŒºé”®å–å€¼å±äºæ—¥æœŸç±»å‹ï¼Œæˆ–è€…æ˜¯èƒ½å¤Ÿè½¬æ¢ä¸º YYYYMMDD æ ¼å¼çš„æ•´å‹ï¼Œåˆ™ä½¿ç”¨æŒ‰ç…§ YYYYMMDD è¿›è¡Œæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²å½¢å¼ä½œä¸ºåˆ†åŒº ID çš„å–å€¼</code></li>
<li><code>4. ä½¿ç”¨å…¶å®ƒç±»å‹ï¼šå¦‚æœåˆ†åŒºé”®å–å€¼æ—¢ä¸æ˜¯æ•´å‹ã€ä¹Ÿä¸æ˜¯æ—¥æœŸç±»å‹ï¼Œæ¯”å¦‚ Stringã€Float ç­‰ç­‰ã€‚åˆ™é€šè¿‡ 128 ä½ Hash ç®—æ³•å–å…¶ Hash å€¼ä½œä¸ºåˆ†åŒº ID çš„å–å€¼</code></li>
</ul>
<p><strong>ä»¥æˆ‘ä»¬ä¹‹å‰çš„ PARTITION BY toYYYYMM(JoinTime) ä¸ºä¾‹ï¼Œå½“å†™å…¥ä¸€æ¡ JoinTime ä¸º 2020-09-18 çš„è®°å½•æ—¶ï¼Œè¯¥è®°å½•å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 202009 çš„åˆ†åŒºä¸­ï¼›å¦‚æœæ˜¯ PARTITION BY JoinTimeï¼Œé‚£ä¹ˆ JoinTime ä¸º 2020-09-18 çš„è®°å½•å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 20200918 çš„åˆ†åŒºä¸­ï¼›å†æ¯”å¦‚ PARTITION BY ageï¼Œå½“å†™å…¥ä¸€æ¡ age ä¸º 16 çš„è®°å½•æ—¶ï¼Œè¯¥æ•°æ®å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 16 çš„åˆ†åŒºä¸­ï¼›å†æ¯”å¦‚ PARTITION BY length(name)ï¼Œé‚£ä¹ˆ name ä¸º â€œå¤æ˜åœ°è§‰â€ çš„è®°å½•å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 4 çš„åˆ†åŒºä¸­ï¼Œ name ä¸º â€œé›¾é›¨é­”ç†æ²™â€ çš„è®°å½•å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 5 çš„åˆ†åŒºä¸­ã€‚</strong></p>
<p><strong>ç›¸ä¿¡è¿™ä¸ªåˆ†åŒº ID è¿˜æ˜¯å¥½ç†è§£çš„ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåˆ†åŒºå­—æ®µæœ‰å¤šä¸ªï¼Œé‚£ä¹ˆä¼šæŒ‰ç…§ç›¸åŒçš„è§„åˆ™ä¸ºæ¯ä¸ªå­—æ®µéƒ½ç”Ÿæˆä¸€ä¸ªåˆ†åŒº IDï¼Œæœ€åå†å°†è¿™äº›åˆ†åŒº ID ä½¿ç”¨å‡å·åˆå¹¶èµ·æ¥ï¼Œä½œä¸ºæœ€ç»ˆçš„åˆ†åŒº IDã€‚</strong></p>
<blockquote>
<p><strong>æ¯”å¦‚ï¼šPARTITION BY (length(UserName), toYYYYMM(JoinTime))ï¼Œé‚£ä¹ˆ UserName ä¸º â€œå¼ ä¸‰â€ã€JoinTime ä¸º 2020-05-13 çš„è®°å½•å°±ä¼šè½åœ¨åˆ†åŒº ID ä¸º 2-202005 çš„åˆ†åŒºä¸­ã€‚</strong></p>
</blockquote>
<h3 id="åˆ†åŒºç›®å½•çš„å‘½åè§„åˆ™"><a href="#åˆ†åŒºç›®å½•çš„å‘½åè§„åˆ™" class="headerlink" title="åˆ†åŒºç›®å½•çš„å‘½åè§„åˆ™"></a>åˆ†åŒºç›®å½•çš„å‘½åè§„åˆ™</h3><p><strong>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†åˆ†åŒº ID ç”Ÿæˆè§„åˆ™ï¼Œä½†å¦‚æœè¿›å…¥æ•°æ®è¡¨æ‰€åœ¨çš„ç£ç›˜ç›®å½•æ—¶ï¼Œä¼šå‘ç° MergeTree åˆ†åŒºç›®å½•çš„å®Œæ•´ç‰©ç†åç§°å¹¶ä¸åªæœ‰åˆ†åŒº IDï¼Œåœ¨ ID çš„åé¢è¿˜è·Ÿç€ä¸€ä¸²å¥‡æ€ªçš„æ•°å­—ï¼Œä»¥æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ user_activity_event æ•°æ®è¡¨ä¸ºä¾‹ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªåˆ†åŒºï¼Œå…¶åç§°å°±å« 202005_1_1_0ã€‚å‰é¢çš„ 202005 æ˜¾ç„¶å°±æ˜¯åˆ†åŒº IDï¼Œé‚£åé¢çš„éƒ¨åˆ†ä»£è¡¨å•¥å«ä¹‰å‘¢ï¼Ÿ</strong></p>
<p><strong>é¦–å…ˆå¯¹äº MergeTree è€Œè¨€ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯åˆ†åŒºç›®å½•çš„åˆå¹¶åŠ¨ä½œï¼ˆè‡³äºæ€ä¹ˆåˆå¹¶æˆ‘ä»¬åé¢å†è¯´ï¼‰ï¼Œè€Œåˆå¹¶é€»è¾‘æˆ‘ä»¬ä»åˆ†åŒºç›®å½•çš„åç§°ä¾¿å¯çª¥çŸ¥ä¸€äºŒã€‚</strong></p>
<p><strong>é¦–å…ˆåˆ†åŒºç›®å½•çš„å‘½åè§„åˆ™æ˜¯ï¼šPartitionID_MinBlockNum_MaxBlockNum_Level</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121303260-1051906586.png" alt="img"></p>
<p><strong>ä¸‹é¢æ¥è§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªéƒ¨åˆ†ï¼š</strong></p>
<p><strong>1ï¼‰PartitionIDï¼šåˆ†åŒº IDï¼Œè¿™ä¸ªåº”è¯¥æ— éœ€å¤šè¯´ã€‚</strong></p>
<p><strong>2ï¼‰MinBlockNumã€MaxBlockNumï¼šæœ€å°æ•°æ®å—ç¼–å·å’Œæœ€å¤§æ•°æ®å—ç¼–å·ï¼Œè¿™é‡Œçš„å‘½åå¾ˆå®¹æ˜“è®©äººè”æƒ³åˆ°åé¢è¦è¯´çš„æ•°æ®å‹ç¼©å—ï¼Œç”šè‡³äº§ç”Ÿæ··æ·†ï¼Œä½†å®é™…ä¸Šè¿™ä¸¤è€…æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚è¿™é‡Œçš„ BlockNum æ˜¯ä¸€ä¸ªè‡ªå¢çš„æ•´æ•°ï¼Œä» 1 å¼€å§‹ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºæ—¶å°±ä¼šè‡ªå¢ 1ï¼Œå¹¶ä¸”å¯¹äºä¸€ä¸ªæ–°çš„åˆ†åŒºç›®å½•è€Œè¨€ï¼Œå®ƒçš„ MinBlockNum å’Œ MaxBlockNum æ˜¯ç›¸ç­‰çš„ã€‚æ¯”å¦‚ 202005_1_1_0ã€202006_2_2_0ã€202007_3_3_0ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå½“åˆ†åŒºç›®å½•å‘ç”Ÿåˆå¹¶çš„æ—¶å€™ï¼Œé‚£ä¹ˆå…¶ MinBlockNum å’Œ MaxBlockNum ä¼šæœ‰å¦å¤–çš„è§„åˆ™ï¼Œä¸€ä¼šå„¿ç»†è¯´ã€‚</strong></p>
<p><strong>3ï¼‰Levelï¼šåˆå¹¶çš„å±‚çº§ï¼Œå¯ä»¥ç†è§£ä¸ºæŸä¸ªåˆ†åŒºè¢«åˆå¹¶çš„æ¬¡æ•°ï¼Œè¿™é‡Œçš„ Level å’Œ BlockNum ä¸åŒï¼Œå®ƒä¸æ˜¯å…¨å±€ç´¯åŠ çš„ã€‚å¯¹äºæ¯ä¸ªæ–°åˆ›å»ºçš„ç›®å½•è€Œè¨€ï¼Œå…¶åˆå§‹å€¼éƒ½ä¸º 0ï¼Œä¹‹åä»¥åˆ†åŒºä¸ºå•ä½ï¼Œå¦‚æœç›¸åŒåˆ†åŒºå‘ç”Ÿåˆå¹¶åŠ¨ä½œï¼Œåˆ™è¯¥åˆ†åŒºå¯¹åº”çš„ Level åŠ  1ã€‚å¯èƒ½æœ‰äººä¸æ˜¯å¾ˆç†è§£è¿™é‡Œçš„ â€œç›¸åŒåˆ†åŒºå‘ç”Ÿåˆå¹¶â€ åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ‘ä»¬ä¸‹é¢å°±æ¥ä»‹ç»ã€‚</strong></p>
<h3 id="åˆ†åŒºç›®å½•çš„åˆå¹¶è¿‡ç¨‹"><a href="#åˆ†åŒºç›®å½•çš„åˆå¹¶è¿‡ç¨‹" class="headerlink" title="åˆ†åŒºç›®å½•çš„åˆå¹¶è¿‡ç¨‹"></a>åˆ†åŒºç›®å½•çš„åˆå¹¶è¿‡ç¨‹</h3><p><strong>MergeTree çš„åˆ†åŒºç›®å½•å’Œå…¶å®ƒä¼ ç»Ÿæ„ä¹‰ä¸Šæ•°æ®åº“æœ‰æ‰€ä¸åŒï¼Œé¦–å…ˆ MergeTree çš„åˆ†åŒºç›®å½•å¹¶ä¸æ˜¯åœ¨æ•°æ®è¡¨è¢«åˆ›å»ºä¹‹åå°±å­˜åœ¨çš„ï¼Œè€Œæ˜¯åœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­è¢«åˆ›å»ºçš„ï¼Œå¦‚æœä¸€å¼ è¡¨ä¸­æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸ä¼šæœ‰ä»»ä½•çš„åˆ†åŒºç›®å½•ã€‚ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºåˆ†åŒºç›®å½•çš„å‘½åä¸åˆ†åŒº ID æœ‰å…³ï¼Œè€Œåˆ†åŒº ID åˆå’Œåˆ†åŒºé”®å¯¹åº”çš„å€¼æœ‰å…³ï¼Œè€Œè¡¨ä¸­è¿æ•°æ®éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä½•æ¥åˆ†åŒºç›®å½•å‘¢ã€‚</strong></p>
<p><strong>å…¶æ¬¡ï¼ŒMergeTree çš„åˆ†åŒºç›®å½•ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œåœ¨å…¶å®ƒæ•°æ®åº“çš„è®¾è®¡ä¸­ï¼Œè¿½åŠ æ•°æ®çš„æ—¶å€™ç›®å½•è‡ªèº«ä¸ä¼šæ”¹å˜ï¼Œåªæ˜¯åœ¨ç›¸åŒåˆ†åŒºä¸­è¿½åŠ æ•°æ®æ–‡ä»¶ã€‚è€Œ MergeTree å®Œå…¨ä¸åŒï¼Œä¼´éšç€æ¯ä¸€æ¬¡æ•°æ®çš„å†™å…¥ï¼ŒMergeTree éƒ½ä¼šç”Ÿæˆä¸€æ‰¹æ–°çš„åˆ†åŒºç›®å½•ï¼Œå³ä½¿ä¸åŒæ‰¹æ¬¡å†™å…¥çš„æ•°æ®å±äºç›¸åŒçš„åˆ†åŒºï¼Œä¹Ÿä¼šç”Ÿæˆä¸åŒçš„åˆ†åŒºç›®å½•ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹äºåŒä¸€ä¸ªåˆ†åŒºè€Œè¨€ï¼Œä¼šå­˜åœ¨å¯¹åº”å¤šä¸ªåˆ†åŒºç›®å½•çš„æƒ…å†µã€‚è€Œåœ¨ä¹‹åçš„æŸä¸ªæ—¶åˆ»ï¼ˆä¸€èˆ¬ 10 åˆ° 15 åˆ†é’Ÿï¼‰ï¼ŒClickHouse ä¼šé€šè¿‡åå°ä»»åŠ¡å°†å±äºç›¸åŒåˆ†åŒºçš„å¤šä¸ªç›®å½•åˆå¹¶ï¼ˆMergeï¼‰æˆä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ optimize TABLE table_name FINAL è¯­å¥ç«‹å³åˆå¹¶ï¼Œè‡³äºåˆå¹¶ä¹‹å‰çš„æ—§ç›®å½•ä¼šåœ¨ä¹‹åçš„æŸä¸ªæ—¶åˆ»ï¼ˆé»˜è®¤ 8 åˆ†é’Ÿï¼‰è¢«åˆ é™¤ã€‚</strong></p>
<p><strong>å±äºåŒä¸€ä¸ªåˆ†åŒºçš„å¤šä¸ªç›®å½•ï¼Œåœ¨åˆå¹¶ä¹‹åä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ç›®å½•ï¼Œç›®å½•ä¸­çš„ç´¢å¼•å’Œæ•°æ®æ–‡ä»¶ä¹Ÿä¼šç›¸åº”åœ°è¿›è¡Œåˆå¹¶ã€‚è€Œæ–°ç›®å½•çš„åç§°çš„ç”Ÿæˆæ–¹å¼éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š</strong></p>
<ul>
<li><code>PartitionIDï¼šä¸å˜</code></li>
<li><code>MinBlockNumï¼šå–åŒä¸€åˆ†åŒºå†…æ‰€æœ‰ç›®å½•ä¸­æœ€å°çš„ MinBlockNum</code></li>
<li><code>MaxBlockNumï¼šå–åŒä¸€åˆ†åŒºå†…æ‰€æœ‰ç›®å½•ä¸­æœ€å¤§çš„ MaxBlockNum</code></li>
<li><code>Levelï¼šå–åŒä¸€åˆ†åŒºå†…æœ€å¤§ Level å€¼å¹¶åŠ  1</code></li>
</ul>
<p><strong>æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬ä¹‹å‰çš„ user_activity_event è¡¨æ˜¯ç©ºçš„ï¼Œç„¶åæˆ‘ä»¬å¾€é‡Œé¢åˆ† 3 æ‰¹å†™å…¥ 3 æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_activity_event <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;å¼ ä¸‰&#x27;</span>, <span class="string">&#x27;å¯»æ‰¾é—å¤±çš„æ—¶é—´&#x27;</span>, <span class="string">&#x27;å¸‚åœºè¥é”€&#x27;</span>, <span class="string">&#x27;Medium&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2020-05-01&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_activity_event <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;æå››&#x27;</span>, <span class="string">&#x27;å¯»æ‰¾é—å¤±çš„æ—¶é—´&#x27;</span>, <span class="string">&#x27;å¸‚åœºè¥é”€&#x27;</span>, <span class="string">&#x27;Medium&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;2020-05-02&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_activity_event <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ç‹äº”&#x27;</span>, <span class="string">&#x27;å¯»æ‰¾é—å¤±çš„æ—¶é—´&#x27;</span>, <span class="string">&#x27;å¸‚åœºè¥é”€&#x27;</span>, <span class="string">&#x27;Medium&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2020-06-01&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ ¹æ®è§„åˆ™ï¼ŒClickHouse ä¼šåˆ›å»º 3 ä¸ªåˆ†åŒºç›®å½•ï¼Œåˆ†åŒºç›®å½•çš„ PartitionID éƒ¨åˆ†ä¾æ¬¡ä¸º 202005ã€202005ã€202006ï¼›è€Œå¯¹äºæ¯ä¸ªæ–°åˆ›å»ºçš„åˆ†åŒºç›®å½•è€Œè¨€ï¼Œå®ƒä»¬çš„ MinBlockNum å’Œ MaxBlockNum éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œå¹¶ä¸”æˆ‘ä»¬è¯´ MinBlockNum å’Œ MaxBlockNum æ˜¯å…¨å±€çš„ï¼Œä» 1 å¼€å§‹è‡ªå¢ï¼Œæ‰€ä»¥ä¸‰ä¸ªåˆ†åŒºç›®å½•çš„ MinBlockNum å’Œ MaxBlockNum ä¾æ¬¡æ˜¯ 1 1ã€2 2ã€3 3ï¼›æœ€åæ˜¯ Levelï¼Œæ¯ä¸ªæ–°å»ºçš„åˆ†åŒºç›®å½•çš„åˆå§‹ Level éƒ½æ˜¯0ã€‚å› æ­¤ä¸‰ä¸ªåˆ†åŒºç›®å½•çš„æœ€ç»ˆåç§°å°±æ˜¯ 202005_1_1_0ã€202005_2_2_0ã€202006_3_3_0ã€‚</strong></p>
<p><strong>ä¹‹ååœ¨æŸä¸€æ—¶åˆ» MergeTree çš„åˆå¹¶åŠ¨ä½œå¼€å§‹äº†ï¼Œé‚£ä¹ˆå±äºåŒä¸€åˆ†åŒºçš„ 202005_1_1_0ã€202005_2_2_0 å°†ä¼šå‘ç”Ÿåˆå¹¶ï¼Œå¾—åˆ° 202005_1_2_1ï¼ˆMinBlockNum å–æœ€å°å€¼ã€MaxBlockNum å–æœ€å¤§å€¼ï¼ŒLevel å»æœ€å¤§å€¼åŠ  1ï¼‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121347504-214244480.png" alt="img"></p>
<p><strong>ç„¶åæˆ‘ä»¬å†æ’å…¥ä¸‰æ¡æ•°æ®ï¼ˆåˆ† 3 æ‰¹å†™å…¥ï¼‰ï¼ŒJoinTime åˆ†åˆ«ä¸º 2020-05-03ã€2020-06-02ã€2020-07-01ï¼Œé‚£ä¹ˆä¼šå†åˆ›å»º 3 ä¸ªåˆ†åŒºç›®å½•ï¼Œåˆ†åŒº ID åˆ†åˆ«ä¸º 202005ã€202006ã€202007ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121401101-615381315.png" alt="img"></p>
<p><strong>ä¹‹å MergeTree çš„åˆå¹¶åŠ¨ä½œå¼€å§‹ï¼Œå±äºç›¸åŒåˆ†åŒºçš„ç›®å½•å¼€å§‹åˆå¹¶ï¼Œ202005_1_2_1 å’Œ 202005_4_4_0 ä¼šå‘ç”Ÿåˆå¹¶ï¼Œå¾—åˆ° 202005_1_4_2ï¼›202006_3_3_0 å’Œ 202006_5_5_0 å‘ç”Ÿåˆå¹¶ï¼Œå¾—åˆ° 202006_3_5_1ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121413700-789754349.png" alt="img"></p>
<p><strong>å¦‚æœå†å†™å…¥æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆ MergeTree ä¾æ—§ä¼šå‘ç”Ÿåˆå¹¶ï¼Œç„¶åé‡å¤å’Œä¸Šé¢çš„ä¸€æ ·çš„åŠ¨ä½œã€‚ç›¸ä¿¡åˆ°è¿™é‡Œå·²ç»æ˜ç™½åˆ†åŒº IDã€ç›®å½•å‘½åã€ä»¥åŠæ•°æ®åˆå¹¶çš„ç›¸å…³è§„åˆ™ã€‚</strong></p>
<p><strong>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆ‘ä»¬ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯ç›®å½•åˆå¹¶ä¹‹åçš„ç»“æœï¼Œè‡³äºæ—§çš„åˆ†åŒºç›®å½•ã€ä¹Ÿå°±æ˜¯åˆå¹¶ä¹‹å‰çš„ç›®å½•ä¼šä¾æ—§ä¿ç•™ä¸€æ®µæ—¶é—´ï¼Œä½†å·²ä¸å†æ˜¯æ¿€æ´»çŠ¶æ€ï¼ˆactive &#x3D; 0ï¼‰ï¼Œåœ¨æ•°æ®æŸ¥è¯¢çš„æ—¶å€™ä¼šè¢«è¿‡æ»¤æ‰ã€‚ç„¶å ClickHouse æœ‰ä¸€ä¸ªåå°ä»»åŠ¡ä¼šå®šæ—¶æ‰«æï¼ˆé»˜è®¤ 8 åˆ†é’Ÿï¼‰ï¼Œè´Ÿè´£å°† active &#x3D; 0 çš„ç›®å½•ä»ç‰©ç†ç£ç›˜ä¸Šåˆ é™¤ã€‚</strong></p>
<h2 id="ä¸€çº§ç´¢å¼•"><a href="#ä¸€çº§ç´¢å¼•" class="headerlink" title="ä¸€çº§ç´¢å¼•"></a>ä¸€çº§ç´¢å¼•</h2><p><strong>MergeTree çš„ä¸»é”®ä½¿ç”¨ PRIMARY KEY å®šä¹‰ï¼Œä¸»é”®å®šä¹‰ä¹‹åï¼ŒMergeTree ä¼šä¾æ® index_granularity é—´éš”ï¼ˆé»˜è®¤ 8192 è¡Œï¼‰ä¸ºæ•°æ®è¡¨ç”Ÿæˆä¸€çº§ç´¢å¼•å¹¶ä¿å­˜è‡³ primary.idx æ–‡ä»¶ä¸­ï¼Œå¹¶æŒ‰ç…§ä¸»é”®è¿›è¡Œæ’åºã€‚å¦‚æœä¸æŒ‡å®š PAIMARY KEYï¼Œé‚£ä¹ˆä¸»é”®é»˜è®¤å’Œæ’åºé”®ç›¸åŒï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç´¢å¼•ï¼ˆprimary.idxï¼‰å’Œæ•°æ®ï¼ˆdata.binï¼‰ä¼šæŒ‰ç…§å®Œå…¨ç›¸åŒçš„è§„åˆ™æ’åºã€‚</strong></p>
<blockquote>
<p><strong>ä½¿ç”¨ PRIMARY KEY å®šä¹‰ä¸»é”®å’Œä½¿ç”¨ ORDER BY ä»£æ›¿å®šä¹‰ä¸»é”®ï¼Œä¸¤è€…ä¹‹é—´è¿˜æ˜¯æœ‰ç‚¹å·®åˆ«çš„ï¼Œè¿™ä¸ªå·®åˆ«ä¼šåœ¨ SummingMergeTree ä¸­æœ‰æ‰€ä½“ç°ï¼Œåç»­ä»‹ç» ã€‚</strong></p>
</blockquote>
<h3 id="ç¨€ç–ç´¢å¼•"><a href="#ç¨€ç–ç´¢å¼•" class="headerlink" title="ç¨€ç–ç´¢å¼•"></a>ç¨€ç–ç´¢å¼•</h3><p><strong>primary.idx æ–‡ä»¶å†…çš„ä¸€çº§ç´¢å¼•é‡‡ç”¨ç¨€ç–ç´¢å¼•å®ç°ï¼Œæ—¢ç„¶æœ‰ç¨€ç–ç´¢å¼•ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä¹Ÿæœ‰ç¨ å¯†ç´¢å¼•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¿˜çœŸæœ‰ï¼Œç¨€ç–ç´¢å¼•å’Œç¨ å¯†ç´¢å¼•ä¹‹é—´çš„åŒºåˆ«å¦‚ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121423507-1319491738.png" alt="img"></p>
<p><strong>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¨ å¯†ç´¢å¼•ä¸­æ¯ä¸€è¡Œæ•°æ®éƒ½ä¼šå¯¹åº”ä¸€è¡Œå”¯ä¸€çš„ç´¢å¼•ï¼›è€Œåœ¨ç¨€ç–ç´¢å¼•ä¸­åªæœ‰éƒ¨åˆ†æ•°æ®ä¼šå¯¹åº”ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯ç›¸é‚»ç´¢å¼•å¯¹åº”çš„æ•°æ®ä¸ç›¸é‚»ï¼Œä¸­é—´ä¼šè·¨è¶Šä¸€å®šè¡Œæ•°çš„æ•°æ®ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œç¨€ç–ç´¢å¼•æ˜¯å¦‚ä½•å‡†ç¡®å®šä½æ•°æ®çš„å‘¢ï¼Ÿ</strong></p>
<p><strong>å‡è®¾æˆ‘è¦æ‰¾ç¬¬ 10000 æ¡æ•°æ®ï¼Œé‚£ä¹ˆé¦–å…ˆ ClickHouse ä¼šè¿›è¡Œä¸€æ¬¡äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•ã€‚å› ä¸º 0 -&gt; 0ã€1 -&gt; 8192ã€2 -&gt; 16384ï¼Œè€Œç¬¬ 10000 æ¡æ•°æ®ä½äº 8192 å’Œ 16384 ä¹‹é—´ï¼Œé‚£ä¹ˆè¦æ‰¾çš„ç´¢å¼•å°±æ˜¯ 1ï¼Œäºæ˜¯ ClickHouse ä¼šå†é€šè¿‡ç´¢å¼• 1 æ‰¾åˆ°ç¬¬ 8192 è¡Œæ•°æ®ï¼Œç„¶åä¸æ–­å¾€åéå†ï¼Œæœ€ç»ˆæ‰¾åˆ°æˆ‘ä»¬è¦æ•°æ®ã€‚å¦‚æœç†Ÿæ‚‰ kafka çš„è¯ï¼Œkafka åº•å±‚å­˜å‚¨æ¶ˆæ¯ä¹Ÿæ˜¯ç”¨åˆ°çš„ç¨€ç–ç´¢å¼•ï¼Œè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆä¸ç”¨ç¨ å¯†ç´¢å¼•å‘¢ï¼Ÿå¦‚æœä½¿ç”¨ç¨ å¯†ç´¢å¼•çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥å°±å¯ä»¥å®šä½åˆ°å‡†ç¡®çš„æ•°æ®ï¼Œä»è€Œå‡å°‘åç»­éå†æ‰€å¸¦æ¥çš„ç£ç›˜ IOï¼Œå¯ä¸ºä»€ä¹ˆä¸è¿™ä¹ˆåšå‘¢ã€‚å…¶å®åŸå› å¾ˆç®€å•ï¼ŒClickHouseã€kafka éƒ½æ˜¯åº”ç”¨åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œç”±äºæ•°æ®é‡æœ¬èº«å°±å¾ˆå¤§ï¼Œé‚£ä¹ˆä½¿ç”¨ç¨ å¯†ç´¢å¼•å¸¦æ¥çš„ç©ºé—´å ç”¨ä¹Ÿä¼šå¾ˆå¤§ã€‚è€Œç¨€ç–ç´¢å¼•å ç©ºé—´å°ï¼Œå› ä¸ºä¸éœ€è¦é‚£ä¹ˆå¤šè¡Œï¼Œä»¥é»˜è®¤çš„ç´¢å¼•ç²’åº¦ï¼ˆ8192ï¼‰ä¸ºä¾‹ï¼ŒMergeTree åªéœ€è¦ 12208 è¡Œç´¢å¼•æ ‡è®°å°±èƒ½ä¸º 1 äº¿è¡Œæ•°æ®è®°å½•æä¾›ç´¢å¼•ã€‚è™½ç„¶åç»­éå†ä¼šå¸¦æ¥é¢å¤–çš„ç£ç›˜ IOï¼Œä½†ç”±äºæ˜¯é¡ºåº IOï¼Œå› æ­¤æ•ˆç‡å®é™…ä¸Šæ˜¯ä¸ä½çš„ï¼Œæˆ‘ä»¬çŸ¥é“æœºæ¢°ç£ç›˜è™½ç„¶ä¸æ“…é•¿éšæœºè¯»å†™ï¼Œä½†é¡ºåºè¯»å†™è¿˜æ˜¯å¾ˆå¿«çš„ï¼ŒSSD å°±æ›´ä¸å¿…è¯´äº†ã€‚</strong></p>
<p><strong>æœ€å…³é”®çš„æ˜¯ï¼Œç”±äºç¨€ç–ç´¢å¼•å ç”¨ç©ºé—´å°ï¼Œé‚£ä¹ˆå¯ä»¥å¸¸é©»å†…å­˜ï¼Œå› æ­¤è¯»å–çš„é€Ÿåº¦éå¸¸å¿«ã€‚å¦‚æœä½¿ç”¨ç¨ å¯†ç´¢å¼•ï¼Œé‚£ä¹ˆç”±äºç©ºé—´å ç”¨è¿‡å¤§è€Œå¯èƒ½å¯¼è‡´æ— æ³•è¯»è¿›å†…å­˜ä¸­ï¼Œå› æ­¤åªèƒ½åœ¨ç£ç›˜ä¸Šæ“ä½œï¼Œè¿™æ ·åœ¨æŸ¥æ‰¾ç´¢å¼•çš„æ—¶å€™ä¹Ÿä¼šå¸¦æ¥ç£ç›˜ IOã€‚å› æ­¤ç»¼ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ç¨€ç–ç´¢å¼•çš„æ€§ä»·æ¯”ç›¸è¾ƒäºç¨ å¯†ç´¢å¼•æ˜æ˜¾è¦æ›´é«˜ï¼Œå› ä¸ºé€Ÿåº¦ç›¸å·®ä¸å¤§ï¼Œä½†çœä¸‹äº†å¤§é‡çš„ç£ç›˜ç©ºé—´ã€‚</strong></p>
<blockquote>
<p><strong>æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬è¯´ç´¢å¼•å’Œæ•°æ®ä¹‹é—´æ˜¯å¯¹åº”çš„ï¼Œä½†æˆ‘ä»¬çŸ¥é“å®ƒä»¬ä¸æ˜¯ç›´æ¥å¯¹åº”çš„ï¼Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»æ•°æ®è¡¨çš„å­˜å‚¨ç»“æ„æ—¶è¯´è¿‡ï¼Œé™¤äº†ç´¢å¼•æ–‡ä»¶ï¼ˆprimary.idxï¼‰å’Œæ•°æ®æ–‡ä»¶ï¼ˆdata.binï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ ‡è®°æ–‡ä»¶ï¼ˆdata.mrkï¼‰ã€‚æ ‡è®°æ–‡ä»¶ä¸­ä¿å­˜äº† data.bin æ–‡ä»¶ä¸­æ•°æ®çš„åç§»é‡ä¿¡æ¯ï¼Œå¹¶ä¸”æ ‡è®°æ–‡ä»¶ï¼ˆæˆ–è€…è¯´åç§»é‡ï¼‰ä¸ç¨€ç–ç´¢å¼•å¯¹é½ï¼Œå› æ­¤æƒ³è¦é€šè¿‡ç´¢å¼•æ‰¾åˆ°å…·ä½“çš„æ•°æ®è¿˜éœ€è¦å€ŸåŠ©äº data.mrk ä¸­åç§»é‡ã€‚</strong></p>
</blockquote>
<h3 id="ç´¢å¼•ç²’åº¦"><a href="#ç´¢å¼•ç²’åº¦" class="headerlink" title="ç´¢å¼•ç²’åº¦"></a>ç´¢å¼•ç²’åº¦</h3><p><strong>ç´¢å¼•ç²’åº¦æ˜¯å»ºè¡¨çš„æ—¶å€™ï¼Œåœ¨ SETTINGS é‡Œé¢æŒ‡å®š index_granularity æ§åˆ¶çš„ï¼Œè™½ç„¶ ClickHouse æä¾›äº†è‡ªé€‚åº”ç²’åº¦å¤§å°çš„ç‰¹æ€§ï¼Œä½†æ˜¯ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å›ºå®šçš„ç´¢å¼•ç²’åº¦è¿›è¡Œä»‹ç»ï¼ˆ8192ï¼‰ã€‚ç´¢å¼•ç²’åº¦å¯¹äº MergeTree è€Œè¨€æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒå°±å¦‚åŒä¸€æŠŠæ ‡å°ºï¼Œä¼šä¸ˆé‡æ•´ä¸ªæ•°æ®çš„é•¿åº¦ï¼Œå¹¶ä¾ç…§åˆ»åº¦å¯¹æ•°æ®è¿›è¡Œæ ‡æ³¨ï¼Œæœ€ç»ˆå°†æ•°æ®æ ‡è®°æˆå¤šä¸ªé—´éš”çš„å°æ®µã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121431115-1300566604.png" alt="img"></p>
<p><strong>æ•°æ®ä»¥ index_granularity çš„ç²’åº¦ï¼ˆé»˜è®¤ 8192ï¼‰è¢«æ ‡è®°æˆå¤šä¸ªå°çš„åŒºé—´ï¼Œå…¶ä¸­æ¯ä¸ªåŒºé—´æœ€å¤š 8192 è¡Œæ•°æ®ï¼ŒMergeTree ä½¿ç”¨ MarkRange è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„åŒºé—´ï¼Œå¹¶é€šè¿‡ start å’Œ end è¡¨ç¤ºå…¶å…·ä½“çš„èŒƒå›´ã€‚index_granularity çš„åå­—è™½ç„¶å–äº†ç´¢å¼•äºŒå­—ï¼Œä½†å®ƒä¸å•å•åªä½œç”¨äºä¸€çº§ç´¢å¼•ï¼ŒåŒæ—¶è¿˜ä¼šå½±å“æ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆdata.mrkï¼‰å’Œæ•°æ®æ–‡ä»¶ï¼ˆdata.binï¼‰ã€‚å› ä¸ºåªæœ‰ä¸€çº§ç´¢å¼•æ˜¯æ— æ³•å®ŒæˆæŸ¥è¯¢å·¥ä½œçš„ï¼Œå®ƒéœ€è¦å€ŸåŠ©æ ‡è®°æ–‡ä»¶ä¸­çš„åç§»é‡æ‰èƒ½å®šä½æ•°æ®ï¼Œæ‰€ä»¥ä¸€çº§ç´¢å¼•å’Œæ•°æ®æ ‡è®°çš„é—´éš”ç²’åº¦ï¼ˆåŒä¸º index_granularity è¡Œï¼‰ç›¸åŒï¼Œå½¼æ­¤å¯¹é½ï¼Œè€Œæ•°æ®æ–‡ä»¶ä¹Ÿä¼šæŒ‰ç…§ index_granularity çš„é—´éš”ç²’åº¦ç”Ÿæˆå‹ç¼©æ•°æ®å—ã€‚</strong></p>
<h3 id="ç´¢å¼•æ•°æ®çš„ç”Ÿæˆè§„åˆ™"><a href="#ç´¢å¼•æ•°æ®çš„ç”Ÿæˆè§„åˆ™" class="headerlink" title="ç´¢å¼•æ•°æ®çš„ç”Ÿæˆè§„åˆ™"></a>ç´¢å¼•æ•°æ®çš„ç”Ÿæˆè§„åˆ™</h3><p><strong>ç”±äºæ˜¯ç¨€ç–ç´¢å¼•ï¼Œæ‰€ä»¥ MergeTree éœ€è¦é—´éš” index_granularity è¡Œæ•°æ®æ‰ä¼šç”Ÿæˆä¸€æ¡ç´¢å¼•è®°å½•ï¼Œå…¶ç´¢å¼•å€¼ä¼šä¾æ®å£°æ˜çš„ä¸»é”®å­—æ®µè·å–ã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hits_v1 (</span><br><span class="line">    CounterID Int64,</span><br><span class="line">    EventDate <span class="type">Date</span></span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY CounterID  <span class="comment">-- ä¹Ÿå¯ä»¥ä¸å†™ï¼Œé»˜è®¤å’Œæ’åºé”®ä¿æŒä¸€è‡´</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> CounterID</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶ EventDate ä¸º 2020 å¹´ 4 æœˆçš„æ•°æ®ä¼šè¢«åˆ’åˆ†åˆ°åŒä¸€ä¸ªåˆ†åŒºç›®å½•ä¸­ï¼Œå¹¶ä¸”æ¯éš” 8192 æ¡æ•°æ®å°±ä¼šå–ä¸€æ¬¡ CounterID çš„å€¼ï¼ˆæ’å¥½åºçš„ï¼‰ä½œä¸ºç´¢å¼•å€¼ï¼Œå†™å…¥ primary.idx æ–‡ä»¶è¿›è¡Œä¿å­˜ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121445103-847797721.png" alt="img"></p>
<p><strong>ä¾‹å¦‚ç¬¬ 0 è¡Œï¼ˆ8192 * 0ï¼‰çš„ CounterID å–å€¼ä¸º 57ï¼Œç¬¬ 8192 è¡Œï¼ˆ8192 * 1ï¼‰çš„ CounterID å–å€¼ä¸º 1635ï¼Œç¬¬ 16384 è¡Œï¼ˆ8192 * 2ï¼‰çš„ CounterID å–å€¼ä¸º 3266ï¼Œæœ€ç»ˆç´¢å¼•æ•°æ®å°†ä¼šæ˜¯ 5716353266â€¦â€¦ã€‚</strong></p>
<p><strong>å¯ä»¥çœ‹åˆ° MergeTree å¯¹äºç¨€ç–ç´¢å¼•çš„å­˜å‚¨æ˜¯éå¸¸ç´§å‡‘çš„ï¼Œç´¢å¼•å€¼å‰åç›¸è¿ï¼ŒæŒ‰ç…§ä¸»é”®å­—æ®µé¡ºåºç´§å¯†åœ°æ’åˆ—åœ¨ä¸€èµ·ã€‚å¹¶ä¸”ä¸ä»…æ˜¯è¿™é‡Œï¼ŒClickHouse ä¸­å¾ˆå¤šæ•°æ®ç»“æ„éƒ½è¢«è®¾è®¡çš„éå¸¸ç´§å‡‘ï¼Œæ¯”å¦‚ä½¿ç”¨ä½è¯»å–æ›¿ä»£ä¸“é—¨çš„æ ‡å¿—ä½æˆ–çŠ¶æ€ç ï¼ˆå‡è®¾ 32 ä½æ•´å‹å­˜å‚¨çš„æ•°æ®æœ€å¤šå ç”¨ 20 ä¸ªä½ï¼Œé‚£ä¹ˆå°±å¯ä»¥åªç”¨ 20 ä¸ªä½è¡¨ç¤ºæ•°æ®ï¼Œç„¶åå‰©ä½™çš„ä½ç”¨æ¥è¡¨ç¤ºçŠ¶æ€ç ï¼‰ï¼Œä¸æµªè´¹ä»»ä½•ä¸€ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ ClickHouse æ€§èƒ½å‡ºä¼—ä¸æ˜¯æ²¡æœ‰åŸå› çš„ï¼Œæ¯ä¸€æ­¥éƒ½åšè¶³äº†ä¼˜åŒ–ã€‚</strong></p>
<p><strong>å¦‚æœä½¿ç”¨å¤šä¸ªä¸»é”®ï¼Œä¾‹å¦‚ ORDER BY (CounterID, EventDate)ï¼Œåˆ™æ¯é—´éš” 8192 è¡Œä¼šåŒæ—¶å– CounterID å’Œ EventDate ä¸¤åˆ—çš„å€¼ä½œä¸ºç´¢å¼•å€¼ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121453878-978279006.png" alt="img"></p>
<h3 id="ç´¢å¼•çš„æŸ¥è¯¢è¿‡ç¨‹"><a href="#ç´¢å¼•çš„æŸ¥è¯¢è¿‡ç¨‹" class="headerlink" title="ç´¢å¼•çš„æŸ¥è¯¢è¿‡ç¨‹"></a>ç´¢å¼•çš„æŸ¥è¯¢è¿‡ç¨‹</h3><p><strong>åœ¨è¯´å®Œç´¢å¼•çš„ä¸€äº›æ¦‚å¿µä¹‹åï¼Œæ¥ä¸‹æ¥è¯´æ˜ç´¢å¼•å…·ä½“æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯ MarkRangeï¼ŒMarkRange åœ¨ ClickHouse ä¸­æ˜¯ç”¨äºå®šä¹‰æ ‡è®°åŒºé—´çš„å¯¹è±¡ã€‚MergeTree æŒ‰ç…§ index_granularity çš„é—´éš”ç²’åº¦ï¼Œå°†ä¸€æ®µå®Œæ•´çš„æ•°æ®åˆ’åˆ†æˆäº†å¤šä¸ªå°çš„é—´éš”æ•°æ®æ®µï¼Œä¸€ä¸ªå…·ä½“çš„æ•°æ®æ®µå°±æ˜¯ä¸€ä¸ª MarkRangeï¼Œå¹¶ä¸ç´¢å¼•ç¼–å·å¯¹åº”ï¼Œä½¿ç”¨start å’Œ end ä¸¤ä¸ªå±æ€§è¡¨ç¤ºå…¶èŒƒå›´ã€‚é€šè¿‡ start å’Œ end å¯¹åº”çš„ç´¢å¼•ç¼–å·çš„å–å€¼ï¼Œå³å¯å¾—åˆ°å®ƒæ‰€å¯¹åº”çš„æ•°å€¼åŒºé—´ï¼Œè€Œæ•°å€¼åŒºåˆ«è¡¨ç¤ºäº†æ­¤ MarkRange çš„æ•°æ®èŒƒå›´ã€‚</strong></p>
<p><strong>å¦‚æœåªæ˜¯è¿™ä¹ˆå¹²å·´å·´çš„ä»‹ç»ï¼Œå¯èƒ½ä¼šæœ‰äº›æŠ½è±¡ï¼Œä¸‹é¢ç”¨ä¸€ä»½ç¤ºä¾‹æ•°æ®æ¥è¯´æ˜ä¸€ä¸‹ã€‚å‡å¦‚ç°åœ¨æœ‰ä¸€ä»½æµ‹è¯•æ•°æ®ï¼Œå…± 192 è¡Œè®°å½•ï¼Œå…¶ä¸­ä¸»é”® ID ä¸º String ç±»å‹ï¼Œå–å€¼ä» A000 å¼€å§‹ï¼Œåé¢ä¾æ¬¡ä¸º A001ã€A002ã€â€¦â€¦ï¼Œç›´åˆ° A192 ä¸ºæ­¢ã€‚MergeTree çš„ç´¢å¼•ç²’åº¦ index_granularity ä¸º 3ï¼Œæ ¹æ®ç´¢å¼•çš„ç”Ÿæˆè§„åˆ™ï¼Œé‚£ä¹ˆ primary.idx æ–‡ä»¶çš„ç´¢å¼•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121503704-1600149797.png" alt="img"></p>
<p><strong>æ ¹æ®ç´¢å¼•æ•°æ®ï¼ŒMergeTree ä¼šå°†æ­¤æ•°æ®ç‰‡æ®µåˆ’åˆ†æˆ 192&#x2F;3&#x3D;64 ä¸ªå°çš„ MarkRangeï¼Œä¸¤ä¸ªç›¸é‚»çš„ MarkRange ç›¸è·çš„æ­¥é•¿ä¸º 1ã€‚å…¶ä¸­ï¼Œæ‰€æœ‰ MarkRangeï¼ˆæ•´ä¸ªæ•°æ®ç‰‡æ®µï¼‰çš„æœ€å¤§æ•°å€¼åŒºé—´ä¸º [A000, +inf)ï¼Œå®Œæ•´ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121512266-468243103.png" alt="img"></p>
<p><strong>åœ¨å¼•å…¥äº†æ•°å€¼åŒºé—´çš„æ¦‚å¿µä¹‹åï¼Œå¯¹äºç´¢å¼•æ•°æ®çš„æŸ¥è¯¢è¿‡ç¨‹å°±å¾ˆå¥½è§£é‡Šäº†ï¼Œç´¢å¼•æŸ¥è¯¢å…¶å®å°±æ˜¯ä¸¤ä¸ªåŒºé—´çš„äº¤é›†åˆ¤æ–­ã€‚å…¶ä¸­ä¸€ä¸ªåŒºé—´æ˜¯ç”±åŸºäºä¸»é”®çš„æŸ¥è¯¢æ¡ä»¶è½¬æ¢è€Œæ¥çš„æ¡ä»¶åŒºé—´ï¼›å¦ä¸€ä¸ªåŒºé—´å°±æ˜¯ä¸Šé¢è¯´çš„ä¸ MarkRange å¯¹åº”çš„æ•°å€¼åŒºé—´ã€‚</strong></p>
<p><strong>æ‰€ä»¥æ•´ä¸ªæŸ¥è¯¢å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š</strong></p>
<p><strong>1ï¼‰ç”ŸæˆæŸ¥è¯¢åŒºé—´ï¼šé¦–å…ˆå°†æŸ¥è¯¢æ¡ä»¶è½¬æ¢ä¸ºåŒºé—´ï¼Œå³ä½¿æ˜¯å•ä¸ªå€¼ä¹Ÿä¼šè½¬æ¢ä¸ºåŒºé—´çš„å½¢å¼ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WHERE</span> ID <span class="operator">=</span> <span class="string">&#x27;A003&#x27;</span> <span class="operator">-</span><span class="operator">&gt;</span> [<span class="string">&#x27;A003&#x27;</span>, <span class="string">&#x27;A003&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> ID <span class="operator">&gt;</span> <span class="string">&#x27;A012&#x27;</span> <span class="operator">-</span><span class="operator">&gt;</span> (<span class="string">&#x27;A012&#x27;</span>, <span class="operator">+</span>inf]</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHERE</span> ID <span class="operator">&lt;</span> <span class="string">&#x27;A185&#x27;</span> <span class="operator">-</span><span class="operator">&gt;</span> [<span class="operator">-</span>inf, <span class="string">&#x27;A185&#x27;</span>)</span><br><span class="line">                      </span><br><span class="line"><span class="keyword">WHERE</span> ID <span class="keyword">LIKE</span> <span class="string">&#x27;A006%&#x27;</span> <span class="operator">-</span><span class="operator">&gt;</span> [<span class="string">&#x27;A006&#x27;</span>, <span class="string">&#x27;A007&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰é€’å½’äº¤é›†åˆ¤æ–­ï¼šä»¥é€’å½’çš„å½¢å¼ï¼Œä¾æ¬¡å¯¹ MarkRange çš„æ•°å€¼åŒºé—´ä¸æ¡ä»¶åŒºé—´åšäº¤é›†åˆ¤æ–­ï¼Œä»æœ€å¤§çš„åŒºé—´ [A000, +inf) å¼€å§‹ï¼š</strong></p>
<ul>
<li><code>å¦‚æœä¸å­˜åœ¨äº¤é›†ï¼Œåˆ™ç›´æ¥é€šè¿‡å‰ªæç®—æ³•ä¼˜åŒ–æ­¤æ•´æ®µ MarkRange</code></li>
<li><code>å¦‚æœå­˜åœ¨äº¤é›†ï¼Œä¸” MarkRange æ­¥é•¿å¤§äºç­‰äº 8ï¼ˆend - startï¼‰ï¼Œåˆ™å°†æ­¤åŒºé—´è¿›ä¸€æ­¥æ‹†åˆ†æˆ 8 ä¸ªå­åŒºé—´ï¼ˆç”± merge_tree_coarse_index_granularity æŒ‡å®šï¼Œé»˜è®¤å€¼ä¸º 8ï¼‰ï¼Œç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼Œç»§ç»­åšé€’å½’äº¤é›†åˆ¤æ–­</code></li>
<li><code>å¦‚æœå­˜åœ¨äº¤é›†ï¼Œä¸” MarkRange ä¸å¯å†åˆ†è§£ï¼ˆæ­¥é•¿å°äº 8ï¼‰ï¼Œåˆ™è®°å½• MarkRange å¹¶è¿”å›</code></li>
</ul>
<p><strong>3ï¼‰åˆå¹¶ MarkRange åŒºé—´ï¼šå°†æœ€ç»ˆåŒ¹é…çš„ MarkRange èšåœ¨ä¸€èµ·ï¼Œåˆå¹¶å®ƒä»¬çš„èŒƒå›´ã€‚</strong></p>
<p><strong>å…‰è¯´ä¸å¥½ç†è§£ï¼Œæˆ‘ä»¬ç”»ä¸€å¼ å›¾ï¼Œæ¥å±•ç¤ºä¸€ä¸‹ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤ï¼Œè¿˜ä»¥ä¸Šé¢çš„æµ‹è¯•æ•°æ®ä¸ºä¾‹ï¼ŒæŸ¥è¯¢æ¡ä»¶ä¸º ID &#x3D; â€˜A003â€™ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121523250-1848437617.png" alt="img"></p>
<p><strong>MergeTree é€šè¿‡é€’å½’çš„å½¢å¼æŒç»­å‘ä¸‹æ‹†åˆ†åŒºé—´ï¼Œæœ€ç»ˆå°† MarkRange å®šä½åˆ°æœ€ç»†çš„ç²’åº¦ï¼Œä»¥ä¾¿åœ¨åç»­è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæœ€å°åŒ–æ•°æ®çš„æ‰«æèŒƒå›´ã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå½“æŸ¥è¯¢æ¡ä»¶ä¸º ID &#x3D; â€˜A003â€™ çš„æ—¶å€™ï¼Œæœ€ç»ˆåªéœ€è¦è¯»å– [A000, A003] å’Œ [A003, A006] ä¸¤ä¸ªåŒºé—´çš„æ•°æ®ï¼Œå®ƒä»¬å¯¹åº” MarkRange(start:0, end:2) èŒƒå›´ï¼Œè€Œå…¶å®ƒæ— ç”¨åŒºé—´éƒ½è¢«è£å‰ªæ‰äº†ã€‚ç”±äº MarkRange è½¬æ¢çš„æ•°å€¼åŒºé—´æ˜¯é—­åŒºé—´ï¼Œæ‰€ä»¥ä¼šé¢å¤–åŒ¹é…åˆ°ä¸´è¿‘çš„ä¸€ä¸ªåŒºé—´ã€‚</strong></p>
<h2 id="äºŒçº§ç´¢å¼•"><a href="#äºŒçº§ç´¢å¼•" class="headerlink" title="äºŒçº§ç´¢å¼•"></a>äºŒçº§ç´¢å¼•</h2><p><strong>é™¤äº†ä¸€çº§ç´¢å¼•ä¹‹å¤–ï¼ŒMergeTree åŒæ ·æ”¯æŒäºŒçº§ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•åˆç§°è·³æ•°ç´¢å¼•ï¼Œç”±æ•°æ®çš„èšåˆä¿¡æ¯æ„å»ºè€Œæˆã€‚æ ¹æ®ç´¢å¼•ç±»å‹çš„ä¸åŒï¼Œå…¶èšåˆä¿¡æ¯çš„å†…å®¹ä¹Ÿä¸åŒï¼Œå½“ç„¶è·³æ•°ç´¢å¼•çš„ä½œç”¨å’Œä¸€çº§ç´¢å¼•æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæ˜¯ä¸ºäº†æŸ¥è¯¢æ—¶å‡å°‘æ•°æ®çš„æ‰«æèŒƒå›´ã€‚</strong></p>
<p><strong>è·³æ•°ç´¢å¼•éœ€è¦åœ¨ CREATE è¯­å¥å†…å®šä¹‰ï¼Œå®ƒæ”¯æŒä½¿ç”¨å…ƒç»„å’Œè¡¨è¾¾å¼çš„å½¢å¼å£°æ˜ï¼Œå…¶å®Œæ•´çš„å®šä¹‰è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">    column1 type,</span><br><span class="line">    column2 type,</span><br><span class="line">    ......</span><br><span class="line">    INDEX index_name expr TYPE index_type(...) GRANULARITY granularity</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ä¸€çº§ç´¢å¼•ä¸€æ ·ï¼Œå¦‚æœåœ¨å»ºè¡¨è¯­å¥ä¸­å£°æ˜äº†è·³æ•°ç´¢å¼•ï¼Œåˆ™ä¼šé¢å¤–ç”Ÿæˆç›¸åº”çš„ç´¢å¼•æ–‡ä»¶å’Œæ ‡è®°æ–‡ä»¶ï¼ˆskp_idx_[Column].idx ä¸ skp_idx_[Column].idxï¼‰ã€‚</strong></p>
<h3 id="granularity-å’Œ-index-granularity-çš„å…³ç³»"><a href="#granularity-å’Œ-index-granularity-çš„å…³ç³»" class="headerlink" title="granularity å’Œ index_granularity çš„å…³ç³»"></a>granularity å’Œ index_granularity çš„å…³ç³»</h3><p><strong>ä¸åŒçš„è·³æ•°ç´¢å¼•ä¹‹é—´ï¼Œé™¤äº†å®ƒä»¬è‡ªèº«ç‹¬æœ‰çš„å‚æ•°ä¹‹å¤–ï¼Œè¿˜éƒ½å…±åŒæ‹¥æœ‰ granularity å‚æ•°ã€‚åˆæ¬¡æ¥è§¦æ—¶ï¼Œå¾ˆå®¹æ˜“å°† granularity å’Œ index_granularity çš„æ¦‚å¿µå¼„æ··æ·†ï¼Œå¯¹äºè·³æ•°ç´¢å¼•è€Œè¨€ï¼Œindex_granularity å®šä¹‰äº†æ•°æ®çš„ç²’åº¦ï¼Œè€Œ granularity å®šä¹‰äº†èšåˆä¿¡æ¯æ±‡æ€»çš„ç²’åº¦ã€‚æ¢è¨€ä¹‹ï¼Œgranularity å®šä¹‰äº†ä¸€è¡Œè·³æ•°ç´¢å¼•èƒ½å¤Ÿè·³è¿‡å¤šå°‘ä¸ª index_granularity åŒºé—´çš„æ•°æ®ã€‚</strong></p>
<p><strong>è¦è§£é‡Šæ¸…é™¤ granularity çš„ä½œç”¨ï¼Œå°±è¦æˆè·³æ•°ç´¢å¼•çš„ç”Ÿæˆè§„åˆ™è¯´èµ·ï¼Œå…¶è§„åˆ™å¤§è‡´æ˜¯å¦‚ä¸‹ï¼šé¦–å…ˆæŒ‰ç…§ index_granularity ç²’åº¦é—´éš”å°†æ•°æ®åˆ’åˆ†æˆ n æ®µï¼Œæ€»å…±æœ‰ [0, n - 1] ä¸ªåŒºé—´ï¼ˆn &#x3D; totol_rows &#x2F; index_granularityï¼Œå‘ä¸Šå–æ•´ï¼‰ï¼›æ¥ç€æ ¹æ®ç´¢å¼•å®šä¹‰æ—¶å£°æ˜çš„è¡¨è¾¾å¼ï¼Œä» 0 åŒºé—´å¼€å§‹ä¾æ¬¡æŒ‰ç…§ index_granularity ç²’åº¦ä»æ•°æ®ä¸­è·å–èšåˆä¿¡æ¯ï¼Œæ¯æ¬¡å‘å‰ç§»åŠ¨ä¸€æ­¥ï¼Œèšåˆä¿¡æ¯èšåˆä¿¡æ¯é€æ­¥ç´¯åŠ ã€‚æœ€åå½“ç§»åŠ¨ granularity æ¬¡åŒºé—´æ—¶ï¼Œåˆ™æ±‡æ€»å¹¶å£°ç§°ä¸€è¡Œè·³æ•°ç´¢å¼•æ•°æ®ã€‚</strong></p>
<p><strong>ä»¥ minmax ç´¢å¼•ä¸ºä¾‹ï¼Œå®ƒçš„èšåˆä¿¡æ¯æ˜¯åœ¨ä¸€ä¸ª index_granularity åŒºé—´å†…æ•°æ®çš„æœ€å°å’Œæœ€å¤§æå€¼ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121530948-1802107303.png" alt="img"></p>
<p><strong>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå‡è®¾ index_granularity &#x3D; 8192 ä¸” granularity &#x3D; 3ï¼Œåˆ™æ•°æ®ä¼šæŒ‰ç…§ index_granularity åˆ’åˆ†ä¸º n ç­‰ä»½ï¼ŒMergeTree ä»ç¬¬ 0 æ®µåˆ†åŒºå¼€å§‹ï¼Œä¾æ¬¡è·å–èšåˆä¿¡æ¯ã€‚å½“è·å–åˆ°ç¬¬ 3 ä¸ªåˆ†åŒºæ—¶ï¼ˆgranularity &#x3D; 3ï¼‰ï¼Œåˆ™ä¼šæ±‡æ€»å¹¶ç”Ÿæˆç¬¬ä¸€è¡Œ minmax ç´¢å¼•ï¼ˆå‰ 3 æ®µ minmax æå€¼æ±‡æ€»åå–å€¼ä¸º [1, 9]ï¼‰ã€‚</strong></p>
<h3 id="è·³æ•°ç´¢å¼•çš„ç±»å‹"><a href="#è·³æ•°ç´¢å¼•çš„ç±»å‹" class="headerlink" title="è·³æ•°ç´¢å¼•çš„ç±»å‹"></a>è·³æ•°ç´¢å¼•çš„ç±»å‹</h3><p><strong>ç›®å‰ MergeTree å…±æ”¯æŒ 4 ç§è·³æ•°ç´¢å¼•ï¼Œåˆ†åˆ«æ˜¯ï¼šminmaxã€setã€ngrambf_v1 å’Œ tokenbf_v1ï¼Œä¸€å¼ æ•°æ®è¡¨æ”¯æŒåŒæ—¶å£°æ˜å¤šä¸ªè·³æ•°ç´¢å¼•ï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> skip_test</span><br><span class="line">(</span><br><span class="line">    ID        String,</span><br><span class="line">    URL       String,</span><br><span class="line">    Code      String,</span><br><span class="line">    EventTime <span class="type">Date</span>,</span><br><span class="line">    INDEX a ID TYPE minmax GRANULARITY <span class="number">5</span>,</span><br><span class="line">    INDEX b (length(ID) <span class="operator">*</span> <span class="number">8</span>) TYPE <span class="keyword">set</span>(<span class="number">100</span>) GRANULARITY <span class="number">5</span>,</span><br><span class="line">    INDEX c (ID, Code) TYPE ngrambf_v1(<span class="number">3</span>, <span class="number">256</span>, <span class="number">2</span>, <span class="number">0</span>) GRANULARITY <span class="number">5</span>,</span><br><span class="line">    INDEX d ID TYPE tokenbf_v1(<span class="number">256</span>, <span class="number">2</span>, <span class="number">0</span>) GRANULARITY <span class="number">5</span></span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()............</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ä¸‹æ¥å°±å€ŸåŠ©ä¸Šé¢çš„æ —å­æ¥ä»‹ç»è¿™å‡ ç§è·³æ•°ç´¢å¼•çš„ç”¨æ³•ï¼š</strong></p>
<p><strong>1ï¼‰minmaxï¼šminmax ç´¢å¼•è®°å½•äº†ä¸€æ®µæ•°æ®å†…çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œå…¶ç´¢å¼•çš„ä½œç”¨ç±»ä¼¼åˆ†åŒºç›®å½•çš„ minmax ç´¢å¼•ï¼Œèƒ½å¤Ÿå¿«é€Ÿè·³è¿‡æ— ç”¨çš„æ•°æ®åŒºé—´ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INDEX a ID TYPE minmax GRANULARITY 5</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°ç¤ºä¾‹ä¸­ minmax ç´¢å¼•ä¼šè®°å½•è¿™æ®µæ•°æ®åŒºé—´å†… ID å­—æ®µçš„æå€¼ï¼Œæå€¼çš„è®¡ç®—æ¶‰åŠæ¯ 5 ä¸ª index_granularity åŒºé—´ä¸­çš„æ•°æ®ã€‚</strong></p>
<p><strong>2ï¼‰setï¼šset ç´¢å¼•ç›´æ¥è®°å½•äº†å£°æ˜å­—æ®µæˆ–è¡¨è¾¾å¼çš„å–å€¼ï¼ˆå”¯ä¸€å€¼ï¼Œæ— é‡å¤ï¼‰ï¼Œå…¶å®Œæ•´å½¢å¼ä¸º set(max_rows)ï¼Œå…¶ä¸­ max_rows æ˜¯ä¸€ä¸ªé˜ˆå€¼ï¼Œè¡¨ç¤ºåœ¨ä¸€ä¸ª index_granularity å†…ç´¢å¼•æœ€å¤šè®°å½•çš„æ•°æ®è¡Œæ•°ã€‚å¦‚æœ max_rows &#x3D; 0ï¼Œåˆ™è¡¨ç¤ºæ— é™åˆ¶ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INDEX b (length(ID) * 8) TYPE set(100) GRANULARITY 5</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°å®ä¾‹ä¸­ set ç´¢å¼•ä¼šè®°å½•æ•°æ®ä¸­ ID çš„é•¿åº¦ * 8 åçš„å–å€¼ï¼Œå…¶ä¸­ index_granularity å†…æœ€å¤šè®°å½• 100 æ¡ã€‚</strong></p>
<p><strong>3ï¼‰ngrambf_v1ï¼šngrambf_v1 ç´¢å¼•è®°å½•çš„æ˜¯æ•°æ®çŸ­è¯­çš„å¸ƒéš†è¡¨è¿‡æ»¤å™¨ï¼Œåªæ”¯æŒ String å’Œ FixedString æ•°æ®ç±»å‹ã€‚ngrambf_v1 åªèƒ½å¤Ÿæå‡ inã€notInã€likeã€equals å’Œ notEquals æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå…¶å®Œæ•´å½¢å¼ä¸ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ngrambf_v1(n, size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</span><br></pre></td></tr></table></figure>

<p><strong>è¿™äº›å‚æ•°æ˜¯ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨çš„æ ‡å‡†è¾“å…¥ï¼Œå¦‚æœä½ æ¥è§¦å¸ƒéš†è¿‡æ»¤å™¨ï¼Œåº”è¯¥å¯¹æ­¤ååˆ†ç†Ÿæ‚‰ï¼Œå®ƒä»¬çš„å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>nï¼štoken é•¿åº¦ï¼Œä¾æ® n çš„é•¿åº¦å°†æ•°æ®åˆ‡å‰²ä¸º token çŸ­è¯­</code></li>
<li><code>size_of_bloom_filter_in_bytesï¼šå¸ƒéš†è¿‡æ»¤å™¨çš„å¤§å°</code></li>
<li><code>number_of_hash_functionsï¼šå¸ƒéš†è¿‡æ»¤å™¨ä¸­ä½¿ç”¨ Hash å‡½æ•°çš„ä¸ªæ•°</code></li>
<li><code>random_seedï¼šHash å‡½æ•°çš„éšæœºç§å­</code></li>
</ul>
<p><strong>ä¾‹å¦‚åœ¨ä¸‹é¢çš„æ —å­ä¸­ï¼Œngrambf_v1 ç´¢å¼•ä¼šä¾ç…§ 3 çš„ç²’åº¦å°†æ•°æ®åˆ‡å‰²æˆçŸ­è¯­ tokenï¼Œtoken ä¼šç»è¿‡ 2 ä¸ª Hash å‡½æ•°æ˜ å°„ä¹‹åå†è¢«å†™å…¥ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¤§å°ä¸º 256 å­—èŠ‚ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INDEX c (ID, Code) TYPE ngrambf_v1(3, 256, 2, 0) GRANULARITY 5</span><br></pre></td></tr></table></figure>

<p><strong>4ï¼‰tokenbf_v1ï¼štokenbf_v1 ç´¢å¼•æ˜¯ ngrambf_v1 çš„å˜ç§ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸€ç§å¸ƒéš†è¿‡æ»¤å™¨ç´¢å¼•ï¼Œä½† tokenbf_v1 é™¤äº†çŸ­è¯­ token çš„å¤„ç†æ–¹æ³•å¤–ï¼Œå…¶å®ƒä¸ ngrambf_v1 æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚tokenbf_v1 ä¼šè‡ªåŠ¨æŒ‰ç…§éå­—ç¬¦çš„ã€æ•°å­—çš„å­—ç¬¦ä¸²åˆ†å‰² tokenï¼Œå…·ä½“ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INDEX d ID TYPE tokenbf_v1(256, 2, 0) GRANULARITY 5</span><br></pre></td></tr></table></figure>

<h2 id="æ•°æ®å­˜å‚¨"><a href="#æ•°æ®å­˜å‚¨" class="headerlink" title="æ•°æ®å­˜å‚¨"></a>æ•°æ®å­˜å‚¨</h2><p><strong>æ­¤å‰å·²ç»å¤šæ¬¡æè¿‡ï¼Œåœ¨ MergeTree ä¸­æ•°æ®æ˜¯æŒ‰åˆ—å­˜å‚¨çš„ï¼Œä½†å…·ä½“ç»†èŠ‚åˆ°åº•å¦‚ä½•æˆ‘ä»¬è¿˜ä¸æ¸…æ¥šï¼Œé‚£ä¹ˆä¸‹é¢å°±æ¥è§£é‡Šä¸€ä¸‹ã€‚å› ä¸ºæ•°æ®å­˜å‚¨å°±å¥½æ¯”ä¸€æœ¬ä¹¦ä¸­çš„æ–‡å­—ï¼Œåœ¨æ’ç‰ˆæ—¶ä¸å¯èƒ½ç›´æ¥å¯†å¯†éº»éº»åœ°æŠŠæ–‡å­—å †æ»¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´éš¾ä»¥é˜…è¯»ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯å°†æ–‡å­—æŒ‰ç…§æ®µè½ç²¾å¿ƒç»„ç»‡ä½¿å…¶é”™è½æœ‰è‡´ã€‚æ•°æ®å­˜å‚¨ä¹Ÿæ˜¯åŒæ ·çš„åˆ°åº•ï¼Œæ•°æ®ä¹Ÿéœ€è¦ç²¾å¿ƒç»„ç»‡ä¹‹åä¹Ÿå­˜å‚¨åˆ°ç£ç›˜ã€‚</strong></p>
<h3 id="æ•°æ®æŒ‰åˆ—å­˜å‚¨"><a href="#æ•°æ®æŒ‰åˆ—å­˜å‚¨" class="headerlink" title="æ•°æ®æŒ‰åˆ—å­˜å‚¨"></a>æ•°æ®æŒ‰åˆ—å­˜å‚¨</h3><p><strong>åœ¨ MergeTree ä¸­æ•°æ®æŒ‰åˆ—å­˜å‚¨ï¼Œåœ¨è€ç‰ˆæœ¬ä¸­æ¯ä¸ªåˆ—ä¹Ÿæ˜¯ç‹¬ç«‹å­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªåˆ—å­—æ®µéƒ½æ‹¥æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ .bin æ–‡ä»¶ï¼›ä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ä¸­è¿™äº›åˆ—å­—æ®µå¯¹åº”çš„ .bin æ–‡ä»¶åˆå¹¶åœ¨ä¸€èµ·äº†ï¼Œåªæœ‰ä¸€ä¸ª data.binã€‚æ­£æ˜¯ data.bin æ–‡ä»¶ï¼Œæœ€ç»ˆæ‰¿è½½ç€ç‰©ç†å­˜å‚¨ã€‚é‚£ä¹ˆæŒ‰åˆ—å­˜å‚¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿé¦–å…ˆå¯ä»¥æ›´å¥½çš„è¿›è¡Œæ•°æ®å‹ç¼©ï¼Œå› ä¸ºç›¸åŒç±»å‹çš„æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œå¯¹å‹ç¼©æ›´åŠ å‹å¥½ï¼›å…¶å®æ˜¯èƒ½å¤Ÿæœ€å°åŒ–æ•°æ®æ‰«æçš„èŒƒå›´ã€‚</strong></p>
<p><strong>è€Œå¯¹åº”åˆ°å­˜å‚¨çš„å…·ä½“å®ç°æ–¹é¢ï¼ŒMergeTree ä¹Ÿå¹¶ä¸æ˜¯ä¸€è‚¡è„‘åœ°å°†æ•°æ®ç›´æ¥å†™å…¥ data.bin æ–‡ä»¶ï¼Œè€Œæ˜¯ç»è¿‡äº†ä¸€ç•ªç²¾å¿ƒè®¾è®¡ï¼šé¦–å…ˆæ•°æ®æ˜¯ç»è¿‡å‹ç¼©çš„ï¼Œç›®å‰æ”¯æŒ LZ4ã€ZSTDã€Multiple å’Œ Delta å‡ ç§ç®—æ³•ï¼Œé»˜è®¤ä½¿ç”¨ LZ4 ç®—æ³•ï¼›å…¶æ¬¡ï¼Œæ•°æ®ä¼šå®ç°æŒ‰ç…§ ORDER BY çš„å£°æ˜æ’åºï¼›æœ€åæ•°æ®ä»¥å‹ç¼©æ•°æ®å—çš„å½¢å¼è¢«ç»„ç»‡å¹¶å†™å…¥ data.bin æ–‡ä»¶ã€‚</strong></p>
<p><strong>å‹ç¼©æ•°æ®å—å°±å¥½æ¯”ä¸€æœ¬ä¹¦çš„æ–‡ä»¶æ®µè½ï¼Œæ˜¯ç»„ç»‡æ–‡å­—çš„åŸºæœ¬å•å…ƒï¼Œè¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œéœ€è¦æ·±å…¥è¯´æ˜ä¸€ä¸‹ã€‚</strong></p>
<h3 id="å‹ç¼©æ•°æ®å—"><a href="#å‹ç¼©æ•°æ®å—" class="headerlink" title="å‹ç¼©æ•°æ®å—"></a>å‹ç¼©æ•°æ®å—</h3><p><strong>ä¸€ä¸ªå‹ç¼©æ•°æ®å—ç”±å¤´ä¿¡æ¯å’Œå‹ç¼©æ•°æ®ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå¤´ä¿¡æ¯å›ºå®šä½¿ç”¨ 9 ä½å­—èŠ‚è¡¨ç¤ºï¼Œå…·ä½“ç”± 1 ä¸ª UInt8ï¼ˆ1 å­—èŠ‚ï¼‰å’Œ 2 ä¸ª UInt32ï¼ˆ4 å­—èŠ‚ï¼‰ç»„æˆï¼Œåˆ†åˆ«ä»£è¡¨ä½¿ç”¨çš„å‹ç¼©ç®—æ³•ç±»å‹ã€å‹ç¼©åçš„æ•°æ®å¤§å°ã€å‹ç¼©å‰çš„æ•°æ®å¤§å°ã€‚æ‰€ä»¥è™½ç„¶å­˜å‚¨çš„æ˜¯å‹ç¼©åçš„æ•°æ®ï¼Œä½†æ˜¯åœ¨å¤´ä¿¡æ¯ä¸­å°†å‹ç¼©å‰çš„æ•°æ®å¤§å°ä¹Ÿè®°å½•äº†ä¸‹æ¥ã€‚æˆ‘ä»¬å…ˆåˆ›å»ºä¸€å¼ è¡¨ï¼Œç„¶åå†™å…¥ä¸€äº›æ•°æ®æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121540506-1382470710.png" alt="img"></p>
<p><strong>ç„¶åç”¨ Python å†™å…¥å†™å…¥ 10 ä¸‡æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"><span class="keyword">from</span> clickhouse_driver <span class="keyword">import</span> Client</span><br><span class="line"></span><br><span class="line">f = Faker(<span class="string">&quot;ja_JP&quot;</span>)  <span class="comment"># ç”Ÿæˆ 1 ä¸‡æ¡æµ‹è¯•æ•°æ®ï¼ŒAge å‡ä¸º 26</span></span><br><span class="line">data = [<span class="built_in">str</span>((<span class="string">f&quot;<span class="subst">&#123;i&#125;</span>&quot;</span>, f.name(), <span class="number">26</span>, f.address())) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line"></span><br><span class="line">sql = <span class="string">f&quot;INSERT INTO people VALUES <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(data)&#125;</span>&quot;</span></span><br><span class="line">client = Client(host=<span class="string">&quot;47.94.174.89&quot;</span>, port=<span class="number">9000</span>)</span><br><span class="line">client.execute(sql)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶ä¼šåˆ›å»ºä¸€ä¸ªåˆ†åŒºï¼Œæ ¹æ®æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„è§„åˆ™ï¼Œåˆ†åŒºå¯¹åº”çš„åˆ†åŒºç›®å½•ä¸º 26_1_1_0ã€‚ä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œè¦ä½¿ç”¨ 1 ä¸ª INSERT è¯­å¥ï¼Œå¦åˆ™çš„è¯æ•°æ®ä¼šåˆ†å¤šæ‰¹å¯¼å…¥ï¼Œè¿™æ ·çš„å°±ä¼šåˆ›å»ºå¤šä¸ªåˆ†åŒºç›®å½•ï¼š26_1_1_0ã€26_2_2_0ã€26_3_3_0ï¼Œâ€¦â€¦ã€‚è€Œæˆ‘ä»¬è¦çš„æ˜¯åˆå¹¶åçš„ç»“æœï¼Œè™½ç„¶å±äºç›¸åŒåˆ†åŒºçš„åˆ†åŒºç›®å½•ä¹‹åä¼šè‡ªåŠ¨åˆå¹¶ï¼Œä½†æ˜¯éœ€è¦ç­‰ä¸€æ®µæ—¶é—´ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å°±ä¸€æ‰¹æ¬¡ç›´æ¥å¯¼å…¥ã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ clickhouse-compressor æŸ¥çœ‹æ•°æ®å¤§å°ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121548304-1172775367.png" alt="img"></p>
<p><strong>å…¶ä¸­æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªæ•°æ®å‹ç¼©å—çš„å¤´ä¿¡æ¯ï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥å‹ç¼©å—ä¸­ â€œå‹ç¼©å‰çš„æ•°æ®å¤§å°â€ å’Œ â€œå‹ç¼©åçš„æ•°æ®å¤§å°â€ï¼Œå¹¶ä¸”æˆ‘ä»¬çœ‹åˆ°æ€»å…±æœ‰ 4 ä¸ªå‹ç¼©æ•°æ®å—ã€‚ä¸ºä»€ä¹ˆæœ‰ 4 ä¸ªï¼ŒåŸå› æ˜¯æˆ‘ä»¬åªæœ‰ 4 ä¸ªåˆ—ï¼Œæ‰€ä»¥ data.bin é‡Œé¢å­˜å‚¨çš„å°±æ˜¯å¯¹ 4 ä¸ªåˆ—å‹ç¼©ä¹‹åçš„ç»“æœï¼Œè¿™æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚åƒç¬¬ä¸€åˆ—å°±æ˜¯ IDï¼Œç”±äºæˆ‘ä»¬çš„ ID æ˜¯é¡ºåºè‡ªå¢çš„ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆé‡å¤ï¼Œæ‰€ä»¥å‹ç¼©ä¹‹åå’Œå‹ç¼©ä¹‹å‰çš„çš„å¤§å°å·®åˆ«ä¸å¤§ï¼›ä½†æ˜¯åé¢å‡ åˆ—çš„æ•°æ®å‹ç¼©ä¹‹åå°±å°å¾ˆå¤šäº†ï¼Œå°¤å…¶æ˜¯ç¬¬ä¸‰è¡Œ Age å­—æ®µï¼Œå› ä¸ºæ¯ä¸ªå€¼éƒ½æ˜¯ä¸€ä¸ª UInt8ï¼Œ1 ä¸‡æ¡æ•°æ®æ‰€ä»¥å  10000 ä¸ªå­—èŠ‚ï¼Œä½†ç”±äºæ‰€æœ‰å€¼éƒ½æ˜¯ 26ï¼Œæ•°æ®å…¨éƒ¨ä¸€æ ·ï¼Œè€Œæ•°æ®è¶Šç›¸ä¼¼å‹ç¼©æ¯”è¶Šé«˜ï¼Œå› æ­¤å‹ç¼©ä¹‹åå˜æˆäº† 59 ä¸ªå­—èŠ‚ã€‚è‡³äºå‹ç¼©èƒŒåçš„ç®—æ³•æˆ‘ä»¬è¿™é‡Œä¸ç»†ç©¶äº†ï¼Œ åªéœ€è¦çŸ¥é“æ•°æ®ä¹‹é—´è¶Šç›¸ä¼¼ã€æˆ–è€…è¯´é‡å¤ç‡è¶Šé«˜ï¼Œå‹ç¼©ä¹‹åçš„æ•°æ®å°±è¶Šå°ã€‚</strong></p>
<p><strong>ä½†æ˜¯æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œçš„æ•°æ®é‡æ¯”è¾ƒå°‘ï¼Œæ¯ä¸€åˆ—æ•°æ®çš„å¤§å°ä¸æ˜¯å¾ˆå¤§ï¼Œå› æ­¤æ¯ä¸€åˆ—åªç”¨ä¸€ä¸ªå‹ç¼©æ•°æ®å—å³å¯å­˜å‚¨ã€‚å¦‚æœæ•°æ®é‡å†å¤šä¸€äº›ï¼Œä¸€ä¸ªå‹ç¼©æ•°æ®å—å­˜å‚¨ä¸ä¸‹ï¼Œé‚£ä¹ˆå°±ä¼šå¯¹åº”å¤šä¸ªå‹ç¼©æ•°æ®å—ã€‚</strong></p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">Column1 å‹ç¼©æ•°æ®å—<span class="number">0</span></span><br><span class="line">Column2 å‹ç¼©æ•°æ®å—<span class="number">0</span></span><br><span class="line">Column3 å‹ç¼©æ•°æ®å—<span class="number">0</span></span><br><span class="line">......</span><br><span class="line">ColumnN å‹ç¼©æ•°æ®å—<span class="number">0</span></span><br><span class="line"></span><br><span class="line">Column1 å‹ç¼©æ•°æ®å—<span class="number">1</span></span><br><span class="line">Column2 å‹ç¼©æ•°æ®å—<span class="number">1</span></span><br><span class="line">Column3 å‹ç¼©æ•°æ®å—<span class="number">1</span></span><br><span class="line">......</span><br><span class="line">ColumnN å‹ç¼©æ•°æ®å—<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Column1 å‹ç¼©æ•°æ®å—<span class="number">2</span></span><br><span class="line">Column2 å‹ç¼©æ•°æ®å—<span class="number">2</span></span><br><span class="line">Column3 å‹ç¼©æ•°æ®å—<span class="number">2</span></span><br><span class="line">......</span><br><span class="line">ColumnN å‹ç¼©æ•°æ®å—<span class="number">2</span></span><br><span class="line"></span><br><span class="line">Column1 å‹ç¼©æ•°æ®å—<span class="number">3</span></span><br><span class="line">Column2 å‹ç¼©æ•°æ®å—<span class="number">3</span></span><br><span class="line">Column3 å‹ç¼©æ•°æ®å—<span class="number">3</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121555649-1327243137.png" alt="img"></p>
<p><strong>å…¶ä¸­æ¯ä¸€è¡Œæ•°æ®éƒ½ä»£è¡¨è€…ä¸€ä¸ªå‹ç¼©æ•°æ®å—çš„å¤´ä¿¡æ¯ï¼Œå…¶åˆ†åˆ«è¡¨ç¤ºè¯¥å‹ç¼©å—ä¸­æœªå‹ç¼©æ•°æ®å’Œå‹ç¼©æ•°æ®çš„å¤§å°ï¼Œæ³¨æ„ï¼šæ‰“å°ä¿¡æ¯å’Œç‰©ç†å­˜å‚¨çš„é¡ºåºåˆšå¥½ç›¸åã€‚</strong></p>
<p><strong>ä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œä¹‹å‰æˆ‘ä»¬è¯´åœ¨æ—©æœŸçš„ ClickHouse ä¸­æ¯ä¸€åˆ—æ•°æ®å„è‡ªå¯¹åº”ä¸€ä¸ª .bin æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬çš„æ—¶å€™åˆå¹¶åœ¨ä¸€èµ·äº†ï¼Œè¿™æ˜¯æ²¡é”™çš„ï¼Œä½†å‰ææ˜¯æ•°æ®é‡ä¸å¤§ã€‚å¦‚æœæ•°æ®é‡å¤§åˆ°ä¸€å®šç¨‹åº¦ï¼Œé‚£ä¹ˆæ¯ä¸€åˆ—çš„æ•°æ®å°±ä¼šåˆ†å¼€å­˜å‚¨äº†ï¼Œä¹Ÿå°±æ˜¯å„è‡ªå¯¹åº”ä¸€ä¸ª .bin æ–‡ä»¶å’Œä¸€ä¸ª .mrk æ–‡ä»¶ï¼Œå’Œ data.binã€data.mrk çš„ä½œç”¨æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼Œ åªä¸è¿‡ä¸€ä¸ªæ˜¯å„åˆ—åˆ†å¼€å­˜å‚¨ã€ä¸€ä¸ªæ˜¯æ‰€æœ‰åˆ—åˆå¹¶åœ¨ä¸€èµ·å­˜å‚¨ã€‚</strong></p>
<p><strong>æˆ‘ä»¬å†æ‰§è¡Œä¸€æ¬¡ä¸Šé¢çš„ Python ä»£ç ï¼Œä½†æ˜¯å°†ç”Ÿæˆçš„æ•°æ®æ”¹æˆ 10 ä¸‡æ¡ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121602882-2030388856.png" alt="img"></p>
<p><strong>æ˜¾ç„¶æ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª 26_2_2_0 åˆ†åŒºç›®å½•ï¼Œé‡Œé¢å°±æ²¡æœ‰ data.bin äº†ï¼Œå–è€Œä»£ä¹‹çš„æ—¶å€™ ID.binã€Name.binã€Age.binã€Place.binï¼ŒåŒç† .mrk æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å½“ç„¶é™¤äº† .mrk ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ª .mrk2ï¼Œå®ƒå’Œ .mrk3 ä½œç”¨ç›¸ä¼¼ï¼Œå½“ä½¿ç”¨äº†è‡ªé€‚åº”å¤§å°çš„ç´¢å¼•é—´éš”ï¼Œä¼šå‡ºç°æ­¤æ ‡è®°æ–‡ä»¶ã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬å†æ¥å¯¹æ¯ä¸€ä¸ªåˆ—å¯¹åº”çš„ .bin æ–‡ä»¶æŸ¥çœ‹ä¸€ä¸‹å¤§å°ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121611426-1900498698.png" alt="img"></p>
<p><strong>å¦‚æœæ¯ä¸€åˆ—éƒ½å¯¹åº”å•ç‹¬çš„ .bin æ–‡ä»¶çš„è¯ï¼Œé‚£ä¹ˆæ¯ä¸€åˆ—éƒ½æœ‰è‡ªå·±çš„å‹ç¼©æ•°æ®å—ï¼šå— 0ã€å—1ã€å—2ã€â€¦â€¦ã€å— nï¼Œè¿™å’Œ data.bin åŸç†ç›¸åŒï¼Œåªä¸è¿‡ data.bin åœ¨æ•°æ®é‡æ²¡è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™ä¼šå°†æ‰€æœ‰åˆ—å¯¹åº”çš„å‹ç¼©æ•°æ®å—å­˜å‚¨åœ¨ä¸€èµ·ï¼šåˆ— 1 å— 0ã€åˆ— 2 å— 0ã€â€¦.ã€åˆ— N å— 0ã€åˆ— 1 å— 1ã€åˆ— 2 å— 1ã€â€¦â€¦ã€åˆ— N å— 1ã€åˆ— 1 å— 2ã€åˆ— 2 å— 2ã€â€¦â€¦ã€åˆ— N å— 2ã€åˆ— 1 å— 3ã€â€¦â€¦.ã€‚</strong></p>
<p><strong>å¹¶ä¸”æ­¤æ—¶æ¯ä¸ªå‹ç¼©æ•°æ®å—çš„å¤§å°ï¼Œéƒ½è¢«ä¸¥æ ¼æ§åˆ¶åœ¨ 64KB åˆ° 1MB ä¹‹é—´ï¼Œå…¶ä¸Šä¸‹é™åˆ†åˆ«ç”± min_compress_block_sizeï¼ˆé»˜è®¤ 65536ï¼‰å’Œ min_compress_block_sizeï¼ˆé»˜è®¤å€¼ä¸º 1048576ï¼‰å†³å®šã€‚æ¯”å¦‚ Age.binï¼Œå› ä¸º 10 ä¸‡æ¡æ•°æ®æ‰€ä»¥ 10 ä¸‡ä¸ªå­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå‹ç¼©æ•°æ®å—çš„å¤§å°å°±æ˜¯ 65536 å­—èŠ‚ï¼Œè¢«å‹ç¼©æˆäº† 276 å­—èŠ‚ï¼Œè‡³äºå‰©ä½™çš„ 34464 å­—èŠ‚æ˜¯å› ä¸ºåªå‰©ä¸‹è¿™ä¹ˆå¤šäº†ï¼Œç„¶åè¢«å‹ç¼©æˆäº† 155 å­—èŠ‚ã€‚è‡³äºå…¶å®ƒçš„åˆ—ä¹Ÿæ˜¯åŒç†ï¼Œåªä¸è¿‡åˆ—ä¸ç›¸åŒï¼Œæ‰€ä»¥å‹ç¼©æ•°æ®å—çš„æœ€ç»ˆå¤§å°ä¹Ÿä¸ç›¸åŒã€‚</strong></p>
<p><strong>é‚£ä¹ˆå‹ç¼©æ•°æ®å—çš„å¤§å°æ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„å‘¢ï¼Ÿé¦–å…ˆå‹ç¼©æ•°æ®å—çš„æœ€ç»ˆå¤§å°æ˜¯å’Œç´¢å¼•ç²’åº¦ï¼ˆindex_granularityï¼‰ç›¸å…³çš„ï¼ŒMergeTree åœ¨å…·ä½“çš„æ•°æ®å†™å…¥è¿‡ç¨‹ä¸­ï¼Œä¼šä¾ç…§ç´¢å¼•ç²’åº¦æŒ‰æ‰¹æ¬¡è·å–æ•°æ®å¹¶å†™å…¥ï¼ˆç”±äºç´¢å¼•ç²’åº¦é»˜è®¤æ˜¯ 8192ï¼Œæ‰€ä»¥æ¯æ‰¹æ¬¡ä¼šè·å– 8192 è¡Œï¼‰ã€‚å¦‚æœæŠŠä¸€æ‰¹æœªå‹ç¼©çš„æ•°æ®çš„å¤§å°è®¾ä¸º sizeï¼Œåˆ™æ•´ä¸ªæ•°æ®çš„å†™å…¥è¿‡ç¨‹éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š</strong></p>
<ul>
<li><strong>1ï¼‰å•ä¸ªæ‰¹æ¬¡æ•°æ® size &lt; 64KBï¼šå¦‚æœå•ä¸ªæ‰¹æ¬¡æ•°æ®å°äº 64KBï¼Œåˆ™ç»§ç»­è·å–ä¸‹ä¸€æ‰¹æ•°æ®ï¼Œç›´è‡³ç´¯ç§¯åˆ° size å¤§äºç­‰äº 64KB æ—¶ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªå‹ç¼©æ•°æ®å—ã€‚</strong></li>
<li><strong>2ï¼‰å•ä¸ªæ‰¹æ¬¡æ•°æ® 64KB &lt;&#x3D; size &lt;&#x3D; 1MBï¼šå¦‚æœå•ä¸ªæ‰¹æ¬¡æ•°æ®åœ¨ 64KB åˆ° 1MB ä¹‹é—´ï¼Œåˆ™ç›´æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªå‹ç¼©æ•°æ®å—ã€‚</strong></li>
<li><strong>3ï¼‰å•ä¸ªæ‰¹æ¬¡æ•°æ® size &gt; 1MBï¼šå¦‚æœå•ä¸ªæ‰¹æ¬¡æ•°æ®ç›´æ¥è¶…è¿‡ 1MBï¼Œåˆ™é¦–å…ˆæŒ‰ç…§ 1MB å¤§å°æˆªæ–­å¹¶ç”Ÿæˆä¸‹ä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œç„¶åå‰©ä½™æ•°æ®ç»§ç»­ä¾ç…§ä¸Šè¿°è§„åˆ™æ‰§è¡Œã€‚å› æ­¤ï¼Œæ­¤æ—¶ä¼šå‡ºç°ä¸€æ‰¹æ¬¡æ•°æ®ç”Ÿæˆå¤šä¸ªå‹ç¼©æ•°æ®å—çš„æƒ…å†µã€‚</strong></li>
</ul>
<p><strong>å› æ­¤è¯´ç™½äº†å°±æ˜¯ MergeTree åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šä¾ç…§ç´¢å¼•ç²’åº¦æŒ‰æ‰¹æ¬¡è·å–æ•°æ®ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯æ¯æ‰¹è·å– 8192 è¡Œï¼Œç„¶åä¸€æ‰¹ä¸€æ‰¹è·å–ã€‚è€Œå¦‚æœè®¾å½“å‰æ‰¹æ¬¡çš„æ•°æ®å¤§å°ä¸º sizeï¼Œé‚£ä¹ˆä¼šæ ¹æ® size çš„ä¸åŒï¼Œèµ°ä¸Šé¢ä¸‰ä¸ªåˆ†æ”¯ä¸­çš„ä¸€ä¸ªã€‚æˆ‘ä»¬ä»¥ Age.bin ä¸ºä¾‹ï¼Œæ¯æ‰¹å– 8912 è¡Œæ˜¾ç„¶å°±æ˜¯ 8192 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 8 KBï¼Œå°äº 64 KBï¼Œå› æ­¤ä¼šè¯»å–ä¸‹ä¸€æ‰¹ã€‚è€Œå½“è¯»åˆ°ç¬¬ 8 æ‰¹æ—¶ï¼Œå‘ç°æ•°æ®åŠ èµ·æ¥è¾¾åˆ°äº† 64 KBï¼Œå› æ­¤ç”Ÿæˆä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œæ­¤æ—¶è¿˜å‰©ä¸‹ 34464ï¼ˆ100000 å‡å» 8 * 8192ï¼‰ã€ä¸åˆ° 34 KBï¼Œå› æ­¤å‰©ä½™çš„éƒ¨åˆ†ç›´æ¥ä½œä¸ºä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼›å½“ç„¶å…¶å®ƒåˆ—ä¹Ÿå¾ˆå¥½åˆ†æï¼Œå’Œ Age æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ Age æœ€ç®€å•ï¼Œæ¯ä¸ªå€¼å  1 å­—èŠ‚ã€‚è€Œå…¶å®ƒåˆ—å› ä¸ºå­˜å‚¨çš„å†…å®¹å¤§å°ä¸å›ºå®šï¼ˆæœ‰çš„é•¿æœ‰çš„çŸ­ï¼‰ï¼Œæ‰€ä»¥ä¸æ˜¯å¾ˆå¥½è®¡ç®—ï¼Œä½†å­˜å‚¨çš„é€»è¾‘æ˜¯ä¸å˜çš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121621814-262052550.png" alt="img"></p>
<p><strong>å› æ­¤ä¸€ä¸ª .bin æ–‡ä»¶æ˜¯ç”± 1 åˆ°å¤šä¸ªå‹ç¼©æ•°æ®å—ç»„æˆçš„ï¼Œæ¯ä¸ªå‹ç¼©å—çš„å¤§å°æ˜¯ 64KB ~ 1MB ä¹‹é—´ï¼Œå¤šä¸ªæ•°æ®å‹ç¼©å—ä¹‹é—´æŒ‰ç…§å†™å…¥é¡ºåºé¦–å°¾ç›¸æ¥ï¼Œç´§å¯†åœ°æ’åœ¨ä¸€èµ·ã€‚</strong></p>
<p><strong>è€Œåœ¨ .bin æ–‡ä»¶ä¸­å¼•å…¥å‹ç¼©æ•°æ®å—çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼š</strong></p>
<ul>
<li><code>1. è™½ç„¶æ•°æ®è¢«å‹ç¼©åèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘æ•°æ®å¤§å°ï¼Œé™ä½å­˜å‚¨ç©ºé—´å¹¶åŠ é€Ÿä¼ è¾“æ•ˆç‡ï¼Œä½†æ•°æ®çš„å‹ç¼©å’Œè§£å‹ç¼©æœ¬èº«æ˜¯ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—çš„ã€‚æ‰€ä»¥è¦æ§åˆ¶è¢«å‹ç¼©æ•°æ®çš„å¤§å°ï¼Œä»¥ä¾¿åœ¨æ€§èƒ½æŸè€—å’Œå‹ç¼©ç‡ä¹‹é—´å¯»æ±‚ä¸€ç§å¹³è¡¡</code></li>
<li><code>2. åœ¨å…·ä½“è¯»å–æŸä¸€åˆ—æ•°æ®æ—¶ï¼ˆ.bin æ–‡ä»¶ï¼‰ï¼Œé¦–å…ˆéœ€è¦å°†å‹ç¼©æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­å¹¶è§£å‹ï¼Œè¿™æ ·æ‰èƒ½è¿›è¡Œåç»­çš„æ•°æ®å¤„ç†ã€‚è€Œé€šè¿‡æ•°æ®å‹ç¼©å—ï¼Œå¯ä»¥åœ¨ä¸è¯»å–æ•´ä¸ª .bin æ–‡ä»¶çš„æƒ…å†µä¸‹å°†è¯»å–ç²’åº¦é™ä½åˆ°å‹ç¼©æ•°æ®å—çº§åˆ«ï¼Œä»è€Œè¿›ä¸€æ­¥ç¼©å°æ•°æ®è¯»å–èŒƒå›´</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121629063-1970946671.png" alt="img"></p>
<p><strong>æ‰€ä»¥å‹ç¼©æ•°æ®å—æ˜¯é‡ç‚¹ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯æŒ‰å—å†™å…¥ã€åŒæ—¶ä¹Ÿä¼šæŒ‰å—è¯»å–ã€‚å¦å¤–å½“æ•°æ®é‡æ²¡æœ‰è¶…è¿‡é˜ˆå€¼çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„åˆ—ä¼šæ”¾åœ¨ä¸€èµ·å­˜å‚¨ï¼ˆdata.binï¼‰ï¼Œæ•°æ®é‡è¶…è¿‡é˜ˆå€¼ã€é‚£ä¹ˆæ¯ä¸€åˆ—ä¼šå•ç‹¬å­˜å‚¨ã€‚</strong></p>
<h2 id="æ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ-mrkï¼‰"><a href="#æ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ-mrkï¼‰" class="headerlink" title="æ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ.mrkï¼‰"></a>æ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ.mrkï¼‰</h2><p><strong>å¦‚æœæŠŠ MergeTree æ¯”ä½œä¸€æœ¬ä¹¦ï¼Œprimary.idxï¼ˆä¸€çº§ç´¢å¼•ï¼‰å°±ç±»ä¼¼ä¹¦çš„ä¸€çº§ç« èŠ‚ç›®å½•ï¼Œä½†æ˜¯è¿™ä¸ªç›®å½•å…·ä½“å¯¹åº”ä¹¦ä¸­ï¼ˆ .bin æ–‡ä»¶ï¼‰çš„å“ªä¸€é¡µå‘¢ï¼Ÿ</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121636786-372556394.png" alt="img"></p>
<p><strong>æ˜¾ç„¶æ¯ä¸ªç›®å½•åé¢çš„é¡µç ä¼šå‘Šè¯‰ä½ ï¼Œè¯¥ç›®å½•ä½äºä¹¦ä¸­çš„å“ªä¸€é¡µï¼Œè€Œé¡µç å°±ç›¸å½“äºæ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ.mrkï¼‰ä¸­è®°å½•çš„åç§»é‡ï¼ˆæ•°æ®æ ‡è®°ï¼‰ï¼Œæ ‡è®°ç´¢å¼•åœ¨æ•°æ®æ–‡ä»¶ä¸­çš„å…·ä½“ä½ç½®ã€‚å› æ­¤å¯¹äºæ•°æ®æ ‡è®°æ–‡ä»¶è€Œè¨€ï¼Œå®ƒè®°å½•äº†ä¸¤ç‚¹å…³é”®ä¿¡æ¯ï¼š</strong></p>
<ul>
<li><code>1. ä¸ä¸€çº§ç« èŠ‚ç›®å½•å¯¹åº”çš„é¡µç ä¿¡æ¯</code></li>
<li><code>2. ä¸€æ®µæ–‡å­—åœ¨æŸä¸€é¡µä¸­çš„èµ·å§‹ä½ç½®ä¿¡æ¯</code></li>
</ul>
<p><strong>è¿™æ ·ä¸€æ¥ï¼Œé€šè¿‡æ•°æ®æ ‡è®°æ–‡ä»¶å¯ä»¥å¾ˆå¿«åœ°ä»ä¸€æœ¬ä¹¦ä¸­ç«‹å³ç¿»åˆ°å…³æ³¨å†…å®¹æ‰€åœ¨çš„é‚£ä¸€é¡µï¼Œå¹¶çŸ¥é“ä»ç¬¬å‡ è¡Œå¼€å§‹é˜…è¯»ã€‚</strong></p>
<h3 id="æ•°æ®æ ‡è®°çš„ç”Ÿæˆè§„åˆ™"><a href="#æ•°æ®æ ‡è®°çš„ç”Ÿæˆè§„åˆ™" class="headerlink" title="æ•°æ®æ ‡è®°çš„ç”Ÿæˆè§„åˆ™"></a>æ•°æ®æ ‡è®°çš„ç”Ÿæˆè§„åˆ™</h3><p><strong>æ•°æ®æ ‡è®°ä½œä¸ºè¡”æ¥ä¸€çº§ç´¢å¼•å’Œæ•°æ®çš„æ¡¥æ¢ï¼Œåƒæäº†ä¹¦ç­¾ï¼Œè€Œä¸”ä¹¦æœ¬æ€»æ¯ä¸€ä¸ªç« èŠ‚ç›®å½•éƒ½æœ‰å„è‡ªçš„ä¹¦ç­¾ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121645106-1424401301.png" alt="img"></p>
<p><strong>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®æ ‡è®°å’Œç´¢å¼•åŒºé—´æ˜¯å¯¹é½çš„ï¼Œå‡æŒ‰ç…§ index_granularity çš„ç²’åº¦é—´éš”ï¼Œå¦‚æ­¤ä¸€æ¥åªéœ€è¦ç®€å•é€šè¿‡ç´¢å¼•ä¸‹æ ‡ç¼–å·å³å¯ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„æ•°æ®æ ‡è®°ã€‚å¹¶ä¸”ä¸ºäº†èƒ½å¤Ÿä¸æ•°æ®è¡”æ¥ï¼Œ.bin æ–‡ä»¶å’Œæ•°æ®æ ‡è®°æ–‡ä»¶æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå³æ¯ä¸€ä¸ª [Column].bin æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª [Column].mrk æ•°æ®æ ‡è®°æ–‡ä»¶ä¸ä¹‹å¯¹åº”ï¼Œç”¨äºè®°å½•æ•°æ®åœ¨ .bin æ–‡ä»¶ä¸­çš„åç§»é‡ä¿¡æ¯ã€‚</strong></p>
<p><strong>ä¸€è¡Œæ ‡è®°æ•°æ®ä½¿ç”¨ä¸€ä¸ªå…ƒç»„è¡¨ç¤ºï¼Œå…ƒç»„å†…åŒ…å«ä¸¤ä¸ªæ•´å‹æ•°å€¼çš„åç§»é‡ä¿¡æ¯ï¼Œåˆ†åˆ«è¡¨ç¤ºåœ¨æ­¤æ®µæ•°æ®åŒºé—´å†…ï¼š</strong></p>
<ul>
<li><code>1. å¯¹åº” .bin å‹ç¼©æ–‡ä»¶ä¸­ï¼Œå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡</code></li>
<li><code>2. å°†è¯¥æ•°æ®å—è§£å‹ç¼©åï¼Œæœªå‹ç¼©æ•°æ®çš„èµ·å§‹åç§»é‡</code></li>
</ul>
<p><strong>æˆ‘ä»¬ä»¥ä¹‹å‰ Age.bin ä¸ºä¾‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121652461-11019192.png" alt="img"></p>
<p><strong>æ¯æ¬¡æŒ‰æ‰¹è¯»å– 8192 è¡Œï¼Œå› ä¸ºä¸€ä¸ª UInt 8 ä¸€å­—èŠ‚ï¼Œæ‰€ä»¥æ¯æ¬¡è¯»å– 8192 ä¸ªå­—èŠ‚ï¼Œåœ¨è¯»å– 8 æ‰¹ä¹‹åä¼šè¿›è¡Œå‹ç¼©å¾—åˆ°ä¸€ä¸ªå‹ç¼©æ•°æ®å—ã€‚ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªå‹ç¼©æ•°æ®å—ä¸º 276 ä¸ªå­—èŠ‚ï¼Œç„¶åæœªå‹ç¼©æ•°æ®è¿˜å‰©ä¸‹ 34464 å­—èŠ‚ï¼Œå°äº 64KBï¼Œäºæ˜¯ç›´æ¥ç”Ÿæˆ 155 å­—èŠ‚çš„ç¬¬äºŒä¸ªå‹ç¼©æ•°æ®å—ã€‚å› æ­¤åœ¨ Age.bin ä¸­ä¸¤ä¸ªåç§»é‡çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121657840-402377603.png" alt="img"></p>
<p><strong>æ¯ä¸€è¡Œæ ‡è®°æ•°æ®éƒ½æ ‡è®°äº†ä¸€ä¸ªç‰‡æ®µçš„æ•°æ®ï¼ˆé»˜è®¤ 8192 è¡Œï¼‰åœ¨ .bin å‹ç¼©æ–‡ä»¶ä¸­çš„è¯»å–ä½ç½®ä¿¡æ¯ï¼Œå› ä¸º Age å  1 å­—èŠ‚ï¼Œæ‰€ä»¥æ¯æ¬¡è¯»å– 8912 è¡Œç›¸å½“äºæ¯æ¬¡è¯»å– 8192 ä¸ªå­—èŠ‚ï¼Œå› æ­¤ â€œæœªå‹ç¼©æ•°æ®çš„èµ·å§‹åç§»é‡â€ å°±æ˜¯ 0ã€8192ã€16384ã€24576ã€â€¦â€¦ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„å›¾ä¸­çš„ 57344ï¼Œå®ƒè¡¨ç¤ºç¬¬ 8 æ‰¹æœªå‹ç¼©æ•°æ®çš„èµ·å§‹åç§»é‡ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»è¾¾åˆ°äº† 64KBï¼Œæ‰€ä»¥ä¼šç”Ÿæˆä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œäºæ˜¯æ¥ä¸‹æ¥è¯»å–ç¬¬ 9 æ‰¹æœªå‹ç¼©æ•°æ®çš„æ—¶å€™å°±ä¼šå¯¹åº”æ–°çš„å‹ç¼©æ•°æ®å—ï¼Œå› æ­¤èµ·å§‹åç§»é‡ä¼šé‡ç½®ä¸º 0ï¼Œè€Œä¸æ˜¯ 65536ã€‚</strong></p>
<blockquote>
<p><strong>æˆ‘ä»¬è¿™é‡Œæ˜¯ Age å­—æ®µä¸ºä¾‹ï¼Œè‡³äºå…¶å®ƒåˆ—ä¹Ÿæ˜¯åŒç†ï¼Œåªä¸è¿‡ç”±äºæ¯ä¸€è¡Œå­—ç¬¦ä¸²çš„é•¿åº¦ä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾è®¡ç®—æ¯æ¬¡è¯» 8192 è¡Œçš„è¯ä¼šè¯»å¤šå°‘ä¸ªå­—èŠ‚ï¼Œä½†å®ƒä»¬çš„åŸç†æ˜¯å¾ˆæ˜æ˜¾éƒ½æ˜¯ä¸€æ ·çš„ã€‚</strong></p>
</blockquote>
<p><strong>ç„¶åæ˜¯ â€œå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡â€ï¼Œå› ä¸ºè¯»äº† 8 æ‰¹æ‰ç”Ÿæˆäº†ç¬¬ä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œå› æ­¤å‰ 8 è¡Œéƒ½æ˜¯ 0ã€‚ç„¶åç”±äºç¬¬ä¸€ä¸ªå‹ç¼©æ•°æ®å—çš„å¤§å°æ˜¯ 276ï¼Œå› æ­¤ç¬¬ 9 è¡Œã€å³ç´¢å¼•ä¸º 8 çš„ä½ç½®ï¼Œå­˜å‚¨çš„å€¼å°±æ˜¯ 276ï¼Œè¡¨ç¤ºç¬¬äºŒä¸ªå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯æ ‡è®°æ–‡ä»¶çš„å­˜å‚¨åŸç†ï¼Œä½†æ˜¯æ ‡è®°æ–‡ä»¶å’Œä¸€çº§ç´¢å¼•ä¸åŒï¼Œå®ƒä¸èƒ½å¸¸é©»å†…å­˜ï¼Œè€Œæ˜¯ä½¿ç”¨ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç¼“å­˜æ·˜æ±°ç­–ç•¥åŠ å¿«å…¶å–ç”¨é€Ÿåº¦ã€‚</strong></p>
<h3 id="æ•°æ®æ ‡è®°çš„å·¥ä½œæ–¹å¼"><a href="#æ•°æ®æ ‡è®°çš„å·¥ä½œæ–¹å¼" class="headerlink" title="æ•°æ®æ ‡è®°çš„å·¥ä½œæ–¹å¼"></a>æ•°æ®æ ‡è®°çš„å·¥ä½œæ–¹å¼</h3><p><strong>MergeTree åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¿…é¡»é€šè¿‡æ ‡è®°æ–‡ä»¶ä¸­çš„åç§»é‡æ‰èƒ½æ‰¾åˆ°æ‰€éœ€è¦çš„æ•°æ®ï¼Œå› æ­¤æ•´ä¸ªæŸ¥æ‰¾è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºè¯»å–å‹ç¼©æ•°æ®å—å’Œè¯»å–æ•°æ®ä¸¤ä¸ªæ­¥éª¤ã€‚ä¸ºäº†ä¾¿äºè§£é‡Šï¼Œè¿™é‡Œç»§ç»­ä½¿ç”¨åˆšæ‰çš„ people è¡¨çš„ Age å­—æ®µè¿›è¡Œè¯´æ˜ï¼Œå› ä¸º Age å­—æ®µçš„å¤§å°å›ºå®šï¼Œæœ€å¥½åˆ†æï¼Œè‡³äºå…¶å®ƒå­—æ®µçš„æŸ¥æ‰¾è¿‡ç¨‹ä¸ä¹‹å®Œå…¨ç±»ä¼¼ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121710168-599041568.png" alt="img"></p>
<p><strong>1ï¼‰è¯»å–å‹ç¼©æ•°æ®å—</strong></p>
<p><strong>åœ¨æŸ¥è¯¢æŸä¸€åˆ—æ•°æ®æ—¶ï¼ŒMergeTree æ— éœ€åŠ è½½æ•´ä¸ª .bin æ–‡ä»¶ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®éœ€è¦åªåŠ è½½ç‰¹å®šçš„å‹ç¼©æ•°æ®å—ï¼Œè€Œè¿™é¡¹ç‰¹æ€§åˆ™è¦å€ŸåŠ© .mrk æ–‡ä»¶ä¸­æ‰€ä¿å­˜çš„åç§»é‡ä¿¡æ¯ã€‚</strong></p>
<p><strong>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸Šä¸‹ç›¸é‚»çš„ä¸¤ä¸ªå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡ï¼Œæ„æˆäº†ä¸å½“å‰æ ‡è®°å¯¹åº”çš„å‹ç¼©æ•°æ®å—çš„åç§»é‡åŒºé—´ï¼Œè¯´äººè¯å°±æ˜¯é€šè¿‡ç¬¬ n ä¸ªå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡å’Œç¬¬ n + 1 ä¸ªå‹ç¼©æ•°æ®å—çš„èµ·å§‹åç§»é‡ï¼Œå¯ä»¥è·å–ç¬¬ n ä¸ªå‹ç¼©æ•°æ®å—ã€‚å…·ä½“åšæ³•å°±æ˜¯ä»å½“å‰åç§»é‡å¼€å§‹å‘ä¸‹å¯»æ‰¾ï¼ˆå½“å‰å—çš„èµ·å§‹ä½ç½® startï¼‰ï¼Œç›´åˆ°æ‰¾åˆ°ä¸åŒçš„åç§»é‡ä½ç½®ï¼ˆå½“å‰å—çš„ä¸‹ä¸€ä¸ªå—çš„èµ·å§‹ä½ç½® next_startï¼‰ï¼Œæ­¤æ—¶ start åˆ° next_start ä¾¿æ˜¯å½“å‰å—å¯¹åº”çš„åç§»é‡åŒºé—´ï¼Œæ¯”å¦‚å›¾ä¸­çš„ 0 åˆ° 276ã€‚é€šè¿‡åç§»é‡åŒºé—´ï¼Œå³å¯è·å¾—å½“å‰çš„å‹ç¼©å—ã€‚</strong></p>
<p><strong>2ï¼‰è¯»å–æ•°æ®</strong></p>
<p><strong>åœ¨è¯»å–è§£å‹åçš„æ•°æ®æ—¶ï¼ŒMergeTree å¹¶ä¸éœ€è¦ä¸€æ¬¡æ€§æ‰«ææ•´æ®µè§£å‹æ•°æ®ï¼Œå®ƒå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä»¥ index_granularity çš„ç²’åº¦åŠ è½½ç‰¹å®šçš„ä¸€å°æ®µï¼Œè€Œä¸ºäº†å®ç°è¿™ç§ç‰¹æ€§ï¼Œéœ€è¦å€ŸåŠ©æ ‡è®°æ–‡ä»¶ä¸­ä¿å­˜çš„è§£å‹æ•°æ®å—çš„åç§»é‡ã€‚</strong></p>
<p><strong>é€šè¿‡åç§»é‡ï¼ŒClickHouse å¯ä»¥æŒ‰éœ€è¯»å–æ•°æ®ï¼Œæ¯”å¦‚é€šè¿‡ [0, 8192] å³å¯è¯»å–å‹ç¼©æ•°æ®å— 0 ä¸­ç¬¬ä¸€ä¸ªæ•°æ®ç‰‡æ®µå¯¹åº”çš„è§£å‹æ•°æ®ã€‚</strong></p>
<h2 id="åˆ†åŒºã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®çš„ååŒæ€»ç»“"><a href="#åˆ†åŒºã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®çš„ååŒæ€»ç»“" class="headerlink" title="åˆ†åŒºã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®çš„ååŒæ€»ç»“"></a>åˆ†åŒºã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®çš„ååŒæ€»ç»“</h2><p><strong>åˆ†åŒºã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®ï¼Œå°±ç±»ä¼¼äº MergeTree çš„ä¸€å¥—ç»„åˆæ‹³ï¼Œä½¿ç”¨æ°å½“çš„è¯å¨åŠ›æ— ç©·ã€‚é‚£ä¹ˆåœ¨ä¾æ¬¡ä»‹ç»äº†å„è‡ªçš„ç‰¹ç‚¹ä¹‹åï¼Œç°åœ¨å°†å®ƒä»¬èšåœ¨ä¸€èµ·æ€»ç»“ä¸€ä¸‹ã€‚</strong></p>
<h3 id="å†™å…¥è¿‡ç¨‹"><a href="#å†™å…¥è¿‡ç¨‹" class="headerlink" title="å†™å…¥è¿‡ç¨‹"></a>å†™å…¥è¿‡ç¨‹</h3><p><strong>æ•°æ®å†™å…¥çš„ç¬¬ä¸€æ­¥æ˜¯ç”Ÿæˆåˆ†åŒºç›®å½•ï¼Œä¼´éšç€æ¯ä¸€æ‰¹æ•°æ®çš„å†™å…¥ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ†åŒºç›®å½•ã€‚åœ¨åç»­çš„æŸä¸€æ—¶åˆ»ï¼Œå±äºç›¸åŒåˆ†åŒºçš„åˆ†åŒºç›®å½•ä¼šè¢«åˆå¹¶åˆ°ä¸€èµ·ã€‚ç´§æ¥ç€æŒ‰ç…§ index_granularity ç´¢å¼•ç²’åº¦ï¼Œä¼šåˆ†åˆ«ç”Ÿæˆ primary.idx ä¸€çº§ç´¢å¼•ï¼ˆå¦‚æœå£°æ˜äº†äºŒçº§ç´¢å¼•ï¼Œè¿˜ä¼šåˆ›å»ºäºŒçº§ç´¢å¼•æ–‡ä»¶ï¼‰ã€æ¯ä¸€ä¸ªåˆ—å­—æ®µçš„å‹ç¼©æ•°æ®æ–‡ä»¶ï¼ˆ.binï¼‰å’Œæ•°æ®æ ‡è®°æ–‡ä»¶ï¼ˆ.mrkï¼‰ï¼Œå¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œåˆ™æ˜¯ data.bin å’Œ data.mrk æ–‡ä»¶ã€‚</strong></p>
<p><strong>ä¸‹é¢çš„ç¤ºæ„å›¾å±•ç¤ºäº† MergeTree è¡¨åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œå®ƒçš„åˆ†åŒºç›®å½•ã€ç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®çš„ç”Ÿæˆã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121718621-4237534.png" alt="img"></p>
<p><strong>ä»åˆ†åŒºç›®å½• 202006_1_34_3 èƒ½å¤Ÿå¾—çŸ¥ï¼Œè¯¥åˆ†åŒºæ•°æ®æ€»å…±åˆ† 34 æ‰¹å†™å…¥ï¼ŒæœŸé—´å‘ç”Ÿè¿‡ 3 æ¬¡åˆå¹¶ã€‚åœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œä¾æ® index_granularity çš„ç²’åº¦ï¼Œä¾æ¬¡ä¸ºæ¯ä¸ªåŒºé—´çš„æ•°æ®ç”Ÿæˆç´¢å¼•ã€æ ‡è®°å’Œå‹ç¼©æ•°æ®å—ã€‚å…¶ä¸­ç´¢å¼•å’Œæ ‡è®°åŒºé—´æ˜¯å¯¹é½çš„ï¼Œè€Œæ ‡è®°ä¸å‹ç¼©å—åˆ™æ˜¯æ ¹æ®åŒºé—´å¤§å°çš„ä¸åŒï¼Œä¼šç”Ÿæˆå¤šå¯¹ä¸€ã€ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</strong></p>
<h3 id="æŸ¥è¯¢è¿‡ç¨‹"><a href="#æŸ¥è¯¢è¿‡ç¨‹" class="headerlink" title="æŸ¥è¯¢è¿‡ç¨‹"></a>æŸ¥è¯¢è¿‡ç¨‹</h3><p><strong>æ•°æ®æŸ¥è¯¢çš„æœ¬è´¨å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªä¸æ–­å‡å°‘æ•°æ®èŒƒå›´çš„è¿‡ç¨‹ï¼Œåœ¨æœ€ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒMergeTree é¦–å…ˆå¯ä»¥å€ŸåŠ©åˆ†åŒºç´¢å¼•ã€ä¸€çº§ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•å°†æ•°æ®æ‰«æèŒƒå›´ç¼©è‡³æœ€å°ã€‚ç„¶åå†å€ŸåŠ©æ•°æ®æ ‡è®°ï¼Œå°†éœ€è¦è§£å‹ä¸è®¡ç®—çš„æ•°æ®èŒƒå›´ç¼©è‡³æœ€å°ã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œè¯¥å›¾å±•ç¤ºäº†åœ¨æœ€ä¼˜çš„æƒ…å†µä¸‹ï¼Œç»è¿‡å±‚å±‚è¿‡æ»¤ï¼Œæœ€ç»ˆè·å–æœ€å°æ•°æ®èŒƒå›´çš„è¿‡ç¨‹ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%A8%E5%BC%95%E6%93%8E%EF%BC%9AMergeTree%20%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90(%E5%85%AD)/1229382-20210826121725662-2046737993.png" alt="img"></p>
<p><strong>å¦‚æœä¸€æ¡æŸ¥è¯¢è¯­å¥æ²¡æœ‰æŒ‡å®šä»»ä½• WHERE æ¡ä»¶ï¼Œæˆ–è€…æŒ‡å®šäº† WHERE æ¡ä»¶ã€ä½†æ˜¯æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•çš„ç´¢å¼•ï¼ˆåˆ†åŒºç´¢å¼•ã€ä¸€çº§ç´¢å¼•ã€äºŒçº§ç´¢å¼•ï¼‰ï¼Œé‚£ä¹ˆ MergeTree å°±ä¸èƒ½é¢„å…ˆå‡å°‘æ•°æ®èŒƒå›´ã€‚åœ¨åç»­è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ï¼Œå®ƒä¼šæ‰«ææ‰€æœ‰åˆ†åŒºç›®å½•ï¼Œä»¥åŠç›®å½•å†…ç´¢å¼•æ®µçš„æœ€å¤§åŒºé—´ã€‚ä¸è¿‡è™½ç„¶ä¸èƒ½å‡å°‘æ•°æ®èŒƒå›´ï¼Œä½† MergeTree ä»ç„¶èƒ½å¤Ÿå€ŸåŠ©æ•°æ®æ ‡è®°ï¼Œä»¥å¤šçº¿ç¨‹çš„å½¢å¼åŒæ—¶è¯»å–å¤šä¸ªå‹ç¼©æ•°æ®å—ï¼Œä»¥æå‡æ€§èƒ½ã€‚</strong></p>
<h3 id="æ•°æ®æ ‡è®°ä¸å‹ç¼©æ•°æ®å—çš„å¯¹åº”å…³ç³»"><a href="#æ•°æ®æ ‡è®°ä¸å‹ç¼©æ•°æ®å—çš„å¯¹åº”å…³ç³»" class="headerlink" title="æ•°æ®æ ‡è®°ä¸å‹ç¼©æ•°æ®å—çš„å¯¹åº”å…³ç³»"></a>æ•°æ®æ ‡è®°ä¸å‹ç¼©æ•°æ®å—çš„å¯¹åº”å…³ç³»</h3><p><strong>ç”±äºå‹ç¼©æ•°æ®å—çš„åˆ’åˆ†ï¼Œä¸ä¸€ä¸ªé—´éš”ï¼ˆindex_granularityï¼‰å†…çš„æ•°æ®å¤§å°ç›¸å…³ï¼Œæ¯ä¸ªå‹ç¼©æ•°æ®å—çš„ä½“ç§¯éƒ½è¢«ä¸¥æ ¼æ§åˆ¶åœ¨ 64KB ~ 1MB ä¹‹é—´ï¼Œè€Œä¸€ä¸ªé—´éš”ï¼ˆindex_granularityï¼‰çš„æ•°æ®ï¼Œåˆåªä¼šäº§ç”Ÿä¸€è¡Œæ•°æ®æ ‡è®°ã€‚é‚£ä¹ˆæ ¹æ®ä¸€ä¸ªé—´éš”å†…æ•°æ®çš„å®é™…å­—èŠ‚å¤§å°ï¼Œæ•°æ®æ ‡è®°å’Œå‹ç¼©æ•°æ®å—ä¹‹é—´ä¼šäº§ç”Ÿä¸‰ç§ä¸åŒçš„å¯¹åº”å…³ç³»ï¼š</strong></p>
<p><strong>1ï¼‰å¤šå¯¹ä¸€</strong></p>
<p><strong>å¤šä¸ªæ•°æ®æ ‡è®°å¯¹åº”ä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œå½“ä¸€ä¸ªé—´éš”ï¼ˆindex_granularityï¼‰å†…æ•°æ®çš„æœªå‹ç¼©å¤§å°å°äº 64KB æ—¶ï¼Œä¼šå‡ºç°è¿™ç§å¯¹åº”å…³ç³»ã€‚</strong></p>
<p><strong>2ï¼‰ä¸€å¯¹ä¸€</strong></p>
<p><strong>ä¸€ä¸ªæ•°æ®æ ‡è®°å¯¹åº”ä¸€ä¸ªå‹ç¼©æ•°æ®å—ï¼Œå½“ä¸€ä¸ªé—´éš”ï¼ˆindex_granularityï¼‰å†…æ•°æ®çš„æœªå‹ç¼©å¤§å°å¤§äºç­‰äº 64KB å¹¶å°äºç­‰äº 1MB æ—¶ï¼Œä¼šå‡ºç°è¿™ç§å¯¹åº”å…³ç³»ã€‚</strong></p>
<p><strong>3ï¼‰ä¸€å¯¹å¤š</strong></p>
<p><strong>ä¸€ä¸ªæ•°æ®æ ‡è®°å¯¹åº”å¤šä¸ªå‹ç¼©æ•°æ®å—ï¼Œå½“ä¸€ä¸ªé—´éš”ï¼ˆindex_granularityï¼‰å†…æ•°æ®çš„æœªå‹ç¼©å¤§å°å¤§äº 1MB æ—¶ï¼Œä¼šå‡ºç°è¿™ç§å¯¹åº”å…³ç³»ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ MergeTree çš„å·¥ä½œåŸç†ï¼Œé¦–å…ˆæˆ‘ä»¬äº†è§£äº† MergeTree çš„åŸºç¡€å±æ€§å’Œç‰©ç†å­˜å‚¨ç»“æ„ï¼›æ¥ç€ï¼Œä¾æ¬¡ä»‹ç»äº†æ•°æ®åˆ†åŒºã€ä¸€çº§ç´¢å¼•ã€äºŒçº§ç´¢å¼•ã€æ•°æ®å­˜å‚¨å’Œæ•°æ®æ ‡è®°çš„é‡è¦ç‰¹æ€§ï¼›æœ€åæ€»ç»“äº† MergeTree ä¸Šè¿°ç‰¹æ€§ä¸€èµ·ååŒæ—¶å·¥ä½œè¿‡ç¨‹ã€‚æŒæ¡äº† MergeTree å³æŒæ¡äº†åˆå¹¶æ ‘ç³»åˆ—è¡¨å¼•æ“çš„ç²¾é«“ï¼Œå› ä¸º MergeTree æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§è¡¨å¼•æ“ã€‚åé¢æˆ‘ä»¬ä¼šä»‹ç» MergeTree å®¶æ—ä¸­å…¶å®ƒå¸¸è§è¡¨å¼•æ“çš„ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå®ƒä»¬éƒ½æœ‰å“ªäº›ç‰¹ç‚¹ã€ä½¿ç”¨æ–¹å¼æ˜¯ä»€ä¹ˆ</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse ä¸­çš„æ•°æ®æŸ¥è¯¢ä»¥åŠå„ç§å­å¥(ä¹)</title>
    <url>/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/</url>
    <content><![CDATA[<h1 id="ClickHouse-ä¸­çš„æ•°æ®æŸ¥è¯¢ä»¥åŠå„ç§å­å¥-ä¹"><a href="#ClickHouse-ä¸­çš„æ•°æ®æŸ¥è¯¢ä»¥åŠå„ç§å­å¥-ä¹" class="headerlink" title="ClickHouse ä¸­çš„æ•°æ®æŸ¥è¯¢ä»¥åŠå„ç§å­å¥(ä¹)"></a>ClickHouse ä¸­çš„æ•°æ®æŸ¥è¯¢ä»¥åŠå„ç§å­å¥(ä¹)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><p><strong>ä½œä¸ºä¸€æ¬¾ OLAP å‹çš„æ•°æ®åº“ï¼Œå®ƒçš„æŸ¥è¯¢åŠŸèƒ½å¯è°“æ˜¯é‡ä¸­ä¹‹é‡ï¼Œè€Œä¸”æˆ‘ç›¸ä¿¡å¤§å®¶åœ¨ç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ä½¿ç”¨å®ƒçš„æŸ¥è¯¢åŠŸèƒ½ï¼Œäº‹å®ä¸Šï¼Œåœ¨æ—¥å¸¸è¿è½¬çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®æŸ¥è¯¢ä¹Ÿæ˜¯ ClickHouse çš„ä¸»è¦å·¥ä½œä¹‹ä¸€ã€‚ClickHouse å®Œå…¨ä½¿ç”¨ SQL ä½œä¸ºæŸ¥è¯¢è¯­è¨€ï¼Œèƒ½å¤Ÿä»¥ SELECT æŸ¥è¯¢è¯­å¥çš„å½¢å¼ä»æ•°æ®åº“ä¸­é€‰å–æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯å®ƒå…·å¤‡æµè¡Œæ½œè´¨çš„é‡è¦åŸå› ã€‚è™½ç„¶ ClickHouse æ‹¥æœ‰ä¼˜ç§€çš„æŸ¥è¯¢æ€§èƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸èƒ½æ»¥ç”¨æŸ¥è¯¢ï¼ŒæŒæ¡ ClickHouse æ‰€æ”¯æŒçš„å„ç§æŸ¥è¯¢å­å¥ï¼Œå¹¶é€‰æ‹©åˆç†çš„æŸ¥è¯¢å½¢å¼æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ä½¿ç”¨ä¸æ°å½“çš„ SQL è¯­å¥è¿›è¡ŒæŸ¥è¯¢ä¸ä»…ä¼šå¸¦æ¥ä½æ€§èƒ½ï¼Œè¿˜å¯èƒ½å¯¼è‡´ä¸å¯é¢„çŸ¥çš„ç³»ç»Ÿé”™è¯¯ã€‚</strong></p>
<p><strong>è™½ç„¶åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»è§è¯†è¿‡ä¸€äº›æŸ¥è¯¢è¯­å¥çš„ç”¨æ³•ï¼Œä½†é‚£äº›éƒ½æ˜¯ä¸ºäº†æ¼”ç¤ºæ•ˆæœç®€åŒ–åçš„ä»£ç ï¼Œä¸çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒä¸­çš„ä»£ç ç›¸å·®è¾ƒå¤§ã€‚ä¾‹å¦‚åœ¨ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼Œéƒ½åº”è¯¥é¿å…ä½¿ç”¨ SELECT * æ¥æŸ¥è¯¢æ•°æ®ï¼Œå› ä¸ºé€šé…ç¬¦ * å¯¹äºé‡‡ç”¨åˆ—å¼å­˜å‚¨çš„ ClickHouse è€Œè¨€æ²¡æœ‰ä»»ä½•å¥½å¤„ã€‚å‡å¦‚é¢å¯¹ä¸€å¼ æ‹¥æœ‰æ•°ç™¾ä¸ªåˆ—å­—æ®µçš„æ•°æ®è¡¨ï¼Œä¸‹é¢è¿™ä¸¤æ¡ SELECT è¯­å¥çš„æ€§èƒ½å¯èƒ½ä¼šç›¸å·® 100 å€ä¹‹å¤šï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span>;</span><br><span class="line"><span class="keyword">SELECT</span> col <span class="keyword">FROM</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨é€šé…ç¬¦ * å’ŒæŒ‰åˆ—æŸ¥è¯¢ç›¸æ¯”ï¼Œæ€§èƒ½å¯èƒ½ç›¸å·® 100 å€ï¼Œå¦å¤– ClickHouse å¯¹äº SQL è¯­å¥çš„è§£ææ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œè¿™æ„å‘³ç€ SELECT a å’Œ SELECT A è¡¨ç¤ºçš„è¯­ä¹‰æ˜¯ä¸ç›¸åŒçš„ï¼Œä½†å…³é”®å­—å¤§å°å†™ä¸æ•æ„Ÿï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®éµå¾ªè§„èŒƒä½¿ç”¨å¤§å†™ã€‚æ­¤å¤– ClickHouse çš„ç±»å‹ä¹Ÿå¤§å°å†™æ•æ„Ÿï¼Œæ¯”å¦‚ï¼šUInt8 ä¸å¯ä»¥å†™æˆ uint8ï¼ŒString ä¸å¯ä»¥å†™æˆ stringï¼›è¿˜æœ‰å¤§éƒ¨åˆ†å‡½æ•°ä¹Ÿæ˜¯å¤§å°å†™æ•æ„Ÿï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯ ClickHouse ç‹¬æœ‰çš„ï¼Œæˆ–è€…è¯´ä½ åœ¨å…¶å®ƒå…³ç³»å‹æ•°æ®åº“ä¸­è§ä¸åˆ°çš„ï¼Œä½†æ˜¯åƒ minã€maxã€lengthã€sumã€count ç­‰ç­‰è¿™äº›åœ¨å…¶å®ƒå…³ç³»å‹åº“ä¸­ä¹Ÿèƒ½çœ‹åˆ°çš„å‡½æ•°ï¼Œåœ¨ ClickHouse ä¸­åˆ™æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ã€‚</strong></p>
<p><strong>ä¸‹é¢ä»‹ç» ClickHouse çš„æŸ¥è¯¢è¯­æ³•ï¼ŒClickHouse æ”¯æŒçš„æŸ¥è¯¢å­å¥å’Œæˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å…³ç³»å‹æ•°æ®åº“éå¸¸ç±»ä¼¼ï¼Œä½†æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šåˆæä¾›äº†å¾ˆå¤šæ–°çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</strong></p>
<blockquote>
<p><strong>è™½ç„¶ ClickHouse çš„æŸ¥è¯¢æ˜¯é‡ä¸­ä¹‹é‡ï¼Œä½†æ¯•ç«Ÿé‡‡ç”¨çš„æ˜¯ SQL è¯­æ³•ï¼Œå› æ­¤åƒä»€ä¹ˆå¦‚ä½•èµ·åˆ«åã€æ¯”è¾ƒè¿ç®—ç¬¦ã€æ¡ä»¶è¿ç®—ç¬¦ç­‰ç­‰ï¼Œè¿™äº›æ¯”è¾ƒåŸºç¡€çš„å†…å®¹å°±ä¸è¯´äº†ã€‚</strong></p>
</blockquote>
<h2 id="WITH-å­å¥"><a href="#WITH-å­å¥" class="headerlink" title="WITH å­å¥"></a>WITH å­å¥</h2><p><strong>ClickHouse æ”¯æŒ CTEï¼ˆCommon Table Expressionï¼Œå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰ï¼Œä»¥å¢å¼ºæŸ¥è¯¢è¯­å¥çš„è¡¨è¾¾ã€‚ä¾‹å¦‚ä¸‹é¢çš„å‡½æ•°åµŒå¥—ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pow(pow(<span class="number">2</span>, <span class="number">2</span>), <span class="number">3</span>); </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€pow(pow(2, 2), 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                64 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨æ”¹ç”¨ CTE çš„å½¢å¼åï¼Œå¯ä»¥æå¤§åœ°æé«˜è¯­å¥çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œç®€åŒ–åçš„è¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> pow(<span class="number">2</span>, <span class="number">2</span>) <span class="keyword">AS</span> a <span class="keyword">SELECT</span> pow(a, <span class="number">3</span>); </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€pow(a, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        64 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨ ClickHouse ä¸­çš„ CTE é€šè¿‡ WITH å­å¥è¡¨ç¤ºï¼Œè€Œè¯­æ³•æ ¼å¼æ˜¾ç„¶å¾ˆç®€å•ï¼Œæƒ³è±¡ä¸€ä¸‹ç¼–ç¨‹è¯­è¨€ä¸­çš„å˜é‡å®šä¹‰ï¼Œä¸€èˆ¬éƒ½ç±»ä¼¼äºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var = è¡¨è¾¾å¼</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨åç»­çš„çš„ä»£ç ç¼–å†™ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ var æ¥ä»£æ›¿ç›¸åº”çš„è¡¨è¾¾å¼ï¼Œè€Œåœ¨ ClickHouse ä¸­ä¹Ÿæ˜¯åŒç†ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WITH è¡¨è¾¾å¼ AS var</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ WITHï¼Œæˆ‘ä»¬å³å¯åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ var æ¥ä»£æ›¿è¡¨è¾¾å¼ï¼Œè€Œæ ¹æ®è¡¨è¾¾å¼çš„ä¸åŒï¼Œå¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§ç”¨æ³•ï¼š</strong></p>
<h4 id="1-è¡¨è¾¾å¼ä¸ºå¸¸é‡"><a href="#1-è¡¨è¾¾å¼ä¸ºå¸¸é‡" class="headerlink" title="1. è¡¨è¾¾å¼ä¸ºå¸¸é‡"></a>1. è¡¨è¾¾å¼ä¸ºå¸¸é‡</h4><p><strong>æ­¤æ—¶ç›¸å½“äºä¸ºå¸¸é‡èµ·äº†ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼Œè¿™äº›åå­—èƒ½å¤Ÿåœ¨åç»­çš„æŸ¥è¯¢å­å¥ä¸­è¢«ç›´æ¥è®¿é—®ã€‚ä¾‹å¦‚ä¸‹é¢ç¤ºä¾‹ä¸­çš„ startï¼Œè¢«ç›´æ¥ç”¨åœ¨ç´§æ¥ç€çš„ WHERE å­å¥ä¸­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="number">10</span> <span class="keyword">AS</span> <span class="keyword">start</span></span><br><span class="line"><span class="keyword">SELECT</span> number <span class="keyword">FROM</span> system.numbers <span class="comment">-- è¿™æ˜¯ä¸€å¼ ç³»ç»Ÿè¡¨</span></span><br><span class="line"><span class="keyword">WHERE</span> number <span class="operator">&gt;</span> <span class="keyword">start</span> LIMIT <span class="number">5</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”</span></span><br><span class="line"><span class="comment">â”‚     11 â”‚</span></span><br><span class="line"><span class="comment">â”‚     12 â”‚</span></span><br><span class="line"><span class="comment">â”‚     13 â”‚</span></span><br><span class="line"><span class="comment">â”‚     14 â”‚</span></span><br><span class="line"><span class="comment">â”‚     15 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæ²¡æœ‰ WITH å­å¥ï¼Œé‚£ä¹ˆç›´æ¥æŠŠ start æ¢æˆ 10 å³å¯ï¼Œåªä¸è¿‡é€šè¿‡ WITH æˆ‘ä»¬ç»™ 10 è¿™ä¸ªå¸¸é‡èµ·äº†ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ã€‚å½“ç„¶å¸¸é‡ä¸ä»…æ˜¯æ•´æ•°ï¼Œå­—ç¬¦ä¸²ã€æµ®ç‚¹æ•°ã€ç”šè‡³æ•°ç»„éƒ½æ˜¯å¯ä»¥çš„ã€‚</strong></p>
<h4 id="2-è¡¨è¾¾å¼ä¸ºå‡½æ•°è°ƒç”¨"><a href="#2-è¡¨è¾¾å¼ä¸ºå‡½æ•°è°ƒç”¨" class="headerlink" title="2. è¡¨è¾¾å¼ä¸ºå‡½æ•°è°ƒç”¨"></a>2. è¡¨è¾¾å¼ä¸ºå‡½æ•°è°ƒç”¨</h4><p><strong>æ„Ÿè§‰æ­¤æ—¶å°±ç±»ä¼¼äºæ›¿æ¢ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯¹ data_uncompressed_bytes ä½¿ç”¨èšåˆå‡½æ•°æ±‚å’Œåï¼Œåˆç´§æ¥ç€åœ¨ SELECT å­å¥ä¸­å¯¹å…¶è¿›è¡Œäº†æ ¼å¼åŒ–å¤„ç†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="built_in">SUM</span>(data_uncompressed_bytes) <span class="keyword">AS</span> bytes</span><br><span class="line"><span class="keyword">SELECT</span> database, formatReadableSize(bytes) <span class="keyword">AS</span> format</span><br><span class="line"><span class="keyword">FROM</span> system.columns</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> database</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> bytes <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€databaseâ”€â”¬â”€formatâ”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ system   â”‚ 5.32 GiB â”‚</span></span><br><span class="line"><span class="comment">â”‚ default  â”‚ 0.00 B   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä¸ä½¿ç”¨ WITH å­å¥ï¼Œé‚£ä¹ˆ SELECT é‡Œé¢å‡ºç°çš„å°±æ˜¯ formatReadableSize(SUM(data_uncompressed_bytes))ï¼Œè¿™æ ·è¯»èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥ä½¿ç”¨ WITH å­å¥å°†é‡Œé¢çš„èšåˆå‡½æ•°è°ƒç”¨èµ·ä¸€ä¸ªåå­—å« bytesï¼Œé‚£ä¹ˆåé¢çš„æŸ¥è¯¢ç›´æ¥ä½¿ç”¨ bytes å³å¯ã€‚</strong></p>
<h4 id="3-è¡¨è¾¾å¼ä¸ºå­æŸ¥è¯¢"><a href="#3-è¡¨è¾¾å¼ä¸ºå­æŸ¥è¯¢" class="headerlink" title="3. è¡¨è¾¾å¼ä¸ºå­æŸ¥è¯¢"></a>3. è¡¨è¾¾å¼ä¸ºå­æŸ¥è¯¢</h4><p><strong>è¡¨è¾¾å¼ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå€ŸåŠ©å­æŸ¥è¯¢å¯ä»¥å¾—å‡ºå„ database æœªå‹ç¼©æ•°æ®å¤§å°ä¸æ•°æ®æ€»å’Œå¤§å°çš„æ¯”ä¾‹çš„æ’åï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SELECT sum(data_uncompressed_bytes) FROM system.columns ä¼šå¾—åˆ°ä¸€ä¸ªæ•°å€¼</span></span><br><span class="line"><span class="comment">-- å› æ­¤æœ¬è´¨ä¸Šå’Œè¡¨è¾¾å¼ä¸ºå¸¸é‡æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å¤šäº†ä¸€ä¸ªè®¡ç®—çš„è¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">WITH</span> (<span class="keyword">SELECT</span> <span class="built_in">sum</span>(data_uncompressed_bytes) <span class="keyword">FROM</span> system.columns) <span class="keyword">AS</span> total_bytes</span><br><span class="line"><span class="keyword">SELECT</span> database, </span><br><span class="line">       (<span class="built_in">sum</span>(data_uncompressed_bytes) <span class="operator">/</span> total_bytes) <span class="operator">*</span> <span class="number">100</span> <span class="keyword">AS</span> database_disk_usage</span><br><span class="line"><span class="keyword">FROM</span> system.columns</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> database</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> database_disk_usage <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€databaseâ”€â”¬â”€database_disk_usageâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ system   â”‚                 100 â”‚</span></span><br><span class="line"><span class="comment">â”‚ default  â”‚                   0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ WITH å­å¥æ—¶æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¡¨è¾¾å¼åªèƒ½è¿”å›çš„æ•°æ®ä¸èƒ½è¶…è¿‡ 1 è¡Œï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155856488-1272004322.png" alt="img"></p>
<p><strong>è¿™é‡Œçš„ WITH AS å°±ç±»ä¼¼äºç¼–ç¨‹è¯­è¨€ä¸­çš„å˜é‡èµ‹å€¼ï¼Œä½†ä½ ä¸å¯èƒ½è®©ä¸€ä¸ªå˜é‡æŒ‡ä»£å¤šä¸ªå€¼ï¼Œå¦‚æœæƒ³è¿™ä¹ˆåšï¼Œé‚£ä¹ˆå°±å°†è¿™äº›å€¼æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ï¼ˆåˆ—è¡¨ã€é›†åˆã€å­—å…¸ç­‰ç­‰ï¼‰é‡Œé¢ã€‚åŒç†ï¼Œå¦‚æœ WITH çš„è¡¨è¾¾å¼è¿”å›äº†å¤šè¡Œæ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶å˜æˆä¸€ä¸ªæ•°ç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œè§åˆ°äº†ä¸€ä¸ªå‡½æ•° groupArrayï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå½“æˆæ˜¯æ™®é€šçš„èšåˆå‡½æ•°æ¥ç†è§£</span></span><br><span class="line"><span class="comment">-- ç±»ä¼¼äº sumï¼Œsum æ˜¯å¯¹åŒä¸€ç»„çš„å…ƒç´ è¿›è¡Œæ±‚å’Œï¼ŒgroupArray æ˜¯å°†åŒä¸€ç»„çš„å…ƒç´ ç»„åˆæˆæ•°ç»„</span></span><br><span class="line"><span class="keyword">WITH</span> (<span class="keyword">SELECT</span> groupArray(number) <span class="keyword">FROM</span> numbers(<span class="number">10</span>)) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arr;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,4,5,6,7,8,9] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶æ­¤æ—¶å°±æ²¡é—®é¢˜äº†ï¼Œå¹¶ä¸”ç›¸æ¯”å…³ç³»å‹æ•°æ®åº“ï¼ŒClickHouse åœ¨è¡Œåˆ—è½¬æ¢çš„æ—¶å€™å°¤ä¸ºæ–¹ä¾¿ã€‚</strong></p>
<h4 id="4-åœ¨å­æŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨WITH"><a href="#4-åœ¨å­æŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨WITH" class="headerlink" title="4. åœ¨å­æŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨WITH"></a>4. åœ¨å­æŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨WITH</h4><p><strong>åœ¨å­æŸ¥è¯¢ä¸­å¯ä»¥åµŒå¥—ä½¿ç”¨ WITH å­å¥ï¼Œä¾‹å¦‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨è®¡ç®—å‡ºå„ database æœªå‹ç¼©æ•°æ®å¤§å°ä¸æ•°æ®æ€»å’Œçš„æ¯”ä¾‹ä¹‹åï¼Œåˆè¿›è¡Œäº†å–æ•´å‡½æ•°çš„è°ƒç”¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> round(database_disk_usage) <span class="keyword">AS</span> database_disk_usage_v1</span><br><span class="line"><span class="keyword">SELECT</span> database, database_disk_usage, database_disk_usage_v1</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="comment">-- åµŒå¥—</span></span><br><span class="line">    <span class="keyword">WITH</span> (<span class="keyword">SELECT</span> <span class="built_in">sum</span>(data_uncompressed_bytes) <span class="keyword">FROM</span> system.columns) <span class="keyword">AS</span> total_bytes</span><br><span class="line">    <span class="keyword">SELECT</span> database, (<span class="built_in">sum</span>(data_uncompressed_bytes) <span class="operator">/</span> total_bytes) <span class="operator">*</span> <span class="number">100</span> <span class="keyword">AS</span> database_disk_usage</span><br><span class="line">    <span class="keyword">FROM</span> system.columns <span class="keyword">GROUP</span> <span class="keyword">BY</span> database <span class="keyword">ORDER</span> <span class="keyword">BY</span> database_disk_usage <span class="keyword">DESC</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯ä¸éš¾ç†è§£ï¼Œä¸è€ƒè™‘ WITH çš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªåµŒå¥—å­æŸ¥è¯¢ï¼šSELECT â€¦ FROM (SELECT â€¦ FROM)ï¼Œåªä¸è¿‡ä¸¤ä¸ª SELECT é‡Œé¢çš„ database_disk_usage_v1ã€total_bytes æ˜¯ç”¨ WITH å£°æ˜çš„å˜é‡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155847398-1492024351.png" alt="img"></p>
<p><strong>è€Œä¸”æˆ‘ä»¬çœ‹åˆ°å¦‚æœå­æŸ¥è¯¢æ˜¯ä½œä¸ºä¸€å¼ è¡¨ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆåœ¨å…³ç³»å‹æ•°æ®åº“ä¸­åº”è¯¥èµ·ä¸€ä¸ªåˆ«åï¼Œä½†åœ¨ ClickHouse å¯ä»¥ä¸ç”¨ã€‚</strong></p>
<p><strong>æ€»çš„æ¥è¯´ï¼ŒWITH å­å¥å°±ç›¸å½“äºèµ·ä¸€ä¸ªåˆ«åï¼Œå¦‚æœä½ çœ‹æŸä¸ªè¡¨è¾¾å¼é•¿å¾—ä¸é¡ºçœ¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ WITH å°†å®ƒæ›¿æ¢æ‰ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚è€Œä¸”ä¸€ä¸ª WITH å­å¥æ˜¯å¯ä»¥ä¸ºå¤šä¸ªè¡¨è¾¾å¼èµ·åˆ«åçš„ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="number">1</span> <span class="keyword">AS</span> a, <span class="number">2</span> <span class="keyword">AS</span> b <span class="keyword">SELECT</span> a <span class="operator">+</span> b; </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€plus(a, b)â”€â”</span></span><br><span class="line"><span class="comment">â”‚          3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="å…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„-WITH-å­å¥"><a href="#å…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„-WITH-å­å¥" class="headerlink" title="å…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„ WITH å­å¥"></a>å…¶å®ƒå…³ç³»å‹æ•°æ®åº“çš„ WITH å­å¥</h4><p><strong>ClickHouse çš„ WITH è¯­å¥å’Œå…¶å®ƒçš„å…³ç³»å‹æ•°æ®åº“è¿˜æ˜¯æœ‰å¾ˆå¤§å·®åˆ«çš„ï¼Œæ¯”å¦‚ PostgreSQLã€‚å¦‚æœ PostgreSQL çš„è¯ï¼Œé‚£ä¹ˆ AS ä¹‹åçš„ç»“æœæ˜¯ä¼šè¢«å½“æˆæ˜¯ä¸€å¼ è¡¨ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å‡è®¾å­˜åœ¨ä¸€å¼ è¡¨å« girls, å¦‚æœæ˜¯ PostgreSQL çš„è¯</span></span><br><span class="line"><span class="keyword">WITH</span> tmp <span class="keyword">AS</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> girls <span class="keyword">WHERE</span> id <span class="operator">&lt;</span> <span class="number">100</span> </span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tmp <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- è¿™ä¹ˆåšçš„è¯, åœ¨ PostgreSQL ä¸­æ˜¯å®Œå…¨æ­£ç¡®çš„åšæ³•ï¼Œæ­¤æ—¶çš„ tmp å°±æ˜¯ table ä¸­ id å°äº 100 çš„è®°å½•ç»„æˆçš„ç»“æœé›†</span></span><br><span class="line"><span class="comment">-- å¹¶ä¸”å®ƒå¯ä»¥ä½œä¸ºä¸€å¼ ä¸´æ—¶è¡¨æ¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">-- æˆ‘ä»¬è¿™ä¸ªç¤ºä¾‹æ¯”è¾ƒç®€å•, ä½†æ˜¯å½“å­æŸ¥è¯¢æ¯”è¾ƒå¤æ‚çš„æ—¶å€™, é€šè¿‡å°†å­æŸ¥è¯¢å½“åšä¸€å¼ ä¸´æ—¶è¡¨, å¯ä»¥ä½¿æŸ¥è¯¢é€»è¾‘æ›´åŠ æ¸…æ™°</span></span><br><span class="line"><span class="comment">-- å¹¶ä¸”æŸ¥è¯¢ç»“æŸä¹‹å, è¿™å¼ ä¸´æ—¶è¡¨ä¹Ÿå°±ä¸å­˜åœ¨äº†</span></span><br><span class="line"><span class="comment">-- ä¸Šé¢è¿™æ®µä»£ç å’Œä¸‹é¢éƒ½æ˜¯ç­‰ä»·çš„</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> girls <span class="keyword">WHERE</span> id <span class="operator">&lt;</span> <span class="number">100</span> <span class="keyword">AND</span> age <span class="operator">&gt;</span> <span class="number">20</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> girls <span class="keyword">WHERE</span> id <span class="operator">&lt;</span> <span class="number">100</span>) tmp <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ ClickHouse çš„ WITH ä¸­çš„è¡¨è¾¾å¼å¿…é¡»åªèƒ½æœ‰ä¸€è¡Œï¼Œå®ƒå°±ç­‰ä»·äºä¸ºæŸä¸ªå¤æ‚çš„è¡¨è¾¾å¼èµ·ä¸€ä¸ªåˆ«åï¼Œä¸å¯ä»¥æ”¾åœ¨ FROM åé¢ä½œä¸ºä¸´æ—¶è¡¨æ¥ä½¿ç”¨ã€‚è€Œ PostgreSQL çš„ WITH ä¸­çš„è¡¨è¾¾å¼æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¯ä»¥è¿”å›ä»»ä½•æ•°æ®ï¼Œè¡Œæ•°ä¸é™ï¼Œå¹¶ä¸”å¯ä»¥å½“æˆä¸´æ—¶è¡¨æ”¾åœ¨ FROM åé¢ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒClickHouse å’Œ PostgreSQL çš„ WITH è¯­å¥è¿˜æœ‰ä¸€å¤„ä¸åŒï¼Œé‚£å°±æ˜¯ ClickHouse ä¸­åˆ«ååœ¨ AS åé¢ï¼Œè€Œ PostgreSQL ä¸­åˆ«ååœ¨ AS å‰é¢ã€‚</strong></p>
<blockquote>
<p><strong>æ³¨æ„ï¼šWITH ä¸­çš„è¡¨è¾¾å¼å¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œé‚£ä¹ˆä¼šæå‰è®¡ç®—å¥½ï¼Œåœ¨ä½¿ç”¨åˆ«åçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å·²ç»è®¡ç®—å¥½çš„ç»“æœã€‚</strong></p>
</blockquote>
<p><strong>é—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶è¡Œæ•°æœ‰é™åˆ¶ï¼Œé‚£åˆ—æ•°æœ‰æ²¡æœ‰é™åˆ¶å‘¢ï¼Ÿæˆ‘ä»¬è¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œé¦–å…ˆåˆ›å»ºä¸€å¼  Memory æ•°æ®è¡¨ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> women</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”¬â”€ageâ”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ å¤æ˜åœ°è§‰  â”‚  17 â”‚</span></span><br><span class="line"><span class="comment">â”‚  2 â”‚ èŠ™å…°æœµéœ²  â”‚ 144 â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ çªéœ²è¯º    â”‚  58 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæˆ‘ä»¬æ¥è¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155837104-1321089989.png" alt="img"></p>
<p><strong>åŒç†é€šè¿‡ WITHï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®ç°ä¸ºå­—æ®µèµ·åˆ«åçš„æ•ˆæœï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155830593-127511004.png" alt="img"></p>
<p><strong>ä¸è¿‡è¿™ç§åšæ³•æ˜¾ç„¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œé™¤éå­—æ®µåå¤ªé•¿äº†ï¼Œæƒ³èµ·ä¸€ä¸ªçŸ­ç‚¹å„¿çš„ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ WITH å­å¥ï¼Œéå¸¸ç®€å•ï¼Œæ ¸å¿ƒå°±ä¸€å¥è¯ï¼šç»™è¡¨è¾¾å¼èµ·åˆ«åï¼Œåç»­ä½¿ç”¨åˆ«åæ¥å¯¹è¡¨è¾¾å¼è¿›è¡Œæ›¿æ¢ã€‚</strong></p>
<h2 id="FROM-å­å¥"><a href="#FROM-å­å¥" class="headerlink" title="FROM å­å¥"></a>FROM å­å¥</h2><p><strong>FROM å­å¥è¡¨ç¤ºä»ä½•å¤„è¯»å–æ•°æ®ï¼Œç›®å‰æ”¯æŒå¦‚ä¸‹ 3 ç§å½¢å¼ã€‚</strong></p>
<p><strong>1. ä»æ•°æ®è¡¨ä¸­å–æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> people</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. ä»å­æŸ¥è¯¢ä¸­å–æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> max_id <span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">max</span>(id) <span class="keyword">AS</span> max_id <span class="keyword">FROM</span> people)</span><br><span class="line"><span class="comment">-- åœ¨å…¶å®ƒå…³ç³»å‹æ•°æ®åº“ä¸­, å¦‚æœå­æŸ¥è¯¢ä½œä¸ºä¸€å¼ è¡¨æ¥ä½¿ç”¨, é‚£ä¹ˆå¿…é¡»è¦èµ·ä¸€ä¸ªåˆ«å</span></span><br><span class="line"><span class="comment">-- ä½†æ˜¯åœ¨ ClickHouse ä¸­ä¸éœ€è¦, ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸ªä¸é”™çš„å†³å®šï¼Œå› ä¸ºèµ·åˆ«åæˆ‘ä»¬åˆä¸ç”¨</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3. ä»è¡¨å‡½æ•°ä¸­å–æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(N) <span class="comment">-- ä¼šè¿”å› 0 åˆ° N - 1 </span></span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤– FROM å…³é”®å­—å¯ä»¥çœç•¥ï¼Œæˆ‘ä»¬åœ¨ä»‹ç» WITH å­å¥çš„æ—¶å€™å¤šæ¬¡çœç•¥ FROMï¼Œå› ä¸º SELECT åé¢æ˜¯æ ‡é‡ï¼Œæ­¤æ—¶ä¼šä»è™šæ‹Ÿè¡¨ä¸­å–å€¼ã€‚åœ¨ ClickHouse ä¸­ï¼Œå¹¶æ²¡æœ‰æ•°æ®åº“ä¸­å¸¸è§çš„ DUAL è™šæ‹Ÿè¡¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ system.oneã€‚ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç­‰ä»·äº SELECT 1, 2, 3 FROM system.oneï¼Œ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>;  </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€1â”€â”¬â”€2â”€â”¬â”€3â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1 â”‚ 2 â”‚ 3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">+</span> <span class="number">2</span>, <span class="number">2</span> <span class="operator">*</span> <span class="number">3</span>;  <span class="comment">-- æ­¤æ—¶å¯ä»¥å½“æˆè®¡ç®—å™¨æ¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€plus(1, 2)â”€â”¬â”€multiply(2, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚          3 â”‚              6 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;KOMEIJI SATORI&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€[1, 2, 3]â”€â”¬â”€&#x27;KOMEIJI SATORI&#x27;â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3]   â”‚ KOMEIJI SATORI   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="ARRAY-JOIN-å­å¥"><a href="#ARRAY-JOIN-å­å¥" class="headerlink" title="ARRAY JOIN å­å¥"></a>ARRAY JOIN å­å¥</h2><p><strong>ARRAY JOIN å­å¥å…è®¸åœ¨æ•°æ®è¡¨çš„å†…éƒ¨ï¼Œä¸æ•°ç»„æˆ–åµŒå¥—ç±»å‹çš„å­—æ®µè¿›è¡Œ JOIN æ“ä½œï¼Œä»è€Œå°†ä¸€è¡Œæ•°ç»„å±•å¼€ä¸ºå¤šè¡Œã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„åŸºç¡€ç”¨æ³•ï¼Œé¦–å…ˆæ–°å»ºä¸€å¼ åŒ…å« Array æ•°ç»„å­—æ®µçš„æµ‹è¯•è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (</span><br><span class="line">    title String,</span><br><span class="line">    <span class="keyword">value</span> <span class="keyword">Array</span>(UInt8)</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç„¶åå†™å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="string">&#x27;food&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), (<span class="string">&#x27;fruit&#x27;</span>, [<span class="number">3</span>, <span class="number">4</span>]), (<span class="string">&#x27;meat&#x27;</span>, []);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€valueâ”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [3,4]   â”‚</span></span><br><span class="line"><span class="comment">â”‚ meat  â”‚ []      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨ä¸€æ¡ SELECT è¯­å¥ä¸­ï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ª ARRAY JOINï¼ˆä½¿ç”¨å­æŸ¥è¯¢é™¤å¤–ï¼‰ï¼Œç›®å‰æ”¯æŒ INNER å’Œ LEFT ä¸¤ç§ JOIN ç­–ç•¥ï¼š</strong></p>
<h4 id="INNER-ARRAY-JOIN"><a href="#INNER-ARRAY-JOIN" class="headerlink" title="INNER ARRAY JOIN"></a>INNER ARRAY JOIN</h4><p><strong>ARRAY JOIN åœ¨é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯ INNER JOIN ç­–ç•¥ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> title, <span class="keyword">value</span> <span class="keyword">FROM</span> t1 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> <span class="keyword">value</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€valueâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚     1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚     2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚     3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚     3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚     4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»æŸ¥è¯¢ç»“æœå¯ä»¥å‘ç°ï¼Œæœ€ç»ˆçš„æ•°æ®åŸºäº value æ•°ç»„è¢«å±•å¼€æˆäº†å¤šè¡Œï¼Œå¹¶ä¸”æ’é™¤æ‰äº†ç©ºæ•°ç»„ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨å’Œå…¶å®ƒå­—æ®µè¿›è¡Œç»„åˆï¼ˆç›¸å½“äºæŒ‰è¡Œåˆå¹¶ï¼‰ã€‚åœ¨ä½¿ç”¨ ARRAY JOIN æ—¶ï¼Œå¦‚æœè¿˜æƒ³è®¿é—®å±•å¼€å‰çš„æ•°ç»„å­—æ®µï¼Œé‚£ä¹ˆåªéœ€ä¸ºåŸæœ‰çš„æ•°ç»„å­—æ®µæ·»åŠ ä¸€ä¸ªåˆ«åå³å¯ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¦‚æœä¸ç»™ ARRAY JOIN åé¢çš„ value èµ·ä¸€ä¸ªåˆ«åï¼Œé‚£ä¹ˆ value å°±æ˜¯å±•å¼€åçš„ç»“æœ</span></span><br><span class="line"><span class="comment">-- å¦‚æœç»™ ARRAY JOIN åé¢çš„ value èµ·ä¸€ä¸ªåˆ«å valï¼Œé‚£ä¹ˆ value å°±è¿˜æ˜¯å±•å¼€å‰çš„æ•°ç»„å­—æ®µ</span></span><br><span class="line"><span class="comment">-- è€Œ val æ‰æ˜¯å±•å¼€åçš„ç»“æœï¼Œæ‰€ä»¥å†åè¿‡æ¥ï¼Œè®© val å‡ºç°åœ¨ SELECT ä¸­å³å¯</span></span><br><span class="line"><span class="keyword">SELECT</span> title, <span class="keyword">value</span>, val <span class="keyword">FROM</span> t1 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> <span class="keyword">value</span> <span class="keyword">AS</span> val;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€valueâ”€â”€â”€â”¬â”€valâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [3,4]   â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [3,4]   â”‚   4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ° ClickHouse çš„ç¡®æ˜¯å½“ä¹‹æ— æ„§çš„æœ€å¼º OLAP æ•°æ®åº“ï¼Œä¸å•å•æ˜¯é€Ÿåº¦å¿«ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå®ƒæä¾›çš„æŸ¥è¯¢è¯­æ³•ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚å¦‚æœä½ ç”¨è¿‡ Hive çš„è¯ï¼Œä¼šå‘ç°è¿™é‡Œç‰¹åˆ«åƒé‡Œé¢çš„ lateral view explode è¯­æ³•ã€‚</strong></p>
<h4 id="LEFT-ARRAY-JOIN"><a href="#LEFT-ARRAY-JOIN" class="headerlink" title="LEFT ARRAY JOIN"></a>LEFT ARRAY JOIN</h4><p><strong>ARRAY JOIN å­å¥æ”¯æŒ LEFT è¿æ¥ç­–ç•¥ï¼Œä¾‹å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> title, <span class="keyword">value</span>, val <span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> <span class="keyword">value</span> <span class="keyword">AS</span> val;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€valueâ”€â”€â”€â”¬â”€valâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3] â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [3,4]   â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [3,4]   â”‚   4 â”‚</span></span><br><span class="line"><span class="comment">â”‚ meat  â”‚ []      â”‚   0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨æ”¹ä¸º LEFT è¿æ¥æŸ¥è¯¢åï¼Œå¯ä»¥å‘ç°ï¼Œåœ¨ INNER JOIN ä¸­è¢«æ’é™¤æ‰çš„ç©ºæ•°ç»„å‡ºç°åœ¨äº†è¿”å›çš„ç»“æœé›†ä¸­ã€‚ä½†æ­¤æ—¶çš„ val æ˜¯é›¶å€¼ï¼Œæ‰€ä»¥ LEFT ARRAY JOIN ä¸ªäººè§‰å¾—ä¸æ˜¯å¾ˆå¸¸ç”¨ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨ ARRAY JOINã€‚</strong></p>
<h4 id="å…³äºæ•°ç»„çš„ä¸€äº›éªšæ“ä½œ"><a href="#å…³äºæ•°ç»„çš„ä¸€äº›éªšæ“ä½œ" class="headerlink" title="å…³äºæ•°ç»„çš„ä¸€äº›éªšæ“ä½œ"></a>å…³äºæ•°ç»„çš„ä¸€äº›éªšæ“ä½œ</h4><p><strong>åœ¨å…³ç³»å‹æ•°æ®åº“é‡Œé¢æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¸å¤ªå–œæ¬¢ç”¨æ•°ç»„ï¼Œä½†æ˜¯åœ¨ ClickHouse ä¸­æ•°ç»„ä¼šç”¨çš„éå¸¸å¤šï¼Œå¹¶ä¸”æ“ä½œèµ·æ¥éå¸¸ç®€å•ã€‚ClickHouse é‡Œé¢æä¾›äº†éå¸¸å¤šçš„å‡½æ•°ï¼Œç”¨å¥½äº†çš„è¯ï¼Œå°±ç›¸å½“äºåˆ†å¸ƒå¼çš„ pandasã€‚ä¸‹é¢å°±å…ˆæ¥çœ‹ä¸€ä¸‹å…³äºæ•°ç»„çš„ä¸€äº›å‡½æ•°ï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€éƒ¨åˆ†ï¼Œæå‰æ„Ÿå—ä¸€ä¸‹ ClickHouse çš„å¼ºå¤§ï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€å¼ æ–°è¡¨ï¼Œå¹¶å†™å…¥æµ‹è¯•æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€dtâ”€â”¬â”€cashâ”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 â”‚ [10,10,10] â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-02 â”‚ [20,20,20] â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 â”‚ [10,10,10] â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-02 â”‚ [20,20]    â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-03 â”‚ []         â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-03 â”‚ [30,30,30] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>groupArray</strong></p>
<p><strong>è¿™ä¸ªå‡½æ•°å·²ç»å‡ºç°è¿‡ä¸€æ¬¡äº†ï¼Œæˆ‘ä»¬è¯´å®ƒæ˜¯æŠŠå¤šè¡Œæ•°æ®åˆå¹¶æˆä¸€ä¸ªæ•°ç»„ï¼Œç›¸å½“äºæ˜¯èšåˆå‡½æ•°çš„ä¸€ç§ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dt, groupArray(cash) <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€dtâ”€â”¬â”€groupArray(cash)â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 â”‚ [[10,10,10],[10,10,10]] â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-02 â”‚ [[20,20,20],[20,20]]    â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-03 â”‚ [[],[30,30,30]]         â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ° groupArray å°±ç­‰åŒäºç±»ä¼¼ countã€sum è¿™æ ·çš„èšåˆå‡½æ•°ï¼Œå°†åŒä¸€ç»„çš„æ•°æ®ç»„åˆæˆä¸€ä¸ªæ–°çš„æ•°ç»„ã€‚ç”±äºæœ¬æ¥çš„å…ƒç´ å°±æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯æ•°ç»„åµŒå¥—æ•°ç»„ã€‚</strong></p>
<p><strong>é™¤äº† groupArray ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª groupUniqArrayï¼Œåœ¨ç»„åˆçš„æ—¶å€™ä¼šå¯¹å…ƒç´ è¿›è¡Œå»é‡ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dt, groupUniqArray(cash) <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€dtâ”€â”¬â”€groupUniqArray(cash)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 â”‚ [[10,10,10]]         â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-02 â”‚ [[20,20],[20,20,20]] â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-03 â”‚ [[],[30,30,30]]      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ° â€˜2020-01-01â€™ è¿™è¡Œæ•°æ®è¢«å»é‡äº†ã€‚</strong></p>
<p><strong>arrayFlatten</strong></p>
<p><strong>ä»åå­—ä¸Šåº”è¯¥èƒ½çŒœå‡ºæ¥ï¼Œç›´æ¥çœ‹ä¾‹å­å°±æ˜ç™½äº†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dt, </span><br><span class="line">       groupArray(cash),</span><br><span class="line">       arrayFlatten(groupArray(cash)) <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬åœ¨ groupArray(cash) åŸºç¡€ä¸Šåˆè°ƒç”¨äº† arrayFlattenï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155811386-223388004.png" alt="img"></p>
<p><strong>ç›¸ä¿¡è¯¥å‡½æ•°çš„ä½œç”¨æ˜¾è€Œæ˜“è§çš„ï¼Œå°±æ˜¯å°†å¤šä¸ªåµŒå¥—æ•°ç»„æ‰å¹³åŒ–ï¼Œå¦å¤–è¿™é‡Œçš„æŸ¥è¯¢è¯­å¥è¿˜å¯ä»¥ç¾åŒ–ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨ WITH å­å¥ï¼Œæå‰å°† groupArray(cash) èµ·ä¸€ä¸ªåˆ«å</span></span><br><span class="line"><span class="keyword">WITH</span> groupArray(cash) <span class="keyword">AS</span> group_cash</span><br><span class="line"><span class="keyword">SELECT</span> dt, </span><br><span class="line">       group_cash,</span><br><span class="line">       arrayFlatten(group_cash) <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br><span class="line">       </span><br><span class="line"><span class="comment">-- æˆ–è€…è¿™ä¹ˆåš</span></span><br><span class="line"><span class="keyword">SELECT</span> dt,</span><br><span class="line">       groupArray(cash) <span class="keyword">AS</span> group_cash,</span><br><span class="line">       arrayFlatten(group_cash) <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br><span class="line"><span class="comment">-- æˆ‘ä»¬çœ‹åˆ°å³ä½¿æ˜¯åœ¨ SELECT é‡Œé¢èµ·çš„åˆ«åä¹Ÿæ˜¯å¯ä»¥è¢«ä½¿ç”¨çš„</span></span><br><span class="line"><span class="comment">-- å¦å¤–é¡ºåºä¹Ÿæ²¡æœ‰é™åˆ¶ï¼Œæ¯”å¦‚ä¸‹é¢çš„åšæ³•ä¹Ÿæ˜¯åˆæ³•çš„</span></span><br><span class="line"><span class="keyword">SELECT</span> dt, </span><br><span class="line">       arrayFlatten(group_cash), </span><br><span class="line">       groupArray(cash) <span class="keyword">AS</span> group_cash <span class="keyword">FROM</span> t2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> dt;</span><br></pre></td></tr></table></figure>

<p><strong>splitByChar</strong></p>
<p><strong>å°†å­—ç¬¦ä¸²æŒ‰ç…§æŒ‡å®šå­—ç¬¦åˆ†å‰²æˆæ•°ç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> splitByChar(<span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;komeiji^koishi&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€splitByChar(&#x27;^&#x27;, &#x27;komeiji^koishi&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;komeiji&#x27;,&#x27;koishi&#x27;]               â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayJoin</strong></p>
<p><strong>è¯¥å‡½æ•°å’Œ ARRAY JOIN å­å¥çš„ä½œç”¨éå¸¸ç±»ä¼¼ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155803358-2134270761.png" alt="img"></p>
<p><strong>arrayMap</strong></p>
<p><strong>å¯¹æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä»¥ç›¸åŒçš„è§„åˆ™è¿›è¡Œæ˜ å°„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- arrayMap(x -&gt; x * 2, value) è¡¨ç¤ºå°† value ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¹˜ä»¥ 2ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°æ•°ç»„</span></span><br><span class="line"><span class="comment">-- è€Œ mapV å°±æ˜¯å˜æ¢è¿‡åçš„æ–°æ•°ç»„ï¼Œç›´æ¥æ‹¿æ¥ç”¨å³å¯</span></span><br><span class="line"><span class="keyword">SELECT</span> title, arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, <span class="keyword">value</span>) <span class="keyword">AS</span> mapV, v</span><br><span class="line"><span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> mapV <span class="keyword">as</span> v</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€mapVâ”€â”€â”€â”€â”¬â”€vâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 4 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 6 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [6,8]   â”‚ 6 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [6,8]   â”‚ 8 â”‚</span></span><br><span class="line"><span class="comment">â”‚ meat  â”‚ []      â”‚ 0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦å¤–å±•å¼€çš„å­—æ®µä¹Ÿå¯ä»¥ä¸æ­¢ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">SELECT</span> title, </span><br><span class="line">       arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, <span class="keyword">value</span>) <span class="keyword">AS</span> mapV, v,</span><br><span class="line">       <span class="keyword">value</span>, v_1</span><br><span class="line"><span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> mapV <span class="keyword">as</span> v, <span class="keyword">value</span> <span class="keyword">AS</span> v_1</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€mapVâ”€â”€â”€â”€â”¬â”€vâ”€â”¬â”€valueâ”€â”€â”€â”¬â”€v_1â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 2 â”‚ [1,2,3] â”‚   1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 4 â”‚ [1,2,3] â”‚   2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [2,4,6] â”‚ 6 â”‚ [1,2,3] â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [6,8]   â”‚ 6 â”‚ [3,4]   â”‚   3 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [6,8]   â”‚ 8 â”‚ [3,4]   â”‚   4 â”‚</span></span><br><span class="line"><span class="comment">â”‚ meat  â”‚ []      â”‚ 0 â”‚ []      â”‚   0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="åµŒå¥—ç±»å‹"><a href="#åµŒå¥—ç±»å‹" class="headerlink" title="åµŒå¥—ç±»å‹"></a>åµŒå¥—ç±»å‹</h4><p><strong>åœ¨å‰é¢ä»‹ç»æ•°æ®å®šä¹‰æ—¶æ›¾ä»‹ç»è¿‡ï¼ŒåµŒå¥—æ•°æ®ç±»å‹çš„æœ¬è´¨æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ ARRAY JOIN ä¹Ÿæ”¯æŒåµŒå¥—æ•°æ®ç±»å‹ã€‚æ¥ä¸‹æ¥ç»§ç»­ç”¨ä¸€ç»„ç¤ºä¾‹è¯´æ˜ï¼Œé¦–å…ˆæ–°å»ºä¸€å¼ åŒ…å«åµŒå¥—ç±»å‹çš„æµ‹è¯•è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t3(</span><br><span class="line">    title String,</span><br><span class="line">    nested Nested</span><br><span class="line">    (</span><br><span class="line">        v1 UInt32,</span><br><span class="line">        v2 UInt64</span><br><span class="line">    )</span><br><span class="line">) ENGINE <span class="operator">=</span> <span class="built_in">Log</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ¥ç€å†™å…¥æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="comment">-- åœ¨å†™å…¥åµŒå¥—æ•°æ®ç±»å‹æ—¶ï¼Œè®°å¾—åŒä¸€è¡Œæ•°æ®ä¸­å„ä¸ªæ•°ç»„çš„é•¿åº¦éœ€è¦å¯¹é½ï¼Œè€Œå¯¹å¤šè¡Œæ•°æ®ä¹‹é—´çš„æ•°ç»„é•¿åº¦æ²¡æœ‰é™åˆ¶</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t3</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;food&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>]),</span><br><span class="line">       (<span class="string">&#x27;fruit&#x27;</span>, [<span class="number">4</span>, <span class="number">5</span>], [<span class="number">40</span>, <span class="number">50</span>]),</span><br><span class="line">       (<span class="string">&#x27;meat&#x27;</span>, [], [])</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹åµŒå¥—ç±»å‹æ•°æ®çš„è®¿é—®ï¼ŒARRAY JOIN æ—¢å¯ä»¥ç›´æ¥ä½¿ç”¨å­—æ®µåˆ—åï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155751689-560561486.png" alt="img"></p>
<p><strong>ä¹Ÿå¯ä»¥ä½¿ç”¨ç‚¹è®¿é—®ç¬¦çš„å½¢å¼ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- nested åªæœ‰ v1 å’Œ v2</span></span><br><span class="line"><span class="comment">-- æ‰€ä»¥ ARRAY JOIN nested.v1, nested.v2 ç­‰ä»·äº ARRAY JOIN nested</span></span><br><span class="line"><span class="keyword">SELECT</span> title, nested.v1, nested.v2 <span class="keyword">FROM</span> t3 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> nested.v1, nested.v2</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€nested.v1â”€â”¬â”€nested.v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         1 â”‚        10 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         2 â”‚        20 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         3 â”‚        30 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚         4 â”‚        40 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚         5 â”‚        50 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åµŒå¥—ç±»å‹ä¹Ÿæ”¯æŒ ARRAY JOIN éƒ¨åˆ†åµŒå¥—å­—æ®µï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> title, nested.v1, nested.v2 <span class="keyword">FROM</span> t3 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> nested.v1</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€nested.v1â”€â”¬â”€nested.v2â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         1 â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         2 â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚         3 â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚         4 â”‚ [40,50]    â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚         5 â”‚ [40,50]    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œåªæœ‰è¢« ARRAY JOIN çš„æ•°ç»„æ‰ä¼šå±•å¼€ã€‚</strong></p>
<p><strong>åœ¨æŸ¥è¯¢åµŒå¥—ç±»å‹æ—¶ä¹Ÿèƒ½å¤Ÿé€šè¿‡åˆ«åçš„å½¢å¼è®¿é—®åŸå§‹æ•°ç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> title, </span><br><span class="line">       nested.v1, nested.v2, </span><br><span class="line">       n.v1, n.v2  </span><br><span class="line"><span class="keyword">from</span> t3 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> nested <span class="keyword">AS</span> n;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€nested.v1â”€â”¬â”€nested.v2â”€â”€â”¬â”€n.v1â”€â”¬â”€n.v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚    1 â”‚   10 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚    2 â”‚   20 â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚    3 â”‚   30 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [4,5]     â”‚ [40,50]    â”‚    4 â”‚   40 â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [4,5]     â”‚ [40,50]    â”‚    5 â”‚   50 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰€ä»¥ ARRAY JOIN nested åé¢å¦‚æœæ²¡æœ‰ ASï¼Œé‚£ä¹ˆè¿™ä¸ª nested.v1 å’Œ nest.v2 å°±æ˜¯å±•å¼€åçš„å€¼</span></span><br><span class="line"><span class="comment">-- å¦‚æœ ARRAY JOIN nested AS nï¼Œèµ·äº†ä¸€ä¸ªåˆ«åï¼Œé‚£ä¹ˆ nested.v1 å’Œ nest.v2 å°±æ˜¯å±•å¼€å‰å€¼ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„æœ¬èº«</span></span><br><span class="line"><span class="comment">-- è€Œ n.v1 å’Œ n.v2 æ‰æ˜¯å±•å¼€åçš„å€¼</span></span><br><span class="line"><span class="comment">-- å¦å¤– ARRAY JOIN nested AS nï¼Œè¿™ä¸ª n å¯ä»¥ä¸ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">SELECT</span> title, </span><br><span class="line">       nested.v1, nested.v2</span><br><span class="line"><span class="keyword">from</span> t3 <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> nested <span class="keyword">AS</span> n;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€titleâ”€â”¬â”€nested.v1â”€â”¬â”€nested.v2â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ food  â”‚ [1,2,3]   â”‚ [10,20,30] â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [4,5]     â”‚ [40,50]    â”‚</span></span><br><span class="line"><span class="comment">â”‚ fruit â”‚ [4,5]     â”‚ [40,50]    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="JOIN-å­å¥"><a href="#JOIN-å­å¥" class="headerlink" title="JOIN å­å¥"></a>JOIN å­å¥</h2><p><strong>JOIN å­å¥å¯ä»¥å¯¹å·¦å³ä¸¤å¼ è¡¨çš„æ•°æ®è¿›è¡Œè¿æ¥ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„æŸ¥è¯¢å­å¥ä¹‹ä¸€ï¼Œå®ƒçš„è¯­æ³•åŒ…å«è¿æ¥ç²¾åº¦å’Œè¿æ¥ç±»å‹ä¸¤éƒ¨åˆ†ã€‚ç›®å‰ ClickHouse æ”¯æŒçš„ JOIN å­å¥å½¢å¼å¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><strong>ç”±ä¸Šå›¾å¯çŸ¥ï¼Œè¿æ¥ç²¾åº¦åˆ†ä¸º ALLã€ANY å’Œ ASOF ä¸‰ç§ï¼ˆå‡†ç¡®çš„è¯´æ˜¯äº”ç§ï¼Œè¿˜æœ‰ SEMI å’Œ ANTIï¼Œè¿™ä¸¤ä¸ªè¿‡ä¼šå†æï¼‰ï¼Œè€Œè¿æ¥ç±»å‹ä¹Ÿå¯åˆ†ä¸ºå¤–è¿æ¥ã€å†…è¿æ¥å’Œäº¤å‰è¿æ¥ä¸‰ç§ã€‚</strong></p>
<p><strong>é™¤æ­¤ä¹‹å¤–ï¼ŒJOIN æŸ¥è¯¢è¿˜å¯ä»¥æ ¹æ®å…¶æ‰§è¡Œç­–ç•¥è¢«åˆ’åˆ†ä¸ºæœ¬åœ°æŸ¥è¯¢å’Œè¿œç¨‹æŸ¥è¯¢ã€‚å…³äºè¿œç¨‹æŸ¥è¯¢çš„å†…å®¹æ”¾åœ¨åç»­ç« èŠ‚è¿›è¡Œè¯´æ˜ï¼Œè¿™é‡Œç€é‡è®²è§£æœ¬åœ°æŸ¥è¯¢ã€‚</strong></p>
<h4 id="è¿æ¥ç²¾åº¦"><a href="#è¿æ¥ç²¾åº¦" class="headerlink" title="è¿æ¥ç²¾åº¦"></a>è¿æ¥ç²¾åº¦</h4><p><strong>è¿æ¥ç²¾åº¦å†³å®šäº† JOIN æŸ¥è¯¢åœ¨è¿æ¥æ•°æ®æ—¶æ‰€ä½¿ç”¨çš„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒ ALLã€ANY å’Œ ASOF ä¸‰ç§ç±»å‹ã€‚å¦‚æœä¸ä¸»åŠ¨å£°æ˜ï¼Œåˆ™é»˜è®¤æ˜¯ ALLã€‚å¯ä»¥é€šè¿‡ join_default_strictness é…ç½®å‚æ•°ä¿®æ”¹é»˜è®¤çš„è¿æ¥ç²¾åº¦ç±»å‹ã€‚</strong></p>
<p><strong>é‚£ä¹ˆè¿™ä¸ªè¿æ¥ç²¾åº¦æŒ‡çš„æ˜¯å•¥å‘¢ï¼Ÿä¸¾ä¸ªæ —å­å°±æ˜ç™½äº†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_1;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€countâ”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚    30 â”‚</span></span><br><span class="line"><span class="comment">â”‚  2 â”‚ A002  â”‚    28 â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚    32 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl_2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code2â”€â”¬â”€countâ”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ B001  â”‚    35 â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ B001  â”‚    29 â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ B003  â”‚    31 â”‚</span></span><br><span class="line"><span class="comment">â”‚  4 â”‚ B004  â”‚    38 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šæ˜¯ç”¨äºæµ‹è¯•çš„è¡¨æ•°æ®ï¼Œä¸‹é¢è¿›è¡Œæµ‹è¯•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- ä¸€åˆ‡æ­£å¸¸ï¼Œè·Ÿä¸€èˆ¬çš„å…³ç³»å‹æ•°æ®åº“æ˜¯ç±»ä¼¼çš„ï¼Œä½†å¦‚æœå°† ALL æ”¹æˆ ANY</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 </span><br><span class="line"><span class="keyword">ANY</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ç»“è®ºå¾ˆæ¸…æ™°äº†ï¼Œå¦‚æœå·¦è¡¨å†…çš„ä¸€è¡Œæ•°æ®ï¼Œåœ¨å³è¡¨ä¸­æœ‰å¤šè¡Œæ•°æ®ä¸ä¹‹è¿æ¥åŒ¹é…ï¼Œé‚£ä¹ˆå½“è¿æ¥ç²¾åº¦ä¸º ALLï¼Œä¼šè¿”å›å³è¡¨ä¸­å…¨éƒ¨è¿æ¥çš„æ•°æ®ï¼›å½“è¿æ¥ç²¾åº¦ä¸º ANYï¼Œä¼šä»…è¿”å›å³è¡¨ä¸­ç¬¬ä¸€è¡Œè¿æ¥çš„æ•°æ®</strong></p>
<p><strong>è¿™å°±æ˜¯è¿æ¥ç²¾åº¦ï¼Œæ²¡ä»€ä¹ˆå¥½ç¨€å¥‡çš„ï¼Œä¸è¿‡åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­åˆ™æ²¡æœ‰è¿æ¥ç²¾åº¦çš„æ¦‚å¿µï¼Œå› ä¸ºå½“å‡ºç°è¿™ç§æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªç­–ç•¥ï¼Œé‚£å°±æ˜¯ç›´æ¥è¿”å›å³è¡¨ä¸­åŒ¹é…çš„å…¨éƒ¨æ•°æ®ã€‚è€Œåœ¨ ClickHouse ä¸­ï¼Œç»™äº†æˆ‘ä»¬è‡ªç”±é€‰æ‹©çš„æƒåˆ©ã€‚</strong></p>
<p><strong>é™¤äº† ALL å’Œ ANY ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ª ASOFï¼Œå®ƒæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿé¦–å…ˆæ— è®º ALL è¿˜æ˜¯ ANYï¼Œåœ¨è¿æ¥çš„æ—¶å€™å¿…é¡»æ˜¯ç­‰å€¼è¿æ¥ã€‚æ¯”å¦‚ä¸Šé¢çš„ t1.id &#x3D; t2.idï¼Œå¦‚æœæ”¹æˆ t1.id &gt;&#x3D; t2.id å°±æ˜¯é”™è¯¯çš„ï¼Œå¦‚æœæ˜¯å¤šä¸ªè¿æ¥æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™äº›è¿æ¥æ¡ä»¶éƒ½å¿…é¡»æ˜¯ç­‰å€¼è¿æ¥ã€‚ä½† ASOF è¡¨ç¤ºæ¨¡ç³Šè¿æ¥ï¼Œä¹Ÿå°±æ˜¯å®ƒå…è®¸ä½ åœ¨ç­‰å€¼è¿æ¥çš„åé¢åŠ ä¸Šä¸€ä¸ªéç­‰å€¼è¿æ¥ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t1.count <span class="keyword">AS</span> count1, t2.count <span class="keyword">AS</span> count2</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”¬â”€count1â”€â”¬â”€count2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚     30 â”‚     35 â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚     30 â”‚     29 â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚     32 â”‚     31 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t1.count <span class="keyword">AS</span> count1, t2.count <span class="keyword">AS</span> count2</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 </span><br><span class="line">ASOF <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id <span class="keyword">AND</span> t1.count <span class="operator">&gt;</span> t2.count;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”¬â”€count1â”€â”¬â”€count2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚     30 â”‚     29 â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚     32 â”‚     31 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t1.count <span class="keyword">AS</span> count1, t2.count <span class="keyword">AS</span> count2</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 </span><br><span class="line">ASOF <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2</span><br><span class="line"><span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id <span class="keyword">AND</span> t1.count <span class="operator">&lt;</span> t2.count;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”¬â”€count1â”€â”¬â”€count2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚     30 â”‚     35 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ç»“è®ºå¾ˆæ¸…æ™°ï¼Œå¦‚æœè¿æ¥ç²¾åº¦ä¸º ALL æˆ–è€… ANYï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¿æ¥æ¡ä»¶å¿…é¡»ä¸ºç­‰å€¼è¿æ¥ï¼Œå¦‚æœå‡ºç°äº†éç­‰å€¼è¿æ¥åˆ™æŠ¥é”™ã€‚è€Œè¿™ä¸¤è€…çš„å”¯ä¸€åŒºåˆ«å°±åœ¨äºï¼š</strong></p>
<ul>
<li><code>ALLï¼šå¦‚æœå³è¡¨æœ‰å¤šæ¡æ•°æ®åŒ¹é…ï¼Œè¿”å›æ‰€æœ‰çš„åŒ¹é…çš„æ•°æ®</code></li>
<li><code>ANYï¼šå¦‚æœå³è¡¨æœ‰å¤šæ¡æ•°æ®åŒ¹é…ï¼Œè¿”å›ç¬¬ä¸€æ¡åŒ¹é…çš„æ•°æ®</code></li>
</ul>
<p><strong>å¦‚æœè¿æ¥ç²¾åº¦ä¸º ASOFï¼Œé‚£ä¹ˆå…è®¸åœ¨ç­‰å€¼è¿æ¥æ¡ä»¶åé¢è¿½åŠ ä¸€ä¸ªéç­‰å€¼è¿æ¥ï¼Œæ‰€ä»¥ä¸Šé¢çš„ t1.id &#x3D; t2.id æ˜¯ç­‰å€¼è¿æ¥ï¼Œt1.count &gt; t2.count æ˜¯éç­‰å€¼è¿æ¥ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä½¿ç”¨éç­‰å€¼è¿æ¥æ—¶ï¼Œè¿™ä¸ªéç­‰å€¼å¯ä»¥æ˜¯ &gt;ã€&gt;&#x3D;ã€&lt;ã€&lt;&#x3D;ï¼Œä½†ä¸èƒ½æ˜¯ !&#x3D;ï¼›å¹¶ä¸”å¯¹äº ASOF è€Œè¨€ï¼Œè¿æ¥æ¡ä»¶å¿…é¡»æ˜¯ç­‰å€¼è¿æ¥å’Œéç­‰å€¼è¿æ¥çš„ç»„åˆï¼Œä¸¤è€…ç¼ºä¸€ä¸å¯ã€‚</strong></p>
<blockquote>
<p><strong>å¯¹äº ASOF è€Œè¨€ï¼Œå¦‚æœå³è¡¨ä¸­æœ‰å¤šè¡Œæ•°æ®åŒ¹é…ï¼Œåªä¼šè¿”å›ç¬¬ä¸€è¡Œã€‚</strong></p>
</blockquote>
<h4 id="è¿æ¥ç±»å‹"><a href="#è¿æ¥ç±»å‹" class="headerlink" title="è¿æ¥ç±»å‹"></a>è¿æ¥ç±»å‹</h4><p><strong>è¿æ¥ç±»å‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œè¿™ä¸ªå’Œå…³ç³»å‹æ•°æ®åº“æ˜¯å®Œå…¨ç±»ä¼¼çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- çœç•¥è¿æ¥ç²¾åº¦ï¼Œé»˜è®¤ä¸º ALL</span></span><br><span class="line"><span class="comment">-- å·¦è¿æ¥</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_2 t2 </span><br><span class="line"><span class="keyword">USING</span>(id); <span class="comment">-- ç­‰ä»·äº t1.id = t2.id</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  2 â”‚ A002  â”‚       â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å³è¿æ¥</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1 <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> tbl_2 t2 </span><br><span class="line"><span class="keyword">USING</span>(id);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  4 â”‚       â”‚ B004  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å…¨è¿æ¥</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1 <span class="keyword">FULL</span> <span class="keyword">JOIN</span> tbl_2 t2 </span><br><span class="line"><span class="keyword">USING</span>(id);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚ B001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  2 â”‚ A002  â”‚       â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  4 â”‚       â”‚ B004  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å’Œå…³ç³»å‹æ•°æ®åº“ç±»ä¼¼ï¼Œä½†æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œå°±æ˜¯å½“æ²¡æœ‰ä¸ä¹‹åŒ¹é…çš„è®°å½•æ—¶ï¼Œä¼šä½¿ç”¨å¯¹åº”ç±»å‹çš„ç©ºå€¼è¿›è¡Œè¡¥å…¨ï¼Œè€Œä¸æ˜¯ Nullã€‚è¿™é‡Œæ²¡æœ‰æŒ‡å®šè¿æ¥ç²¾åº¦ï¼Œé»˜è®¤ä¸º ALLï¼Œæ­¤å¤– LEFT &#x2F; RIGHT &#x2F; FULL JOIN åé¢éƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ª OUTERï¼Œä¸è¿‡ä¹Ÿå¯ä»¥ä¸åŠ ã€‚æœ€åæ˜¯äº¤å‰è¿æ¥ï¼Œäº¤å‰è¿æ¥ç›´æ¥ä¼šå»ç¬›å¡å°”ç§¯ï¼Œä¸éœ€è¦ä»»ä½•çš„è¿æ¥æ¡ä»¶ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155733180-1723661310.png" alt="img"></p>
<h4 id="SEMI-å’Œ-ANTI"><a href="#SEMI-å’Œ-ANTI" class="headerlink" title="SEMI å’Œ ANTI"></a>SEMI å’Œ ANTI</h4><p><strong>æˆ‘ä»¬ä¹‹å‰è¯´è¿æ¥ç²¾åº¦ä¸æ­¢ ALLã€ANYã€ASOF ä¸‰ç§ï¼Œè¿˜æœ‰ SEMI å’Œ ANTIï¼Œåªä¸è¿‡è¿™ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºå®ƒä»¬åªèƒ½ç”¨åœ¨ LEFT JOIN å’Œ RIGHT JOIN ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å•ç‹¬ä»‹ç»ã€‚</strong></p>
<ul>
<li><code>t1 SEMI LEFT JOIN t2 USING(id)ï¼šéå† t1 ä¸­çš„ idï¼Œå¦‚æœå­˜åœ¨äº t2 ä¸­ï¼Œåˆ™è¾“å‡º</code></li>
<li><code>t1 SEMI RIGHT JOIN t2 USING(id)ï¼šéå† t2 ä¸­çš„ idï¼Œå¦‚æœå­˜åœ¨äº t1 ä¸­ï¼Œåˆ™è¾“å‡º</code></li>
<li><code>t1 ANTI LEFT JOIN t2 USING(id)ï¼šéå† t1 ä¸­çš„ idï¼Œå¦‚æœä¸å­˜åœ¨äº t2 ä¸­ï¼Œåˆ™è¾“å‡º</code></li>
<li><code>t1 ANTI RIGHT JOIN t2 USING(id)ï¼šéå† t2 ä¸­çš„ idï¼Œå¦‚æœä¸å­˜åœ¨äº t1 ä¸­ï¼Œåˆ™è¾“å‡º</code></li>
</ul>
<p><strong>æˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155724985-600169291.png" alt="img"></p>
<p><strong>ANTI åˆ™ä¸ä¹‹ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒçš„ç­–ç•¥æ˜¯ä¸å‡ºç°æ‰è¾“å‡ºï¼Œå¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹ã€‚å¦å¤–å¯èƒ½æœ‰äººå‘ç°ï¼Œè¿™ä¸ª SEMI çš„åŠŸèƒ½è²Œä¼¼æœ‰äº›é‡å¤äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ ALL å’Œ ANY å®Œå…¨å¯ä»¥å–ä»£ã€‚å…¶å®å¦‚æœä½ ç”¨è¿‡ hive çš„è¯ï¼Œä¼šå‘ç° SEMI LEFT JOIN å’Œ ANTI LEFT JOIN æ˜¯ IN&#x2F;EXISTS çš„ä¸€ç§æ›´åŠ é«˜æ•ˆçš„å®ç°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™ç§å­æŸ¥è¯¢åº”è¯¥éå¸¸å¸¸è§äº†ï¼ŒæŸ¥è¯¢ä¸€å¼ è¡¨ï¼Œè€Œè¿‡æ»¤çš„æ¡ä»¶è¯¥è¡¨çš„æŸä¸ªå­—æ®µçš„å–å€¼è¦å‡ºç°åœ¨å¦ä¸€å¼ è¡¨çš„æŸä¸ªå­—æ®µä¸­</span></span><br><span class="line"><span class="keyword">SELECT</span> id, code1 <span class="keyword">FROM</span> tbl_1 <span class="keyword">WHERE</span> id <span class="keyword">in</span> (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tbl_2);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è€Œé€šè¿‡ SEMI LEFT JOIN çš„è¯ï¼Œæ•ˆç‡ä¼šæ›´é«˜ä¸€äº›</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1 <span class="keyword">FROM</span> tbl_1 t1 </span><br><span class="line">SEMI <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_2 t2 <span class="keyword">USING</span>(id)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚ A001  â”‚</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ANTI åˆ™æ˜¯ä¸ºäº† NOT IN/EXISTS </span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸¤è€…çš„è¾“å‡ºæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ SEMI &#x2F; ANTI LEFT JOIN æ˜¯ä¸ºäº† IN&#x2F;EXISTS è¿™ç±»åœºæ™¯è€Œè®¾è®¡çš„ï¼Œè‡³äº SEMI RIGHT JOINã€ANTI RIGHT JOIN å°±ç”¨çš„ä¸æ˜¯å¾ˆå¤šäº†ã€‚</strong></p>
<p><strong>Hive é‡Œæœ‰ä¸€ä¸ª LEFT SEMI JOINï¼Œå•è¯é¡ºåºè°ƒæ¢äº†ä¸€ä¸‹ï¼Œç”¨é€”æ˜¯ç±»ä¼¼çš„ï¼Œä¸è¿‡å®ƒçš„å±€é™æ€§è¦æ¯” ClickHouse ä¸­çš„ SEMI LEFT JOIN å¤§å¾ˆå¤šã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Hiveï¼Œè¿™ä¸ª t2.xxx åªèƒ½å‡ºç°åœ¨ ON å­å¥ä¸­ç”¨äºè¿æ¥ï¼Œä¸å¯ç”¨åœ¨å…¶å®ƒåœ°æ–¹</span></span><br><span class="line">t1 <span class="keyword">LEFT</span> SEMI <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ClickHouseï¼Œt2.xxx é™¤äº†å¯ä»¥å‡ºç°åœ¨ ON å­å¥ä¸­ï¼Œå¯ä»¥å‡ºç°åœ¨ SELECT å­å¥ä¸­ï¼ŒWHERE å­å¥ä¸­</span></span><br><span class="line">t1 SEMI <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¸¾ä¸ªæ —å­ï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2 </span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1 SEMI </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_2 t2 </span><br><span class="line"><span class="keyword">USING</span>(id) <span class="keyword">where</span> t2.code2 <span class="operator">=</span> <span class="string">&#x27;B003&#x27;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€idâ”€â”¬â”€code1â”€â”¬â”€code2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  3 â”‚ A003  â”‚ B003  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤– Hive é‡Œé¢åªæœ‰ LEFT SEMI JOINï¼Œæ²¡æœ‰å…¶å®ƒçš„ï¼Œä½† ClickHouse çš„é€‰æ‹©å°±å¤šäº†å¾ˆå¤šã€‚</strong></p>
<h4 id="å¤šè¡¨è¿æ¥"><a href="#å¤šè¡¨è¿æ¥" class="headerlink" title="å¤šè¡¨è¿æ¥"></a>å¤šè¡¨è¿æ¥</h4><p><strong>åœ¨è¿›è¡Œå¤šå¼ æ•°æ®è¡¨çš„è¿æ¥æŸ¥è¯¢æ—¶ï¼ŒClickHouse ä¼šå°†å®ƒä»¬è½¬ä¸ºä¸¤ä¸¤è¿æ¥çš„å½¢å¼ã€‚æˆ‘ä»¬é¦–å…ˆå†åˆ›å»ºä¸€å¼ è¡¨ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155714466-1251789186.png" alt="img"></p>
<p><strong>ç„¶åå¯¹ä¸‰å¼ æµ‹è¯•è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t3.code3</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 <span class="keyword">AS</span> t1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 <span class="keyword">AS</span> t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tbl_3 <span class="keyword">AS</span> t3 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t3.id</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨æ‰§è¡Œä¸Šè¿°æŸ¥è¯¢æ—¶ï¼Œtbl_1 å’Œ tbl_2 ä¼šå…ˆè¿›è¡Œå†…è¿æ¥ï¼Œä¹‹åå†å°†å®ƒä»¬çš„ç»“æœé›†åˆ tbl_3 è¿›è¡Œå·¦è¿æ¥ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155706262-2109411026.png" alt="img"></p>
<p><strong>å¦å¤– ClickHouse ä¹Ÿæ”¯æŒå…³è”æŸ¥è¯¢çš„è¯­æ³•ï¼Œåªä¸è¿‡ä¼šè‡ªåŠ¨è½¬æˆæŒ‡å®šçš„è¿æ¥æŸ¥è¯¢ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å…³è”æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰ WHEREï¼Œé‚£ä¹ˆä¸‰å¼ è¡¨ä¼šåšç¬›å¡å°”ç§¯</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t3.code3</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1, tbl_2 t2, tbl_3 t3 </span><br><span class="line"><span class="keyword">WHERE</span> t1.id <span class="operator">=</span> t2.id <span class="keyword">AND</span> t1.id <span class="operator">=</span> t3.id</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€t1.idâ”€â”¬â”€t1.code1â”€â”¬â”€t2.code2â”€â”¬â”€t3.code3â”€â”</span></span><br><span class="line"><span class="comment">â”‚     3 â”‚ A003     â”‚ B003     â”‚ C003     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šå°±æ˜¯å…³è”æŸ¥è¯¢ï¼Œè™½ç„¶ä¹Ÿèƒ½å®ç°ï¼Œä¸è¿‡è¿˜æ˜¯ä¸æ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºæ­¤æ—¶è¿æ¥æ¡ä»¶å’Œè¿‡æ»¤æ¡ä»¶éƒ½å†™åœ¨äº† WHERE å­å¥é‡Œé¢ï¼Œçœ‹èµ·æ¥ä¼šæ¯”è¾ƒæ··ä¹±ã€‚æ‰€ä»¥æ›´æ¨èè¿æ¥æŸ¥è¯¢ï¼ˆClickHouse ä¼šè‡ªåŠ¨è½¬åŒ–ï¼‰ï¼Œä¹Ÿå°±æ˜¯ JOIN ON çš„å½¢å¼ï¼Œæ­¤æ—¶ ON åé¢å†™è¿æ¥æ¡ä»¶ï¼Œè€Œæ•°æ®è¿‡æ»¤æ¡ä»¶å†™ WHERE é‡Œé¢ï¼ˆå½“ç„¶æˆ‘ä»¬è¿™é‡Œä¸éœ€è¦è¿‡æ»¤ï¼‰ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t1.id, t1.code1, t2.code2, t3.code3</span><br><span class="line"><span class="keyword">FROM</span> tbl_1 t1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_2 t2 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t2.id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl_3 t3 <span class="keyword">ON</span> t1.id <span class="operator">=</span> t3.id</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€t1.idâ”€â”¬â”€t1.code1â”€â”¬â”€t2.code2â”€â”¬â”€t3.code3â”€â”</span></span><br><span class="line"><span class="comment">â”‚     3 â”‚ A003     â”‚ B003     â”‚ C003     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h4><p><strong>æœ€åï¼Œè¿˜æœ‰ä¸¤ä¸ªå…³äº JOIN æŸ¥è¯¢çš„æ³¨æ„äº‹é¡¹ã€‚</strong></p>
<p><strong>1. å…³äºæ€§èƒ½</strong></p>
<p><strong>æœ€åï¼Œè¿˜æœ‰ä¸¤ä¸ªå…³äº JOIN æŸ¥è¯¢çš„æ³¨æ„äº‹é¡¹ã€‚ä¸ºäº†èƒ½å¤Ÿä¼˜åŒ– JOIN æŸ¥è¯¢æ€§èƒ½ï¼Œé¦–å…ˆåº”è¯¥éµå¾ªå·¦å¤§å³å°çš„åŸåˆ™ï¼Œå³æ•°æ®é‡å°çš„è¡¨è¦æ”¾åœ¨å³ä¾§ã€‚è¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œ JOIN æŸ¥è¯¢æ—¶ï¼Œæ— è®ºä½¿ç”¨çš„æ˜¯å“ªç§è¿æ¥æ–¹å¼ï¼Œå³è¡¨éƒ½ä¼šè¢«å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ä¸å·¦è¡¨è¿›è¡Œæ¯”è¾ƒã€‚</strong></p>
<p><strong>å…¶æ¬¡ï¼ŒJOIN æŸ¥è¯¢ç›®å‰æ²¡æœ‰ç¼“å­˜çš„æ”¯æŒï¼Œè¿™æ„å‘³ç€æ¯ä¸€æ¬¡ JOIN æŸ¥è¯¢ï¼Œå³ä¾¿æ˜¯è¿ç»­æ‰§è¡Œç›¸åŒçš„ SQLï¼Œä¹Ÿéƒ½ä¼šç”Ÿæˆä¸€æ¬¡å…¨æ–°çš„æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¼šå¤§é‡ä½¿ç”¨ JOIN æŸ¥è¯¢ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥è€ƒè™‘å€ŸåŠ©ä¸Šå±‚åº”ç”¨ä¾§çš„ç¼“å­˜æœåŠ¡æˆ–ä½¿ç”¨ JOIN è¡¨å¼•æ“æ¥æ”¹å–„æ€§èƒ½ã€‚</strong></p>
<p><strong>æœ€åï¼Œå¦‚æœæ˜¯åœ¨å¤§é‡ç»´åº¦å±æ€§è¡¥å…¨çš„æŸ¥è¯¢åœºæ™¯ä¸­ï¼Œåˆ™å»ºè®®ä½¿ç”¨å­—å…¸ä»£æ›¿ JOIN æŸ¥è¯¢ã€‚å› ä¸ºåœ¨è¿›è¡Œå¤šè¡¨çš„è¿æ¥æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢ä¼šè½¬æ¢æˆä¸¤ä¸¤è¿æ¥çš„å½¢å¼ï¼Œè€Œè¿™ç§æ»šé›ªçƒå¼çš„æŸ¥è¯¢å¾ˆå¯èƒ½å¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚</strong></p>
<p><strong>2. ç©ºå€¼ç­–ç•¥</strong></p>
<p><strong>åœ¨ä¹‹å‰çš„ä»‹ç»ä¸­ï¼Œè¿æ¥æŸ¥è¯¢çš„ç©ºå€¼ï¼ˆé‚£äº›æœªè¢«è¿æ¥çš„æ•°æ®ï¼‰æ˜¯ç”±é»˜è®¤å€¼å¡«å……çš„ï¼Œè¿™ä¸å…¶ä»–æ•°æ®åº“æ‰€é‡‡å–çš„ç­–ç•¥ä¸åŒï¼ˆç”±Null å¡«å……ï¼‰ã€‚è¿æ¥æŸ¥è¯¢çš„ç©ºå€¼ç­–ç•¥é€šè¿‡ join_use_nulls å‚æ•°æŒ‡å®šçš„ï¼Œé»˜è®¤ä¸º 0ã€‚å½“å‚æ•°å€¼ä¸º 0 æ—¶ï¼Œç©ºå€¼ç”±æ•°æ®ç±»å‹çš„é»˜è®¤å€¼å¡«å……ï¼›è€Œå½“å‚æ•°å€¼ä¸º 1 æ—¶ï¼Œç©ºå€¼ç”± Null å¡«å……ã€‚</strong></p>
<h2 id="WHERE-ä¸-PREWHERE-å­å¥"><a href="#WHERE-ä¸-PREWHERE-å­å¥" class="headerlink" title="WHERE ä¸ PREWHERE å­å¥"></a>WHERE ä¸ PREWHERE å­å¥</h2><p><strong>WHERE å­å¥åŸºäºæ¡ä»¶è¡¨è¾¾å¼æ¥å®ç°æ•°æ®è¿‡æ»¤ï¼Œå¦‚æœè¿‡æ»¤æ¡ä»¶æ°å¥½æ˜¯ä¸»é”®å­—æ®µï¼Œåˆ™èƒ½å¤Ÿè¿›ä¸€æ­¥å€ŸåŠ©ç´¢å¼•è¿‡æ»¤æ•°æ®åŒºé—´ï¼Œä»è€ŒåŠ é€ŸæŸ¥è¯¢ï¼Œæ‰€ä»¥ WHERE å­å¥æ˜¯ä¸€æ¡æŸ¥è¯¢è¯­å¥èƒ½å¦å¯ç”¨ç´¢å¼•çš„åˆ¤æ–­ä¾æ®ï¼Œå‰ææ˜¯è¡¨å¼•æ“æ”¯æŒç´¢å¼•ç‰¹æ€§ã€‚</strong></p>
<p><strong>é™¤äº† WHEREï¼ŒClickHouse è¿˜æ”¯æŒå…¨æ–°çš„ PREWHERE å­å¥ï¼ŒPREWHERE ç›®å‰åªèƒ½ç”¨äº MegeTee ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œå®ƒå¯ä»¥çœ‹ä½œå¯¹æ˜¯ WHERE çš„ä¸€ç§ä¼˜åŒ–ï¼Œå…¶ä½œç”¨ä¸ WHERE ç›¸åŒï¼Œå‡æ˜¯ç”¨æ¥è¿‡æ»¤æ•°æ®ã€‚ä½†å®ƒä»¬çš„ä¸åŒä¹‹å¤„åœ¨äºã€‚ä½¿ç”¨ PREWHERE æ—¶ï¼Œé¦–å…ˆåªä¼šè¯»å– PREWHERE æŒ‡å®šçš„åˆ—å­—æ®µæ•°æ®ï¼Œç”¨äºæ•°æ®è¿‡æ»¤çš„æ¡ä»¶åˆ¤æ–­ã€‚å¾…æ•°æ®è¿‡æ»¤ä¹‹åå†è¯»å– SELECT å£°æ˜çš„åˆ—å­—æ®µä»¥è¡¥å…¨å…¶ä½™å±æ€§ã€‚æ‰€ä»¥åœ¨ä¸€äº›åœºåˆä¸‹ï¼ŒPREWHERE ç›¸æ¯” WHERE è€Œè¨€ï¼Œå¤„ç†çš„æ•°æ®é‡æ›´å°‘ï¼Œæ€§èƒ½æ›´é«˜ã€‚</strong></p>
<p><strong>æ—¢ç„¶ WHERE å­å¥æ€§èƒ½æ›´ä¼˜ï¼Œé‚£ä¹ˆæ˜¯å¦éœ€è¦å°†æ‰€æœ‰çš„ WHERE å­å¥éƒ½æ›¿æ¢æˆ PREWHERE å­å¥å‘¢ï¼Ÿå…¶å®å¤§å¯ä¸å¿…ï¼Œå› ä¸º ClickHouse å®ç°äº†è‡ªæˆ‘ä¼˜åŒ–çš„åŠŸèƒ½ï¼Œä¼šåœ¨æ¡ä»¶åˆé€‚çš„æƒ…å†µä¸‹å°† WHERE æ›¿æ¢ä¸º PREWHEREã€‚å¦‚æœæƒ³å¼€å¯è¿™é¡¹ç‰¹æ€§ï¼Œåªéœ€è¦å°† optimize_move_to_prewhere è®¾ç½®ä¸º 1 å³å¯ï¼Œå½“ç„¶é»˜è®¤å°±ä¸º 1ï¼Œå³å¼€å¯çŠ¶æ€ã€‚</strong></p>
<p><strong>ä½†å‡¡äº‹ä¹Ÿæœ‰ä¾‹å¤–ï¼Œä»¥ä¸‹æƒ…å½¢ä¸ä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼š</strong></p>
<p><strong>1ï¼‰ä½¿ç”¨äº†å¸¸é‡è¡¨è¾¾å¼ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, code <span class="keyword">FROM</span> tbl <span class="keyword">WHERE</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰ä½¿ç”¨äº†é»˜è®¤å€¼ä¸º ALIAS ç±»å‹çš„å­—æ®µï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å‡è®¾ code çš„é»˜è®¤å€¼ç±»å‹æ˜¯ ALIAS</span></span><br><span class="line"><span class="keyword">SELECT</span> id, code <span class="keyword">FROM</span> tbl <span class="keyword">WHERE</span> code <span class="operator">=</span> <span class="string">&#x27;A000&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰åŒ…å«äº† arrayJoinã€globalInã€globalNotIn æˆ–è€… indexHint æŸ¥è¯¢çš„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> title, nested.v1, nested.v2 <span class="keyword">FROM</span> tbl <span class="keyword">ARRAY</span> <span class="keyword">JOIN</span> nested <span class="keyword">WHERE</span> nested.v1 <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>4ï¼‰SELECT æŸ¥è¯¢çš„åˆ—å­—æ®µå’Œ WHERE è°“è¯ç›¸åŒï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> v3 <span class="keyword">FROM</span> tbl <span class="keyword">WHERE</span> v3 <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰ä½¿ç”¨äº†ä¸»é”®å­—æ®µï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> tbl <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;A000&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>è™½ç„¶åœ¨ä¸Šè¿°æƒ…å½¢ä¸­ ClickHouse ä¸ä¼šè‡ªåŠ¨å°†è°“è¯ç§»åŠ¨åˆ° PREWHEREï¼Œä½†ä»ç„¶å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ PREWHEREã€‚ä»¥ä¸»é”®å­—æ®µä¸ºä¾‹ï¼Œå½“ä½¿ç”¨ PREWHERE è¿›è¡Œä¸»é”®æŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆä¼šé€šè¿‡ç¨€ç–ç´¢å¼•è¿‡æ»¤æ•°æ®åŒºé—´ï¼ˆindex_granularity ç²’åº¦ï¼‰ï¼Œæ¥ç€ä¼šè¯»å– PREWHERE æŒ‡å®šçš„æ¡ä»¶åˆ—è¿›ä¸€æ­¥è¿‡æ»¤ï¼Œè¿™æ ·ä¸€æ¥å°±æœ‰å¯èƒ½æˆªæ‰æ•°æ®åŒºé—´çš„å°¾å·´ï¼Œä»è€Œè¿”å›ä½äº index_granularity ç²’åº¦çš„æ•°æ®èŒƒå›´ã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œç›¸æ¯”å…¶ä»–åœºåˆç§»åŠ¨è°“è¯æ‰€å¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œè¿™ç±»æ•ˆæœè¿˜æ˜¯æ¯”è¾ƒæœ‰é™çš„ï¼Œæ‰€ä»¥ç›®å‰ ClickHouse åœ¨è¿™ç±»åœºåˆä¸‹ä»ç„¶ä¿æŒä¸ç§»åŠ¨çš„å¤„ç†æ–¹å¼ã€‚</strong></p>
<h2 id="GROUP-BY-å­å¥"><a href="#GROUP-BY-å­å¥" class="headerlink" title="GROUP BY å­å¥"></a>GROUP BY å­å¥</h2><p><strong>GROUP BY åˆç§°èšåˆæŸ¥è¯¢ï¼Œæ˜¯æœ€å¸¸ç”¨çš„å­å¥ä¹‹ä¸€ï¼Œå®ƒæ˜¯è®© ClickHouse æœ€å‡¸æ˜¾å“è¶Šæ€§èƒ½çš„åœ°æ–¹ã€‚åœ¨ GROUP BY åå£°æ˜çš„è¡¨è¾¾å¼ï¼Œé€šå¸¸ç§°ä¸ºèšåˆé”®æˆ–è€… Keyï¼Œæ•°æ®ä¼šæŒ‰ç…§èšåˆé”®è¿›è¡Œèšåˆã€‚ClickHouse çš„èšåˆæŸ¥è¯¢ä¸­ï¼Œå’Œå…³ç³»å‹æ•°æ®åº“ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åªæœ‰èšåˆå‡½æ•°ï¼Œå¯ä»¥çœç•¥ GROUP BY</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(data_compressed_bytes) <span class="keyword">AS</span> compressed,</span><br><span class="line">       <span class="built_in">sum</span>(data_uncompressed_bytes) <span class="keyword">AS</span> undata_compressed_bytes</span><br><span class="line"><span class="keyword">FROM</span> system.parts;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SELECT å­å¥ä¸­çš„å­—æ®µè¦ä¹ˆå‡ºç°åœ¨ GROUP BY å­å¥ä¸­ï¼Œè¦ä¹ˆå‡ºç°åœ¨èšåˆå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">table</span>, <span class="built_in">count</span>() <span class="keyword">FROM</span> system.parts <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”™è¯¯çš„è¯­æ³•ï¼Œrows æ—¢æ²¡æœ‰å‡ºç°åœ¨ GROUP BY ä¸­ï¼Œä¹Ÿæ²¡æœ‰å‡ºç°åœ¨èšåˆå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">table</span>, <span class="built_in">count</span>(), <span class="keyword">rows</span>() <span class="keyword">FROM</span> system.parts <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœèšåˆé”®å¯¹åº”çš„åˆ—åŒ…å« Null å€¼ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ Null ä¼šè¢«å½’ä¸ºåŒä¸€ç»„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155652085-2037142784.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°æ‰€æœ‰çš„ Null è¢«åˆ†ä¸ºäº†ä¸€ç»„ï¼Œä½†æ˜¯æ³¨æ„ï¼šcount(å­—æ®µ) ä¸ä¼šæŠŠ Null è®¡ç®—åœ¨å†…ï¼Œæ‰€ä»¥ç›´æ¥ count() å°±è¡Œã€‚</strong></p>
<p><strong>æ¯”è¾ƒç®€å•ï¼Œä½†é™¤äº†ä¸Šè¿°ç‰¹æ€§ä¹‹å¤–ï¼ŒèšåˆæŸ¥è¯¢è¿˜èƒ½é…åˆ WITH ROLLUPã€WITH CUBEã€WITH TOTALS ä¸‰ç§ä¿®é¥°ç¬¦è·å–é¢å¤–çš„æ±‡æ€»ä¿¡æ¯ã€‚</strong></p>
<h4 id="WITH-ROLLUP"><a href="#WITH-ROLLUP" class="headerlink" title="WITH ROLLUP"></a>WITH ROLLUP</h4><p><strong>æµ‹è¯•æ•°æ®å¦‚ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155645759-481178151.png" alt="img"></p>
<p><strong>ä»¥ä¸Šæ˜¯æ™®é€šçš„ GROUP BYï¼Œæ²¡ä»€ä¹ˆéš¾çš„ï¼Œç„¶åçœ‹çœ‹å®ƒå’Œ WITH ROLLUP æ­é…ä¼šæœ‰ä»€ä¹ˆæ•ˆæœï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155638394-350610817.png" alt="img"></p>
<p><strong>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¤šäº†å››æ¡æ•°æ®ï¼Œä¸Šé¢ä¸‰æ¡ï¼Œå°±æ˜¯æŒ‰ç…§ productã€channel æ±‡æ€»ä¹‹åï¼Œå†å•ç‹¬æŒ‰ product æ±‡æ€»ï¼Œè€Œæ­¤æ—¶ä¼šç»™å¯¹åº”çš„ channel è®¾ä¸ºé›¶å€¼ï¼ˆè¿™é‡Œæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå…³ç³»å‹æ•°æ®åº“ä¸­ä¸º Nullï¼‰ã€‚åŒç†æœ€åä¸€æ¡æ•°æ®æ˜¯å…¨é‡æ±‡æ€»ï¼Œä¸éœ€è¦æŒ‡å®š product å’Œ channelï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸º product å’Œ channel éƒ½æ˜¾ç¤ºä¸ºé›¶å€¼ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™å°±ç›¸å½“äºæŒ‰ç…§ product å•ç‹¬èšåˆç„¶åå†è‡ªåŠ¨æ‹¼æ¥åœ¨ä¸Šé¢äº†ï¼Œæ’å¥½åºï¼Œå¹¶ä¸”è‡ªåŠ¨å°† channel èµ‹å€¼ä¸ºé›¶å€¼ï¼ŒåŒç†æœ€åä¸€æ¡æ•°æ®ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å†™å¤šä¸ªè¯­å¥ï¼Œç„¶åé€šè¿‡ UNION ä¹Ÿèƒ½å®ç°ä¸Šé¢çš„æ•ˆæœï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ã€‚ä½†æ˜¯ ClickHouse æä¾›äº† WITH ROLLUP è¿™ä¸ªéå¸¸æ–¹ä¾¿çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±è¦åˆ©ç”¨å¥½å®ƒã€‚</strong></p>
<blockquote>
<p><strong>GROUP BY å­å¥åŠ ä¸Š WITH ROLLUP é€‰é¡¹æ—¶ï¼Œé¦–å…ˆæŒ‰ç…§å…¨éƒ¨çš„åˆ†ç»„å­—æ®µè¿›è¡Œåˆ†ç»„æ±‡æ€»ï¼›ç„¶åä»å³å¾€å·¦ä¾æ¬¡å»æ‰ä¸€ä¸ªåˆ†ç»„å­—æ®µå†è¿›è¡Œåˆ†ç»„æ±‡æ€»ï¼Œè¢«å»æ‰çš„å­—æ®µæ˜¾ç¤ºä¸ºé›¶å€¼ï¼›æœ€åï¼Œå°†æ‰€æœ‰çš„æ•°æ®è¿›è¡Œä¸€æ¬¡æ±‡æ€»ï¼Œæ‰€æœ‰çš„åˆ†ç»„å­—æ®µéƒ½æ˜¾ç¤ºä¸ºé›¶å€¼ã€‚</strong></p>
</blockquote>
<h4 id="WITH-CUBE"><a href="#WITH-CUBE" class="headerlink" title="WITH CUBE"></a>WITH CUBE</h4><p><strong>CUBE ä»£è¡¨ç«‹æ–¹ä½“ï¼Œå®ƒç”¨äºå¯¹åˆ†ç»„å­—æ®µè¿›è¡Œå„ç§å¯èƒ½çš„ç»„åˆï¼Œèƒ½å¤Ÿäº§ç”Ÿå¤šç»´åº¦çš„äº¤å‰ç»Ÿè®¡ç»“æœï¼ŒCUBE é€šå¸¸ç”¨äºæ•°æ®ä»“åº“ä¸­çš„äº¤å‰æŠ¥è¡¨åˆ†æã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155630214-2072640677.png" alt="img"></p>
<p><strong>ä»ä»¥ä¸Šç»“æœå¯ä»¥çœ‹å‡ºï¼ŒCUBE è¿”å›äº†æ›´å¤šçš„åˆ†ç»„æ•°æ®ï¼Œå…¶ä¸­ä¸ä»…åŒ…å«äº† ROLLUP æ±‡æ€»çš„ç»“æœï¼Œè¿˜åŒ…å«äº†ç›¸å½“äºæŒ‰ç…§ channel è¿›è¡Œèšåˆçš„è®°å½•ã€‚å› æ­¤éšç€åˆ†ç»„å­—æ®µçš„å¢åŠ ï¼ŒCUBE äº§ç”Ÿçš„ç»„åˆå°†ä¼šå‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚</strong></p>
<h4 id="WITH-TOTALS"><a href="#WITH-TOTALS" class="headerlink" title="WITH TOTALS"></a>WITH TOTALS</h4><p><strong>WITH TOTALS åè€Œæ˜¯æœ€ç®€å•çš„ï¼ŒåªåŒ…å«ä¸€ä¸ªå…¨å±€æ±‡æ€»çš„ç»“æœã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155623477-1060377326.png" alt="img"></p>
<h2 id="HAVING-å­å¥"><a href="#HAVING-å­å¥" class="headerlink" title="HAVING å­å¥"></a>HAVING å­å¥</h2><p><strong>HAVING å­å¥è¦å’Œ GROUP BY å­å¥åŒæ—¶å‡ºç°ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå®ƒèƒ½å¤Ÿåœ¨èšåˆè®¡ç®—ä¹‹åå®ç°æ•°æ®çš„äºŒæ¬¡è¿‡æ»¤ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155618015-611567566.png" alt="img"></p>
<p><strong>å¯¹äºä¸Šé¢çš„æ —å­ï¼Œä½¿ç”¨ WHERE æ¯”ä½¿ç”¨ HAVING çš„æ•ˆç‡æ›´é«˜ï¼Œå› ä¸º WHERE ç­‰åŒäºä½¿ç”¨äº†è°“è¯ä¸‹æ¨ï¼Œåœ¨èšåˆä¹‹å‰å°±å‡å°‘äº†æ•°æ®è¿‡æ»¤ï¼Œä»è€Œå‡å°‘äº†åç»­èšåˆæ—¶éœ€è¦å¤„ç†çš„æ•°æ®é‡ã€‚</strong></p>
<p><strong>æ‰€ä»¥ä½¿ç”¨ HAVING è¿›è¡Œè¿‡æ»¤ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯å¯¹èšåˆä¹‹åçš„ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚å¦‚æœä¸æ˜¯èšåˆä¹‹åçš„ï¼Œé‚£ä¹ˆä½¿ç”¨ WHERE å°±å¥½ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155609969-370614629.png" alt="img"></p>
<p><strong>å› ä¸º WHERE çš„ä¼˜å…ˆçº§å¤§äº GROUP BYï¼Œæ‰€ä»¥å¦‚æœæŒ‰ç…§èšåˆå€¼è¿›è¡Œç»Ÿè®¡ï¼Œé‚£ä¹ˆå°±å¿…é¡»è¦å€ŸåŠ©äº HAVINGã€‚</strong></p>
<h2 id="ORDER-BY-å­å¥"><a href="#ORDER-BY-å­å¥" class="headerlink" title="ORDER BY å­å¥"></a>ORDER BY å­å¥</h2><p><strong>ORDER BYå­å¥é€šè¿‡å£°æ˜æ’åºé”®æ¥æŒ‡å®šæŸ¥è¯¢æ•°æ®è¿”å›çš„é¡ºåºï¼Œé€šè¿‡å…ˆå‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ MergeTree è¡¨å¼•æ“ä¸­ä¹Ÿæœ‰ ORDER BY å‚æ•°ç”¨äºæŒ‡å®šæ’åºé”®ï¼Œé‚£ä¹ˆè¿™ä¸¤è€…æœ‰ä½•ä¸åŒå‘¢ï¼Ÿåœ¨ MergeTree ä¸­æŒ‡å®š ORDER BY åï¼Œæ•°æ®åœ¨å„ä¸ªåˆ†åŒºå†…ä¼šæŒ‰ç…§å…¶å®šä¹‰çš„è§„åˆ™æ’åºï¼Œè¿™æ˜¯ä¸€ç§åˆ†åŒºå†…çš„å±€éƒ¨æ’åºã€‚å¦‚æœåœ¨æŸ¥è¯¢æ—¶æ•°æ®è·¨è¶Šäº†å¤šä¸ªåˆ†åŒºï¼Œåˆ™å®ƒä»¬çš„è¿”å›é¡ºåºæ˜¯æ— æ³•é¢„çŸ¥çš„ï¼Œæ¯ä¸€æ¬¡æŸ¥è¯¢è¿”å›çš„é¡ºåºéƒ½æœ‰å¯èƒ½ä¸åŒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœéœ€è¦æ•°æ®æ€»æ˜¯èƒ½å¤ŸæŒ‰ç…§æœŸæœ›çš„é¡ºåºèŒƒå›´ï¼Œå°±éœ€è¦å€ŸåŠ© ORDER BY å­å¥æ¥æŒ‡å®šå…¨å±€é¡ºåºã€‚</strong></p>
<p><strong>ORDER BY åœ¨ä½¿ç”¨æ—¶å¯ä»¥å®šä¹‰å¤šä¸ªæ’åºé”®ï¼Œæ¯ä¸ªæ’åºé”®åéœ€ç´§è·Ÿ ASCï¼ˆå‡åºï¼‰æˆ–  DESCï¼ˆé™åºï¼‰æ¥ç¡®å®šæ’åˆ—é¡ºåºã€‚å¦‚è‹¥ä¸å†™ï¼Œåˆ™é»˜è®¤ä¸º ASCã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¸¤æ¡è¯­å¥å³æ˜¯ç­‰ä»·çš„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl <span class="keyword">ORDER</span> <span class="keyword">BY</span> v1 <span class="keyword">ASC</span>, v2 <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tbl <span class="keyword">ORDER</span> <span class="keyword">BY</span> v1, v2 <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®é¦–å…ˆä¼šæŒ‰ç…§ v1 å‡åºï¼Œå¦‚æœ v1 å­—æ®µä¸­å‡ºç°äº†ç›¸åŒçš„å€¼ï¼Œé‚£ä¹ˆå†æŒ‰ç…§ v2 é™åºã€‚</strong></p>
<p><strong>ç„¶åæ˜¯ Null å€¼çš„æ’åºï¼Œç›®å‰ ClickHouse æœ‰ Null å€¼æœ€åå’Œ Null å€¼æœ€å‰ä¸¤ç§ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹è¿›è¡Œè®¾ç½®ï¼š</strong></p>
<h4 id="1-NULLS-LAST"><a href="#1-NULLS-LAST" class="headerlink" title="1. NULLS LAST"></a>1. NULLS LAST</h4><p><strong>Null å€¼æ’åœ¨æœ€åï¼Œæ— è®ºå‡åºè¿˜æ˜¯é™åºï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„è¡Œä¸ºã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">value -&gt; NaN -&gt; Null</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155600186-1068645033.png" alt="img"></p>
<h4 id="2-NULLS-FIRST"><a href="#2-NULLS-FIRST" class="headerlink" title="2. NULLS FIRST"></a>2. NULLS FIRST</h4><p><strong>Null å€¼æ’åœ¨æœ€åï¼Œæ— è®ºå‡åºè¿˜æ˜¯é™åºã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NULL -&gt; NaN -&gt; value</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155551570-1492398706.png" alt="img"></p>
<p><strong>ç»è¿‡æµ‹è¯•ä¸éš¾å‘ç°ï¼Œå¯¹äº NaN è€Œè¨€ï¼Œå®ƒæ€»æ˜¯è·Ÿåœ¨ Null çš„èº«è¾¹ã€‚</strong></p>
<h2 id="LIMIT-BY-å­å¥"><a href="#LIMIT-BY-å­å¥" class="headerlink" title="LIMIT BY å­å¥"></a>LIMIT BY å­å¥</h2><p><strong>LIMIT BY å­å¥å’Œå¤§å®¶å¸¸è§çš„ LIMIT æœ‰æ‰€ä¸åŒï¼Œå®ƒè¿è¡Œäº ORDER BY ä¹‹åå’Œ LIMIT ä¹‹å‰ï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§æŒ‡å®šåˆ†ç»„ï¼Œæœ€å¤šè¿”å›å‰ n è¡Œæ•°æ®ï¼ˆå°‘äº n è¡Œåˆ™æŒ‰ç…§å®é™…æ•°é‡è¿”å›ï¼‰ï¼Œå¸¸ç”¨äº TOP N çš„æŸ¥è¯¢åœºæ™¯ã€‚LIMIT BY è¯­æ³•è§„åˆ™å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LIMIT n BY express</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ªäººè§‰å¾—è¿™ä¸ª LIMIT BY éå¸¸å¼ºå¤§ï¼Œæˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155503458-270715071.png" alt="img"></p>
<p><strong>å½“ç„¶èšåˆä¹‹åæ²¡æœ‰æ’åºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ’ä¸€ä¸‹åºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    product,</span><br><span class="line">    channel,</span><br><span class="line">    <span class="built_in">sum</span>(amount) <span class="keyword">AS</span> amount</span><br><span class="line"><span class="keyword">FROM</span> sales_data</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    product,</span><br><span class="line">    channel</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount <span class="keyword">ASC</span></span><br><span class="line">LIMIT <span class="number">1</span> <span class="keyword">BY</span> channel</span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶ä¼šé€‰æ‹©æ¯ä¸ªæ¸ é“å¯¹åº”çš„é‡‘é¢æœ€é«˜çš„æ•°æ®ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ LIMIT å¤šæ¡æ•°æ®ã€ä¹Ÿå¯ä»¥ BY å¤šä¸ªå­—æ®µã€‚è¿™ä¸ªåŠŸèƒ½å¯ä»¥è¯´æ˜¯éå¸¸å¸¸ç”¨äº†ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ LIMITï¼Œä¸€èˆ¬æ˜¯å…¨å±€æ’åºä¹‹åé€‰æ‹©å‰ N æ¡æ•°æ®ï¼Œè€Œè¿™é‡Œçš„ LIMIT BY æ˜¯æŒ‰ç…§æŒ‡å®šçš„å­—æ®µåˆ†ç»„ï¼Œç„¶åæ¯ä¸€ç»„é€‰æ‹©å‰ N æ¡æ•°æ®ã€‚</strong></p>
<blockquote>
<p><strong>LIMIT BY ä¼šä»ä¸Šå¾€ä¸‹åœ¨æ¯ä¸ªç»„ä¸­é€‰æ‹©æŒ‡å®šæ¡æ•°çš„æ•°æ®ï¼Œå› æ­¤ä½¿ç”¨ LIMIT BY åº”è¯¥åŒæ—¶æŒ‡å®š ORDER BYï¼Œå¦åˆ™æ‹¿å‡ºçš„æ•°æ®æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œé™¤éæ•°æ®æœ¬èº«å°±æ˜¯æœ‰åºçš„ã€‚</strong></p>
</blockquote>
<p><strong>å½“ç„¶ LIMIT BY ä¹Ÿå¯ä»¥æŒ‡å®šåç§»é‡ï¼Œå› ä¸ºä¸ä¸€å®šä»ä¸€æ¡å¼€å§‹é€‰æ‹©ï¼Œè€ŒæŒ‡å®šåç§»é‡æœ‰ä¸¤ç§æ–¹å¼ï¼š</strong></p>
<ul>
<li><code>LIMIT N OFFSET M BY ...</code></li>
<li><code>LIMIT M, N BY ...</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155452951-107038302.png" alt="img"></p>
<h2 id="LIMIT-å­å¥"><a href="#LIMIT-å­å¥" class="headerlink" title="LIMIT å­å¥"></a>LIMIT å­å¥</h2><p><strong>LIMIT å­å¥ç”¨äºè¿”å›æŒ‡å®šçš„å‰ N è¡Œæ•°æ®ï¼Œå¸¸ç”¨äºåˆ†é¡µåœºæ™¯ï¼Œå®ƒçš„ä¸‰ç§è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">LIMIT N</span><br><span class="line">LIMIT N <span class="keyword">OFFSET</span> M</span><br><span class="line">LIMIT M, N</span><br></pre></td></tr></table></figure>

<p><strong>ç”¨æ³•å’Œ LIMIT BY ä¸­çš„ LIMIT ä¸€è‡´ï¼Œå¦‚æœæŠŠ LIMIT BY ä¸­çš„ BY å»æ‰ï¼Œé‚£ä¹ˆå°±å˜æˆäº† LIMITã€‚æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç”¨ä¸€å¼ å›¾æ¥ä»‹ç»ä¸€ä¸‹ LIMIT å’Œ LIMIT BY ä¹‹å‰çš„å…³ç³»ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155444441-40300823.png" alt="img"></p>
<p><strong>æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ LIMIT çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœæ•°æ®è·¨è¶Šäº†å¤šä¸ªåˆ†åŒºï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰ä½¿ç”¨ ORDER BY æŒ‡å®šå…¨å±€é¡ºåºçš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡ LIMIT æŸ¥è¯¢æ‰€è¿”å›çš„æ•°æ®å¯èƒ½æœ‰æ‰€ä¸åŒã€‚å¦‚æœå¯¹è¿”å›çš„æ•°æ®çš„é¡ºåºæ¯”è¾ƒæ•æ„Ÿï¼Œåˆ™åº”æ­é… ORDER BY ä¸€èµ·ä½¿ç”¨ã€‚</strong></p>
<h2 id="SELECT-å’Œ-DISTINCT-å­å¥"><a href="#SELECT-å’Œ-DISTINCT-å­å¥" class="headerlink" title="SELECT å’Œ DISTINCT å­å¥"></a>SELECT å’Œ DISTINCT å­å¥</h2><p><strong>SELECT å­å¥å†³å®šäº†ä¸€æ¬¡æŸ¥è¯¢è¯­å¥æœ€ç»ˆèƒ½è¿”å›å“ªäº›å­—æ®µæˆ–è¡¨è¾¾å¼ï¼Œä¸ç›´è§‚æ„Ÿå—ä¸åŒï¼Œè™½ç„¶ SELECT ä½äº SQL è¯­å¥çš„èµ·å§‹ä½ç½®ï¼Œä½†å®ƒçš„æ‰§è¡Œçš„é¡ºåºå´æ’åœ¨äº†ä¸Šé¢ä»‹ç»çš„æ‰€æœ‰å­å¥çš„åé¢ã€‚åœ¨å…¶å®ƒå­å¥æ‰§è¡Œä¹‹åï¼ŒSELECT ä¼šå°†é€‰å–çš„å­—æ®µæˆ–è¡¨è¾¾å¼ä½œç”¨äºæ¯è¡Œæ•°æ®ä¹‹ä¸Šï¼Œå¦‚æœä½¿ç”¨ * é€šé…ç¬¦ï¼Œåˆ™ä¼šè¿”å›æ‰€æœ‰å­—æ®µã€‚ä½†æ­£å¦‚å¼€ç¯‡æ‰€è¨€ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºå¯¹äºä¸€æ¬¾åˆ—å¼å­˜å‚¨æ•°æ®åº“è€Œè¨€ï¼Œè¿™ç»å¯¹æ˜¯åŠ£åŠ¿è€Œä¸æ˜¯ä¼˜åŠ¿ï¼ˆæˆ‘ä»¬è¿™é‡Œåœ¨å­¦ä¹ çš„è¿‡ç¨‹å°±ä¸ç®—äº†ï¼‰ã€‚</strong></p>
<p><strong>åœ¨é€‰æ‹©åˆ—å­—æ®µæ—¶ï¼ŒClickHouse è¿˜ä¸ºç‰¹å®šåœºæ™¯æä¾›äº†ä¸€ç§åŸºäºæ­£åˆ™æŸ¥è¯¢çš„å½¢å¼ï¼Œä¾‹å¦‚ä¸‹é¢ä¼šé€‰æ‹©ä»¥ n å¼€å¤´å’ŒåŒ…å«å­—æ¯ p çš„å­—æ®µï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> COLUMNS(<span class="string">&#x27;^n&#x27;</span>), COLUMNS(<span class="string">&#x27;p&#x27;</span>) <span class="keyword">FROM</span> system.databases</span><br></pre></td></tr></table></figure>

<p><strong>DISTINCT å­å¥èƒ½å¤Ÿå»é™¤é‡å¤æ•°æ®ï¼Œä½¿ç”¨åœºæ™¯ä¹Ÿå¾ˆå¹¿æ³›ï¼Œå¾ˆå¤šäººç»å¸¸ä¼šæ‹¿å®ƒå’Œ GROUP BY è¿›è¡Œå¯¹æ¯”ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155436201-311425704.png" alt="img"></p>
<p><strong>è™½ç„¶é¡ºåºä¸åŒï¼Œä½†æ˜¾ç„¶ç»“æœé›†çš„å†…å®¹æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆè¿™ä¸¤è€…ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå¦‚æœè§‚å¯Ÿå®ƒä»¬çš„æ‰§è¡Œè®¡åˆ’ï¼ˆåé¢ä¼šè¯´ï¼‰ä¸éš¾å‘ç°ï¼ŒDISTINCT å­å¥çš„æ‰§è¡Œè®¡åˆ’ä¼šæ›´åŠ ç®€å•ï¼Œä¸æ­¤åŒæ—¶ï¼ŒDISTINCT ä¹Ÿèƒ½å¤Ÿå’Œ GROUP BY æ­é…ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯äº’è¡¥è€Œä¸æ˜¯äº’æ–¥çš„å…³ç³»ã€‚</strong></p>
<p><strong>å¦å¤–ï¼Œå¦‚æœä½¿ç”¨äº† LIMIT ä¸”æ²¡æœ‰ ORDER BY å­å¥ï¼Œé‚£ä¹ˆ DISTINCT åœ¨æ»¡è¶³æ¡ä»¶æ—¶èƒ½å¤Ÿç«‹å³ç»“æŸæŸ¥è¯¢ã€‚å‡è®¾æˆ‘åªéœ€è¦å»é‡ä¹‹åçš„å‰ä¸‰æ¡æ•°æ®ï¼Œé‚£ä¹ˆ GROUP BY ä¼šå¯¹å…¨ä½“æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå†é€‰æ‹©å‰ä¸‰æ¡ï¼›è€Œ DISTINCT åœ¨å»é‡æ—¶å‘ç°å·²ç»æœ‰ä¸‰æ¡äº†ï¼Œäºæ˜¯ç›´æ¥è¿”å›ï¼Œåé¢çš„æ•°æ®å°±ä¸éœ€è¦çœ‹äº†ï¼Œå› ä¸ºçœ‹äº†ä¹Ÿæ²¡æ„ä¹‰ï¼ŒLIMIT å†³å®šäº†åªè¿”å›ä¸‰æ¡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155429111-1453572753.png" alt="img"></p>
<p><strong>ä¸¤ä¸ªæŸ¥è¯¢è¿”å›çš„ç»“æœé›†ä¸ä¸€æ ·ï¼Œè¿™æ˜¯å› ä¸º GROUP BY å’Œ DISTINCT å¤„ç†æ•°æ®çš„é¡ºåºä¸åŒã€‚ä¸€å¼€å§‹æˆ‘ä»¬å°±çœ‹åˆ°äº†ï¼Œå¦‚æœæ²¡æœ‰ LIMITï¼Œé‚£ä¹ˆä¸¤ä¸ªç»“æœé›†é¡ºåºä¸åŒï¼Œä½†å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯è¿™é‡ŒåŠ äº† LIMITï¼Œæ‰€ä»¥ç›¸å½“äºé€‰æ‹©äº†ç›¸åŒå†…å®¹çš„ä¸åŒéƒ¨åˆ†ã€‚</strong></p>
<p><strong>å¦‚æœæœ‰ ORDER BYï¼Œé‚£ä¹ˆä¼šå…ˆæ‰§è¡Œ DISTINCTï¼Œå†æ‰§è¡Œ ORDER BYã€‚å¹¶ä¸”å¯¹äº Null è€Œè¨€ï¼Œå¦‚æœæœ‰å¤šä¸ª Nullï¼Œé‚£ä¹ˆ DISTINCT ä¹‹ååªä¼šä¿ç•™ä¸€ä¸ª Nullã€‚</strong></p>
<h2 id="UNION-ALL-å­å¥"><a href="#UNION-ALL-å­å¥" class="headerlink" title="UNION ALL å­å¥"></a>UNION ALL å­å¥</h2><p><strong>UNION ALL å­å¥èƒ½å¤Ÿè”åˆå·¦å³ä¸¤è¾¹çš„ä¸¤ç»„å­æŸ¥è¯¢ï¼Œå°†ç»“æœä¸€å¹¶è¿”å›ã€‚åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­å¯ä»¥å£°æ˜å¤šæ¬¡ UNION ALL ä»¥ä¾¿è”åˆå¤šç»„æŸ¥è¯¢ï¼Œä½† UNION ALL ä¸èƒ½ç›´æ¥ä½¿ç”¨å…¶ä»–å­å¥ï¼ˆä¾‹å¦‚ ORDER BYã€LIMIT ç­‰ï¼‰ï¼Œè¿™äº›å­å¥åªèƒ½åœ¨å®ƒè”åˆçš„å­æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name, v1 <span class="keyword">FROM</span> union_v1</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> title, v1 <span class="keyword">FROM</span> union_v1</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹äº UNION ALL ä¸¤ä¾§çš„å­æŸ¥è¯¢æœ‰ä»¥ä¸‹å‡ ç‚¹ä¿¡æ¯ï¼šé¦–å…ˆï¼Œåˆ—å­—æ®µçš„æ•°é‡å¿…é¡»ç›¸åŒï¼›å…¶æ¬¡ï¼Œåˆ—å­—æ®µçš„æ•°æ®ç±»å‹å¿…é¡»ç›¸åŒæˆ–ç›¸å…¼å®¹ï¼›æœ€åï¼Œåˆ—å­—æ®µçš„åç§°å¯ä»¥ä¸åŒï¼ŒæŸ¥è¯¢ç»“æœä¸­çš„åˆ—åä¼šä»¥å·¦è¾¹çš„å­æŸ¥è¯¢ä¸ºå‡†ã€‚</strong></p>
<p><strong>å¯¹äºè”åˆæŸ¥è¯¢è¿˜æœ‰ä¸€ç‚¹è¦è¯´æ˜ï¼Œç›®å‰ ClickHouse åªæ”¯æŒ UNION ALL å­å¥ï¼Œå¦‚æœæƒ³å¾—åˆ° UNION DISTINCT å­å¥çš„æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨åµŒå¥—æŸ¥è¯¢æ¥å˜ç›¸å®ç°ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> name <span class="keyword">FROM</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> name, v1 <span class="keyword">FROM</span> union_v1</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> title, v1 <span class="keyword">FROM</span> union_v1</span><br><span class="line">)    </span><br></pre></td></tr></table></figure>

<h2 id="SAMPLE-å­å¥"><a href="#SAMPLE-å­å¥" class="headerlink" title="SAMPLE å­å¥"></a>SAMPLE å­å¥</h2><p><strong>SAMPLE å­å¥èƒ½å¤Ÿå®ç°æ•°æ®é‡‡æ ·çš„åŠŸèƒ½ï¼Œä½¿æŸ¥è¯¢ä»…è¿”å›é‡‡æ ·æ•°æ®è€Œä¸æ˜¯å…¨éƒ¨æ•°æ®ï¼Œä»é¢æœ‰æ•ˆå‡å°‘æŸ¥è¯¢è´Ÿè½½ã€‚SAMPLE å­å¥çš„é‡‡æ ·æœºåˆ¶æ˜¯ä¸€ç§å¹‚ç­‰è®¾è®¡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ•°æ®ä¸å‘ç”Ÿå˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç›¸åŒçš„é‡‡æ ·è§„åˆ™æ€»æ˜¯èƒ½ç­‰è¿”å›ç›¸åŒçš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é¡¹ç‰¹æ€§éå¸¸é€‚åˆåœ¨é‚£äº›å¯ä»¥æ¥å—è¿‘ä¼¼æŸ¥è¯¢ç»“æœçš„åœºåˆä½¿ç”¨ã€‚ä¾‹å¦‚åœ¨æ•°æ®é‡ååˆ†å·¨å¤§çš„æƒ…å†µä¸‹ï¼Œå¯¹æŸ¥è¯¢æ—¶æ•ˆæ€§çš„è¦æ±‚å¤§äºå‡†ç¡®æ€§æ—¶å°±å¯ä»¥å°è¯•ä½¿ç”¨ SAMPLE å­å¥ã€‚</strong></p>
<p><strong>SAMPLE å­å¥åªèƒ½ç”¨äº MergeTree ç³»åˆ—å¼•æ“çš„æ•°æ®è¡¨ï¼Œå¹¶ä¸”è¦æ±‚åœ¨ CREATE TABLE æ—¶å£°æ˜ SAMPLE BY è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hits_v1 (</span><br><span class="line">    CounterID UInt64,</span><br><span class="line">    EventDate <span class="type">Date</span>,</span><br><span class="line">    UserID UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, intHash32(UserID))</span><br><span class="line"><span class="comment">-- SAMPLE BY å£°æ˜çš„è¡¨è¾¾å¼å¿…é¡»è¦åŒ…å«åœ¨ä¸»é”®çš„å£°æ˜ä¸­</span></span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br></pre></td></tr></table></figure>

<p><strong>SAMPLE BY è¡¨ç¤º hits_v1å†…çš„æ•°æ®ï¼Œå¯ä»¥æŒ‰ç…§ intHash32(UserID) åˆ†å¸ƒåçš„ç»“æœé‡‡æ ·æŸ¥è¯¢ã€‚ä½†éœ€è¦æ³¨æ„ï¼šSAMPLE BY æ‰€å£°æ˜çš„è¡¨è¾¾å¼å¿…é¡»åŒæ—¶åŒ…å«åœ¨ä¸»é”®çš„å£°æ˜å†…ï¼Œå¹¶ä¸”é€‰æ‹©çš„å­—æ®µå¿…é¡»æ˜¯ Int ç±»å‹ï¼Œå¦‚æœä¸æ˜¯ ClickHouse åœ¨å»ºè¡¨çš„æ—¶å€™ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œä½†æŸ¥è¯¢çš„æ—¶å€™ä¼šå‡ºå¼‚å¸¸ã€‚</strong></p>
<p><strong>SAMPLE å­å¥ç›®å‰æ”¯æŒå¦‚ä¸‹ 3 ç§ç”¨æ³•ï¼š</strong></p>
<h4 id="1-SAMPLE-factor"><a href="#1-SAMPLE-factor" class="headerlink" title="1. SAMPLE factor"></a>1. SAMPLE factor</h4><p><strong>SAMPLE factor è¡¨ç¤ºæŒ‰å› å­ç³»æ•°é‡‡æ ·ï¼Œå…¶ä¸­ factor è¡¨ç¤ºé‡‡æ ·å› å­ï¼Œå®ƒçš„å–å€¼æ”¯æŒ0~1 ä¹‹é—´çš„å°æ•°ã€‚å¦‚æœ factor è®¾ç½®ä¸º 0 æˆ–è€… 1ï¼Œåˆ™æ•ˆæœç­‰åŒäºä¸è¿›è¡Œæ•°æ®é‡‡æ ·ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CounterID <span class="keyword">FROM</span> hits_v1 SAMPLE <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<p><strong>factor ä¹Ÿæ”¯æŒä½¿ç”¨åè¿›åˆ¶çš„å½¢å¼è¡¨è¿°ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CounterID <span class="keyword">FROM</span> hits_v1 SAMPLE <span class="number">1</span> <span class="operator">/</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœåœ¨è¿›è¡Œç»Ÿè®¡æŸ¥è¯¢æ—¶ï¼Œä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„è¿‘ä¼¼ç»“æœï¼Œéœ€è¦å°†å¾—åˆ°çš„ç›´æ¥ç»“æœä¹˜ä»¥é‡‡æ ·ç³»æ•°ã€‚ä¾‹å¦‚æƒ³æŒ‰ç…§ 0.1 çš„å› å­é‡‡æ ·æ•°æ®ï¼Œåˆ™éœ€è¦å°†ç»Ÿè®¡ç»“æœæ”¾å¤§ 10 å€ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>() <span class="operator">*</span> <span class="number">10</span> <span class="keyword">FROM</span> hits_v1 SAMPLE <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸€ç§æ›´ä¸ºä¼˜é›…çš„æ–¹æ³•æ˜¯å€ŸåŠ©è™šæ‹Ÿå­—æ®µ _sample_factor æ¥è·å–é‡‡æ ·ç³»æ•°ï¼Œå¹¶ä»¥æ­¤ä»£æ›¿ç¡¬ç¼–ç çš„å½¢å¼ï¼Œ_sample_factor å¯ä»¥å‘é‚£ä¼šå½“å‰æŸ¥è¯¢æ‰€å¯¹åº”çš„é‡‡æ ·ç³»æ•°ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>() <span class="operator">*</span> <span class="keyword">any</span>(_sample_factor) <span class="keyword">FROM</span> hits_v1 SAMPLE <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<h4 id="2-SAMPLE-rows"><a href="#2-SAMPLE-rows" class="headerlink" title="2. SAMPLE rows"></a>2. SAMPLE rows</h4><p><strong>SAMPLE rows è¡¨ç¤ºæŒ‰æ ·æœ¬æ•°é‡é‡‡æ ·ï¼Œå…¶ä¸­ rows è¡¨ç¤ºè‡³å°‘é‡‡æ ·å¤šå°‘è¡Œæ•°æ®ï¼Œå®ƒçš„å–å€¼å¿…é¡»æ˜¯å¤§äº 1 çš„æ•´æ•°ã€‚å¦‚æœ rows çš„å–å€¼å¤§äºè¡¨å†…æ•°æ®çš„æ€»è¡Œæ•°ï¼Œåˆ™æ•ˆæœç­‰äº rows &#x3D; 1ï¼Œä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨é‡‡æ ·ã€‚</strong></p>
<p><strong>æ¯”å¦‚æˆ‘ä»¬é‡‡æ · 10000 è¡Œæ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>() <span class="keyword">FROM</span> hits_v1 SAMPLE <span class="number">10000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>è™½ç„¶æˆ‘ä»¬é‡‡æ · 10000 è¡Œï¼Œä½†æ˜¯ä¸ä¸€å®šå°±è¿”å› 10000 è¡Œï¼Œå› ä¸ºæ•°æ®é‡‡æ ·æ˜¯ä¸€ä¸ªè¿‘ä¼¼èŒƒå›´ï¼Œè¿™æ˜¯ç”±äºé‡‡æ ·æ•°æ®çš„æœ€å°ç²’åº¦ç”± index_granularity ç´¢å¼•ç²’åº¦æ‰€å†³å®šçš„ã€‚ç”±æ­¤å¯çŸ¥ï¼Œè®¾ç½®ä¸€ä¸ªå°äºç´¢å¼•ç²’åº¦æˆ–è€…è¾ƒå°çš„ rows æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œåº”è¯¥è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ã€‚å¦å¤–ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨è™šæ‹Ÿå­—æ®µ _sample_factor æ¥è·å–å½“å‰æŸ¥è¯¢å¯¹åº”çš„é‡‡æ ·ç³»æ•°ã€‚</strong></p>
<h4 id="4-SAMPLE-factor-OFFSET-n"><a href="#4-SAMPLE-factor-OFFSET-n" class="headerlink" title="4. SAMPLE factor OFFSET n"></a>4. SAMPLE factor OFFSET n</h4><p><strong>SAMPLE factor OFFSET n è¡¨ç¤ºæŒ‰å› å­ç³»æ•°å’Œåç§»é‡é‡‡æ ·ï¼Œå…¶ä¸­ factor è¡¨ç¤ºé‡‡æ ·å› å­ï¼Œn è¡¨ç¤ºåç§»å¤šå°‘æ•°æ®åæ‰å¼€å§‹é‡‡æ ·ï¼Œå®ƒä»¬ä¸¤ä¸ªçš„å–å€¼éƒ½æ˜¯ 0~1 ä¹‹é—´çš„å°æ•°ã€‚ä¾‹å¦‚ä¸‹é¢çš„è¯­å¥è¡¨ç¤ºåç§»é‡ä¸º 0.5 å¹¶æŒ‰ 0.4 çš„ç³»æ•°é‡‡æ ·ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CounterID <span class="keyword">FROM</span> hits_v1 SAMPEL <span class="number">0.4</span> <span class="keyword">OFFSET</span> <span class="number">0.5</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°æŸ¥è¯¢ä¼šä»æ•°æ®çš„äºŒåˆ†ä¹‹ä¸€å¤„å¼€å§‹ï¼ŒæŒ‰ç…§ 0.4 çš„ç³»æ•°é‡‡æ ·æ•°æ®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155409003-1169057178.png" alt="img"></p>
<p><strong>å¦‚æœåœ¨è®¡ç®— OFFSET åç§»é‡åï¼ŒæŒ‰ç…§ SAMPLE æ¯”ä¾‹é‡‡æ ·å‡ºç°äº†æº¢å‡ºï¼Œåˆ™æ•°æ®ä¼šè¢«è‡ªåŠ¨æˆªæ–­ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%BB%A5%E5%8F%8A%E5%90%84%E7%A7%8D%E5%AD%90%E5%8F%A5(%E4%B9%9D)/1229382-20210903155401456-2508167.png" alt="img"></p>
<p><strong>å½“ç„¶è¿™ç§åšæ³•ä¹Ÿæ”¯æŒè™šæ‹Ÿå­—æ®µã€‚</strong></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p><strong>ä»¥ä¸Šå°±æ˜¯ ClickHouse å…³äºæŸ¥è¯¢æ–¹é¢çš„å†…å®¹ï¼Œå¯ä»¥è‚¯å®šçš„æ˜¯å†…å®¹ç»å¯¹ä¸æ­¢è¿™äº›ï¼Œå› ä¸ºå’Œå…³ç³»å‹æ•°æ®åº“é‡å çš„éƒ¨åˆ†è¿™é‡Œè‡ªåŠ¨çœç•¥æˆ–è€…ä¸€ç¬”å¸¦è¿‡äº†ï¼Œæ¯”å¦‚ç©ºå€¼å¦‚ä½•å¤„ç†ï¼ˆnullifã€coalesceï¼‰ã€IN æŸ¥è¯¢ã€LIKE æŸ¥è¯¢ã€ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢ã€CASE WHEN è¯­å¥ç­‰ç­‰ç­‰ç­‰ã€‚å¦‚æœå¤§éƒ¨åˆ†çš„å…³ç³»å‹æ•°æ®åº“éƒ½æ”¯æŒçš„è¯­æ³•ï¼Œé‚£ä¹ˆåœ¨ ClickHouse ä¸­åŸºæœ¬ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚æ‰€ä»¥ä¸ªäººè§‰å¾—æœ‰ MySQL ç›¸å…³ç»éªŒçš„è¯ï¼Œè‡³å°‘åœ¨ ClickHouse çš„æŸ¥è¯¢æ–¹é¢ï¼Œç»å¯¹æ˜¯éå¸¸å¥½ä¸Šæ‰‹çš„ï¼Œæ²¡äº‹å¤šå†™ä¸€å†™å°±è¡Œã€‚</strong></p>
<p><strong>æ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç» ClickHouse ä¸­å…³äºæ“ä½œæ•°ç»„çš„å‡½æ•°ï¼Œåˆ°æ—¶å€™ä¹Ÿä¼šåˆ»æ„åœ°èå…¥æ›´å¤šçš„è¯­æ³•ï¼ˆè¿™é‡Œä»‹ç»çš„ï¼Œå’Œæ²¡æœ‰ä»‹ç»çš„ï¼‰ã€‚å› ä¸º ClickHouse ä¸­æä¾›äº†å¤§é‡çš„å‡½æ•°ï¼Œé€šè¿‡è¿™äº›å‡½æ•° ClickHouse åœ¨å¤„ç†æ•°æ®å°±èƒ½å¤Ÿå˜å¾—æ‰€å‘æŠ«é¡ï¼Œä½†æˆ‘ä»¬ä¸å¯èƒ½ä¸€ä¸‹å…¨è¯´å®Œï¼Œè¿™é‡Œå°±å…ˆæ‹¿æ•°ç»„å¼€åˆ€ï¼Œå› ä¸ºå®ƒç›¸å¯¹æ›´å¤æ‚ä¸€äº›ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse å…¶å®ƒçš„ä¸€äº›æ“ä½œå‡½æ•° (åäº”)</title>
    <url>/2023/04/11/ClickHouse%20%E5%85%B6%E5%AE%83%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%20(%E5%8D%81%E4%BA%94)/</url>
    <content><![CDATA[<h1 id="ClickHouse-å…¶å®ƒçš„ä¸€äº›æ“ä½œå‡½æ•°-åäº”"><a href="#ClickHouse-å…¶å®ƒçš„ä¸€äº›æ“ä½œå‡½æ•°-åäº”" class="headerlink" title="ClickHouse å…¶å®ƒçš„ä¸€äº›æ“ä½œå‡½æ•° (åäº”)"></a>ClickHouse å…¶å®ƒçš„ä¸€äº›æ“ä½œå‡½æ•° (åäº”)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>åœ¨ ClickHouse ä¸­è¿˜å­˜åœ¨ä¸€äº›å…¶å®ƒæ¯”è¾ƒæœ‰æ„æ€çš„å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</strong></p>
<p><strong>andï¼šè®¡ç®—å¤šä¸ªå€¼é€»è¾‘ä¸è¿æ¥çš„ç»“æœ</strong></p>
<p><strong>è¯¥å‡½æ•°åªèƒ½æ¥æ”¶ æ•´å‹ã€æµ®ç‚¹å‹å’Œ Nullï¼Œå…¶é€»è¾‘å’Œ Python ä¸­çš„ and ç±»ä¼¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">and</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="keyword">Null</span>, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€and(1, 2, 0, NULL, 3, 5)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                        0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">2</span> <span class="keyword">AND</span> <span class="number">0</span> <span class="keyword">AND</span> <span class="keyword">Null</span> <span class="keyword">AND</span> <span class="number">3</span> <span class="keyword">AND</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€and(1, 2, 0, NULL, 3, 5)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                        0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>orï¼šè®¡ç®—å¤šä¸ªå€¼é€»è¾‘æˆ–è¿æ¥çš„ç»“æœ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">or</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="keyword">Null</span>, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€or(1, 2, 0, NULL, 3, 5)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                       1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">OR</span> <span class="number">2</span> <span class="keyword">OR</span> <span class="number">0</span> <span class="keyword">OR</span> <span class="keyword">Null</span> <span class="keyword">OR</span> <span class="number">3</span> <span class="keyword">OR</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€or(1, 2, 0, NULL, 3, 5)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                       1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>notï¼šåŒæ ·åªèƒ½æ¥æ”¶æ•´å‹ã€æµ®ç‚¹å‹ã€Nullï¼Œç”¨äºé€»è¾‘å–å</strong></p>
<p><strong>ä¸¾ä¸ªæ —å­ï¼šå¦‚æœæ˜¯é 0ã€é Nullï¼Œé‚£ä¹ˆé€»è¾‘ä¸Šå°±ä¸ºçœŸï¼Œå› æ­¤è°ƒç”¨ not ä¹‹åä¼šå¾—åˆ°å‡ï¼Œä¹Ÿå°±æ˜¯ 0ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- not(0) å¾—åˆ° 1ï¼Œnot(Null) è¿˜æ˜¯ Nullï¼Œnot(é0ã€é Null) å¾—åˆ° 0</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">not</span>(<span class="number">123</span>), <span class="keyword">not</span>(<span class="keyword">Null</span>), <span class="keyword">not</span>(<span class="number">0</span>), <span class="keyword">not</span>(<span class="number">333</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€not(123)â”€â”¬â”€not(NULL)â”€â”¬â”€not(0)â”€â”¬â”€not(333)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        0 â”‚ á´ºáµá´¸á´¸      â”‚      1 â”‚        0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NOT</span> <span class="number">123</span>, <span class="keyword">NOT</span> <span class="keyword">Null</span>, <span class="keyword">NOT</span> <span class="number">0</span>, <span class="keyword">NOT</span> <span class="number">333</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€not(123)â”€â”¬â”€not(NULL)â”€â”¬â”€not(0)â”€â”¬â”€not(333)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        0 â”‚ á´ºáµá´¸á´¸      â”‚      1 â”‚        0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ifï¼šæƒ³è±¡æˆç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸‰å…ƒè¡¨è¾¾å¼å³å¯</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> number, if(number <span class="operator">&lt;</span> <span class="number">5</span>, <span class="string">&#x27;less than 5&#x27;</span>, <span class="string">&#x27;greater than or equal to 5&#x27;</span>) </span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”¬â”€if(less(number, 5), &#x27;less than 5&#x27;, &#x27;greater than or equal to 5&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚      0 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      1 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      2 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      3 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      4 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      5 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      6 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      7 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      8 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      9 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦å¤– ClickHouse æœ¬èº«ä¹Ÿæ”¯æŒä¸‰å…ƒè¡¨è¾¾å¼ï¼Œåº•å±‚ä¾æ—§ä¼šè½¬æˆ if</span></span><br><span class="line"><span class="keyword">SELECT</span> number, number <span class="operator">&lt;</span> <span class="number">5</span> ? <span class="string">&#x27;less than 5&#x27;</span> : <span class="string">&#x27;greater than or equal to 5&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”¬â”€if(less(number, 5), &#x27;less than 5&#x27;, &#x27;greater than or equal to 5&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚      0 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      1 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      2 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      3 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      4 â”‚ less than 5                                                      â”‚</span></span><br><span class="line"><span class="comment">â”‚      5 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      6 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      7 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      8 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â”‚      9 â”‚ greater than or equal to 5                                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CASE WHEN è¯­å¥å®ç°ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> number, <span class="keyword">CASE</span> <span class="keyword">WHEN</span> number <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="string">&#x27;less than 5&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;greater than or equal to 5&#x27;</span> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”¬â”€multiIf(less(number, 5), &#x27;less than 5&#x27;, &#x27;greater than or equal to 5&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚      0 â”‚ less than 5                                                           â”‚</span></span><br><span class="line"><span class="comment">â”‚      1 â”‚ less than 5                                                           â”‚</span></span><br><span class="line"><span class="comment">â”‚      2 â”‚ less than 5                                                           â”‚</span></span><br><span class="line"><span class="comment">â”‚      3 â”‚ less than 5                                                           â”‚</span></span><br><span class="line"><span class="comment">â”‚      4 â”‚ less than 5                                                           â”‚</span></span><br><span class="line"><span class="comment">â”‚      5 â”‚ greater than or equal to 5                                            â”‚</span></span><br><span class="line"><span class="comment">â”‚      6 â”‚ greater than or equal to 5                                            â”‚</span></span><br><span class="line"><span class="comment">â”‚      7 â”‚ greater than or equal to 5                                            â”‚</span></span><br><span class="line"><span class="comment">â”‚      8 â”‚ greater than or equal to 5                                            â”‚</span></span><br><span class="line"><span class="comment">â”‚      9 â”‚ greater than or equal to 5                                            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°åº•å±‚è½¬åŒ–æˆäº† multiIfï¼Œé‚£ä¹ˆè¿™ä¸ª multiIf æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿé¦–å…ˆ if å‡½æ•°çš„å‚æ•°å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if(cond, then, else)</span><br></pre></td></tr></table></figure>

<p><strong>è€Œ multiIf å‡½æ•°çš„å‚æ•°å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multiIf(cond1, then1, cond2, then2, cond3, then3, ..., else)</span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ä»åå­—ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥ multiIf æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œif åªèƒ½æœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œç›¸å½“äºç¼–ç¨‹è¯­è¨€ä¸­çš„ if â€¦ elseï¼›è€Œ multiIf å¯ä»¥æ¥æ”¶å¤šä¸ªæ¡ä»¶ï¼Œç›¸å½“äºç¼–ç¨‹è¯­è¨€ä¸­çš„ if â€¦ else if â€¦ else if â€¦ elseã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç­‰ä»·äº multiIf(number &lt; 5, &#x27;less than 5&#x27;, number = 5, &#x27;equal to 5&#x27;, &#x27;greater than 5&#x27;)</span></span><br><span class="line"><span class="keyword">SELECT</span> number, </span><br><span class="line">       <span class="keyword">CASE</span> <span class="keyword">WHEN</span> number <span class="operator">&lt;</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="string">&#x27;less than 5&#x27;</span> <span class="keyword">WHEN</span> number <span class="operator">=</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="string">&#x27;equal to 5&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;greater than 5&#x27;</span> <span class="keyword">END</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">10</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”¬â”€multiIf(less(number, 5), &#x27;less than 5&#x27;, equals(number, 5), &#x27;equal to 5&#x27;, &#x27;greater than 5&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚      0 â”‚ less than 5                                                                                â”‚</span></span><br><span class="line"><span class="comment">â”‚      1 â”‚ less than 5                                                                                â”‚</span></span><br><span class="line"><span class="comment">â”‚      2 â”‚ less than 5                                                                                â”‚</span></span><br><span class="line"><span class="comment">â”‚      3 â”‚ less than 5                                                                                â”‚</span></span><br><span class="line"><span class="comment">â”‚      4 â”‚ less than 5                                                                                â”‚</span></span><br><span class="line"><span class="comment">â”‚      5 â”‚ equal to 5                                                                                 â”‚</span></span><br><span class="line"><span class="comment">â”‚      6 â”‚ greater than 5                                                                             â”‚</span></span><br><span class="line"><span class="comment">â”‚      7 â”‚ greater than 5                                                                             â”‚</span></span><br><span class="line"><span class="comment">â”‚      8 â”‚ greater than 5                                                                             â”‚</span></span><br><span class="line"><span class="comment">â”‚      9 â”‚ greater than 5                                                                             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ ¹æ®è¿”å›çš„ç»“æœé›†çš„å­—æ®µæˆ‘ä»¬å‘ç°åº•å±‚ä¼šå˜æˆå‡½æ•°è°ƒç”¨ï¼š</strong></p>
<ul>
<li><code>a &lt; b ç­‰ä»·äº less(a, b)</code></li>
<li><code>a = b ç­‰ä»·äº equals(a, b)</code></li>
<li><code>a &gt; b ç­‰ä»·äº greater(a, b)</code></li>
<li><code>a &lt;= b ç­‰ä»·äº lessOrEquals(a, b)</code></li>
<li><code>a &gt;= b ç­‰ä»·äº greaterOrEquals(a, b)</code></li>
<li><code>a != b ç­‰ä»·äº notEquals(a, b)</code></li>
</ul>
<p><strong>ä½†è¿˜æ˜¯æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ CASE WHEN è¿›è¡Œå®ç°ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯å…³ç³»å‹æ•°æ®ä¸­éå¸¸å¸¸ç”¨çš„è¯­æ³•ï¼Œè¿™æ ·è¯»èµ·æ¥ä¼šæ›´åŠ çš„äº²åˆ‡ã€‚å…³äºå¤§å°æ¯”è¾ƒï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨æ“ä½œç¬¦å³å¯ï¼Œæ²¡å¿…è¦ä½¿ç”¨ lessã€equalsã€greater ç­‰å‡½æ•°ã€‚</strong></p>
<h4 id="æ•°å­¦è®¡ç®—å‡½æ•°"><a href="#æ•°å­¦è®¡ç®—å‡½æ•°" class="headerlink" title="æ•°å­¦è®¡ç®—å‡½æ•°"></a>æ•°å­¦è®¡ç®—å‡½æ•°</h4><p><strong>ä»¥ä¸‹æ˜¯å…³äºæ•°å­¦è®¡ç®—çš„ä¸€äº›å‡½æ•°ï¼Œæ¥çœ‹ä¸€ä¸‹ã€‚</strong></p>
<p><strong>eï¼šä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨ä¹‹åè¿”å›åº•æ•° e</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€e()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2.718281828459045 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>piï¼šä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨ä¹‹åè¿”å›åœ†å‘¨ç‡ Ï€</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pi();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€pi()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 3.141592653589793 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>expï¼šè¿”å› e çš„ x æ¬¡æ–¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">exp</span>(<span class="number">1</span>), <span class="built_in">exp</span>(<span class="number">2</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€exp(1)â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€exp(2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2.718281828460626 â”‚ 7.389056098924109 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é™¤äº† exp ä¹‹å¤–ï¼Œè¿˜æœ‰ exp2 è¿”å› 2 çš„ x æ¬¡æ–¹ï¼Œexp10 è¿”å› 10 çš„ x æ¬¡æ–¹ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> exp2(<span class="number">2</span>), exp10(<span class="number">2</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€exp2(2)â”€â”¬â”€exp10(2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       4 â”‚      100 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>logã€lnï¼šä¸¤è€…æ˜¯ç­‰ä»·çš„ï¼Œéƒ½æ˜¯ä»¥è‡ªç„¶å¯¹æ•°ä¸ºåº•</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">log</span>(e()), <span class="built_in">ln</span>(e() <span class="operator">*</span> e());</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€log(e())â”€â”¬â”€log(multiply(e(), e()))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 0.9999999987491066 â”‚        2.00000000029383 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒç†è¿˜æœ‰ log2 ä»¥ 2 ä¸ºåº•ï¼Œlog10 ä»¥ 10 ä¸ºåº•ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> log2(<span class="number">8</span>), <span class="built_in">log10</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€log2(8)â”€â”¬â”€log10(1000)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       3 â”‚           3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>sqrtï¼šè¿”å›ä¸€ä¸ªæ•°çš„å¹³æ–¹æ ¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sqrt</span>(<span class="number">9</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€sqrt(9)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>cbrtï¼šè¿”å›ä¸€ä¸ªæ•°çš„ç«‹æ–¹æ ¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cbrt(<span class="number">27</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€cbrt(27)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 3.0000000000000004 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>powï¼šè®¡ç®— x çš„ y æ¬¡æ–¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- pow ä¹Ÿå¯ä»¥å†™æˆ power</span></span><br><span class="line"><span class="keyword">SELECT</span> pow(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€pow(3, 4)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        81 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>sinã€cosã€tanï¼šè®¡ç®—æ­£å¼¦å€¼ã€ä½™å¼¦å€¼ã€æ­£åˆ‡å€¼</strong></p>
<p><strong>asinã€acosã€atanï¼šè®¡ç®—åæ­£å¼¦å€¼ã€åä½™å¼¦å€¼ã€åæ­£åˆ‡å€¼</strong></p>
<p><strong>sinhã€coshã€tanhï¼šè®¡ç®—åŒæ›²æ­£å¼¦å€¼ã€åŒæ›²ä½™å¼¦å€¼ã€åŒæ›²æ­£åˆ‡å€¼</strong></p>
<p><strong>asinhã€acoshã€atanhï¼šè®¡ç®—ååŒæ›²æ­£å¼¦å€¼ã€ååŒæ›²ä½™å¼¦å€¼ã€ååŒæ›²æ­£åˆ‡å€¼</strong></p>
<p><strong>atan2ï¼šatan çš„å¢å¼ºç‰ˆï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥ç™¾åº¦æˆ–è€…è°·æ­Œ</strong></p>
<p><strong>hypotï¼šç»™å®šä¸¤ä¸ªç›´è§’è¾¹ï¼Œè®¡ç®—æ–œè¾¹é•¿åº¦ï¼Œç­‰äº x2+y2âˆ’âˆ’âˆ’âˆ’âˆ’âˆ’âˆšï¿½2+ï¿½2</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> hypot(<span class="number">3</span>, <span class="number">4</span>), hypot(<span class="number">6</span>, <span class="number">8</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hypot(3, 4)â”€â”¬â”€hypot(6, 8)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           5 â”‚          10 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>signï¼šå°äº 0 è¿”å› -1ã€ç­‰äº 0 è¿”å› 0ã€å¤§äº 0 è¿”å› 1</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sign(<span class="number">-100</span>), sign(<span class="number">0</span>), sign(<span class="number">111</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€sign(-100)â”€â”¬â”€sign(0)â”€â”¬â”€sign(111)â”€â”</span></span><br><span class="line"><span class="comment">â”‚         -1 â”‚       0 â”‚         1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>floorã€ceilï¼ˆæˆ–è€… ceilingï¼‰ï¼šè¿”å›å°äºç­‰äº x çš„æœ€å¤§æ•´æ•°ã€å¤§äºç­‰äº x çš„æœ€å°æ•´æ•°ï¼Œæ³¨æ„ï¼šè¯´è¿”å›æ•´æ•°å…¶å®ä¸å¤ªå‡†ç¡®ï¼Œå› ä¸ºè¿”å›çš„ä»æ˜¯ Float64</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">floor</span>(<span class="number">3.14</span>), <span class="built_in">ceil</span>(<span class="number">3.14</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€floor(3.14)â”€â”¬â”€ceil(3.14)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           3 â”‚          4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿˜å¯ä»¥é€‰æ‹©ç²¾åº¦ï¼Œä¼šä¿ç•™ä¸€ä½ï¼Œé»˜è®¤æ˜¯ä¸€ä½éƒ½ä¸ä¿ç•™</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">floor</span>(<span class="number">3.14</span>, <span class="number">1</span>), <span class="built_in">ceil</span>(<span class="number">3.14</span>, <span class="number">2</span>), <span class="built_in">ceiling</span>(<span class="number">3.14</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€floor(3.14, 1)â”€â”¬â”€ceil(3.14, 2)â”€â”¬â”€ceil(3.14, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            3.1 â”‚          3.14 â”‚          3.14 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>truncateã€truncï¼šæˆªæ–­å°æ•°ç‚¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> trunc(<span class="number">3.14</span>), trunc(<span class="number">-2.17</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€trunc(3.14)â”€â”¬â”€trunc(-2.17)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           3 â”‚           -2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»ç„¶å¯ä»¥é€‰æ‹©ä¿ç•™ä½æ•°</span></span><br><span class="line"><span class="keyword">SELECT</span> trunc(<span class="number">3.14</span>, <span class="number">1</span>), trunc(<span class="number">-2.17</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€trunc(3.14, 1)â”€â”¬â”€trunc(-2.17, 1)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            3.1 â”‚            -2.1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>roundï¼šä¿ç•™æŒ‡å®šä½æ•°çš„å°æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸æŒ‡å®šä½æ•°ï¼Œå°†ä¸€ä½éƒ½ä¸ä¿ç•™</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">3.1415926</span>, <span class="number">3</span>), round(<span class="number">3.1415926</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€round(3.1415926, 3)â”€â”¬â”€round(3.1415926)â”€â”</span></span><br><span class="line"><span class="comment">â”‚               3.142 â”‚                3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šClickHouse ä¸­çš„ round è¿˜æœ‰ä¸€ç§ç‰¹æ®Šç”¨æ³•ï¼Œé‚£å°±æ˜¯å¯¹æ•´æ•°å››èˆäº”å…¥ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å½“æŒ‡å®šä¸ºè´Ÿæ•°æ—¶ï¼Œè¡¨ç¤ºå¯¹æ•´æ•°æˆ–è€…å°æ•°ç‚¹å‰é¢çš„è¿›è¡Œå››èˆäº”å…¥</span></span><br><span class="line"><span class="comment">-- -1 è¡¨ç¤ºé’ˆå¯¹æœ€åä¸€ä½ï¼Œæ‰€ä»¥ round(222, -1) å¾—åˆ°çš„ç»“æœæ˜¯ 220ï¼Œround(228, -1) å¾—åˆ°çš„ç»“æœæ˜¯ 230</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">222</span>, <span class="number">-1</span>), round(<span class="number">228</span>, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€round(222, -1)â”€â”¬â”€round(228, -1)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            220 â”‚            230 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- -2 è¡¨ç¤ºé’ˆå¯¹æœ€åä¸¤ä½ï¼Œæ‰€ä»¥ round(-350, -2) å¾—åˆ°çš„ç»“æœæ˜¯ -400ï¼Œround(349, -2) å¾—åˆ°çš„ç»“æœæ˜¯ 300</span></span><br><span class="line"><span class="comment">-- å› ä¸º 50 è¾¾åˆ°äº† 100 çš„ä¸€åŠï¼Œ49 æ²¡æœ‰è¾¾åˆ° 100 çš„ä¸€åŠ</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">-350</span>, <span class="number">-2</span>), round(<span class="number">349</span>, <span class="number">-2</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€round(-350, -2)â”€â”¬â”€round(349, -2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            -400 â”‚            300 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- -3 è¡¨ç¤ºé’ˆå¯¹æœ€åä¸‰ä½ï¼Œæ‰€ä»¥ round(499, -3) å¾—åˆ°çš„ç»“æœæ˜¯ 0ï¼Œround(500, -3) å¾—åˆ°çš„ç»“æœæ˜¯ 1000</span></span><br><span class="line"><span class="comment">-- å› ä¸º 499 æ²¡æœ‰è¾¾åˆ° 1000 çš„ä¸€åŠï¼Œ500 è¾¾åˆ°äº† 1000 çš„ä¸€åŠ</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">499</span>, <span class="number">-3</span>), round(<span class="number">500</span>, <span class="number">-3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€round(499, -3)â”€â”¬â”€round(500, -3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚              0 â”‚           1000 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>roundToExp2ï¼šå°†æ•°å€¼è½¬ä¸ºæŸä¸ªæœ€æ¥è¿‘çš„ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼Œæ¯”å¦‚ roundToExp2(33) å¾—åˆ°çš„å°±æ˜¯ 32ï¼Œå› ä¸º 32 æ˜¯ 2 çš„ 5 æ¬¡å¹‚ï¼›roundToExp2(31) å¾—åˆ°çš„å°±æ˜¯ 16ï¼Œå› ä¸º 16 æ˜¯ 2 çš„ 4 æ¬¡å¹‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å°äº 1ï¼Œè¿”å› 0</span></span><br><span class="line"><span class="keyword">SELECT</span> roundToExp2(<span class="number">33</span>), roundToExp2(<span class="number">31</span>), roundToExp2(<span class="number">1</span>), roundToExp2(<span class="number">-11</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€roundToExp2(33)â”€â”¬â”€roundToExp2(31)â”€â”¬â”€roundToExp2(1)â”€â”¬â”€roundToExp2(-11)â”€â”</span></span><br><span class="line"><span class="comment">â”‚              32 â”‚              16 â”‚              1 â”‚                0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>roundAgeï¼šå¦‚æœä¸€ä¸ªæ•°å€¼å°äº 18ï¼Œè¿”å›å…¶æœ¬èº«ï¼›å¦åˆ™å°†å…¶è½¬æˆ 18ã€25ã€35ã€45ã€55 å½“ä¸­ä¸ä¹‹æœ€æ¥è¿‘çš„ä¸€ä¸ªå€¼ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªå‡½æ•°æ˜¯é’ˆå¯¹ Yandex å…¬å¸çš„ä¸šåŠ¡è€Œä¸“é—¨è®¾è®¡çš„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> roundAge(<span class="number">15</span>), roundAge(<span class="number">20</span>), roundAge(<span class="number">29</span>), roundAge(<span class="number">38</span>), roundAge(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€roundAge(15)â”€â”¬â”€roundAge(20)â”€â”¬â”€roundAge(29)â”€â”¬â”€roundAge(38)â”€â”¬â”€roundAge(1000)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           17 â”‚           18 â”‚           25 â”‚           35 â”‚             55 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>roundDownï¼šå°†ä¸€ä¸ªæ•°å€¼å››èˆäº”å…¥åˆ°æŸä¸ªæ•°ç»„ä¸­ä¸ä¹‹æœ€æ¥è¿‘çš„å€¼ï¼Œå¦‚æœæ•°å€¼å°äºæ•°ç»„ä¸­çš„æœ€å°å€¼ï¼Œé‚£ä¹ˆç­‰äºæœ€å°å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">18</span>, <span class="number">25</span>, <span class="number">35</span>, <span class="number">45</span>, <span class="number">55</span>] <span class="keyword">AS</span> arr</span><br><span class="line"><span class="keyword">SELECT</span> roundDown(<span class="number">15</span>, arr), roundDown(<span class="number">20</span>, arr), roundDown(<span class="number">29</span>, arr), roundDown(<span class="number">38</span>, arr), roundDown(<span class="number">1000</span>, arr)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€roundDown(15, arr)â”€â”¬â”€roundDown(20, arr)â”€â”¬â”€roundDown(29, arr)â”€â”¬â”€roundDown(38, arr)â”€â”¬â”€roundDown(1000, arr)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                 18 â”‚                 18 â”‚                 25 â”‚                 35 â”‚                   55 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>randã€rand32ï¼šç”Ÿæˆä¸€ä¸ª UInt32 ä¼ªéšæœºæ•°</strong></p>
<p><strong>rand64ï¼šç”Ÿæˆä¸€ä¸ª UInt64 ä¼ªéšæœºæ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> rand32(), rand64();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€rand32()â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€rand64()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 4261522186 â”‚ 13571471280441249418 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>randConstantï¼šç”Ÿæˆä¸€ä¸ª UInt32 ä¼ªéšæœºæ•°ï¼Œä½†åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­å¤šæ¬¡è°ƒç”¨å¾—åˆ°çš„ç»“æœä¸€æ ·</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> rand32(), randConstant() <span class="keyword">FROM</span> numbers(<span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€rand32()â”€â”¬â”€randConstant()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 3054555439 â”‚      602145845 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 1590396198 â”‚      602145845 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2065566003 â”‚      602145845 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="å¸¸è§ç¼–ç å‡½æ•°"><a href="#å¸¸è§ç¼–ç å‡½æ•°" class="headerlink" title="å¸¸è§ç¼–ç å‡½æ•°"></a>å¸¸è§ç¼–ç å‡½æ•°</h4><p><strong>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç¼–ç å‡½æ•°ï¼Œä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚</strong></p>
<p><strong>charï¼šå°† ASCII ç è½¬æˆå¯¹åº”çš„å­—ç¬¦ï¼Œå¯ä»¥åŒæ—¶æ¥æ”¶å¤šä¸ª ASCII ç </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="type">char</span>(<span class="number">97</span>), <span class="type">char</span>(<span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€char(97)â”€â”¬â”€char(97, 98, 99)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ a        â”‚ abc              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hexï¼šå°†æ•´å‹ç”¨ 16 è¿›åˆ¶è¡¨ç¤º</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> hex(<span class="number">97</span>), hex(<span class="number">98</span>), hex(<span class="number">99</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hex(97)â”€â”¬â”€hex(98)â”€â”¬â”€hex(99)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 61      â”‚ 62      â”‚ 63      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hex é™¤äº†æ¥æ”¶æ•´å‹ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²ï¼Œå°†æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„ ASCII ç ç”¨ 16 è¿›åˆ¶è¡¨ç¤ºã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åå…­è¿›åˆ¶ï¼ša -&gt; 61, b -&gt; 62, c-&gt;63</span></span><br><span class="line"><span class="keyword">SELECT</span> hex(<span class="string">&#x27;abc&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hex(&#x27;abc&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 616263     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>unhexï¼šhex çš„é€†è¿ç®—ï¼Œä½†åªèƒ½æ¥æ”¶å­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> unhex(<span class="string">&#x27;616263&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€unhex(&#x27;616263&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ abc             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="å…¶å®ƒå‡½æ•°"><a href="#å…¶å®ƒå‡½æ•°" class="headerlink" title="å…¶å®ƒå‡½æ•°"></a>å…¶å®ƒå‡½æ•°</h4><p><strong>hostNameï¼šè¿”å›å½“å‰ ClickHouse Server æ‰€åœ¨èŠ‚ç‚¹çš„ä¸»æœºå</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> hostName();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hostName()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>getMacroï¼šä»æœåŠ¡å™¨çš„å®é…ç½®ä¸­è·å–æŒ‡å®šçš„å€¼</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>satori<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åå³å¯é€šè¿‡ getMacro(name) è·å–ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„å®ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> system.macros;</span><br></pre></td></tr></table></figure>

<p><strong>fqdnï¼šè¿”å›å…¨é™å®šåŸŸåï¼Œå’Œæˆ‘å½“å‰çš„ä¸»æœºåæ˜¯ä¸€æ ·çš„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> fqdn();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€FQDN()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>basenameï¼šè¿”å›è·¯å¾„ä¸­æœ€åä¸€ä¸ª &#x2F; æˆ–è€… \ åé¢çš„éƒ¨åˆ†</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;/root/girls/1.csv&#x27;</span> file_path, basename(file_path) file_name;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€file_pathâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€file_nameâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ /root/girls/1.csv â”‚ 1.csv     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>visibleWidthï¼šå½“ä»¥æ–‡æœ¬æ ¼å¼å‘æ§åˆ¶å°è¾“å‡ºå†…å®¹æ—¶ï¼Œè®¡ç®—å‡ºæ‰€éœ€è¦çš„å®½åº¦ï¼Œç”¨äºç¾åŒ–è¾“å‡º</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> visibleWidth(<span class="number">3.1415</span>), visibleWidth(<span class="string">&#x27;satori&#x27;</span>), visibleWidth(<span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€visibleWidth(3.1415)â”€â”¬â”€visibleWidth(&#x27;satori&#x27;)â”€â”¬â”€visibleWidth(NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                    6 â”‚                      6 â”‚                  4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> visibleWidth([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="keyword">Null</span>]), length(<span class="string">&#x27;[1,2,3,4,Null]&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€visibleWidth([1, 2, 3, 4, NULL])â”€â”¬â”€length(&#x27;[1,2,3,4,Null]&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                               14 â”‚                       14 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°å°±æ˜¯æŠŠå†…å®¹å½“æˆçº¯æ–‡æœ¬ï¼Œè®¡ç®—æ‰€å çš„é•¿åº¦ã€‚</strong></p>
<p><strong>toTypeNameï¼šè¿”å›ä¸€ä¸ªå€¼çš„ç±»å‹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> toTypeName([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), toTypeName(<span class="number">123</span>), toTypeName((<span class="number">11</span>, <span class="string">&#x27;22&#x27;</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toTypeName([1, 2, 3])â”€â”¬â”€toTypeName(123)â”€â”¬â”€toTypeName((11, &#x27;22&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ Array(UInt8)          â”‚ UInt8           â”‚ Tuple(UInt8, String)   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ•°ç»„ä¸­å¦‚æœåŒ…å« Nullï¼Œé‚£ä¹ˆ Array(...) ä¼šå˜æˆ Array(Nullable(...))</span></span><br><span class="line"><span class="comment">-- è€Œ Null çš„ç±»å‹æœ¬èº«åˆ™æ˜¯ Nullable(Nothing)</span></span><br></pre></td></tr></table></figure>

<p><strong>ignoreï¼šæ¥æ”¶ä»»ä½•å‚æ•°ï¼ŒåŒ…æ‹¬ Nullï¼Œä½†æ€»æ˜¯è¿”å› 0ï¼›ç„¶è€Œè¯¥å‚æ•°ä»ç„¶ä¼šè¢«è€ƒè™‘åœ¨å†…ï¼Œå› æ­¤ä¸€èˆ¬ç”¨äºåŸºå‡†æµ‹è¯•</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ignore(<span class="number">11</span>), ignore([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), ignore(<span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€ignore(11)â”€â”¬â”€ignore([1, 2, 3])â”€â”¬â”€ignore(NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚          0 â”‚                 0 â”‚            0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>currentDatabaseï¼šè·å–å½“å‰æ‰€åœ¨çš„æ•°æ®åº“</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> currentDatabase();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€currentDatabase()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ default           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>currentUsereï¼šè·å–å½“å‰çš„ç”¨æˆ·</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å½“å‰çš„é»˜è®¤ç”¨æˆ·ä¹Ÿå« default</span></span><br><span class="line"><span class="keyword">SELECT</span> currentUser();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€currentUser()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ default       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>ä»¥ä¸Šå°±æ˜¯ ClickHouse çš„ä¸€äº›å…¶å®ƒå‡½æ•°ï¼Œå½“ç„¶è¿˜æ˜¯é‚£å¥è¯ï¼ŒClickHouse çš„æä¾›çš„å‡½æ•°éå¸¸å¤šï¼Œä¸æ­¢æˆ‘ä»¬ä¸Šé¢è¯´çš„ï¼Œåªä¸è¿‡æœ‰å¾ˆå¤šä¸ªäººè§‰å¾—ç”¨ä¸ä¸Šï¼Œæ‰€ä»¥å°±ä¸è¯´äº†ã€‚å½“ç„¶å¦‚æœä½ æœ‰å…´è¶£çš„è¯å¯ä»¥å»å®˜ç½‘è¿›è¡ŒæŸ¥çœ‹ï¼Œé“¾æ¥ï¼š <a href="https://clickhouse.tech/docs/en/sql-reference/functions/">https://clickhouse.tech/docs/en/sql-reference/functions/</a> ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse ä¹‹ MergeTree å®¶æ—ä¸­çš„å…¶å®ƒè¡¨å¼•æ“(ä¸ƒ)</title>
    <url>/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/</url>
    <content><![CDATA[<h1 id="ClickHouse-ä¹‹-MergeTree-å®¶æ—ä¸­çš„å…¶å®ƒè¡¨å¼•æ“-ä¸ƒ"><a href="#ClickHouse-ä¹‹-MergeTree-å®¶æ—ä¸­çš„å…¶å®ƒè¡¨å¼•æ“-ä¸ƒ" class="headerlink" title="ClickHouse ä¹‹ MergeTree å®¶æ—ä¸­çš„å…¶å®ƒè¡¨å¼•æ“(ä¸ƒ)"></a>ClickHouse ä¹‹ MergeTree å®¶æ—ä¸­çš„å…¶å®ƒè¡¨å¼•æ“(ä¸ƒ)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<p><strong>ç›®å‰åœ¨ ClickHouse ä¸­ï¼ŒæŒ‰ç…§ç‰¹ç‚¹å¯ä»¥å°†è¡¨å¼•æ“åˆ†ä¸º 6 ä¸ªç³»åˆ—ï¼Œåˆ†åˆ«æ˜¯åˆå¹¶æ ‘ã€å¤–éƒ¨å­˜å‚¨ã€å†…å­˜ã€æ–‡ä»¶ã€æ¥å£å’Œå…¶å®ƒï¼Œæ¯ä¸€ä¸ªç³»åˆ—çš„è¡¨å¼•æ“éƒ½æœ‰ç‹¬è‡ªçš„ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯ã€‚è€Œå…¶ä¸­æœ€æ ¸å¿ƒçš„å½“å± MergeTree ç³»åˆ—ï¼Œå› ä¸ºå®ƒä»¬æ‹¥æœ‰æœ€ä¸ºå¼ºå¤§çš„æ€§èƒ½å’Œæœ€ä¸ºå¹¿æ³›çš„ä½¿ç”¨åœºæ™¯ã€‚</strong></p>
<p><strong>ç»è¿‡ä¹‹å‰çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ MergeTree æœ‰ä¸¤ç§å«ä¹‰ï¼š</strong></p>
<ul>
<li><code>1. è¡¨ç¤ºåˆå¹¶æ ‘è¡¨å¼•æ“å®¶æ—</code></li>
<li><code>2. è¡¨ç¤ºåˆå¹¶æ ‘è¡¨å¼•æ“å®¶æ—ä¸­æœ€åŸºç¡€çš„ MergeTree è¡¨å¼•æ“</code></li>
</ul>
<p><strong>è€Œåœ¨æ•´ä¸ªå®¶æ—ä¸­ï¼Œé™¤äº†åŸºç¡€è¡¨å¼•æ“ MergeTree ä¹‹å¤–ï¼Œå¸¸ç”¨çš„è¡¨å¼•æ“è¿˜æœ‰ ReplacingMergeTreeã€SummingMergeTreeã€AggregatingMergeTreeã€CollapsingMergeTreeã€VersionedCollapsingMergeTreeã€‚ä»åå­—ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œæ¯ä¸€ç§åˆå¹¶æ ‘çš„å˜ç§ï¼Œåœ¨ç»§æ‰¿äº† MergeTree çš„åŸºç¡€èƒ½åŠ›åï¼Œåˆå¢åŠ äº†ç‹¬æœ‰çš„ç‰¹æ€§ï¼Œè€Œè¿™äº›ç‹¬æœ‰çš„ç‰¹æ€§éƒ½æ˜¯åœ¨è§¦å‘åˆå¹¶çš„è¿‡ç¨‹ä¸­è¢«æ¿€æ´»çš„ã€‚</strong></p>
<h3 id="MergeTree"><a href="#MergeTree" class="headerlink" title="MergeTree"></a>MergeTree</h3><p><strong>MergeTree ä½œä¸ºå®¶æ—ç³»åˆ—æœ€åŸºç¡€çš„è¡¨å¼•æ“ï¼Œæä¾›äº†æ•°æ®åˆ†åŒºã€ä¸€çº§ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•ç­‰åŠŸèƒ½ï¼Œè‡³äºå®ƒä»¬çš„è¿è¡Œæœºç†æˆ‘ä»¬ä¹‹å‰å·²ç»ä»‹ç»è¿‡äº†ã€‚è¿™é‡Œæˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹ MergeTree çš„å¦å¤–ä¸¤ä¸ªåŠŸèƒ½ï¼šæ•°æ® TTL å’Œ å­˜å‚¨ç­–ç•¥ã€‚</strong></p>
<h4 id="æ•°æ®-TTL"><a href="#æ•°æ®-TTL" class="headerlink" title="æ•°æ® TTL"></a>æ•°æ® TTL</h4><p><strong>TTL å³ Time To Liveï¼Œè¡¨ç¤ºæ•°æ®çš„å­˜æ´»æ—¶é—´ï¼Œè€Œåœ¨ MergeTree ä¸­å¯ä»¥ä¸ºæŸä¸ªåˆ—å­—æ®µæˆ–æ•´å¼ è¡¨è®¾ç½® TTLã€‚å½“æ—¶é—´åˆ°è¾¾æ—¶ï¼Œå¦‚æœæ˜¯åˆ—å­—æ®µçº§åˆ«çš„ TTLï¼Œåˆ™ä¼šåˆ é™¤è¿™ä¸€åˆ—çš„æ•°æ®ï¼›å¦‚æœæ˜¯æ•´å¼ è¡¨çº§åˆ«çš„ TTLï¼Œåˆ™ä¼šåˆ é™¤æ•´å¼ è¡¨çš„æ•°æ®ï¼›å¦‚æœåŒæ—¶è®¾ç½®ï¼Œåˆ™ä¼šä»¥å…ˆåˆ°æœŸçš„ä¸ºä¸»ã€‚</strong></p>
<p><strong>æ— è®ºæ˜¯åˆ—çº§åˆ«è¿˜æ˜¯è¡¨çº§åˆ«çš„ TTLï¼Œéƒ½éœ€è¦ä¾æ‰˜æŸä¸ª DateTime æˆ– Date ç±»å‹çš„å­—æ®µï¼Œé€šè¿‡å¯¹è¿™ä¸ªæ—¶é—´å­—æ®µçš„ INTERVAL æ“ä½œæ¥è¡¨è¿° TTL çš„è¿‡æœŸæ—¶é—´ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹è®¾ç½®çš„æ–¹å¼ã€‚</strong></p>
<p><strong>1ï¼‰åˆ—çº§åˆ«è®¾ç½® TTL</strong></p>
<p><strong>å¦‚æœæƒ³è¦è®¾ç½®åˆ—çº§åˆ«çš„ TTLï¼Œåˆ™éœ€è¦åœ¨å®šä¹‰è¡¨å­—æ®µçš„æ—¶å€™ä¸ºå®ƒä»¬å£°æ˜ TTL è¡¨è¾¾å¼ï¼Œä¸»é”®å­—æ®µä¸èƒ½è¢«å£°æ˜ TTLï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ttl_table_v1 (</span><br><span class="line">    id String,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    code String TTL create_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">10</span> <span class="keyword">SECOND</span>,</span><br><span class="line">    type UInt8 TTL create_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">10</span> <span class="keyword">SECOND</span> </span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ create_time æ˜¯æ—¥æœŸç±»å‹ï¼Œåˆ—å­—æ®µ code å’Œ type å‡è¢«è®¾ç½®äº† TTLï¼Œå®ƒä»¬çš„å­˜æ´»æ—¶é—´åœ¨ create_time å–å€¼çš„åŸºç¡€ä¹‹ä¸Šå‘åå»¶ç»­ 10 ç§’ã€‚å‡è®¾æŸä¸€æ¡æ•°æ®çš„ create_time çš„å€¼ä¸º dtï¼Œé‚£ä¹ˆå½“ç³»ç»Ÿæ—¶é—´è¶…è¿‡äº† dt + 10 ç§’ï¼Œè¯¥æ¡æ•°æ®çš„ codeã€type å°±ä¼šè¿‡æœŸã€‚</strong></p>
<blockquote>
<p><strong>é™¤äº† SECOND ä¹‹å¤–ï¼Œè¿˜æœ‰ MINUTEã€HOURã€DAYã€WEEKã€MONTHã€QUARTER å’Œ YEARã€‚</strong></p>
</blockquote>
<p><strong>ç°åœ¨å†™å…¥ä¸¤æ¡æµ‹è¯•æ•°æ®ï¼Œå…¶ä¸­ç¬¬ä¸€æ¡çš„ create_time å–å½“å‰çš„ç³»ç»Ÿæ—¶é—´ï¼Œç¬¬äºŒæ¡çš„ create_time æ¯”ç¬¬ä¸€æ¡å¤š 5 åˆ†é’Ÿã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> ttl_table_v1 </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, now(), <span class="string">&#x27;C1&#x27;</span>, <span class="number">1</span>), </span><br><span class="line">       (<span class="string">&#x27;A000&#x27;</span>, now() <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">5</span> <span class="keyword">MINUTE</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åé©¬ä¸Šè¿›è¡ŒæŸ¥è¯¢ï¼ˆæ‰‹é€Ÿè¦å¿«ï¼‰ï¼Œç„¶åç­‰ 10 ç§’è¿‡åï¼ˆä»å†™å…¥æ•°æ®çš„é‚£ä¸€åˆ»èµ·ï¼‰ï¼Œå†æŸ¥è¯¢ä¸€æ¬¡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829182030888-1275351927.png" alt="img"></p>
<p><strong>å†æ¬¡æŸ¥è¯¢ ttl_table_v1 ä¼šçœ‹åˆ°ï¼Œç”±äºç¬¬ä¸€æ¡æ•°æ®æ»¡è¶³ TTL è¿‡æœŸæ—¶é—´ï¼ˆå½“å‰ç³»ç»Ÿæ—¶é—´ &gt;&#x3D; create_time + 10 ç§’ï¼‰ï¼Œå®ƒä»¬çš„ code å’Œ type ä¼šè¢«è¿˜åŸä¸ºæ•°æ®ç±»å‹çš„é›¶å€¼ã€‚</strong></p>
<p><strong>å¦‚æœæƒ³è¦ä¿®æ”¹åˆ—å­—æ®µçš„ TTLï¼Œæˆ–è€…ä¸ºå·²æœ‰å­—æ®µæ·»åŠ  TTLï¼ˆä¸å¯ä»¥æ˜¯ä¸»é”®å­—æ®µï¼‰ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ ALTER è¯­å¥ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE ttl_table_v1 MODIFY COLUMN code String TTL create_time + INTERVAL 1 DAY</span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰è¡¨çº§åˆ«è®¾ç½® TTL</strong></p>
<p><strong>å¦‚æœæƒ³ä¸ºæ•´å¼ è¡¨è®¾ç½® TTLï¼Œéœ€è¦åœ¨ MergeTree çš„è¡¨å‚æ•°ä¸­å¢åŠ  TTL è¡¨è¾¾å¼ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ttl_table_v2 (</span><br><span class="line">    id String,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    code String TTL create_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">MINUTE</span>,</span><br><span class="line">    type UInt8</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time</span><br><span class="line">TTL create_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span></span><br></pre></td></tr></table></figure>

<p><strong>ttl_table_v2 æ•´å¼ è¡¨è¢«è®¾ç½®äº† TTLï¼Œå½“è§¦å‘ TTL æ¸…ç†æ—¶ï¼Œé‚£äº›æ»¡è¶³è¿‡æœŸæ—¶é—´çš„æ•°æ®è¡Œå°†è¢«æ•´è¡Œåˆ é™¤ã€‚åŒæ ·ï¼Œè¡¨çº§åˆ«çš„ TTL ä¹Ÿæ”¯æŒä¿®æ”¹ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE ttl_table_v2 MODIFY TTL create_time INTERVAL + 3 DAY</span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤–è¡¨çº§åˆ«çš„ TTL ä¹Ÿä¸æ”¯æŒå–æ¶ˆã€‚</strong></p>
<p><strong>3ï¼‰TTL è¿è¡Œæœºç†</strong></p>
<p><strong>åœ¨äº†è§£äº†åˆ—çº§åˆ«å’Œè¡¨çº§åˆ« TTL çš„è¿è¡Œæœºç†åï¼Œç°åœ¨ç®€å•èŠä¸€èŠ TTL çš„è¿è¡Œæœºç†ã€‚å¦‚æœä¸€å¼  MergeTree è¡¨è¢«è®¾ç½®äº† TTL è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆåœ¨å†™å…¥æ•°æ®æ—¶ä¼šä»¥åˆ†åŒºä¸ºå•ä½ï¼Œåœ¨æ¯ä¸ªåˆ†åŒºç›®å½•å†…ç”Ÿæˆ ttl.txt æ–‡ä»¶ã€‚ä»¥ä¸Šé¢çš„ ttl_table_v2 ä¸ºä¾‹ï¼Œå®ƒè¢«è®¾ç½®äº†åˆ—çº§åˆ«çš„ TTLï¼Œä¹Ÿè¢«è®¾ç½®äº†è¡¨çº§åˆ«çš„ TTLï¼Œé‚£ä¹ˆåœ¨å†™å…¥æ•°æ®ä¹‹åï¼Œå®ƒçš„æ¯ä¸ªåˆ†åŒºç›®å½•å†…éƒ½ä¼šç”Ÿæˆ ttl.txt æ–‡ä»¶ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829182020856-1939143318.png" alt="img"></p>
<p><strong>æˆ‘ä»¬æŸ¥çœ‹ ttl.txt çš„å†…å®¹å‘ç°ï¼ŒåŸæ¥ MergeTree æ˜¯é€šè¿‡ä¸€ä¸² JSON ä¿å­˜äº† TTL çš„ç›¸å…³ä¿¡æ¯ï¼Œå…¶ä¸­ï¼š</strong></p>
<ul>
<li><code>columns ç”¨äºä¿å­˜åˆ—çº§åˆ«çš„ TTL ä¿¡æ¯</code></li>
<li><code>table ç”¨äºè¡¨çº§åˆ«çš„ TTL ä¿¡æ¯</code></li>
<li><code>min å’Œ max åˆ™ä¿å­˜äº†å½“å‰æ•°æ®åˆ†åŒºå†…ï¼ŒTTL æŒ‡å®šæ—¥æœŸå­—æ®µçš„æœ€å°å€¼å’Œæœ€å¤§å€¼åˆ†åˆ«ä¸ INTERVAL è¡¨è¾¾å¼è®¡ç®—åçš„æ—¶é—´æˆ³</code></li>
</ul>
<p><strong>å¦‚æœå°† table å±æ€§ä¸­çš„ min å’Œ max æ—¶é—´æˆ³æ ¼å¼åŒ–ï¼Œå¹¶åˆ†åˆ«ä¸ create_time æœ€å°å€¼ä¸æœ€å¤§å€¼è¿›è¡Œå¯¹æ¯”ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829182013609-1828101509.png" alt="img"></p>
<p><strong>åˆ™èƒ½å¤Ÿå°è¯ï¼Œttl.txt ä¸­è®°å½•çš„æå€¼åŒºé—´æ°å¥½ç­‰äºå½“å‰åˆ†åŒºå†… create_time çš„æœ€å°å€¼ã€æœ€å¤§å€¼åŠ  1 å¤©ï¼ˆ86400 ç§’ï¼‰ï¼Œä¸ TTL è¡¨è¾¾å¼ create_time + INTERVAL 1 DAY ç›¸ç¬¦åˆï¼ŒåŒç† ttl_min å’Œ ttl_max åˆ†åˆ«å‡å»ä¸€å¤©å³å¯å¾—åˆ° create_time è¿™ä¸€åˆ—çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚</strong></p>
<p><strong>åœ¨çŸ¥é“äº† TTL ä¿¡æ¯çš„è®°å½•æ–¹å¼ä¹‹åï¼Œå†æ¥çœ‹çœ‹å®ƒçš„å¤„ç†é€»è¾‘ã€‚</strong></p>
<ul>
<li><code>1. MergeTree ä»¥åˆ†åŒºç›®å½•ä¸ºå•ä½ï¼Œé€šè¿‡ ttl.txt æ–‡ä»¶è®°å½•è¿‡æœŸæ—¶é—´ï¼Œå¹¶å°†å…¶ä½œä¸ºåç»­çš„åˆ¤æ–­ä¾æ®</code></li>
<li><code>2. æ¯å½“å†™å…¥ä¸€æ‰¹æ•°æ®æ—¶ï¼Œéƒ½ä¼šåŸºäº INTERVAL è¡¨è¾¾å¼çš„è®¡ç®—ç»“æœä¸ºè¿™ä¸ªåˆ†åŒºç”Ÿæˆ ttl.txt æ–‡ä»¶</code></li>
<li><code>3. åªæœ‰ MergeTree åœ¨å¯¹å±äºç›¸åŒåˆ†åŒºçš„å¤šä¸ªåˆ†åŒºç›®å½•è¿›è¡Œåˆå¹¶æ—¶ï¼Œæ‰ä¼šè§¦å‘åˆ é™¤ TTL è¿‡æœŸæ•°æ®çš„é€»è¾‘</code></li>
<li><code>4. åœ¨é€‰æ‹©åˆ é™¤çš„åˆ†åŒºæ—¶ï¼Œä¼šä½¿ç”¨è´ªå©ªç®—æ³•ï¼Œå®ƒçš„ç®—æ³•è§„åˆ™æ˜¯å°½å¯èƒ½æ‰¾åˆ°ä¼šæœ€æ—©è¿‡æœŸçš„ã€åŒæ—¶å¹´çºªåˆæ˜¯æœ€è€çš„åˆ†åŒºï¼ˆåˆå¹¶æ¬¡æ•°æ›´å¤šï¼ŒMaxBlockNum æ›´å¤§çš„ï¼‰</code></li>
<li><code>5. å¦‚æœä¸€ä¸ªåˆ†åŒºå†…æŸä¸€åˆ—æ•°æ®å› ä¸º TTL åˆ°æœŸå…¨éƒ¨è¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆåœ¨åˆå¹¶ä¹‹åç”Ÿæˆçš„æ–°åˆ†åŒºç›®å½•ä¸­ï¼Œå°†ä¸ä¼šå†åŒ…å«è¯¥åˆ—å¯¹åº”çš„ bin æ–‡ä»¶å’Œ mrk æ–‡ä»¶ï¼Œå¦‚æœåˆ—æ•°æ®åˆ†å¼€å­˜å‚¨çš„è¯</code></li>
</ul>
<p><strong>TTL é»˜è®¤çš„åˆå¹¶é¢‘ç‡ç”± MergeTree çš„ merge_with_ttl_timeout å‚æ•°æ‰€æ§åˆ¶ï¼Œé»˜è®¤ä¸º 86400 ç§’ã€ä¹Ÿå°±æ˜¯ 1 å¤©ã€‚å®ƒç»´æŠ¤çš„æ˜¯ä¸€ä¸ªä¸“æœ‰çš„ TTL ä»»åŠ¡é˜Ÿåˆ—ï¼Œæœ‰åˆ«äº MergeTree çš„å¸¸è§„åˆå¹¶ä»»åŠ¡ï¼Œè¿™ä¸ªå€¼å¦‚æœè®¾ç½®çš„è¿‡å°ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½æŸè€—ã€‚å½“ç„¶é™¤äº†è¢«åŠ¨è§¦å‘ TTL åˆå¹¶å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ optimize å¼ºåˆ¶è§¦å‘åˆå¹¶ï¼š</strong></p>
<ul>
<li><code>optimize TABLE table_name PARTITION åˆ†åŒºåï¼šè§¦å‘ä¸€ä¸ªåˆ†åŒºåˆå¹¶</code></li>
<li><code>optimize TABLE table_name FINALï¼šè§¦å‘æ‰€æœ‰åˆ†åŒºåˆå¹¶</code></li>
</ul>
<p><strong>æœ€åï¼ŒClickHouse è™½ç„¶æ²¡æœ‰æä¾›åˆ é™¤ TTL çš„å£°æ˜æ–¹æ³•ï¼Œä½†æ˜¯æä¾›äº†æ§åˆ¶ TTL åˆå¹¶ä»»åŠ¡çš„å¯åœæ–¹æ³•ã€‚</strong></p>
<ul>
<li><code>SYSTEM STOP/START TTL MERGESï¼šæ§åˆ¶å…¨å±€ MergeTree è¡¨å¯åœ</code></li>
<li><code>SYSTEM STOP/START TTL MERGES table_nameï¼šæ§åˆ¶æŒ‡å®š MergeTree å¯åœ</code></li>
</ul>
<h4 id="å¤šè·¯å¾„å­˜å‚¨ç­–ç•¥"><a href="#å¤šè·¯å¾„å­˜å‚¨ç­–ç•¥" class="headerlink" title="å¤šè·¯å¾„å­˜å‚¨ç­–ç•¥"></a>å¤šè·¯å¾„å­˜å‚¨ç­–ç•¥</h4><p><strong>åœ¨ ClickHouse 19.15 ç‰ˆæœ¬ä¹‹å‰ï¼ŒMergeTree åªæ”¯æŒå•è·¯å¾„å­˜å‚¨ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«å†™å…¥ config.xml é…ç½®ä¸­çš„ path æŒ‡å®šçš„è·¯å¾„ä¸‹ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829182004024-1343945799.png" alt="img"></p>
<p><strong>å³ä½¿æœåŠ¡å™¨æŒ‚è½½äº†å¤šå—ç£ç›˜ï¼Œä¹Ÿæ— æ³•æœ‰æ•ˆåˆ©ç”¨è¿™äº›å­˜å‚¨ç©ºé—´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œä» 19.15 ç‰ˆæœ¬å¼€å§‹ï¼ŒMergeTree å®ç°äº†è‡ªå®šä¹‰å­˜å‚¨ç­–ç•¥çš„åŠŸèƒ½ï¼Œæ”¯æŒä»¥æ•°æ®åˆ†åŒºä¸ºæœ€å°ç§»åŠ¨å•å…ƒï¼Œå°†åˆ†åŒºç›®å½•å†™å…¥å¤šå—ç£ç›˜ç›®å½•ã€‚</strong></p>
<p><strong>è€Œæ ¹æ®é…ç½®ç­–ç•¥çš„ä¸åŒï¼Œç›®å‰å¤§è‡´æœ‰ä¸‰ç±»å­˜å‚¨ç­–ç•¥ã€‚</strong></p>
<ul>
<li><strong>é»˜è®¤ç­–ç•¥ï¼šMergeTree åŸæœ¬çš„å­˜å‚¨ç­–ç•¥ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼Œæ‰€æœ‰åˆ†åŒºä¼šè‡ªåŠ¨ä¿å­˜åˆ° config.xml é…ç½®ä¸­ path æŒ‡å®šçš„è·¯å¾„ä¸‹ã€‚</strong></li>
<li><strong>JBOD ç­–ç•¥ï¼šè¿™ç§ç­–ç•¥é€‚åˆæœåŠ¡å™¨æŒ‚è½½äº†å¤šå—ç£ç›˜ï¼Œä½†æ²¡æœ‰åš RAID çš„åœºæ™¯ã€‚JBOD çš„å…¨ç§°æ˜¯ Just a Bunch of Disksï¼Œå®ƒæ˜¯ä¸€ç§è½®è¯¢ç­–ç•¥ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ INSERT æˆ–è€… MERGEï¼Œæ‰€äº§ç”Ÿçš„æ–°åˆ†åŒºä¼šè½®è¯¢å†™å…¥å„ä¸ªç£ç›˜ã€‚è¿™ç§ç­–ç•¥çš„æ•ˆæœç±»ä¼¼äº RAID 0ï¼Œå¯ä»¥é™ä½å•å—ç£ç›˜çš„è´Ÿè½½ï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹èƒ½å¤Ÿå¢åŠ æ•°æ®å¹¶è¡Œè¯»å†™çš„æ€§èƒ½ã€‚å¦‚æœå•å—ç£ç›˜å‘ç”Ÿæ•…éšœï¼Œåˆ™ä¼šä¸¢æ‰åº”ç”¨ JBOD ç­–ç•¥å†™å…¥çš„è¿™éƒ¨åˆ†æ•°æ®ï¼Œä½†è¿™åˆä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åˆ©ç”¨å‰¯æœ¬æœºåˆ¶æ¥ä¿éšœæ•°æ®çš„å¯é æ€§ï¼ˆå‰¯æœ¬æœºåˆ¶åé¢è¯´ï¼‰ã€‚</strong></li>
<li><strong>HOT&#x2F;COLD ç­–ç•¥ï¼šè¿™ç§ç­–ç•¥é€‚åˆæœåŠ¡å™¨æŒ‚è½½äº†ä¸åŒç±»å‹ç£ç›˜çš„åœºæ™¯ï¼Œå°†å­˜å‚¨ç£ç›˜åˆ†ä¸º HOT å’Œ COLD ä¸¤ç±»åŒºåŸŸã€‚HOT åŒºåŸŸä½¿ç”¨ SSD è¿™ç±»é«˜æ€§èƒ½å­˜å‚¨åª’ä»‹ï¼Œæ³¨é‡å­˜å‚¨æ€§èƒ½ï¼›COLD åŒºåŸŸåˆ™ä½¿ç”¨ HDD è¿™ç±»é«˜å®¹é‡å­˜å‚¨åª’ä»‹ï¼Œæ³¨é‡å­˜å‚¨ç»æµæ€§ã€‚æ•°æ®åœ¨å†™å…¥ MergeTree ä¹‹åˆï¼Œä¼šåœ¨ HOT åŒºåŸŸåˆ›å»ºåˆ†åŒºç›®å½•ç”¨äºä¿å­˜æ•°æ®ï¼Œå½“åˆ†åŒºæ•°æ®å¤§å°ç´¯ç§¯åˆ°é˜ˆå€¼æ—¶ï¼Œæ•°æ®ä¼šè‡ªåŠ¨ç§»åŠ¨åˆ° COLD åŒºåŸŸã€‚è€Œåœ¨æ¯ä¸ªåŒºåŸŸçš„å†…éƒ¨ï¼Œä¹Ÿæ”¯æŒå®šä¹‰å¤šä¸ªç£ç›˜ï¼Œæ‰€ä»¥åœ¨å•ä¸ªåŒºåŸŸçš„å†™å…¥è¿‡ç¨‹ä¸­ï¼Œä¹Ÿèƒ½åº”ç”¨ JBOD ç­–ç•¥ã€‚</strong></li>
</ul>
<p><strong>å­˜å‚¨é…ç½®éœ€è¦é¢„å…ˆå®šä¹‰åœ¨ config.xml é…ç½®æ–‡ä»¶ä¸­ï¼Œç”± storage_configuration è¡¨ç¤ºï¼Œè€Œ storage_configuration ä¹‹ä¸‹åˆåˆ†ä¸º disks å’Œ policies ä¸¤ç»„æ ‡ç­¾ï¼Œåˆ†åˆ«è¡¨ç¤ºç£ç›˜ä¸å­˜å‚¨ç­–ç•¥ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_name_a</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç£ç›˜åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/ch/data1<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_name_a</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_name_b</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç£ç›˜åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/ch/data2<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_name_b</span>&gt;</span>	</span><br><span class="line">    <span class="tag">&lt;/<span class="name">disks</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">policie_name_a</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç­–ç•¥åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">volume_name_a</span>&gt;</span>  <span class="comment">&lt;!-- è‡ªå®šä¹‰å·åç§° --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_name_a<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_name_b<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">max_data_part_size_bytes</span>&gt;</span>disk_name_a<span class="tag">&lt;/<span class="name">max_data_part_size_bytes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">volume_name_a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">move_factor</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">move_factor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">policie_name_a</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">policie_name_b</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">policie_name_b</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è§£é‡Šä¸€ä¸‹é‡Œé¢æ ‡ç­¾çš„å«ä¹‰ï¼Œé¦–å…ˆæ˜¯ disks æ ‡ç­¾ï¼š</strong></p>
<ul>
<li><code>ï¼Œå¿…å¡«é¡¹ï¼Œå¿…é¡»å…¨å±€å”¯ä¸€ï¼Œè¡¨ç¤ºç£ç›˜çš„è‡ªå®šä¹‰åç§°ï¼Œæ˜¾ç„¶å¯ä»¥å®šä¹‰å¤šå—ç£ç›˜</code></li>
<li><code>ï¼Œå¿…å¡«é¡¹ï¼Œç”¨äºæŒ‡å®šç£ç›˜è·¯å¾„</code></li>
<li><code>ï¼šé€‰å¡«é¡¹ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œç”¨äºå®šä¹‰ç£ç›˜çš„é¢„ç•™ç©ºé—´</code></li>
</ul>
<p><strong>ç„¶åæ˜¯ policies æ ‡ç­¾ï¼Œåœ¨ policies æ ‡ç­¾é‡Œé¢éœ€è¦å¼•ç”¨å·²ç»å®šä¹‰çš„ disks ç£ç›˜ï¼Œå¹¶ä¸”åŒæ ·æ”¯æŒå®šä¹‰å¤šä¸ªç­–ç•¥ï¼š</strong></p>
<ul>
<li><code>ï¼Œå¿…å¡«é¡¹ï¼Œå¿…é¡»å…¨å±€å”¯ä¸€ï¼Œè¡¨ç¤ºç­–ç•¥çš„è‡ªå®šä¹‰åç§°</code></li>
<li><code>ï¼Œå¿…é¡»å¡«ï¼Œæ¯”å¦‚å…¨å±€å”¯ä¸€ï¼Œè¡¨ç¤ºå·çš„è‡ªå®šä¹‰åç§°</code></li>
<li><code>ï¼Œå¿…å¡«é¡¹ï¼Œç”¨äºå…³è”  é…ç½®å†…çš„ç£ç›˜ï¼Œå¯ä»¥å£°æ˜å¤šä¸ª diskï¼ŒMergeTree ä¼šæŒ‰ç…§å£°æ˜çš„é¡ºåºé€‰æ‹© disk</code></li>
<li><code>ï¼Œé€‰å¡«é¡¹ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸ªå·çš„å•ä¸ª disk ç£ç›˜ä¸­ï¼Œä¸€ä¸ªæ•°æ®åˆ†åŒºçš„æœ€å¤§åˆ†åŒºé˜ˆå€¼ã€‚å¦‚æœå½“å‰åˆ†åŒºçš„æ•°æ®å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™ä¹‹åçš„åˆ†åŒºä¼šå†™å…¥ä¸‹ä¸€ä¸ª disk ç£ç›˜</code></li>
<li><code>ï¼Œé€‰å¡«é¡¹ï¼Œé»˜è®¤ä¸º 0.1ï¼Œå¦‚æœå½“å‰å·çš„å¯ç”¨ç©ºé—´å°äº factor å› å­ï¼Œå¹¶ä¸”å®šä¹‰äº†å¤šä¸ªå·ï¼Œåˆ™æ•°æ®ä¼šè‡ªåŠ¨å‘ä¸‹ä¸€ä¸ªå·ç§»åŠ¨</code></li>
</ul>
<p><strong>1. JBOD ç­–ç•¥æ¼”ç¤º</strong></p>
<p><strong>æ³¨æ„ï¼šstorage_configuration åœ¨ config.xml é‡Œé¢æ˜¯æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åŠ è¿›å»ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_hot1</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç£ç›˜åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/hotdata1/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_hot1</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_hot2</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç£ç›˜åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/hotdata2/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_hot2</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_cold</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç£ç›˜åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/colddata/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_cold</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">disks</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- é…ç½®å­˜å‚¨ç­–ç•¥ï¼Œåœ¨ volumes å·ä¸‹é¢å¼•ç”¨ä¸Šé¢å®šä¹‰çš„ä¸¤å—ç£ç›˜ï¼Œç»„æˆç£ç›˜ç»„ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jbod_policies</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰ç­–ç•¥åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jbod</span>&gt;</span>  <span class="comment">&lt;!-- è‡ªå®šä¹‰å·åç§° --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_hot1<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_hot2<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jbod</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jbod_policies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤ä¸€ä¸ªæ”¯æŒ JBOD çš„å­˜å‚¨ç­–ç•¥å°±é…ç½®å¥½äº†ï¼Œä½†åœ¨æ­£å¼åº”ç”¨ä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚é¦–å…ˆæˆ‘ä»¬è¦å°†ç›®å½•åˆ›å»ºå¥½ï¼Œç„¶åå°†è·¯å¾„æˆæƒï¼Œè®© ClickHouse ç”¨æˆ·æ‹¥æœ‰ç›¸åº”çš„è¯»å†™æƒé™ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># mkdir hotdata1 hotdata2 colddata</span></span><br><span class="line">[root@satori ~]<span class="comment"># sudo chown clickhouse:clickhouse -R /root</span></span><br></pre></td></tr></table></figure>

<p><strong>ç”±äºå­˜å‚¨é…ç½®ä¸æ”¯æŒåŠ¨æ€æ›´æ–°ï¼Œä¸ºäº†ä½¿é…ç½®ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦é‡å¯ ClickHouse æœåŠ¡ï¼Œç›´æ¥ clickhouse restart å³å¯ã€‚é‡å¯ä¹‹åå¯ä»¥æŸ¥è¯¢ç³»ç»Ÿè¡¨æ¥éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181952844-2036224644.png" alt="img"></p>
<p><strong>é€šè¿‡ system.disks ç³»ç»Ÿè¡¨å¯ä»¥çœ‹åˆ°åˆšæ‰å£°æ˜çš„ä¸‰å—ç£ç›˜é…ç½®å·²ç»ç”Ÿæ•ˆï¼Œæ¥ç€éªŒè¯é…ç½®ç­–ç•¥ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181945403-153314088.png" alt="img"></p>
<p><strong>é€šè¿‡ system.storage_policies ç³»ç»Ÿè¡¨å¯ä»¥çœ‹åˆ°åˆšæ‰é…ç½®çš„å­˜å‚¨ç­–ç•¥ä¹Ÿå·²ç»ç”Ÿæ•ˆäº†ï¼Œç°åœ¨åˆ›å»ºä¸€å¼  MergeTree è¡¨ï¼Œç”¨äºæµ‹è¯• jbod_policies å­˜å‚¨ç­–ç•¥çš„æ•ˆæœã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181936302-1008011642.png" alt="img"></p>
<p><strong>åœ¨å®šä¹‰ MergeTree æ•°æ®è¡¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ storage_policy é…ç½®é¡¹æŒ‡å®šåˆšæ‰çš„ jbod_policies å­˜å‚¨ç­–ç•¥ï¼Œæ³¨æ„ï¼šå­˜å‚¨ç­–ç•¥ä¸€æ—¦è®¾ç½®ï¼Œå°±ä¸èƒ½å†ä¿®æ”¹äº†ã€‚ä¸‹é¢æ¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181927735-1046606557.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€å—åˆ†åŒºå†™å…¥äº†ç¬¬ä¸€å—ç£ç›˜ disk_hot1ï¼Œç„¶åæˆ‘ä»¬å†æ¥å†™å…¥ç¬¬äºŒæ‰¹æ•°æ®ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºç¬¬äºŒä¸ªåˆ†åŒºç›®å½•ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181919064-149165324.png" alt="img"></p>
<p><strong>æ’å…¥æ•°æ®ä¹‹åå†æ¬¡æŸ¥çœ‹åˆ†åŒºç³»ç»Ÿè¡¨ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªåˆ†åŒºå†™å…¥äº†ç¬¬äºŒå—ç£ç›˜ã€‚æœ€åå†è§¦å‘ä¸€æ¬¡åˆ†åŒºåˆå¹¶åŠ¨ä½œï¼Œç”Ÿæˆä¸€ä¸ªåˆå¹¶åçš„æ–°åˆ†åŒºç›®å½•ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181911463-1216561303.png" alt="img"></p>
<p><strong>è¿˜æ˜¯æŸ¥è¯¢åˆ†åŒºç³»ç»Ÿè¡¨ï¼Œå¯ä»¥çœ‹åˆ°åˆå¹¶åç”Ÿæˆçš„ all_1_2_1 åˆ†åŒºå†æ¬¡å†™å…¥äº†ç¬¬ä¸€å—ç£ç›˜ disk_hot1ã€‚</strong></p>
<p><strong>ç›¸ä¿¡æ­¤æ—¶åº”è¯¥è§£é‡Šæ¸…é™¤ JBOD ç­–ç•¥çš„å·¥ä½œæ–¹å¼äº†ï¼Œåœ¨è¿™ä¸ªç­–ç•¥ä¸­ï¼Œç”±å¤šä¸ªç£ç›˜ç»„æˆä¸€ä¸ªç£ç›˜ç»„ï¼Œå³ volume å·ã€‚æ¯å½“ç”Ÿæˆä¸€ä¸ªæ–°æ•°æ®åˆ†åŒºçš„æ—¶å€™ï¼Œåˆ†åŒºç›®å½•ä¼šä¾ç…§ volume å·ä¸­ç£ç›˜å®šä¹‰çš„é¡ºåºï¼Œä¾æ¬¡è½®è¯¢å¹¶å†™å…¥å„ä¸ªç£ç›˜ã€‚</strong></p>
<p><strong>2. HOT&#x2F;COLD ç­–ç•¥æ¼”ç¤º</strong></p>
<p><strong>ç°åœ¨ä»‹ç» HOT&#x2F;COLD ç­–ç•¥çš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å°† JBOD ç­–ç•¥å¯¹åº”çš„é…ç½®åŸå°ä¸åŠ¨çš„æ‹·è´è¿‡æ¥ï¼Œç„¶ååœ¨é‡Œé¢åŠ ä¸€ä¸ªæ–°ç­–ç•¥ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">storage_configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_hot1</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/hotdata1/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_hot1</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_hot2</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/hotdata2/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_hot2</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">disk_cold</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span>&gt;</span>/root/colddata/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keep_free_space_bytes</span>&gt;</span>1073741824<span class="tag">&lt;/<span class="name">keep_free_space_bytes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">disk_cold</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">disks</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jbod_policies</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jbod</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_hot1<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_hot2<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jbod</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jbod_policies</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- æ·»åŠ æ–°ç­–ç•¥ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">moving_from_hot_to_cold</span>&gt;</span>  <span class="comment">&lt;!-- è‡ªå®šä¹‰ç­–ç•¥åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">volumes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">hot</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰åç§°ï¼Œhot åŒºåŸŸç£ç›˜ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_hot1<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">max_data_part_size_bytes</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">max_data_part_size_bytes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">hot</span>&gt;</span>        </span><br><span class="line">                <span class="tag">&lt;<span class="name">cold</span>&gt;</span> <span class="comment">&lt;!-- è‡ªå®šä¹‰åç§°ï¼Œcold åŒºåŸŸç£ç›˜ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">disk</span>&gt;</span>disk_cold<span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">cold</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">volumes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">move_factor</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">move_factor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">moving_from_hot_to_cold</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">storage_configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç”¨æ–°é…ç½®å°†ä¹‹å‰çš„ JBOD é…ç½®ç»™æ›¿æ¢æ‰ï¼Œæˆ–è€…ç›´æ¥å°†æˆ‘ä»¬æ–°åŠ çš„éƒ¨åˆ†æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­å³å¯ï¼Œç„¶åé‡å¯ ClickHouseã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181901836-1655234789.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°æ–°é…ç½®çš„å­˜å‚¨ç­–ç•¥å·²ç»ç”Ÿæ•ˆäº†ï¼Œmoving_from_hot_to_cold å­˜å‚¨ç­–ç•¥æ‹¥æœ‰ hot å’Œ cold ä¸¤ä¸ªç£ç›˜å·ï¼Œåœ¨æ¯ä¸ªå·ä¸‹å„æ‹¥æœ‰ä¸€å—ç£ç›˜ã€‚æ³¨æ„ï¼šhot ç£ç›˜å·çš„ max_data_part_size åˆ—æ˜¾ç¤ºçš„å€¼ä¸º 1MBï¼Œè¿™ä¸ªå€¼çš„å«ä¹‰ä¸ºï¼Œåœ¨è¿™ä¸ªç£ç›˜å·ä¸‹ï¼Œå¦‚æœä¸€ä¸ªåˆ†åŒºçš„å¤§å°è¶…è¿‡ 1MBï¼Œåˆ™å®ƒéœ€è¦è¢«ç§»åŠ¨åˆ°ç´§é‚»çš„ä¸‹ä¸€ä¸ªç£ç›˜ã€‚å½“ç„¶è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œå®é™…å·¥ä½œä¸­ä¸ä¼šé…ç½®çš„è¿™ä¹ˆå°çš„ã€‚</strong></p>
<p><strong>é‚£ä¹ˆä¸‹é¢è¿˜æ˜¯åˆ›å»ºä¸€å¼  MergeTree è¡¨ï¼Œç”¨äºæµ‹è¯• moving_from_hot_to_cold å­˜å‚¨ç­–ç•¥çš„æ•ˆæœã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hot_cold_table (id UInt64)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line">SETTINGS storage_policy <span class="operator">=</span> <span class="string">&#x27;moving_from_hot_to_cold&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨å®šä¹‰ MergeTree æ—¶ï¼Œä½¿ç”¨ storage_policy é…ç½®é¡¹æŒ‡å®šåˆšæ‰å®šä¹‰çš„å­˜å‚¨ç­–ç•¥ï¼Œå½“ç„¶å­˜å‚¨ç­–ç•¥ä¸€æ—¦å®šä¹‰å°±ä¸èƒ½å†ä¿®æ”¹äº†ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼Œé¦–å…ˆå†™å…¥ç¬¬ä¸€æ‰¹æ•°æ®ï¼ˆå°äº 1MBï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªåˆ†åŒºç›®å½•ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181852306-1069889650.png" alt="img"></p>
<p><strong>æŸ¥è¯¢åˆ†åŒºç³»ç»Ÿè¡¨ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºå†™å…¥äº† hot å·ã€‚é‚£ä¹ˆä¸‹é¢å°±æ¥å†™å…¥ç¬¬äºŒæ‰¹æ•°æ®ï¼Œæ•°æ®å¤§å°å’Œä¸Šæ¬¡ä¸€æ ·ï¼Œå½“ç„¶æ­¤æ—¶ä¼šåˆ›å»ºç¬¬äºŒä¸ªåˆ†åŒºç›®å½•ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181842923-483729542.png" alt="img"></p>
<p><strong>è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒä¸ªåˆ†åŒºä»ç„¶å†™å…¥äº† hot å·ï¼Œå› ä¸º hot å·çš„ max_data_part_size æ˜¯ 1MBï¼Œè€Œæ¯æ¬¡å†™å…¥æ•°æ®çš„å¤§å°æ²¡æœ‰è¶…è¿‡ 1MBï¼Œæ‰€ä»¥è‡ªç„¶éƒ½ä¿å­˜åˆ°äº†è¯¥ç£ç›˜ä¸‹ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥è§¦å‘ä¸€æ¬¡åˆ†åŒºçš„åˆå¹¶åŠ¨ä½œï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ†åŒºç›®å½•ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181835354-1979918308.png" alt="img"></p>
<p><strong>å½“ä¸¤ä¸ªåˆ†åŒºåˆå¹¶ä¹‹åï¼Œæ‰€åˆ›å»ºçš„æ–°åˆ†åŒºçš„å¤§å°è¶…è¿‡äº† 1MBï¼Œæ‰€ä»¥å®ƒä¼šè¢«å†™å…¥ cold å·ã€‚å½“ç„¶ä¸€æ¬¡æ€§å†™å…¥å¤§äº 1MB çš„æ•°æ®ï¼Œåˆ†åŒºä¹Ÿä¼šè¢«å†™å…¥ cold å·ã€‚</strong></p>
<p><strong>è‡³æ­¤æˆ‘ä»¬ç®—æ˜¯æ˜ç™½äº† HOT&#x2F;COLD ç­–ç•¥çš„å·¥ä½œæ–¹å¼äº†ï¼Œåœ¨è¿™ä¸ªç­–ç•¥ä¸­ï¼Œç”±å¤šä¸ªç£ç›˜å·ï¼ˆvolume å·ï¼‰ç»„æˆä¸€ä¸ª volume ç»„ã€‚æ¯å½“ç”Ÿæˆä¸€ä¸ªæ–°æ•°æ®åˆ†åŒºçš„æ—¶å€™ï¼ŒæŒ‰ç…§é˜ˆå€¼å¤§å°ï¼ˆmax_data_part_sizeï¼‰ï¼Œåˆ†åŒºç›®å½•ä¼šä¾ç…§ volume ç»„ä¸­ç£ç›˜å®šä¹‰çš„é¡ºåºï¼Œä¾æ¬¡è½®è¯¢å¹¶å†™å…¥å„ä¸ªå·ä¸‹çš„ç£ç›˜ã€‚</strong></p>
<p><strong>å¦å¤–ï¼Œè™½ç„¶ MergeTree çš„å­˜å‚¨ç­–ç•¥æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä½†åˆ†åŒºç›®å½•å´æ”¯æŒç§»åŠ¨ï¼Œä¾‹å¦‚å°†æŸä¸ªåˆ†åŒºç§»åŠ¨è‡³å½“å‰å­˜å‚¨ç­–ç•¥ä¸­ volume å·ä¸‹çš„å…¶å®ƒ disk ç£ç›˜ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> hot_cold_table MOVE PART <span class="string">&#x27;all_1_2_1&#x27;</span> <span class="keyword">TO</span> DISK <span class="string">&#x27;disk_hot1&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ–è€…å°†æŸä¸ªåˆ†åŒºç§»åŠ¨è‡³å½“å‰å­˜å‚¨ç­–ç•¥ä¸­å…¶å®ƒçš„ volume å·ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> hot_cold_table MOVE PART <span class="string">&#x27;all_1_2_1&#x27;</span> <span class="keyword">TO</span> VOLUME <span class="string">&#x27;cold&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181828118-1564848043.png" alt="img"></p>
<h3 id="ReplacingMergeTree"><a href="#ReplacingMergeTree" class="headerlink" title="ReplacingMergeTree"></a>ReplacingMergeTree</h3><p><strong>è™½ç„¶ MergeTree æ‹¥æœ‰ä¸»é”®ï¼Œä½†æ˜¯å®ƒçš„ä¸»é”®å´æ²¡æœ‰å”¯ä¸€çš„çº¦æŸï¼Œè¿™æ„å‘³ç€å³ä¾¿å¤šè¡Œæ•°æ®çš„ä¸»é”®ç›¸åŒï¼Œä¾æ—§èƒ½å¤Ÿæ­£ç¡®å†™å…¥ã€‚è€Œåœ¨æŸäº›åœºåˆæˆ‘ä»¬ä¸å¸Œæœ›æ•°æ®è¡¨ä¸­æœ‰é‡å¤çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ ReplacingMergeTree å°±ç™»åœºäº†ï¼Œå®ƒå°±æ˜¯ä¸ºæ•°æ®å»é‡è€Œè®¾è®¡çš„ï¼Œå¯ä»¥åœ¨åˆå¹¶åˆ†åŒºæ—¶åˆ é™¤é‡å¤çš„æ•°æ®ã€‚å› æ­¤å®ƒçš„å‡ºç°ï¼Œç¡®å®åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†é‡å¤æ•°æ®çš„é—®é¢˜ï¼Œå•Šå˜å˜ï¼Œä¸ºå•¥æ˜¯ä¸€å®šç¨‹åº¦ï¼Ÿå…ˆå–ä¸ªå…³å­ã€‚</strong></p>
<p><strong>åˆ›å»ºä¸€å¼  ReplacingMergeTree æ•°æ®è¡¨çš„è¯­æ³•å’Œåˆ›å»ºæ™®é€š MergeTree è¡¨åˆ«æ— äºŒè‡´ï¼Œåªéœ€è¦å°† ENGINE æ¢ä¸€ä¸‹å³å¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = ReplacingMergeTree(ver)</span><br></pre></td></tr></table></figure>

<p><strong>é‡Œé¢çš„å‚æ•° ver æ˜¯é€‰å¡«çš„ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæ•´å‹ã€Dateã€DateTime çš„å­—æ®µä½œä¸ºç‰ˆæœ¬å·ï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†å»é™¤é‡å¤æ•°æ®æ—¶æ‰€ä½¿ç”¨çš„ç®—æ³•ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€å¼  ReplacingMergeTree æ•°æ®è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> replace_table (</span><br><span class="line">    id String,</span><br><span class="line">    code String,</span><br><span class="line">    create_time DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, code)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œçš„ ORDER BY æ˜¯å»é™¤é‡å¤æ•°æ®çš„å…³é”®ï¼Œä¸æ˜¯ PRIMARY KEYï¼ŒORDERR BY å£°æ˜çš„è¡¨è¾¾å¼æ˜¯åç»­åˆ¤æ–­æ•°æ®æ˜¯å¦é‡å¤çš„ä¾æ®ã€‚åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæ•°æ®ä¼šåŸºäº id å’Œ code ä¸¤ä¸ªå­—æ®µè¿›è¡Œå»é‡ï¼Œæˆ‘ä»¬å†™å…¥å‡ æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replace_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-10 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-11 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C100&#x27;</span>, <span class="string">&#x27;2020-11-12 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C200&#x27;</span>, <span class="string">&#x27;2020-11-13 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A002&#x27;</span>, <span class="string">&#x27;C2&#x27;</span>, <span class="string">&#x27;2020-11-14 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A003&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>, <span class="string">&#x27;2020-11-15 15:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æ’å…¥äº† 6 æ¡æ•°æ®ï¼Œä½† create_time ä¸º 2020-11-10 15:00:00ã€2020-11-11 15:00:00 çš„ä¸¤æ¡æ•°æ®çš„ id å’Œ code æ˜¯é‡å¤çš„ï¼Œå› æ­¤ä¼šè¿›è¡Œå»é‡ï¼Œåªä¿ç•™é‡å¤æ•°æ®çš„æœ€åä¸€æ¡ï¼Œæ‰€ä»¥æœ€ç»ˆåªä¼šæœ‰ 5 æ¡æ•°æ®ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¿™ 6 æ¡æ•°æ®æ˜¯ä½¿ç”¨ä¸€ä¸ª INSERT è¯­å¥å¯¼å…¥çš„ï¼Œæ‰€ä»¥åœ¨å¯¼å…¥çš„æ—¶å€™ç›´æ¥å°±å»é‡äº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181813167-935728819.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°åªä¿ç•™äº†æœ€åä¸€æ¡é‡å¤æ•°æ®ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ä¸€ä¸ª INSERTï¼Œæ‰€ä»¥è¿™æ‰¹æ•°æ®ä¼šå†™å…¥åˆ°åŒä¸€ä¸ªåˆ†åŒºç›®å½•ã€‚å¦‚æœæ˜¯åŒä¸€åˆ†åŒºçš„ä¸åŒåˆ†åŒºç›®å½•ï¼ˆåˆ†å¤šæ‰¹å¯¼å…¥ï¼‰ï¼Œé‚£ä¹ˆæ•°æ®æ˜¯ä¸ä¼šå»é‡çš„ï¼Œåªæœ‰åœ¨è¿›è¡Œåˆå¹¶çš„æ—¶å€™æ‰ä¼šè¿›è¡Œå»é‡ã€‚ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬å†å†™å…¥å‡ æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replace_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-03 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-02 15:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶è¿™ä¸¤æ¡æ•°æ®ä¼šå†™å…¥æ–°çš„åˆ†åŒºç›®å½•ï¼Œä½†å®ƒä»¬çš„ id å’Œ code ä¹Ÿæ˜¯é‡å¤çš„ï¼Œå› æ­¤ä¼šå»è¿›è¡Œå»é‡ï¼Œæœ€ç»ˆæ–°ç”Ÿæˆçš„åˆ†åŒºç›®å½•ä¸­åªä¼šæœ‰ä¸€æ¡æ•°æ®ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181805763-97212981.png" alt="img"></p>
<p><strong>ClickHouse çš„æ§åˆ¶å°åšçš„è¿˜æ˜¯å¾ˆäººæ€§åŒ–çš„ï¼Œä¸åŒåˆ†åŒºç›®å½•çš„æ•°æ®æ˜¯åˆ†å¼€æ˜¾ç¤ºçš„ï¼Œå½“ç„¶æˆ‘ä»¬åœ¨è·å–åˆ°çš„æ•°æ®æœ¬èº«æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œåªæ˜¯ ClickHouse çš„æ§åˆ¶å°æ–¹ä¾¿ä½ è§‚å¯Ÿè€Œåˆ†å¼€æ˜¾ç¤ºäº†ã€‚æˆ‘ä»¬çœ‹åˆ°ç¬¬äºŒä¸ªåˆ†åŒºç›®å½•ä¸­åªæœ‰ä¸€æ¡æ•°æ®ï¼Œå› ä¸ºå¯¼å…¥çš„ä¸¤æ¡æ•°æ®çš„ id å’Œ code æ˜¯é‡å¤çš„ï¼Œåœ¨å†™å…¥åŒä¸€ä¸ªåˆ†åŒºç›®å½•çš„æ—¶å€™ä¼šå…ˆå¯¹æ•°æ®è¿›è¡Œå»é‡ã€‚ä½†æ˜¯ä¸åŒåˆ†åŒºç›®å½•çš„ä¹‹é—´çš„æ•°æ®æ˜¯å¯ä»¥é‡å¤çš„ï¼Œå› ä¸ºå»é‡æ˜¯ä»¥åˆ†åŒºç›®å½•ä¸ºå•ä½çš„ï¼Œè€Œä¸€ä¸ªåˆ†åŒºå¯ä»¥å¯¹åº”å¤šä¸ªåˆ†åŒºç›®å½•ï¼Œæ‰€ä»¥ä¸Šé¢å‡ºç°äº†ä¸¤ä¸ª A001ã€C1ï¼Œå› ä¸ºå®ƒä»¬ä½äºä¸åŒçš„åˆ†åŒºç›®å½•ã€‚åªæœ‰å½“è¿™äº›åˆ†åŒºç›®å½•è¿›è¡Œåˆå¹¶ã€ç”Ÿæˆæ–°çš„åˆ†åŒºç›®å½•æ—¶æ‰ä¼šè¿›è¡Œå»é‡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181759317-1132408541.png" alt="img"></p>
<p><strong>å½“ä¸åŒåˆ†åŒºç›®å½•çš„æ•°æ®è¿›è¡Œåˆå¹¶æ—¶ï¼Œæ•°æ®å†æ¬¡è¿›è¡Œäº†å»é‡ï¼Œä¼šä¿ç•™ååˆ›å»ºçš„åˆ†åŒºç›®å½•ä¸­çš„æ•°æ®ï¼Œå› æ­¤ create_time ä¸º 2020-11-02 15:00:00 çš„æ•°æ®ä¿ç•™äº†ä¸‹æ¥ã€‚å¹¶ä¸”æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒReplacingMergeTree åœ¨å»é™¤é‡å¤æ•°æ®æ—¶ï¼Œç¡®å®æ˜¯ä»¥æ’åºé”®ä¸ºå•ä½çš„ã€‚å¦‚æœä»¥ä¸»é”®å»é‡çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰ 3 æ¡ A001 äº†ã€‚</strong></p>
<p><strong>æ‰€ä»¥æš‚æ—¶å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</strong></p>
<ul>
<li><code>1. å»é‡æ˜¯ä»¥æ’åºé”®ä¸ºå‡†</code></li>
<li><code>2. å½“æ•°æ®å†™å…¥åŒä¸€ä¸ªåˆ†åŒºç›®å½•æ—¶ï¼Œä¼šç›´æ¥å¯¹é‡å¤æ•°æ®è¿›è¡Œå»é‡ï¼Œå¹¶ä¸”ä¿ç•™çš„æ˜¯æœ€åä¸€æ¡</code></li>
<li><code>3. åŒä¸€åˆ†åŒºã€ä½†ä½äºä¸åŒåˆ†åŒºç›®å½•çš„æ•°æ®ä¸ä¼šè¿›è¡Œå»é‡ï¼Œåªæœ‰åœ¨åˆå¹¶æˆæ–°çš„åˆ†åŒºç›®å½•æ—¶æ‰ä¼šè¿›è¡Œå»é‡ï¼Œå¹¶ä¸”ä¿ç•™çš„æ˜¯æœ€åä¸€ä¸ªåˆ†åŒºçš„æ•°æ®</code></li>
</ul>
<p><strong>ä¸è¿‡é—®é¢˜æ¥äº†ï¼Œè¦æ˜¯ä¸åŒåˆ†åŒºçš„æ•°æ®ä¼šä¸ä¼šå»é‡å‘¢ï¼Ÿå…¶å®åœ¨å¼€å¤´æˆ‘ä»¬å°±å·²ç»åŸ‹ä¸‹ä¼ç¬”äº†ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¼€å¤´è¯´äº† ReplacingMergeTree æ˜¯åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†æ•°æ®é‡å¤çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸åŒåˆ†åŒºçš„æ•°æ®é‡å¤å®ƒæ˜¯æ— æ³•è§£å†³çš„ã€‚</strong></p>
<p><strong>æˆ‘ä»¬ä¸Šé¢æ‰€æœ‰çš„æ•°æ®éƒ½ä½äº 2020-11 è¿™ä¸ªåˆ†åŒºä¸­ï¼Œé‚£ä¹ˆä¸‹é¢å†æ’å…¥ä¸€æ¡æ•°æ®ã€åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO replace_table VALUES (&#x27;A001&#x27;, &#x27;C1&#x27;, &#x27;2010-11-17 15:00:00&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬å°† 2020 æ”¹æˆ 2010ï¼Œç„¶åæµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181751295-1246488673.png" alt="img"></p>
<p><strong>å› æ­¤ä¸åŒåˆ†åŒºçš„æ•°æ®æ˜¯æ— æ³•è¿›è¡Œå»é‡çš„ï¼Œè¿™ä¹Ÿç®—æ˜¯ ReplacingMergeTree çš„ä¸€ä¸ªå±€é™æ€§ã€‚å½“ç„¶è¯´å±€é™æ€§æ„Ÿè§‰ä¹Ÿä¸æ˜¯å¾ˆåˆé€‚ï¼Œå› ä¸ºåˆ†åŒºçš„ç›®çš„å°±æ˜¯ä¸ºäº†å‡å°æŸ¥è¯¢æ—¶çš„æ•°æ®é‡ï¼Œå¦‚æœå¾€ä¸€ä¸ªåˆ†åŒºå¯¼å…¥æ•°æ®è¿˜è¦åœ¨ä¹å…¶å®ƒåˆ†åŒºã€çœ‹æ•°æ®æ˜¯å¦åœ¨å…¶å®ƒåˆ†åŒºä¸­å·²å‡ºç°ï¼Œé‚£è¿™ä¸å°±ç›¸å½“äºä¸§å¤±äº†åˆ†åŒºçš„æ„ä¹‰äº†å—ï¼Ÿ</strong></p>
<p><strong>ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œè¿™é‡Œä¸åŒåˆ†åŒºçš„æ•°æ®å…ˆä¸è€ƒè™‘ï¼Œå› ä¸ºå®ƒæ— æ³•å»é‡ï¼Œæˆ‘ä»¬å†è°ˆä¸€ä¸‹åŒä¸€ä¸ªåˆ†åŒºä¸­æ•°æ®å»é‡çš„é€»è¾‘ã€‚æˆ‘ä»¬è¯´å½“æ•°æ®é‡å¤æ—¶ä¼šä¿ç•™æœ€åä¸€æ¡ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›æŸä¸ªå­—æ®µçš„å€¼æœ€å¤§çš„é‚£ä¸€æ¡ä¿ç•™ä¸‹æ¥ï¼Œè¿™æ—¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è¯´åœ¨æŒ‡å®š ReplacingMergeTree çš„æ—¶å€™å¯ä»¥æŒ‡å®šå‚æ•°å—ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> replace_table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> replace_table (</span><br><span class="line">    id String,</span><br><span class="line">    code String,</span><br><span class="line">    create_time DateTime</span><br><span class="line">    <span class="comment">-- æŒ‡å®šå‚æ•°ï¼Œä»¥åå»é‡çš„æ—¶å€™ä¼šä¿ç•™ create_time æœ€å¤§çš„é‚£ä¸€æ¡æ•°æ®</span></span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree(create_time)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, code)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæ’å…¥å‡ æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replace_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-10 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-21 15:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-11 15:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç¤ºæ­¤æ—¶ä¼šä¿ç•™ create_time ä¸º 2020-11-21 15:00:00 çš„è®°å½•ï¼Œå› ä¸ºçš„å€¼æœ€å¤§ï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181742777-356270348.png" alt="img"></p>
<p><strong>ç„¶åå†æ’å…¥ä¸¤æ¡è®°å½•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replace_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-28 15:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replace_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;2020-11-27 15:00:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šæˆ‘ä»¬è¦åˆ†ä¸¤æ‰¹å¯¼å…¥ï¼Œç„¶åè¿›è¡Œåˆå¹¶ï¼Œæ˜¾ç„¶ 2020-11-28 15:00:00 è¿™æ¡ä¼šä¿ç•™ä¸‹æ¥ï¼Œè€Œä¸æ˜¯æœ€åä¸€ä¸ªåˆ†åŒºç›®å½•ä¸­æ•°æ®ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181736300-18731632.png" alt="img"></p>
<p><strong>æ‰€ä»¥æœ€åå†æ€»ç»“ä¸€ä¸‹ ReplacingMergeTree çš„ä½¿ç”¨é€»è¾‘ï¼š</strong></p>
<ul>
<li><code>1. ä½¿ç”¨ ORDER BY æ’åºé”®ä½œä¸ºåˆ¤æ–­æ•°æ®é‡å¤çš„å”¯ä¸€é”®</code></li>
<li><code>2. å½“å¯¼å…¥åŒä¸€åˆ†åŒºç›®å½•æ—¶ï¼Œä¼šç›´æ¥è¿›è¡Œå»é‡</code></li>
<li><code>3. å½“å¯¼å…¥ä¸åŒåˆ†åŒºç›®å½•æ—¶ï¼Œä¸ä¼šè¿›è¡Œå»é‡ï¼Œåªæœ‰å½“åˆ†åŒºç›®å½•åˆå¹¶æ—¶ï¼Œå±äºåŒä¸€åˆ†åŒºå†…çš„é‡å¤æ•°æ®æ‰ä¼šå»é‡ï¼›ä½†æ˜¯ä¸åŒåˆ†åŒºå†…çš„é‡å¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤</code></li>
<li><code>4. åœ¨è¿›è¡Œæ•°æ®å»é‡æ—¶ï¼Œå› ä¸ºåˆ†åŒºå†…çš„æ•°æ®å·²ç»æ˜¯åŸºäº ORDER BY æ’å¥½åºçš„ï¼Œæ‰€ä»¥èƒ½å¾ˆå®¹æ˜“åœ°æ‰¾åˆ°é‚£äº›ç›¸é‚»çš„é‡å¤çš„æ•°æ®</code></li>
<li><code>5. æ•°æ®å»é‡ç­–ç•¥æœ‰ä¸¤ç§ï¼šå¦‚æœæ²¡æœ‰è®¾ç½® ver ç‰ˆæœ¬å·ï¼Œåˆ™ä¿ç•™åŒä¸€ç»„é‡å¤æ•°æ®ä¸­çš„æœ€åä¸€æ¡ï¼›å¦‚æœè®¾ç½®äº† ver ç‰ˆæœ¬å·ï¼Œåˆ™ä¿ç•™åŒä¸€ç»„é‡å¤æ•°æ®ä¸­ ver å­—æ®µå–å€¼æœ€å¤§çš„é‚£ä¸€è¡Œ</code></li>
</ul>
<h3 id="SummingMergeTree"><a href="#SummingMergeTree" class="headerlink" title="SummingMergeTree"></a>SummingMergeTree</h3><p><strong>å‡è®¾æœ‰è¿™æ ·ä¸€ç§æŸ¥è¯¢éœ€æ±‚ï¼Œç»ˆç«¯ç”¨æˆ·åªéœ€è¦æŸ¥è¯¢æ•°æ®çš„æ±‡æ€»ç»“æœï¼Œä¸å…³å¿ƒæ˜ç»†æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®çš„æ±‡æ€»æ¡ä»¶æ˜¯é¢„å…ˆæ˜ç¡®çš„ï¼ˆGROUP BY æ¡ä»¶æ˜ç¡®ï¼Œä¸”ä¸ä¼šéšæ„æ”¹å˜ï¼‰ã€‚å¯¹äºè¿™æ ·çš„æŸ¥è¯¢åœºæ™¯ï¼ŒClickHouse è¦å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</strong></p>
<p><strong>æœ€ç›´æ¥çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ MergeTree å­˜å‚¨æ•°æ®ï¼Œç„¶åé€šè¿‡ GROUP BY èšåˆæŸ¥è¯¢ï¼Œå¹¶åˆ©ç”¨ SUM å‡½æ•°æ±‡æ€»ç»“æœã€‚è¿™ç§æ–¹æ¡ˆæœ¬èº«å®Œå…¨è¡Œçš„é€šï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªä¸å®Œç¾ä¹‹å¤„ï¼š</strong></p>
<ul>
<li><code>å­˜åœ¨é¢å¤–çš„å­˜å‚¨å¼€é”€ï¼šç»ˆç«¯ç”¨æˆ·ä¸ä¼šæŸ¥è¯¢ä»»ä½•æ˜ç»†æ•°æ®ï¼Œåªå…³å¿ƒæ±‡æ€»ç»“æœï¼Œæ‰€ä»¥ä¸åº”è¯¥ä¸€ç›´ä¿å­˜æ‰€æœ‰çš„æ˜ç»†æ•°æ®</code></li>
<li><code>å­˜åœ¨é¢å¤–çš„æŸ¥è¯¢å¼€é”€ï¼šç»ˆç«¯ç”¨æˆ·åªå…³å¿ƒæ±‡æ€»ç»“æœï¼Œè™½ç„¶ MergeTree æ€§èƒ½å¼ºå¤§ï¼Œä½†æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œå®æ—¶èšåˆè®¡ç®—ä¹Ÿæ˜¯ä¸€ç§æ€§èƒ½æ¶ˆè€—</code></li>
</ul>
<p><strong>è€Œ SummingMergeTree å°±æ˜¯ä¸ºäº†åº”å¯¹è¿™ç±»æŸ¥è¯¢åœºæ™¯è€Œç”Ÿçš„ï¼Œé¡¾åæ€ä¹‰å®ƒèƒ½å¤Ÿåœ¨åˆå¹¶åˆ†åŒºçš„æ—¶å€™æŒ‰ç…§é¢„å…ˆå®šä¹‰çš„çš„æ¡ä»¶æ±‡æ€»æ•°æ®ï¼Œå°†åŒä¸€åˆ†ç»„ä¸‹çš„å¤šè¡Œæ•°æ®æ±‡æ€»æˆä¸€è¡Œï¼Œè¿™æ ·æ—¢å‡å°‘äº†æ•°æ®è¡Œï¼Œåˆé™ä½äº†åç»­æ±‡æ€»æŸ¥è¯¢çš„å¼€é”€ã€‚</strong></p>
<p><strong>åœ¨ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒMergeTree çš„æ¯ä¸ªåˆ†åŒºå†…ï¼Œæ•°æ®éƒ½ä¼šæŒ‰ç…§ ORDER BY è¡¨è¾¾å¼æ’å¥½åºï¼Œä¸»é”®ç´¢å¼•éƒ½ä¼šæŒ‰ç…§ PRIMARY KEY å–å€¼å¹¶æ’å¥½åºã€‚è€Œé»˜è®¤æƒ…å†µä¸‹ ORDER BY å¯ä»¥ä»£æŒ‡ PRIMARY KEYï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦å£°æ˜ ORDER BY å³å¯ã€‚ä½†å¦‚æœéœ€è¦åŒæ—¶å®šä¹‰ ORDER BY å’Œ PRIMARY KEYï¼Œé€šå¸¸åªæœ‰ä¸€ç§å¯èƒ½ï¼Œé‚£å°±æ˜¯æ˜ç¡®å¸Œæœ› ORDER BY å’Œ PRIMARY KEY ä¸åŒï¼Œè€Œè¿™ç§æƒ…å†µåªä¼šåœ¨ä½¿ç”¨ SummingMergeTree å’Œ AggregatingMergeTree æ—¶æ‰ä¼šå‡ºç°ï¼Œå› ä¸ºè¿™ä¸¤è€…çš„èšåˆéƒ½æ˜¯æ ¹æ® ORDER BY è¿›è¡Œçš„ã€‚</strong></p>
<p><strong>å‡è®¾æœ‰ä¸€å¼  SummingMergeTree æ•°æ®è¡¨ï¼Œé‡Œé¢æœ‰ Aã€Bã€Cã€Dã€Eã€F å…­ä¸ªå­—æ®µï¼Œå¦‚æœéœ€è¦æŒ‰ç…§ Aã€Bã€Cã€D æ±‡æ€»ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºè¡¨ç»“æ„çš„æ—¶å€™éœ€è¦æŒ‡å®šï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (A, B, C, D)</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯è¿™æ ·ä¸»é”®ä¹Ÿè¢«å®šä¹‰æˆäº† Aã€Bã€Cã€Dï¼Œè€Œåœ¨ä¸šåŠ¡å±‚é¢å…¶å®åªéœ€è¦å¯¹ä¸šåŠ¡å­—æ®µ A è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤ï¼Œæ‰€ä»¥åº”è¯¥åªä½¿ç”¨ A å­—æ®µåˆ›å»ºä¸»é”®ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥è¿™ä¹ˆå®šä¹‰ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (A, B, C, D)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY A</span><br></pre></td></tr></table></figure>

<p><strong>ä½†å¦‚æœåŒæ—¶å£°æ˜äº† ORDER BY å’Œ PRIMARY KEYï¼Œé‚£ä¹ˆ MergeTree ä¼šå¼ºåˆ¶è¦æ±‚ PRIMARY KEY å¿…é¡»æ˜¯ ORDER BY çš„å‰ç¼€ï¼Œæ‰€ä»¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸è¡Œ</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (B, C)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY A</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¡Œ</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (B, C)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY B</span><br></pre></td></tr></table></figure>

<p><strong>è¿™ç§å¼ºåˆ¶çº¦æŸä¿éšœäº†å³ä¾¿åœ¨å®šä¹‰ä¸åŒçš„æƒ…å†µä¸‹ï¼Œä¸»é”®ä»ç„¶æ˜¯æ’åºé”®çš„å‰ç¼€ï¼Œä¸ä¼šå‡ºç°ç´¢å¼•ä¸æ•°æ®é¡ºåºæ··ä¹±çš„é—®é¢˜ã€‚å‡è®¾ç°åœ¨ä¸šåŠ¡å‘ç”Ÿäº†ç»†å¾®çš„å˜åŒ–ï¼Œéœ€è¦å‡å°‘å­—æ®µï¼Œå°†å…ˆå‰çš„ Aã€Bã€Cã€D æ”¹ä¸ºæŒ‰ç…§ Aã€B æ±‡æ€»ï¼Œåˆ™å¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹æ’åºé”®ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE table_name MODIFY ORDER BY (A, B)</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œå¦‚æœå‡å°‘å­—æ®µçš„è¯ï¼Œåªèƒ½ä»å³å¾€å·¦å‡å°‘ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹å‰æ˜¯æŒ‰ç…§ Aã€Bã€Cã€D è¿›è¡Œçš„æ±‡æ€»ï¼Œé‚£ä¹ˆå‡å°‘å­—æ®µçš„è¯ï¼Œæœ€ç»ˆå¯ä»¥æŒ‰ç…§ Aã€Bã€C æ±‡æ€»ã€å¯ä»¥æŒ‰ç…§ Aã€B æ±‡æ€»ã€å¯ä»¥æŒ‰ç…§ A æ±‡æ€»ï¼Œä½†æ˜¯ä¸èƒ½æŒ‰ç…§ Aã€C æˆ–è€… Aã€Dã€æˆ–è€… Aã€Cã€D ç­‰ç­‰è¿›è¡Œæ±‡æ€»ã€‚æ‰€ä»¥å‡å°‘å­—æ®µä¸€å®šæ˜¯ä»å³å¾€å·¦ä¾æ¬¡å‡å°‘ï¼Œä¸èƒ½å‡ºç°è·³è·ƒã€‚</strong></p>
<p><strong>é™¤æ­¤ä¹‹å¤–ï¼ŒORDER BY åªèƒ½åœ¨ç°æœ‰å­—æ®µçš„åŸºç¡€ä¸Šå‡å°‘å­—æ®µï¼Œå¦‚æœæ–°å¢å­—æ®µï¼Œåˆ™åªèƒ½æ·»åŠ é€šè¿‡ ALTER ADD COLUMN æ–°å¢çš„å­—æ®µã€‚ä½† ALTER æ˜¯ä¸€ç§å…ƒæ•°æ®çº§åˆ«çš„æ“ä½œï¼Œä¿®æ”¹æˆæœ¬å¾ˆä½ï¼Œç›¸æ¯”ä¸èƒ½ä¿®æ”¹çš„ä¸»é”®ï¼Œå·²ç»éå¸¸ä¾¿åˆ©äº†ã€‚</strong></p>
<p><strong>é‚£ä¹ˆä»‹ç» SummingMergeTree æ•°æ®è¡¨çš„åˆ›å»ºæ–¹å¼ï¼Œæ˜¾ç„¶éƒ½å·²ç»çŒœåˆ°äº†ï¼Œå› ä¸º MergeTree å®¶æ—çš„è¡¨å¼•æ“åˆ›å»ºæ–¹å¼éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å¼•æ“ä¸åŒç½¢äº†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ENGINE <span class="operator">=</span> SummingMergeTree((col1, col2, col3, ...))</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ col1ã€col2 ä¸º columns å‚æ•°å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªé€‰å¡«å‚æ•°ï¼Œç”¨äºè®¾ç½®é™¤ä¸»é”®å¤–çš„å…¶å®ƒæ•°å€¼ç±»å‹å­—æ®µï¼Œä»¥æŒ‡å®šè¢« SUM æ±‡æ€»çš„åˆ—å­—æ®µã€‚å¦‚æœä¸å¡«å†™æ­¤å‚æ•°ï¼Œåˆ™ä¼šå°†æ‰€æœ‰éä¸»é”®çš„æ•°å€¼ç±»å‹å­—æ®µè¿›è¡Œæ±‡æ€»ï¼Œä¸‹é¢å°±æ¥åˆ›å»ºä¸€å¼  SummingMergeTree è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> summing_table (</span><br><span class="line">    id String,</span><br><span class="line">    city String,</span><br><span class="line">    v1 UInt32,</span><br><span class="line">    v2 Float64,</span><br><span class="line">    create_time DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> SummingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, city)</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ä¸‹æ¥æ’å…¥å‡ æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> summing_table</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="number">10</span>, <span class="number">20.1</span>, <span class="string">&#x27;2020-05-10 17:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="number">20</span>, <span class="number">30.2</span>, <span class="string">&#x27;2020-05-20 17:00:00&#x27;</span>),</span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;shanghai&#x27;</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="string">&#x27;2020-05-10 17:00:00&#x27;</span>);</span><br><span class="line">       </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> summing_table</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="string">&#x27;2020-05-01 17:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> summing_table</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="number">60</span>, <span class="number">50</span>, <span class="string">&#x27;2020-10-10 17:00:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶æ­¤æ—¶ä¼šåˆ›å»ºä¸‰ä¸ªåˆ†åŒºç›®å½•ï¼Œ202005_1_\1_0ã€202005_2_\2_0ã€202010_1_\1_0ã€‚å¦å¤– SummingMergeTree å’Œ ReplacingMergeTree ç±»ä¼¼ï¼Œå¦‚æœå¯¼å…¥åŒä¸€åˆ†åŒºç›®å½•çš„æ•°æ®æœ‰é‡å¤çš„ï¼Œé‚£ä¹ˆç›´æ¥å°±èšåˆäº†ï¼Œä¸åŒåˆ†åŒºç›®å½•åˆ™ä¸ä¼šèšåˆï¼Œè€Œæ˜¯åœ¨åˆå¹¶ç”Ÿæˆæ–°åˆ†åŒºç›®å½•çš„æ—¶å€™ï¼Œå†å¯¹å±äºåŒä¸€åˆ†åŒºçš„å¤šä¸ªåˆ†åŒºç›®å½•é‡Œçš„æ•°æ®è¿›è¡Œèšåˆã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181722193-2107011356.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºç›®å½•ä¸­çš„ä¸‰æ¡æ•°æ®èšåˆæˆäº†ä¸¤æ¡ï¼Œç„¶åæ‰‹åŠ¨è§¦å‘åˆå¹¶åŠ¨ä½œï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181715636-1448937195.png" alt="img"></p>
<p><strong>ä¸åŒåˆ†åŒºç›®å½•ï¼ˆå±äºåŒä¸€åˆ†åŒºï¼‰é‡Œçš„æ•°æ®èšåˆåœ¨ä¸€èµ·äº†ï¼Œè‡³äºä¸åœ¨æ±‡æ€»å­—æ®µä¹‹åˆ—çš„ create_time åˆ™å–äº†åŒç»„å†…ç¬¬ä¸€è¡Œæ•°æ®çš„å€¼ï¼›è€Œä¸åŒåˆ†åŒºå¯¹åº”çš„åˆ†åŒºç›®å½•å°±ä¸ä¼šè¢«èšåˆäº†ï¼Œå› ä¸ºä¸åœ¨åŒä¸€ä¸ªåˆ†åŒºå†…ã€‚</strong></p>
<p><strong>å¦å¤– SummingMergeTree ä¹Ÿæ”¯æŒåµŒå¥—ç±»å‹çš„å­—æ®µï¼Œåœ¨ä½¿ç”¨åµŒå¥—ç±»å‹å­—æ®µæ—¶ï¼Œéœ€è¦è¢« SUM æ±‡æ€»çš„å­—æ®µå¿…é¡»ä»¥ä»¥ Map åç¼€ç»“å°¾ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> summing_table_nested (</span><br><span class="line">    id String,</span><br><span class="line">    nestMap Nested (</span><br><span class="line">        id UInt32,</span><br><span class="line">        key UInt32,</span><br><span class="line">        val UInt64</span><br><span class="line">    ),</span><br><span class="line">    create_time DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> SummingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨ä½¿ç”¨åµŒå¥—æ•°æ®ç±»å‹æ—¶ï¼Œé»˜è®¤ä¼šä»¥åµŒå¥—ç±»å‹ä¸­ç¬¬ä¸€ä¸ªå­—æ®µä½œä¸ºèšåˆæ¡ä»¶ Keyï¼Œå†™å…¥æµ‹è¯•æ•°æ®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181705340-308252351.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°å†™å…¥çš„æ—¶å€™å°±èšåˆäº†ï¼Œå¹¶ä¸”æŒ‰ç…§ nestMap é‡Œé¢çš„ id èšåˆçš„ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼šåµŒå¥—ç±»å‹æœ¬è´¨æ˜¯ä¸€ç§å¤šç»´æ•°ç»„çš„ç»“æ„ï¼Œé‡Œé¢çš„æ¯ä¸ªå­—æ®µéƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”é•¿åº¦è¦ç›¸ç­‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181659994-1690687124.png" alt="img"></p>
<p><strong>ç„¶åæˆ‘ä»¬å†å†™ä¸€æ¡æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> summing_table_nested <span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, [<span class="number">2</span>], [<span class="number">300</span>], [<span class="number">600</span>], <span class="string">&#x27;2020-08-10 17:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶æ­¤æ—¶ä¼šæ–°åˆ›å»ºä¸€ä¸ªåˆ†åŒºç›®å½•ï¼Œç„¶åæˆ‘ä»¬æ‰‹åŠ¨è§¦å‘åˆå¹¶ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181654283-926470290.png" alt="img"></p>
<p><strong>åˆå¹¶çš„ç»“æœæ˜¾ç„¶ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå½“ç„¶å¦‚æœåˆ†åŒºä¸åŒï¼Œé‚£ä¹ˆå°±æ— æ³•åˆå¹¶äº†ã€‚</strong></p>
<p><strong>å½“ç„¶æˆ‘ä»¬ä¸Šé¢é»˜è®¤æ˜¯æŒ‰ id è¿›è¡Œèšåˆçš„ï¼Œæˆ–è€…è¯´æ˜¯æŒ‰åµŒå¥—ç±»å‹ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œèšåˆï¼Œä½† ClickHouse ä¹Ÿæ”¯æŒä½¿ç”¨å¤åˆå­—æ®µï¼ˆKeyï¼‰ä½œä¸ºæ•°æ®èšåˆçš„æ¡ä»¶ã€‚ä¸ºäº†ä½¿ç”¨å¤åˆ Keyï¼Œåœ¨åµŒå¥—ç±»å‹çš„å­—æ®µä¸­ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªå­—æ®µä»¥å¤–ï¼Œä»»ä½•åç§°æ˜¯ä»¥ Keyã€Id æˆ–è€… Type ç»“å°¾çš„å­—æ®µï¼Œéƒ½å°†å’Œç¬¬ä¸€ä¸ªå­—æ®µä¸€èµ·ç»„æˆå¤åˆ Keyã€‚ä¾‹å¦‚æˆ‘ä»¬å°†ä¸Šé¢çš„å»ºè¡¨é€»è¾‘æ”¹ä¸€ä¸‹ï¼Œå°†å°å†™ key æ”¹æˆå¤§å†™ Keyï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> summing_table_nested (</span><br><span class="line">    id String,</span><br><span class="line">    nestMap Nested (</span><br><span class="line">        id UInt32,</span><br><span class="line">        Key UInt32,  <span class="comment">-- å¤§å†™ Key</span></span><br><span class="line">        val UInt64</span><br><span class="line">    ),</span><br><span class="line">    create_time DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> SummingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>è¯¥æ —å­ä¸­ä¼šä»¥ id å’Œ Key ä½œä¸ºèšåˆæ¡ä»¶ï¼Œå› æ­¤ä»¥ä¸Šå°±æ˜¯ SummingMergeTreeï¼Œæˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹å®ƒçš„å¤„ç†é€»è¾‘ï¼š</strong></p>
<ul>
<li><code>åªæœ‰ ORDER BY æ’åºé”®ä½œä¸ºèšåˆæ•°æ®çš„æ¡ä»¶ Key</code></li>
<li><code>å†™å…¥åŒä¸€åˆ†åŒºç›®å½•çš„æ•°æ®ä¼šèšåˆä¹‹ååœ¨å†™å…¥ï¼Œè€Œå±äºåŒä¸€åˆ†åŒºçš„ä¸åŒåˆ†åŒºç›®å½•çš„æ•°æ®ï¼Œåˆ™ä¼šåœ¨åˆå¹¶è§¦å‘æ—¶è¿›è¡Œæ±‡æ€»</code></li>
<li><code>ä¸åŒåˆ†åŒºçš„æ•°æ®ä¸ä¼šæ±‡æ€»åˆ°ä¸€èµ·</code></li>
<li><code>å¦‚æœåœ¨å®šä¹‰å¼•æ“æ—¶æŒ‡å®šäº† columns æ±‡æ€»åˆ—ï¼ˆéä¸»é”®çš„æ•°å€¼ç±»å‹å­—æ®µï¼‰ï¼Œåˆ™ SUM ä¼šæ±‡æ€»è¿™äº›åˆ—å­—æ®µï¼›å¦‚æœæœªæŒ‡å®šï¼Œåˆ™èšåˆæ‰€æœ‰éä¸»é”®çš„æ•°å€¼ç±»å‹å­—æ®µ</code></li>
<li><code>åœ¨è¿›è¡Œæ•°æ®æ±‡æ€»æ—¶ï¼Œå› ä¸ºåˆ†åŒºå†…çš„æ•°æ®å·²ç»åŸºäº ORDER BY è¿›è¡Œæ’åºï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°ç›¸é‚»ä¹Ÿæ‹¥æœ‰ç›¸åŒ Key çš„æ•°æ®</code></li>
<li><code>åœ¨æ±‡æ€»æ•°æ®æ—¶ï¼ŒåŒä¸€åˆ†åŒºå†…ç›¸åŒèšåˆ key çš„å¤šè¡Œæ•°æ®ä¼šåˆå¹¶æˆä¸€è¡Œï¼Œå…¶ä¸­æ±‡æ€»å­—æ®µä¼šè¿›è¡Œ SUM è®¡ç®—ï¼›å¯¹äºé‚£äº›éæ±‡æ€»å­—æ®µï¼Œåˆ™ä¼šä½¿ç”¨ç¬¬ä¸€è¡Œæ•°æ®çš„å–å€¼</code></li>
<li><code>æ”¯æŒåµŒå¥—ç»“æ„ï¼Œä½†åˆ—å­—æ®µåç§°å¿…é¡»ä»¥ Map åç¼€ç»“å°¾ï¼Œå¹¶ä¸”é»˜è®¤ä»¥ç¬¬ä¸€ä¸ªå­—æ®µä½œä¸ºèšåˆ Keyã€‚å¹¶ä¸”é™¤äº†ç¬¬ä¸€ä¸ªå­—æ®µä»¥å¤–ï¼Œä»»ä½•åç§°ä»¥ keyã€Id æˆ–è€… Type ä¸ºåç¼€ç»“å°¾çš„å­—æ®µéƒ½ä¼šå’Œç¬¬ä¸€ä¸ªå­—æ®µç»„æˆå¤åˆ Key</code></li>
</ul>
<h3 id="AggregatingMergeTree"><a href="#AggregatingMergeTree" class="headerlink" title="AggregatingMergeTree"></a>AggregatingMergeTree</h3><p><strong>æœ‰è¿‡æ•°ä»“å»ºè®¾ç»éªŒçš„ä½ ä¸€å®šçŸ¥é“æ•°æ®ç«‹æ–¹ä½“çš„æ¦‚å¿µï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨æ•°ä»“é¢†åŸŸååˆ†å¸¸è§çš„æ¨¡å‹ï¼Œå®ƒé€šè¿‡ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå°†éœ€è¦èšåˆçš„æ•°æ®é¢„å…ˆè®¡ç®—å‡ºæ¥ï¼ˆé¢„èšåˆï¼‰å¹¶ä¿å­˜ï¼Œåœ¨åç»­éœ€è¦èšåˆæŸ¥è¯¢åˆ°çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨ä¿å­˜å¥½çš„ç»“æœæ•°æ®ã€‚</strong></p>
<blockquote>
<p><strong>Kylin å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨é¢„èšåˆçš„æ•°æ®ä»“åº“ï¼Œæä¾› Hadoop&#x2F;Spark ä¹‹ä¸Šçš„ SQL æŸ¥è¯¢æ¥å£åŠå¤šç»´åˆ†æï¼ˆOLAPï¼‰èƒ½åŠ›ä»¥æ”¯æŒè¶…å¤§è§„æ¨¡æ•°æ®ã€‚å®ƒçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯åœ¨æ•°æ®é›†ä¸Šå®šä¹‰ä¸€ä¸ªæ˜Ÿå½¢æ¨¡å‹æˆ–è€…é›ªèŠ±æ¨¡å‹ï¼Œç„¶ååŸºäºæ¨¡å‹æ­å»ºæ•°æ®ç«‹æ–¹ä½“ï¼ˆcubeï¼‰å¹¶å°†ç»“æœå­˜å‚¨åœ¨ HBase ä¸­ï¼Œæœ€åä½¿ç”¨æ ‡å‡† SQL ä»¥åŠå…¶å®ƒ API è¿›è¡ŒæŸ¥è¯¢ï¼Œç”±äºæ•°æ®å·²ç»æå‰è®¡ç®—å¥½ï¼Œæ‰€ä»¥ä»…éœ€äºšç§’çº§å“åº”æ—¶é—´å³å¯è·å¾—æŸ¥è¯¢ç»“æœã€‚</strong></p>
</blockquote>
<p><strong>AggregatingMergeTree å°±æœ‰äº›æ•°æ®ç«‹æ–¹ä½“çš„æ„æ€ï¼Œå®ƒèƒ½å¤Ÿåœ¨åˆå¹¶åˆ†åŒºçš„æ—¶å€™æŒ‰ç…§é¢„å…ˆå®šä¹‰çš„æ¡ä»¶èšåˆæ•°æ®ã€‚åŒæ—¶ï¼Œæ ¹æ®é¢„å…ˆå®šä¹‰çš„èšåˆå‡½æ•°è®¡ç®—æ•°æ®å¹¶é€šè¿‡äºŒè¿›åˆ¶çš„æ ¼å¼å­˜å…¥è¡¨å†…ã€‚é€šè¿‡å°†åŒä¸€åˆ†ç»„ä¸‹çš„å¤šè¡Œæ•°æ®é¢„å…ˆèšåˆæˆä¸€è¡Œï¼Œæ—¢å‡å°‘äº†æ•°æ®è¡Œï¼Œåˆé™ä½äº†åç»­èšåˆæŸ¥è¯¢çš„å¼€é”€ã€‚å¯ä»¥è¯´ AggregatingMergeTree æ˜¯ SummingMergeTree çš„å‡çº§ç‰ˆï¼Œå®ƒä»¬çš„è®¸å¤šè®¾è®¡æ€è·¯å’Œç‰¹æ€§æ˜¯ä¸€è‡´çš„ï¼Œä¾‹å¦‚åŒæ—¶å®šä¹‰ ORDER BY å’Œ PRIMARY KEY çš„åŸå› å’Œç›®çš„ã€‚ä½†æ˜¯åœ¨ç”¨æ³•ä¸Šä¸¤è€…å­˜åœ¨æ˜æ˜¾å·®å¼‚ï¼Œåº”è¯¥è¯´ AggregatingMergeTree çš„å®šä¹‰æ–¹å¼æ˜¯ MergeTree å®¶æ—ä¸­æœ€ä¸ºç‰¹æ®Šçš„ä¸€ä¸ªã€‚å£°æ˜ä½¿ç”¨ AggregatingMergeTree çš„æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = AggregatingMergeTree()</span><br></pre></td></tr></table></figure>

<p><strong>AggregatingMergeTree æ²¡æœ‰ä»»ä½•é¢å¤–çš„è®¾ç½®å‚æ•°ï¼Œåœ¨åˆ†åŒºåˆå¹¶æ—¶ï¼Œåœ¨æ¯ä¸ªæ•°æ®åˆ†åŒºå†…ï¼Œä¼šæŒ‰ç…§ ORDER BY èšåˆã€‚è€Œä½¿ç”¨ä½•ç§èšåˆå‡½æ•°ï¼Œä»¥åŠé’ˆå¯¹å“ªäº›åˆ—å­—æ®µè¿›è¡Œè®¡ç®—ï¼Œåˆ™æ˜¯é€šè¿‡å®šä¹‰ AggregateFunction æ•°æ®ç±»å‹å®ç°çš„ã€‚ä»¥ä¸‹é¢çš„è¯­å¥ä¸ºä¾‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> agg_table (</span><br><span class="line">    id String,</span><br><span class="line">    city String,</span><br><span class="line">    code AggregateFunction(uniq, String),</span><br><span class="line">    <span class="keyword">value</span> AggregateFunction(sum, UInt32),</span><br><span class="line">    create_time DateTime</span><br><span class="line">) ENGINE <span class="operator">=</span> AggregatingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, city)</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id </span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°çš„ id å’Œ city æ˜¯èšåˆæ¡ä»¶ï¼Œç­‰åŒäºåœ¨ SQL è¯­å¥ä¸­æŒ‡å®š GROUP BY id, cityï¼›è€Œ code å’Œ value èšåˆå­—æ®µï¼Œå…¶è¯­ä¹‰ç­‰åŒäº uniq(code)ã€sum(value)ã€‚</strong></p>
<p><strong>AggregateFunction æ˜¯ ClickHouse æä¾›çš„ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒèƒ½å¤Ÿä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨ä¸­é—´çŠ¶æ€ç»“æœã€‚å…¶ä½¿ç”¨æ–¹æ³•ä¹Ÿååˆ†ç‰¹æ®Šï¼Œå¯¹äº AggregateFunction ç±»å‹çš„åˆ—å­—æ®µï¼Œæ•°æ®çš„æŸ¥è¯¢å’Œå†™å…¥éƒ½ä¸ä¼—ä¸åŒã€‚åœ¨å†™å…¥æ•°æ®æ—¶éœ€è¦è°ƒç”¨ *State å‡½æ•°ï¼ŒæŸ¥è¯¢æ•°æ®æ—¶åˆ™è°ƒç”¨ç›¸åº”çš„ *Merge å‡½æ•°ã€‚å…¶ä¸­ * è¡¨ç¤ºå®šä¹‰æ—¶ä½¿ç”¨çš„èšåˆå‡½æ•°ï¼Œä¾‹å¦‚ä¸Šé¢çš„å»ºè¡¨è¯­å¥ä¸­ä½¿ç”¨äº† uniq å’Œ sum å‡½æ•°ã€‚</strong></p>
<p><strong>é‚£ä¹ˆåœ¨å†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦è°ƒç”¨å¯¹åº”çš„ uniqState å’Œ sumState å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ INSERT SELECT è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> agg_table </span><br><span class="line"><span class="keyword">SELECT</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, uniqState(<span class="string">&#x27;code1&#x27;</span>), sumState(toUInt32(<span class="number">100</span>)), <span class="string">&#x27;2020-08-10 17:00:00&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;A000&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, uniqState(<span class="string">&#x27;code1&#x27;</span>), sumState(toUInt32(<span class="number">100</span>)), <span class="string">&#x27;2020-08-10 17:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>è€Œåœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œå¦‚æœä½¿ç”¨åˆ—å codeã€value è¿›è¡Œè®¿é—®çš„è¯ï¼Œè™½ç„¶ä¹Ÿèƒ½æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåªä¸è¿‡æ˜¾ç¤ºçš„æ˜¯æ— æ³•é˜…è¯»çš„äºŒè¿›åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨å¯¹åº”çš„ uniqMerge å’Œ sumState å‡½æ•°ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, city, uniqMerge(code), sumMerge(<span class="keyword">value</span>)</span><br><span class="line"><span class="keyword">FROM</span> agg_table </span><br><span class="line"><span class="comment">-- åœ¨ SQL è¯­å¥ä¸­èšåˆè¯­å¥è‚¯å®šè¦ç”¨ GROUP BY</span></span><br><span class="line"><span class="comment">-- ä½†åœ¨å®šä¹‰è¡¨ç»“æ„çš„æ—¶å€™ï¼Œèšåˆå­—æ®µæ˜¯ä½¿ç”¨ ORDER BY è¡¨ç¤ºçš„ï¼Œå½“ç„¶å®ƒæŒ‡å®šçš„ä¹Ÿæ˜¯æ’åºå­—æ®µ</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> id, city</span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181639262-723234817.png" alt="img"></p>
<p><strong>çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½è§‰å¾— AggregatingMergeTree ä½¿ç”¨èµ·æ¥æœ‰äº›è¿‡å»ç¹çäº†ï¼Œè¿æ­£å¸¸æ•°æ®å†™å…¥è¿˜è¦å€ŸåŠ© INSERT SELECTã€å¹¶ä¸”è°ƒç”¨ç‰¹æ®Šå‡½æ•°æ‰èƒ½å®ç°ï¼Œæ²¡é”™ï¼Œå¦‚æœæ˜¯ä¸Šé¢è¿™ç§åšæ³•çš„è¯ï¼Œç¡®å®æœ‰äº›éº»çƒ¦äº†ã€‚ä¸è¿‡æ— é¡»æ‹…å¿ƒï¼Œå½“å‰è¿™ç§ç”¨æ³•å¹¶ä¸æ˜¯ä¸»æµç”¨æ³•ã€‚</strong></p>
<p><strong>AggregatingMergeTree çš„ä¸»æµç”¨æ³•æ˜¯ç»“åˆç‰©åŒ–è§†å›¾ä½¿ç”¨ï¼Œå°†å®ƒä½œä¸ºç‰©åŒ–è§†å›¾çš„è¡¨å¼•æ“ï¼Œè¿™é‡Œçš„ç‰©åŒ–è§†å›¾æ˜¯ä½œä¸ºå…¶å®ƒæ•°æ®è¡¨ä¸Šå±‚çš„ä¸€ç§æŸ¥è¯¢è§†å›¾ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181631184-1254707137.png" alt="img"></p>
<p><strong>æ¥ä¸‹æ¥ç”¨ä¸€ç»„ç¤ºä¾‹è¿›è¡Œè¯´æ˜ï¼Œé¦–å…ˆåˆ›å»ºæ˜ç»†æ•°æ®è¡¨ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„åº•è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> agg_table_basic (</span><br><span class="line">    id String,</span><br><span class="line">    city String,</span><br><span class="line">    code String,</span><br><span class="line">    <span class="keyword">value</span> UInt32</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> city</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, city)</span><br></pre></td></tr></table></figure>

<p><strong>é€šå¸¸ä½¿ç”¨ MergeTree ä½œä¸ºåº•è¡¨ï¼Œç”¨äºå­˜å‚¨å…¨é‡çš„æ˜ç»†æ•°æ®ï¼Œå¹¶ä»¥æ­¤å¯¹å¤–æä¾›å®æ—¶æŸ¥è¯¢ã€‚æ¥ç€ï¼Œåˆ›å»ºä¸€å¼ ç‰©åŒ–è§†å›¾ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> agg_view </span><br><span class="line">ENGINE <span class="operator">=</span> AggregatingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> city</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (id, city)</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    id, city,</span><br><span class="line">    uniqState(code) <span class="keyword">AS</span> code,</span><br><span class="line">    sumState(<span class="keyword">value</span>) <span class="keyword">AS</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">FROM</span> agg_table_basic</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> id, city</span><br></pre></td></tr></table></figure>

<p><strong>ç‰©åŒ–è§†å›¾ä½¿ç”¨ AggregatingMergeTree è¡¨å¼•æ“ï¼Œç”¨äºç‰¹å®šåœºæ™¯çš„æ•°æ®æŸ¥è¯¢ï¼Œç›¸æ¯” MergeTreeï¼Œå®ƒæ‹¥æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚ä½†åœ¨æ–°å¢æ•°æ®æ—¶ï¼Œé¢å‘çš„å¯¹è±¡æ˜¯åº•è¡¨ MergeTreeï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> agg_table_basic </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="string">&#x27;code1&#x27;</span>, <span class="number">100</span>),</span><br><span class="line">       (<span class="string">&#x27;A000&#x27;</span>, <span class="string">&#x27;beijing&#x27;</span>, <span class="string">&#x27;code2&#x27;</span>, <span class="number">200</span>),</span><br><span class="line">       (<span class="string">&#x27;A000&#x27;</span>, <span class="string">&#x27;shanghai&#x27;</span>, <span class="string">&#x27;code1&#x27;</span>, <span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ç‰©åŒ–è§†å›¾ï¼Œå¹¶æŒ‰ç…§ AggregatingMergeTree çš„å¼•æ“çš„è§„åˆ™è¿›è¡Œå¤„ç†ã€‚è€Œåœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œé¢å‘çš„å¯¹è±¡æ˜¯ç‰©åŒ–è§†å›¾ AggregatingMergeTreeï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181622930-228367562.png" alt="img"></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ AggregatingMergeTree çš„æ•´ä¸ªæµç¨‹ï¼Œæœ€å¸¸è§çš„ç”¨æ³•æ˜¯ä½œä¸ºæ™®é€šç‰©åŒ–è§†å›¾çš„è¡¨å¼•æ“ï¼Œå’Œæ™®é€š MergeTree æ•°æ®è¡¨æ­é…ä½¿ç”¨ã€‚</strong></p>
<h3 id="CollapsingMergeTree"><a href="#CollapsingMergeTree" class="headerlink" title="CollapsingMergeTree"></a>CollapsingMergeTree</h3><p><strong>å‡è®¾ç°åœ¨éœ€è¦è®¾è®¡ä¸€æ¬¾æ•°æ®åº“ï¼Œè¯¥æ•°æ®åº“æ”¯æŒéœ€è¦æ”¯æŒå¯¹å·²ç»å­˜åœ¨çš„æ•°æ®å®ç°è¡Œçº§ç²’åº¦çš„ä¿®æ”¹å’Œåˆ é™¤ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿä¸€ç§æœ€å¸¸è§çš„æƒ³æ³•æ˜¯ï¼šé¦–å…ˆæ‰¾åˆ°ä¿å­˜æ•°æ®çš„æ–‡ä»¶ï¼Œæ¥ç€ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚ä¿®æ”¹æˆ–åˆ é™¤é‚£äº›éœ€è¦å˜åŒ–çš„æ•°æ®è¡Œã€‚ç„¶è€Œåœ¨å¤§æ•°æ®é¢†åŸŸï¼Œå¯¹äº ClickHouse è¿™ç±»é«˜æ€§èƒ½åˆ†ææ•°æ®åº“è€Œè¨€ï¼Œå¯¹æ•°æ®æºæ–‡ä»¶è¿›è¡Œä¿®æ”¹æ˜¯ä¸€ä»¶éå¸¸å¥¢ä¾ˆä¸”ä»£ä»·æ˜‚è´µçš„æ“ä½œã€‚ç›¸è¾ƒäºç›´æ¥ä¿®æ”¹æºæ–‡ä»¶ï¼Œå°†ä¿®æ”¹å’Œåˆ é™¤æ“ä½œè½¬æ¢ä¸ºæ–°å¢æ“ä½œä¼šæ›´åˆé€‚ä¸€äº›ï¼Œä¹Ÿå°±æ˜¯ä»¥å¢ä»£åˆ ã€‚</strong></p>
<p><strong>CollapsingMergeTree å°±æ˜¯ä¸€ç§é€šè¿‡ä»¥å¢ä»£åˆ çš„æ€è·¯ï¼Œæ”¯æŒè¡Œçº§æ•°æ®ä¿®æ”¹å’Œåˆ é™¤çš„è¡¨å¼•æ“ã€‚å®ƒé€šè¿‡å®šä¹‰ä¸€ä¸ª sign æ ‡è®°ä½å­—æ®µï¼Œè®°å½•æ•°æ®è¡Œçš„çŠ¶æ€ã€‚å¦‚æœ sign æ ‡è®°ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€è¡Œæœ‰æ•ˆæ•°æ®ï¼›å¦‚æœ sign æ ‡è®°ä¸º -1ï¼Œåˆ™è¡¨ç¤ºè¿™è¡Œæ•°æ®è¦è¢«åˆ é™¤ã€‚å½“ CollapsingMergeTree åˆ†åŒºåˆå¹¶æ—¶ï¼ŒåŒä¸€æ•°æ®åˆ†åŒºå†…ï¼Œsign æ ‡è®°ä¸º 1 å’Œ -1 çš„ä¸€ç»„æ•°æ®ï¼ˆORDER BY å­—æ®µå¯¹åº”çš„å€¼ç›¸åŒï¼‰ä¼šè¢«æŠµæ¶ˆåˆ é™¤ã€‚è¿™ç§ 1 å’Œ -1 ç›¸äº’æŠµæ¶ˆçš„æ“ä½œï¼ŒçŠ¹å¦‚å°†ä¸€å¼ ç“¦æ¥çº¸æŠ˜å äº†ä¸€èˆ¬ï¼Œè¿™ç§ç›´è§‚çš„æ¯”å–»ï¼Œæƒ³å¿…ä¹Ÿæ˜¯æŠ˜å åˆå¹¶æ ‘ï¼ˆCollapsingMergeTreeï¼‰çš„ç”±æ¥ã€‚</strong></p>
<p><strong>å£°æ˜ CollapsingMergeTree çš„æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = CollapsingMergeTree(sign)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ï¼Œsign ç”¨äºæŒ‡å®šä¸€ä¸ª Int8 ç±»å‹çš„æ ‡å¿—ä½å­—æ®µï¼Œä¸€ä¸ªå®Œæ•´çš„ CollapsingMergeTree æ•°æ®è¡¨å£°æ˜å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> collapse_table (</span><br><span class="line">    id String,</span><br><span class="line">    code Int32,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    sign Int8</span><br><span class="line">) ENGINE <span class="operator">=</span> CollapsingMergeTree(sign)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>ä¸å…¶å®ƒçš„ MergeTree å˜ç§å¼•æ“ä¸€æ ·ï¼ŒCollapsingMergeTree åŒæ ·æ˜¯ä»¥ ORDER BY æ’åºé”®ä½œä¸ºåç»­åˆ¤æ–­æ•°æ®å”¯ä¸€æ€§çš„ä¾æ®ã€‚æŒ‰ç…§ä¹‹å‰çš„ä»‹ç»ï¼Œå¯¹äºä¸Šè¿° collapse_table æ•°æ®è¡¨è€Œè¨€ï¼Œé™¤äº†å¸¸è§„çš„æ–°å¢æ“ä½œä¹‹å¤–ï¼Œè¿˜èƒ½æ”¯æŒå…¶å®ƒä¸¤ç§æ“ä½œï¼š</strong></p>
<p><strong>å…¶ä¸€ï¼šåˆ é™¤ä¸€è¡Œæ•°æ®</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ’å…¥ä¸€æ¡æ•°æ®ï¼Œåç»­å¯¹å®ƒè¿›è¡Œåˆ é™¤</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>åˆ é™¤ä¸€æ¡æ•°æ®ï¼Œæ˜¾ç„¶ä¸èƒ½åƒå…³ç³»å‹æ•°æ®åº“é‚£æ ·ä½¿ç”¨ DELETEï¼Œæ­£ç¡®åšæ³•æ˜¯æ’å…¥ä¸€æ¡â€è¦åˆ é™¤çš„æ•°æ®â€çš„é•œåƒæ•°æ®ï¼ŒORDER BY å­—æ®µä¸åŸæ•°æ®ç›¸åŒï¼ˆå…¶å®ƒå­—æ®µå¯ä»¥ä¸åŒï¼‰ï¼Œç„¶å sign å–åä¸º -1ï¼Œå®ƒä¼šå’ŒåŸæ•°æ®æŠ˜å ï¼Œç„¶åç›¸äº’æŠµæ¶ˆã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line">Query id: f02e3e84<span class="number">-7837</span><span class="number">-4</span>db7<span class="operator">-</span>af2b<span class="operator">-</span>d42957c5a63b</span><br><span class="line"></span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A000 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A000 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚   <span class="number">-1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br></pre></td></tr></table></figure>

<p><strong>å…¶äºŒï¼šä¿®æ”¹ä¸€è¡Œæ•°æ®</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ’å…¥ä¸€æ¡æ•°æ®ï¼Œåç»­å¯¹å®ƒè¿›è¡Œä¿®æ”¹</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ code çš„å€¼æ˜¯ 100ï¼Œæˆ‘ä»¬è¦å°†å…¶ä¿®æ”¹æˆ 120ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæ˜¾ç„¶ä¸èƒ½åƒå…³ç³»å‹æ•°æ®é‚£æ ·ä½¿ç”¨ UPDATEï¼Œæ­£ç¡®çš„åšæ³•æ˜¯ä»¥å¢ä»£åˆ ã€‚å…ˆåˆ›å»ºé•œåƒæ•°æ®å°†åŸæ•°æ®æŠ˜å ï¼Œç„¶åå°†ä¿®æ”¹åçš„åŸæ•°æ®å†æ’å…¥åˆ°è¡¨ä¸­å³å¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>),</span><br><span class="line">       <span class="comment">-- ç„¶åå°†åŸæ•°æ®ä¿®æ”¹ä¹‹åä½œä¸ºæ–°æ•°æ®ï¼Œæ’å…¥åˆ°è¡¨ä¸­ï¼Œsign ä¸º 1</span></span><br><span class="line">       (<span class="string">&#x27;A001&#x27;</span>, <span class="number">120</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line">Query id: bfb8afec<span class="operator">-</span>e672<span class="number">-416</span>f<span class="operator">-</span>a7b8<span class="number">-5</span>fcdf6470e59</span><br><span class="line"></span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A000 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A000 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚   <span class="number">-1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A001 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A001 â”‚  <span class="number">100</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚   <span class="number">-1</span> â”‚</span><br><span class="line">â”‚ A001 â”‚  <span class="number">120</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">satori :) </span><br></pre></td></tr></table></figure>

<p><strong>è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œç„¶å CollapsingMergeTree åœ¨æŠ˜å æ•°æ®æ—¶éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š</strong></p>
<ul>
<li><code>å¦‚æœ sign = 1 æ¯” sign = -1 çš„æ•°æ®å¤šä¸€è¡Œï¼Œåˆ™ä¿ç•™æœ€åä¸€è¡Œ sign = 1 çš„æ•°æ®</code></li>
<li><code>å¦‚æœ sign = -1 æ¯” sign = 1 çš„æ•°æ®å¤šä¸€è¡Œï¼Œåˆ™ä¿ç•™ç¬¬ä¸€è¡Œ sign = -1 çš„æ•°æ®</code></li>
<li><code>å¦‚æœ sign = 1 å’Œ sign = -1 çš„æ•°æ®è¡Œä¸€æ ·å¤šï¼Œå¹¶ä¸”æœ€åä¸€è¡Œæ˜¯ sign = 1ï¼Œåˆ™ä¿ç•™ç¬¬ä¸€è¡Œ sign = -1 å’Œæœ€åä¸€è¡Œ sign = 1 çš„æ•°æ®</code></li>
<li><code>å¦‚æœ sign = 1 å’Œ sign = -1 çš„æ•°æ®è¡Œä¸€è¡Œå¤šï¼Œå¹¶ä¸”æœ€åä¸€è¡Œæ˜¯ sign = -1ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸ä¿ç•™</code></li>
<li><code>å…¶ä½™æƒ…å†µï¼ŒClickHouse ä¼šæ‰“å°å‘Šè­¦æ—¥å¿—ï¼Œä½†ä¸ä¼šæŠ¥é”™ï¼Œåœ¨è¿™ç§æƒ…å½¢ä¸‹æ‰“å°ç»“æœä¸å¯é¢„çŸ¥</code></li>
</ul>
<p><strong>å½“ç„¶æŠ˜å æ•°æ®å¹¶ä¸æ˜¯å®æ—¶è§¦å‘çš„ï¼Œå’Œæ‰€æœ‰çš„å…¶å®ƒ MergeTree å˜ç§è¡¨å¼•æ“ä¸€æ ·ï¼Œè¿™é¡¹ç‰¹æ€§åªæœ‰åœ¨å¤šä¸ªåˆ†åŒºç›®å½•åˆå¹¶çš„æ—¶å€™æ‰ä¼šè§¦å‘ï¼Œè§¦å‘æ—¶å±äºåŒä¸€åˆ†åŒºçš„æ•°æ®ä¼šè¿›è¡ŒæŠ˜å ã€‚è€Œåœ¨åˆ†åŒºåˆå¹¶ä¹‹å‰ï¼Œç”¨æˆ·è¿˜æ˜¯å¯ä»¥çœ‹åˆ°æ—§æ•°æ®çš„ï¼Œå°±åƒä¸Šé¢æ¼”ç¤ºçš„é‚£æ ·ã€‚</strong></p>
<p><strong>å¦‚æœä¸æƒ³çœ‹åˆ°æ—§æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨èšåˆçš„æ—¶å€™å¯ä»¥æ”¹å˜ä¸€ä¸‹ç­–ç•¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åŸå§‹ SQL è¯­å¥</span></span><br><span class="line"><span class="keyword">SELECT</span> id, <span class="built_in">sum</span>(code), <span class="built_in">count</span>(code), <span class="built_in">avg</span>(code), uniq(code) </span><br><span class="line"><span class="keyword">FROM</span> collapse_table <span class="keyword">GROUP</span> <span class="keyword">BY</span> id</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ”¹æˆå¦‚ä¸‹</span></span><br><span class="line"><span class="keyword">SELECT</span> id, <span class="built_in">sum</span>(code <span class="operator">*</span> sign), <span class="built_in">count</span>(code <span class="operator">*</span> sign), <span class="built_in">avg</span>(code <span class="operator">*</span> sign), uniq(code <span class="operator">*</span> sign)</span><br><span class="line"><span class="keyword">FROM</span> collapse_table <span class="keyword">GROUP</span> <span class="keyword">BY</span> id <span class="keyword">HAVING</span> <span class="built_in">sum</span>(sign) <span class="operator">&gt;</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ–è€…åœ¨æŸ¥è¯¢æ•°æ®ä¹‹å‰ä½¿ç”¨ optimize TABLE table_name FINAL å‘½ä»¤å¼ºåˆ¶åˆ†åŒºåˆå¹¶ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æ•ˆç‡æä½ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ…ç”¨ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">0</span>cf9d813<span class="number">-5</span>dcc<span class="number">-4</span>a58<span class="operator">-</span>a02a<span class="operator">-</span>de3d6fb38c60</span><br><span class="line"></span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A001 â”‚  <span class="number">120</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec. </span><br><span class="line"></span><br><span class="line">satori :) </span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ° A000 çš„æ•°æ®å·²ç»æ²¡æœ‰äº†ï¼Œåªå‰©ä¸‹äº† A001ï¼Œå¹¶ä¸” code æ˜¯ 120ï¼Œä¸æ˜¯åŸæ¥çš„ 100ã€‚</strong></p>
<p><strong>å¦å¤–åªæœ‰ç›¸åŒåˆ†åŒºå†…çš„æ•°æ®æ‰æœ‰å¯èƒ½è¢«æŠ˜å ï¼Œä¸è¿‡è¿™é¡¹é™åˆ¶å¯¹äº CollapsingMergeTree æ¥è¯´é€šå¸¸ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºä¿®æ”¹æˆ–åˆ é™¤æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›æ•°æ®çš„åˆ†åŒºè§„åˆ™é€šå¸¸éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸ä¼šæ”¹å˜ã€‚ä½† CollapsingMergeTree è¿˜æœ‰ä¸€ä¸ªéå¸¸è‡´å‘½çš„é™åˆ¶ï¼Œé‚£å°±æ˜¯å¯¹æ•°æ®çš„å†™å…¥é¡ºåºæœ‰ç€ä¸¥æ ¼è¦æ±‚ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å…ˆå†™å…¥ sign = 1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A002&#x27;</span>, <span class="number">102</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">-- å…ˆå†™å…¥ sign = -1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A002&#x27;</span>, <span class="number">102</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶æ­¤æ—¶æ˜¯å¯ä»¥æ­£å¸¸æŠ˜å çš„ï¼Œæˆ‘ä»¬åˆšæ‰å·²ç»å®éªŒè¿‡äº†ï¼Œä½†å¦‚æœå°†å†™å…¥çš„é¡ºåºç½®æ¢ä¸€ä¸‹ï¼Œå°±æ— æ³•æŠ˜å äº†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å…ˆå†™å…¥ sign = 1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A003&#x27;</span>, <span class="number">102</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- å…ˆå†™å…¥ sign = -1</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A003&#x27;</span>, <span class="number">102</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼Œæ‰§è¡Œ optimize TABLE collapse_table FINALï¼Œç„¶åè¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> collapse_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">3</span>aaf02d2<span class="number">-7089</span><span class="number">-42</span>f6<span class="number">-9</span>d3b<span class="operator">-</span>a697b196bd42</span><br><span class="line"></span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A001 â”‚  <span class="number">120</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â”‚ A003 â”‚  <span class="number">102</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚   <span class="number">-1</span> â”‚</span><br><span class="line">â”‚ A003 â”‚  <span class="number">102</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec. </span><br><span class="line"></span><br><span class="line">satori :) </span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°ä¸¤ä¸ª A003 æ²¡åŠæ³•è¿›è¡ŒæŠ˜å ï¼ŒåŸå› å°±æ˜¯è¿™ä¸¤æ¡æ•°æ®çš„ sign &#x3D; -1 åœ¨å‰ã€sign &#x3D; 1 åœ¨åï¼Œå¦‚æœæˆ‘ä»¬åœ¨å†™å…¥ä¸€æ¡ A003ã€sign &#x3D; -1 ä¼šæœ‰ä»€ä¹ˆç»“æœå‘¢ï¼Ÿæ˜¾ç„¶ä¼šå’Œ sign &#x3D; 1 çš„ A003 è¿›è¡Œåˆå¹¶ï¼Œåªç•™ä¸‹ä¸€æ¡ sign &#x3D; -1 çš„ A003ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> collapse_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> collapse_table</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">82226926</span><span class="number">-6</span>f2a<span class="number">-4</span>ab8<span class="number">-80</span>b4<span class="operator">-</span>ce8980ec1eec</span><br><span class="line"></span><br><span class="line">â”Œâ”€idâ”€â”€â”€â”¬â”€codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€create_timeâ”€â”¬â”€signâ”€â”</span><br><span class="line">â”‚ A001 â”‚  <span class="number">120</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚    <span class="number">1</span> â”‚</span><br><span class="line">â”‚ A003 â”‚  <span class="number">102</span> â”‚ <span class="number">2020</span><span class="number">-02</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> â”‚   <span class="number">-1</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec. </span><br><span class="line"></span><br><span class="line">satori :) </span><br></pre></td></tr></table></figure>

<p><strong>è¿™ç§ç°è±¡æ˜¯ CollapsingMergeTree çš„å¤„ç†æœºåˆ¶æ‰€å¯¼è‡´çš„ï¼Œå› ä¸ºå®ƒè¦æ±‚ sign &#x3D; 1 å’Œ sign &#x3D; -1 çš„æ•°æ®ç›¸é‚»ï¼Œè€Œåˆ†åŒºå†…çš„æ•°æ®ä¸¥æ ¼æŒ‰ç…§ ORDER BY æ’åºï¼Œè¦å®ç° sign &#x3D; 1 å’Œ sign &#x3D; -1 çš„æ•°æ®ç›¸é‚»ï¼Œåˆ™åªèƒ½ä¸¥æ ¼æŒ‰ç…§é¡ºåºå†™å…¥ã€‚</strong></p>
<p><strong>å¦‚æœæ•°æ®çš„å†™å…¥é¡ºåºæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œåˆ™èƒ½å¤Ÿæ¯”è¾ƒå¥½çš„æ§åˆ¶å†™å…¥é¡ºåºï¼›ä½†å¦‚æœéœ€è¦å¤„ç†çš„æ•°æ®é‡å¾ˆå¤§ï¼Œæ•°æ®çš„å†™å…¥ç¨‹åºé€šå¸¸æ˜¯å¤šçº¿ç¨‹çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¸èƒ½ä¿éšœæ•°æ®çš„å†™å…¥é¡ºåºäº†ã€‚è€Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCollapsingMergeTree çš„å·¥ä½œæœºåˆ¶å°±ä¼šå‡ºç°é—®é¢˜ï¼Œè€Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒClickHouse é¢å¤–æä¾›äº†ä¸€ä¸ªåä¸º VersionedCollapsingMergeTree çš„è¡¨å¼•æ“ã€‚</strong></p>
<h3 id="VersionedCollapsingMergeTree"><a href="#VersionedCollapsingMergeTree" class="headerlink" title="VersionedCollapsingMergeTree"></a>VersionedCollapsingMergeTree</h3><p><strong>VersionedCollapsingMergeTree è¡¨å¼•æ“çš„ä½œç”¨å’Œ CollapsingMergeTree å®Œå…¨ç›¸åŒï¼Œå®ƒä»¬çš„ä¸åŒä¹‹å¤„åœ¨äº VersionedCollapsingMergeTree å¯¹æ•°æ®çš„å†™å…¥é¡ºåºæ²¡æœ‰è¦æ±‚ï¼Œåœ¨åŒä¸€ä¸ªåˆ†åŒºå†…ï¼Œä»»æ„é¡ºåºçš„æ•°æ®éƒ½å¯ä»¥å®ŒæˆæŠ˜å æ“ä½œã€‚é‚£ä¹ˆ VersionedCollapsingMergeTree æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿå…¶å®ä»å®ƒçš„åå­—å°±èƒ½çœ‹å‡ºæ¥ï¼Œå› ä¸ºç›¸æ¯” CollapsingMergeTree å¤šäº†ä¸€ä¸ª Versionedï¼Œé‚£ä¹ˆæ˜¾ç„¶å°±æ˜¯é€šè¿‡ç‰ˆæœ¬å·ï¼ˆversionï¼‰è§£å†³çš„ã€‚</strong></p>
<p><strong>åœ¨å®šä¹‰ VersionedCollapsingMergeTree æ•°æ®è¡¨çš„æ—¶å€™ï¼Œé™¤äº†æŒ‡å®š sign æ ‡è®°å­—æ®µä¹‹å¤–ï¼Œè¿˜éœ€è¦é¢å¤–æŒ‡å®šä¸€ä¸ª UInt8 ç±»å‹çš„ ver ç‰ˆæœ¬å·å­—æ®µã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = VersionedCollapsingMergeTree(sign, ver)</span><br></pre></td></tr></table></figure>

<p><strong>ä¸€ä¸ªå®Œæ•´çš„ VersionedCollapsingMergeTree è¡¨å®šä¹‰å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ver_collapse_table (</span><br><span class="line">    id String,</span><br><span class="line">    code Int32,</span><br><span class="line">    create_time DateTime,</span><br><span class="line">    sign Int8,</span><br><span class="line">    ver UInt8</span><br><span class="line">) ENGINE <span class="operator">=</span> CollapsingMergeTree(sign, ver)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>é‚£ä¹ˆ VersionedCollapsingMergeTree æ˜¯å¦‚ä½•ä½¿ç”¨ç‰ˆæœ¬å·å­—æ®µçš„å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåœ¨å®šä¹‰ ver å­—æ®µä¹‹åï¼ŒVersionedCollapsingMergeTree ä¼šè‡ªåŠ¨å°† ver ä½œä¸ºæ’åºæ¡ä»¶å¹¶å¢åŠ åˆ° ORDER BY çš„æœ«ç«¯ã€‚ä»¥ä¸Šé¢çš„ ver_collapse_table ä¸ºä¾‹ï¼Œåœ¨æ¯ä¸ªåˆ†åŒºå†…ï¼Œæ•°æ®ä¼šæŒ‰ç…§ ORDER BY id, ver DESC æ’åºã€‚æ‰€ä»¥æ— è®ºå†™å…¥æ—¶æ•°æ®çš„é¡ºåºå¦‚ä½•ï¼Œåœ¨æŠ˜å å¤„ç†æ—¶ï¼Œéƒ½èƒ½å›åˆ°æ­£ç¡®çš„é¡ºåºã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é¦–å…ˆæ˜¯åˆ é™¤æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ver_collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="number">101</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ver_collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A000&#x27;</span>, <span class="number">101</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç„¶åæ˜¯ä¿®æ”¹æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ver_collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">101</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ver_collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">102</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ver_collapse_table <span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">103</span>, <span class="string">&#x27;2020-02-20 00:00:00&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šæ•°æ®å‡èƒ½æ­£å¸¸æŠ˜å ã€‚</strong></p>
<h3 id="å„ç§-MergeTree-ä¹‹é—´çš„å…³ç³»æ€»ç»“"><a href="#å„ç§-MergeTree-ä¹‹é—´çš„å…³ç³»æ€»ç»“" class="headerlink" title="å„ç§ MergeTree ä¹‹é—´çš„å…³ç³»æ€»ç»“"></a>å„ç§ MergeTree ä¹‹é—´çš„å…³ç³»æ€»ç»“</h3><p><strong>ç»è¿‡ä¸Šè¿°ä»‹ç»æ˜¯ä¸æ˜¯è§‰å¾— MergeTree ç‰¹åˆ«ä¸°å¯Œå‘¢ï¼Ÿä½†è¿˜æ˜¯é‚£å¥è¯ï¼Œä»»ä½•äº‹éƒ½æœ‰ä¸¤é¢æ€§ï¼ŒåŠŸèƒ½ä¸°å¯Œå°±æ„å‘³ç€å¾ˆå®¹æ˜“è¢«è¿™ä¹ˆå¤šè¡¨å¼•æ“å¼„æ™•ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±ä»¥ç»§æ‰¿å’Œç»„åˆè¿™ä¸¤ç§å…³ç³»æ¥ç†è§£æ•´ä¸ª MergeTreeã€‚</strong></p>
<h4 id="ç»§æ‰¿å…³ç³»"><a href="#ç»§æ‰¿å…³ç³»" class="headerlink" title="ç»§æ‰¿å…³ç³»"></a>ç»§æ‰¿å…³ç³»</h4><p><strong>é¦–å…ˆä¸ºäº†ä¾¿äºç†è§£ï¼Œå¯ä»¥ä½¿ç”¨ç»§æ‰¿å…³ç³»æ¥ç†è§£ MergeTreeï¼ŒMergeTree è¡¨å¼•æ“å‘ä¸‹æ´¾ç”Ÿå‡º 6 ä¸ªå˜ç§è¡¨å¼•æ“ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181601134-545853463.png" alt="img"></p>
<p><strong>åœ¨ ClickHouse åº•å±‚çš„å®ç°æ–¹æ³•ä¸­ï¼Œä¸Šè¿° 7 ç§è¡¨å¼•æ“çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨ Merge åˆå¹¶çš„é€»è¾‘éƒ¨åˆ†ï¼Œç®€åŒ–åçš„å¯¹è±¡å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181553869-189950708.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°åœ¨å…·ä½“çš„å®ç°éƒ¨åˆ†ï¼Œ7 ç§ MergeTree å…±ç”¨ä¸€ä¸ªä¸»ä½“ï¼Œè€Œåœ¨è§¦å‘ Merge åŠ¨ä½œæ—¶ï¼Œå®ƒä»¬è°ƒç”¨äº†å„è‡ªç‹¬æœ‰çš„åˆå¹¶é€»è¾‘ã€‚</strong></p>
<p><strong>MergeTree ä¹‹å¤–çš„å…¶å®ƒ 6 ä¸ªå˜ç§è¡¨å¼•æ“çš„ Merge åˆå¹¶é€»è¾‘ï¼Œå…¨éƒ¨éƒ½æ˜¯å»ºç«‹åœ¨ MergeTree åŸºç¡€ä¹‹ä¸Šçš„ï¼Œä¸”å‡ç»§æ‰¿äº MergeTree çš„ MergingSortedBlockInputStreamï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181548211-180815683.png" alt="img"></p>
<p><strong>MergingSortedBlockInputStream çš„ä¸»è¦ä½œç”¨æ˜¯æŒ‰ç…§ ORDER BY çš„è§„åˆ™ä¿è¯åˆ†åŒºå†…æ•°æ®çš„æœ‰åºæ€§ï¼Œè€Œå…¶å®ƒ 6 ç§å˜ç§ MergeTree çš„åˆå¹¶é€»è¾‘ï¼Œåˆ™æ˜¯åœ¨æœ‰åºçš„åŸºç¡€ä¹‹ä¸Šå„æœ‰æ‰€é•¿ï¼Œä¾‹å¦‚å°†æ’åºåç›¸é‚»çš„é‡å¤æ•°æ®æ¶ˆé™¤ï¼Œæˆ–è€…å°†é‡å¤æ•°æ®ç´¯åŠ æ±‡æ€»ç­‰ç­‰ã€‚</strong></p>
<h4 id="ç»„åˆå…³ç³»"><a href="#ç»„åˆå…³ç³»" class="headerlink" title="ç»„åˆå…³ç³»"></a>ç»„åˆå…³ç³»</h4><p><strong>äº†è§£å®Œ 7 ç§ MergeTree çš„å…³ç³»ï¼Œä¸‹é¢å†æ¥è¯´ä¸€ä¸‹å®ƒä»¬çš„ç»„åˆï¼Œæˆ‘ä»¬è¯´å¦‚æœ MergeTree åŠ ä¸Š Replicated çš„è¯ï¼Œåˆ™è¡¨ç¤ºæ”¯æŒå‰¯æœ¬ï¼Œé‚£ä¹ˆ ReplicatedMergeTree å’Œæ™®é€šçš„ MergeTree æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181542392-1496501780.png" alt="img"></p>
<p><strong>ä¸Šå›¾ä¸­çš„è™šçº¿æ¡†éƒ¨åˆ†æ˜¯ MergeTree çš„èƒ½åŠ›è¾¹ç•Œï¼Œè€Œ ReplicatedMergeTree åˆ™åœ¨ MergeTree èƒ½åŠ›çš„åŸºç¡€ä¹‹ä¸Šå¢åŠ äº†åˆ†å¸ƒå¼ååŒçš„èƒ½åŠ›ï¼Œå…¶å€ŸåŠ© zookeeper çš„æ¶ˆæ¯æ—¥å¿—å¹¿æ’­åŠŸèƒ½ï¼Œå®ç°äº†å‰¯æœ¬å®ä¾‹ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚</strong></p>
<p><strong>ReplicatedMergeTree ç³»åˆ—å¯ä»¥ç”¨ç»„åˆå…³ç³»æ¥ç†è§£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E4%B9%8B%20MergeTree%20%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%A1%A8%E5%BC%95%E6%93%8E(%E4%B8%83)/1229382-20210829181537938-2135925933.png" alt="img"></p>
<p><strong>å½“æˆ‘ä»¬ä¸º 7 ç§ MergeTree åŠ ä¸Š Replicated å‰ç¼€ä¹‹åï¼Œåˆèƒ½ç»„åˆå‡º 7 ç§æ–°çš„è¡¨å¼•æ“ï¼Œè€Œè¿™äº› ReplicatedMergeTree æ‹¥æœ‰å‰¯æœ¬ååŒçš„èƒ½åŠ›ã€‚å…³äº ReplicatedMergeTreeï¼Œåç»­ä¼šè¯¦ç»†è¯´ã€‚</strong></p>
<p><strong>ä»¥ä¸Šæˆ‘ä»¬å°±ä»‹ç»å®Œäº† MergeTree ä»¥åŠæ•´ä¸ªå®¶æ—ç³»åˆ—çš„è¡¨å¼•æ“ï¼ŒMergeTree ç³»åˆ—è¡¨å¼•æ“åœ¨ç”Ÿäº§ä¸­æ˜¯ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„è¡¨å¼•æ“ï¼Œæˆ‘ä»¬æ˜¯éå¸¸æœ‰å¿…è¦å½»åº•æŒæ¡å®ƒçš„ã€‚ä½†æˆ‘ä»¬è¯´é™¤äº† MergeTreeï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒè¡¨å¼•æ“ï¼Œè™½ç„¶ä½¿ç”¨é¢‘ç‡ä¸æ˜¯é‚£ä¹ˆé«˜ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰é€‚åˆè‡ªèº«çš„åœºæ™¯çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦æŒæ¡ï¼Œé‚£ä¹ˆåç»­å°±æ¥çœ‹ä¸€çœ‹å…¶å®ƒç§ç±»çš„è¡¨å¼•æ“ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse æ•°æ®è¡¨çš„å¢åˆ æ”¹(äº”)</title>
    <url>/2023/03/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9(%E4%BA%94)/</url>
    <content><![CDATA[<h1 id="ClickHouse-æ•°æ®è¡¨çš„å¢åˆ æ”¹-äº”"><a href="#ClickHouse-æ•°æ®è¡¨çš„å¢åˆ æ”¹-äº”" class="headerlink" title="ClickHouse æ•°æ®è¡¨çš„å¢åˆ æ”¹(äº”)"></a>ClickHouse æ•°æ®è¡¨çš„å¢åˆ æ”¹(äº”)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š (<a href="https://www.cnblogs.com/traditional/p/15218565.html">https://www.cnblogs.com/traditional/p/15218565.html</a>) </p>
<h3 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h3><p><strong>è·Ÿç»å¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“ä¸€æ ·ï¼ŒClickHouse ä½¿ç”¨ INSERT è¯­å¥è¿›è¡Œæ•°æ®çš„æ’å…¥ã€‚å¹¶ä¸” INSERTè¯­å¥æ”¯æŒä¸‰ç§è¯­æ³•èŒƒå¼ï¼Œä¸‰ç§èŒƒå¼å„æœ‰ä¸åŒï¼Œå¯ä»¥æ ¹æ®å†™å…¥çš„éœ€æ±‚çµæ´»è¿ç”¨ã€‚</strong></p>
<p><strong>å…¶ä¸­ï¼Œç¬¬ä¸€ç§æ˜¯ä½¿ç”¨ VALUES æ ¼å¼çš„å¸¸è§„è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸­æ‹¬å·è¡¨ç¤ºé‡Œé¢çš„å†…å®¹å¯ä»¥çœç•¥</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [db.]table_name [(col1, col2, col3...)] <span class="keyword">VALUES</span> (val1, val2, val3, ...), (val1, val2, val3, ...), ...</span><br></pre></td></tr></table></figure>

<p><strong>è¿™ä¸ªå’Œå…¶å®ƒå…³ç³»å‹æ•°æ®åº“æ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</strong></p>
<p><strong>åœ¨ä½¿ç”¨ VALUES æ ¼å¼çš„è¯­æ³•å†™å…¥æ•°æ®æ—¶ï¼Œè¿˜æ”¯æŒåŠ å…¥è¡¨è¾¾å¼æˆ–å‡½æ•°ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> partizion_v2 <span class="keyword">VALUES</span>(<span class="string">&#x27;matsuri&#x27;</span>, toString(<span class="number">1</span><span class="operator">+</span><span class="number">2</span>), now())</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒç§æ˜¯ä½¿ç”¨æŒ‡å®šæ ¼å¼çš„è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [db.]table_name [(col1, col2, col3...)] FORMAT format_name data_set</span><br></pre></td></tr></table></figure>

<p><strong>ClickHouse æ”¯æŒå¤šç§æ•°æ®æ ¼å¼ï¼Œä»¥å¸¸ç”¨çš„ CSV æ ¼å¼å†™å…¥ä¸ºä¾‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> partition_v2 FORMAT CSV \</span><br><span class="line">	<span class="string">&#x27;mea&#x27;</span>, <span class="string">&#x27;www.mea.com&#x27;</span>, <span class="string">&#x27;2019-01-01&#x27;</span></span><br><span class="line">	<span class="string">&#x27;nana&#x27;</span>, <span class="string">&#x27;www.nana.com&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span></span><br><span class="line">	<span class="string">&#x27;matsuri&#x27;</span>, <span class="string">&#x27;www.matsuri.com&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰ç§æ˜¯ä½¿ç”¨ SELECT å­å¥å½¢å¼çš„è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [db.]table_name [(col1, col2, col3...)] <span class="keyword">SELECT</span> ...</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ SELECT å­å¥å¯å°†æŸ¥è¯¢ç»“æœå†™å…¥æ•°æ®è¡¨ï¼Œå‡è®¾éœ€è¦å°† partition_v1 çš„æ•°æ®å†™å…¥ partition_v2ï¼Œåˆ™å¯ä»¥ ä½¿ç”¨ä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> partition_v2 <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> partition_v1</span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åŠ å…¥è¡¨è¾¾å¼ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚è¿™é‡Œçš„ now()</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> partition_v2 <span class="keyword">SELECT</span> <span class="string">&#x27;aqua&#x27;</span>, <span class="string">&#x27;www.aqua.com&#x27;</span>, now()</span><br></pre></td></tr></table></figure>

<p><strong>è™½ç„¶ VALUES å’Œ SELECT å­å¥çš„å½¢å¼éƒ½æ”¯æŒå£°æ˜è¡¨è¾¾å¼æˆ–å‡½æ•°ï¼Œä½†æ˜¯è¡¨è¾¾å¼æˆ–å‡½æ•°ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œä»è€Œå¯¼è‡´å†™å…¥æ€§èƒ½ä¸‹é™ã€‚æ‰€ä»¥å¦‚æœè¿½æ±‚æè‡´çš„å†™å…¥æ€§èƒ½ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨å®ƒä»¬ã€‚</strong></p>
<p><strong>åœ¨å‰é¢æ›¾ä»‹ç»è¿‡ï¼ŒClickHouse å†…éƒ¨æ‰€æœ‰çš„æ•°æ®æ“ä½œéƒ½æ˜¯é¢å‘ Block æ•°æ®å—çš„ï¼Œæ‰€ä»¥ INSERT æŸ¥è¯¢æœ€ç»ˆä¼šå°†æ•°æ®è½¬æ¢ä¸º Block æ•°æ®å—ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼ŒINSERT è¯­å¥åœ¨å•ä¸ªæ•°æ®å—çš„å†™å…¥è¿‡ç¨‹ä¸­æ˜¯å…·æœ‰åŸå­æ€§çš„ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ•°æ®å—æœ€å¤šå¯ä»¥å†™å…¥ 1048576 æ¡æ•°æ®ï¼ˆç”± max_insert_block_size å‚æ•°æ§åˆ¶ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€æ¡ INSERT è¯­å¥å†™å…¥çš„æ•°æ®è¡Œæ•°å°‘äº max_insert_block_sizeï¼Œé‚£ä¹ˆè¿™æ‰¹æ•°æ®çš„å†™å…¥æ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰åœ¨ ClickHouse æœåŠ¡ç«¯å¤„ç†æ•°æ®çš„æ—¶å€™æ‰å…·æœ‰è¿™ç§åŸå­å†™å…¥çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ä½¿ç”¨ HTTP æ¥å£ï¼Œå› ä¸º max_insert_block_size å‚æ•°åœ¨ä½¿ç”¨ CLI å‘½ä»¤è¡Œæˆ–è€… INSERT SELECT å­å¥å†™å…¥æ—¶æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</strong></p>
<h3 id="åˆ é™¤ä¸ä¿®æ”¹"><a href="#åˆ é™¤ä¸ä¿®æ”¹" class="headerlink" title="åˆ é™¤ä¸ä¿®æ”¹"></a>åˆ é™¤ä¸ä¿®æ”¹</h3><p><strong>ClickHouse æä¾›äº† DELETE å’Œ UPDATE çš„èƒ½åŠ›ï¼Œè¿™ç±»æ“ä½œè¢«ç§°ä¸º Mutation æŸ¥è¯¢ï¼Œå®ƒå¯ä»¥çœ‹ä½œ ALTER è¯­å¥çš„å˜ç§ã€‚è™½ç„¶ Mutation èƒ½æœ€ç»ˆå®ç°ä¿®æ”¹å’Œåˆ é™¤ï¼Œä½†ä¸èƒ½å®Œå…¨ä»¥é€šå¸¸æ„ä¹‰ä¸Šçš„ UPDATE å’Œ DELETE æ¥ç†è§£ï¼Œæˆ‘ä»¬å¿…é¡»æ¸…é†’åœ°è®¤è¯†åˆ°å®ƒçš„ä¸åŒã€‚é¦–å…ˆï¼ŒMutation è¯­å¥æ˜¯ä¸€ç§ â€œå¾ˆé‡â€ çš„æ“ä½œï¼Œæ›´é€‚ç”¨äºæ‰¹é‡æ•°æ®çš„ä¿®æ”¹å’Œåˆ é™¤ï¼›å…¶æ¬¡ï¼Œå®ƒä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸€æ—¦è¯­å¥è¢«æäº¤æ‰§è¡Œï¼Œå°±ä¼šç«‹åˆ»å¯¹ç°æœ‰æ•°æ®é€ æˆå½±å“ï¼Œæ— æ³•å›æ»šï¼›æœ€åï¼ŒMutation è¯­å¥çš„æ‰§è¡Œæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„åå°è¿‡ç¨‹ï¼Œè¯­å¥è¢«æäº¤ä¹‹åå°±ä¼šç«‹å³è¿”å›ã€‚æ‰€ä»¥è¿™å¹¶ä¸ä»£è¡¨å…·ä½“é€»è¾‘å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå®ƒçš„å…·ä½“æ‰§è¡Œè¿›åº¦éœ€è¦é€šè¿‡ system.mutations ç³»ç»Ÿè¡¨æŸ¥è¯¢ã€‚</strong></p>
<p><strong>DELETE è¯­å¥çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [db_name.]table_name <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> filter_expr</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®åˆ é™¤çš„èŒƒå›´ç”± WHERE æŸ¥è¯¢å­å¥å†³å®šã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œä¸‹é¢è¯­å¥å¯ä»¥åˆ é™¤ partition_v2 è¡¨å†…æ‰€æœ‰ ID ç­‰äº â€˜xxxâ€™ çš„æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> partition_v2 <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> ID <span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæ•°æ®å¾ˆå°‘çš„è¯ï¼Œé‚£ä¹ˆ DELETE æ“ä½œç»™äººçš„æ„Ÿè§‰å’Œå¸¸ç”¨çš„ OLTP æ•°æ®åº“æ— å¼‚ï¼Œä½†æˆ‘ä»¬å¿ƒä¸­åº”è¯¥è¦æ˜ç™½è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„åå°æ‰§è¡ŒåŠ¨ä½œã€‚</strong></p>
<p><strong>ä¸‹é¢æˆ‘ä»¬æ¥å®é™…åˆ é™¤æ•°æ®ï¼Œå°±ä»¥ partition_v1 ä¸ºä¾‹å§ï¼Œå…ˆæ¥çœ‹çœ‹å¯¹åº”ç›®å½•ï¼ˆ&#x2F;var&#x2F;lib&#x2F;clickhouse&#x2F;data&#x2F;default&#x2F;partition_v1ï¼‰é‡Œé¢çš„å†…å®¹ï¼š</strong></p>
<p><img src="/2023/03/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9(%E4%BA%94)/1229382-20210816173525150-1169637887.png" alt="img"></p>
<p><strong>æ‰§è¡Œè¯¥è¯­å¥ï¼šALTER TABLE partition_v1 DELETE WHERE ID &#x3D;â€™xxxâ€™ è¿›è¡Œæ•°æ®åˆ é™¤ï¼Œæ‰§è¡Œå®Œä¹‹åå†çœ‹ä¸€ä¸‹ç›®å½•ç»“æ„ï¼š</strong></p>
<p><img src="/2023/03/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9(%E4%BA%94)/1229382-20210816173531402-1147768169.png" alt="img"></p>
<p><strong>å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡Œäº† DELETE æ“ä½œåæ•°æ®ç›®å½•å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œæ¯ä¸€ä¸ªåŸæœ‰çš„æ•°æ®ç›®å½•éƒ½é¢å¤–å¢åŠ äº†ä¸€ä¸ªåŒåç›®å½•ï¼Œå¹¶ä¸”åœ¨æœ«å°¾å¤„å¢åŠ äº† _3 åç¼€ã€‚æ­¤å¤–ï¼Œç›®å½•ä¸‹è¿˜å¤šäº†ä¸€ä¸ªåä¸º mutation_3.txt æ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori partition_v1]<span class="comment"># cat mutation_3.txt</span></span><br><span class="line">format version: 1</span><br><span class="line">create time: 2021-08-16 14:55:41</span><br><span class="line">commands: DELETE WHERE ID = \<span class="string">&#x27;xxx\&#x27;</span></span><br><span class="line">[root@satori partition_v1]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>åŸæ¥ mutation3.txt æ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå®ƒå®Œæ•´åœ°è®°å½•äº†è¿™æ¬¡ DELETE æ“ä½œçš„æ‰§è¡Œè¯­å¥å’Œæ—¶é—´ï¼Œè€Œæ–‡ä»¶åçš„åç¼€ _3 ä¸æ–°å¢ç›®å½•çš„åç¼€å¯¹åº”ã€‚é‚£ä¹ˆåç¼€çš„æ•°å­—ä»ä½•è€Œæ¥å‘¢ï¼Ÿç»§ç»­æŸ¥è¯¢ system.mutations ç³»ç»Ÿè¡¨ï¼Œä¸€æ¢ç©¶ç«Ÿï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> database, <span class="keyword">table</span>, mutation_id, block_numbers.number <span class="keyword">as</span> num, is_done <span class="keyword">FROM</span> <span class="keyword">system</span> .mutations</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9(%E4%BA%94)/1229382-20210816173111584-5614938.png" alt="img"></p>
<p><strong>è‡³æ­¤ï¼Œæ•´ä¸ª Mutation æ“ä½œçš„é€»è¾‘å°±æ¯”è¾ƒæ¸…æ™°äº†ã€‚æ¯æ‰§è¡Œä¸€æ¡ ALTER DELETE è¯­å¥ï¼Œéƒ½ä¼šåœ¨ mutations ç³»ç»Ÿè¡¨ä¸­ç”Ÿæˆä¸€æ¡å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼Œå½“ is_done ç­‰äº 1 æ—¶è¡¨ç¤ºæ‰§è¡Œå®Œæ¯•ã€‚ä¸æ­¤åŒæ—¶ï¼Œåœ¨æ•°æ®è¡¨çš„æ ¹ç›®å½•ä¸‹ï¼Œä¼šä»¥ mutation_id ä½œä¸ºåå­—ç”Ÿæˆä¸ä¹‹å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ç”¨äºè®°å½•ç›¸å…³ä¿¡æ¯ã€‚è€Œæ•°æ®åˆ é™¤çš„è¿‡ç¨‹æ˜¯ä»¥æ•°æ®è¡¨çš„æ¯ä¸ªåˆ†åŒºç›®å½•ä¸ºå•ä½ï¼Œå°†æ‰€æœ‰ç›®å½•é‡å†™ä¸ºæ–°çš„ç›®å½•ï¼Œæ–°ç›®å½•çš„å‘½åè§„åˆ™æ˜¯åœ¨åŸæœ‰åç§°ä¸ŠåŠ ä¸Š system.mutations.block_numbers.numberã€‚æ•°æ®åœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ä¼šå°†éœ€è¦åˆ é™¤çš„æ•°æ®å»æ‰ï¼Œæ—§çš„æ•°æ®ç›®å½•å¹¶ä¸ä¼šç«‹å³åˆ é™¤ï¼Œè€Œæ˜¯ä¼šè¢«æ ‡è®°æˆéæ¿€æ´»çŠ¶æ€ï¼ˆactive ä¸º 0ï¼‰ã€‚ç­‰åˆ° MergeTree å¼•æ“çš„ä¸‹ä¸€æ¬¡åˆå¹¶åŠ¨ä½œè§¦å‘æ—¶ï¼Œè¿™äº›éæ¿€æ´»ç›®å½•æ‰ä¼šè¢«çœŸæ­£ä»ç‰©ç†æ„ä¹‰ä¸Šåˆ é™¤ã€‚</strong></p>
<p><strong>æ•°æ®ä¿®æ”¹é™¤äº†éœ€è¦æŒ‡å®šå…·ä½“çš„è¦æ›´æ–°çš„åˆ—å­—æ®µä¹‹å¤–ï¼Œæ•´ä¸ªé€»è¾‘ä¸æ•°æ®åˆ é™¤åˆ«æ— äºŒè‡´ï¼Œå®ƒçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [db_name.]table_name <span class="keyword">UPDATE</span> column1 <span class="operator">=</span> expr1 [, ...] <span class="keyword">WHERE</span> filter_expr</span><br></pre></td></tr></table></figure>

<p><strong>UPDATE æ”¯æŒåœ¨ä¸€æ¡è¯­å¥ä¸­åŒæ—¶å®šä¹‰å¤šä¸ªä¿®æ”¹å­—æ®µï¼Œä½†æ˜¯åˆ†åŒºé”®å’Œä¸»é”®ä¸èƒ½ä½œä¸ºä¿®æ”¹å­—æ®µã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse æ•°æ®è¡¨ã€æ•°æ®åˆ†åŒºçš„ç›¸å…³æ“ä½œï¼Œä»¥åŠ DDL(å››)</title>
    <url>/2023/02/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BB%A5%E5%8F%8A%20DDL(%E5%9B%9B)/</url>
    <content><![CDATA[<h1 id="ClickHouse-æ•°æ®è¡¨ã€æ•°æ®åˆ†åŒºçš„ç›¸å…³æ“ä½œï¼Œä»¥åŠ-DDL-å››"><a href="#ClickHouse-æ•°æ®è¡¨ã€æ•°æ®åˆ†åŒºçš„ç›¸å…³æ“ä½œï¼Œä»¥åŠ-DDL-å››" class="headerlink" title="ClickHouse æ•°æ®è¡¨ã€æ•°æ®åˆ†åŒºçš„ç›¸å…³æ“ä½œï¼Œä»¥åŠ DDL(å››)"></a>ClickHouse æ•°æ®è¡¨ã€æ•°æ®åˆ†åŒºçš„ç›¸å…³æ“ä½œï¼Œä»¥åŠ DDL(å››)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š (<a href="https://www.cnblogs.com/traditional/p/15218664.html">https://www.cnblogs.com/traditional/p/15218664.html</a> </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>åœ¨çŸ¥æ™“äº† ClickHouse çš„ä¸»è¦æ•°æ®ç±»å‹ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»‹ç» DDL æ“ä½œä»¥åŠå®šä¹‰æ•°æ®çš„æ–¹æ³•ï¼ŒDDL æŸ¥è¯¢æä¾›äº†æ•°æ®è¡¨çš„åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤æ“ä½œï¼Œæ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€ã€‚</strong></p>
<h3 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h3><p><strong>æ•°æ®åº“èµ·åˆ°äº†å‘½åç©ºé—´çš„ä½œç”¨ï¼Œå¯ä»¥æœ‰æ•ˆè§„é¿å‘½åå†²çªçš„é—®é¢˜ï¼Œä¹Ÿä¸ºåç»­çš„æ•°æ®éš”ç¦»æä¾›äº†æ”¯æ’‘ã€‚ä»»ä½•ä¸€å¼ æ•°æ®è¡¨ï¼Œéƒ½å¿…é¡»å½’å±åœ¨æŸä¸ªæ•°æ®åº“ä¹‹ä¸‹ã€‚åˆ›å»ºæ•°æ®åº“çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> db_name[ENGINE <span class="operator">=</span> engine]</span><br></pre></td></tr></table></figure>

<p><strong>IF NOT EXISTS è¡¨ç¤ºå¦‚æœå·²ç»å­˜åœ¨ä¸€ä¸ªåŒåçš„æ•°æ®åº“ï¼Œåˆ™ä¼šå¿½ç•¥åç»­çš„åˆ›å»ºè¿‡ç¨‹ï¼›[ENGINE &#x3D; engine] è¡¨ç¤ºæ•°æ®åº“æ‰€ä½¿ç”¨çš„å¼•æ“ç±»å‹ï¼ˆæ˜¯çš„ï¼Œä½ æ²¡çœ‹é”™ï¼Œæ•°æ®åº“ä¹Ÿæ”¯æŒè®¾ç½®å¼•æ“ï¼‰ã€‚</strong></p>
<p><strong>æ•°æ®åº“ç›®å‰ä¸€å…±æ”¯æŒ 5 ç§å¼•æ“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</strong></p>
<ul>
<li><code>Ordinaryï¼šé»˜è®¤å¼•æ“ï¼Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨é»˜è®¤å¼•æ“ï¼Œä½¿ç”¨æ—¶æ— é¡»åˆ»æ„å£°æ˜ï¼Œåœ¨æ­¤æ•°æ®åº“ä¸‹å¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹çš„è¡¨å¼•æ“</code></li>
<li><code>Dictionaryï¼šå­—å…¸å¼•æ“ï¼Œæ­¤ç±»æ•°æ®åº“ä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰æ•°æ®å­—å…¸åˆ›å»ºå®ƒä»¬çš„æ•°æ®è¡¨ï¼Œå…³äºæ•°æ®å­—å…¸çš„è¯¦ç»†ä»‹ç»ä¼šåœ¨åé¢å±•å¼€</code></li>
<li><code>Memoryï¼šå†…å­˜å¼•æ“ï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶æ•°æ®ã€‚æ­¤ç±»æ•°æ®åº“ä¸‹çš„æ•°æ®è¡¨åªä¼šåœç•™åœ¨å†…å­˜ä¸­ï¼Œä¸ä¼šæ¶‰åŠä»»ä½•ç£ç›˜æ“ä½œï¼Œå½“æœåŠ¡é‡å¯åæ•°æ®ä¼šè¢«æ¸…é™¤</code></li>
<li><code>Lazyï¼šæ—¥å¿—å¼•æ“ï¼Œæ­¤ç±»æ•°æ®åº“ä¸‹åªèƒ½ä½¿ç”¨ Log ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œå…³äº Log è¡¨å¼•æ“çš„è¯¦ç»†ä»‹ç»ä¼šåç»­ç« èŠ‚å±•å¼€</code></li>
<li><code>MySQLï¼šMySQL å¼•æ“ï¼Œæ­¤ç±»æ•°æ®åº“ä¸‹ä¼šè‡ªåŠ¨æ‹‰å–è¿œç«¯ MySQL ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸ºå®ƒä»¬åˆ›å»º MySQL è¡¨å¼•æ“çš„æ•°æ®è¡¨ï¼Œå…³äºMySQLè¡¨å¼•æ“çš„è¯¦ç»†ä»‹ç»ä¹Ÿä¼šåœ¨åç»­ç« èŠ‚å±•å¼€ã€‚</code></li>
</ul>
<p><strong>åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½åªéœ€ä½¿ç”¨é»˜è®¤çš„æ•°æ®åº“å¼•æ“ï¼Œä¾‹å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œä¾¿èƒ½å¤Ÿåˆ›å»ºå±äºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ•°æ®åº“ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE kagura_nana;</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®åº“çš„å®è´¨å°±æ˜¯ç‰©ç†ç£ç›˜ä¸Šçš„ä¸€ä¸ªç›®å½•æ–‡ä»¶ï¼Œæ‰€ä»¥åœ¨è¯­å¥æ‰§è¡Œä¹‹åï¼ŒClickHouse ä¾¿ä¼šåœ¨å®‰è£…è·¯å¾„ä¸‹åˆ›å»º kagura_nana æ•°æ®åº“çš„ç›®å½•æ–‡ä»¶ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># ls /var/lib/clickhouse/data/</span></span><br><span class="line">default  kagura_nana  system</span><br><span class="line">[root@satori ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸æ­¤åŒæ—¶ï¼Œåœ¨ metadata è·¯å¾„ä¸‹ä¹Ÿä¼šä¸€åŒåˆ›å»ºç”¨äºæ¢å¤æ•°æ®åº“çš„ kagura_nana.sql æ–‡ä»¶ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># ls /var/lib/clickhouse/metadata/</span></span><br><span class="line">default  default.sql  kagura_nana  kagura_nana.sql  system  system.sql</span><br><span class="line">[root@satori ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ SHOW DATABASES æŸ¥è¯¢ï¼Œèƒ½å¤Ÿè¿”å› ClickHouse å½“å‰çš„æ•°æ®åº“åˆ—è¡¨:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">2</span>a4de6ad<span class="number">-535</span>f<span class="number">-489</span>f<span class="number">-955</span>e<span class="operator">-</span>dae511a18415</span><br><span class="line"></span><br><span class="line">â”Œâ”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="keyword">default</span>     â”‚</span><br><span class="line">â”‚ kagura_nana â”‚</span><br><span class="line">â”‚ <span class="keyword">system</span>      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ USE æŸ¥è¯¢å¯ä»¥å®ç°åœ¨å¤šä¸ªæ•°æ®åº“ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œé€šè¿‡ SHOW TABLES æŸ¥è¯¢å¯ä»¥æŸ¥çœ‹å½“å‰æ•°æ®åº“ä¸­å­˜åœ¨çš„æ‰€ä»¥æ•°æ®è¡¨ã€‚åˆ é™¤ä¸€ä¸ªæ•°æ®åº“ï¼Œåˆ™éœ€è¦ç”¨åˆ°ä¸‹é¢çš„ DROP æŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE [IF <span class="keyword">EXISTS</span>] db_name;</span><br></pre></td></tr></table></figure>

<h3 id="æ•°æ®è¡¨"><a href="#æ•°æ®è¡¨" class="headerlink" title="æ•°æ®è¡¨"></a>æ•°æ®è¡¨</h3><p><strong>æˆ‘ä»¬è¯´æ•°æ®åº“åœ¨ç‰©ç†ç£ç›˜ä¸Šå¯¹åº”ä¸€ä¸ªç›®å½•æ–‡ä»¶ï¼Œè€Œè¡¨åˆ™æ˜¯åœ¨æ•°æ®åº“å¯¹åº”çš„ç›®å½•æ–‡ä»¶é‡Œé¢å†åˆ›å»ºä¸€ä¸ªç›®å½•æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ•°æ®åº“ kagura_nana é‡Œé¢åˆ›å»ºä¸€å¼ è¡¨ tï¼Œé‚£ä¹ˆç›¸å½“äºåœ¨ &#x2F;var&#x2F;lib&#x2F;clickhouse&#x2F;data&#x2F;kagura_nana é‡Œé¢åˆ›å»ºä¸€ä¸ªç›®å½•æ–‡ä»¶ tï¼Œè€Œå¾€è¡¨ t é‡Œé¢å†™çš„æ•°æ®åˆ™ä¼šåœ¨ç›®å½• t ä¸­ä»¥æ–‡æœ¬æ–‡ä»¶çš„å½¢å¼ä¿å­˜ï¼Œæ‰€ä»¥æ•´ä¸ªé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°å¥½ç†è§£çš„ã€‚è€Œ ClickHouse æ•°æ®è¡¨çš„å®šä¹‰è¯­æ³•ï¼Œæ˜¯åœ¨æ ‡å‡† SQL çš„åŸºç¡€ä¹‹ä¸Šå»ºç«‹çš„ï¼Œæ‰€ä»¥ç†Ÿæ‚‰æ•°æ®åº“çš„ä½ åœ¨çœ‹åˆ°æ¥ä¸‹æ¥çš„è¯­æ³•æ—¶ï¼Œåº”è¯¥ä¼šæ„Ÿåˆ°å¾ˆç†Ÿæ‚‰ã€‚ClickHouse ç›®å‰æä¾›äº†ä¸‰ç§æœ€åŸºæœ¬çš„å»ºè¡¨æ–¹æ³•ï¼š</strong></p>
<p><strong>ç¬¬ä¸€ç§æ˜¯å¸¸è§„å®šä¹‰æ–¹æ³•ï¼Œå®ƒçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name.]table_name (</span><br><span class="line">    column_name1 type [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr],</span><br><span class="line">    column_name2 type [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr],</span><br><span class="line">    ......</span><br><span class="line">) ENGINE <span class="operator">=</span> engine</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ [db_name.] å‚æ•°å¯ä»¥ä¸ºæ•°æ®è¡¨æŒ‡å®šæ•°æ®åº“ï¼Œå¦‚æœä¸æŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™é»˜è®¤ä¼šä½¿ç”¨ default æ•°æ®åº“ã€‚æ³¨æ„ç»“å°¾çš„ ENGINE å‚æ•°ï¼Œå®ƒè¢«ç”¨äºæŒ‡å®šæ•°æ®è¡¨çš„å¼•æ“ï¼Œè¡¨å¼•æ“å†³å®šäº†æ•°æ®è¡¨çš„ç‰¹æ€§ï¼Œä¹Ÿå†³å®šäº†æ•°æ®å°†ä¼šè¢«å¦‚ä½•å­˜å‚¨ä»¥åŠå¦‚ä½•åŠ è½½ã€‚ä¾‹å¦‚ Memory è¡¨å¼•æ“ï¼Œå®ƒæ˜¯ ClickHouse æœ€ç®€å•çš„è¡¨å¼•æ“ï¼Œæ•°æ®åªä¼šè¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨æœåŠ¡é‡å¯æ—¶æ•°æ®ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬ä¼šåœ¨åç»­ç« èŠ‚è¯¦ç»†ä»‹ç»æ•°æ®è¡¨å¼•æ“ï¼Œæ­¤å¤„æš‚ä¸å±•å¼€ã€‚</strong></p>
<p><strong>ç¬¬äºŒç§å®šä¹‰æ–¹æ³•æ˜¯å¤åˆ¶å…¶ä»–è¡¨çš„ç»“æ„ï¼Œå…·ä½“è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name1.]table_name1 <span class="keyword">AS</span> [db_name2.]table_name2 [ENGINE <span class="operator">=</span> engine]</span><br></pre></td></tr></table></figure>

<p><strong>è¿™ç§æ–¹å¼æ”¯æŒåœ¨ä¸åŒçš„æ•°æ®åº“ä¹‹é—´å¤åˆ¶è¡¨ç»“æ„ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å°† A åº“ä¸‹çš„ a è¡¨æ‹·è´ä¸€ä»½åˆ° B åº“ä¸‹çš„ b è¡¨, æ³¨æ„ï¼šå¼•æ“å¯ä»¥æ›´æ¢</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> A.a <span class="keyword">AS</span> B.b ENGINE <span class="operator">=</span> TinyLog</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰ç§å®šä¹‰æ–¹æ³•æ˜¯é€šè¿‡ SELECT å­å¥çš„å½¢å¼åˆ›å»ºï¼Œå®ƒçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name].table_name ENGINE <span class="operator">=</span> engine <span class="keyword">AS</span> <span class="keyword">SELECT</span> ...</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œä¸ä»…ä¼šæ ¹æ® SELECT å­å¥å»ºç«‹ç›¸åº”çš„è¡¨ç»“æ„ï¼ŒåŒæ—¶è¿˜ä¼šå°† SELECT å­å¥æŸ¥è¯¢çš„æ•°æ®é¡ºå¸¦å†™å…¥ï¼Œä¾‹å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> db.not_exists_table ENGINE <span class="operator">=</span> Memory <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> db.exists_table</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°è¯­å¥ä¼šå°† SELECT * FROM db.exists_table çš„æŸ¥è¯¢ç»“æœä¸€å¹¶å†™å…¥æ•°æ®è¡¨ã€‚</strong></p>
<p><strong>ClickHouse å’Œå¤§å¤šæ•°æ•°æ®åº“ä¸€æ ·ï¼Œä½¿ç”¨ DESC æŸ¥è¯¢å¯ä»¥è¿”å›æ•°æ®è¡¨çš„å®šä¹‰ç»“æ„ï¼Œå¦å¤–å¦‚æœæƒ³åˆ é™¤ä¸€å¼ æ•°æ®è¡¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ DROP è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [IF <span class="keyword">EXISTS</span>] [db_name.]table_name</span><br></pre></td></tr></table></figure>

<h3 id="é»˜è®¤å€¼è¡¨è¾¾å¼"><a href="#é»˜è®¤å€¼è¡¨è¾¾å¼" class="headerlink" title="é»˜è®¤å€¼è¡¨è¾¾å¼"></a>é»˜è®¤å€¼è¡¨è¾¾å¼</h3><p><strong>è¡¨å­—æ®µæ”¯æŒä¸‰ç§é»˜è®¤å€¼è¡¨è¾¾å¼çš„å®šä¹‰æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ DEFAULTã€MATERIALIZED å’Œ ALIASã€‚æ— è®ºä½¿ç”¨å“ªç§å½¢å¼ï¼Œè¡¨å­—æ®µä¸€æ—¦å®šä¹‰äº†é»˜è®¤å€¼ï¼Œé‚£ä¹ˆä¾¿ä¸å†å¼ºåˆ¶è¦æ±‚å®šä¹‰æ•°æ®ç±»å‹ï¼Œå› ä¸º ClickHouse ä¼šæ ¹æ®é»˜è®¤å€¼è¿›è¡Œç±»å‹æ¨æ–­ã€‚å¦‚æœåŒæ—¶å¯¹è¡¨å­—æ®µå®šä¹‰äº†æ•°æ®ç±»å‹å’Œé»˜è®¤å€¼è¡¨è¾¾å¼ï¼Œåˆ™ä»¥æ˜ç¡®å®šä¹‰çš„æ•°æ®ç±»å‹ä¸ºä¸»ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (    id String,    col1 <span class="keyword">DEFAULT</span> <span class="number">100</span>,    col2 String <span class="keyword">DEFAULT</span> col1) ENGINE<span class="operator">=</span>Memory</span><br></pre></td></tr></table></figure>

<p><strong>col1 å­—æ®µæ²¡æœ‰å®šä¹‰æ•°æ®ç±»å‹ï¼Œé»˜è®¤å€¼ä¸ºæ•´å‹ 1000ï¼›col2 å­—æ®µå®šä¹‰äº†æ•°æ®ç±»å‹å’Œé»˜è®¤å€¼ï¼Œä¸”é»˜è®¤å€¼ç­‰äº col1ï¼Œç°åœ¨å†™å…¥æµ‹è¯•æ•°æ®ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name(id) <span class="keyword">VALUES</span>(<span class="string">&#x27;AAA&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨å†™å…¥ä¹‹åæ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> id, col1, col2, toTypeName(col1), toTypeName(col2) <span class="keyword">from</span> table_nameSELECT    id,    col1,    col2,    toTypeName(col1),    toTypeName(col2)<span class="keyword">FROM</span> table_nameQuery id: d9114fe3<span class="number">-172</span>f<span class="number">-4e2</span>f<span class="operator">-</span>bd2a<span class="number">-13</span>b514015de9â”Œâ”€idâ”€â”€â”¬â”€col1â”€â”¬â”€col2â”€â”¬â”€toTypeName(col1)â”€â”¬â”€toTypeName(col2)â”€â”â”‚ AAA â”‚  <span class="number">100</span> â”‚ <span class="number">100</span>  â”‚ UInt8            â”‚ String           â”‚â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.satori :)</span><br></pre></td></tr></table></figure>

<p><strong>ç”±æŸ¥è¯¢ç»“æœå¯ä»¥éªŒè¯ï¼Œé»˜è®¤å€¼çš„ä¼˜å…ˆçº§ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œå…¶ä¸­ col1 å­—æ®µæ ¹æ®é»˜è®¤å€¼è¢«æ¨æ–­ä¸º UInt16ï¼›è€Œ col2 å­—æ®µç”±äºåŒæ—¶å®šä¹‰äº†æ•°æ®ç±»å‹å’Œé»˜è®¤å€¼ï¼Œæ‰€ä»¥å®ƒæœ€ç»ˆçš„æ•°æ®ç±»å‹æ¥è‡ªæ˜ç¡®å®šä¹‰çš„ Stringã€‚</strong></p>
<hr>
<p><strong>é»˜è®¤å€¼è¡¨è¾¾å¼çš„ä¸‰ç§å®šä¹‰æ–¹æ³•ä¹‹é—´ä¹Ÿå­˜åœ¨ç€ä¸åŒä¹‹å¤„ï¼Œå¯ä»¥ä»å¦‚ä¸‹ä¸‰ä¸ªæ–¹é¢è¿›è¡Œæ¯”è¾ƒã€‚</strong></p>
<p><strong>1ï¼‰æ•°æ®å†™å…¥ï¼šåœ¨æ•°æ®å†™å…¥æ—¶ï¼Œåªæœ‰ DEFAULT ç±»å‹çš„å­—æ®µå¯ä»¥å‡ºç°åœ¨ INSERT è¯­å¥ä¸­ï¼Œè€Œ MATERIALIZED å’Œ ALIAS éƒ½ä¸èƒ½è¢«æ˜¾å¼èµ‹å€¼ï¼Œå®ƒä»¬åªèƒ½ä¾é è®¡ç®—å–å€¼ã€‚ä¾‹å¦‚è¯•å›¾ä¸º MATERIALIZED ç±»å‹çš„å­—æ®µå†™å…¥æ•°æ®ï¼Œå°†ä¼šå¾—åˆ°å¦‚ä¸‹çš„é”™è¯¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DB::Exception: Cannot <span class="keyword">insert</span> <span class="keyword">column</span> URL,because it <span class="keyword">is</span> MATERIALIZED column..</span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰æ•°æ®æŸ¥è¯¢ï¼šåœ¨æ•°æ®æŸ¥è¯¢æ—¶ï¼Œåªæœ‰ DEFAULT ç±»å‹çš„å­—æ®µå¯ä»¥é€šè¿‡ SELECT * è¿”å›ï¼Œè€Œ MATERIALIZED å’Œ ALIAS ç±»å‹çš„å­—æ®µä¸ä¼šå‡ºç°åœ¨ SELECT * æŸ¥è¯¢çš„è¿”å›ç»“æœé›†ä¸­ã€‚</strong></p>
<p><strong>3ï¼‰æ•°æ®å­˜å‚¨ï¼šåœ¨æ•°æ®å­˜å‚¨æ—¶ï¼Œåªæœ‰ DEFAULT å’Œ MATERIALIZED ç±»å‹çš„å­—æ®µæ‰æ”¯æŒæŒä¹…åŒ–ã€‚å¦‚æœä½¿ç”¨çš„è¡¨å¼•æ“æ”¯æŒç‰©ç†å­˜å‚¨ï¼ˆä¾‹å¦‚ TinyLog è¡¨å¼•æ“)ï¼Œé‚£ä¹ˆè¿™äº›åˆ—å­—æ®µå°†ä¼šæ‹¥æœ‰ç‰©ç†å­˜å‚¨ã€‚è€Œ ALIAS ç±»å‹çš„å­—æ®µä¸æ”¯æŒæŒä¹…åŒ–ï¼Œå®ƒçš„å–å€¼æ€»æ˜¯éœ€è¦ä¾é è®¡ç®—äº§ç”Ÿï¼Œæ•°æ®ä¸ä¼šè½åˆ°ç£ç›˜ã€‚</strong></p>
<p><strong>å¯ä»¥ä½¿ç”¨ ALTER è¯­å¥ä¿®æ”¹é»˜è®¤å€¼ï¼Œä¾‹å¦‚:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> [db_name.]table_name MODIFY COLOMN col_name DEFAUET <span class="keyword">value</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹åŠ¨ä½œå¹¶ä¸ä¼šå½±å“æ•°æ®è¡¨å†…å…ˆå‰å·²ç»å­˜åœ¨çš„æ•°æ®ï¼Œä½†æ˜¯é»˜è®¤å€¼çš„ä¿®æ”¹æœ‰è¯¸å¤šé™åˆ¶ï¼Œä¾‹å¦‚åœ¨ MergeTree è¡¨å¼•æ“ä¸­ï¼Œå®ƒçš„ä¸»é”®å­—æ®µæ˜¯æ— æ³•è¢«ä¿®æ”¹çš„ï¼›è€ŒæŸäº›è¡¨å¼•æ“åˆ™å®Œå…¨ä¸æ”¯æŒä¿®æ”¹ï¼ˆä¾‹å¦‚ TinyLogï¼‰ã€‚</strong></p>
<h3 id="ä¸´æ—¶è¡¨"><a href="#ä¸´æ—¶è¡¨" class="headerlink" title="ä¸´æ—¶è¡¨"></a>ä¸´æ—¶è¡¨</h3><p><strong>ClickHouse ä¹Ÿæœ‰ä¸´æ—¶è¡¨çš„æ¦‚å¿µï¼Œåˆ›å»ºä¸´æ—¶è¡¨çš„æ–¹æ³•æ˜¯åœ¨æ™®é€šè¡¨çš„åŸºç¡€ä¹‹ä¸Šæ·»åŠ  TEMPORARY å…³é”®å­—ï¼ŒCREATE TEMPORARY TABLEâ€¦ï¼Œå‰©ä½™çš„éƒ¨åˆ†å’Œåˆ›å»ºæ™®é€šè¡¨å®Œå…¨ä¸€æ ·ã€‚</strong></p>
<p><strong>ç›¸æ¯”æ™®é€šè¡¨è€Œè¨€ï¼Œä¸´æ—¶è¡¨æœ‰å¦‚ä¸‹ä¸¤ç‚¹ç‰¹æ®Šä¹‹å¤„ï¼š</strong></p>
<ul>
<li><code>å®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¼šè¯ç»‘å®šçš„ï¼Œæ‰€ä»¥å®ƒåªæ”¯æŒ Memory è¡¨å¼•æ“ï¼Œå¦‚æœä¼šè¯ç»“æŸï¼Œæ•°æ®è¡¨å°±ä¼šè¢«é”€æ¯;</code></li>
<li><code>ä¸´æ—¶è¡¨ä¸å±äºä»»ä½•æ•°æ®åº“ï¼Œæ‰€ä»¥åœ¨å®ƒçš„å»ºè¡¨è¯­å¥ä¸­ï¼Œæ—¢æ²¡æœ‰æ•°æ®åº“å‚æ•°ä¹Ÿæ²¡æœ‰è¡¨å¼•æ“å‚æ•°;</code></li>
</ul>
<p><strong>é’ˆå¯¹ç¬¬äºŒä¸ªç‰¹æ®Šé¡¹ï¼Œæœ‰äººå¿ƒä¸­éš¾å…ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼šæ—¢ç„¶ä¸´æ—¶è¡¨ä¸å±äºä»»ä½•æ•°æ®åº“ï¼Œå¦‚æœä¸´æ—¶è¡¨å’Œæ™®é€šè¡¨åç§°ç›¸åŒï¼Œä¼šå‡ºç°ä»€ä¹ˆçŠ¶å†µå‘¢ï¼Ÿæ¥ä¸‹æ¥ä¸å¦¨åšä¸ªæµ‹è¯•ã€‚é¦–å…ˆåœ¨ DEFAULT æ•°æ®åº“åˆ›å»ºæµ‹è¯•è¡¨å¹¶å†™å…¥æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_v1(title String) ENGINE <span class="operator">=</span> Memory;<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp_v1 <span class="keyword">VALUES</span> (<span class="string">&#x27;xxx&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ç€åˆ›å»ºä¸€å¼ åç§°ç›¸åŒçš„ä¸´æ—¶è¡¨å¹¶å†™å…¥æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> tmp_v1(num UInt8) ENGINE <span class="operator">=</span> Memory;<span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp_v1 <span class="keyword">VALUES</span> (<span class="number">22</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ç°åœ¨æŸ¥è¯¢ tmp_v1 çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tmp_v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> tmp_v1</span><br><span class="line"></span><br><span class="line">Query id: ad4b5094<span class="number">-3627</span><span class="number">-4</span>af7<span class="operator">-</span>a207<span class="operator">-</span>bbd8ef90617a</span><br><span class="line"></span><br><span class="line">â”Œâ”€numâ”€â”</span><br><span class="line">â”‚  <span class="number">22</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡è¿”å›ç»“æœå¯ä»¥å¾—å‡ºç»“è®ºï¼Œä¸´æ—¶è¡¨çš„ä¼˜å…ˆçº§æ˜¯å¤§äºæ™®é€šè¡¨çš„ã€‚å½“ä¸¤å¼ æ•°æ®è¡¨åç§°ç›¸åŒçš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆè¯»å–ä¸´æ—¶è¡¨çš„æ•°æ®ã€‚å½“ç„¶åœ¨ ClickHouse çš„æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œä¸ä¼šåˆ»æ„åœ°ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå®ƒæ›´å¤šè¢«è¿ç”¨åœ¨ ClickHouse çš„å†…éƒ¨ï¼Œæ˜¯æ•°æ®åœ¨é›†ç¾¤ä¹‹é—´ä¼ æ’­çš„è½½ä½“ã€‚</strong></p>
<h3 id="åˆ†åŒºè¡¨"><a href="#åˆ†åŒºè¡¨" class="headerlink" title="åˆ†åŒºè¡¨"></a>åˆ†åŒºè¡¨</h3><p><strong>æ•°æ®åˆ†åŒºï¼ˆpartitionï¼‰å’Œæ•°æ®åˆ†ç‰‡ï¼ˆshardï¼‰æ˜¯å®Œå…¨ä¸åŒçš„è€Œä¸ªæ¦‚å¿µï¼Œæ•°æ®åˆ†åŒºæ˜¯é’ˆå¯¹æœ¬åœ°æ•°æ®è€Œè¨€çš„ï¼Œæ˜¯æ•°æ®çš„ä¸€ç§çºµå‘åˆ‡åˆ†ï¼›è€Œæ•°æ®åˆ†ç‰‡æ˜¯æ•°æ®çš„ä¸€ç§æ¨ªå‘åˆ‡åˆ†ï¼ˆåç»­ç« èŠ‚ä¼šè¯¦ç»†è¯´ï¼‰ã€‚æ•°æ®åˆ†åŒºå¯¹äºä¸€æ¬¾ OLAP æ•°æ®åº“è€Œè¨€æ„ä¹‰éå‡¡ï¼Œå€ŸåŠ©æ•°æ®åˆ†åŒºï¼Œåœ¨åç»­çš„æŸ¥è¯¢è¿‡ç¨‹ä¸­èƒ½å¤Ÿè·³è¿‡ä¸å¿…è¦çš„æ•°æ®ç›®å½•ï¼Œä»è€Œæå‡æŸ¥è¯¢çš„æ€§èƒ½ã€‚åˆç†åœ°åˆ©ç”¨åˆ†åŒºç‰¹æ€§ï¼Œè¿˜å¯ä»¥å˜ç›¸å®ç°æ•°æ®çš„æ›´æ–°æ“ä½œï¼Œå› ä¸ºæ•°æ®åˆ†åŒºæ”¯æŒåˆ é™¤ã€æ›¿æ¢å’Œé‡ç½®æ“ä½œã€‚å‡è®¾æ•°æ®è¡¨æŒ‰ç…§æœˆä»½åˆ†åŒºï¼Œé‚£ä¹ˆæ•°æ®å°±å¯ä»¥æŒ‰æœˆä»½çš„ç²’åº¦è¢«æ›¿æ¢æ›´æ–°ã€‚</strong></p>
<p><strong>åˆ†åŒºè™½å¥½ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„è¡¨å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨è¿™é¡¹ç‰¹æ€§ï¼Œç›®å‰åªæœ‰åˆå¹¶æ ‘ï¼ˆMergeTreeï¼‰å®¶æ—ç³»åˆ—çš„è¡¨å¼•æ“æ‰æ”¯æŒæ•°æ®åˆ†åŒºã€‚æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºåˆ†åŒºè¡¨çš„ä½¿ç”¨æ–¹æ³•ï¼Œé¦–å…ˆç”± PARTITION BY æŒ‡å®šåˆ†åŒºé”®ï¼Œä¾‹å¦‚ä¸‹é¢çš„æ•°æ®è¡¨ partition_v1 ä½¿ç”¨äº†æ—¥æœŸå­—æ®µä½œä¸ºåˆ†åŒºé”®ï¼Œå¹¶å°†å…¶æ ¼å¼åŒ–ä¸ºå¹´æœˆçš„å½¢å¼ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> partition_v1 (</span><br><span class="line">    ID String,</span><br><span class="line">    URL String,</span><br><span class="line">    EventDate <span class="type">Date</span></span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ID</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ç€å†™å…¥ä¸åŒæœˆä»½çš„æµ‹è¯•æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> partition_v1 <span class="keyword">VALUES</span> (<span class="string">&#x27;a1&#x27;</span>, <span class="string">&#x27;www.a1.com&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>), (<span class="string">&#x27;a2&#x27;</span>, <span class="string">&#x27;www.a2.com&#x27;</span>, <span class="string">&#x27;2019-06-02&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>æœ€åé€šè¿‡ system.parts ç³»ç»Ÿè¡¨ï¼ŒæŸ¥è¯¢æ•°æ®è¡¨çš„åˆ†åŒºçŠ¶æ€ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">table</span>, <span class="keyword">partition</span>, path <span class="keyword">FROM</span> system.parts <span class="keyword">WHERE</span> <span class="keyword">table</span> <span class="operator">=</span> <span class="string">&#x27;partition_v1&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BB%A5%E5%8F%8A%20DDL(%E5%9B%9B)/1229382-20210816173455153-82548770.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°ï¼Œpartition_v1 æŒ‰å¹´æœˆåˆ’åˆ†åï¼Œç›®å‰æ‹¥æœ‰ä¸¤ä¸ªæ•°æ®åˆ†åŒºï¼Œä¸”æ¯ä¸ªåˆ†åŒºéƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ç›®å½•ï¼Œç”¨äºä¿å­˜å„è‡ªéƒ¨åˆ†çš„æ•°æ®ã€‚</strong></p>
<p><strong>åˆç†è®¾è®¡åˆ†åŒºé”®éå¸¸é‡è¦ï¼Œé€šå¸¸ä¼šæŒ‰ç…§æ•°æ®è¡¨çš„æŸ¥è¯¢åœºæ™¯è¿›è¡Œé’ˆå¯¹æ€§è®¾è®¡ã€‚ä¾‹å¦‚åœ¨åˆšæ‰ç¤ºä¾‹ä¸­çš„æ•°æ®è¡¨æŒ‰å¹´æœˆåˆ†åŒºï¼Œå¦‚æœåç»­çš„æŸ¥è¯¢æŒ‰ç…§åˆ†åŒºé”®è¿‡æ»¤ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> partition_v1 <span class="keyword">WHERE</span> EventDate <span class="operator">=</span><span class="string">&#x27;2019-05-01&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>é‚£ä¹ˆåœ¨åç»­çš„æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åˆ©ç”¨åˆ†åŒºç´¢å¼•è·³è¿‡ 6 æœˆä»½çš„åˆ†åŒºç›®å½•ï¼ŒåªåŠ è½½ 5 æœˆä»½çš„æ•°æ®ï¼Œä»è€Œå¸¦æ¥æŸ¥è¯¢çš„æ€§èƒ½æå‡ã€‚</strong></p>
<p><strong>å½“ç„¶ï¼Œä½¿ç”¨ä¸åˆç†çš„åˆ†åŒºé”®ä¹Ÿä¼šé€‚å¾—å…¶åï¼Œåˆ†åŒºé”®ä¸åº”è¯¥ä½¿ç”¨ç²’åº¦è¿‡ç»†çš„æ•°æ®å­—æ®µã€‚ä¾‹å¦‚æŒ‰ç…§å°æ—¶åˆ†åŒºï¼Œå°†ä¼šå¸¦æ¥åˆ†åŒºæ•°é‡çš„æ€¥å‰§å¢é•¿ï¼Œä»è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å…³äºæ•°æ®åˆ†åŒºæ›´è¯¦ç»†çš„åŸç†è¯´æ˜ï¼Œä¹Ÿä¼šåœ¨åç»­ç« èŠ‚è¿›è¡Œã€‚</strong></p>
<h3 id="è§†å›¾"><a href="#è§†å›¾" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h3><p><strong>ClickHouse æ‹¥æœ‰æ™®é€šå’Œç‰©åŒ–ä¸¤ç§è§†å›¾ï¼Œå…¶ä¸­ç‰©åŒ–è§†å›¾æ‹¥æœ‰ç‹¬ç«‹çš„å­˜å‚¨ï¼Œæˆ‘ä»¬ä¸€ä¼šè¯´ï¼›è€Œæ™®é€šè§†å›¾å’Œå…³ç³»å‹æ•°æ®åº“ä¸­çš„è§†å›¾ç±»ä¼¼ï¼Œåªæ˜¯ä¸€å±‚ç®€å•çš„æŸ¥è¯¢ä»£ç†ã€‚åˆ›å»ºæ™®é€šè§†å›¾çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name.]view_name <span class="keyword">AS</span> SELECT...</span><br></pre></td></tr></table></figure>

<p><strong>æ™®é€šè§†å›¾ä¸ä¼šå­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒåªæ˜¯ä¸€å±‚å•çº¯çš„ SELECT æŸ¥è¯¢æ˜ å°„ï¼Œèµ·ç€ç®€åŒ–æŸ¥è¯¢ã€æ˜æ™°è¯­ä¹‰çš„ä½œç”¨ï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½ä¸ä¼šæœ‰ä»»ä½•å¢å¼ºã€‚å‡è®¾æœ‰ä¸€å¼ æ™®é€šè§†å›¾ view_tb_v1ï¼Œå®ƒæ˜¯åŸºäºæ•°æ®è¡¨ tb_v1 çš„ id å’Œ name ä¸¤ä¸ªå­—æ®µåˆ›å»ºçš„ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä¸¤æ¡ SELECT æŸ¥è¯¢æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> view_tb_v1;</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> tb_v1;</span><br></pre></td></tr></table></figure>

<p><strong>è€Œç‰©åŒ–è§†å›¾éœ€è¦æŒ‡å®šè¡¨å¼•æ“ï¼Œæ•°æ®ä¿å­˜å½¢å¼ç”±å®ƒçš„è¡¨å¼•æ“å†³å®šï¼Œåˆ›å»ºç‰©åŒ–è§†å›¾çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]view_name [<span class="keyword">TO</span> [db.]name] ENGINE <span class="operator">=</span> engine [POPULATE] <span class="keyword">AS</span> <span class="keyword">SELECT</span> ...</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æ¥å¯¹è¿™äº›è¯­æ³•è§„åˆ™ä¸¾ä¾‹è¯´æ˜ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€å¼ ç‰©åŒ–è§†å›¾ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç‰©åŒ–è§†å›¾æœ¬è´¨ä¸Šå¯ä»¥çœ‹æˆæ˜¯ä¸€å¼ ç‰¹æ®Šçš„æ•°æ®è¡¨ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™ä¹Ÿéœ€è¦æŒ‡å®šå¼•æ“</span></span><br><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> girls_view_1 ENGINE<span class="operator">=</span>TinyLog()</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> id, name, age <span class="keyword">FROM</span> girls;</span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæ™®é€šè§†å›¾ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºç‰©åŒ–çš„è§†å›¾çš„æ—¶å€™ï¼Œåœ¨ create åé¢å¤šå†™äº†ä¸€ä¸ª MATERIALIZED æ¥è¡¨ç¤ºåˆ›å»ºçš„æ˜¯ç‰©åŒ–è§†å›¾ã€ä»¥åŠæŒ‡å®šäº†ä¸€ä¸ªè¡¨å¼•æ“ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç‰©åŒ–è§†å›¾æ˜¯å¯ä»¥å­˜å‚¨æ•°æ®çš„ã€‚æ¯”å¦‚æ­¤æ—¶çš„ç‰©åŒ–è§†å›¾ girls_view_1 æ˜¯æ ¹æ®è¡¨ girls çš„ idã€nameã€age ä¸‰ä¸ªå­—æ®µåˆ›å»ºçš„ï¼Œå¦‚æœä¹‹åå†å¾€ girls é‡Œé¢å†™æ•°æ®ï¼Œé‚£ä¹ˆæ–°å†™å…¥çš„æ•°æ®å¯¹åº”çš„ idã€nameã€age å°±ä¼šåŒæ­¥åˆ° girl_view_1 ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç‰©åŒ–è§†å›¾åˆ›å»ºå¥½ä¹‹åï¼Œå¦‚æœæºè¡¨è¢«å†™å…¥æ–°æ•°æ®ï¼Œé‚£ä¹ˆç‰©åŒ–è§†å›¾ä¹Ÿä¼šåŒæ­¥æ›´æ–°ã€‚</strong></p>
<p><strong>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç‰©åŒ–è§†å›¾åœ¨åˆ›å»ºæ—¶ä¸ä¼šæ‹·è´æºè¡¨ä¸­çš„æ•°æ®ï¼Œå®ƒåªä¼šåŒæ­¥åœ¨æ­¤ä¹‹åè¢«å†™å…¥æºè¡¨çš„æ•°æ®ï¼Œæ‰€ä»¥å½“å‰ girls é‡Œé¢çš„å·²å­˜åœ¨çš„æ•°æ®å¹¶æ²¡æœ‰å†™å…¥åˆ° girls_view_\1 ä¸­ã€‚å¦‚æœå¸Œæœ›åœ¨åˆ›å»ºçš„ç‰©åŒ–è§†å›¾çš„æ—¶å€™ï¼Œå°±é¡ºå¸¦æŠŠè¡¨ä¸­çš„æ•°æ®ä¹ŸåŒæ­¥è¿‡å»è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åªéœ€è¦åœ¨ AS SELECT çš„å‰é¢åŠ ä¸Š POPULATE å³å¯</span></span><br><span class="line"><span class="comment">-- æ­¤æ—¶è¡¨ girls çš„æ•°æ®ï¼Œæ›´å‡†ç¡®çš„è¯´æ˜¯ SELECT æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†æ‰ä¼šè¿›å…¥ç‰©åŒ–è§†å›¾ä¸­</span></span><br><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> girls_view_1 ENGINE<span class="operator">=</span>TinyLog()</span><br><span class="line">POPULATE <span class="keyword">AS</span> <span class="keyword">SELECT</span> id, name, age <span class="keyword">FROM</span> girls;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ POPULATE ä¿®é¥°ç¬¦å†³å®šäº†ç‰©åŒ–è§†å›¾çš„åˆå§‹åŒ–ç­–ç•¥ï¼šå¦‚æœä½¿ç”¨äº† POPULATE ä¿®é¥°ç¬¦ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºè§†å›¾çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¿å¸¦å°†æºè¡¨ä¸­å·²å­˜åœ¨çš„æ•°æ®ï¼ˆæ›´å‡†ç¡®çš„è¯´æ˜¯ SELECT æŸ¥è¯¢å¾—åˆ°çš„ç»“æœé›†ï¼‰ä¸€å¹¶å¯¼å…¥ã€‚åä¹‹ï¼Œå¦‚æœä¸ä½¿ç”¨ POPULATE ä¿®é¥°ç¬¦ï¼Œé‚£ä¹ˆç‰©åŒ–è§†å›¾åœ¨åˆ›å»ºä¹‹åæ˜¯æ²¡æœ‰æ•°æ®çš„ï¼Œå®ƒåªä¼šåŒæ­¥åœ¨æ­¤ä¹‹åè¢«å†™å…¥æºè¡¨çš„æ•°æ®ã€‚</strong></p>
<p><strong>å¦å¤–ç‰©åŒ–è§†å›¾æœ¬è´¨æ˜¯ä¸€å¼ ç‰¹æ®Šçš„æ•°æ®è¡¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆä½¿ç”¨ SHOW TABLE ä¹Ÿèƒ½æŸ¥çœ‹åˆ°ã€‚è€Œå¦‚æœåˆ é™¤ä¸€ä¸ªè§†å›¾ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ DROP TABLE å³å¯ï¼Œæ³¨æ„ï¼šæ²¡æœ‰ DROP VIEWï¼Œåªè¦æ˜¯è§†å›¾ï¼Œåˆ é™¤è¯­å¥éƒ½æ˜¯ DROP TABLEï¼Œæ‰€ä»¥è¿™ä¹Ÿä¾§é¢è¯´æ˜äº†è§†å›¾åå’Œè¡¨åä¸å¯ä»¥é‡å¤ã€‚</strong></p>
<p><strong>ç„¶åç‰©åŒ–è§†å›¾è¿˜æœ‰ä¸€ä¸ªç”¨æ³•ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç‰©åŒ–è§†å›¾çš„æ—¶å€™å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯ä¼šåˆ›å»ºä¸€å¼ è¡¨ï¼Œé»˜è®¤åç§°æ˜¯ â€œ .inner.ç‰©åŒ–è§†å›¾å â€œï¼Œåªä¸è¿‡è¿™å¼ è¡¨æ˜¯éšè—çš„ï¼Œå…¶ä½œç”¨å°±æ˜¯è´Ÿè´£ä¿å­˜ç‰©åŒ–è§†å›¾ä»æºè¡¨ä¸­åŒæ­¥è¿‡æ¥çš„æ•°æ®ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè´Ÿè´£å­˜å‚¨ç‰©åŒ–è§†å›¾æ•°æ®çš„è¡¨å¯ä¸å¯ä»¥æˆ‘ä»¬è‡ªå·±æŒ‡å®šå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> girls_view_1 <span class="keyword">TO</span> other_girls</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> id, name, age <span class="keyword">FROM</span> girls;</span><br></pre></td></tr></table></figure>

<p><strong>ç‰©åŒ–è§†å›¾åœ¨åŒæ­¥æ•°æ®çš„æ—¶å€™å°±ä¼šå°†æ•°æ®å†™å…¥åˆ° other_girls ä¸­ï¼Œå½“ç„¶ other_girls çš„è¡¨ç»“æ„ä¸ SELECT é€‰æ‹©çš„å­—æ®µçš„ç±»å‹ã€æ•°é‡è¦ç›¸åŒ¹é…ï¼Œå¹¶ä¸”æ­¤æ—¶æˆ‘ä»¬æ—¢å¯ä»¥é€šè¿‡ç‰©åŒ–è§†å›¾æŸ¥çœ‹æ•°æ®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ other_girls æ¥æŸ¥çœ‹ã€‚è¿™ç§ç”¨æ³•ï¼Œæˆ‘ä»¬åé¢ä»‹ç»è¡¨å¼•æ“çš„æ—¶å€™ä¼šè¯´ï¼Œç›®å‰å…ˆäº†è§£ç‰©åŒ–è§†å›¾çš„ç”¨æ³•ã€‚</strong></p>
<h3 id="æ•°æ®è¡¨çš„åŸºæœ¬æ“ä½œ"><a href="#æ•°æ®è¡¨çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="æ•°æ®è¡¨çš„åŸºæœ¬æ“ä½œ"></a>æ•°æ®è¡¨çš„åŸºæœ¬æ“ä½œ</h3><p><strong>ç›®å‰åªæœ‰ MergeTreeã€Merge å’Œ Distributed è¿™ä¸‰ç±»è¡¨å¼•æ“æ”¯æŒ ALTER æŸ¥è¯¢ï¼Œå¦‚æœç°åœ¨è¿˜ä¸æ˜ç™½è¿™äº›è¡¨å¼•æ“çš„ä½œç”¨ä¹Ÿä¸å¿…æ‹…å¿ƒï¼Œç›®å‰åªéœ€ç®€å•äº†è§£è¿™äº›ä¿¡æ¯å³å¯ï¼Œåé¢ä¼šå¯¹å®ƒä»¬è¿›è¡Œä»‹ç»ã€‚</strong></p>
<h4 id="è¿½åŠ æ–°å­—æ®µ"><a href="#è¿½åŠ æ–°å­—æ®µ" class="headerlink" title="è¿½åŠ æ–°å­—æ®µ"></a>è¿½åŠ æ–°å­—æ®µ</h4><p><strong>å‡å¦‚éœ€è¦å¯¹ä¸€å¼ æ•°æ®è¡¨è¿½åŠ æ–°çš„å­—æ®µï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] å­—æ®µå [ç±»å‹] [é»˜è®¤å€¼] [æ’åœ¨å“ªä¸ªå­—æ®µåé¢]</span><br></pre></td></tr></table></figure>

<h4 id="ä¿®æ”¹å­—æ®µç±»å‹"><a href="#ä¿®æ”¹å­—æ®µç±»å‹" class="headerlink" title="ä¿®æ”¹å­—æ®µç±»å‹"></a>ä¿®æ”¹å­—æ®µç±»å‹</h4><p><strong>å¦‚æœéœ€è¦æ”¹å˜è¡¨å­—æ®µçš„æ•°æ®ç±»å‹æˆ–è€…é»˜è®¤å€¼ï¼Œéœ€è¦ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name MODIFY <span class="keyword">COLUMN</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] å­—æ®µå [ç±»å‹] [é»˜è®¤å€¼]</span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹æŸä¸ªå­—æ®µçš„æ•°æ®ç±»å‹ï¼Œå®è´¨ä¸Šä¼šè°ƒç”¨ç›¸åº”çš„ toType è½¬å‹æ–¹æ³•ã€‚å¦‚æœå½“å‰çš„ç±»å‹ä¸æœŸæœ›çš„ç±»å‹ä¸èƒ½å…¼å®¹ï¼Œåˆ™ä¿®æ”¹ç±»å‹å¤±è´¥ã€‚ä¾‹å¦‚å°† String ç±»å‹çš„ IP å­—æ®µè½¬æˆ IPv4 ç±»å‹æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯è½¬æˆ UInt åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚</strong></p>
<h4 id="ä¿®æ”¹å¤‡æ³¨"><a href="#ä¿®æ”¹å¤‡æ³¨" class="headerlink" title="ä¿®æ”¹å¤‡æ³¨"></a>ä¿®æ”¹å¤‡æ³¨</h4><p><strong>åšå¥½ä¿¡æ¯å¤‡æ³¨æ˜¯ä¿æŒè‰¯å¥½ç¼–ç¨‹ä¹ æƒ¯çš„ç¾å¾·ä¹‹ä¸€ï¼Œæ‰€ä»¥å¦‚æœä½ è¿˜æ²¡æœ‰ä¸ºåˆ—å­—æ®µæ·»åŠ å¤‡æ³¨ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±èµ¶ç´§è¡ŒåŠ¨å§ã€‚è¿½åŠ å¤‡æ³¨çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name COMMENT <span class="keyword">COLUMN</span> [IF <span class="keyword">EXISTS</span>] å­—æ®µå <span class="string">&#x27;some comment&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BB%A5%E5%8F%8A%20DDL(%E5%9B%9B)/1229382-20210816173503361-1995846816.png" alt="img"></p>
<h4 id="åˆ é™¤å·²æœ‰å­—æ®µ"><a href="#åˆ é™¤å·²æœ‰å­—æ®µ" class="headerlink" title="åˆ é™¤å·²æœ‰å­—æ®µ"></a>åˆ é™¤å·²æœ‰å­—æ®µ</h4><p><strong>å‡å¦‚è¦åˆ é™¤æŸä¸ªå­—æ®µï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> [IF <span class="keyword">EXISTS</span>] name</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæŸä¸ªå­—æ®µè¢«åˆ é™¤ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ•°æ®ä¹Ÿå°±è¢«åˆ é™¤äº†ã€‚</strong></p>
<h4 id="ç§»åŠ¨æ•°æ®è¡¨"><a href="#ç§»åŠ¨æ•°æ®è¡¨" class="headerlink" title="ç§»åŠ¨æ•°æ®è¡¨"></a>ç§»åŠ¨æ•°æ®è¡¨</h4><p><strong>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œmv å‘½ä»¤çš„æœ¬æ„æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ä»åŸå§‹ä½ç½® A ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½® Bï¼Œä½†æ˜¯å¦‚æœä½ç½® A ä¸ä½ç½® B ç›¸åŒï¼Œåˆ™å¯ä»¥å˜ç›¸å®ç°é‡å‘½åçš„ä½œç”¨ã€‚ClickHouse çš„ RENAME æŸ¥è¯¢å°±ä¸ä¹‹æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼ŒRENAME è¯­å¥çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">RENAME <span class="keyword">TABLE</span> [db_name1.]table_name1 <span class="keyword">TO</span> [db_name2.]table_name2, [db_name1.]table_name3 <span class="keyword">TO</span> [db_name2.]table_name3......</span><br></pre></td></tr></table></figure>

<p><strong>RENAME å¯ä»¥ä¿®æ”¹æ•°æ®è¡¨çš„åç§°ï¼Œå¦‚æœå°†åŸå§‹æ•°æ®åº“ä¸ç›®æ ‡æ•°æ®åº“è®¾ä¸ºä¸åŒçš„åç§°ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°æ•°æ®è¡¨åœ¨ä¸¤ä¸ªæ•°æ®åº“ä¹‹é—´ç§»åŠ¨çš„æ•ˆæœï¼Œå¹¶ä¸”è¿˜å¯ä»¥åŒæ—¶ç§»åŠ¨å¤šå¼ ã€‚</strong></p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°æ®è¡¨çš„ç§»åŠ¨åªèƒ½åœ¨å•ä¸ªèŠ‚ç‚¹çš„èŒƒå›´å†…ã€‚æ¢è¨€ä¹‹ï¼Œæ•°æ®è¡¨ç§»åŠ¨çš„ç›®æ ‡æ•°æ®åº“å’ŒåŸå§‹æ•°æ®åº“å¿…é¡»åœ¨åŒä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹å†…ï¼Œè€Œä¸èƒ½æ˜¯é›†ç¾¤ä¸­çš„è¿œç¨‹èŠ‚ç‚¹ã€‚</strong></p>
<h4 id="æ¸…ç©ºæ•°æ®è¡¨"><a href="#æ¸…ç©ºæ•°æ®è¡¨" class="headerlink" title="æ¸…ç©ºæ•°æ®è¡¨"></a>æ¸…ç©ºæ•°æ®è¡¨</h4><p><strong>å‡è®¾éœ€è¦å°†è¡¨å†…çš„æ•°æ®å…¨éƒ¨æ¸…ç©ºï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤è¿™å¼ è¡¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ TRUNCATE è¯­å¥ï¼Œå®ƒçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">EXISTS</span>] [db_name.]table_name</span><br></pre></td></tr></table></figure>

<h3 id="æ•°æ®åˆ†åŒºçš„åŸºæœ¬æ“ä½œ"><a href="#æ•°æ®åˆ†åŒºçš„åŸºæœ¬æ“ä½œ" class="headerlink" title="æ•°æ®åˆ†åŒºçš„åŸºæœ¬æ“ä½œ"></a>æ•°æ®åˆ†åŒºçš„åŸºæœ¬æ“ä½œ</h3><p><strong>äº†è§£å¹¶å–„ç”¨æ•°æ®åˆ†åŒºç›Šå¤„é¢‡å¤šï¼Œç†Ÿç»ƒæŒæ¡å®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥ä¸ºåç»­çš„ç¨‹åºè®¾è®¡å¸¦æ¥æå¤§çš„çµæ´»æ€§å’Œä¾¿åˆ©æ€§ï¼Œç›®å‰åªæœ‰ MergeTree ç³»åˆ—çš„è¡¨å¼•æ“æ”¯æŒæ•°æ®åˆ†åŒºã€‚</strong></p>
<h4 id="æŸ¥è¯¢åˆ†åŒºä¿¡æ¯"><a href="#æŸ¥è¯¢åˆ†åŒºä¿¡æ¯" class="headerlink" title="æŸ¥è¯¢åˆ†åŒºä¿¡æ¯"></a>æŸ¥è¯¢åˆ†åŒºä¿¡æ¯</h4><p><strong>ClickHouse å†…ç½®äº†è®¸å¤š system ç³»ç»Ÿè¡¨ï¼Œç”¨äºæŸ¥è¯¢è‡ªèº«çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­ parts ç³»ç»Ÿè¡¨ä¸“é—¨ç”¨äºæŸ¥è¯¢æ•°æ®è¡¨çš„åˆ†åŒºä¿¡æ¯ã€‚ä¾‹å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œå°±èƒ½å¤Ÿå¾—åˆ°æ•°æ®è¡¨ partition_v1 çš„åˆ†åŒºçŠ¶å†µ:</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E6%95%B0%E6%8D%AE%E8%A1%A8%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BB%A5%E5%8F%8A%20DDL(%E5%9B%9B)/1229382-20210816173511827-810044396.png" alt="img"></p>
<p><strong>å¦‚ä¸Šæ‰€ç¤ºï¼Œç›®å‰ partition_v1 å…±æ‹¥æœ‰ 2 ä¸ªåˆ†åŒºï¼Œå…¶ä¸­ partition_id æˆ–è€… name ç­‰åŒäºåˆ†åŒºçš„ä¸»é”®ï¼Œå¯ä»¥åŸºäºå®ƒä»¬çš„å–å€¼ç¡®å®šä¸€ä¸ªå…·ä½“çš„åˆ†åŒºã€‚</strong></p>
<h4 id="åˆ é™¤æŒ‡å®šåˆ†åŒº"><a href="#åˆ é™¤æŒ‡å®šåˆ†åŒº" class="headerlink" title="åˆ é™¤æŒ‡å®šåˆ†åŒº"></a>åˆ é™¤æŒ‡å®šåˆ†åŒº</h4><p><strong>åˆç†åœ°è®¾è®¡åˆ†åŒºé”®å¹¶åˆ©ç”¨åˆ†åŒºçš„åˆ é™¤åŠŸèƒ½ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°æ•°æ®æ›´æ–°çš„ç›®çš„ï¼Œåˆ é™¤ä¸€ä¸ªæŒ‡å®šåˆ†åŒºçš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> partition_expr</span><br></pre></td></tr></table></figure>

<p><strong>å‡å¦‚ç°åœ¨éœ€è¦æ›´æ–° partition_v1 æ•°æ®è¡¨æ•´ä¸ª 6 æœˆä»½çš„æ•°æ®ï¼Œåˆ™å¯ä»¥å…ˆå°† 6 æœˆä»½çš„åˆ†åŒºåˆ é™¤ï¼›</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> partition_v1 <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> <span class="number">201906</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åå°†æ•´ä¸ª 6 æœˆä»½çš„æ–°æ•°æ®é‡æ–°å†™å…¥ï¼Œå°±å¯ä»¥è¾¾åˆ°æ›´æ–°çš„ç›®çš„ã€‚</strong></p>
<h4 id="å¤åˆ¶åˆ†åŒºæ•°æ®"><a href="#å¤åˆ¶åˆ†åŒºæ•°æ®" class="headerlink" title="å¤åˆ¶åˆ†åŒºæ•°æ®"></a>å¤åˆ¶åˆ†åŒºæ•°æ®</h4><p><strong>ClickHouse æ”¯æŒå°† A è¡¨çš„åˆ†åŒºæ•°æ®å¤åˆ¶åˆ° B è¡¨ï¼Œè¿™é¡¹ç‰¹æ€§å¯ä»¥ç”¨äºå¿«é€Ÿæ•°æ®å†™å…¥ã€å¤šè¡¨é—´æ•°æ®åŒæ­¥å’Œå¤‡ä»½ç­‰åœºæ™¯ï¼Œå®ƒçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> B REPLACE <span class="keyword">PARTITION</span> partition_expr <span class="keyword">FROM</span> A</span><br></pre></td></tr></table></figure>

<p><strong>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯ä»»æ„æ•°æ®è¡¨ä¹‹é—´éƒ½èƒ½å¤Ÿç›¸äº’å¤åˆ¶ï¼Œå®ƒä»¬è¿˜éœ€è¦æ»¡è¶³ä¸¤ä¸ªå‰ææ¡ä»¶ï¼š</strong></p>
<ul>
<li><code>ä¸¤å¼ è¡¨éœ€è¦æ‹¥æœ‰ç›¸åŒçš„åˆ†åŒºé”®;</code></li>
<li><code>å®ƒä»¬çš„è¡¨ç»“æ„å®Œå…¨ç›¸åŒ;</code></li>
</ul>
<p><strong>å‡è®¾æœ‰ä¸€ä¸ªæ•°æ®è¡¨ partition_v2ï¼Œå¹¶ä¸”ä¸ä¹‹å‰ partition_v1 çš„åˆ†åŒºé”®å’Œè¡¨ç»“æ„å®Œå…¨ç›¸åŒï¼Œé‚£ä¹ˆå¦‚æœæƒ³å°† partition_v1 ä¸­ 5 æœˆä»½çš„æ•°æ®å¯¼å…¥åˆ° partition_v2ä¸­ï¼Œå°±å¯ä»¥è¿™ä¹ˆåšã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> partition_v2 REPLACE <span class="keyword">PARTITION</span> <span class="number">201905</span> <span class="keyword">FROM</span> partition_v1</span><br></pre></td></tr></table></figure>

<h4 id="é‡ç½®åˆ†åŒºæ•°æ®"><a href="#é‡ç½®åˆ†åŒºæ•°æ®" class="headerlink" title="é‡ç½®åˆ†åŒºæ•°æ®"></a>é‡ç½®åˆ†åŒºæ•°æ®</h4><p><strong>å¦‚æœæ•°æ®è¡¨æŸä¸€åˆ—çš„æ•°æ®æœ‰è¯¯ï¼Œéœ€è¦å°†å…¶é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­å¥å®ç°:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name CLEAR <span class="keyword">COLUMN</span> column_name <span class="keyword">IN</span> <span class="keyword">PARTITION</span> partition_expr</span><br></pre></td></tr></table></figure>

<p><strong>é¦–å…ˆå¦‚æœå£°æ˜äº†é»˜è®¤å€¼è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆä»¥è¡¨è¾¾å¼ä¸ºå‡†ï¼›å¦åˆ™ä»¥ç›¸åº”æ•°æ®ç±»å‹çš„é»˜è®¤å€¼ä¸ºå‡†ï¼Œæ¯”å¦‚ String ç±»å‹çš„é»˜è®¤å€¼å°±æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚</strong></p>
<h4 id="è£…è½½ä¸å¸è½½åˆ†åŒº"><a href="#è£…è½½ä¸å¸è½½åˆ†åŒº" class="headerlink" title="è£…è½½ä¸å¸è½½åˆ†åŒº"></a>è£…è½½ä¸å¸è½½åˆ†åŒº</h4><p><strong>è¡¨åˆ†åŒºå¯ä»¥é€šè¿‡ DETACH è¯­å¥å¸è½½ï¼Œåˆ†åŒºè¢«å¸è½½åï¼Œå®ƒçš„ç‰©ç†æ•°æ®å¹¶æ²¡æœ‰åˆ é™¤ï¼Œè€Œæ˜¯è¢«è½¬ç§»åˆ°äº†å½“å‰æ•°æ®è¡¨ç›®å½•çš„ detached å­ç›®å½•ä¸‹ã€‚è€Œè£…è½½åˆ†åŒºåˆ™æ˜¯åå‘æ“ä½œï¼Œå®ƒèƒ½å¤Ÿå°† detached å­ç›®å½•ä¸‹çš„æŸä¸ªåˆ†åŒºé‡æ–°è£…è½½å›å»ã€‚å¸è½½ä¸è£…è½½è¿™ä¸€å¯¹ä¼´ç”Ÿçš„æ“ä½œï¼Œå¸¸ç”¨äºåˆ†åŒºæ•°æ®çš„è¿ç§»å’Œå¤‡ä»½åœºæ™¯ã€‚å¸è½½æŸä¸ªåˆ†åŒºçš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name DETACH <span class="keyword">PARTITION</span> partition_expr</span><br></pre></td></tr></table></figure>

<p><strong>å‡è®¾æœ‰ä¸€ä¸ªåˆ†åŒºè¡¨ partition_v3ï¼Œé‡Œé¢æœ‰å¾ˆå¤šæœˆçš„æ•°æ®ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹é¢çš„è¯­å¥å°±å¯ä»¥å°†è¯¥è¡¨ä¸­æ•´ä¸ª 8 æœˆä»½çš„åˆ†åŒºå¸è½½ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> partition_v3 DETACH <span class="keyword">PARTITION</span> <span class="number">201908</span></span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶å†æ¬¡æŸ¥è¯¢è¿™å¼ è¡¨ï¼Œä¼šå‘ç°å…¶ä¸­ 2019 å¹´ 8 æœˆä»½çš„æ•°æ®å·²ç»æ²¡æœ‰äº†ã€‚è€Œè¿›å…¥ partition_v3 çš„ç£ç›˜ç›®å½•ï¼Œåˆ™å¯ä»¥çœ‹åˆ°è¢«å¸è½½çš„åˆ†åŒºç›®å½•å·²ç»è¢«ç§»åŠ¨åˆ°äº† detached ç›®å½•ä¸­ã€‚</strong></p>
<p><strong>è®°ä½ï¼Œä¸€æ—¦åˆ†åŒºè¢«ç§»åŠ¨åˆ°äº† detached å­æ—¥å½•ï¼Œå°±ä»£è¡¨å®ƒå·²ç»è„±ç¦»äº† ClickHouse çš„ç®¡ç†ï¼ŒClickHouse å¹¶ä¸ä¼šä¸»åŠ¨æ¸…ç†è¿™äº›æ–‡ä»¶ã€‚è¿™æ­¤åˆ†åŒºæ–‡ä»¶ä¼šä¸€ç›´å­˜åœ¨ï¼Œé™¤éæˆ‘ä»¬ä¸»åŠ¨åˆ é™¤æˆ–è€…ä½¿ç”¨ ATTACH è¯­å¥é‡æ–°è£…è½½å®ƒä»¬ã€‚è£…è½½æŸä¸ªåˆ†åŒºçš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name ATTACH <span class="keyword">PARTITION</span> partition_expr</span><br></pre></td></tr></table></figure>

<p><strong>å†æ¬¡æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œå°±å¯ä»¥å°†åˆšæ‰å·²è¢«å¸è½½çš„ 201908 åˆ†åŒºé‡æ–°è£…è½½å›å»:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> partition_v3 ATTACH <span class="keyword">PARTITION</span> <span class="number">201908</span></span><br></pre></td></tr></table></figure>

<h4 id="å¤‡ä»½ä¸è¿˜åŸæ–‡ä»¶"><a href="#å¤‡ä»½ä¸è¿˜åŸæ–‡ä»¶" class="headerlink" title="å¤‡ä»½ä¸è¿˜åŸæ–‡ä»¶"></a>å¤‡ä»½ä¸è¿˜åŸæ–‡ä»¶</h4><p><strong>å…³äºåˆ†åŒºæ•°æ®çš„å¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡ FREEZE ä¸ FETCH å®ç°ï¼Œç”±äºç›®å‰è¿˜ç¼ºå°‘ç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åç»­ç« èŠ‚ä»‹ç»ã€‚</strong></p>
<h3 id="åˆ†å¸ƒå¼-DDL-æ‰§è¡Œ"><a href="#åˆ†å¸ƒå¼-DDL-æ‰§è¡Œ" class="headerlink" title="åˆ†å¸ƒå¼ DDL æ‰§è¡Œ"></a>åˆ†å¸ƒå¼ DDL æ‰§è¡Œ</h3><p><strong>ClickHouse æ”¯æŒé›†ç¾¤æ¨¡å¼ï¼Œä¸€ä¸ªé›†ç¾¤æ‹¥æœ‰ 1 åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚CREATEã€ALTERã€DROPã€RENMAE åŠ TRUNCATE è¿™äº› DDL è¯­å¥ï¼Œéƒ½æ”¯æŒåˆ†å¸ƒå¼æ‰§è¡Œã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåœ¨é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ DDL è¯­å¥ï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„è¯­å¥ã€‚è¿™é¡¹ç‰¹æ€§æ„ä¹‰éå‡¡ï¼Œå®ƒå°±å¦‚åŒæ‰¹å¤„ç†å‘½ä»¤ä¸€æ ·ï¼Œçœå»äº†éœ€è¦ä¾æ¬¡å»å•ä¸ªèŠ‚ç‚¹æ‰§è¡Œ DDL çš„çƒ¦æ¼ã€‚</strong></p>
<p><strong>å°†ä¸€æ¡æ™®é€šçš„ DDL è¯­å¥è½¬æ¢æˆåˆ†å¸ƒå¼æ‰§è¡Œååˆ†ç®€å•ï¼Œåªéœ€åŠ ä¸Š ON CLUSTER cluster_name å£°æ˜å³å¯ã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œä¸‹é¢çš„è¯­å¥åå°†ä¼šå¯¹ ch_cluster é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­è¿™æ¡ DDL è¯­å¥ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> partition_v4 <span class="keyword">ON</span> CLUSTER ch_cluster(</span><br><span class="line">    ID String,</span><br><span class="line">    URL String,</span><br><span class="line">    EventDate <span class="type">Date</span></span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ID</span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ï¼Œå¦‚æœç°åœ¨æ‰§è¡Œè¿™æ¡è¯­å¥æ˜¯ä¸ä¼šæˆåŠŸçš„ã€‚å› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢è¿˜æ²¡æœ‰é…ç½®è¿‡ ClickHouse çš„é›†ç¾¤æ¨¡å¼ï¼Œç›®å‰è¿˜ä¸å­˜åœ¨ä¸€ä¸ªåä¸º ch_cluster çš„é›†ç¾¤ï¼Œè¿™éƒ¨å†…å®¹ä¼šæ”¾åˆ°åç»­ç« èŠ‚å±•å¼€è¯´æ˜ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œå‡½æ•°(åäºŒ)</title>
    <url>/2023/04/11/ClickHouse%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0(%E5%8D%81%E4%BA%8C)/</url>
    <content><![CDATA[<h1 id="ClickHouse-å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œå‡½æ•°-åäºŒ"><a href="#ClickHouse-å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œå‡½æ•°-åäºŒ" class="headerlink" title="ClickHouse å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œå‡½æ•°(åäºŒ)"></a>ClickHouse å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œå‡½æ•°(åäºŒ)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>ä¸‹é¢æ¥è¯´ä¸€è¯´å­—ç¬¦ä¸²çš„ç›¸å…³æ“ä½œã€‚</strong></p>
<p><strong>emptyï¼šæ£€æµ‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¿”å› 1ï¼Œä¸ä¸ºç©ºè¿”å› 0</strong></p>
<p><strong>notEmptyï¼šæ£€æµ‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸ä¸ºç©ºè¿”å› 1ï¼Œä¸ºç©ºè¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">empty</span>(<span class="string">&#x27;&#x27;</span>), <span class="keyword">empty</span>(<span class="string">&#x27;satori&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€empty(&#x27;&#x27;)â”€â”¬â”€empty(&#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚         1 â”‚               0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> notEmpty(<span class="string">&#x27;&#x27;</span>), notEmpty(<span class="string">&#x27;satori&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€notEmpty(&#x27;&#x27;)â”€â”¬â”€notEmpty(&#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            0 â”‚                  1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>lengthï¼šè®¡ç®—ä¸€ä¸ªå­—ç¬¦ä¸²å å¤šå°‘ä¸ªå­—èŠ‚</strong></p>
<p><strong>char_lengthï¼šè®¡ç®—ä¸€ä¸ªå­—ç¬¦ä¸²å å¤šå°‘ä¸ªå­—ç¬¦</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="string">&#x27;satori&#x27;</span> <span class="keyword">AS</span> s1, <span class="string">&#x27;å¤æ˜åœ°è§‰&#x27;</span> <span class="keyword">AS</span> s2</span><br><span class="line"><span class="keyword">SELECT</span> length(s1), length(s2), <span class="keyword">char_length</span>(s1), <span class="keyword">char_length</span>(s2)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€length(s1)â”€â”¬â”€length(s2)â”€â”¬â”€CHAR_LENGTH(s1)â”€â”¬â”€CHAR_LENGTH(s2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚          6 â”‚         12 â”‚               6 â”‚               4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toStringï¼šå°†æ•´å‹ã€æ—¥æœŸè½¬æˆå­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> toString(<span class="number">3</span>), <span class="built_in">cast</span>(<span class="number">3</span> <span class="keyword">AS</span> String);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toString(3)â”€â”¬â”€CAST(3, &#x27;String&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 3           â”‚ 3                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é™¤äº†ä½¿ç”¨ cast ä¹‹å¤–ï¼Œæ¯ç§æ•°æ®ç±»å‹éƒ½å†…ç½®äº†ç›¸åº”çš„è½¬æ¢å‡½æ•°ï¼Œæ ¼å¼ä¸º to + ç±»å‹ï¼Œæ¯”å¦‚ toInt8ã€toUInt32ã€toFloat64ã€toDecimal64 ç­‰ç­‰</strong></p>
<p><strong>lowerã€lcaseï¼šå­—ç¬¦ä¸²è½¬å°å†™</strong></p>
<p><strong>upperã€ucaseï¼šå­—ç¬¦ä¸²è½¬å¤§å†™</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">lower</span>(<span class="string">&#x27;SAtoRI&#x27;</span>), <span class="built_in">upper</span>(<span class="string">&#x27;SAtoRI&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€lower(&#x27;SAtoRI&#x27;)â”€â”¬â”€upper(&#x27;SAtoRI&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori          â”‚ SATORI          â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>repeatï¼šå°†å­—ç¬¦ä¸²é‡å¤ n æ¬¡</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> repeat(<span class="string">&#x27;abc&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€repeat(&#x27;abc&#x27;, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ abcabcabc        â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>reverseï¼šå°†å­—ç¬¦ä¸²ç¿»è½¬</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> reverse(<span class="string">&#x27;satori&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€reverse(&#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ irotas            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šreverse æ˜¯æŒ‰ç…§å­—èŠ‚ç¿»è½¬çš„ï¼Œè¿™æ„å‘³ç€å®ƒä¸èƒ½ç”¨åœ¨ä¸­æ–‡ä¸Šé¢ï¼Œå¦‚æœæƒ³ç¿»è½¬ä¸­æ–‡ï¼Œé‚£ä¹ˆè¦ä½¿ç”¨ reverseUTF8ï¼Œå¯ä»¥è¯•ä¸€ä¸‹ã€‚</strong></p>
<p><strong>formatï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> format(<span class="string">&#x27;&#123;&#125;--&#123;&#125;&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€format(&#x27;&#123;&#125;--&#123;&#125;&#x27;, &#x27;hello&#x27;, &#x27;world&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello--world                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- &#123;&#125; çš„æ•°é‡å’Œæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²æ•°é‡è¦åŒ¹é…ï¼Œå½“ç„¶ä¸‹é¢è¿™ç§æƒ…å†µä¾‹å¤–</span></span><br><span class="line"><span class="keyword">SELECT</span> format(<span class="string">&#x27;&#123;0&#125;--&#123;1&#125;--&#123;0&#125;&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€format(&#x27;&#123;0&#125;--&#123;1&#125;--&#123;0&#125;&#x27;, &#x27;hello&#x27;, &#x27;world&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello--world--hello                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>concatï¼šæ‹¼æ¥å­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> concat(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€concat(&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ abc                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶æ‹¼æ¥å­—ç¬¦ä¸²è¿˜å¯ä»¥ä½¿ç”¨åŒç«–çº¿ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;a&#x27;</span> <span class="operator">||</span> <span class="string">&#x27;b&#x27;</span> <span class="operator">||</span> <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€concat(&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ abc                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>substringï¼šå­—ç¬¦ä¸²æˆªå–ï¼Œä¹Ÿå¯ä»¥å†™æˆ midã€substrï¼Œç”¨æ³•å’Œæ ‡å‡† SQL ä¸­çš„ substring ä¸€æ ·ï¼Œä½†æœ‰ä¸€ç‚¹åŒºåˆ«</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä»ç¬¬ 2 ä¸ªå…ƒç´ å¼€å§‹æˆªå–ï¼Œæˆªå– 3 ä¸ªå­—èŠ‚ï¼Œæ³¨æ„ï¼šåŒºåˆ«æ¥äº†ï¼Œæˆªå–çš„æ˜¯å­—èŠ‚</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(<span class="string">&#x27;abcdefg&#x27;</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€substring(&#x27;abcdefg&#x27;, 2, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ bcd                        â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦‚æœæƒ³æŒ‰ç…§å­—ç¬¦æˆªå–ï¼Œè¦ä½¿ç”¨ substringUTF8</span></span><br></pre></td></tr></table></figure>

<p><strong>appendTrailingCharIfAbsentï¼šå¦‚æœéç©ºå­—ç¬¦ä¸² s çš„æœ«å°¾ä¸åŒ…å«å­—ç¬¦ cï¼Œé‚£ä¹ˆå°±åœ¨ s çš„ç»“å°¾å¡«ä¸Šå­—ç¬¦ c</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> appendTrailingCharIfAbsent(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;i&#x27;</span>), </span><br><span class="line">       appendTrailingCharIfAbsent(<span class="string">&#x27;sator&#x27;</span>, <span class="string">&#x27;i&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€appendTrailingCharIfAbsent(&#x27;satori&#x27;, &#x27;i&#x27;)â”€â”¬â”€appendTrailingCharIfAbsent(&#x27;sator&#x27;, &#x27;i&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori                                    â”‚ satori                                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>convertCharsetï¼šæ”¹å˜å­—ç¬¦ä¸²çš„å­—ç¬¦é›†</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> convertCharset(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€convertCharset(&#x27;satori&#x27;, &#x27;ascii&#x27;, &#x27;utf8&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>base64Encodeï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œ base64 ç¼–ç </strong></p>
<p><strong>base64Decodeï¼šå¯¹ base64 ç¼–ç çš„å­—ç¬¦ä¸²è¿›è¡Œ base64 è§£ç </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> base64Encode(<span class="string">&#x27;satori&#x27;</span>) s1, base64Decode(s1);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€s1â”€â”€â”€â”€â”€â”€â”€â”¬â”€base64Decode(base64Encode(&#x27;satori&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ c2F0b3Jp â”‚ satori                               â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿˜æœ‰ä¸€ä¸ª tryBase64Decodeï¼Œå’Œ base64Decode ç±»ä¼¼ï¼Œä½†è§£æå¤±è´¥æ—¶ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚å¦‚æœæ˜¯ base64Decodeï¼Œé‚£ä¹ˆå¯¹ä¸€ä¸ªé base64 ç¼–ç çš„å­—ç¬¦ä¸²è§£æä¼šå¾—åˆ°ä¹±ç ã€‚</strong></p>
<p><strong>startsWithã€endsWithï¼šåˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŸä¸ªå­ä¸²å¼€å¤´æˆ–ç»“å°¾ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å› 1ï¼›å¦åˆ™ï¼Œè¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> startsWith(<span class="string">&#x27;å¤æ˜åœ°è§‰&#x27;</span>, <span class="string">&#x27;å¤æ˜&#x27;</span>) v1, endsWith(<span class="string">&#x27;å¤æ˜åœ°è§‰&#x27;</span>, <span class="string">&#x27;å¤æ˜&#x27;</span>) v2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€v1â”€â”¬â”€v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚  1 â”‚  0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>trimï¼šå»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„å­—ç¬¦</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">trim</span>(<span class="string">&#x27;   satori    &#x27;</span>) s, length(s);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€sâ”€â”€â”€â”€â”€â”€â”¬â”€length(trimBoth(&#x27;   satori    &#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ satori â”‚                                 6 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é»˜è®¤å»é™¤ç©ºæ ¼ï¼Œä¹Ÿå¯ä»¥å»é™¤å…¶å®ƒå­—ç¬¦</span></span><br><span class="line"><span class="comment">-- ä½†æ­¤æ—¶å¿…é¡»æŒ‡å®šæ˜¯ä» &quot;å·¦è¾¹&quot; å»é™¤ï¼Œè¿˜æ˜¯ä» &quot;å³è¾¹&quot; å»é™¤ï¼Œè¿˜æ˜¯ &quot;ä¸¤ç«¯&quot; éƒ½å»é™¤</span></span><br><span class="line"><span class="comment">-- å·¦è¾¹æ˜¯ LEADINGï¼Œå³è¾¹æ˜¯ TRAILINGï¼Œä¸¤ç«¯æ˜¯ BOTH</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">trim</span>(<span class="keyword">BOTH</span> <span class="string">&#x27;ab&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;abxxxxxxbaaa&#x27;</span>) s1,</span><br><span class="line">       <span class="built_in">trim</span>(<span class="keyword">LEADING</span> <span class="string">&#x27;ab&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;abxxxxxxbaaa&#x27;</span>) s2,</span><br><span class="line">       <span class="built_in">trim</span>(<span class="keyword">TRAILING</span> <span class="string">&#x27;ab&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;abxxxxxxbaaa&#x27;</span>) s3;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€s1â”€â”€â”€â”€â”€â”¬â”€s2â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€s3â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ xxxxxx â”‚ xxxxxxbaaa â”‚ abxxxxxx â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>trim å¦‚æœåªæ¥æ”¶ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆé»˜è®¤è¡Œä¸ºå°±æ˜¯åˆ é™¤ä¸¤ç«¯çš„ç©ºæ ¼ï¼Œæ‰€ä»¥è¿˜æœ‰ trimLeftã€trimRightï¼Œä¹Ÿæ˜¯æ¥æ”¶ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ä¸²ï¼Œç„¶åå»é™¤å·¦è¾¹ã€å³è¾¹çš„ç©ºæ ¼ã€‚å…¶ä¸­ trimLeft ä¹Ÿå¯ä»¥å†™ä½œ ltrimï¼ŒtrimRight ä¹Ÿå¯ä»¥å†™ä½œ rtrimã€‚</strong></p>
<p><strong>CRC32ï¼šè¿”å›å­—ç¬¦ä¸²çš„ CRC32 æ ¡éªŒå’Œï¼Œä½¿ç”¨ CRC-32-IEEE 802.3 å¤šé¡¹å¼ï¼Œå¹¶ä¸”åˆå§‹å€¼ä¸º 0xFFFFFFFF</strong></p>
<p><strong>CRC32IEEEï¼šè¿”å›å­—ç¬¦ä¸²çš„ CRC32 æ ¡éªŒå’Œï¼Œä½¿ç”¨ CRC-32-IEEE 802.3 å¤šé¡¹å¼</strong></p>
<p><strong>CRC64ï¼šè¿”å›å­—ç¬¦ä¸²çš„ CRC64 æ ¡éªŒå’Œï¼Œä½¿ç”¨ CRC-64-ECMA å¤šé¡¹å¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CRC32(<span class="string">&#x27;satori&#x27;</span>), CRC32IEEE(<span class="string">&#x27;satori&#x27;</span>), CRC64(<span class="string">&#x27;satori&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€CRC32(&#x27;satori&#x27;)â”€â”¬â”€CRC32IEEE(&#x27;satori&#x27;)â”€â”¬â”€â”€â”€â”€â”€CRC64(&#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       379058543 â”‚          2807388364 â”‚ 1445885890712067336 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>encodeXMLComponentï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œè½¬ä¹‰ï¼Œé’ˆå¯¹ &lt;ã€&amp;ã€&gt;ã€â€ã€â€™ äº”ç§ç¬¦å·</strong></p>
<p><strong>decodeXMLComponentï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œåè½¬ä¹‰ï¼Œé’ˆå¯¹ &lt;ã€&amp;ã€&gt;ã€â€ã€â€™ äº”ç§ç¬¦å·</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> encodeXMLComponent(<span class="string">&#x27;&lt;name&gt;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€encodeXMLComponent(&#x27;&lt;name&gt;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &amp;lt;name&amp;gt;                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> decodeXMLComponent(<span class="string">&#x27;&amp;lt;name&amp;gt;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€decodeXMLComponent(&#x27;&amp;lt;name&amp;gt;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &lt;name&gt;                             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>positionï¼šæŸ¥æ‰¾æŸä¸ªå­ä¸²åœ¨å­—ç¬¦ä¸²å½“ä¸­çš„ä½ç½®</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">position</span>(<span class="string">&#x27;abcdefg&#x27;</span>, <span class="string">&#x27;de&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€position(&#x27;abcdefg&#x27;, &#x27;de&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                         4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¹Ÿå¯ä»¥ä»æŒ‡å®šä½ç½®æŸ¥æ‰¾</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">position</span>(<span class="string">&#x27;hello world&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="number">1</span>), <span class="built_in">position</span>(<span class="string">&#x27;hello world&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€position(&#x27;hello world&#x27;, &#x27;o&#x27;, 1)â”€â”¬â”€position(&#x27;hello world&#x27;, &#x27;o&#x27;, 7)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                               5 â”‚                               8 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>è¯¥å‡½æ•°æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¦‚æœæƒ³å¤§å°å†™ä¸æ•æ„Ÿï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ positionCaseInsensitiveã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œè¯¥å‡½æ•°æ˜¯æŒ‰ç…§å­—èŠ‚ç»Ÿè®¡çš„ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">position(&#x27;å¤æ˜åœ°è§‰A&#x27;, &#x27;A&#x27;) å¾—åˆ°çš„æ˜¯ 13ï¼Œå› ä¸ºä¸€ä¸ªæ±‰å­— 3 å­—èŠ‚</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœåŒ…å«ä¸­æ–‡ï¼Œæƒ³æŒ‰ç…§å­—ç¬¦ç»Ÿè®¡ï¼Œåˆ™éœ€è¦ä½¿ç”¨ positionUTF8ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">positionUTF8(&#x27;å¤æ˜åœ°è§‰A&#x27;, &#x27;A&#x27;) å¾—åˆ°çš„å°±æ˜¯ 5</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å› 0</strong></p>
<p><strong>multiSearchAllPositionsï¼šæŸ¥æ‰¾å¤šä¸ªå­ä¸²åœ¨å­—ç¬¦ä¸²å½“ä¸­çš„ä½ç½®ï¼Œå¤šä¸ªå­ä¸²ç»„æˆæ•°ç»„è¿›è¡Œä¼ é€’</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> multiSearchAllPositions(<span class="string">&#x27;satori&#x27;</span>, [<span class="string">&#x27;sa&#x27;</span>, <span class="string">&#x27;to&#x27;</span>, <span class="string">&#x27;ri&#x27;</span>, <span class="string">&#x27;xxx&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiSearchAllPositions(&#x27;satori&#x27;, [&#x27;sa&#x27;, &#x27;to&#x27;, &#x27;ri&#x27;, &#x27;xxx&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,3,5,0]                                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³å¤§å°å†™ä¸æ•æ„Ÿï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ multiSearchAllPositionsCaseInsensitiveã€‚åŒæ ·çš„ï¼Œè¯¥å‡½æ•°ä¹Ÿæ˜¯åœ¨å­—èŠ‚åºåˆ—ä¸Šè¿›è¡Œæœç´¢ï¼Œä¸è€ƒè™‘å­—ç¬¦ç¼–ç ï¼Œå¦‚æœæƒ³æ”¯æŒé ASCII å­—ç¬¦ï¼Œåº”è¯¥ä½¿ç”¨ multiSearchAllPositionsUTF8ã€‚</strong></p>
<p><strong>matchï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå¦‚æœç»™å®šçš„å­—ç¬¦ä¸²åŒ¹é…ç»™å®šçš„è¡¨è¾¾å¼ï¼Œåˆ™è¿”å› 1ï¼›ä¸åŒ¹é…ï¼Œåˆ™è¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å­—ç¬¦ä¸²æ”¾å·¦è¾¹ï¼Œæ¨¡å¼æ–¹å³è¾¹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">match</span>(<span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;\\d&#123;1,3&#125;&#x27;</span>), <span class="keyword">match</span>(<span class="string">&#x27;abcd&#x27;</span>, <span class="string">&#x27;\\d&#123;1,3&#125;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€match(&#x27;123&#x27;, &#x27;\\d&#123;1,3&#125;&#x27;)â”€â”¬â”€match(&#x27;abcd&#x27;, &#x27;\\d&#123;1,3&#125;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                        1 â”‚                         0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çŸ¥é“åæ–œæ æœ¬èº«ä»£è¡¨è½¬ä¹‰ï¼Œé‚£ä¹ˆå¦‚æœæƒ³è¡¨è¾¾ \dï¼Œåº”è¯¥ä½¿ç”¨ \dã€‚åŒç†å¦‚æœæˆ‘ä»¬æƒ³æ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«åæ–œæ ï¼Œé‚£ä¹ˆåº”è¯¥è¿™ä¹ˆåšï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT match(s, &#x27;\\\\&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>å› ä¸ºåæ–œæ å…·æœ‰è½¬ä¹‰ï¼Œé‚£ä¹ˆå››ä¸ªåæ–œæ ä¼šå˜æˆä¸¤ä¸ªæ™®é€šçš„åæ–œæ ï¼Œä½†æˆ‘ä»¬çŸ¥é“åæ–œæ åœ¨æ­£åˆ™ä¸­ä¹Ÿå…·æœ‰å«ä¹‰ï¼Œæ‰€ä»¥ä¸¤ä¸ªåæ–œæ ä¼šå˜æˆä¸€ä¸ªæ™®é€šçš„åæ–œæ ã€‚</strong></p>
<p><strong>multiMatchAnyï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œä½†å¯ä»¥æ¥æ”¶å¤šä¸ªæ¨¡å¼ï¼Œæœ‰ä¸€ä¸ªèƒ½åŒ¹é…ä¸Šï¼Œåˆ™è¿”å› 1ï¼›å…¨éƒ½åŒ¹é…ä¸ä¸Šï¼Œåˆ™è¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">match</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>), <span class="keyword">match</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€match(&#x27;satori&#x27;, &#x27;xx&#x27;)â”€â”¬â”€match(&#x27;satori&#x27;, &#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                     0 â”‚                         1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> multiMatchAny(<span class="string">&#x27;satori&#x27;</span>, [<span class="string">&#x27;xx&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiMatchAny(&#x27;satori&#x27;, [&#x27;xx&#x27;, &#x27;satori&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                         1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>multiMatchAnyIndexï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ¥æ”¶å¤šä¸ªæ¨¡å¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ¨¡å¼çš„ç´¢å¼•</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ˜¾ç„¶ &#x27;satori&#x27; å¯ä»¥åŒ¹é…ä¸Šï¼Œè€Œå®ƒçš„ç´¢å¼•ä¸º 3</span></span><br><span class="line"><span class="keyword">SELECT</span> multiMatchAnyIndex(<span class="string">&#x27;satori&#x27;</span>, [<span class="string">&#x27;yy&#x27;</span>, <span class="string">&#x27;xx&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiMatchAnyIndex(&#x27;satori&#x27;, [&#x27;yy&#x27;, &#x27;xx&#x27;, &#x27;satori&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                                    3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæ²¡æœ‰ä¸€ä¸ªèƒ½åŒ¹é…ä¸Šåˆ™è¿”å› 0ï¼Œå› ä¸ºç´¢å¼•ä» 1 å¼€å§‹ï¼Œæ‰€ä»¥è¿”å› 0 ä»£è¡¨æ²¡æœ‰ä¸€ä¸ªåŒ¹é…ä¸Šã€‚åƒä¸€èˆ¬çš„ç¼–ç¨‹è¯­è¨€ï¼Œç”±äºç´¢å¼•ä» 0 å¼€å§‹ï¼Œé‚£ä¹ˆå½“åŒ¹é…ä¸ä¸Šçš„æ—¶å€™è¿”å›çš„å°±æ˜¯ -1ã€‚</strong></p>
<p><strong>multiMatchAllIndicesï¼šæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ¥æ”¶å¤šä¸ªæ¨¡å¼ï¼Œè¿”å›æ‰€æœ‰åŒ¹é…çš„æ¨¡å¼çš„ç´¢å¼•</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç´¢å¼•ä¸º 2ã€3 çš„æ¨¡å¼éƒ½èƒ½åŒ¹é…ä¸Šï¼Œä½†åªè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…ä¸Šçš„</span></span><br><span class="line"><span class="keyword">SELECT</span> multiMatchAnyIndex(<span class="string">&#x27;satori&#x27;</span>, [<span class="string">&#x27;yy&#x27;</span>, <span class="string">&#x27;sa&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiMatchAnyIndex(&#x27;satori&#x27;, [&#x27;yy&#x27;, &#x27;sa&#x27;, &#x27;satori&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                                    2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿”å›æ‰€æœ‰åŒ¹é…ä¸Šçš„</span></span><br><span class="line"><span class="keyword">SELECT</span> multiMatchAllIndices(<span class="string">&#x27;satori&#x27;</span>, [<span class="string">&#x27;yy&#x27;</span>, <span class="string">&#x27;sa&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€multiMatchAllIndices(&#x27;satori&#x27;, [&#x27;yy&#x27;, &#x27;sa&#x27;, &#x27;satori&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,3]                                                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>extractï¼šè¿”å›ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æˆ‘ä»¬çœ‹åˆ°åŒ¹é…ä½¿ç”¨çš„æ˜¯è´ªå©ªæ¨¡å¼</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">extract</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;\\w&#123;1,3&#125;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extract(&#x27;satori&#x27;, &#x27;\\w&#123;1,3&#125;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ sat                           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é‡‡ç”¨éè´ªå©ªæ¨¡å¼</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">extract</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;\\w&#123;1,3&#125;?&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extract(&#x27;satori&#x27;, &#x27;\\w&#123;1,3&#125;?&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ s                              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒ¹é…ä¸ä¸Šï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</strong></p>
<p><strong>extractAllï¼šextract åªè¿”å›ä¸€ä¸ªåŒ¹é…çš„å­—ç¬¦ä¸²ï¼ŒextractAll åˆ™è¿”å›æ‰€æœ‰çš„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">extract</span>(<span class="string">&#x27;abc abd abe&#x27;</span>, <span class="string">&#x27;ab.&#x27;</span>), extractAll(<span class="string">&#x27;abc abd abe&#x27;</span>, <span class="string">&#x27;ab.&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extract(&#x27;abc abd abe&#x27;, &#x27;ab.&#x27;)â”€â”¬â”€extractAll(&#x27;abc abd abe&#x27;, &#x27;ab.&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ abc                           â”‚ [&#x27;abc&#x27;,&#x27;abd&#x27;,&#x27;abe&#x27;]              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>extractAllGroupsHorizontalã€extractAllGroupsVerticalï¼šåŒ¹é…ç»„ï¼Œä¸¾ä¾‹è¯´æ˜æœ€ç›´æ¥</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> extractAllGroupsHorizontal(<span class="string">&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;</span>, </span><br><span class="line">                                  <span class="string">&#x27;(\\d&#123;4&#125;)-(\\d&#123;2&#125;)-(\\d&#123;2&#125;)&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extractAllGroupsHorizontal(&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;, &#x27;(\\d&#123;4&#125;)-(\\d&#123;2&#125;)-(\\d&#123;2&#125;)&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [[&#x27;2020&#x27;,&#x27;2020&#x27;,&#x27;2020&#x27;],[&#x27;01&#x27;,&#x27;02&#x27;,&#x27;11&#x27;],[&#x27;05&#x27;,&#x27;21&#x27;,&#x27;13&#x27;]]                                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> extractAllGroupsVertical(<span class="string">&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;</span>, </span><br><span class="line">                                <span class="string">&#x27;(\\d&#123;4&#125;)-(\\d&#123;2&#125;)-(\\d&#123;2&#125;)&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extractAllGroupsVertical(&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;, &#x27;(\\d&#123;4&#125;)-(\\d&#123;2&#125;)-(\\d&#123;2&#125;)&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [[&#x27;2020&#x27;,&#x27;01&#x27;,&#x27;05&#x27;],[&#x27;2020&#x27;,&#x27;02&#x27;,&#x27;21&#x27;],[&#x27;2020&#x27;,&#x27;11&#x27;,&#x27;13&#x27;]]                                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ClickHouse åœ¨åŒ¹é…ç»„çš„æ—¶å€™ä¹Ÿç»™äº†ä¸¤ç§é€‰æ‹©ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ç¼–ç¨‹è¯­è¨€è¿›è¡Œç»„åŒ¹é…çš„æ—¶å€™ï¼Œä¸€èˆ¬è¿”å›éƒ½æ˜¯ç¬¬äºŒç§ã€‚è€Œä¸”äº‹å®ä¸Šï¼ŒextractAllGroupsVertical çš„é€Ÿåº¦æ¯” extractAllGroupsHorizontal è¦å¿«ä¸€äº›ã€‚</strong></p>
<p><strong>å½“åŒ¹é…ä¸ä¸Šçš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯ç©ºåˆ—è¡¨ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> extractAllGroupsHorizontal(<span class="string">&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;</span>, </span><br><span class="line">                                  <span class="string">&#x27;(\\d&#123;10&#125;)-(\\d&#123;20&#125;)-(\\d&#123;20&#125;)&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extractAllGroupsHorizontal(&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;, &#x27;(\\d&#123;10&#125;)-(\\d&#123;20&#125;)-(\\d&#123;20&#125;)&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [[],[],[]]                                                                                      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> extractAllGroupsVertical (<span class="string">&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;</span>, </span><br><span class="line">                                 <span class="string">&#x27;(\\d&#123;10&#125;)-(\\d&#123;20&#125;)-(\\d&#123;20&#125;)&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€extractAllGroupsVertical(&#x27;2020-01-05 2020-02-21 2020-11-13&#x27;, &#x27;(\\d&#123;10&#125;)-(\\d&#123;20&#125;)-(\\d&#123;20&#125;)&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ []                                                                                            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>extractAllGroupsHorizontal ç›¸å½“äºæŠŠå¤šä¸ªç»„ä¸­æŒ‰ç…§é¡ºåºåˆå¹¶äº†ï¼Œæ‰€ä»¥åˆ—è¡¨é‡Œé¢æ˜¯ 3 ä¸ªç©ºåˆ—è¡¨ï¼Œå› ä¸ºæˆ‘ä»¬åŒ¹é…çš„ç»„æœ‰ä¸‰ä¸ªã€‚</strong></p>
<p><strong>likeï¼šwhere è¯­å¥é‡Œé¢æœ‰ LIKEï¼Œä½† like ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸¤è€…è§„åˆ™æ˜¯ä¸€æ ·çš„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- % è¡¨ç¤ºä»»æ„æ•°é‡çš„ä»»æ„å­—ç¬¦ï¼›_ è¡¨ç¤ºå•ä¸ªä»»æ„å­—ç¬¦</span></span><br><span class="line"><span class="comment">-- \ è¡¨ç¤ºè½¬ä¹‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">like</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;sa%&#x27;</span>), <span class="keyword">like</span>(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;sa_&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>é™¤äº† like ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª notLikeï¼Œä»¥åŠä¸åŒºåˆ†å¤§å°å†™çš„ ilikeã€‚</strong></p>
<p><strong>ngramDistanceï¼šè®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ï¼Œå–å€¼ä¸º 0 åˆ° 1ï¼Œè¶Šç›¸ä¼¼è¶Šæ¥è¿‘ 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ngramDistance(<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;satori&#x27;</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€ngramDistance(&#x27;satori&#x27;, &#x27;satori&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                 0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šå¦‚æœæŸä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦è¶…è¿‡äº† 32 KBï¼Œé‚£ä¹ˆç»“æœç›´æ¥ä¸º 1ï¼Œå°±ä¸å†è®¡ç®—ç›¸ä¼¼åº¦äº†ã€‚è¯¥å‡½æ•°åœ¨è®¡ç®—å­—ç¬¦ä¸²ç›¸ä¼¼åº¦çš„æ—¶å€™æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¦‚æœæƒ³è¦å¿½ç•¥å¤§å°å†™ï¼Œå¯ä»¥ä½¿ç”¨ ngramDistanceCaseInsensitiveã€‚åŒç†å¦‚æœé’ˆå¯¹ä¸­æ–‡ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ ngramDistanceUTF8ï¼Œä»¥åŠ ngramDistanceCaseInsensitiveUTF8ã€‚</strong></p>
<p><strong>countSubstringsï¼šè®¡ç®—å­—ç¬¦ä¸²ä¸­æŸä¸ªå­—ä¸²å‡ºç°çš„æ¬¡æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> countSubstrings(<span class="string">&#x27;aaaa&#x27;</span>, <span class="string">&#x27;aa&#x27;</span>), countSubstrings(<span class="string">&#x27;abc_abc&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€countSubstrings(&#x27;aaaa&#x27;, &#x27;aa&#x27;)â”€â”¬â”€countSubstrings(&#x27;abc_abc&#x27;, &#x27;abc&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                             2 â”‚                                 2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»æŒ‡å®šä½ç½®å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line"><span class="keyword">SELECT</span> countSubstrings(<span class="string">&#x27;aabbaa&#x27;</span>, <span class="string">&#x27;aa&#x27;</span>), countSubstrings(<span class="string">&#x27;aabbaa&#x27;</span>, <span class="string">&#x27;aa&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€countSubstrings(&#x27;aabbaa&#x27;, &#x27;aa&#x27;)â”€â”¬â”€countSubstrings(&#x27;aabbaa&#x27;, &#x27;aa&#x27;, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                               2 â”‚                                  1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœå¸Œæœ›å¤§å°å†™æ•æ„Ÿï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ countSubstringsCaseInsensitiveï¼Œé’ˆå¯¹ä¸­æ–‡å¯ä»¥ä½¿ç”¨ countSubstringsCaseInsensitiveUTF8ã€‚</strong></p>
<p><strong>countMatchesï¼šè®¡ç®—å­—ç¬¦ä¸²ä¸­æŸä¸ªæ¨¡å¼åŒ¹é…çš„æ¬¡æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> countSubstrings(<span class="string">&#x27;aaabbaa&#x27;</span>, <span class="string">&#x27;aa&#x27;</span>), countMatches(<span class="string">&#x27;aaabbaa&#x27;</span>, <span class="string">&#x27;a.&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€countSubstrings(&#x27;aaabbaa&#x27;, &#x27;aa&#x27;)â”€â”¬â”€countMatches(&#x27;aaabbaa&#x27;, &#x27;a.&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                2 â”‚                             3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>replaceOneï¼šå¯¹å­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„éƒ¨åˆ†è¿›è¡Œæ›¿æ¢ï¼Œä½†åªä¼šæ›¿æ¢ç¬¬ä¸€æ¬¡å‡ºç°çš„éƒ¨åˆ†</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> replaceOne(<span class="string">&#x27;hello cruel world, cruel&#x27;</span>, <span class="string">&#x27;cruel&#x27;</span>, <span class="string">&#x27;beautiful&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€replaceOne(&#x27;hello cruel world, cruel&#x27;, &#x27;cruel&#x27;, &#x27;beautiful&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello beautiful world, cruel                                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³å…¨éƒ¨æ›¿æ¢ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ replaceAllï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> replaceAll(<span class="string">&#x27;hello cruel world, cruel&#x27;</span>, <span class="string">&#x27;cruel&#x27;</span>, <span class="string">&#x27;beautiful&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€replaceAll(&#x27;hello cruel world, cruel&#x27;, &#x27;cruel&#x27;, &#x27;beautiful&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello beautiful world, beautiful                             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>replaceRegexpOneï¼šå¯¹å­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„éƒ¨åˆ†è¿›è¡Œæ›¿æ¢ï¼Œä½†æ”¯æŒæ­£åˆ™</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> replaceRegexpOne(<span class="string">&#x27;hello cruel world, cruel&#x27;</span>, <span class="string">&#x27;cru..&#x27;</span>, <span class="string">&#x27;beautiful&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€replaceRegexpOne(&#x27;hello cruel world, cruel&#x27;, &#x27;cru..&#x27;, &#x27;beautiful&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello beautiful world, cruel                                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³å…¨éƒ¨æ›¿æ¢ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ replaceRegexpAllï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> replaceRegexpAll(<span class="string">&#x27;hello cruel world, cruel&#x27;</span>, <span class="string">&#x27;cru..&#x27;</span>, <span class="string">&#x27;beautiful&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€replaceRegexpAll(&#x27;hello cruel world, cruel&#x27;, &#x27;cru..&#x27;, &#x27;beautiful&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ hello beautiful world, beautiful                                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


<p><strong>splitByCharï¼šå°†å­—ç¬¦ä¸²æŒ‰ç…§æŒ‡å®šå­—ç¬¦è¿›è¡Œåˆ†è§£ï¼Œè¿”å›æ•°ç»„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ†éš”ç¬¦å¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦</span></span><br><span class="line"><span class="keyword">SELECT</span> splitByChar(<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;ABC_def_fgh&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€splitByChar(&#x27;_&#x27;, &#x27;ABC_def_fgh&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;ABC&#x27;,&#x27;def&#x27;,&#x27;fgh&#x27;]             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>splitByStringï¼šå°†å­—ç¬¦ä¸²æŒ‰ç…§æŒ‡å®šå­—ç¬¦ï¼ˆä¸²ï¼‰è¿›è¡Œåˆ†è§£ï¼Œè¿”å›æ•°ç»„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ†éš”ç¬¦å¿…é¡»æ˜¯å•ä¸ªå­—ç¬¦</span></span><br><span class="line"><span class="keyword">SELECT</span> splitByString(<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;ABC_def_fgh&#x27;</span>), splitByString(<span class="string">&#x27;__&#x27;</span>, <span class="string">&#x27;ABC__def__fgh&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€splitByString(&#x27;_&#x27;, &#x27;ABC_def_fgh&#x27;)â”€â”¬â”€splitByString(&#x27;__&#x27;, &#x27;ABC__def__fgh&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;ABC&#x27;,&#x27;def&#x27;,&#x27;fgh&#x27;]               â”‚ [&#x27;ABC&#x27;,&#x27;def&#x27;,&#x27;fgh&#x27;]                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º splitByString å®Œå…¨å¯ä»¥å–ä»£ splitByCharï¼Œå› ä¸ºå®ƒæ—¢å¯ä»¥æŒ‰ç…§å•ä¸ªå­—ç¬¦åˆ†è§£ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§å­—ç¬¦ä¸²åˆ†è§£ï¼Œå½“ç„¶å•ä¸ªå­—ç¬¦åœ¨ ClickHouse é‡Œé¢ä¹Ÿæ˜¯å­—ç¬¦ä¸²ã€‚ä½† ClickHouse æ—¢ç„¶æä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆä¸ªäººå»ºè®®ï¼Œå¦‚æœæ˜¯æŒ‰ç…§å•ä¸ªå­—ç¬¦åˆ†è§£çš„è¯ï¼Œè¿˜æ˜¯ä½¿ç”¨ splitByCharã€‚</strong></p>
<p><strong>splitByRegexpï¼šå°†å­—ç¬¦ä¸²æŒ‰ç…§æ­£åˆ™çš„æ¨¡å¼è¿›è¡Œåˆ†è§£ï¼Œè¿”å›æ•°ç»„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> splitByRegexp(<span class="string">&#x27;\\d+&#x27;</span>, <span class="string">&#x27;a12bc23de345f&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€splitByRegexp(&#x27;\\d+&#x27;, &#x27;a12bc23de345f&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;a&#x27;,&#x27;bc&#x27;,&#x27;de&#x27;,&#x27;f&#x27;]                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayStringConcatï¼šå°†æ•°ç»„ä¸­çš„å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayStringConcat([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>], <span class="string">&#x27;--&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayStringConcat([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;], &#x27;--&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ a--b--c--d                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>å­—ç¬¦ä¸²ç®—æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒçš„æ“ä½œè‡ªç„¶ä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†éƒ½ä¸æ˜¯å¾ˆéš¾ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„ Map ç±»å‹ä»¥åŠç›¸å…³æ“ä½œ(åå››)</title>
    <url>/2023/04/11/ClickHouse%20%E7%9A%84%20Map%20%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C(%E5%8D%81%E5%9B%9B)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„-Map-ç±»å‹ä»¥åŠç›¸å…³æ“ä½œ-åå››"><a href="#ClickHouse-çš„-Map-ç±»å‹ä»¥åŠç›¸å…³æ“ä½œ-åå››" class="headerlink" title="ClickHouse çš„ Map ç±»å‹ä»¥åŠç›¸å…³æ“ä½œ(åå››)"></a>ClickHouse çš„ Map ç±»å‹ä»¥åŠç›¸å…³æ“ä½œ(åå››)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>ä¹‹å‰åœ¨ä»‹ç»æ•°æ®ç±»å‹çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§æ²¡æœ‰è¯´ï¼Œå°±æ˜¯ Mapã€‚Map æ˜¯ä»€ä¹ˆæƒ³å¿…æ— éœ€å¤šè¨€ï¼Œç®€å•æ¥è¯´çš„è¯å°±æ˜¯ç»´æŠ¤é”®å€¼å¯¹ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡é”®è¿…é€Ÿå®šä½åˆ°å€¼ã€‚</strong></p>
<p><strong>ä¸‹é¢å°±å…ˆæ¥åˆ›å»ºä¸€å¼ è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨å®šä¹‰ Map çš„æ—¶å€™ï¼Œå¿…é¡»è¦æŒ‡å®šé”®å€¼å¯¹çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_map(a Map(String, UInt64)) ENGINE <span class="operator">=</span> Memory();</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯ä¸å‡ºæ„å¤–æˆ‘ä»¬åˆ›å»ºè¡¨çš„æ—¶å€™åº”è¯¥ä¼šæŠ¥é”™ï¼ŒåŸå› å°±æ˜¯åœ¨è¡¨ä¸­æ”¯æŒå®šä¹‰ Map ç±»å‹çš„å­—æ®µè¿˜åªæ˜¯è¯•éªŒæ€§çš„ï¼Œæˆ‘ä»¬éœ€è¦å°† allow_experimental_map_type è®¾ç½®ä¸º 1ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å•ç‹¬æ‹¿å‡ºæ¥ä»‹ç»çš„åŸå› ã€‚ç„¶åæˆ‘ä»¬æ’å…¥æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> allow_experimental_map_type <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_map(a Map(String, UInt64)) ENGINE <span class="operator">=</span> Memory();</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_map </span><br><span class="line"><span class="keyword">VALUES</span> (&#123;<span class="string">&#x27;key1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;key2&#x27;</span>: <span class="number">10</span>&#125;), (&#123;<span class="string">&#x27;key1&#x27;</span>:<span class="number">2</span>,<span class="string">&#x27;key2&#x27;</span>:<span class="number">20</span>&#125;), (&#123;<span class="string">&#x27;key1&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;key2&#x27;</span>:<span class="number">30</span>&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢æ¥å¯¹è¡¨è¿›è¡ŒæŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:1,&#x27;key2&#x27;:10&#125; â”‚</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:2,&#x27;key2&#x27;:20&#125; â”‚</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:3,&#x27;key2&#x27;:30&#125; â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³é€‰æ‹©æŸä¸ªå…·ä½“çš„é”®å¯¹åº”çš„ valueï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡æ–¹æ‹¬å·å³å¯ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a[<span class="string">&#x27;key1&#x27;</span>], a[<span class="string">&#x27;key2&#x27;</span>], a <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(a, &#x27;key1&#x27;)â”€â”¬â”€arrayElement(a, &#x27;key2&#x27;)â”€â”¬â”€aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚                       1 â”‚                      10 â”‚ &#123;&#x27;key1&#x27;:1,&#x27;key2&#x27;:10&#125; â”‚</span></span><br><span class="line"><span class="comment">â”‚                       2 â”‚                      20 â”‚ &#123;&#x27;key1&#x27;:2,&#x27;key2&#x27;:20&#125; â”‚</span></span><br><span class="line"><span class="comment">â”‚                       3 â”‚                      30 â”‚ &#123;&#x27;key1&#x27;:3,&#x27;key2&#x27;:30&#125; â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæŸ¥è¯¢ä¸€ä¸ªä¸åœ¨ Map å½“ä¸­ keyï¼Œé‚£ä¹ˆä¼šè¿”å›å¯¹åº”çš„é›¶å€¼ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a[<span class="string">&#x27;key3&#x27;</span>] <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(a, &#x27;key3&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                       0 â”‚</span></span><br><span class="line"><span class="comment">â”‚                       0 â”‚</span></span><br><span class="line"><span class="comment">â”‚                       0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®ç°æœ‰çš„æ•°ç»„ç»“æ„åˆ›å»º Mapï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="keyword">AS</span> key, [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>] <span class="keyword">AS</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">cast</span>((key, <span class="keyword">value</span>) <span class="keyword">AS</span> Map(UInt8, String));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€CAST(tuple(key, value), &#x27;Map(UInt8, String)&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &#123;1:&#x27;a&#x27;,2:&#x27;b&#x27;,3:&#x27;c&#x27;&#125;                           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- ä»è¿”å›çš„ç»“æœé›†çš„å­—æ®µåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œcast(val AS type) ç­‰ä»·äº cast(val, &#x27;type&#x27;)</span></span><br><span class="line"><span class="comment">-- æ¯”å¦‚ cast(3 AS String) å’Œ cast(3, &#x27;String&#x27;) æ˜¯ç­‰ä»·çš„ï¼Œä¸è¿‡ä¸ªäººè¿˜æ˜¯ä¹ æƒ¯å‰è€…</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬åœ¨é€‰æ‹©çš„æ—¶å€™ä¹Ÿå¯ä»¥åªé€‰æ‹© key æˆ–è€… valueã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.keys, a.values <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€a.keysâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€a.valuesâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [1,10]   â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [2,20]   â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [3,30]   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å­—å…¸éƒ½æ”¯æŒå“ªäº›å‡½æ•°æ“ä½œ"><a href="#ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å­—å…¸éƒ½æ”¯æŒå“ªäº›å‡½æ•°æ“ä½œ" class="headerlink" title="ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å­—å…¸éƒ½æ”¯æŒå“ªäº›å‡½æ•°æ“ä½œ"></a>ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å­—å…¸éƒ½æ”¯æŒå“ªäº›å‡½æ•°æ“ä½œ</h3><p><strong>mapï¼šæˆ‘ä»¬é™¤äº†å¯ä»¥é€šè¿‡å¤§æ‹¬å·åˆ›å»º Mapï¼Œä¹Ÿå¯ä»¥é€šè¿‡ map å‡½æ•°åˆ›å»º</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> map(<span class="string">&#x27;key1&#x27;</span>, number, <span class="string">&#x27;key2&#x27;</span>, number <span class="operator">*</span> <span class="number">2</span>) <span class="keyword">FROM</span> numbers(<span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€map(&#x27;key1&#x27;, number, &#x27;key2&#x27;, multiply(number, 2))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:0,&#x27;key2&#x27;:0&#125;                              â”‚</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:1,&#x27;key2&#x27;:2&#125;                              â”‚</span></span><br><span class="line"><span class="comment">â”‚ &#123;&#x27;key1&#x27;:2,&#x27;key2&#x27;:4&#125;                              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- æ³¨æ„ï¼šSELECT &#123;&#x27;key1&#x27;: number, &#x27;key2&#x27;: number * 2&#125; æ˜¯éæ³•çš„ï¼Œå¿…é¡»ä½¿ç”¨ map å‡½æ•°åˆ›å»º</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒç†æˆ‘ä»¬æ’å…¥æ•°æ®çš„æ—¶å€™ä¹Ÿå¯ä»¥ä½¿ç”¨ map å‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_map <span class="keyword">VALUES</span> (map(<span class="string">&#x27;key1&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;key2&#x27;</span>, <span class="number">10</span>));</span><br><span class="line"><span class="keyword">SELECT</span> a.keys, a.values <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€a.keysâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€a.valuesâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [1,10]   â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [2,20]   â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [3,30]   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">â”Œâ”€a.keysâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€a.valuesâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [1,10]   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>mapContainsï¼šæ£€æµ‹ Map é‡Œé¢æ˜¯å¦åŒ…å«æŸä¸ª key</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> map(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">5</span>) <span class="keyword">AS</span> m</span><br><span class="line"><span class="keyword">SELECT</span> mapContains(m, <span class="number">1</span>), mapContains(m, <span class="number">3</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€mapContains(m, 1)â”€â”¬â”€mapContains(m, 3)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                 1 â”‚                 0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>mapKeysï¼šç­‰ä»·äº Map.keys</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.keys, mapKeys(a) <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€a.keysâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€mapKeys(a)â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">â”Œâ”€a.keysâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€mapKeys(a)â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚ [&#x27;key1&#x27;,&#x27;key2&#x27;] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>mapValuesï¼šç­‰ä»·äº Map.values</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.values, mapValues(a) <span class="keyword">FROM</span> table_map;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€a.valuesâ”€â”¬â”€mapValues(a)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,10]   â”‚ [1,10]       â”‚</span></span><br><span class="line"><span class="comment">â”‚ [2,20]   â”‚ [2,20]       â”‚</span></span><br><span class="line"><span class="comment">â”‚ [3,30]   â”‚ [3,30]       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">â”Œâ”€a.valuesâ”€â”¬â”€mapValues(a)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,10]   â”‚ [1,10]       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šmapKeysã€mapValues ç›¸å½“äºæ•°æ®å…¨é‡è¯»å–ï¼Œç„¶åå†é€‰æ‹©æ‰€æœ‰çš„ key æˆ– valueï¼Œæ‰€ä»¥å»ºè®®è¿˜æ˜¯ä½¿ç”¨ Map.keysã€Map.valuesã€‚ä½†å¦‚æœå°† optimize_functions_to_subcolumns è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œä¼˜åŒ–ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT mapKeys(m), mapValues(m) FROM table ä¼šè½¬åŒ–æˆ SELECT m.keys, m.values FROM table</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šå°±æ˜¯ Map çš„å†…å®¹ï¼Œæ€»çš„æ¥è¯´è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚</strong></p>
<h3 id="JSON-çš„ç›¸å…³æ“ä½œ"><a href="#JSON-çš„ç›¸å…³æ“ä½œ" class="headerlink" title="JSON çš„ç›¸å…³æ“ä½œ"></a>JSON çš„ç›¸å…³æ“ä½œ</h3><p><strong>æ—¢ç„¶æåˆ°äº† Mapï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä¸æåˆ° JSONï¼Œè¿™ä¸¤è€…åœ¨ç»“æ„ä¸Šæœ‰ç€éå¸¸é«˜çš„ç›¸ä¼¼ä¹‹å¤„ï¼Œä¸‹é¢å°±æ¥çœ‹çœ‹ JSON æ”¯æŒå“ªäº›æ“ä½œã€‚</strong></p>
<p><strong>isValidJSONï¼šæ£€æµ‹ JSON æ˜¯å¦åˆæ³•</strong></p>
<p><strong>JSON æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒisValidJSON åˆ™æ˜¯æ£€æµ‹è¯¥å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆ JSON æ ¼å¼ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> isValidJSON(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;</span>), isValidJSON(<span class="string">&#x27;&#123;1, 2, 3&#125;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€isValidJSON(&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;)â”€â”¬â”€isValidJSON(&#x27;&#123;1, 2, 3&#125;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                   1 â”‚                        0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>JSONHasï¼šæ£€æµ‹ JSON æ˜¯å¦åŒ…å«æŒ‡å®šçš„ key</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> JSONHas(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;</span>, <span class="string">&#x27;a&#x27;</span>), JSONHas(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;</span>, <span class="string">&#x27;a1&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONHas(&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;, &#x27;a&#x27;)â”€â”¬â”€JSONHas(&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;, &#x27;a1&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                    1 â”‚                                     0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>JSONLengthï¼šè·å– JSON çš„é•¿åº¦</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> JSONLength(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONLength(&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: false&#125;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                  2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>JSONTypeï¼šè·å– JSON ä¸­æŒ‡å®š value çš„ç±»å‹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: true, &quot;c&quot;: null, &quot;d&quot;: &quot;xx&quot;, &quot;e&quot;: [1, 2, 3], &quot;f&quot;: &#123;&quot;a&quot;: 1&#125;&#125;&#x27;</span> <span class="keyword">AS</span> j</span><br><span class="line"><span class="keyword">SELECT</span> JSONType(j, <span class="string">&#x27;a&#x27;</span>), JSONType(j, <span class="string">&#x27;b&#x27;</span>), JSONType(j, <span class="string">&#x27;c&#x27;</span>), </span><br><span class="line">       JSONType(j, <span class="string">&#x27;d&#x27;</span>), JSONType(j, <span class="string">&#x27;e&#x27;</span>), JSONType(j, <span class="string">&#x27;f&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONType(j, &#x27;a&#x27;)â”€â”¬â”€JSONType(j, &#x27;b&#x27;)â”€â”¬â”€JSONType(j, &#x27;c&#x27;)â”€â”¬â”€JSONType(j, &#x27;d&#x27;)â”€â”¬â”€JSONType(j, &#x27;e&#x27;)â”€â”¬â”€JSONType(j, &#x27;f&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ Int64            â”‚ Bool             â”‚ Null             â”‚ String           â”‚ Array            â”‚ Object           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toJSONStringï¼šå°†å…¶å®ƒæ•°æ®ç±»å‹è½¬æˆ JSON</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸å¯ä»¥å†™æˆ &#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: 2&#125;</span></span><br><span class="line"><span class="keyword">SELECT</span> toJSONString(map(<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">2</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toJSONString(map(&#x27;a&#x27;, 1, &#x27;b&#x27;, 2))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ &#123;&quot;a&quot;:1,&quot;b&quot;:2&#125;                     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>JSONExtractï¼šæ ¹æ® keyï¼Œä» JSON ä¸­è§£æå‡ºæŒ‡å®šçš„ valueï¼Œå°±ç±»ä¼¼äºæ ¹æ® key è·å– Map ä¸­çš„ value ä¸€æ ·</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åœ¨è·å– value çš„æ—¶å€™ï¼Œå¿…é¡»è¦æŒ‡å®š value æ˜¯ä»€ä¹ˆç±»å‹</span></span><br><span class="line"><span class="comment">-- ClickHouse ä¸­çš„ Bool æ˜¯ç”¨æ•´å‹è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥è½¬æˆ UInt8ã€16ã€32ã€64 ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: true&#125;&#x27;</span> <span class="keyword">AS</span> j</span><br><span class="line"><span class="keyword">SELECT</span> JSONExtract(j, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;UInt8&#x27;</span>), JSONExtract(j, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;Bool&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONExtract(j, &#x27;a&#x27;, &#x27;UInt8&#x27;)â”€â”¬â”€JSONExtract(j, &#x27;b&#x27;, &#x27;Bool&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                            1 â”‚                           1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> <span class="string">&#x27;&#123;&quot;a&quot;: [null, 123], &quot;b&quot;: &#123;&quot;a&quot;: 1&#125;&#125;&#x27;</span> <span class="keyword">AS</span> j</span><br><span class="line"><span class="keyword">SELECT</span> JSONExtract(j, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Array(UInt8)&#x27;</span>),</span><br><span class="line">       JSONExtract(j, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;Array(Nullable(UInt8))&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONExtract(j, &#x27;a&#x27;, &#x27;Array(UInt8)&#x27;)â”€â”¬â”€JSONExtract(j, &#x27;a&#x27;, &#x27;Array(Nullable(UInt8))&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,123]                             â”‚ [NULL,123]                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœè§£æå¤±è´¥ï¼Œé‚£ä¹ˆä¼šå¾—åˆ°ç›¸åº”çš„é›¶å€¼ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="string">&#x27;&#123;&quot;a&quot;: [null, 123], &quot;b&quot;: &#123;&quot;a&quot;: 1&#125;&#125;&#x27;</span> <span class="keyword">AS</span> j</span><br><span class="line"><span class="keyword">SELECT</span> JSONExtract(j, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;UInt64&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€JSONExtract(j, &#x27;a&#x27;, &#x27;UInt64&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                             0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse æ•°ç»„çš„ç›¸å…³æ“ä½œå‡½æ•°ï¼Œä¸€ç½‘æ‰“å°½(å)</title>
    <url>/2023/04/11/ClickHouse%20%E6%95%B0%E7%BB%84%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%EF%BC%8C%E4%B8%80%E7%BD%91%E6%89%93%E5%B0%BD(%E5%8D%81)/</url>
    <content><![CDATA[<h1 id="ClickHouse-æ•°ç»„çš„ç›¸å…³æ“ä½œå‡½æ•°ï¼Œä¸€ç½‘æ‰“å°½"><a href="#ClickHouse-æ•°ç»„çš„ç›¸å…³æ“ä½œå‡½æ•°ï¼Œä¸€ç½‘æ‰“å°½" class="headerlink" title="ClickHouse æ•°ç»„çš„ç›¸å…³æ“ä½œå‡½æ•°ï¼Œä¸€ç½‘æ‰“å°½"></a>ClickHouse æ•°ç»„çš„ç›¸å…³æ“ä½œå‡½æ•°ï¼Œä¸€ç½‘æ‰“å°½</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>åœ¨ä¸€èˆ¬çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¸æ€ä¹ˆä½¿ç”¨æ•°ç»„è¿™ä¸ªç»“æ„ï¼Œå¦‚æœçœŸçš„éœ€è¦æ•°ç»„ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å°†å…¶å˜æˆæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²è¿›è¡Œå­˜å‚¨ã€‚ä½†åœ¨ ClickHouse ä¸­ï¼Œæ•°ç»„çš„ä½¿ç”¨é¢‘ç‡æ˜¯éå¸¸é«˜çš„ï¼Œå› ä¸ºå®ƒå†…ç½®äº†å¤§é‡å’Œæ•°ç»„æœ‰å…³çš„å‡½æ•°ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> version();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€version()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 21.7.3.14 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>() <span class="keyword">FROM</span> system.functions <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%array%&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€count()â”€â”</span></span><br><span class="line"><span class="comment">â”‚      48 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“å‰çš„ ClickHouse æ˜¯ 21.7.3.14 ç‰ˆæœ¬ï¼Œå…³äºæ•°ç»„çš„å‡½æ•°æœ‰ 48 ä¸ªï¼Œé€šè¿‡è¿™ä¸ª 48 ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°ç»„è¿›è¡Œå„ç§éªšæ“ä½œã€‚å½“ç„¶ä¹Ÿæœ‰ä¸€äº›å‡½æ•°ä¸æ˜¯ä¸“é—¨é’ˆå¯¹æ•°ç»„çš„ï¼Œä½†æ˜¯å¯ä»¥ç”¨åœ¨æ•°ç»„èº«ä¸Šï¼Œæˆ‘ä»¬å°±ä¹Ÿæ”¾åœ¨ä¸€èµ·è¯´äº†ï¼Œä¸‹é¢å°±æ¥ä¾æ¬¡ä»‹ç»ç›¸å…³å‡½æ•°çš„ç”¨æ³•ã€‚</strong></p>
<p><strong>emptyï¼šåˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„ä¸åŒ…å«ä»»ä½•å…ƒç´ ï¼Œè¿”å› 1ï¼›å¦åˆ™è¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">empty</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), <span class="keyword">empty</span>([]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€empty([1, 2, 3])â”€â”¬â”€empty(array())â”€â”</span></span><br><span class="line"><span class="comment">â”‚                0 â”‚              1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>empty ä¸ä»…å¯ä»¥æ£€æµ‹æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œè¿˜å¯ä»¥æ£€æµ‹å­—ç¬¦ä¸²ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">empty</span>(<span class="string">&#x27;satori&#x27;</span>), <span class="keyword">empty</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€empty(&#x27;satori&#x27;)â”€â”¬â”€empty(&#x27;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚               0 â”‚         1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>notEmptyï¼šåˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ä¸ºç©ºï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„åŒ…å«è‡³å°‘ä¸€ä¸ªå…ƒç´ ï¼Œè¿”å› 1ï¼›ä¸åŒ…å«ä»»ä½•å…ƒç´ ï¼Œåˆ™è¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> notEmpty([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), notEmpty([]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€notEmpty([1, 2, 3])â”€â”¬â”€notEmpty(array())â”€â”</span></span><br><span class="line"><span class="comment">â”‚                   1 â”‚                 0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŒæ ·å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">SELECT</span> notEmpty(<span class="string">&#x27;satori&#x27;</span>), notEmpty(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€notEmpty(&#x27;satori&#x27;)â”€â”¬â”€notEmpty(&#x27;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                  1 â”‚            0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>lengthï¼šè¿”å›æ•°ç»„çš„é•¿åº¦ï¼Œè¯¥å‡½æ•°ä¹Ÿå¯ä»¥è¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> length([]), length([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), length(<span class="string">&#x27;satori&#x27;</span>), length(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€length(array())â”€â”¬â”€length([1, 2, 3])â”€â”¬â”€length(&#x27;satori&#x27;)â”€â”¬â”€length(&#x27;&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚               0 â”‚                 3 â”‚                6 â”‚          0 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>emptyArrayUInt8ã€emptyArrayUInt16ã€emptyArrayUInt32ã€emptyArrayUInt64ã€emptyArrayInt8ã€emptyArrayInt16ã€emptyArrayInt32ã€emptyArrayInt64ã€emptyArrayFloat32ã€emptyArrayFloat64ã€emptyArrayDateã€emptyArrayDateTimeã€emptyArrayStringï¼šåˆ›å»ºä¸€ä¸ªæŒ‡å®šç±»å‹çš„ç©ºæ•°ç»„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ•°ç»„å…ƒç´ çš„ç±»å‹ä¸º nothingï¼Œå› ä¸ºæ²¡æœ‰æŒ‡å®šä»»ä½•å…ƒç´ </span></span><br><span class="line"><span class="keyword">SELECT</span> [] v, toTypeName(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”¬â”€toTypeName(array())â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [] â”‚ Array(Nothing)      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é‡‡ç”¨æœ€å°ç±»å‹å­˜å‚¨ï¼Œå› ä¸º 1 å’Œ 2 éƒ½åœ¨ UInt8 çš„èŒƒå›´å†…</span></span><br><span class="line"><span class="keyword">SELECT</span> [<span class="number">1</span>, <span class="number">2</span>] v, toTypeName(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”€â”€â”€â”¬â”€toTypeName([1, 2])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2] â”‚ Array(UInt8)       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ›å»ºæŒ‡å®šç±»å‹çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">SELECT</span> emptyArrayDateTime() v, toTypeName(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”¬â”€toTypeName(emptyArrayDateTime())â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [] â”‚ Array(DateTime)                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>rangeï¼šç±»ä¼¼äº Python ä¸­çš„ rangeï¼Œçœ‹æµ‹è¯•ç”¨ä¾‹</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E6%95%B0%E7%BB%84%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%EF%BC%8C%E4%B8%80%E7%BD%91%E6%89%93%E5%B0%BD(%E5%8D%81)/1229382-20210904151126780-1273074293.png" alt="img"></p>
<p><strong>arrayï¼šä¹Ÿæ˜¯åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œå’Œç›´æ¥ä½¿ç”¨æ–¹æ‹¬å·ç±»ä¼¼ã€‚ä½†æ˜¯ array å‡½æ•°è¦æ±‚å¿…é¡»è‡³å°‘ä¼ é€’ä¸€ä¸ªå¸¸é‡ï¼Œå¦åˆ™å°±ä¸çŸ¥é“è¦åˆ›å»ºå“ªç§ç±»å‹çš„æ•°ç»„ã€‚å¦‚æœæƒ³åˆ›å»ºæŒ‡å®šç±»å‹çš„ç©ºæ•°ç»„ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸Šé¢çš„ emptyArray* ç³»åˆ—å‡½æ•°å³å¯</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸ç®¡æ˜¯ä½¿ç”¨ array åˆ›å»ºï¼Œè¿˜æ˜¯ä½¿ç”¨ [] åˆ›å»ºï¼Œé‡Œé¢çš„å…ƒç´ éƒ½å¿…é¡»å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæˆ–è€…èƒ½å¤Ÿå…¼å®¹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>), [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€array(1, 2, 3)â”€â”¬â”€[1, 2, 3]â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3]        â”‚ [1,2,3]   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayConatï¼šå°†å¤šä¸ªæ•°ç»„è¿›è¡Œåˆå¹¶ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SELECT ä¸­èµ·çš„åˆ«åå¯ä»¥è¢«ç›´æ¥å…¶å®ƒå­—æ®µæ‰€ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">SELECT</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] v1, [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>] v2, [<span class="number">111</span>, <span class="number">222</span>, <span class="number">333</span>] v3, arrayConcat(v1, v2, v3);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€v1â”€â”€â”€â”€â”¬â”€v2â”€â”€â”€â”€â”€â”€â”¬â”€v3â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€arrayConcat([1, 2], [11, 22], [111, 222])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2] â”‚ [11,22] â”‚ [111,222] â”‚ [1,2,11,22,111,222]                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayElementï¼šæŸ¥æ‰¾æŒ‡å®šç´¢å¼•çš„å…ƒç´ ï¼Œç´¢å¼•ä» 1 å¼€å§‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–¹æ‹¬å·ç›´æ¥å–å€¼ï¼›å¦å¤–ä¹Ÿæ”¯æŒè´Ÿæ•°ç´¢å¼•ï¼Œ-1 ä»£è¡¨æœ€åä¸€ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç´¢å¼•ä» 1 å¼€å§‹ï¼Œæ‰€ä»¥ arr[20] å°±è¡¨ç¤ºç¬¬ 20 ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ 19</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">100</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayElement(arr, <span class="number">20</span>), arr[<span class="number">20</span>];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(arr, 20)â”€â”¬â”€arrayElement(arr, 20)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                    19 â”‚                    19 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">100</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayElement(arr, <span class="number">-1</span>), arr[<span class="number">-50</span>];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayElement(arr, -1)â”€â”¬â”€arrayElement(arr, -50)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                    99 â”‚                     50 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hasï¼šåˆ¤æ–­æ•°ç»„é‡Œé¢æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼Œå¦‚æœåŒ…å«ï¼Œè¿”å› 1ï¼›ä¸åŒ…å«ï¼Œè¿”å›0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">Null</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> has(arr, <span class="number">2</span>), has(arr, <span class="number">0</span>), has(arr, <span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€has(arr, 2)â”€â”¬â”€has(arr, 0)â”€â”¬â”€has(arr, NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚           1 â”‚           0 â”‚              1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åµŒå¥—æ•°ç»„ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="keyword">SELECT</span> has([[<span class="number">1</span>, <span class="number">2</span>]], [<span class="number">1</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€has([[1, 2]], [1, 2])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                     1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hasAllï¼šåˆ¤æ–­æ•°ç»„é‡Œé¢æ˜¯å¦åŒ…å«æŸä¸ªå­æ•°ç»„ï¼Œå¦‚æœåŒ…å«ï¼Œè¿”å› 1ï¼›ä¸åŒ…å«ï¼Œè¿”å›0</strong></p>
<p><strong>æ³¨æ„ï¼šç©ºæ•°ç»„æ˜¯ä»»æ„æ•°ç»„çš„å­é›†ï¼›Null ä¼šè¢«çœ‹æˆæ˜¯æ™®é€šçš„å€¼ï¼›æ•°ç»„ä¸­çš„å…ƒç´ é¡ºåºæ²¡æœ‰è¦æ±‚ï¼›1.0 å’Œ 1 è¢«è§†ä¸ºç›¸ç­‰</strong></p>
<ul>
<li><code>hasAll([], [])ï¼šè¿”å› 1</code></li>
<li><code>hasAll([1, Null], [Null])ï¼šè¿”å› 1</code></li>
<li><code>hasAll([1.0, 2.0, 3.0], [2.0, 3.0, 1.0])ï¼šè¿”å› 1ï¼Œå› ä¸ºå…ƒç´ é¡ºåºæ— å½±å“ï¼Œå¹¶ä¸” 1.0 å’Œ 1 è¢«è§†ä¸ºç›¸ç­‰</code></li>
<li><code>hasAll([&#39;a&#39;, &#39;b&#39;], [&#39;a&#39;])ï¼šè¿”å› 1</code></li>
<li><code>hasAll([&#39;a&#39;, &#39;b&#39;], [&#39;c&#39;])ï¼šè¿”å› 0</code></li>
<li><code>hasAll([[1, 2], [3, 4]], [[1, 2], [3, 4]])ï¼šè¿”å› 1ï¼ŒåµŒå¥—æ•°ç»„ä¹Ÿæ˜¯å¯ä»¥çš„</code></li>
</ul>
<p><strong>åœ¨ has å‡½æ•°é‡Œé¢ä¹Ÿæœ‰åµŒå¥—æ•°ç»„ï¼Œä½†æ˜¯ç»´åº¦ä¸åŒã€‚æ¯”å¦‚ has(a, b)ï¼šå¦‚æœ a æ˜¯ç»´åº¦ä¸º N çš„æ•°ç»„ï¼Œé‚£ä¹ˆ b å¿…é¡»æ˜¯ç»´åº¦ä¸º N - 1 çš„æ•°ç»„ï¼›è€Œ hasAll åˆ™è¦æ±‚ a å’Œ b çš„ç»´åº¦å¿…é¡»ç›¸åŒã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">11</span>, <span class="number">22</span>]] <span class="keyword">AS</span> arr, [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">11</span>, <span class="number">22</span>]] <span class="keyword">AS</span> <span class="keyword">subset</span> <span class="keyword">SELECT</span> hasAll(arr, <span class="keyword">subset</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hasAll(arr, subset)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                   1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æˆ‘ä»¬è¯´ SELECT é‡Œé¢åˆ«åå¯ä»¥ç»™å…¶å®ƒå­—æ®µä½¿ç”¨ï¼Œå› æ­¤ä¸‹é¢è¿™ç§åšæ³•ä¹Ÿæ˜¯åˆæ³•çš„</span></span><br><span class="line"><span class="keyword">WITH</span> [[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">11</span>, <span class="number">22</span>]] <span class="keyword">AS</span> arr, arr <span class="keyword">AS</span> <span class="keyword">subset</span> <span class="keyword">SELECT</span> hasAll(arr, <span class="keyword">subset</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hasAll(arr, subset)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                   1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hasAnyï¼šåˆ¤æ–­ä¸¤ä¸ªæ•°ç»„é‡Œé¢æ˜¯å¦æœ‰ç›¸åŒçš„å…ƒç´ ï¼Œåªè¦æœ‰ 1 ä¸ªç›¸åŒçš„å…ƒç´ ï¼Œè¿”å› 1ï¼›å¦åˆ™ï¼Œè¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> hasAny([<span class="number">1.0</span>, <span class="number">2.0</span>], [<span class="number">1</span>]), hasAny([<span class="keyword">Null</span>], [<span class="number">1</span>, <span class="keyword">Null</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hasAny([1., 2.], [1])â”€â”¬â”€hasAny([NULL], [1, NULL])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                     1 â”‚                         1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> hasAny([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]], [[<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hasAny([[1, 2], [3, 4]], [[3, 4]])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                  1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>hasSubstrï¼šå’Œ hasAll ç±»ä¼¼ï¼Œä½†æ˜¯é¡ºåºæœ‰è¦æ±‚ï¼ŒhasAll(arr, subset) è¦æ±‚çš„æ˜¯ subset ä¸­çš„å…ƒç´ åœ¨ arr ä¸­éƒ½å‡ºç°å³å¯ï¼›ä½†æ˜¯ hasSubstr å‡½æ•°åˆ™ä¸ä»…è¦æ±‚ subset ä¸­çš„å…ƒç´ åœ¨ arr ä¸­éƒ½å‡ºç°ï¼Œå¹¶ä¸”è¿˜è¦ä»¥ç›¸åŒçš„é¡ºåºã€‚ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<ul>
<li><code>hasSubstr([1, 2, 3], [2, 3])ï¼šè¿”å› 1</code></li>
<li><code>hasSubstr([1, 2, 3], [3, 2])ï¼šè¿”å› 0</code></li>
<li><code>hasSubstr([[1, 2], [2, 1], [3, 2]], [[3, 2]])ï¼šè¿”å› 1</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸¤ä¸ªæ•°ç»„çš„ç»´åº¦å¿…é¡»ç›¸åŒ</span></span><br><span class="line"><span class="keyword">SELECT</span> hasSubstr([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">3</span>, <span class="number">2</span>]), hasSubstr([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€hasSubstr([1, 2, 3], [3, 2])â”€â”¬â”€hasSubstr([1, 2, 3], [2, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                            0 â”‚                            1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>indexOfï¼šæŸ¥æ‰¾æŸä¸ªå…ƒç´ ç¬¬ä¸€æ¬¡åœ¨æ•°ç»„ä¸­å‡ºç°çš„ä½ç½®ï¼Œç´¢å¼•ä» 1 å¼€å§‹ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å› 0</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="keyword">Null</span>, <span class="number">99</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> indexOf(arr, <span class="number">100</span>), indexOf(arr, <span class="number">99</span>), indexOf(arr, <span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€indexOf(arr, 100)â”€â”¬â”€indexOf(arr, 99)â”€â”¬â”€indexOf(arr, NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                 0 â”‚                5 â”‚                  4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayCountï¼šæŸ¥æ‰¾ä¸€ä¸ªæ•°ç»„ä¸­é 0 å…ƒç´ çš„ä¸ªæ•°ï¼Œè¯¥æ•°ç»„ç±»çš„å…ƒç´ ç±»å‹å¿…é¡»æ˜¯ UInt8ï¼Œå¹¶ä¸”ä¸èƒ½åŒ…å« Null å€¼ã€‚å› ä¸ºä¸€æ—¦åŒ…å« Nullï¼Œé‚£ä¹ˆç±»å‹å°±ä¸æ˜¯ UInt8 äº†ï¼Œè€Œæ˜¯ Nullable(UInt8)</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayCount([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), arrayCount([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayCount([1, 2, 3])â”€â”¬â”€arrayCount([1, 2, 3, 4, 0])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                     3 â”‚                           4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ­¤å¤– arrayCount è¿˜æœ‰ä¸€ç§ç”¨æ³•ï¼Œå°±æ˜¯æ¥æ”¶ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæ•°ç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">0</span>] <span class="keyword">AS</span> arr </span><br><span class="line"><span class="keyword">SELECT</span> arrayCount(arr), </span><br><span class="line">       arrayCount(x <span class="operator">-</span><span class="operator">&gt;</span> <span class="built_in">cast</span>(x <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> UInt8), arr)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayCount(arr)â”€â”¬â”€arrayCount(lambda(tuple(x), CAST(plus(x, 1), &#x27;UInt8&#x27;)), arr)â”€â”</span></span><br><span class="line"><span class="comment">â”‚               4 â”‚                                                            5 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*</span></span><br></pre></td></tr></table></figure>

<p><strong>ClickHouse ä¸­çš„å‡½æ•°ç±»ä¼¼äº C++ ä¸­çš„ lambda è¡¨è¾¾å¼ï¼Œx -&gt; x + 1 ç›¸å½“äºå°† arr ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åŠ ä¸Š 1ï¼Œä½†ç»“æœå¾—åˆ°æ•´å‹æ˜¯ UInt16ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ cast è½¬æˆ UInt8ï¼Œå¦åˆ™æŠ¥é”™ã€‚å¦å¤–ï¼ŒåŠ ä¸Š 1 ä¹‹åå°±æ²¡æœ‰ä¸º 0 çš„å…ƒç´ äº†ï¼Œæ‰€ä»¥è¿”å›çš„ç»“æœæ˜¯ 5ã€‚</strong></p>
<p><strong>countEqualï¼šè¿”å›æŸä¸ªå…ƒç´ åœ¨æ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="keyword">Null</span>, <span class="keyword">Null</span>] <span class="keyword">as</span> arr <span class="keyword">SELECT</span> countEqual(arr, <span class="number">1</span>), countEqual(arr, <span class="keyword">Null</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€countEqual(arr, 1)â”€â”¬â”€countEqual(arr, NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                  3 â”‚                     2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayEnumerateï¼šç­‰ä»·äºå…ˆè®¡ç®—å‡ºæ•°ç»„çš„é•¿åº¦ï¼Œå‡è®¾ä¸º Nï¼Œç„¶åè¿”å› range(1, N + 1)</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayEnumerate([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayEnumerate([2, 2, 2, 2])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3,4]                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayEnumerateUniqï¼šä»æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œæ¯é‡å¤ä¸€æ¬¡å°±åŠ  1</strong></p>
<p><strong>å…‰è¯´ä¸å¥½ç†è§£ï¼Œç›´æ¥çœ‹ä¾‹å­ï¼Œç„¶åç”»å›¾è¯´æ˜ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayEnumerateUniq([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayEnumerateUniq([&#x27;a&#x27;, &#x27;a&#x27;, &#x27;c&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,1,1,2,3,2,3]                                            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E6%95%B0%E7%BB%84%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0%EF%BC%8C%E4%B8%80%E7%BD%91%E6%89%93%E5%B0%BD(%E5%8D%81)/1229382-20210904151135342-481015945.png" alt="img"></p>
<p><strong>arrayEnumerateUniq è¿˜å¯ä»¥æ¥æ”¶å¤šä¸ªæ•°ç»„ï¼Œè¿™äº›æ•°æ®å…·æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œç›¸ä¿¡ä½ å·²ç»çŸ¥é“å®ƒçš„ä½œç”¨äº†ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayEnumerateUniq([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayEnumerateUniq([&#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;], [1, 2, 2, 1])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,1,1,2]                                              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­</span></span><br><span class="line"><span class="comment">-- ä½ å°±å¯ä»¥ç†è§£ä¸ºï¼šarrayEnumerateUniq( [(&#x27;a&#x27;, 1), (&#x27;a&#x27;, 2), (&#x27;b&#x27;, 2), (&#x27;a&#x27;, 1)] )</span></span><br><span class="line"><span class="comment">-- æ­¤æ—¶ä¼šå°†å¤šä¸ªæ•°ç»„ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå› æ­¤è¿™äº›æ•°ç»„éƒ½å¿…é¡»æœ‰ç›¸åŒçš„é•¿åº¦</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayPopBackï¼šç§»é™¤æ•°ç»„ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayPopBack([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPopBack([1, 2, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2]                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶å®ƒæ˜¯å¯ä»¥è¢«åµŒå¥—çš„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayPopBack(arrayPopBack(arr))</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPopBack(arrayPopBack(arr))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1]                             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šå¯¹ç©ºæ•°ç»„ä½¿ç”¨ arrayPopBack ä¸ä¼šæŠ¥é”™ï¼Œå¾—åˆ°çš„è¿˜æ˜¯ç©ºæ•°ç»„ã€‚</strong></p>
<p><strong>arrayPopFrontï¼šç§»é™¤æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayPopFront([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPopFront([1, 2, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,3]                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å’Œ arrayPopBack ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥è¢«åµŒå¥—ï¼Œå¹¶ä¸”å¯¹ç©ºæ•°ç»„ä½¿ç”¨ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œè¿˜æ˜¯å¾—åˆ°ç©ºæ•°ç»„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayPopFront(arrayPopFront(arr));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPopFront(arrayPopFront(arr))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3]                               â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayPushBackï¼šä»æ•°ç»„çš„å°¾éƒ¨å¡è¿›ä¸€ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayPushBack([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="number">1</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPushBack([1, 2, 3], 1)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3,1]                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ çš„æ—¶å€™è®°å¾—ç±»å‹è¦åŒ¹é…ï¼Œå¦‚æœæ·»åŠ äº† Nullï¼Œé‚£ä¹ˆæ•°ç»„ä¼šå˜æˆ Nullableã€‚</strong></p>
<p><strong>arrayPushFrontï¼šä»æ•°ç»„çš„å¤´éƒ¨å¡è¿›ä¸€ä¸ªå…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayPushFront([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>], <span class="string">&#x27;d&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayPushFront([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;], &#x27;d&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;d&#x27;,&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ çš„æ—¶å€™è®°å¾—ç±»å‹è¦åŒ¹é…ï¼Œå¦‚æœæ·»åŠ äº† Nullï¼Œé‚£ä¹ˆæ•°ç»„ä¼šå˜æˆ Nullableã€‚</strong></p>
<p><strong>arrayResizeï¼šæ”¹å˜æ•°ç»„çš„é•¿åº¦</strong></p>
<ul>
<li><code>å¦‚æœæŒ‡å®šçš„é•¿åº¦æ¯”åŸæ¥çš„é•¿åº¦å¤§ï¼Œé‚£ä¹ˆä¼šç”¨é›¶å€¼ä»å°¾éƒ¨è¿›è¡Œå¡«å……</code></li>
<li><code>å¦‚æœæŒ‡å®šçš„é•¿åº¦æ¯”åŸæ¥çš„é•¿åº¦å¤§ï¼Œé‚£ä¹ˆä¼šä»å°¾éƒ¨è¿›è¡Œæˆªæ–­</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayResize(<span class="keyword">range</span>(<span class="number">4</span>), <span class="number">7</span>), arrayResize(<span class="keyword">range</span>(<span class="number">4</span>), <span class="number">2</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayResize(range(4), 7)â”€â”¬â”€arrayResize(range(4), 2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,0,0,0]          â”‚ [0,1]                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨å¡«å……çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æŒ‡å®šçš„å€¼è¿›è¡Œå¡«å……ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayResize(<span class="keyword">range</span>(<span class="number">4</span>), <span class="number">7</span>, <span class="number">66</span>), arrayResize(<span class="keyword">range</span>(<span class="number">4</span>), <span class="number">7</span>, <span class="keyword">Null</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayResize(range(4), 7, 66)â”€â”¬â”€arrayResize(range(4), 7, NULL)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,66,66,66]           â”‚ [0,1,2,3,NULL,NULL,NULL]       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arraySliceï¼šè¿”å›æ•°ç»„çš„ä¸€ä¸ªç‰‡æ®µ</strong></p>
<ul>
<li><code>arraySlice(arr, M)ï¼šè¿”å›ä»ç´¢å¼•ä¸º M å¼€å§‹ä»¥åŠä¹‹åçš„æ‰€æœ‰å…ƒç´ </code></li>
<li><code>arraySlice(arr, M, N)ï¼šä»ç´¢å¼•ä¸º M çš„å…ƒç´ å¼€å§‹ï¼Œæ€»å…±è¿”å› N ä¸ªå…ƒç´ </code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arraySlice(<span class="keyword">range</span>(<span class="number">1</span>, <span class="number">10</span>), <span class="number">3</span>), arraySlice(<span class="keyword">range</span>(<span class="number">1</span>, <span class="number">10</span>), <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySlice(range(1, 10), 3)â”€â”¬â”€arraySlice(range(1, 10), 3, 4)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3,4,5,6,7,8,9]             â”‚ [3,4,5,6]                      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arraySortï¼šå¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œç„¶åè¿”å›</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arraySort([<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>]), arraySort([<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;ab&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySort([2, 3, 1])â”€â”¬â”€arraySort([&#x27;abc&#x27;, &#x27;ab&#x27;, &#x27;c&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3]              â”‚ [&#x27;ab&#x27;,&#x27;abc&#x27;,&#x27;c&#x27;]              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å­—ç¬¦ä¸²ä¼šæŒ‰ç…§å­—å…¸åºæ’åºè¿”å›ï¼Œæ•´å‹ã€æµ®ç‚¹å‹ã€æ—¥æœŸéƒ½ä¼šæŒ‰ç…§å¤§å°è¿”å›ã€‚</strong></p>
<p><strong>é—®é¢˜æ¥äº†ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æŒ‰ç…§å­—ç¬¦ä¸²çš„é•¿åº¦æ’åºè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ‰€ä»¥ arraySort è¿˜æ”¯æŒä¼ é€’ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŒ‰ç…§æ•°ç»„ä¸­å…ƒç´ çš„é•¿åº¦è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="keyword">SELECT</span> arraySort(x <span class="operator">-</span><span class="operator">&gt;</span> length(x),[<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;ab&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySort(lambda(tuple(x), length(x)), [&#x27;abc&#x27;, &#x27;ab&#x27;, &#x27;c&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;c&#x27;,&#x27;ab&#x27;,&#x27;abc&#x27;]                                           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å…ˆæŒ‰ç…§æ­£è´Ÿå·æ’åºï¼Œå°äº 0 çš„æ’åœ¨å¤§äº 0 çš„å·¦è¾¹ï¼Œç„¶åå„è‡ªå†æŒ‰ç…§ç»å¯¹å€¼è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="keyword">SELECT</span> arraySort(x <span class="operator">-</span><span class="operator">&gt;</span> (x <span class="operator">&gt;</span> <span class="number">0</span>, <span class="built_in">abs</span>(x)), [<span class="number">-3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">-1</span>, <span class="number">-2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySort(lambda(tuple(x), tuple(greater(x, 0), abs(x))), [-3, 1, 2, -1, -2, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [-1,-2,-3,1,2,3]                                                                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘å»ï¼Œè¿™ ClickHouse ä¹Ÿå¤ªå¼ºå¤§äº†å§ï¼Œè¿™ç®€ç›´ä¸åƒæ˜¯åœ¨å†™ SQL äº†ï¼Œéƒ½æœ‰ç‚¹åƒå†™ Python ä»£ç äº†ï¼Œæ‰€ä»¥ ClickHouse è¿™ä¹ˆç«ä¸æ˜¯æ²¡æœ‰åŸå› çš„ã€‚</strong></p>
<p><strong>å¦å¤–å½“å‡ºç°ç©ºå€¼æˆ– NaN çš„è¯ï¼Œå®ƒä»¬çš„é¡ºåºå¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-inf æ™®é€šæ•°å€¼ inf NaN Null</span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥ arraySort å¦‚æœæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆè¯¥å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç„¶å ClickHouse æŒ‰ç…§é»˜è®¤çš„è§„åˆ™è¿›è¡Œæ’åºï¼›å¦‚æœæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŒ¿åå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°ç»„ï¼Œæ­¤æ—¶ ClickHouse ä¼šæŒ‰ç…§æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°æ¥ç»™æ•°ç»„æ’åºï¼›ä½†å…¶å® arraySort è¿˜å¯ä»¥æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¾æ—§æ˜¯å‡½æ•°ï¼Œç„¶åç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯æ•°ç»„ï¼Œæ­¤æ—¶ä¼šç”¨æ•°ç»„ç»™æ•°ç»„æ’åºï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å› ä¸ºæœ‰ä¸¤ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥åŒ¿åå‡½æ•°è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œx è¡¨ç¤ºç¬¬ä¸€ä¸ªæ•°ç»„ã€y è¡¨ç¤ºç¬¬äºŒä¸ªæ•°ç»„</span></span><br><span class="line"><span class="comment">-- é¦–å…ˆä¸ç®¡æ’åºè§„åˆ™æ˜¯ä»€ä¹ˆï¼Œæœ€ç»ˆè¾“å‡ºçš„éƒ½æ˜¯ç¬¬ä¸€ä¸ªæ•°ç»„</span></span><br><span class="line"><span class="comment">-- x, y -&gt; y å°±è¡¨ç¤ºæŒ‰ç…§ç¬¬äºŒä¸ªæ•°ç»„æ¥ç»™ç¬¬ä¸€ä¸ªæ•°ç»„è¿›è¡Œæ’åºè¾“å‡º</span></span><br><span class="line"><span class="keyword">SELECT</span> arraySort(x, y <span class="operator">-</span><span class="operator">&gt;</span> y, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">22</span>, <span class="number">11</span>, <span class="number">33</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySort(lambda(tuple(x, y), y), [1, 2, 3], [22, 11, 33])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,1,3]                                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŒç† x, y -&gt; x è¿”å›çš„è¿˜æ˜¯ [1, 2, 3]ã€ x, y -&gt; -x è¿”å›çš„æ˜¯ [3, 2, 1]</span></span><br><span class="line"><span class="comment">-- åªä¸è¿‡æ­¤æ—¶ç¬¬äºŒä¸ªæ•°ç»„å°±ç”¨ä¸ä¸Šäº†</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayReverseSortï¼šå¯¹æ•°æ®è¿›è¡Œé€†åºæ’åºï¼Œç„¶åè¿”å›</strong></p>
<p><strong>è¯¥å‡½æ•°ä½ å¯ä»¥è®¤ä¸ºå®ƒæ˜¯å…ˆæŒ‰ç…§ arraySort æ’åºï¼Œç„¶åå°†ç»“æœå†åè¿‡æ¥ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arraySort(x <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">-</span>x, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) sort, arrayReverseSort(x <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">-</span>x, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) reverse_sort;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€sortâ”€â”€â”€â”€â”¬â”€reverse_sortâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3,2,1] â”‚ [1,2,3]      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æŒ‡å®šäº†åŒ¿åå‡½æ•°ï¼ŒæŒ‰ç…§ç›¸åæ•°è¿›è¡Œæ’åºï¼Œå› ä¸º -3 &lt; -2 &lt; -1ï¼Œæ‰€ç¤º arraySort æ’åºä¹‹åå°±æ˜¯ [3, 2, 1]ï¼Œç„¶å arrayReverseSort åˆ™æ˜¯åœ¨å…¶åŸºç¡€ä¸Šç›´æ¥è¿”å›ï¼Œæ‰€ä»¥å¾—åˆ°çš„è¿˜æ˜¯ [1, 2, 3]ã€‚</strong></p>
<p><strong>è‡³äºå…¶å®ƒç”¨æ³•å’Œ arraySort éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥çœ‹åšæ˜¯åœ¨ arraySort çš„åŸºç¡€ä¸Šåšäº†ä¸€æ¬¡åè½¬ã€‚ä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œé‚£å°±æ˜¯ Null å€¼å’Œ NaNï¼š</strong></p>
<ul>
<li><code>arraySortï¼š-inf æ™®é€šæ•°å€¼ inf NaN Null</code></li>
<li><code>arrayReverseSortï¼šinf æ™®é€šæ•°å€¼ -inf NaN Null</code></li>
</ul>
<p><strong>å³ä½¿æ˜¯ arrayReverseSortï¼ŒNaN å’Œ Null ä¾ç„¶æ’åœ¨æœ€åé¢ã€‚</strong></p>
<p><strong>arrayUniqï¼šè¿”å›æ•°ç»„ä¸­ä¸åŒå…ƒç´ çš„æ•°é‡</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayUniq([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayUniq([1, 2, 3, 1, 4])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                          4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¹Ÿå¯ä»¥ä¼ é€’å¤šä¸ªé•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œä¼šä¾æ¬¡å–å‡ºæ‰€æœ‰æ•°ç»„ä¸­ç›¸åŒä½ç½®çš„å…ƒç´ ï¼Œç„¶åæ‹¼æˆå…ƒç»„ï¼Œå¹¶è®¡ç®—è¿™äº›ä¸é‡å¤çš„å…ƒç»„çš„æ•°é‡ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç›¸å½“äºåˆ¤æ–­ arrayUniq( [(&#x27;a&#x27;, 1, 3), (&#x27;a&#x27;, 1, 3), (&#x27;b&#x27;, 2, 3)] )</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayUniq([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayUniq([&#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;], [1, 1, 2], [3, 3, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                                2 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayJoinï¼šå°†æ•°ç»„å±•å¼€æˆå¤šè¡Œ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayJoin(<span class="keyword">range</span>(<span class="number">1</span>, <span class="number">7</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayJoin(range(1, 7))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                      1 â”‚</span></span><br><span class="line"><span class="comment">â”‚                      2 â”‚</span></span><br><span class="line"><span class="comment">â”‚                      3 â”‚</span></span><br><span class="line"><span class="comment">â”‚                      4 â”‚</span></span><br><span class="line"><span class="comment">â”‚                      5 â”‚</span></span><br><span class="line"><span class="comment">â”‚                      6 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- || è¡¨ç¤ºå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå½“ arrayJoin å±•å¼€æˆå¤šè¡Œçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å’Œå…¶å®ƒå­—æ®µç»„åˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayJoin(<span class="keyword">range</span>(<span class="number">1</span>, <span class="number">7</span>)) <span class="keyword">AS</span> v, <span class="string">&#x27;A00&#x27;</span> <span class="operator">||</span> <span class="built_in">cast</span>(v <span class="keyword">AS</span> String);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”¬â”€concat(&#x27;A00&#x27;, CAST(arrayJoin(range(1, 7)), &#x27;String&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1 â”‚ A001                                                  â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2 â”‚ A002                                                  â”‚</span></span><br><span class="line"><span class="comment">â”‚ 3 â”‚ A003                                                  â”‚</span></span><br><span class="line"><span class="comment">â”‚ 4 â”‚ A004                                                  â”‚</span></span><br><span class="line"><span class="comment">â”‚ 5 â”‚ A005                                                  â”‚</span></span><br><span class="line"><span class="comment">â”‚ 6 â”‚ A006                                                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœå‡ºç°äº†å¤šä¸ª arrayJoin ï¼Œé‚£ä¹ˆä¼šåšç¬›å¡å°”ç§¯ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayJoin([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]), arrayJoin([<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>])ï¼›</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayJoin([1, 2, 3])â”€â”¬â”€arrayJoin([11, 22, 33])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                    1 â”‚                      11 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    1 â”‚                      22 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    1 â”‚                      33 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    2 â”‚                      11 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    2 â”‚                      22 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    2 â”‚                      33 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    3 â”‚                      11 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    3 â”‚                      22 â”‚</span></span><br><span class="line"><span class="comment">â”‚                    3 â”‚                      33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æåˆ°äº† arrJoinï¼Œé‚£ä¹ˆå°±å¿…é¡»æä¸€ä¸‹ groupArrayï¼Œè¿™ç®—æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå®ƒå’Œ arrayJoin ä½œç”¨ç›¸åï¼Œå°†å¤šè¡Œæ•°æ®åˆå¹¶æˆæ•°ç»„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> number <span class="keyword">FROM</span> numbers(<span class="number">5</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€numberâ”€â”</span></span><br><span class="line"><span class="comment">â”‚      0 â”‚</span></span><br><span class="line"><span class="comment">â”‚      1 â”‚</span></span><br><span class="line"><span class="comment">â”‚      2 â”‚</span></span><br><span class="line"><span class="comment">â”‚      3 â”‚</span></span><br><span class="line"><span class="comment">â”‚      4 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> groupArray(number) <span class="keyword">FROM</span> numbers(<span class="number">5</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArray(number)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,1,2,3,4]        â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>é™¤äº† groupArrayï¼Œè¿˜æœ‰ä¸€ä¸ª groupUniqArrayï¼Œä»åå­—ä¸Šçœ‹æ˜¾ç„¶å¤šäº†ä¸€ä¸ªå»é‡çš„åŠŸèƒ½ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SELECT arrayJoin([1, 1, 2, 2, 3]) ä¼šè‡ªåŠ¨å±•å¼€æˆå¤šè¡Œ</span></span><br><span class="line"><span class="comment">-- å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å®ƒä½œä¸ºä¸€å¼ è¡¨</span></span><br><span class="line"><span class="keyword">SELECT</span> v <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> arrayJoin([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]) v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 1 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 2 â”‚</span></span><br><span class="line"><span class="comment">â”‚ 3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é€šè¿‡ groupArray å†å˜æˆåŸæ¥çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">SELECT</span> groupArray(v) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> arrayJoin([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]) v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupArray(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,1,2,2,3]   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦‚æœä½¿ç”¨ groupUniqArray çš„è¯</span></span><br><span class="line"><span class="keyword">SELECT</span> groupUniqArray(v) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> arrayJoin([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]) v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€groupUniqArray(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,1,3]           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayDifferenceï¼šè®¡ç®—æ•°ç»„ä¸­æ¯ç›¸é‚»çš„ä¸¤ä¸ªå…ƒç´ çš„å·®å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç¬¬ä¸€ä¸ªå…ƒç´ å›ºå®šä¸º 0ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸º 3 - 1ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ ä¸º 4 - 3ï¼Œä»¥æ­¤ç±»æ¨</span></span><br><span class="line"><span class="comment">-- ç›¸é‚»å…ƒç´ ç›¸å‡</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayDifference([<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">10</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayDifference([1, 3, 4, 7, 10])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [0,2,1,3,3]                       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayDistinctï¼šå¯¹æ•°ç»„ä¸­çš„å…ƒç´ è¿›è¡Œå»é‡</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayDistinct([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayDistinct([1, 1, 1, 2, 2, 3])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3]                           â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayEnumerateDenseï¼šè¿”å›ä¸€ä¸ªå’ŒåŸæ•°ç»„å¤§å°ç›¸ç­‰çš„æ•°ç»„ï¼Œå¹¶æŒ‡ç¤ºæ¯ä¸ªå…ƒç´ åœ¨åŸæ•°ç»„ä¸­é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆç´¢å¼•éƒ½æ˜¯ä» 1 å¼€å§‹ï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 22 é¦–æ¬¡å‡ºç°åœ¨ç´¢å¼•ä¸º 1 çš„ä½ç½®ã€1 é¦–æ¬¡å‡ºç°åœ¨ç´¢å¼•ä¸º 2 çš„ä½ç½®</span></span><br><span class="line"><span class="comment">-- 13 é¦–æ¬¡å‡ºç°åœ¨ç´¢å¼•ä¸º 4 çš„ä½ç½®ï¼Œå› æ­¤ç»“æœä¸º [1, 2, 1, 3, 2, 3]</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayEnumerateDense([<span class="number">22</span>, <span class="number">1</span>, <span class="number">22</span>, <span class="number">13</span>, <span class="number">1</span>, <span class="number">13</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayEnumerateDense([22, 1, 22, 13, 1, 13])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,1,3,2,3]                               â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayIntersectï¼šæ¥æ”¶å¤šä¸ªæ•°ç»„ï¼Œå¹¶å–å®ƒä»¬çš„äº¤é›†</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayIntersect([<span class="number">1</span>, <span class="number">2</span>], [<span class="number">2</span>, <span class="number">3</span>], [<span class="number">3</span>, <span class="number">4</span>]), arrayIntersect([<span class="number">1</span>, <span class="number">2</span>], [<span class="number">2</span>, <span class="number">3</span>], [<span class="number">2</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayIntersect([1, 2], [2, 3], [3, 4])â”€â”¬â”€arrayIntersect([1, 2], [2, 3], [2, 4])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ []                                     â”‚ [2]                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayReduceï¼šå°†ä¸€ä¸ªèšåˆå‡½æ•°ä½œç”¨åœ¨æ•°ç»„ä¸Šï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayReduce(<span class="string">&#x27;max&#x27;</span>, [<span class="number">1</span>, <span class="number">23</span>, <span class="number">6</span>]), arrayReduce(<span class="string">&#x27;sum&#x27;</span>, [<span class="number">1</span>, <span class="number">23</span>, <span class="number">6</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayReduce(&#x27;max&#x27;, [1, 23, 6])â”€â”¬â”€arrayReduce(&#x27;sum&#x27;, [1, 23, 6])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                             23 â”‚                             30 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯èƒ½æœ‰äººè§‰å¾—ç›´æ¥ç”¨èšåˆå‡½æ•°ä¸å°±å¥½äº†ï¼Œç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¿™äº›èšåˆå‡½æ•°é’ˆå¯¹çš„éƒ½æ˜¯å¤šè¡Œç»“æœé›†ï¼Œè€Œä¸æ˜¯æ•°ç»„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç›¸å½“äºåªæœ‰ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥è¿”å›å…¶æœ¬èº«</span></span><br><span class="line"><span class="comment">-- å¦‚æœæ˜¯ sum å°±ç›´æ¥æŠ¥é”™äº†ï¼Œ å› ä¸ºæ•°ç»„ä¹‹é—´ä¸èƒ½è¿›è¡ŒåŠ æ³•è¿ç®—</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>([<span class="number">11</span>, <span class="number">33</span>, <span class="number">22</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€max([11, 33, 22])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [11,33,22]        â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å¦‚æœæƒ³è¿”å› 33ï¼Œæˆ‘ä»¬åº”è¯¥å°†è¿™ä¸ªæ•°ç»„ç»™å±•å¼€ï¼Œå˜æˆå¤šè¡Œ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(arrayJoin([<span class="number">11</span>, <span class="number">33</span>, <span class="number">22</span>]));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€max(arrayJoin([11, 33, 22]))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                           33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ‰€ä»¥èšåˆå‡½æ•°é’ˆå¯¹çš„æ˜¯å¤šè¡Œï¼Œè€Œä¸æ˜¯æ•°ç»„ï¼Œå¦‚æœæƒ³ç”¨èšåˆå‡½æ•°ï¼Œé‚£ä¹ˆåº”è¯¥å°†æ•°ç»„ç»™å±•å¼€ã€‚æˆ–è€…ä½¿ç”¨è¿™é‡Œçš„ arrayReduceï¼Œç›¸å½“äºå°†ä¸¤æ­¥åˆåœ¨ä¸€èµ·äº†ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨ arrayReduceï¼Œå› ä¸º ClickHouse ä¸ºäº†æ•°ç»„ä¸“é—¨æä¾›äº†ç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚æ±‚æ•°ç»„ä¸­æœ€å¤§çš„å…ƒç´ å¯ä»¥ä½¿ç”¨æ›´å¼ºå¤§çš„ arrayMaxï¼Œåé¢è¯´ã€‚</strong></p>
<p><strong>arrayReduceInRangesï¼šå¯¹ç»™å®šèŒƒå›´å†…çš„æ•°ç»„å…ƒç´ åº”ç”¨èšåˆå‡½æ•°ï¼Œå…‰è¯´ä¸å¥½è§£é‡Šï¼Œç›´æ¥çœ‹ä¾‹å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¼šå¯¹æ•°ç»„ä¸­ç´¢å¼•ä¸º 1 å¼€å§‹å‘åçš„ 5 ä¸ªå…ƒç´ è¿›è¡Œ sumï¼Œç»“æœä¸º 15</span></span><br><span class="line"><span class="comment">-- ä¼šå¯¹æ•°ç»„ä¸­ç´¢å¼•ä¸º 2 å¼€å§‹å‘åçš„ 4 ä¸ªå…ƒç´ è¿›è¡Œ sumï¼Œç»“æœä¸º 14</span></span><br><span class="line"><span class="comment">-- ä¼šå¯¹æ•°ç»„ä¸­ç´¢å¼•ä¸º 1 å¼€å§‹å‘åçš„ 3 ä¸ªå…ƒç´ è¿›è¡Œ sumï¼Œç»“æœä¸º 6</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayReduceInRanges(</span><br><span class="line">    <span class="string">&#x27;sum&#x27;</span>,</span><br><span class="line">    [(<span class="number">1</span>, <span class="number">5</span>), (<span class="number">2</span>, <span class="number">4</span>), (<span class="number">1</span>, <span class="number">3</span>)],</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayReduceInRanges(&#x27;sum&#x27;, array((1, 5), (2, 4), (1, 3)), [1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [15,14,6]                                                                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»¥ä¸Šç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">WITH</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="keyword">AS</span> arr </span><br><span class="line"><span class="keyword">SELECT</span> [arrayReduce(<span class="string">&#x27;sum&#x27;</span>, arraySlice(arr, <span class="number">1</span>, <span class="number">5</span>)), </span><br><span class="line">        arrayReduce(<span class="string">&#x27;sum&#x27;</span>, arraySlice(arr, <span class="number">2</span>, <span class="number">4</span>)),</span><br><span class="line">        arrayReduce(<span class="string">&#x27;sum&#x27;</span>, arraySlice(arr, <span class="number">1</span>, <span class="number">3</span>))] <span class="keyword">AS</span> v</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [15,14,6] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayReverseï¼šå¯¹æ•°æ®è¿›è¡Œé€†åºï¼Œç„¶åè¿”å›ï¼›æˆ‘ä»¬ä¹‹å‰è¿˜ä»‹ç»äº†ä¸€ä¸ª arrayReverseSortï¼Œå®ƒåœ¨é€†åºä¹‹å‰ä¼šå…ˆæ’åºï¼Œè€Œè¿™é‡Œçš„ arrayReverse åªæ˜¯å•çº¯çš„é€†åº</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- arrayReverse å’Œ reverse ä½œç”¨ç›¸åŒ</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayReverse([<span class="number">22</span>, <span class="number">33</span>, <span class="number">11</span>]), reverse([<span class="number">22</span>, <span class="number">33</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayReverse([22, 33, 11])â”€â”¬â”€reverse([22, 33, 11])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [11,33,22]                 â”‚ [11,33,22]            â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayFlattenï¼šå°†æ•°ç»„æ‰å¹³åŒ–</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- arrayFlatten ä¹Ÿå¯ä»¥ä½¿ç”¨ flatten ä»£æ›¿</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayFlatten([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>]]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFlatten([[1, 2, 3], [11, 22, 33]])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3,11,22,33]                        â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬ä¹‹å‰è¿˜ä»‹ç»äº†ä¸€ä¸ª arrayConcatï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¸¤è€…çš„åŒºåˆ«</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayConcat ([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayConcat([1, 2, 3], [11, 22, 33])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,2,3,11,22,33]                     â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayCompactï¼šä»æ•°ç»„ä¸­åˆ é™¤è¿ç»­é‡å¤çš„å…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayCompact([<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="keyword">Null</span>, <span class="keyword">Null</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayCompact([2, 2, 1, 1, 1, 3, 3, NULL, NULL])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,1,3,NULL]                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°ä½œç”¨ç±»ä¼¼äºä¹‹å‰ä»‹ç»çš„ arrayDistinctï¼Œä½†ä¸¤è€…è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayDistinct([<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayDistinct([2, 2, 1, 1, 1, 3, 3, NULL, NULL])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,1,3]                                          â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬å‘ç° arrayDistinct ä¸åŒ…å« Null å€¼ã€‚</strong></p>
<p><strong>arrayZipï¼šç±»ä¼¼äº Python ä¸­çš„ zipï¼Œç›´æ¥çœ‹ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayZip([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayZip([&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;], [1, 2, 3], [&#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [(&#x27;a&#x27;,1,&#x27;x&#x27;),(&#x27;b&#x27;,2,&#x27;y&#x27;),(&#x27;c&#x27;,3,&#x27;z&#x27;)]                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayMapï¼šå¯¹æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä½œç”¨ç›¸åŒçš„å‡½æ•°ï¼Œæ ¹æ®å‡½æ•°çš„è¿”å›å€¼åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œéå¸¸å¸¸ç”¨çš„ä¸€ä¸ªåŠŸèƒ½ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> (x, <span class="number">1</span>), [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMap(lambda(tuple(x), tuple(x, 1)), [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [(&#x27;a&#x27;,1),(&#x27;b&#x27;,1),(&#x27;c&#x27;,1)]                                â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) v1, <span class="built_in">sum</span>(arrayJoin(v1)) v2, arrayReduce(<span class="string">&#x27;sum&#x27;</span>, v1) v3;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€v1â”€â”€â”€â”€â”€â”€â”¬â”€v2â”€â”¬â”€v3â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,4,6] â”‚ 12 â”‚ 12 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ä¹Ÿå¯ä»¥ä½œç”¨åµŒå¥—æ•°ç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> arrayReduce(<span class="string">&#x27;sum&#x27;</span>, x), [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>], [<span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>]]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMap(lambda(tuple(x), arrayReduce(&#x27;sum&#x27;, x)), [[1, 2, 3], [11, 22, 33], [33, 44, 55]])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [6,66,132]                                                                                 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> arrayReduce(<span class="string">&#x27;max&#x27;</span>, x), [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>], [<span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>]]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMap(lambda(tuple(x), arrayReduce(&#x27;max&#x27;, x)), [[1, 2, 3], [11, 22, 33], [33, 44, 55]])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3,33,55]                                                                                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x <span class="operator">-</span><span class="operator">&gt;</span> arrayReduce(<span class="string">&#x27;min&#x27;</span>, x), [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>], [<span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>]]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMap(lambda(tuple(x), arrayReduce(&#x27;max&#x27;, x)), [[1, 2, 3], [11, 22, 33], [33, 44, 55]])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,11,33]                                                                                  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¹Ÿå¯ä»¥ä½œç”¨å¤šä¸ªæ•°ç»„ï¼Œè¿™äº›æ•°ç»„çš„é•¿åº¦å¿…é¡»ç›¸ç­‰ã€‚æ­¤å¤–ï¼Œæœ‰å¤šä¸ªæ•°ç»„ï¼Œå‡½æ•°å°±è¦æœ‰å¤šå°‘ä¸ªå‚æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¾—åˆ°çš„æ˜¯ [1 + 11 + 33, 2 + 22 + 44, 3 + 33 + 55]</span></span><br><span class="line"><span class="comment">-- å¦‚æœæ˜¯ arrayMap(x -&gt; arrayReduce(&#x27;sum&#x27;, x), [[1, 2, 3], [11, 22, 33], [33, 44, 55]])</span></span><br><span class="line"><span class="comment">-- é‚£ä¹ˆå¾—åˆ°çš„æ˜¯ [1 + 2 + 3, 11 + 22 + 33, 33 + 44 + 55]</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x, y, z <span class="operator">-</span><span class="operator">&gt;</span> arrayReduce(<span class="string">&#x27;sum&#x27;</span>, [x, y, z]), [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>], [<span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>]) <span class="keyword">AS</span> v;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [45,68,91] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x, y, z <span class="operator">-</span><span class="operator">&gt;</span> (x <span class="operator">+</span> y, z), [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>], [<span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>]) <span class="keyword">AS</span> v;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [(12,33),(24,44),(36,55)] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayFilterï¼šå¯¹æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä½œç”¨ç›¸åŒçš„å‡½æ•°ï¼Œå¦‚æœå‡½æ•°è¿”å›å€¼ä¸ºçœŸï¼ˆé 0ï¼‰ï¼Œåˆ™è¯¥å…ƒç´ ä¿ç•™ï¼Œå¦åˆ™ä¸ä¿ç•™ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayFilter(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">&gt;</span> <span class="number">5</span>, [<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">10</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFilter(lambda(tuple(x), greater(x, 5)), [1, 4, 5, 7, 10])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [7,10]                                                         â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayFilter(x <span class="operator">-</span><span class="operator">&gt;</span> length(x) <span class="operator">&gt;</span> <span class="number">1</span>, [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;aa&#x27;</span>, <span class="string">&#x27;aaa&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFilter(lambda(tuple(x), greater(length(x), 1)), [&#x27;a&#x27;, &#x27;aa&#x27;, &#x27;aaa&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;aa&#x27;,&#x27;aaa&#x27;]                                                             â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> arrayFilter(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="keyword">LIKE</span> <span class="string">&#x27;sa%&#x27;</span>, [<span class="string">&#x27;satori&#x27;</span>, <span class="string">&#x27;koishi&#x27;</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFilter(lambda(tuple(x), like(x, &#x27;sa%&#x27;)), [&#x27;satori&#x27;, &#x27;koishi&#x27;])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [&#x27;satori&#x27;]                                                          â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayFillï¼šå¯¹æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä½œç”¨ç›¸åŒçš„å‡½æ•°ï¼Œå¦‚æœå‡½æ•°è¿”å›å€¼ä¸ºçœŸï¼Œåˆ™è¯¥å…ƒç´ ä¿ç•™ï¼Œå¦åˆ™è¢«æ›¿æ¢ä¸ºå‰ä¸€ä¸ªå…ƒç´ ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 2 ä¼šè¢«æ›¿æ¢æˆ 4ï¼Œ1 ä¼šè¢«æ›¿æ¢æˆ 5</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayFill(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">&gt;=</span> <span class="number">3</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFill(lambda(tuple(x), greaterOrEquals(x, 3)), [3, 4, 2, 5, 1])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3,4,4,5,5]                                                         â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç¬¬ä¸€ä¸ªå…ƒç´ æ°¸è¿œä¸ä¼šè¢«æ›¿æ¢ï¼Œ2ã€3ã€4ã€5 éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤éƒ½è¦æ¢æˆå‰ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="comment">-- æ¢ 2 çš„æ—¶å€™ï¼Œ2 å·²ç»å˜æˆäº† 1ï¼Œæ‰€ä»¥ 3 çš„å‰é¢æ˜¯ 1ï¼Œäºæ˜¯ 3 ä¹Ÿä¼šå˜æˆ 1</span></span><br><span class="line"><span class="comment">-- 4 å’Œ 5 ä¹Ÿæ˜¯åŒç†ï¼Œå› æ­¤æœ€ç»ˆæ‰€æœ‰å€¼éƒ½ä¼šå˜æˆ 1</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayFill(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">&gt;=</span> <span class="number">6</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayFill(lambda(tuple(x), greaterOrEquals(x, 6)), [1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,1,1,1,1]                                                         â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayReverseFillï¼šå¯¹æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä½œç”¨ç›¸åŒçš„å‡½æ•°ï¼Œå¦‚æœå‡½æ•°è¿”å›å€¼ä¸ºçœŸï¼Œåˆ™è¯¥å…ƒç´ ä¿ç•™ï¼Œå¦åˆ™è¢«æ›¿æ¢ä¸ºåä¸€ä¸ªå…ƒç´ ã€‚æ³¨æ„ï¼šæ­¤æ—¶æ•°ç»„æ˜¯ä»åå¾€å‰æ‰«æçš„</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 2 ä¼šè¢«æ›¿æ¢æˆ 5ï¼Œ1 è¿˜æ˜¯ 1ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸ä¼šè¢«æ›¿æ¢</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayReverseFill(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">&gt;=</span> <span class="number">3</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayReverseFill(lambda(tuple(x), greaterOrEquals(x, 3)), [3, 4, 2, 5, 1])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [3,4,5,5,1]                                                                â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å› ä¸ºæ•°ç»„ä»åå¾€å‰æ‰«æï¼Œæ‰€ä»¥ 4 å˜æˆ 5ã€3 ä¹Ÿä¼šå˜æˆ 5ï¼Œæ‰€æœ‰å€¼éƒ½ä¼šå˜æˆ 5</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayReverseFill(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">&gt;=</span> <span class="number">6</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayReverseFill(lambda(tuple(x), greaterOrEquals(x, 6)), [1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [5,5,5,5,5]                                                                â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayMinï¼šè¿”å›æ•°ç»„ä¸­æœ€å°çš„å…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">11</span>, <span class="number">22</span>, <span class="number">8</span>, <span class="number">33</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayMin(arr) v1, <span class="built_in">min</span>(arrayJoin(arr)) v2, arrayReduce(<span class="string">&#x27;min&#x27;</span>, arr) v3;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€v1â”€â”¬â”€v2â”€â”¬â”€v3â”€â”</span></span><br><span class="line"><span class="comment">â”‚  8 â”‚  8 â”‚  8 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayMin é‡Œé¢è¿˜å¯ä»¥ä¼ é€’ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayMin(x <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">-</span>x, [<span class="number">11</span>, <span class="number">22</span>, <span class="number">8</span>, <span class="number">33</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMin(lambda(tuple(x), negate(x)), [11, 22, 8, 33])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                                    -33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¼šæŒ‰ç…§è°ƒç”¨åŒ¿åå‡½æ•°çš„è¿”å›å€¼è¿›è¡Œåˆ¤æ–­ï¼Œé€‰æ‹©æœ€å°çš„å…ƒç´ ï¼Œè¿™é‡Œ 33 åœ¨è°ƒç”¨ä¹‹åè¿”å› -33ï¼Œæ˜¾ç„¶æ˜¯æœ€å°å€¼ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯å®ƒè¿”å›çš„ä¹Ÿæ˜¯åŒ¿åå‡½æ•°çš„è¿”å›å€¼ã€‚ä¸ªäººè§‰å¾—åº”è¯¥è¿”å› 33 æ‰å¯¹ï¼Œåº”ä¸ºæˆ‘ä»¬æŒ‡å®šå‡½æ•°åªæ˜¯å¸Œæœ› ClickHouse èƒ½å¤ŸæŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„è§„åˆ™è¿›è¡Œæ’åºï¼Œè€Œå€¼è¿˜æ˜¯åŸæ¥çš„å€¼ï¼Œä½† ClickHouse è¿™é‡Œè®¾è®¡æœ‰ç‚¹è«æµ‹é«˜æ·±äº†ã€‚å¦‚æœæˆ‘ä»¬ä»¥å­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œé‚£ä¹ˆä¼šçœ‹çš„æ›´åŠ æ˜æ˜¾ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayMin(x <span class="operator">-</span><span class="operator">&gt;</span> length(x), [<span class="string">&#x27;ab&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]) v;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°å±…ç„¶è¿”å›äº†ä¸€ä¸ª 1ï¼Œæˆ‘ä»¬çš„æœ¬æ„æ˜¯æƒ³é€‰æ‹©é•¿åº¦æœ€çŸ­çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯æœ€çŸ­å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¿”å›çš„ä¸æ˜¯ â€˜aâ€™ï¼Œè€Œæ˜¯ length(â€˜aâ€™)ã€‚</strong></p>
<p><strong>arrayMaxï¼šè¿”å›æ•°ç»„ä¸­æœ€å¤§çš„å…ƒç´ </strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> [<span class="number">11</span>, <span class="number">22</span>, <span class="number">8</span>, <span class="number">33</span>] <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayMax(arr) v1, <span class="built_in">max</span>(arrayJoin(arr)) v2, arrayReduce(<span class="string">&#x27;max&#x27;</span>, arr) v3;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€v1â”€â”¬â”€v2â”€â”¬â”€v3â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 33 â”‚ 33 â”‚ 33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¹Ÿå¯ä»¥åŠ ä¸Šä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä½œç”¨å’Œ arrayMin å®Œå…¨ä¸€æ ·ï¼Œå¹¶ä¸”è¿”å›çš„ä¹Ÿæ˜¯å‡½æ•°è°ƒç”¨ä¹‹åçš„ç»“æœã€‚</strong></p>
<p><strong>arraySumï¼šå¯¹æ•°ç»„æ±‚æ€»å’Œ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">101</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arraySum(arr), arrayReduce(<span class="string">&#x27;sum&#x27;</span>, arr), <span class="built_in">sum</span>(arrayJoin(arr));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySum(arr)â”€â”¬â”€arrayReduce(&#x27;sum&#x27;, arr)â”€â”¬â”€sum(arrayJoin(arr))â”€â”</span></span><br><span class="line"><span class="comment">â”‚          5050 â”‚                    5050 â”‚                5050 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·å¯ä»¥åŠ ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">101</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arraySum(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, arr);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arraySum(lambda(tuple(x), multiply(x, 2)), arr)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                           10100 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayProductï¼šå¯¹æ•°ç»„æ±‚æ€»ä¹˜ç§¯</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayProduct([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayProduct([1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                           120 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·å¯ä»¥åŠ ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> arrayProduct(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">+</span> <span class="number">1</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayProduct(lambda(tuple(x), plus(x, 1)), [1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                                         720 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayAvgï¼šå¯¹æ•°ç»„å–å¹³å‡å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">101</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayAvg(arr), arrayReduce(<span class="string">&#x27;avg&#x27;</span>, arr), <span class="built_in">avg</span>(arrayJoin(arr));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayAvg(arr)â”€â”¬â”€arrayReduce(&#x27;avg&#x27;, arr)â”€â”¬â”€avg(arrayJoin(arr))â”€â”</span></span><br><span class="line"><span class="comment">â”‚          50.5 â”‚                    50.5 â”‚                50.5 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·å¯ä»¥åŠ ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">101</span>) <span class="keyword">AS</span> arr <span class="keyword">SELECT</span> arrayAvg(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, arr);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayAvg(lambda(tuple(x), multiply(x, 2)), arr)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                             101 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>arrayCumSumï¼šå¯¹æ•°ç»„è¿›è¡Œç´¯å’Œ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç¬¬ä¸€ä¸ªå…ƒç´ ä¸å˜</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayCumSum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayCumSum([1, 2, 3, 4, 5])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [1,3,6,10,15]                â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>åŒæ ·å¯ä»¥åŠ ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ç¬¬ä¸€ä¸ªå…ƒç´ ä¸å˜</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayCumSum(x <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">*</span> <span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]), arrayCumSum([<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayCumSum(lambda(tuple(x), multiply(x, 2)), [1, 2, 3, 4, 5])â”€â”¬â”€arrayCumSum([2, 4, 6, 8, 10])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [2,6,12,20,30]                                                 â”‚ [2,6,12,20,30]                â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>ä»¥ä¸Šå°±æ˜¯å…³äº ClickHouse æ•°ç»„çš„ä¸€äº›å‡½æ•°æ“ä½œï¼Œå¯ä»¥è¯´æ˜¯éå¸¸å¼ºå¤§äº†ï¼Œä¸å…‰æ˜¯åŠŸèƒ½å¼ºå¤§ï¼Œç”¨èµ·æ¥ä¹Ÿå¾ˆèˆ’æœï¼Œä»¿ä½›æœ‰ç§åœ¨å†™ Python ä»£ç çš„æ„Ÿè§‰ã€‚å½“ç„¶ä»¥ä¸Šå¹¶ä¸æ˜¯å…³äºæ•°ç»„çš„å…¨éƒ¨æ“ä½œï¼ˆç»å¤§éƒ¨åˆ†ï¼‰ï¼Œä½†è¯´å®è¯å·²ç»å¤Ÿç”¨äº†ï¼Œå³ä½¿ä½ å½“å‰çš„éœ€æ±‚ï¼ŒæŸä¸€ä¸ªå‡½æ•°ä¸èƒ½è§£å†³ï¼Œé‚£ä¹ˆä¹Ÿèƒ½å¤šä¸ªå‡½æ•°ç»„åˆæ¥è§£å†³ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³è¦è®¡ç®—ä¸¤ä¸ªæ•°ç»„ä¸­ç›¸åŒä½ç½®çš„å…ƒç´ çš„å·®ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿™ä¹ˆåšï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸€ä¸ªå‡½æ•°å³å¯è§£å†³</span></span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(x, y <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">-</span> y, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€arrayMap(lambda(tuple(x, y), minus(x, y)), [1, 2, 3], [3, 2, 1])â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [-2,0,2]                                                         â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å†æ¯”å¦‚ï¼Œè®¡ç®—æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å‡å»ä¸Šä¸€ä¸ªå…ƒç´ çš„å€¼ï¼Œç”±äºç¬¬ä¸€ä¸ªå…ƒç´ ä¸Šé¢æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆè®¾ä¸ºç©ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æˆ‘ä»¬åªéœ€è¦é€‰æ‹© arr çš„å‰ N - 1 ä¸ªå…ƒç´ ï¼Œç„¶åå†åœ¨å¤´éƒ¨æ’å…¥ä¸€ä¸ª Nullï¼Œ[Null, 11, 22, 33, 44, 55]</span></span><br><span class="line"><span class="comment">-- æœ€åè®© arr å’Œå®ƒçš„å¯¹åº”å…ƒç´ ä¾æ¬¡ç›¸å‡å³å¯</span></span><br><span class="line"><span class="keyword">WITH</span> [<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>, <span class="number">66</span>] <span class="keyword">AS</span> arr</span><br><span class="line"><span class="keyword">SELECT</span> arrayMap(</span><br><span class="line">    x, y <span class="operator">-</span><span class="operator">&gt;</span> x <span class="operator">-</span> y, </span><br><span class="line">    arr, </span><br><span class="line">    arrayPushFront(arraySlice(arr, <span class="number">1</span>, length(arr) <span class="operator">-</span> <span class="number">1</span>), <span class="keyword">Null</span>)</span><br><span class="line">) v;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€vâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ [NULL,11,11,11,11,11] â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶å³ä½¿æ˜¯å¤æ‚çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¤šä¸ªå‡½æ•°ç»„åˆå®Œæˆï¼Œæ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹é…·å‘¢ï¼ŸClickHouse å†…å»ºäº†å¾ˆå¤šçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç»™æˆ‘ä»¬ä¸€ç§ä»¿ä½›åœ¨ç”¨ç¼–ç¨‹è¯­è¨€å†™ä»£ç çš„æ„Ÿè§‰ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse æ—¥æœŸæ—¶é—´çš„ç›¸å…³æ“ä½œå‡½æ•°(åä¸‰)</title>
    <url>/2023/04/11/ClickHouse%20%E6%97%A5%E6%9C%9F%E6%97%B6%E9%97%B4%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0(%E5%8D%81%E4%B8%89)/</url>
    <content><![CDATA[<h1 id="ClickHouse-æ—¥æœŸæ—¶é—´çš„ç›¸å…³æ“ä½œå‡½æ•°-åä¸‰"><a href="#ClickHouse-æ—¥æœŸæ—¶é—´çš„ç›¸å…³æ“ä½œå‡½æ•°-åä¸‰" class="headerlink" title="ClickHouse æ—¥æœŸæ—¶é—´çš„ç›¸å…³æ“ä½œå‡½æ•°(åä¸‰)"></a>ClickHouse æ—¥æœŸæ—¶é—´çš„ç›¸å…³æ“ä½œå‡½æ•°(åä¸‰)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>ä¸‹é¢æ¥è¯´ä¸€è¯´æ—¥æœŸå’Œæ—¶é—´çš„ç›¸å…³æ“ä½œã€‚</strong></p>
<p><strong>toDateã€toDateTimeï¼šå°†å­—ç¬¦ä¸²è½¬æˆ Dateã€DateTime</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> toDate(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>) v1, toDateTime(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>) v2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-11-11 â”‚ 2020-11-11 12:12:12 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- å½“ç„¶é™¤äº†å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ DateTimeã€Date</span></span><br><span class="line"><span class="keyword">WITH</span> toDate(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>) <span class="keyword">AS</span> v1, toDateTime(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>) <span class="keyword">AS</span> v2</span><br><span class="line"><span class="keyword">SELECT</span> v1, v2, toDateTime(v1) v3, toDate(v2) v4;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v2â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v3â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€v4â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-11-11 â”‚ 2020-11-11 12:12:12 â”‚ 2020-11-11 00:00:00 â”‚ 2020-11-11 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å½“ç„¶æ—¶é—´æˆ³ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="keyword">SELECT</span> toDate(<span class="number">1605067932</span>), toDateTime(<span class="number">1605067932</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toDate(1605067932)â”€â”¬â”€toDateTime(1605067932)â”€â”</span></span><br><span class="line"><span class="comment">â”‚         2020-11-11 â”‚    2020-11-11 12:12:12 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯¹äº toDateTime åœ¨è½¬æ¢çš„æ—¶å€™ä¹Ÿå¯ä»¥æŒ‡å®šæ—¶åŒºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Asia/Shanghai ä¸ºä¸œå…«åŒºï¼Œå°† UTC çš„æ—¶é—´è½¬æˆ Asia/Shanghai ä¹‹åï¼Œä¼šå¢åŠ  8 å°æ—¶</span></span><br><span class="line"><span class="keyword">SELECT</span> toDateTime(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>) v1, toDateTime(v1, <span class="string">&#x27;Asia/Shanghai&#x27;</span>) v2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-11-11 12:12:12 â”‚ 2020-11-11 20:12:12 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>timeZoneï¼šè¿”å›å½“å‰æœåŠ¡å™¨æ‰€åœ¨çš„æ—¶åŒº</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> timeZone();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€timeZone()â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ Asia/Shanghai â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toTimeZoneï¼šè½¬æ¢ DataTime æ‰€åœ¨çš„æ—¶åŒº</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è½¬æ¢ DateTime æ‰€åœ¨çš„æ—¶åŒº</span></span><br><span class="line"><span class="keyword">SELECT</span> toDateTime(<span class="string">&#x27;2020-01-01 12:11:33&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>) v1, toTimeZone(v1, <span class="string">&#x27;Asia/Shanghai&#x27;</span>) v2;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€v2â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 12:11:33 â”‚ 2020-01-01 20:11:33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>timeZoneOfï¼šè¿”å› DateTime æ‰€åœ¨çš„æ—¶åŒº</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-01-01 12:11:33&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>) <span class="keyword">AS</span> v1, toTimeZone(v1, <span class="string">&#x27;Asia/Shanghai&#x27;</span>) <span class="keyword">AS</span> v2</span><br><span class="line"><span class="keyword">SELECT</span> timeZoneOf(v1), timeZoneOf(v2);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€timeZoneOf(v1)â”€â”¬â”€timeZoneOf(v2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ UTC            â”‚ Asia/Shanghai  â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>timeZoneOffsetï¼šè¿”å›æŸä¸ªæ—¶åŒºå’Œ UTC ä¹‹é—´çš„åç§»é‡</strong></p>
<p><strong>æ¯”å¦‚ Asia&#x2F;Shanghai å’Œ UTC ä¹‹é—´æŸ¥äº† 8 ä¸ªå°æ—¶ï¼Œä¹Ÿå°±æ˜¯ 8 * 3600 ç§’</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æˆ‘ä»¬éœ€è¦ä½¿ç”¨ timeZoneOffset çš„æ—¶å€™ï¼Œéœ€è¦å…ˆä½¿ç”¨ toTypeName è·å–ç›¸åº”çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-01-01 11:11:11&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toTypeName(v) type, timeZoneOffset(v) offset_second, offset_second <span class="operator">/</span> <span class="number">3600</span> offset_hour;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€typeâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€offset_secondâ”€â”¬â”€offset_hourâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ DateTime(&#x27;Asia/Shanghai&#x27;) â”‚         28800 â”‚           8 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»»ä½•ä¸€ä¸ªå€¼çš„ç±»å‹éƒ½å¯ä»¥é€šè¿‡ toTypeName æŸ¥çœ‹</span></span><br><span class="line"><span class="keyword">SELECT</span> toTypeName(<span class="number">123</span>), toTypeName(<span class="string">&#x27;ä½ å¥½&#x27;</span>), toTypeName([]), toTypeName((<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toTypeName(123)â”€â”¬â”€toTypeName(&#x27;ä½ å¥½&#x27;)â”€â”¬â”€toTypeName(array())â”€â”¬â”€toTypeName((1, 2))â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ UInt8           â”‚ String             â”‚ Array(Nothing)      â”‚ Tuple(UInt8, UInt8) â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toYearï¼šè·å– DateTimeã€Date çš„å¹´ä»½</strong></p>
<p><strong>toMonthï¼šè·å– DateTimeã€Date çš„æœˆä»½</strong></p>
<p><strong>toQuarterï¼šè·å– DateTimeã€Date çš„å­£åº¦</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDate(<span class="string">&#x27;2020-08-21&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toYear(v), toMonth(v), toQuarter(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toYear(v)â”€â”¬â”€toMonth(v)â”€â”¬â”€toQuarter(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚      2020 â”‚          8 â”‚            3 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toHourï¼šè·å– DateTime çš„å°æ—¶</strong></p>
<p><strong>toMinuteï¼šè·å– DateTime çš„åˆ†é’Ÿ</strong></p>
<p><strong>toSecondï¼šè·å– DateTime çš„ç§’</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:11:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toHour(v), toMinute(v), toSecond(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toHour(v)â”€â”¬â”€toMinute(v)â”€â”¬â”€toSecond(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚        12 â”‚          11 â”‚          33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toDayOfYearï¼šè¿”å›æŸä¸ª DateTimeã€Date æ˜¯ä¸€å¹´å½“ä¸­çš„ç¬¬å‡ å¤©ï¼ˆ1 ~ 366ï¼‰</strong></p>
<p><strong>toDayOfMonthï¼šè¿”å›æŸä¸ª DateTimeã€Date æ˜¯ä¸€ä¸ªæœˆå½“ä¸­çš„ç¬¬å‡ å¤©ï¼ˆ1 ~ 31ï¼‰</strong></p>
<p><strong>toDayOfWeekï¼šè¿”å›æŸä¸ª DateTimeã€Date æ˜¯ä¸€å‘¨å½“ä¸­çš„ç¬¬å‡ å¤©ï¼ˆæ˜ŸæœŸä¸€æ˜¯ 1ï¼Œæ˜ŸæœŸå¤©æ˜¯ 7ï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:11:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toDayOfYear(v), toDayOfMonth(v), toDayOfWeek(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toDayOfYear(v)â”€â”¬â”€toDayOfMonth(v)â”€â”¬â”€toDayOfWeek(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚            234 â”‚              21 â”‚              5 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toStartOfYearï¼šè¿”å›ä¸€ä¸ª DateTimeã€Date æ‰€åœ¨çš„å¹´çš„ç¬¬ä¸€å¤©</strong></p>
<p><strong>toStartOfMonthï¼šè¿”å›ä¸€ä¸ª DateTimeã€Date æ‰€åœ¨çš„æœˆçš„ç¬¬ä¸€å¤©</strong></p>
<p><strong>toStartOfQuarterï¼šè¿”å›ä¸€ä¸ª DateTimeã€Date æ‰€åœ¨çš„å­£åº¦çš„ç¬¬ä¸€å¤©</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 2020-08-21 12:22:33 æ‰€åœ¨çš„å¹´çš„ç¬¬ä¸€å¤©æ˜¯ 2020-01-01</span></span><br><span class="line"><span class="comment">-- 2020-08-21 12:22:33 æ‰€åœ¨çš„æœˆçš„ç¬¬ä¸€å¤©æ˜¯ 2020-08-01</span></span><br><span class="line"><span class="comment">-- 2020-08-21 12:22:33 æ‰€åœ¨çš„å­£åº¦çš„ç¬¬ä¸€å¤©æ˜¯ 2020-07-01ï¼Œç¬¬ä¸‰å­£åº¦</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toStartOfYear(v), toStartOfMonth(v), toStartOfQuarter(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toStartOfYear(v)â”€â”¬â”€toStartOfMonth(v)â”€â”¬â”€toStartOfQuarter(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       2020-01-01 â”‚        2020-08-01 â”‚          2020-07-01 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toMondayï¼šè¿”å›ä¸€ä¸ªè·ç¦»æŒ‡å®š DateTimeã€Date æœ€è¿‘çš„æ˜ŸæœŸä¸€</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 2020-08-21 æ˜¯æ˜ŸæœŸäº”ï¼Œæ‰€ä»¥æœ€è¿‘çš„æ˜ŸæœŸä¸€æ˜¯ 2020-08-17</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> toDayOfWeek(v), toMonday(v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toDayOfWeek(v)â”€â”¬â”€toMonday(v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚              5 â”‚  2020-08-17 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>dateTruncï¼šå°† DateTime æŒ‰ç…§æŒ‡å®šéƒ¨åˆ†è¿›è¡Œæˆªæ–­ï¼Œæˆªæ–­åçš„éƒ¨åˆ†ä½¿ç”¨ 0 å¡«å……</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡ŒæŒ‰å°æ—¶æˆªæ–­ï¼Œæˆªæ–­åçš„éƒ¨åˆ†ç›´æ¥ä¸¢å¼ƒæˆ–è€…ç”¨ 0 å¡«å……ï¼Œæ‰€ä»¥ä¼šå¾—åˆ° 2020-08-21 12:00:00</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> v, dateTrunc(<span class="string">&#x27;hour&#x27;</span>, v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”¬â”€dateTrunc(&#x27;hour&#x27;, v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-08-21 12:22:33 â”‚  2020-08-21 12:00:00 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ€»å…±å¯ä»¥æŒ‰ç…§ yearã€quarterã€monthã€weekã€dayã€hourã€minuteã€second è¿›è¡Œæˆªæ–­</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> dateTrunc(<span class="string">&#x27;year&#x27;</span>, v) year_trunc, </span><br><span class="line">       dateTrunc(<span class="string">&#x27;month&#x27;</span>, v) month_trunc, </span><br><span class="line">       dateTrunc(<span class="string">&#x27;quarter&#x27;</span>, v) quarter_trunc,</span><br><span class="line">       dateTrunc(<span class="string">&#x27;day&#x27;</span>, v) day_truc, </span><br><span class="line">       dateTrunc(<span class="string">&#x27;minute&#x27;</span>, v) minute_trunc</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€year_truncâ”€â”¬â”€month_truncâ”€â”¬â”€quarter_truncâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€day_trucâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€minute_truncâ”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01 â”‚  2020-08-01 â”‚    2020-07-01 â”‚ 2020-08-21 00:00:00 â”‚ 2020-08-21 12:22:00 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>dateAddã€dateSubï¼šç»™ DateTimeã€Date åŠ &#x2F;å‡ ä¸€ä¸ªæ—¶é—´é—´éš”</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2017-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> v, dateAdd(<span class="keyword">YEAR</span>, <span class="number">3</span>, v), dateAdd(<span class="keyword">YEAR</span>, <span class="number">-3</span>, v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”¬â”€plus(v, toIntervalYear(3))â”€â”¬â”€plus(v, toIntervalYear(-3))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2017-08-21 12:22:33 â”‚        2020-08-21 12:22:33 â”‚         2014-08-21 12:22:33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>dateSub çš„ç”¨æ³•ä¸ä¹‹ä¸€æ ·ï¼Œå…¶å®å½“ dateAdd åŠ çš„æ—¶é—´é—´éš”ä¸ºè´Ÿæ•°æ—¶ï¼Œç­‰åŒäº dateSubã€‚æ—¶é—´é—´éš”çš„å•ä½å¯ä»¥æ˜¯ yearã€quarterã€monthã€weekã€dayã€hourã€minuteã€secondï¼Œå¹¶ä¸”é™¤äº†ä½¿ç”¨å‡½æ•°ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç›¸åŠ ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--  v + INTERVAL 3 YEAR ç­‰ä»·äº  v - INTERVAL -3 YEAR</span></span><br><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2017-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> v, v <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">3</span> <span class="keyword">YEAR</span>, v <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">-3</span> <span class="keyword">YEAR</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€vâ”€â”¬â”€plus(v, toIntervalYear(3))â”€â”¬â”€plus(v, toIntervalYear(-3))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2017-08-21 12:22:33 â”‚        2020-08-21 12:22:33 â”‚         2014-08-21 12:22:33 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>dataDiffï¼šè®¡ç®—ä¸¤ä¸ª DateTimeã€Date çš„å·®å€¼</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2017-08-21 12:22:33&#x27;</span>) <span class="keyword">AS</span> v1, toDateTime(<span class="string">&#x27;2018-09-15 11:44:55&#x27;</span>) <span class="keyword">AS</span> v2</span><br><span class="line"><span class="keyword">SELECT</span> dateDiff(<span class="string">&#x27;YEAR&#x27;</span>, v1, v2), dateDiff(<span class="string">&#x27;MONTH&#x27;</span>, v1, v2), dateDiff(<span class="string">&#x27;HOUR&#x27;</span>, v1, v2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€dateDiff(&#x27;YEAR&#x27;, v1, v2)â”€â”¬â”€dateDiff(&#x27;MONTH&#x27;, v1, v2)â”€â”¬â”€dateDiff(&#x27;HOUR&#x27;, v1, v2)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                        1 â”‚                        13 â”‚                     9359 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>nowï¼šè¿”å›å½“å‰çš„ DateTime</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é»˜è®¤æ˜¯æœ¬åœ°æ—¶åŒºï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®š</span></span><br><span class="line"><span class="keyword">SELECT</span> now(), now(<span class="string">&#x27;Asia/Shanghai&#x27;</span>), now(<span class="string">&#x27;UTC&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now()â”€â”¬â”€now(&#x27;Asia/Shanghai&#x27;)â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€now(&#x27;UTC&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2021-09-07 12:27:31 â”‚  2021-09-07 12:27:31 â”‚ 2021-09-07 04:27:31 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>todayï¼šè¿”å›å½“å‰çš„ Dateï¼Œç±»ä¼¼äº toDate( now() )</strong></p>
<p><strong>yesterdayï¼šå‰ä¸€å¤©ï¼Œç±»ä¼¼äº today() - INTERVAL 1 DAY</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> today(), yesterday(), today() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€today()â”€â”¬â”€yesterday()â”€â”¬â”€minus(today(), toIntervalDay(1))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2021-09-07 â”‚  2021-09-06 â”‚                       2021-09-06 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toYYYYMMï¼šå°† DateTimeã€Date ä½¿ç”¨æ•´å‹è¡¨ç¤ºï¼Œä¿ç•™åˆ°æœˆ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> toYYYYMM(toDate(<span class="string">&#x27;2020-11-11&#x27;</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toYYYYMM(toDate(&#x27;2020-11-11&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                         202011 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŒç†è¿˜æœ‰ toYYYYMMDD å’Œ toYYYYMMDDhhmmss</span></span><br><span class="line"><span class="keyword">SELECT</span> toYYYYMMDD(toDate(<span class="string">&#x27;2020-11-11&#x27;</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toYYYYMMDD(toDate(&#x27;2020-11-11&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                         20201111 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> toYYYYMMDDhhmmss(toDateTime(<span class="string">&#x27;2020-11-11 12:12:12&#x27;</span>));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toYYYYMMDDhhmmss(toDateTime(&#x27;2020-11-11 12:12:12&#x27;))â”€â”</span></span><br><span class="line"><span class="comment">â”‚                                      20201111121212 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>formatDateTimeï¼šè®²ä¸€ä¸ª DateTimeã€Date æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> formatDateTime(toDateTime(<span class="string">&#x27;2020-01-01 11:11:11&#x27;</span>), <span class="string">&#x27;%F&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€formatDateTime(toDateTime(&#x27;2020-01-01 11:11:11&#x27;), &#x27;%F&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020-01-01                                              â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> formatDateTime(toDateTime(<span class="string">&#x27;2020-01-01 11:11:11&#x27;</span>), <span class="string">&#x27;%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€formatDateTime(toDateTime(&#x27;2020-01-01 11:11:11&#x27;), &#x27;%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020å¹´01æœˆ01æ—¥ 11æ—¶11åˆ†11ç§’                                                    â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>å‡½æ•°ä¸éš¾ï¼Œä¸»è¦æ˜¯ä¸€äº›æ ¼å¼ç¬¦å·æˆ‘ä»¬éœ€è¦è®°å¿†ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ ¼å¼ç¬¦å·ï¼š</strong></p>
<ul>
<li><code>%Y: å¯¹åº”å¹´</code></li>
<li><code>%m: å¯¹åº”æœˆï¼Œ01 ~ 12</code></li>
<li><code>%d: å¯¹åº”å¤©ï¼Œ01 ~ 31</code></li>
<li><code>%H: å¯¹åº”å°æ—¶ï¼Œ00 ~ 23</code></li>
<li><code>%M: å¯¹åº”åˆ†é’Ÿï¼Œ00 ~ 59</code></li>
<li><code>%S: å¯¹åº”ç§’é’Ÿï¼Œ00 ~ 59</code></li>
<li><code>%F: å¯¹åº”å¹´æœˆæ—¥ï¼Œç›¸å½“äº %Y-%m-%d</code></li>
<li><code>%j: ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©ï¼Œ001 ~ 366</code></li>
<li><code>%P: å¯¹åº”ä¸Šåˆè¿˜æ˜¯ä¸‹åˆ</code></li>
<li><code>%Q: å¯¹åº”å­£åº¦ï¼Œ1 ~ 4</code></li>
<li><code>%R: ç›¸å½“äº %H:%M</code></li>
<li><code>%u: æ˜ŸæœŸå‡ ï¼Œ1 ~ 7</code></li>
<li><code>%V: ä¸€å¹´ä¸­çš„ç¬¬å‡ ä¸ªæ˜ŸæœŸï¼Œ01 ~ 53</code></li>
</ul>
<p><strong>dateNameï¼šè¿”å› DateTime æŒ‡å®šéƒ¨åˆ†ï¼Œå¾—åˆ°çš„æ˜¯å­—ç¬¦ä¸²</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> toDateTime(<span class="string">&#x27;2020-09-17 11:22:33&#x27;</span>) <span class="keyword">AS</span> v</span><br><span class="line"><span class="keyword">SELECT</span> dateName(<span class="string">&#x27;year&#x27;</span>, v), dateName(<span class="string">&#x27;month&#x27;</span>, v), dateName(<span class="string">&#x27;quarter&#x27;</span>, v);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€dateName(&#x27;year&#x27;, v)â”€â”¬â”€dateName(&#x27;month&#x27;, v)â”€â”¬â”€dateName(&#x27;quarter&#x27;, v)â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 2020                â”‚ September            â”‚ 3                      â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>FROM_UNIXTIMEï¼šå°†ä¸€ä¸ªæ—¶é—´æˆ³è½¬æˆæ—¶é—´</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é»˜è®¤è½¬æ¢çš„æ ¼å¼æ˜¯ å¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šæ ¼å¼</span></span><br><span class="line"><span class="keyword">SELECT</span> FROM_UNIXTIME(<span class="number">1600312953</span>), FROM_UNIXTIME(<span class="number">1600312953</span>, <span class="string">&#x27;%F %R&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€FROM_UNIXTIME(1600312953)â”€â”¬â”€FROM_UNIXTIME(1600312953, &#x27;%F %R&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚       2020-09-17 11:22:33 â”‚ 2020-09-17 11:22                   â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>toUnixTimestampï¼šå°†ä¸€ä¸ª DateTimeã€Date è½¬æˆæ—¶é—´æˆ³</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é‡Œé¢é™¤äº†å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¼ é€’ DateTimeã€Date</span></span><br><span class="line"><span class="keyword">SELECT</span> toUnixTimestamp(<span class="string">&#x27;2020-09-17 11:22:33&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€toUnixTimestamp(&#x27;2020-09-17 11:22:33&#x27;)â”€â”</span></span><br><span class="line"><span class="comment">â”‚                             1600312953 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŒæ—¶ä¹Ÿå¯ä»¥æŒ‡å®šæ—¶åŒºï¼Œé»˜è®¤ä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼Œ</span></span><br><span class="line"><span class="comment">-- UTC æ—¶åŒºçš„ 2020-09-17 11:22:33 ç›¸å½“äº Asia/Shanghai æ—¶åŒºçš„ 2020-09-17 19:22:33 </span></span><br><span class="line"><span class="keyword">SELECT</span> toUnixTimestamp(<span class="string">&#x27;2020-09-17 11:22:33&#x27;</span>, <span class="string">&#x27;UTC&#x27;</span>) v1, <span class="number">1600312953</span> <span class="operator">+</span> <span class="number">8</span> <span class="operator">*</span> <span class="number">3600</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€v1â”€â”¬â”€plus(1600312953, multiply(8, 3600))â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1600341753 â”‚                          1600341753 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„åŸºæœ¬ä»‹ç»(ä¸€)</title>
    <url>/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„åŸºæœ¬ä»‹ç»-ä¸€"><a href="#ClickHouse-çš„åŸºæœ¬ä»‹ç»-ä¸€" class="headerlink" title="ClickHouse çš„åŸºæœ¬ä»‹ç»(ä¸€)"></a>ClickHouse çš„åŸºæœ¬ä»‹ç»(ä¸€)</h1><p>â€‹													</p>
<h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><blockquote>
<p><strong>æœ€è¿‘å…¬å¸å†³å®šé‡‡ç”¨ ClickHouse æ¥åšæ•°æ®çš„å¤§è§„æ¨¡å¤„ç†ï¼Œå…³äº ClickHouse è™½ç„¶æ—©æœ‰è€³é—»ï¼Œä½†å› ä¸ºæ—¶é—´åŸå› å¹¶æ²¡æœ‰ä¸“é—¨å»å­¦ä¹ ã€‚è€Œå…¬å¸ä¹Ÿè€ƒè™‘åˆ°ç›®å‰å†…éƒ¨å…·æœ‰ ClickHouse ä½¿ç”¨ç»éªŒçš„äººè¿˜ä¸æ˜¯å¾ˆå¤šï¼Œå› æ­¤ç»™äº†ç›¸å¯¹æ¯”è¾ƒå……è¶³çš„æ—¶é—´å»äº†è§£ã€‚è™½ç„¶ ClickHouse è¯ç”Ÿäº 2016 å¹´ï¼Œä½†ç›¸å¯¹äº Hadoop ç”Ÿæ€åœˆè€Œè¨€ï¼Œæ™®åŠåº¦æ˜¾ç„¶è¿˜æ²¡æœ‰é‚£ä¹ˆå¹¿ï¼Œå› æ­¤é™¤äº†å®˜ç½‘ä¹‹å¤–è¿˜æ²¡æœ‰çœ‹åˆ°æ¯”è¾ƒåˆé€‚çš„æ•™ç¨‹ã€‚ä¸è¿‡å¹¸è¿çš„æ˜¯åœ¨äº¬ä¸œä¸Šé¢å‘ç°äº†ä¸€æœ¬å…³äº ClickHouse çš„ä¹¦ï¼Œå«ã€ŠClickHouse åŸç†è§£æä¸åº”ç”¨å®è·µã€‹ï¼Œç”±æœ±å‡¯è€å¸ˆç¼–å†™ï¼Œæ®æ‚‰è¿™æ˜¯ç¬¬ä¸€æœ¬è®²è§£ ClickHouse çš„ä¹¦ã€‚çœ‹äº†ä¸€ä¸‹ç›®å½•ï¼Œæ„Ÿè§‰å†…å®¹è¿˜æ˜¯æ¯”è¾ƒå……å®çš„ï¼Œäºæ˜¯æœæ–­ä¹°ä¸‹æ¥ï¼Œç”¨äºå­¦ä¹ ã€‚</strong></p>
<p><strong>å› æ­¤æœ¬æ–‡å¾ˆå¤šå†…å®¹å‡æ¥è‡ªäºæ­¤ä¹¦ï¼Œåªä¸è¿‡ä¹¦ä¸­çš„ ClickHouse ç‰ˆæœ¬æœ‰äº›ä½äº†ï¼ˆClickHouse çš„å‘å¸ƒé¢‘ç‡è¿˜æ˜¯æŒºå¿«çš„ï¼‰ï¼Œè¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œå› æ­¤å®‰è£…æ—¶çš„ç»†èŠ‚ä¼šæœ‰äº›ä¸åŒã€‚é‚£ä¹ˆä¸‹é¢å°±å¼€å§‹ ClickHouse çš„å­¦ä¹ ä¹‹æ—…å§ï¼Œçœ‹çœ‹ ClickHouse ç©¶ç«Ÿæ˜¯ä½•æ–¹ç¥åœ£ï¼Œä¸ºä½•èƒ½å¤Ÿå¼‚å†›çªèµ·ã€‚</strong></p>
</blockquote>
<p><strong>Google äº 2003~2006 å¹´ç›¸ç»§å‘è¡¨äº†ä¸‰ç¯‡è®ºæ–‡ï¼šâ€Google File Systemâ€ã€â€Google MapReduceâ€ã€â€Google Bigtableâ€ï¼Œå°†å¤§æ•°æ®çš„å¤„ç†æŠ€æœ¯å¸¦è¿›äº†å¤§ä¼—è§†é‡ï¼Œè€Œ 2006 å¹´å¼€æºé¡¹ç›® Hadoop çš„å‡ºç°ï¼Œåˆ™æ ‡å¿—ç€å¤§æ•°æ®å¤„ç†æŠ€æœ¯æ™®åŠçš„å¼€å§‹ï¼Œå¤§æ•°æ®æŠ€æœ¯çœŸæ­£å¼€å§‹èµ°å‘å¤§ä¼—ã€‚Hadoop æœ€åˆæŒ‡çš„æ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ HDFS å’Œ MapReduce è®¡ç®—æ¡†æ¶ï¼Œä½†æ˜¯å®ƒä¸€è·¯é«˜æ­ŒçŒ›è¿›ï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šåƒæ­ç§¯æœ¨ä¸€æ ·å¿«é€Ÿå‘å±•æˆä¸ºä¸€ä¸ªåºå¤§çš„ç”Ÿæ€ï¼ˆè¢«ç§°ä¸º Hadoop ç”Ÿæ€åœˆï¼‰ï¼Œå…¶ä¸­åŒ…æ‹¬ Hiveã€HBaseã€Spark ç­‰æ•°åç§æ¡†æ¶ã€‚è€Œåœ¨å¤§æ•°æ®åˆ†æåœºæ™¯çš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“å¾ˆå¿«å°±è¢« Hadoop ç”Ÿæ€åœˆæ‰€å–ä»£ï¼ŒBI é¢†åŸŸå°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚åƒä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“æ‰€æ„å»ºçš„æ•°æ®ä»“åº“ï¼Œå°±è¢«ä»¥ Hive ä¸ºä»£è¡¨çš„å¤§æ•°æ®æŠ€æœ¯æ‰€å–ä»£ï¼Œæ•°æ®æŸ¥è¯¢åˆ†æçš„æ‰‹æ®µæ›´æ˜¯å±‚å‡ºä¸ç©·ï¼ŒSparkã€Impalaã€Kylin ç­‰æ¡†æ¶ç™¾èŠ±é½æ”¾ã€‚Hadoop å‘å±•è‡³ä»Šï¼Œæ—©å·²ä¸Šå‡æˆä¸ºå¤§æ•°æ®çš„ä»£åè¯ï¼Œä»¿ä½›ä¸€æåˆ°æµ·é‡æ•°æ®åˆ†æåœºæ™¯ä¸‹çš„æŠ€æœ¯é€‰å‹ï¼Œå°±é Hadoop ç”Ÿæ€è«å±ã€‚</strong></p>
<p><strong>ç„¶è€Œä¸–é—´å¹¶æ²¡æœ‰é“¶å¼¹ï¼ˆä¸‡å…¨ä¹‹ç­–ï¼‰ï¼ŒHadoop ä¹Ÿè·³ä¸å‡ºè¿™ä¸ªè§„åˆ™ã€‚è™½ç„¶ Hadoop ç”Ÿæ€åœˆå·²ç»ç›¸å½“å®Œå–„äº†ï¼Œä¸åŒçš„ç»„ä»¶ä¹Ÿå¯ä»¥ç›¸äº’å¯¹æ¥ï¼Œä¾‹å¦‚åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ HDFS å¯ä»¥ç›´æ¥ä½œä¸ºå…¶ä»–ç»„ä»¶çš„åº•å±‚å­˜å‚¨ï¼ˆåƒ HBaseã€Hive ç­‰ï¼‰ï¼Œç”Ÿæ€å†…éƒ¨çš„ç»„ä»¶ä¹‹é—´ä¸ç”¨é‡å¤é€ è½®å­ï¼Œåªéœ€ç›¸äº’å€ŸåŠ›ã€ç»„åˆå°±èƒ½å½¢æˆæ–°çš„æ–¹æ¡ˆã€‚ä½†ç”Ÿæ€åŒ–çš„å¦ä¸€é¢åˆ™å¯ä»¥çœ‹åšè‡ƒè‚¿å’Œå¤æ‚ï¼ŒHadoop ç”Ÿæ€ä¸‹æ¯ç§ç»„ä»¶éƒ½è‡ªæˆä¸€ä½“ã€ç›¸äº’ç‹¬ç«‹ï¼Œè¿™ç§å¼ºå¼ºç»„åˆçš„æŠ€æœ¯ç»„ä»¶æœ‰äº›æ—¶å€™åˆ™æ˜¾å¾—è¿‡äºç¬¨é‡äº†ã€‚ä¸æ­¤åŒæ—¶ï¼Œéšç€ç°ä»£åŒ–ç»ˆç«¯ç³»ç»Ÿå¯¹å®æ—¶æ€§çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼ŒHadoop ç”Ÿæ€åœ¨æµ·é‡æ•°æ®å’Œé«˜æ—¶æ•ˆæ€§çš„åŒé‡å‹åŠ›ä¸‹ï¼Œä¹Ÿæ˜¾å¾—æœ‰äº›åŠ›ä¸ä»å¿ƒäº†ã€‚</strong></p>
<p><strong>è€Œè¿™ä¸ªæ—¶å€™ï¼ŒClickHouseå‡ºç°äº†ï¼Œå®ƒæ˜¯ä¿„ç½—æ–¯çš„ Yandex å…¬å¸äº 2016 å¹´å¼€æºçš„åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼Œä½¿ç”¨ C++ è¯­è¨€ç¼–å†™ï¼Œä¸“é—¨ç”¨äº OLAPï¼ˆè”æœºåˆ†æå¤„ç†ï¼‰ï¼Œå…¶æƒŠäººçš„æ€§èƒ½å¯ä»¥ç¬é—´è®©ä½ è·ªå€’åœ¨å®ƒçš„çŸ³æ¦´è£™ä¸‹ã€‚</strong></p>
<h2 id="ä»€ä¹ˆæ˜¯-OLAPï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-OLAPï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ OLAPï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ OLAPï¼Ÿ</h2><p><strong>è¿™é‡Œå…ˆå›é¡¾ä¸€ä¸‹ä»€ä¹ˆæ˜¯ OLAPï¼Œä»¥åŠå®ç° OLAP çš„å‡ ç§å¸¸è§æ€è·¯ã€‚</strong></p>
<p><strong>å‰é¢è¯´äº†ï¼ŒOLAP åä¸ºè”æœºåˆ†æå¤„ç†ï¼Œåˆå¯ä»¥ç§°ä¹‹ä¸ºå¤šç»´åˆ†æå¤„ç†ï¼Œæ˜¯ç”±å…³ç³»å‹æ•°æ®ä¹‹çˆ¶äº 1993 å¹´æå‡ºçš„æ¦‚å¿µã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒæŒ‡çš„æ˜¯é€šè¿‡å¤šç§ä¸åŒçš„ç»´åº¦å®¡è§†æ•°æ®ï¼Œè¿›è¡Œæ·±å±‚æ¬¡åˆ†æã€‚ç»´åº¦å¯ä»¥çœ‹æˆæ˜¯è§‚å¯Ÿæ•°æ®çš„ä¸€ç§è§†è§’ï¼Œä¾‹å¦‚äººç±»èƒ½çœ‹åˆ°çš„ä¸–ç•Œæ˜¯ä¸‰ç»´çš„ï¼Œå®ƒåŒ…å«é•¿ã€å®½ã€é«˜ä¸‰ä¸ªç»´åº¦ã€‚ç›´æ¥ä¸€ç‚¹ç†è§£ï¼Œç»´åº¦å°±å¥½æ¯”æ˜¯ä¸€å¼ æ•°æ®è¡¨çš„å­—æ®µï¼Œè€Œå¤šç»´åˆ†æåˆ™æ˜¯åŸºäºè¿™äº›å­—æ®µè¿›è¡ŒèšåˆæŸ¥è¯¢ã€‚é‚£ä¹ˆå¤šç»´åˆ†æé€šå¸¸éƒ½åŒ…å«å“ªäº›åŸºæœ¬æ“ä½œå‘¢ï¼Ÿä¸ºäº†æ›´å¥½åœ°ç†è§£å¤šç»´åˆ†æçš„æ¦‚å¿µï¼Œå¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªç«‹æ–¹ä½“çš„å›¾åƒè¿›è¡Œå…·è±¡åŒ–æ¥æè¿°ã€‚ä»¥å¦‚ä¸‹ä¸€å¼ é”€å”®æ˜ç»†è¡¨ä¸ºä¾‹ï¼š</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132202666-1270926469.png" alt="img"></p>
<p><strong>é‚£ä¹ˆæ•°æ®ç«‹æ–¹ä½“å¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</strong></p>
<p><strong>ä¸‹é’»ï¼šä»é«˜å±‚æ¬¡å‘ä½å±‚æ¬¡æ˜ç»†æ•°æ®è¿›è¡Œç©¿é€ã€‚ä¾‹å¦‚ä» â€œçœâ€ ä¸‹é’»åˆ° â€œå¸‚â€ï¼Œä» â€œæ¹–åŒ—çœâ€ ç©¿é€åˆ° â€œæ­¦æ±‰â€ å’Œ â€œå®œæ˜Œâ€ ã€‚</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132210489-1492902232.png" alt="img"></p>
<p><strong>ä¸Šå·ï¼šå’Œä¸‹é’»ç›¸åï¼Œä»ä½å±‚æ¬¡å‘é«˜å±‚æ¬¡æ±‡èšã€‚ä¾‹å¦‚ä» â€œå¸‚â€ æ±‡èšåˆ° â€œçœâ€ï¼Œå°† â€œæ­¦æ±‰â€ å’Œ â€œå®œæ˜Œâ€ æ±‡èšæˆ â€œæ¹–åŒ—â€ã€‚</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132216589-314917835.png" alt="img"></p>
<p><strong>åˆ‡ç‰‡ï¼šè§‚å¯Ÿç«‹æ–¹ä½“çš„ä¸€å±‚ï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ªæ¸©åº¦è®¾ä¸ºå•ä¸ªå›ºå®šçš„å€¼ï¼Œç„¶åè§‚å¯Ÿå‰©ä½™çš„ç»´åº¦ï¼Œä¾‹å¦‚å°†å•†å“ç»´åº¦å›ºå®šä¸º â€œè¶³çƒâ€ã€‚</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132222084-206492651.png" alt="img"></p>
<p><strong>åˆ‡å—ï¼šå’Œåˆ‡ç‰‡ç±»ä¼¼ï¼Œåªæ˜¯å°†å•ä¸ªå›ºå®šå€¼å˜æˆå¤šä¸ªå›ºå®šå€¼ã€‚ä¾‹å¦‚å°†å•†å“ç»´åº¦å›ºå®šä¸ºâ€è¶³çƒâ€ã€â€ç¯®çƒâ€ å’Œ â€œä¹’ä¹“çƒâ€ã€‚</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132228079-1585593282.png" alt="img"></p>
<p><strong>æ—‹è½¬ï¼šæ—‹è½¬ç«‹æ–¹ä½“çš„ä¸€é¢ï¼Œå¦‚æœè¦å°†æ•°æ®æ˜ å°„åˆ°ä¸€å¼ äºŒç»´è¡¨ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡Œæ—‹è½¬ï¼Œç­‰åŒäºè¡Œåˆ—è½¬æ¢ã€‚</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012132234073-1799091680.png" alt="img"></p>
<h3 id="OLAP-æ¶æ„åˆ†ç±»"><a href="#OLAP-æ¶æ„åˆ†ç±»" class="headerlink" title="OLAP æ¶æ„åˆ†ç±»"></a>OLAP æ¶æ„åˆ†ç±»</h3><p><strong>ä¸ºäº†å®ç°ä¸Šè¿°æ“ä½œï¼Œå°†å¸¸è§çš„ OLAP æ¶æ„å¤§è‡´åˆ†ä¸ºä¸‰ç±»ã€‚</strong></p>
<p><strong>ç¬¬ä¸€ç±»æ¶æ„ç§°ä¸º ROLAPï¼ˆRelational OLAPï¼Œå…³ç³»å‹ OLAPï¼‰ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒç›´æ¥ä½¿ç”¨å…³ç³»æ¨¡å‹æ„å»ºï¼Œæ•°æ®æ¨¡å‹å¸¸ä½¿ç”¨æ˜Ÿå‹æ¨¡å‹æˆ–è€…é›ªèŠ±æ¨¡å‹ï¼Œè¿™æ˜¯æœ€å…ˆèƒ½å¤Ÿæƒ³åˆ°ã€ä¹Ÿæ˜¯æœ€ä¸ºç›´æ¥çš„å®ç°æ–¹æ³•ã€‚</strong></p>
<blockquote>
<p><strong>æ˜Ÿå‹æ¨¡å‹ï¼šäº‹å®è¡¨å‘¨å›´çš„ç»´åº¦è¡¨åªèƒ½æœ‰ä¸€å±‚ï¼›é›ªèŠ±æ¨¡å‹ï¼šäº‹å®è¡¨å‘¨å›´çš„ç»´åº¦è¡¨å¯ä»¥æœ‰å¤šå±‚ã€‚</strong></p>
</blockquote>
<p><strong>å› ä¸º OLAP æ¦‚å¿µåœ¨æœ€åˆæå‡ºçš„æ—¶å€™ï¼Œå°±æ˜¯å»ºç«‹åœ¨å…³ç³»å‹æ•°æ®åº“ä¹‹ä¸Šçš„ï¼Œå¤šç»´åˆ†æçš„æ“ä½œå¯ä»¥ç›´æ¥è½¬æˆ SQL æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ä¸Šå·æ“ä½œæŸ¥çœ‹çœä»½çš„é”€å”®é¢ï¼Œå°±å¯ä»¥è½¬æˆç±»ä¼¼ä¸‹é¢çš„ SQL è¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(ä»·æ ¼) <span class="keyword">FROM</span> é”€å”®æ•°æ®è¡¨ <span class="keyword">GROUP</span> <span class="keyword">BY</span> çœ;</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯è¿™ç§æ¶æ„å¯¹æ•°æ®çš„å®æ—¶å¤„ç†èƒ½åŠ›è¦æ±‚å¾ˆé«˜ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœå¯¹ä¸€å¼ å­˜æœ‰ä¸Šäº¿æ¡è®°å½•çš„è¡¨åŒæ—¶æ‰§è¡Œæ•°åä¸ªå­—æ®µçš„GROUP BYæŸ¥è¯¢ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Ÿ</strong></p>
<p><strong>ç¬¬äºŒç±»æ¶æ„ç§°ä¸º MOLAPï¼ˆMultidimensional OLAPï¼Œå¤šç»´å‹ OLAPï¼‰ï¼Œå®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†ç¼“è§£ ROLAP æ€§èƒ½é—®é¢˜ã€‚</strong></p>
<p><strong>MOLAP ä½¿ç”¨å¤šç»´æ•°ç»„çš„å½¢å¼ä¿å­˜æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å€ŸåŠ©é¢„å…ˆèšåˆç»“æœï¼ˆè¯´ç™½äº†å°±æ˜¯æå‰å…ˆç®—å¥½ï¼Œç„¶åå°†ç»“æœä¿å­˜èµ·æ¥ï¼‰ï¼Œä½¿ç”¨ç©ºé—´æ¢å–æ—¶é—´çš„å½¢å¼ä»è€Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´æ¢å¾—æŸ¥è¯¢æ—¶é—´çš„å‡å°‘ï¼Œå…¶å…·ä½“çš„å®ç°æ–¹å¼æ˜¯ä¾æ‰˜ç«‹æ–¹ä½“æ¨¡å‹çš„æ¦‚å¿µã€‚é¦–å…ˆï¼Œå¯¹éœ€è¦åˆ†æçš„æ•°æ®è¿›è¡Œå»ºæ¨¡ï¼Œæ¡†å®šéœ€è¦åˆ†æçš„ç»´åº¦å­—æ®µï¼›ç„¶åï¼Œé€šè¿‡é¢„å¤„ç†çš„å½¢å¼ï¼Œå¯¹å„ç§ç»´åº¦è¿›è¡Œç»„åˆå¹¶äº‹å…ˆèšåˆï¼›æœ€åï¼Œå°†èšåˆç»“æœä»¥æŸç§ç´¢å¼•æˆ–è€…ç¼“å­˜çš„å½¢å¼ä¿å­˜èµ·æ¥ï¼ˆé€šå¸¸åªä¿ç•™èšåˆåçš„ç»“æœï¼Œä¸å­˜å‚¨æ˜ç»†æ•°æ®ï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨éšåçš„æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ç»“æœè¿”å›æ•°æ®ã€‚</strong></p>
<p><strong>ä½†æ˜¯è¿™ç§æ¶æ„æ˜¾ç„¶å¹¶ä¸å®Œç¾ï¼ŒåŸå› å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><strong>é¢„èšåˆåªèƒ½æ”¯æŒå›ºå®šçš„åˆ†æåœºæ™¯ï¼Œæ‰€ä»¥å®ƒæ— æ³•æ»¡è¶³è‡ªå®šä¹‰åˆ†æçš„éœ€æ±‚ã€‚</strong></li>
<li><strong>ç»´åº¦çš„é¢„å¤„ç†ä¼šå¯¼è‡´æ•°æ®è†¨èƒ€ï¼Œè¿™é‡Œå¯ä»¥åšä¸€æ¬¡ç®€å•çš„è®¡ç®—ï¼Œä»¥ä¸Šé¢çš„é”€å”®æ˜ç»†è¡¨ä¸ºä¾‹ï¼Œå¦‚æœæ•°æ®ç«‹æ–¹ä½“åŒ…å«äº† 5 ä¸ªç»´åº¦ï¼ˆå­—æ®µï¼‰ï¼Œé‚£ä¹ˆç»´åº¦çš„ç»„åˆæ–¹å¼å°±æœ‰ 2525 ç§ã€‚ç»´åº¦ç»„åˆçˆ†ç‚¸ä¼šå¯¼è‡´æ•°æ®è†¨èƒ€ï¼Œè¿™æ ·ä¼šé€ æˆä¸å¿…è¦çš„è®¡ç®—å’Œå­˜å‚¨å¼€é”€ã€‚æ­¤å¤–ï¼Œç”¨æˆ·å¹¶ä¸ä¸€å®šä¼šç”¨åˆ°æ‰€æœ‰ç»´åº¦çš„ç»„åˆï¼Œé‚£ä¹ˆæ²¡æœ‰è¢«ç”¨åˆ°çš„ç»„åˆå°†ä¼šæµªè´¹ã€‚</strong></li>
<li><strong>å¦å¤–ï¼Œç”±äºä½¿ç”¨äº†é¢„èšåˆçš„æ–¹å¼ï¼Œæ•°æ®ç«‹æ–¹ä½“ä¼šæœ‰ä¸€å®šçš„æ»åæ€§ï¼Œä¸èƒ½å®æ—¶åœ°è¿›è¡Œæ•°æ®åˆ†æã€‚æ‰€ä»¥å¯¹äºåœ¨çº¿å®æ—¶æ¥æ”¶çš„æµé‡æ•°æ®ï¼Œé¢„èšåˆè¿˜éœ€è¦è€ƒè™‘å¦‚ä½•åŠæ—¶æ›´æ–°æ•°æ®ã€‚è€Œä¸”ç«‹æ–¹ä½“åªä¿ç•™äº†èšåˆåçš„ç»“æœæ•°æ®ï¼Œå› æ­¤æ˜ç»†æ•°æ®æ˜¯æ— æ³•æŸ¥è¯¢çš„ã€‚</strong></li>
</ul>
<p><strong>ç¬¬ä¸‰ç±»æ¶æ„ç§°ä¸º HOLAPï¼ˆHybrid OLAPï¼Œæ··åˆæ¶æ„çš„OLAPï¼‰ï¼Œè¿™ç§æ€è·¯å¯ä»¥ç†è§£æˆ ROLAP å’Œ MOLAP ä¸¤è€…çš„ç»„åˆï¼Œè¿™é‡Œä¸å†å±•å¼€ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ ROLAP å’Œ MOLAPã€‚</strong></p>
<h3 id="OLAP-å®ç°æŠ€æœ¯çš„æ¼”è¿›"><a href="#OLAP-å®ç°æŠ€æœ¯çš„æ¼”è¿›" class="headerlink" title="OLAP å®ç°æŠ€æœ¯çš„æ¼”è¿›"></a>OLAP å®ç°æŠ€æœ¯çš„æ¼”è¿›</h3><p><strong>åœ¨ä»‹ç»äº† OLAP å‡ ç§ä¸»è¦çš„æ¶æ„ä¹‹åï¼Œå†æ¥çœ‹çœ‹å®ƒä»¬èƒŒåæŠ€æœ¯çš„æ¼”è¿›è¿‡ç¨‹ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ¼”è¿›è¿‡ç¨‹åˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</strong></p>
<p><strong>ç¬¬ä¸€ä¸ªå¯ä»¥ç§°ä¸ºä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“é˜¶æ®µã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒOLAP ä¸»è¦åŸºäºä»¥ Oracleã€MySQL ä¸ºä»£è¡¨çš„ä¸€ç§å…³ç³»å‹æ•°æ®åº“å®ç°ã€‚åœ¨ ROLA Pæ¶æ„ä¸‹ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®ä½œä¸ºå­˜å‚¨ä¸è®¡ç®—çš„è½½ä½“ï¼›åœ¨ MOLAP æ¶æ„ä¸‹ï¼Œåˆ™å€ŸåŠ©ç‰©åŒ–è§†å›¾çš„æ–¹å¼å®ç°æ•°æ®ç«‹æ–¹ä½“ã€‚åœ¨è¿™ä¸ªæ—¶æœŸï¼Œä¸è®ºæ˜¯ ROLAP è¿˜æ˜¯ MOLAPï¼Œåœ¨æ•°æ®ä½“é‡å¤§ã€ç»´åº¦æ•°ç›®å¤šçš„æƒ…å†µä¸‹éƒ½å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œç”šè‡³å­˜åœ¨æ ¹æœ¬æŸ¥è¯¢ä¸å‡ºç»“æœçš„æƒ…å†µã€‚</strong></p>
<p><strong>ç¬¬äºŒä¸ªé˜¶æ®µå¯ä»¥ç§°ä¸ºå¤§æ•°æ®æŠ€æœ¯é˜¶æ®µã€‚ç”±äºå¤§æ•°æ®æŠ€æœ¯çš„æ™®åŠï¼Œäººä»¬å¼€å§‹ä½¿ç”¨å¤§æ•°æ®æŠ€æœ¯é‡æ„ ROLAP å’Œ MOLAPã€‚ä»¥ ROLAP æ¶æ„ä¸ºä¾‹ï¼Œä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“å°±è¢« Hive å’Œ SparkSQL è¿™ç±»æ–°å…´æŠ€æœ¯æ‰€å–ä»£ã€‚è™½ç„¶ï¼Œä»¥ Spark ä¸ºä»£è¡¨çš„åˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿï¼Œç›¸æ¯” Oracle è¿™ç±»ä¼ ç»Ÿæ•°æ®åº“è€Œè¨€ï¼Œåœ¨é¢å‘æµ·é‡æ•°æ®çš„å¤„ç†æ€§èƒ½æ–¹é¢å·²ç»ä¼˜ç§€å¾ˆå¤šï¼Œä½†æ˜¯ç›´æ¥æŠŠå®ƒä»¬ä½œä¸ºé¢å‘ç»ˆç«¯ç”¨æˆ·çš„åœ¨çº¿æŸ¥è¯¢ç³»ç»Ÿåˆ™è¿˜æ˜¯å¤ªæ…¢äº†ã€‚æˆ‘ä»¬çš„ç”¨æˆ·æ™®éç¼ºä¹è€å¿ƒï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢å“åº”éœ€è¦å‡ åç§’ç”šè‡³æ•°åˆ†é’Ÿæ‰èƒ½è¿”å›ï¼Œé‚£ä¹ˆè¿™å¥—æ–¹æ¡ˆå°±å®Œå…¨è¡Œä¸é€šã€‚å†çœ‹ MOLAP æ¶æ„ï¼ŒMOLAP èƒŒåä¹Ÿè½¬ä¸ºä¾æ‰˜ MapReduce æˆ– Spark è¿™ç±»æ–°å…´æŠ€æœ¯ï¼Œå°†å…¶ä½œä¸ºç«‹æ–¹ä½“çš„è®¡ç®—å¼•æ“ï¼Œè¿›è¡Œç«‹æ–¹ä½“çš„æ„å»ºï¼Œå…¶é¢„èšåˆç»“æ„çš„å­˜å‚¨è½½ä½“ä¹Ÿè½¬å‘ HBase è¿™ç±»é«˜æ€§èƒ½åˆ†å¸ƒå¼æ•°æ®åº“ã€‚å¤§æ•°æ®æŠ€æœ¯é˜¶æ®µï¼Œä¸»æµ MOLAP æ¶æ„å·²ç»èƒ½å¤Ÿåœ¨äº¿ä¸‡çº§æ•°æ®çš„ä½“é‡ä¸‹ï¼Œå®ç°æ¯«ç§’çº§çš„æŸ¥è¯¢ï¼Œä½†æˆ‘ä»¬è¯´ MOLAP æ¶æ„ä¼šå­˜åœ¨ç»´åº¦çˆ†ç‚¸ã€æ•°æ®åŒæ­¥å®æ—¶æ€§ä¸é«˜çš„é—®é¢˜ã€‚</strong></p>
<p><strong>ä¸éš¾å‘ç°ï¼Œè™½ç„¶ OLAP åœ¨ç»å†äº†å¤§æ•°æ®æŠ€æœ¯çš„æ´—ç¤¼ä¹‹åï¼Œå…¶å„æ–¹é¢æ€§èƒ½å·²ç»æœ‰äº†è„±èƒæ¢éª¨å¼çš„æ”¹è§‚ï¼Œä½†ä¸è®ºæ˜¯ ROLAP è¿˜æ˜¯ MOLAPï¼Œä»ç„¶å­˜åœ¨å„è‡ªçš„ç—›ç‚¹ã€‚å¯å¦‚æœå•çº¯ä»æ¨¡å‹è§’åº¦è€ƒè™‘ï¼Œå¾ˆæ˜æ˜¾ ROLAP è¦æ›´èƒœä¸€ç­¹ï¼Œå› ä¸ºå…³ç³»å‹æ•°æ®åº“çš„å­˜åœ¨ï¼Œæ‰€ä»¥å…³ç³»æ¨¡å‹æ‹¥æœ‰æœ€å¥½çš„ â€œç¾¤ä¼—åŸºç¡€â€ï¼Œä¹Ÿæ›´ç®€å•ä¸”å®¹æ˜“ç†è§£ã€‚å®ƒç›´æ¥é¢å‘æ˜ç»†æ•°æ®æŸ¥è¯¢ï¼Œç”±äºä¸éœ€è¦é¢„å¤„ç†ï¼Œä¹Ÿå°±è‡ªç„¶æ²¡æœ‰é¢„å¤„ç†å¸¦æ¥çš„è´Ÿé¢å½±å“ï¼ˆç»´åº¦ç»„åˆçˆ†ç‚¸ã€æ•°æ®å®æ—¶æ€§ã€æ›´æ–°é—®é¢˜ï¼‰ã€‚é‚£æ˜¯å¦å­˜åœ¨è¿™æ ·ä¸€ç§æŠ€æœ¯ï¼Œå®ƒä½¿ç”¨ ROLAP æ¨¡å‹ï¼Œä½†åŒæ—¶åˆæ‹¥æœ‰æ¯”è‚© MOLAP çš„æ€§èƒ½å‘¢ï¼Ÿ</strong></p>
<p><strong>æ˜¾ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ ClickHouseï¼Œæœ‰ä¸€ç¯‡æ€§èƒ½æŠ¥å‘Šï¼Œåœ¨ 10 äº¿æ¡æµ‹è¯•æ•°æ®çš„ä½“é‡ä¸‹ï¼ŒSpark è¢« ClickHouse æ‰“çš„è½èŠ±æµæ°´ã€‚ClickHouse å…·æœ‰ ROLAPã€åœ¨çº¿å®æ—¶æŸ¥è¯¢ã€å®Œæ•´çš„ DBMSã€åˆ—å¼å­˜å‚¨ã€ä¸éœ€è¦ä»»ä½•æ•°æ®é¢„å¤„ç†ã€æ”¯æŒæ‰¹é‡æ›´æ–°ã€æ‹¥æœ‰éå¸¸å®Œå–„çš„ SQL æ”¯æŒå’Œå‡½æ•°ã€æ”¯æŒé«˜å¯ç”¨ã€ä¸ä¾èµ– Hadoop å¤æ‚ç”Ÿæ€ã€å¼€ç®±å³ç”¨ç­‰è®¸å¤šç‰¹ç‚¹ã€‚ç‰¹åˆ«æ˜¯å®ƒé‚£å¤¸å¼ çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘æƒ³å¤§å¤šæ•°åˆšæ¥è§¦ ClickHouse çš„äººä¹Ÿä¸€å®šä¼šå› ä¸ºå®ƒçš„æ€§èƒ½æŒ‡æ ‡è€ŒåŠ¨å®¹ã€‚</strong></p>
<p><strong>åœ¨ä¸€ç³»åˆ—å®˜æ–¹å…¬å¸ƒçš„åŸºå‡†æµ‹è¯•å¯¹æ¯”ä¸­ï¼ŒClickHouse éƒ½é¥é¥é¢†å…ˆå¯¹æ‰‹ï¼Œè¿™å…¶ä¸­ä¹Ÿä¸ä¹ä¸€äº›æˆ‘ä»¬è€³ç†Ÿèƒ½è¯¦çš„åå­—ã€‚æ‰€æœ‰ç”¨äºå¯¹æ¯”çš„æ•°æ®åº“éƒ½ä½¿ç”¨äº†ç›¸åŒé…ç½®çš„æœåŠ¡å™¨ï¼Œåœ¨å•ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œå¯¹ä¸€å¼ æ‹¥æœ‰ 133 ä¸ªå­—æ®µçš„æ•°æ®è¡¨åˆ†åˆ«åœ¨ 1000 ä¸‡ã€1 äº¿å’Œ 10 äº¿ä¸‰ç§æ•°æ®ä½“é‡ä¸‹æ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼ŒåŸºå‡†æµ‹è¯•çš„èŒƒå›´æ¶µç›– 43 é¡¹SQLæŸ¥è¯¢ã€‚åœ¨ 1 äº¿æ•°æ®çº§ä½“é‡çš„æƒ…å†µä¸‹ï¼ŒClickHouse çš„å¹³å‡å“åº”é€Ÿåº¦æ˜¯ Vertica çš„2.63å€ã€InfiniDB çš„ 17 å€ã€MonetDB çš„ 27 å€ã€Hive çš„ 126 å€ã€MySQL çš„ 429 å€ä»¥åŠ Greenplum çš„ 10 å€ã€‚</strong></p>
<p><strong>æ­¤å¤– ClickHouse æ˜¯ä¸€æ¬¾å¼€æºè½¯ä»¶ï¼Œéµå¾ª Apache License 2.0 åè®®ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è¢«å…è´¹ä½¿ç”¨ã€‚</strong></p>
<blockquote>
<p><strong>ClickHouse çš„åå­—ç”±æ¥ï¼šClickHouse æœ€åˆçš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†æœåŠ¡äºè‡ªå®¶å…¬å¸çš„ä¸€æ¬¾åå« Metrica æµé‡åˆ†æå·¥å…·ã€‚Metrica åœ¨é‡‡é›†æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡é¡µé¢ç‚¹å‡»ï¼ˆClickï¼‰ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªäº‹ä»¶ï¼ˆEventï¼‰ï¼Œå°±æ˜¯åŸºäºé¡µé¢çš„ç‚¹å‡»äº‹ä»¶æµï¼ˆStreamï¼‰ï¼Œç„¶åé¢å‘æ•°æ®ä»“åº“è¿›è¡Œ OLAP åˆ†æã€‚æ‰€ä»¥ ClickHouse çš„å…¨ç§°æ˜¯ Click Streamã€Data WareHouseï¼Œç®€ç§° ClickHouseã€‚</strong></p>
</blockquote>
<h2 id="åˆè¯†-ClickHouse"><a href="#åˆè¯†-ClickHouse" class="headerlink" title="åˆè¯† ClickHouse"></a>åˆè¯† ClickHouse</h2><p><strong>éšç€ä¸šåŠ¡çš„è¿…çŒ›å¢é•¿ï¼ŒYandex å…¬å¸çš„ Metrica ç›®å‰å·²ç»æˆä¸ºä¸–ç•Œç¬¬ä¸‰å¤§ Web æµé‡åˆ†æå¹³å°ï¼Œæ¯å¤©å¤„ç†è¶…è¿‡ä¸¤ç™¾äº¿ä¸ªè·Ÿè¸ªäº‹ä»¶ï¼Œè€Œä¹‹æ‰€ä»¥èƒ½å¤Ÿæœ‰å¦‚æ­¤æƒŠäººçš„ä½“é‡ï¼Œåœ¨èƒŒåä¸ºå…¶æä¾›æ”¯æ’‘çš„ ClickHouse åŠŸä¸å¯æ²¡ã€‚ClickHouse å·²ç»ä¸º Metrica å­˜å‚¨äº†è¶…è¿‡ 20 ä¸‡äº¿è¡Œçš„æ•°æ®ï¼Œç™¾åˆ†ä¹‹ 90 çš„æŸ¥è¯¢èƒ½å¤Ÿåœ¨ 1 ç§’å†…è¿”å›ï¼Œå…¶é›†ç¾¤è§„æ¨¡ä¹Ÿå·²ç»è¶…è¿‡äº† 400 å°æœåŠ¡å™¨ã€‚è™½ç„¶ ClickHouse èµ·åˆåªæ˜¯ä¸ºäº† Metrica è€Œç ”å‘çš„ï¼Œä½†ç”±äºå®ƒå‡ºä¼—çš„æ€§èƒ½ï¼Œç›®å‰ä¹Ÿè¢«å¹¿æ³›åº”ç”¨äº Yandex å…¬å¸å†…éƒ¨çš„å…¶å®ƒæ•°åä¸ªäº§å“ä¸­ã€‚</strong></p>
<p><strong>é™¤äº† Yandex è‡ªå·±ä»¥å¤–ï¼ŒClickHouse è¿˜è¢«ä¼—å¤šå•†ä¸šå…¬å¸æˆ–ç ”ç©¶ç»„ç»‡åº”ç”¨åˆ°äº†å…¶ç”Ÿäº§ç¯å¢ƒã€‚æ¬§æ´²æ ¸å­ç ”ç©¶ä¸­å¿ƒï¼ˆCERNï¼Œæƒ³èµ·äº†çŸ³å¤´é—¨ï¼‰å°†å®ƒç”¨äºä¿å­˜å¼ºå¯¹æ’æœºè¯•éªŒåæ‰€è®°å½•çš„æ•°åäº¿äº‹ä»¶çš„æµ‹é‡æ•°æ®ï¼Œå¹¶æˆåŠŸå°†å…ˆå‰çš„æ•°æ®æŸ¥è¯¢æ—¶é—´ä»å‡ ä¸ªå°æ—¶ç¼©çŸ­åˆ°å‡ ç§’ï¼›è‘—åçš„ CDN æœåŠ¡å‚å•† CloudFlare å°† ClickHouse ç”¨äº HTTP çš„æµé‡åˆ†æï¼›å›½å†…çš„å¤´æ¡ã€é˜¿é‡Œå·´å·´ã€è…¾è®¯å’Œæ–°æµªç­‰ä¸€ä¼—äº’è”ç½‘å…¬å¸éƒ½åœ¨åº”ç”¨ ClickHouseã€‚</strong></p>
<p><strong>å¯ä»¥è¯´ ClickHouse å…·å¤‡äº†äººä»¬å¯¹ä¸€æ¬¾é«˜æ€§èƒ½ OLAP æ•°æ®åº“çš„ç¾å¥½å‘å¾€ï¼Œæ‰€ä»¥å®ƒåŸºæœ¬èƒ½å¤Ÿèƒœä»»å„ç§æ•°æ®åˆ†æç±»çš„åœºæ™¯ï¼Œå¹¶ä¸”éšç€æ•°æ®ä½“é‡çš„å¢å¤§ï¼Œå®ƒçš„ä¼˜åŠ¿ä¹Ÿä¼šå˜å¾—è¶Šä¸ºæ˜æ˜¾ã€‚ClickHouse éå¸¸é€‚ç”¨äºå•†ä¸šæ™ºèƒ½é¢†åŸŸï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ BI é¢†åŸŸã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿè¢«å¹¿æ³›åº”ç”¨äºå¹¿å‘Šæµé‡ã€Webã€Appæµé‡ã€ç”µä¿¡ã€é‡‘èã€ç”µå­å•†åŠ¡ã€ä¿¡æ¯å®‰å…¨ã€ç½‘ç»œæ¸¸æˆã€ç‰©è”ç½‘ç­‰ä¼—å¤šå…¶å®ƒé¢†åŸŸã€‚</strong></p>
<p><strong>æƒ³å¿…åˆ°äº†è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯äº§ç”Ÿäº†è¿™æ ·çš„ä¸€ç§é”™è§‰å‘¢ï¼ŸClickHouse ä»¿ä½›è¿èƒŒäº†ç‰©ç†å®šå¾‹ï¼Œæ²¡æœ‰ä»»ä½•ç¼ºç‚¹ï¼Œæ˜¯ä¸€ä¸ªä¸çœŸå®çš„å­˜åœ¨ï¼Œä¸€æ¬¾é«˜æ€§èƒ½ã€é«˜å¯ç”¨ OLAP æ•°æ®åº“çš„ä¸€åˆ‡è¯‰æ±‚ï¼ŒClickHouse éƒ½èƒ½æ»¡è¶³ã€‚ä½†æ˜¯ä¼°è®¡å¾ˆå¤šäººä¹‹å‰éƒ½æ˜¯ Hadoop ç”Ÿæ€åœˆçš„ï¼Œé‚£ä¹ˆä½ åœ¨è½¬å‘ ClickHouse çš„æ—¶å€™åº”è¯¥ä¼šæœ‰ä¸€äº›ä¸é€‚åº”ï¼Œå› ä¸ºå®ƒå’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„æŠ€æœ¯çš„ â€œæ€§æ ¼â€ è¿¥ç„¶ä¸åŒï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚å¦‚æœæŠŠæ•°æ®åº“æ¯”ä½œæ±½è½¦ï¼Œé‚£ä¹ˆ ClickHouse ä¿¨ç„¶å°±æ˜¯ä¸€è¾†æ‰‹åŠ¨æŒ¡çš„èµ›è½¦ï¼Œå®ƒåœ¨å¾ˆå¤šæ–¹é¢ä¸åƒå…¶å®ƒç³»ç»Ÿé‚£æ ·é«˜åº¦è‡ªåŠ¨åŒ–ã€‚ClickHouse çš„ä¸€äº›æ¦‚å¿µä¹Ÿå’Œæˆ‘ä»¬å¹³å¸¸ç†è§£çš„æœ‰æ‰€ä¸åŒï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†ç‰‡å’Œå‰¯æœ¬æ–¹é¢ï¼Œæœ‰äº›æ—¶å€™æ•°æ®çš„åˆ†ç‰‡ç”šè‡³éœ€è¦æ‰‹åŠ¨å®Œæˆã€‚ä½†åœ¨è¿›ä¸€æ­¥æ·±å…¥ä½¿ç”¨ ClickHouse ä¹‹åï¼Œæˆ‘ä»¬å°±ä¼šæ¸æ¸ç†è§£è¿™äº›è®¾è®¡çš„ç›®çš„ï¼ŒæŸäº›çœ‹ä¼¼ä¸è‡ªåŠ¨åŒ–çš„è®¾è®¡ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­åè€Œå¸¦æ¥äº†æå¤§çš„çµæ´»æ€§ã€‚ä¸ Hadoop ç”Ÿæ€çš„å…¶å®ƒæ•°æ®åº“ç›¸æ¯”ï¼ŒClickHouse æ›´åƒæ˜¯ä¸€æ¬¾ä¼ ç»Ÿ MPP æ¶æ„çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼Œå®ƒæ²¡æœ‰é‡‡ç”¨ Hadoop ç”Ÿæ€ä¸­å¸¸ç”¨çš„ä¸»ä»æ¶æ„ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å¤šä¸»å¯¹ç­‰ç½‘ç»œç»“æ„ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯åŸºäºå…³ç³»æ¨¡å‹çš„ ROLAP æ–¹æ¡ˆã€‚</strong></p>
<p><strong>é‚£ä¹ˆä¸‹é¢å°±è®©æˆ‘ä»¬æŠ½ä¸å‰¥èŒ§ï¼Œçœ‹çœ‹ ClickHouse éƒ½æœ‰å“ªäº›æ ¸å¿ƒç‰¹æ€§ã€‚</strong></p>
<h3 id="å®Œå¤‡çš„-DBMS-åŠŸèƒ½"><a href="#å®Œå¤‡çš„-DBMS-åŠŸèƒ½" class="headerlink" title="å®Œå¤‡çš„ DBMS åŠŸèƒ½"></a>å®Œå¤‡çš„ DBMS åŠŸèƒ½</h3><p><strong>ClickHouse æ‹¥æœ‰å®Œå¤‡çš„ç®¡ç†åŠŸèƒ½ï¼Œæ‰€ä»¥å®ƒç§°å¾—ä¸Šæ˜¯ä¸€ä¸ª DBMSï¼ˆDataBase Management Systemï¼Œæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼‰ï¼Œè€Œä½œä¸ºä¸€ä¸ª DBMSï¼Œå®ƒå…·å¤‡å¦‚ä¸‹åŠŸèƒ½ï¼š</strong></p>
<ul>
<li><code>DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰ï¼šå¯ä»¥åŠ¨æ€åœ°åˆ›å»ºã€ä¿®æ”¹æˆ–è€…åˆ é™¤æ•°æ®åº“ã€è¡¨å’Œè§†å›¾ï¼Œè€Œæ— éœ€é‡å¯æœåŠ¡</code></li>
<li><code>DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰ï¼šå¯ä»¥åŠ¨æ€åœ°æŸ¥è¯¢ã€æ’å…¥ã€ä¿®æ”¹æˆ–åˆ é™¤æ•°æ®</code></li>
<li><code>æƒé™æ§åˆ¶ï¼šå¯ä»¥æŒ‰ç…§ç”¨æˆ·ç²’åº¦è®¾ç½®æ•°æ®åº“æˆ–è€…è¡¨çš„æ“ä½œæƒé™ï¼Œä¿éšœæ•°æ®çš„å®‰å…¨æ€§</code></li>
<li><code>æ•°æ®å¤‡ä»½ä¸æ¢å¤ï¼šæä¾›äº†æ•°æ®å¤‡ä»½å¯¼å‡ºä¸å¯¼å…¥æ¢å¤æœºåˆ¶ï¼Œæ»¡è¶³ç”Ÿäº§ç¯å¢ƒçš„è¦æ±‚</code></li>
<li><code>åˆ†å¸ƒå¼ç®¡ç†ï¼šæä¾›é›†ç¾¤æ¨¡å¼ï¼Œèƒ½å¤Ÿè‡ªåŠ¨ç®¡ç†å¤šä¸ªæ•°æ®åº“èŠ‚ç‚¹</code></li>
</ul>
<p><strong>ä¸Šé¢åªåˆ—ä¸¾äº†ä¸€äº›æœ€å…·ä»£è¡¨æ€§çš„åŠŸèƒ½ï¼Œä½†è¿™å·²ç„¶è¶³ä»¥è¡¨æ˜ä¸ºä»€ä¹ˆ ClickHouse ç§°å¾—ä¸Šæ˜¯ DBMS äº†ã€‚</strong></p>
<p><strong>ä½†æ˜¯æ³¨æ„ï¼ŒClickHouse è™½ç„¶å¾ˆä¼˜ç§€ï¼Œä½†å®ƒæ¯•ç«Ÿæ˜¯ä¸€æ¬¾é¢å‘ OLAP çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠå®ƒç”¨äºä»»ä½• OLTP äº‹åŠ¡æ€§æ“ä½œçš„åœºæ™¯ï¼Œå› ä¸ºå®ƒæœ‰ä»¥ä¸‹å‡ ç‚¹ä¸è¶³ï¼š</strong></p>
<ul>
<li><code>ä¸æ”¯æŒäº‹åŠ¡</code></li>
<li><code>ä¸æ“…é•¿æ ¹æ®ä¸»é”®æŒ‰è¡Œç²’åº¦è¿›è¡ŒæŸ¥è¯¢ï¼ˆè™½ç„¶æ”¯æŒï¼‰ï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠ ClickHouse å½“åšé”®å€¼å¯¹æ•°æ®åº“ä½¿ç”¨</code></li>
<li><code>ä¸æ“…é•¿æŒ‰è¡Œåˆ é™¤æ•°æ®ï¼ˆè™½ç„¶æ”¯æŒï¼‰</code></li>
</ul>
<p><strong>ä¸è¿‡è¿™äº›ä¸è¶³å¹¶ä¸èƒ½ç®—æ˜¯ ClickHouse çš„ç¼ºç‚¹ï¼Œäº‹å®ä¸Šå…¶å®ƒçš„åŒç±»é«˜æ€§èƒ½é¢å‘ OLAP çš„æ•°æ®åº“ä¸€æ ·ä¸æ“…é•¿ä¸Šé¢è¿™äº›ã€‚å› ä¸ºå¯¹äº OLAP æ•°æ®åº“è€Œè¨€ï¼Œä¸Šè¿°è¿™äº›èƒ½åŠ›ä¸æ˜¯é‡ç‚¹ï¼Œåªèƒ½è¯´è¿™æ˜¯ä¸ºäº†æè‡´çš„æŸ¥è¯¢æ€§èƒ½æ‰€åšçš„æƒè¡¡ã€‚</strong></p>
<h3 id="åˆ—å¼å­˜å‚¨ä¸æ•°æ®å‹ç¼©"><a href="#åˆ—å¼å­˜å‚¨ä¸æ•°æ®å‹ç¼©" class="headerlink" title="åˆ—å¼å­˜å‚¨ä¸æ•°æ®å‹ç¼©"></a>åˆ—å¼å­˜å‚¨ä¸æ•°æ®å‹ç¼©</h3><p><strong>åˆ—å¼å­˜å‚¨ä¸æ•°æ®å‹ç¼©ï¼Œå¯¹äºä¸€æ¬¾é«˜æ€§èƒ½æ•°æ®åº“æ¥è¯´æ˜¯å¿…ä¸å¯å°‘çš„ç‰¹æ€§ã€‚ä¸€ä¸ªéå¸¸æµè¡Œçš„è§‚ç‚¹è®¤ä¸ºï¼šå¦‚æœä½ æƒ³è®©æŸ¥è¯¢å˜å¾—æ›´å¿«ï¼Œæœ€ç®€å•ä¸”æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯å‡å°‘æ•°æ®æ‰«æèŒƒå›´å’Œæ•°æ®ä¼ è¾“æ—¶çš„å¤§å°ï¼Œè€Œåˆ—å¼å­˜å‚¨å’Œæ•°æ®å‹ç¼©å°±å¯ä»¥å®ç°ä¸Šé¢ä¸¤ç‚¹ã€‚åˆ—å¼å­˜å‚¨å’Œæ•°æ®å‹ç¼©é€šå¸¸æ˜¯ä¼´ç”Ÿçš„ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´åˆ—å¼å­˜å‚¨æ˜¯æ•°æ®å‹ç¼©çš„å‰æã€‚</strong></p>
<p><strong>é‚£ä»€ä¹ˆæ˜¯åˆ—å¼å­˜å‚¨å‘¢ï¼Ÿ</strong></p>
<p><strong>é¦–å…ˆåˆ—å¼å­˜å‚¨ï¼Œæˆ–è€…è¯´æŒ‰åˆ—å­˜å‚¨ï¼Œç›¸æ¯”æŒ‰è¡Œå­˜å‚¨ï¼Œå‰è€…å¯ä»¥æœ‰æ•ˆå‡å°‘æŸ¥è¯¢æ—¶éœ€è¦æ‰«æçš„æ•°æ®é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸ªæ —å­è¯´æ˜ä¸€ä¸‹ã€‚å‡è®¾ä¸€å¼ æ•°æ®è¡¨ Aï¼Œé‡Œé¢æœ‰ 50 ä¸ªå­—æ®µ A1 ~ A50ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥è¯¢å‰ 5 ä¸ªå­—æ®µçš„æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ SQL å®ç°ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A1, A2, A3, A4, A5 <span class="keyword">from</span> A;</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯è¿™æ ·é—®é¢˜æ¥äº†ï¼Œæ•°æ®åº“æ¯æ¬¡éƒ½ä¼šé€è¡Œæ‰«æã€å¹¶è·å–æ¯è¡Œæ•°æ®çš„å…¨éƒ¨å­—æ®µï¼Œè¿™é‡Œå°±æ˜¯ 50 ä¸ªï¼Œç„¶åå†ä»ä¸­è¿”å›å‰ 5 ä¸ªå­—æ®µã€‚å› æ­¤ä¸éš¾å‘ç°ï¼Œå°½ç®¡åªéœ€è¦å‰ 5 ä¸ªå­—æ®µï¼Œä½†ç”±äºæ•°æ®æ˜¯æŒ‰è¡Œè¿›è¡Œç»„ç»‡çš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æ‰«æäº†æ‰€æœ‰çš„å­—æ®µã€‚ä½†å¦‚æœæ•°æ®æ˜¯æŒ‰åˆ—è¿›è¡Œå­˜å‚¨ï¼Œåˆ™ä¸ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œç”±äºæ•°æ®æŒ‰åˆ—è¿›è¡Œç»„ç»‡ï¼Œæ•°æ®åº“å¯ä»¥ç›´æ¥é€‰æ‹© A1 ~ A5 è¿™ 5 åˆ—çš„æ•°æ®å¹¶è¿”å›ï¼Œä»è€Œé¿å…å¤šä½™çš„æ•°æ®æ‰«æã€‚ä¸ºäº†æ›´å¥½çš„è¯´æ˜è¿™ä¸¤è€…çš„åŒºåˆ«ï¼Œæˆ‘ä»¬ç”»ä¸€å¼ å›¾ï¼š</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20210816173126709-1615157780.png" alt="img"></p>
<p><strong>å¦‚æœæ˜¯æŒ‰è¡Œå­˜å‚¨çš„è¯ï¼Œé‚£ä¹ˆå‡è®¾æˆ‘ä»¬è¦è®¡ç®— age è¿™ä¸€åˆ—çš„å¹³å‡å€¼ï¼Œå°±éœ€è¦ä¸€è¡Œä¸€è¡Œæ‰«æï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè‡³å°‘æ‰«æ 11 ä¸ªå€¼ï¼ˆ 3 + 3 + 3 + 2 ï¼‰æ‰èƒ½æ‰¾åˆ° age è¿™ä¸€åˆ—æ‰€å­˜å‚¨çš„ 4 ä¸ªå€¼ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ç­‰å¾… IO å®Œæˆï¼Œè€Œä¸”è¯»å®Œä¹‹åè¿˜è¦æ‰”æ‰å¾ˆå¤šï¼ˆå› ä¸ºæˆ‘ä»¬åªéœ€è¦éƒ¨åˆ†å­—æ®µï¼‰ã€‚ä½†å¦‚æœæ˜¯æŒ‰åˆ—å­˜å‚¨çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦è·å– age è¿™ä¸€åˆ—çš„è¿ç»­å¿«ï¼Œå³å¯å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ 4 ä¸ªå€¼ï¼Œæ‰€ä»¥è¿™ç§æ“ä½œé€Ÿåº¦æ›´å¿«ã€æ•ˆç‡æ›´é«˜ã€‚</strong></p>
<p><strong>æŒ‰åˆ—å­˜å‚¨ç›¸æ¯”æŒ‰è¡Œå­˜å‚¨çš„å¦ä¸€ä¸ªä¼˜åŠ¿æ˜¯å¯¹æ•°æ®å‹ç¼©çš„å‹å¥½æ€§ï¼ŒåŒæ ·å¯ä»¥ä¸¾ä¸€ä¸ªæ —å­ç®€å•è¯´æ˜ä¸€ä¸‹å‹ç¼©çš„æœ¬è´¨æ˜¯ä»€ä¹ˆã€‚å‡è®¾æœ‰ä¸ªå­—ç¬¦ä¸² abcdefghi_bcdefghiï¼Œç°åœ¨å¯¹å®ƒè¿›è¡Œå‹ç¼©ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">å‹ç¼©å‰ï¼šabcdefghi_bcdefghi</span><br><span class="line">å‹ç¼©åï¼š<span class="built_in">abcdefghi_</span>(<span class="number">9</span>,<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°ï¼Œå‹ç¼©çš„æœ¬è´¨å°±æ˜¯æŒ‰ç…§ä¸€å®šæ­¥é•¿å¯¹æ•°æ®è¿›è¡ŒåŒ¹é…æ‰«æï¼Œå½“å‘ç°é‡å¤éƒ¨åˆ†çš„æ—¶å€™å°±ä¼šç¼–ç è½¬æ¢ã€‚ä¾‹å¦‚ä¸Šé¢çš„ <code>(9, 8)</code>ï¼Œè¡¨ç¤ºä»ä¸‹åˆ’çº¿å¼€å§‹å‘å‰ç§»åŠ¨ 9 ä¸ªå­—èŠ‚ï¼Œä¼šåŒ¹é…åˆ° 8 ä¸ªå­—èŠ‚é•¿åº¦çš„é‡å¤é¡¹ï¼Œå³ bcdefghiã€‚</strong></p>
<p><strong>å°½ç®¡çœŸå®çš„å‹ç¼©ç®—æ³•è¦æ¯”è¿™ä¸ªå¤æ‚è®¸å¤šï¼Œä½†å‹ç¼©çš„æœ¬è´¨å°±æ˜¯å¦‚æ­¤ã€‚æ•°æ®ä¸­çš„é‡å¤é¡¹è¶Šå¤šï¼Œåˆ™å‹ç¼©ç‡è¶Šé«˜ï¼›å‹ç¼©ç‡è¶Šé«˜ï¼Œåˆ™æ•°æ®ä½“é‡è¶Šå°ï¼›è€Œæ•°æ®ä½“é‡è¶Šå°ï¼Œåœ¨ç½‘ç»œä¸­ä¼ è¾“çš„é€Ÿåº¦åˆ™è¶Šå¿«ï¼Œå¹¶ä¸”å¯¹ç½‘ç»œå¸¦å®½å’Œç£ç›˜ IO çš„å‹åŠ›ä¹Ÿå°±è¶Šå°ã€‚å¯æ€æ ·çš„æ•°æ®æœ€å¯èƒ½å…·å¤‡é‡å¤çš„ç‰¹æ€§å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å±äºåŒä¸€ä¸ªåˆ—å­—æ®µçš„æ•°æ®ï¼Œå› ä¸ºå®ƒä»¬å…·æœ‰ç›¸åŒçš„æ•°æ®ç±»å‹å’Œç°å®è¯­ä¹‰ï¼Œé‡å¤é¡¹çš„å¯èƒ½æ€§è‡ªç„¶å°±æ›´é«˜ã€‚</strong></p>
<p><strong>ClickHouse å°±æ˜¯ä¸€æ¬¾ä½¿ç”¨åˆ—å¼å­˜å‚¨çš„æ•°æ®åº“ï¼Œæ•°æ®æŒ‰åˆ—è¿›è¡Œç»„ç»‡ï¼Œå±äºåŒä¸€åˆ—çš„æ•°æ®ä¼šè¢«ä¿å­˜åœ¨ä¸€èµ·ï¼Œå¹¶è¿›è¡Œå‹ç¼©ï¼Œè€Œåˆ—ä¸åˆ—ä¹‹é—´çš„æ•°æ®ä¹Ÿä¼šç”±ä¸åŒçš„æ–‡ä»¶åˆ†åˆ«ä¿å­˜ï¼ˆè¿™é‡Œä¸»è¦æ˜¯æŒ‡ MergeTree å¼•æ“ï¼Œåç»­ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚æ•°æ®é»˜è®¤ä½¿ç”¨ LZ4 ç®—æ³•å‹ç¼©ï¼Œåœ¨ Yandex å…¬å¸çš„ Metrica ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ•°æ®æ•´ä½“çš„å‹ç¼©æ¯”å¯ä»¥è¾¾åˆ° 8 æ¯” 1ï¼ˆæœªå‹ç¼©å‰ 17 PBï¼Œå‹ç¼©å 8 PBï¼‰ã€‚å¦å¤–åˆ—å¼å­˜å‚¨é™¤äº†é™ä½ IO å’Œå­˜å‚¨çš„å‹åŠ›ä¹‹å¤–ï¼Œè¿˜ä¸ºå‘é‡åŒ–æ‰§è¡Œåšå¥½äº†é“ºå«ã€‚</strong></p>
<h3 id="å‘é‡åŒ–æ‰§è¡Œå¼•æ“"><a href="#å‘é‡åŒ–æ‰§è¡Œå¼•æ“" class="headerlink" title="å‘é‡åŒ–æ‰§è¡Œå¼•æ“"></a>å‘é‡åŒ–æ‰§è¡Œå¼•æ“</h3><p><strong>åŠé—´æœ‰å¥ç©ç¬‘ï¼šâ€èƒ½ç”¨ money è§£å†³çš„é—®é¢˜ï¼Œåƒä¸‡åˆ«èŠ±æ—¶é—´â€ã€‚è€Œä¸šç•Œä¹Ÿæœ‰ç§è°ƒä¾ƒä¸ä¹‹å¦‚å‡ºä¸€è¾™ï¼šâ€èƒ½å‡çº§ç¡¬ä»¶è§£å†³çš„é—®é¢˜ï¼Œåƒä¸‡åˆ«ä¼˜åŒ–ç¨‹åºâ€ã€‚æœ‰æ—¶å€™ï¼Œä½ åƒè¾›ä¸‡è‹¦ä¼˜åŒ–ç¨‹åºé€»è¾‘å¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œè¿˜ä¸å¦‚ç›´æ¥å‡çº§ç¡¬ä»¶æ¥çš„ç®€å•ç›´æ¥ã€‚è¿™è™½ç„¶æ˜¯ä¸€å¥ç©ç¬‘è¯ä¸èƒ½å½“çœŸï¼Œä½†ç¡¬ä»¶å±‚é¢çš„ä¼˜åŒ–ç¡®å®æ˜¯æœ€ç®€å•ç²—æš´ã€å¹¶ä¸”æœ‰æ•ˆçš„é€”å¾„ä¹‹ä¸€ã€‚å‘é‡åŒ–æ‰§è¡Œå°±æ˜¯å…¸å‹ä»£è¡¨ï¼Œè¿™é¡¹å¯„å­˜å™¨ç¡¬ä»¶å±‚é¢çš„ç‰¹æ€§ï¼Œä¸ºä¸Šå±‚åº”ç”¨çš„ç¨‹åºåœ¨æ€§èƒ½ä¸Šå¸¦æ¥äº†æŒ‡æ•°çº§çš„æå‡ã€‚</strong></p>
<p><strong>å‘é‡åŒ–æ‰§è¡Œå¯ä»¥ç®€å•åœ°çœ‹åšæˆä¸€ç§æ¶ˆé™¤ç¨‹åºä¸­çš„å¾ªç¯æ‰€åšçš„ä¼˜åŒ–ï¼Œä¸¾ä¸ªæ —å­ã€‚å‡è®¾å°æ˜åœ¨å–æœæ±ï¼Œè€Œæ¦¨ä¸€æ¯æœæ±å‡è®¾éœ€è¦ 2 åˆ†é’Ÿï¼Œæœ‰å®¢æˆ·æŠ±æ€¨å¤ªæ…¢äº†ï¼Œé‚£ä¹ˆä¸ºäº†å¢åŠ é€Ÿåº¦è¦æ€ä¹ˆåŠå‘¢ï¼Ÿæ˜¾ç„¶å¤šå‡†å¤‡å‡ å°æ¦¨æ±æœºå°±å¥½äº†ï¼Œå› æ­¤éå‘é‡åŒ–æ‰§è¡Œçš„æ–¹å¼æ˜¯åˆ©ç”¨ 1 å°æ¦¨æ±æœºé‡å¤ n æ¬¡ï¼Œè€Œå‘é‡åŒ–æ‰§è¡Œçš„æ–¹å¼æ˜¯åˆ©ç”¨ n å°æ¦¨æ±æœºåªæ‰§è¡Œ 1 æ¬¡ã€‚</strong></p>
<p><strong>è€Œä¸ºäº†å®ç°å‘é‡åŒ–æ‰§è¡Œï¼Œéœ€è¦åˆ©ç”¨ CPU çš„ SIMD æŒ‡ä»¤ã€‚SIMD çš„å…¨ç§°æ˜¯ï¼šSingle Instruction Multiple Dataï¼Œå³ç”¨å•æ¡æŒ‡ä»¤æ“ä½œå¤šæ¡æ•°æ®ã€‚ç°ä»£è®¡ç®—æœºç³»ç»Ÿæ¦‚å¿µä¸­ï¼Œå®ƒæ˜¯é€šè¿‡æ•°æ®å¹¶è¡Œä»¥æé«˜æ€§èƒ½çš„ä¸€ç§å®ç°æ–¹å¼ï¼ˆå…¶å®ƒçš„è¿˜æœ‰æŒ‡ä»¤çº§å¹¶è¡Œå’Œçº¿ç¨‹çº§å¹¶è¡Œï¼‰ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ CPU å¯„å­˜å™¨å±‚é¢å®ç°æ•°æ®çš„å¹¶è¡Œè®¡ç®—ã€‚</strong></p>
<p><strong>åœ¨è®¡ç®—æœºç³»ç»Ÿçš„ä½“ç³»ç»“æ„ä¸­ï¼Œå­˜å‚¨ç³»ç»Ÿæ˜¯ä¸€ç§å±‚æ¬¡ç»“æ„ï¼Œå…¸å‹æœåŠ¡å™¨è®¡ç®—æœºçš„å­˜å‚¨å±‚æ¬¡ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012235603619-407134725.png" alt="img"></p>
<p><strong>å®ƒä»¬çš„å¤§å°ä¼šæ ¹æ® CPU çš„ä¸åŒè€Œä¸åŒï¼Œä»¥æˆ‘ä¹‹å‰çš„ä¸ªäººç¬”è®°æœ¬ç”µè„‘ä¸ºä¾‹ï¼š</strong></p>
<p><img src="/2022/12/01/ClickHouse%20%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%20ClickHouse(%E4%B8%80)/1229382-20201012235609340-470453106.png" alt="img"></p>
<p><strong>ä»å·¦å‘å³è·ç¦» CPU è¶Šè¿‘ï¼Œè®¿é—®é€Ÿåº¦å°±è¶Šå¿«ï¼Œæ˜¾ç„¶èƒ½å¤Ÿå®¹çº³çš„æ•°æ®å¤§å°ä¹Ÿå°±è¶Šå°ï¼›åˆ«å¿˜äº†ï¼ŒCPU å¯„å­˜å™¨ä¹Ÿæ˜¯å¯ä»¥å­˜å‚¨æ•°æ®çš„ï¼ŒCPU ä»å¯„å­˜å™¨ä¸­è·å–æ•°æ®çš„é€Ÿåº¦æ˜¯æœ€å¿«çš„ï¼Œæ˜¯å†…å­˜çš„ 300 å€ï¼Œç£ç›˜çš„ 3000 ä¸‡å€ã€‚æ‰€ä»¥åˆ©ç”¨ CPU å‘é‡åŒ–æ‰§è¡Œçš„ç‰¹æ€§ï¼Œå¯¹äºç¨‹åºçš„æ€§èƒ½æå‡æœ‰ç€éå‡¡çš„æ„ä¹‰ã€‚</strong></p>
<blockquote>
<p><strong>ClickHouse ç›®å‰ä½¿ç”¨ SSE 4.2 æŒ‡ä»¤é›†å®ç°å‘é‡åŒ–æ‰§è¡Œã€‚</strong></p>
</blockquote>
<h3 id="å…³ç³»æ¨¡å‹ä¸-SQL-æŸ¥è¯¢"><a href="#å…³ç³»æ¨¡å‹ä¸-SQL-æŸ¥è¯¢" class="headerlink" title="å…³ç³»æ¨¡å‹ä¸ SQL æŸ¥è¯¢"></a>å…³ç³»æ¨¡å‹ä¸ SQL æŸ¥è¯¢</h3><p><strong>ç›¸æ¯” HBase å’Œ Redis è¿™ç±» NoSQL æ•°æ®åº“ï¼ŒClickHouse ä½¿ç”¨å…³ç³»æ¨¡å‹æè¿°æ•°æ®å¹¶æä¾›äº†ä¼ ç»Ÿæ•°æ®åº“çš„æ¦‚å¿µï¼ˆæ•°æ®åº“ã€è¡¨ã€è§†å›¾å’Œå‡½æ•°ç­‰ï¼‰ã€‚ä¸æ­¤åŒæ—¶ï¼ŒClickHouse å®Œå…¨ä½¿ç”¨ SQL ä½œä¸ºæŸ¥è¯¢è¯­è¨€ï¼ˆæ”¯æŒ GROUP BYã€ORDER BYã€JOINã€IN ç­‰å¤§å¤šæ•°æ ‡å‡† SQLï¼‰ï¼Œè¿™ä½¿å¾—å®ƒå¹³æ˜“è¿‘äººï¼Œå®¹æ˜“ç†è§£å’Œå­¦ä¹ ã€‚å› ä¸ºå…³ç³»å‹æ•°æ®åº“å’Œ SQL è¯­è¨€ï¼Œå¯ä»¥è¯´æ˜¯è½¯ä»¶é¢†åŸŸå‘å±•è‡³ä»Šåº”ç”¨æœ€ä¸ºå¹¿æ³›çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œä¹Ÿæ­£å› ä¸º ClickHouse æä¾›äº†æ ‡å‡†åè®®çš„ SQL æŸ¥è¯¢æ¥å£ï¼Œä½¿å¾—ç°æœ‰çš„ç¬¬ä¸‰æ–¹åˆ†æå¯è§†åŒ–ç³»ç»Ÿå¯ä»¥è½»æ¾åœ°ä¸å®ƒé›†æˆå¯¹æ¥ã€‚è€Œåœ¨ SQL è§£ææ–¹é¢ï¼ŒClickHouse æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œè¿™æ„å‘³ç€ SELECT a å’Œ SELECT A æ‰€ä»£è¡¨çš„è¯­ä¹‰æ˜¯ä¸åŒçš„ï¼ˆå…³é”®å­—éå¤§å°å†™æ•æ„Ÿï¼‰ã€‚</strong></p>
<p><strong>å…³ç³»æ¨¡å‹ç›¸æ¯”æ–‡æ¡£æ¨¡å‹ã€é”®å€¼å¯¹æ¨¡å‹ç­‰ç­‰ï¼Œæ‹¥æœ‰æ›´å¥½çš„æè¿°èƒ½åŠ›ï¼Œä¹Ÿèƒ½æ›´åŠ æ¸…æ¥šåœ°è¡¨ç¤ºå®ä½“ä¹‹é—´çš„å…³ç³»ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨ OLAP é¢†åŸŸï¼Œå·²æœ‰çš„å¤§é‡æ•°æ®å»ºæ¨¡å·¥ä½œéƒ½æ˜¯åŸºäºå…³ç³»æ¨¡å‹å±•å¼€çš„ï¼ˆæ˜Ÿåº§æ¨¡å‹ã€é›ªèŠ±æ¨¡å‹å’Œå®½è¡¨æ¨¡å‹ï¼‰ã€‚ClickHouse ä½¿ç”¨äº†å…³ç³»æ¨¡å‹ï¼Œæ‰€ä»¥å°†æ„å»ºåœ¨ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“æˆ–è€…æ•°ä»“ä¹‹ä¸Šçš„ç³»ç»Ÿè¿ç§»åˆ° ClickHouse çš„æˆæœ¬ä¼šå˜å¾—æ›´ä½ï¼Œå¯ä»¥ç›´æ¥æ²¿ç”¨ä¹‹å‰çš„ç»éªŒæˆæœã€‚</strong></p>
<h3 id="å¤šæ ·åŒ–çš„è¡¨å¼•æ“"><a href="#å¤šæ ·åŒ–çš„è¡¨å¼•æ“" class="headerlink" title="å¤šæ ·åŒ–çš„è¡¨å¼•æ“"></a>å¤šæ ·åŒ–çš„è¡¨å¼•æ“</h3><p><strong>ClickHouse å¹¶ä¸æ˜¯ç›´æ¥å°±ä¸€è¹´è€Œå°±çš„ï¼ŒMetrica äº§å“çš„æœ€åˆæ¶æ„æ˜¯åŸºäºMySQLå®ç°çš„ï¼Œæ‰€ä»¥åœ¨ ClickHouse çš„è®¾è®¡ä¸­ï¼Œèƒ½å¤Ÿå¯Ÿè§‰åˆ°ä¸€äº› MySQL çš„å½±å­ï¼Œè¡¨å¼•æ“çš„è®¾è®¡å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚ä¸ MySQL ç±»ä¼¼ï¼ŒClickHouse ä¹Ÿå°†å­˜å‚¨éƒ¨åˆ†è¿›è¡Œäº†æŠ½è±¡ï¼ŒæŠŠå­˜å‚¨å¼•æ“ä½œä¸ºä¸€å±‚ç‹¬ç«‹çš„æ¥å£ï¼Œå¹¶ä¸”æ‹¥æœ‰åˆå¹¶æ ‘ã€å†…å­˜ã€æ–‡ä»¶ã€æ¥å£ç­‰ 20 å¤šç§å¼•æ“ã€‚å…¶ä¸­æ¯ä¸€ç§å¼•æ“éƒ½æœ‰ç€å„è‡ªçš„ç‰¹ç‚¹ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯çš„éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„å¼•æ“ã€‚</strong></p>
<p><strong>é€šå¸¸è€Œè¨€ï¼Œä¸€ä¸ªé€šç”¨ç³»ç»Ÿæ„å‘³ç€æ›´å¹¿æ³›çš„å®ç”¨æ€§ï¼Œèƒ½å¤Ÿé€‚åº”æ›´å¤šçš„åœºæ™¯ã€‚ä½†é€šç”¨çš„å¦ä¸€ç§è§£é‡Šæ˜¯å¹³åº¸ï¼Œå› ä¸ºå®ƒæ— æ³•åœ¨æ‰€æœ‰åœºæ™¯ä¸­éƒ½åšåˆ°æè‡´ã€‚</strong></p>
<p><strong>åœ¨è½¯ä»¶çš„ä¸–ç•Œä¸­ï¼Œå¹¶ä¸ä¼šå­˜åœ¨ä¸€ä¸ªèƒ½å¤Ÿé€‚ç”¨ä»»ä½•åœºæ™¯çš„é€šç”¨ç³»ç»Ÿï¼Œä¸ºäº†çªå‡ºæŸé¡¹ç‰¹æ€§åŠ¿å¿…ä¼šåœ¨åˆ«å¤„æœ‰æ‰€å–èˆã€‚æ‰€ä»¥å°†è¡¨å¼•æ“ç‹¬ç«‹è®¾è®¡çš„å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œé€šè¿‡ç‰¹å®šçš„è¡¨å¼•æ“æ”¯æ’‘ç‰¹å®šçš„åœºæ™¯ï¼Œååˆ†çµæ´»ã€‚å¯¹äºç®€å•çš„åœºæ™¯ï¼Œå¯ç›´æ¥ä½¿ç”¨ç®€å•çš„å¼•æ“é™ä½æˆæœ¬ï¼Œè€Œå¤æ‚çš„åœºæ™¯ä¹Ÿæœ‰åˆé€‚çš„é€‰æ‹©ã€‚</strong></p>
<h3 id="å¤šçº¿ç¨‹ä¸åˆ†å¸ƒå¼"><a href="#å¤šçº¿ç¨‹ä¸åˆ†å¸ƒå¼" class="headerlink" title="å¤šçº¿ç¨‹ä¸åˆ†å¸ƒå¼"></a>å¤šçº¿ç¨‹ä¸åˆ†å¸ƒå¼</h3><p><strong>ClickHouse å‡ ä¹å…·å¤‡ç°ä»£åŒ–é«˜æ€§èƒ½æ•°æ®åº“çš„æ‰€æœ‰å…¸å‹ç‰¹å¾ï¼Œå¯¹äºå¯ä»¥æå‡æ€§èƒ½çš„æ‰‹æ®µå¯è°“æ˜¯å…¨éƒ¨ç”¨å°½ï¼Œå¯¹äºå¤šçº¿ç¨‹å’Œåˆ†å¸ƒå¼è¿™ç±»è¢«å¹¿æ³›åº”ç”¨çš„æŠ€æœ¯è‡ªç„¶æ›´æ˜¯ä¸åœ¨è¯ä¸‹ã€‚</strong></p>
<p><strong>å¦‚æœè¯´å‘é‡åŒ–æ‰§è¡Œæ˜¯é€šè¿‡æ•°æ®çº§åˆ«çš„å¹¶è¡Œæ–¹å¼æå‡äº†æ€§èƒ½ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹å¤„ç†å°±æ˜¯é€šè¿‡çº¿ç¨‹çº§å¹¶è¡Œçš„æ–¹å¼å®ç°äº†æ€§èƒ½æå‡ã€‚ç›¸æ¯”åŸºäºåº•å±‚ç¡¬ä»¶å®ç°çš„å‘é‡åŒ–æ‰§è¡Œ SIMDï¼Œçº¿ç¨‹çº§å¹¶è¡Œé€šå¸¸ç”±æ›´é«˜å±‚æ¬¡çš„è½¯ä»¶å±‚é¢æ§åˆ¶ã€‚ç°ä»£è®¡ç®—æœºç³»ç»Ÿæ—©å·²æ™®åŠäº†å¤šå¤„ç†å™¨æ¶æ„ï¼Œæ‰€ä»¥ç°ä»Šå¸‚é¢ä¸Šçš„æœåŠ¡å™¨éƒ½å…·å¤‡è‰¯å¥½çš„å¤šæ ¸å¿ƒå¤šçº¿ç¨‹å¤„ç†èƒ½åŠ›ã€‚ç”±äº SIMD ä¸é€‚åˆç”¨äºå¸¦æœ‰è¾ƒå¤šåˆ†æ”¯åˆ¤æ–­çš„åœºæ™¯ï¼ŒClickHouse ä¹Ÿå¤§é‡ä½¿ç”¨äº†å¤šçº¿ç¨‹æŠ€æœ¯ä»¥å®ç°æé€Ÿï¼Œä»¥æ­¤å’Œå‘é‡åŒ–æ‰§è¡Œå½¢æˆäº’è¡¥ã€‚</strong></p>
<p><strong>å¦‚æœä¸€ä¸ªç¯®å­è£…ä¸ä¸‹æ‰€ä»¥çš„é¸¡è›‹ï¼Œå°±å¤šç”¨å‡ ä¸ªç¯®å­æ¥è£…ï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼è®¾è®¡ä¸­åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³ã€‚åŒç†ï¼Œå¦‚æœä¸€å°æœåŠ¡å™¨æ€§èƒ½åƒç´§ï¼Œé‚£ä¹ˆå°±åˆ©ç”¨å¤šå°æœåŠ¡çš„èµ„æºååŒå¤„ç†ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œé¦–å…ˆå°±è¦åœ¨æ•°æ®å±‚é¢å®ç°æ•°æ®çš„åˆ†å¸ƒå¼ï¼Œå› ä¸ºåœ¨åˆ†å¸ƒå¼é¢†åŸŸï¼Œå­˜åœ¨ç€ä¸€æ¡å…¬è®¤çš„ç†è®ºï¼šç§»åŠ¨è®¡ç®—ä¼˜äºç§»åŠ¨æ•°æ®ã€‚åœ¨å„æœåŠ¡å™¨ä¹‹é—´ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“æ•°æ®çš„æˆæœ¬æ˜¯å¾ˆé«˜çš„ï¼Œæ‰€ä»¥ç›¸æ¯”ç§»åŠ¨æ•°æ®ï¼Œæ›´ä¸ºèªæ˜çš„åšæ³•æ˜¯é¢„å…ˆå°†æ•°æ®åˆ†å¸ƒåˆ°å„å°æœåŠ¡å™¨ï¼Œå°†æ•°æ®çš„è®¡ç®—æŸ¥è¯¢ç›´æ¥ä¸‹æ¨åˆ°æ•°æ®æ‰€åœ¨çš„æœåŠ¡å™¨ã€‚è€Œ ClickHouse åœ¨æ•°æ®å­˜å‚¨æ–¹é¢ï¼Œæ—¢æ”¯æŒåˆ†åŒºï¼ˆçºµå‘æ‰©å±•ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹èµ„æºï¼‰ï¼Œä¹Ÿæ”¯æŒåˆ†ç‰‡ï¼ˆæ¨ªå‘æ‰©å±•ï¼Œåˆ©ç”¨åˆ†å¸ƒå¼åŸç†ï¼‰ï¼Œå¯ä»¥è¯´æ˜¯å°†å¤šçº¿ç¨‹å’Œåˆ†å¸ƒå¼çš„æŠ€æœ¯åº”ç”¨åˆ°äº†æè‡´ã€‚</strong></p>
<h3 id="å¤šä¸»æ¶æ„"><a href="#å¤šä¸»æ¶æ„" class="headerlink" title="å¤šä¸»æ¶æ„"></a>å¤šä¸»æ¶æ„</h3><p><strong>HDFSã€Sparkã€HBase å’Œ Elasticsearch è¿™ç±»åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéƒ½é‡‡ç”¨äº† master-slave ä¸»ä»æ¶æ„ï¼Œç”±ä¸€ä¸ªç®¡æ§èŠ‚ç‚¹ä½œä¸º Leader ç»Ÿç­¹å…¨å±€ï¼Œè€Œ ClickHouse åˆ™é‡‡ç”¨ multi-master å¤šä¸»æ¶æ„ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è§’è‰²å¯¹ç­‰ï¼Œå®¢æˆ·ç«¯è®¿é—®ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½èƒ½å¾—åˆ°ç›¸åŒçš„æ•ˆæœã€‚è¿™ç§å¤šä¸»æ¶æ„æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œä¾‹å¦‚å¯¹ç­‰çš„è§’è‰²ä½¿ç³»ç»Ÿæ¶æ„å˜å¾—æ›´åŠ ç®€å•ï¼Œä¸ç”¨å†åŒºåˆ†ä¸»æ§èŠ‚ç‚¹ã€æ•°æ®èŠ‚ç‚¹å’Œè®¡ç®—èŠ‚ç‚¹ï¼Œé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½ç›¸åŒã€‚æ‰€ä»¥å®ƒå¤©ç„¶è§„é¿äº†å•ç‚¹æ•…éšœçš„é—®é¢˜ï¼Œéå¸¸é€‚åˆç”¨äºå¤šæ•°æ®ä¸­å¿ƒã€å¼‚åœ°å¤šæ´»çš„åœºæ™¯ã€‚</strong></p>
<h3 id="åœ¨çº¿æŸ¥è¯¢"><a href="#åœ¨çº¿æŸ¥è¯¢" class="headerlink" title="åœ¨çº¿æŸ¥è¯¢"></a>åœ¨çº¿æŸ¥è¯¢</h3><p><strong>ClickHouse ç»å¸¸ä¼šè¢«æ‹¿æ¥ä¸å…¶å®ƒçš„åˆ†ææ€§æ•°æ®åº“åšå¯¹æ¯”ï¼Œæ¯”å¦‚ Verticaã€SparkSQLã€Hive å’Œ Elasticsearch ç­‰ï¼Œå®ƒä¸è¿™äº›æ•°æ®åº“ç¡®å®å­˜åœ¨è®¸å¤šç›¸ä¼¼ä¹‹å¤„ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬éƒ½å¯ä»¥æ”¯æ’‘æµ·é‡æ•°æ®çš„æŸ¥è¯¢åœºæ™¯ï¼Œéƒ½æ‹¥æœ‰åˆ†å¸ƒå¼æ¶æ„ï¼Œéƒ½æ”¯æŒåˆ—å­˜å‚¨ã€æ•°æ®åˆ†ç‰‡ã€è®¡ç®—ä¸‹æ¨ç­‰åŠŸèƒ½ã€‚è¿™å…¶å®ä¹Ÿè¯´æ˜äº† ClickHouse åœ¨è®¾è®¡ä¸Šå¸å–äº†å„è·¯å¥‡æŠ€æ·«å·§ï¼Œè€Œä¸å…¶å®ƒæ•°æ®åº“ç›¸æ¯”ï¼ŒClickHouse ä¹Ÿæ‹¥æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚ä¾‹å¦‚ï¼ŒVertica è¿™ç±»å•†ç”¨è½¯ä»¶ä»·æ ¼é«˜æ˜‚ï¼›SparkSQL ä¸ Hive è¿™ç±»ç³»ç»Ÿæ— æ³•ä¿éšœ 90% çš„æŸ¥è¯¢éƒ½èƒ½åœ¨ 1 ç§’å†…è¿”å›ï¼Œåœ¨å¤§æ•°æ®é‡ä¸‹çš„å¤æ‚æŸ¥è¯¢å¯èƒ½ä¼šéœ€è¦åˆ†é’Ÿçº§çš„å“åº”æ—¶é—´ï¼›è€Œ Elasticsearch è¿™ç±»æœç´¢å¼•æ“åœ¨å¤„ç†äº¿çº§æ•°æ®èšåˆæŸ¥è¯¢æ—¶åˆ™å·²ç»æ˜¾å¾—æ‰è¥Ÿè§è‚˜ã€‚</strong></p>
<p><strong>æ­£å¦‚ ClickHouse çš„ â€œå¹¿å‘Šè¯â€ æ‰€è¨€ï¼Œå…¶å®ƒçš„å¼€æºç³»ç»Ÿå¤ªæ…¢ï¼Œå•†ç”¨çš„ç³»ç»Ÿå¤ªè´µï¼Œåªæœ‰ ClickHouse åœ¨æˆæœ¬ä¸æ€§èƒ½ä¹‹é—´é€‰æ‹©äº†è‰¯å¥½å¹³è¡¡ï¼Œåˆå¿«åˆå¼€æºã€‚ClickHouse å½“ä¹‹æ— æ„§åœ°é˜é‡Šäº† â€œåœ¨çº¿â€ äºŒå­—çš„å«ä¹‰ï¼Œå³ä¾¿æ˜¯åœ¨å¤æ‚çš„æŸ¥è¯¢åœºæ™¯ä¸‹ï¼Œå®ƒä¹Ÿèƒ½å¤Ÿåšåˆ°æå…¶å¿«é€Ÿçš„å“åº”ï¼Œä¸”æ— éœ€å¯¹æ•°æ®è¿›è¡Œä»»ä½•é¢„å¤„ç†åŠ å·¥ã€‚</strong></p>
<h3 id="æ•°æ®åˆ†ç‰‡ä¸åˆ†å¸ƒå¼æŸ¥è¯¢"><a href="#æ•°æ®åˆ†ç‰‡ä¸åˆ†å¸ƒå¼æŸ¥è¯¢" class="headerlink" title="æ•°æ®åˆ†ç‰‡ä¸åˆ†å¸ƒå¼æŸ¥è¯¢"></a>æ•°æ®åˆ†ç‰‡ä¸åˆ†å¸ƒå¼æŸ¥è¯¢</h3><p><strong>æ•°æ®åˆ†ç‰‡æ˜¯å°†æ•°æ®è¿›è¡Œæ¨ªå‘åˆ‡åˆ†ï¼Œè¿™æ˜¯ä¸€ç§åœ¨é¢å¯¹æµ·é‡æ•°æ®çš„åœºæ™¯ä¸‹ï¼Œè§£å†³å­˜å‚¨å’ŒæŸ¥è¯¢ç“¶é¢ˆçš„æœ‰æ•ˆæ‰‹æ®µï¼Œæ˜¯ä¸€ç§åˆ†ä¹‹æ€æƒ³çš„ä½“ç°ã€‚ClickHouse æ”¯æŒåˆ†ç‰‡ï¼Œè€Œåˆ†ç‰‡åˆ™ä¾èµ–é›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤å¯ä»¥æœ‰ä¸€åˆ°å¤šä¸ªåˆ†ç‰‡ï¼Œä½†æ˜¯æ³¨æ„ï¼šä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ªåˆ†ç‰‡ï¼Œæ‰€ä»¥åˆ†ç‰‡çš„æ•°é‡å–å†³äºèŠ‚ç‚¹æ•°é‡ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯åˆ†ç‰‡å‘¢ï¼Ÿå¾€ä¸‹çœ‹ã€‚</strong></p>
<p><strong>ClickHouse å¹¶ä¸åƒå…¶ä»–åˆ†å¸ƒå¼ç³»ç»Ÿé‚£æ ·ï¼Œæ‹¥æœ‰é«˜åº¦è‡ªåŠ¨åŒ–çš„åˆ†ç‰‡åŠŸèƒ½ï¼ŒClickHouse æä¾›äº†æœ¬åœ°è¡¨ï¼ˆLocal Tableï¼‰å’Œåˆ†å¸ƒå¼è¡¨ï¼ˆDistributed Tableï¼‰çš„æ¦‚å¿µã€‚ä¸€å¼ æœ¬åœ°è¡¨ç­‰åŒäºä¸€ä»½æ•°æ®çš„åˆ†ç‰‡ï¼Œè€Œåˆ†å¸ƒå¼è¡¨æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒæ˜¯æœ¬åœ°è¡¨çš„è®¿é—®ä»£ç†ï¼Œå…¶ä½œç”¨ç±»ä¼¼åˆ†åº“ä¸­é—´ä»¶ã€‚å€ŸåŠ©åˆ†å¸ƒå¼è¡¨ï¼Œèƒ½å¤Ÿä»£ç†è®¿é—®å¤šä¸ªæ•°æ®åˆ†ç‰‡ï¼Œä»è€Œå®ç°åˆ†å¸ƒå¼æŸ¥è¯¢ã€‚</strong></p>
<p><strong>è¿™ç±»è®¾è®¡ç±»ä¼¼äºæ•°æ®åº“çš„åˆ†åº“å’Œåˆ†è¡¨ï¼Œååˆ†çµæ´»ã€‚ä¾‹å¦‚åœ¨ä¸šåŠ¡ä¸Šçº¿çš„åˆæœŸï¼Œæ•°æ®ä½“é‡å¹¶ä¸é«˜ï¼Œæ­¤æ—¶æ•°æ®è¡¨å¹¶ä¸éœ€è¦å¤šä¸ªåˆ†ç‰‡ã€‚æ‰€ä»¥ä½¿ç”¨å•ä¸ªèŠ‚ç‚¹çš„æœ¬åœ°è¡¨ï¼ˆå•ä¸ªæ•°æ®åˆ†ç‰‡ï¼‰å³å¯æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œå¾…åˆ°ä¸šåŠ¡å¢é•¿ã€æ•°æ®é‡å¢å¤§çš„æ—¶å€™ï¼Œå†é€šè¿‡æ–°å¢æ•°æ®åˆ†ç‰‡çš„æ–¹å¼åˆ†æµæ•°æ®ï¼Œå¹¶é€šè¿‡åˆ†å¸ƒå¼è¡¨å®ç°åˆ†å¸ƒå¼æŸ¥è¯¢ã€‚è¿™å°±å¥½æ¯”ä¸€è¾†æ‰‹åŠ¨æŒ¡èµ›è½¦ï¼Œå®ƒå°†æ‰€æœ‰çš„é€‰æ‹©æƒéƒ½äº¤ç»™äº†ä½¿ç”¨è€…ã€‚</strong></p>
<h3 id="ClickHouse-å…·æœ‰æ— ä¸ä¼¦æ¯”çš„æŸ¥è¯¢é€Ÿåº¦"><a href="#ClickHouse-å…·æœ‰æ— ä¸ä¼¦æ¯”çš„æŸ¥è¯¢é€Ÿåº¦" class="headerlink" title="ClickHouse å…·æœ‰æ— ä¸ä¼¦æ¯”çš„æŸ¥è¯¢é€Ÿåº¦"></a>ClickHouse å…·æœ‰æ— ä¸ä¼¦æ¯”çš„æŸ¥è¯¢é€Ÿåº¦</h3><p><strong>ClickHouse æŸ¥è¯¢é€Ÿåº¦å¿«æˆ‘ä»¬å·²ç»è¯´è¿‡äº†ï¼Œè¿™é‡Œæ¥æ¢è®¨ä¸€ä¸‹é€Ÿåº¦å¿«çš„åŸå› ï¼Œè™½ç„¶å‰é¢å¯¹è¿™ä¸ªé—®é¢˜å·²ç»åšå‡ºäº†ç§‘å­¦åˆç†çš„è§£é‡Šï¼Œæ¯”æ–¹è¯´ï¼šå› ä¸º ClickHouse æ˜¯åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼›ClickHouse ä½¿ç”¨äº†å‘é‡åŒ–å¼•æ“ç­‰ç­‰ã€‚è¿™äº›è§£é‡Šè™½ç„¶éƒ½ç«™å¾—ä½è„šï¼Œä½†æ˜¯ä¾ç„¶ä¸èƒ½æ¶ˆé™¤å…¨éƒ¨çš„ç–‘é—®ï¼Œå› ä¸ºè¿™äº›æŠ€æœ¯ä¸æ˜¯ä»€ä¹ˆç§˜å¯†ï¼Œå¸‚é¢æœ‰å¾ˆå¤šæ•°æ®åº“åŒæ ·ä½¿ç”¨äº†è¿™äº›æŠ€æœ¯ï¼Œä½†æ˜¯ä¾ç„¶æ²¡æœ‰ ClickHouse è¿™ä¹ˆå¿«ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥æ¢è®¨ä¸€ç•ª ClickHouse çš„ç§˜è¯€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p><strong>é¦–å…ˆæŠ›å‡ºä¸€ä¸ªç–‘é—®ï¼šåœ¨è®¾è®¡è½¯ä»¶æ¶æ„çš„æ—¶å€™ï¼Œåšè®¾è®¡çš„åŸåˆ™åº”è¯¥æ˜¯è‡ªé¡¶å‘ä¸‹åœ°å»è®¾è®¡ï¼Œè¿˜æ˜¯è‡ªåº•å‘ä¸Šåœ°å»è®¾è®¡å‘¢ï¼Ÿåœ¨ä¼ ç»Ÿçš„è§‚å¿µä¸­ï¼Œè‡ªç„¶æ˜¯è‡ªé¡¶å‘ä¸‹çš„è®¾è®¡ï¼Œå› ä¸ºåœ¨åšä»€ä¹ˆäº‹æƒ…çš„ä¸€å®šå…ˆæœ‰ä¸€ä¸ªå¤§çº²ï¼Œç„¶åå†æ…¢æ…¢å®ç°ç»†èŠ‚ã€‚è€Œ ClickHouse çš„è®¾è®¡åˆ™é‡‡ç”¨äº†è‡ªåº•å‘ä¸Šçš„æ–¹å¼ï¼Œå› ä¸ºå®ƒçš„åŸå‹æ—©åœ¨ 2008 å¹´å°±è¯ç”Ÿäº†ï¼Œåœ¨è¯ç”Ÿä¹‹å¤„å®ƒå¹¶æ²¡æœ‰å®ä¼Ÿçš„è§„åˆ’ã€‚ç›¸åå®ƒçš„ç›®çš„å¾ˆå•çº¯ï¼Œå°±æ˜¯å¸Œæœ›èƒ½ä»¥æœ€å¿«çš„é€Ÿåº¦è¿›è¡Œ GROUP BY æŸ¥è¯¢å’Œè¿‡æ»¤ï¼Œé‚£ä¹ˆæˆ˜æ–—æ°‘æ—çš„æ”»åŸç‹®ä»¬æ˜¯å¦‚ä½•å®ç°è‡ªåº•å‘ä¸Šçš„è®¾è®¡å‘¢ï¼Ÿ</strong></p>
<h4 id="ç€çœ¼ç¡¬ä»¶ï¼Œå…ˆæƒ³ååš"><a href="#ç€çœ¼ç¡¬ä»¶ï¼Œå…ˆæƒ³ååš" class="headerlink" title="ç€çœ¼ç¡¬ä»¶ï¼Œå…ˆæƒ³ååš"></a>ç€çœ¼ç¡¬ä»¶ï¼Œå…ˆæƒ³ååš</h4><p><strong>é¦–å…ˆä»ç¡¬ä»¶åŠŸèƒ½å±‚é¢ç€æ‰‹è®¾è®¡ï¼Œåœ¨è®¾è®¡ä¼Šå§‹å°±è‡³å°‘éœ€è¦æƒ³æ¸…æ¥šå¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</strong></p>
<ul>
<li><code>å°†è¦ä½¿ç”¨çš„ç¡¬ä»¶æ°´å¹³æ˜¯æ€æ ·çš„ï¼ŸåŒ…æ‹¬ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œç­‰ç­‰</code></li>
<li><code>åœ¨è¿™æ ·çš„ç¡¬ä»¶ä¸Šï¼Œéœ€è¦è¾¾åˆ°æ€æ ·çš„æ€§èƒ½ï¼ŸåŒ…æ‹¬å»¶è¿Ÿã€ååé‡ç­‰ç­‰</code></li>
<li><code>å‡†å¤‡ä½¿ç”¨æ€æ ·çš„æ•°æ®ç»“æ„ï¼ŸåŒ…æ‹¬ Stringã€HashTableã€Vetcor ç­‰ç­‰</code></li>
<li><code>é€‰æ‹©è¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œåœ¨ç¡¬ä»¶ä¸Šä¼šå¦‚ä½•å·¥ä½œï¼Ÿ</code></li>
</ul>
<p><strong>å¦‚æœèƒ½æƒ³æ¸…æ¥šä¸Šé¢è¿™äº›é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨åŠ¨æ‰‹å®ç°åŠŸèƒ½ä¹‹å‰ï¼Œå°±å·²ç»èƒ½å¤Ÿè®¡ç®—å‡ºç²—ç•¥çš„æ€§èƒ½äº†ã€‚æ‰€ä»¥ï¼ŒåŸºäºå°†ç¡¬ä»¶åŠŸæ•ˆæœ€å¤§åŒ–çš„ç›®çš„ï¼ŒClickHouse ä¼šåœ¨å†…å­˜ä¸­è¿›è¡Œ GROUP BYï¼Œå¹¶ä¸”ä½¿ç”¨ HashTable è£…è½½æ•°æ®ã€‚ä¸æ­¤åŒæ—¶ï¼Œæ”»åŸç‹®ä»¬éå¸¸åœ¨æ„ CPU L3 çº§åˆ«çš„ç¼“å­˜ï¼Œå› ä¸ºä¸€æ¬¡ L3 çš„ç¼“å­˜å¤±æ•ˆå°†ä¼šå¸¦æ¥ 700~100ns çš„å»¶è¿Ÿï¼Œè¿™æ„å‘³ç€åœ¨å•æ ¸ CPU ä¸Šï¼Œå®ƒä¼šæµªè´¹æ¯ç§’ 4000 ä¸‡æ¬¡çš„è¿ç®—ï¼›è€Œåœ¨ä¸€ä¸ª 32 çº¿ç¨‹çš„ CPU ä¸Šï¼Œå°†ä¼šæµªè´¹æ¯ç§’ 5 äº¿æ¬¡çš„è¿ç®—ã€‚æ‰€ä»¥åˆ«å°çœ‹è¿™äº›ç»†èŠ‚ï¼Œä¸€ç‚¹ä¸€æ»´åœ°å°†å®ƒä»¬ç´¯åŠ èµ·æ¥ï¼Œæ•°æ®æ˜¯éå¸¸å¯è§‚çš„ã€‚æ­£æ˜¯å› ä¸ºæ³¨æ„è¿™äº›ç»†èŠ‚ï¼ŒClickHouse åœ¨åŸºå‡†æŸ¥è¯¢ä¸­æ‰èƒ½åšåˆ°æ¯ç§’ 1.75 äº¿æ¬¡çš„æ•°æ®æ‰«ææ€§èƒ½ã€‚</strong></p>
<h4 id="ç®—æ³•åœ¨å‰ï¼ŒæŠ½è±¡åœ¨å"><a href="#ç®—æ³•åœ¨å‰ï¼ŒæŠ½è±¡åœ¨å" class="headerlink" title="ç®—æ³•åœ¨å‰ï¼ŒæŠ½è±¡åœ¨å"></a>ç®—æ³•åœ¨å‰ï¼ŒæŠ½è±¡åœ¨å</h4><p><strong>å¸¸æœ‰äººå¿µå¨ï¼šâ€æœ‰æ—¶å€™é€‰æ‹©æ¯”åŠªåŠ›æ›´é‡è¦â€ï¼Œç¡®å®ï¼Œè·¯çº¿é€‰é”™äº†çš„è¯å†åŠªåŠ›ä¹Ÿæ˜¯ç™½æ­ã€‚åœ¨ ClickHouse çš„åº•å±‚å®ç°ä¸­ï¼Œç»å¸¸ä¼šé¢å¯¹ä¸€äº›é‡å¤çš„åœºæ™¯ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²å­ä¸²æŸ¥è¯¢ã€æ•°æ®æ’åºã€ä½¿ç”¨ HashTable ç­‰ï¼Œå¦‚ä½•æ‰èƒ½å®ç°æ€§èƒ½çš„æœ€å¤§åŒ–å‘¢ï¼Ÿç®—æ³•çš„é€‰æ‹©å°±å˜æˆäº†é‡ä¸­ä¹‹é‡ã€‚ä»¥å­—ç¬¦ä¸²ä¸ºä¾‹ï¼Œæœ‰ä¸€æœ¬ä¸“é—¨è®²è§£å­—ç¬¦ä¸²æœç´¢çš„ä¹¦ï¼Œé‡Œé¢åˆ—ä¸¾äº† 35 ç§å¸¸è§çš„å­—ç¬¦ä¸²æœç´¢ç®—æ³•ï¼Œé‚£ä¹ˆä½ çŒœçŒœ ClickHouse ä½¿ç”¨äº†é‡Œé¢çš„å“ªç§ç®—æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸€ç§éƒ½æ²¡æœ‰ï¼Œå› ä¸ºæ€§èƒ½ä¸å¤Ÿå¿«ï¼Œåœ¨å­—ç¬¦ä¸²æœç´¢æ–¹é¢ï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼ŒClickHouse æœ€ç»ˆé€‰æ‹©äº†è¿™äº›ç®—æ³•ï¼šå¯¹äºå¸¸é‡ï¼Œä½¿ç”¨ Volnitsky ç®—æ³•ï¼›å¯¹äºéå¸¸é‡ï¼Œä½¿ç”¨ CPU çš„å‘é‡åŒ–æ‰§è¡Œ SIMDï¼Œæš´åŠ›ä¼˜åŒ–ï¼›æ­£åˆ™åŒ¹é…ä½¿ç”¨ re2 å’Œ hyperscan ç®—æ³•ã€‚</strong></p>
<blockquote>
<p><strong>æ€§èƒ½æ˜¯ç®—æ³•é€‰æ‹©çš„é¦–è¦è€ƒé‡æŒ‡æ ‡ã€‚</strong></p>
</blockquote>
<h4 id="ç”¨äºå°é²œï¼Œä¸è¡Œå°±æ¢"><a href="#ç”¨äºå°é²œï¼Œä¸è¡Œå°±æ¢" class="headerlink" title="ç”¨äºå°é²œï¼Œä¸è¡Œå°±æ¢"></a>ç”¨äºå°é²œï¼Œä¸è¡Œå°±æ¢</h4><p><strong>é™¤äº†å­—ç¬¦ä¸²ä¹‹å¤–ï¼Œå…¶ä½™çš„åœºæ™¯ä¹Ÿä¸å®ƒç±»ä¼¼ï¼ŒClickHouse ä¼šä½¿ç”¨æœ€åˆé€‚ã€æœ€å¿«çš„ç®—æ³•ã€‚å¦‚æœå¸‚é¢ä¸Šå‡ºç°äº†å·ç§°æ€§èƒ½æœ€å¼ºå¤§çš„æ–°ç®—æ³•ï¼Œé‚£ä¹ˆ ClickHouse å›¢é˜Ÿå°±ä¼šç«‹å³å°†å…¶çº³å…¥å¹¶è¿›è¡ŒéªŒè¯ã€‚å¦‚æœæ•ˆæœä¸é”™å°±ä¿ç•™ä½¿ç”¨ï¼Œä¸å°½äººæ„çš„è¯å°±å°†å…¶ä¸¢å¼ƒã€‚</strong></p>
<h4 id="ç‰¹å®šåœºæ™¯ï¼Œç‰¹æ®Šä¼˜åŒ–"><a href="#ç‰¹å®šåœºæ™¯ï¼Œç‰¹æ®Šä¼˜åŒ–" class="headerlink" title="ç‰¹å®šåœºæ™¯ï¼Œç‰¹æ®Šä¼˜åŒ–"></a>ç‰¹å®šåœºæ™¯ï¼Œç‰¹æ®Šä¼˜åŒ–</h4><p><strong>é’ˆå¯¹åŒä¸€ä¸ªåœºæ™¯çš„ä¸åŒçŠ¶å†µï¼Œé€‰æ‹©ä½¿ç”¨ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå°½å¯èƒ½å°†æ€§èƒ½æœ€å¤§åŒ–ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œå…¶å®åœ¨å‰é¢ä»‹ç»å­—ç¬¦ä¸²æŸ¥è¯¢çš„æ—¶å€™ï¼Œé’ˆå¯¹ä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒç®—æ³•çš„æ€è·¯å°±æœ‰æ‰€ä½“ç°äº†ã€‚</strong></p>
<p><strong>ç±»ä¼¼çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚å»é‡è®¡æ•° uniqCombined å‡½æ•°ï¼Œä¼šæ ¹æ®æ•°æ®é‡çš„ä¸åŒé€‰æ‹©ä¸åŒçš„ç®—æ³•ï¼›å½“æ•°æ®é‡å¾ˆå°çš„æ—¶å€™ï¼Œä¼šé€‰æ‹©ä½¿ç”¨ Array ä¿å­˜ï¼›å½“æ•°æ®é‡ä¸­ç­‰çš„æ—¶å€™ï¼Œä¼šé€‰æ‹© HashSetï¼›è€Œå½“æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨ HyperLogLog ç®—æ³•ã€‚</strong></p>
<p><strong>å¯¹äºæ•°æ®ç»“æ„åŒ–æ¯”è¾ƒæ¸…æ™°çš„åœºæ™¯ï¼Œä¼šé€šè¿‡ä»£ç ç”ŸæˆæŠ€æœ¯å®ç°å¾ªç¯å±•å¼€ï¼Œä»¥å‡å°‘å¾ªç¯æ¬¡æ•°ã€‚æ¥ç€å°±æ˜¯å¤§å®¶ç†ŸçŸ¥çš„å¤§æ€å™¨ â€œå‘é‡åŒ–æ‰§è¡Œâ€ã€‚SIMD è¢«å¹¿æ³›åœ°åº”ç”¨äºæ–‡æœ¬è½¬æ¢ã€æ•°æ®è¿‡æ»¤ã€æ•°æ®è§£å‹å’Œ JSON è½¬æ¢ç­‰åœºæ™¯ã€‚ç›¸è¾ƒäºå•çº¯åœ°ä½¿ç”¨ CPUï¼Œåˆ©ç”¨å¯„å­˜å™¨æš´åŠ›ä¼˜åŒ–ä¹Ÿç®—æ˜¯ä¸€ç§é™ç»´æ‰“å‡»äº†ã€‚</strong></p>
<h4 id="æŒç»­æµ‹è¯•ï¼ŒæŒç»­æ”¹è¿›"><a href="#æŒç»­æµ‹è¯•ï¼ŒæŒç»­æ”¹è¿›" class="headerlink" title="æŒç»­æµ‹è¯•ï¼ŒæŒç»­æ”¹è¿›"></a>æŒç»­æµ‹è¯•ï¼ŒæŒç»­æ”¹è¿›</h4><p><strong>å¦‚æœåªæ˜¯å•çº¯åœ°åœ¨ä¸Šè¿°ç»†èŠ‚ä¸Šä¸‹åŠŸå¤«ï¼Œè¿˜ä¸è¶³ä»¥æ„å»ºå‡ºå¦‚æ­¤å¼ºå¤§çš„ ClickHouseï¼Œå› æ­¤è¿˜éœ€è¦ä¸€ä¸ªèƒ½å¤ŸæŒç»­éªŒè¯ã€æŒç»­æ”¹è¿›çš„æœºåˆ¶ã€‚ç”±äº Yandex å…¬å¸çš„å¤©ç„¶ä¼˜åŠ¿ï¼ŒClickHouse ç»å¸¸ä½¿ç”¨çœŸå®çš„æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¸€ç‚¹å¾ˆå¥½åœ°ä¿è¯äº†æµ‹è¯•åœºæ™¯çš„çœŸå®æ€§ã€‚ä¸æ­¤åŒæ—¶ï¼ŒClickHouse ç®—æ˜¯æ›´æ–°é€Ÿåº¦æœ€å¿«çš„å¼€æºè½¯ä»¶äº†ï¼Œå·®ä¸å¤šæ¯ä¸ªæœˆéƒ½èƒ½å‘å¸ƒä¸€ä¸ªç‰ˆæœ¬ï¼Œæ²¡æœ‰ä¸€ä¸ªå¯é çš„æŒç»­é›†æˆç¯å¢ƒï¼Œè¿™ä¸€ç‚¹æ˜¯åšä¸åˆ°çš„ã€‚æ­£å› ä¸ºæ‹¥æœ‰è¿™æ ·çš„é¢‘ç‡ï¼ŒClickHouse æ‰èƒ½å¿«é€Ÿè¿­ä»£ã€å¿«é€Ÿæ”¹è¿›ã€‚</strong></p>
<p><strong>æ‰€ä»¥ ClickHouse çš„é»‘é­”æ³•å¹¶ä¸æ˜¯ä¸€é¡¹å•ä¸€çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§è‡ªåº•å‘ä¸Šçš„ã€è¿½æ±‚æé™æ€§èƒ½çš„è®¾è®¡æ€è·¯ï¼Œè¿™å°±æ˜¯å®ƒå¦‚æ­¤å—çš„ç§˜è¯€ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„æ‰§è¡Œè®¡åˆ’ä»¥åŠä¼˜åŒ–ç­–ç•¥(åå…­)</title>
    <url>/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„æ‰§è¡Œè®¡åˆ’ä»¥åŠä¼˜åŒ–ç­–ç•¥-åå…­"><a href="#ClickHouse-çš„æ‰§è¡Œè®¡åˆ’ä»¥åŠä¼˜åŒ–ç­–ç•¥-åå…­" class="headerlink" title="ClickHouse çš„æ‰§è¡Œè®¡åˆ’ä»¥åŠä¼˜åŒ–ç­–ç•¥(åå…­)"></a>ClickHouse çš„æ‰§è¡Œè®¡åˆ’ä»¥åŠä¼˜åŒ–ç­–ç•¥(åå…­)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h3 id="æ‰§è¡Œè®¡åˆ’"><a href="#æ‰§è¡Œè®¡åˆ’" class="headerlink" title="æ‰§è¡Œè®¡åˆ’"></a>æ‰§è¡Œè®¡åˆ’</h3><p><strong>å¦‚æœè¦åœ¨ ClickHouse 20.6 ç‰ˆæœ¬ä¹‹å‰æŸ¥çœ‹ SQL è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œéœ€è¦åœ¨ config.xml é‡Œé¢å°†æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º traceã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ–°ç‰ˆæœ¬é»˜è®¤æ˜¯ trace --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">level</span>&gt;</span>trace<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åè¿˜è¦çœŸæ­£æ‰§è¡Œç›¸åº”çš„ SQL è¯­å¥ï¼Œåœ¨æ‰§è¡Œæ—¥å¿—é‡Œé¢æŸ¥çœ‹ï¼Œå¾ˆæ˜æ˜¾è¿™æ˜¯éå¸¸ä¸æ–¹ä¾¿çš„ã€‚äºæ˜¯ ClickHouse åœ¨ 20.6 ç‰ˆæœ¬é‡Œé¢å¼•å…¥äº†åŸç”Ÿçš„æ‰§è¡Œè®¡åˆ’çš„è¯­æ³•ï¼ˆæ­¤æ—¶å¤„äºè¯•ç”¨æœŸé˜¶æ®µï¼‰ï¼Œå¹¶åœ¨ 20.6.3 ç‰ˆæœ¬ä¸­æ­£å¼è½¬æ­£ã€‚</strong></p>
<blockquote>
<p><strong>æˆ‘ä»¬å½“å‰ç³»åˆ—éƒ½æ˜¯åŸºäº ClickHouse çš„ 21.7.3.14 ç‰ˆæœ¬ã€‚</strong></p>
</blockquote>
<p><strong>ç„¶åæˆ‘ä»¬æ¥ä»‹ç»å¦‚ä½•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œä¸è¿‡ä»‹ç»ä¹‹å‰æˆ‘ä»¬å…ˆåˆ›å»ºä¸€å¼ æ•°æ®è¡¨ï¼Œè¿™æ¬¡æˆ‘ä»¬é‡‡ç”¨çœŸå®çš„æ•°æ®ã€‚é¦–å…ˆ ClickHouse å®˜æ–¹æä¾›äº†ä¸¤ä¸ªæ•°æ®é›†ï¼Œå…¶ä¸­æ•°æ®è¡Œæ•°å’Œå­—æ®µæ•°éƒ½éå¸¸çš„å¤§ï¼Œä¸äºšäºä¸€äº›å…¬å¸ç”Ÿäº§ç¯å¢ƒä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬æ¥ä¸‹è½½ä¸€ä¸‹ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½æ•°æ®é›†ï¼Œè¿™é‡Œçš„æ•°æ®é›†ä¸æ˜¯ CSVã€JSONï¼Œè€Œæ˜¯ .binã€.mrk ç­‰ç‰©ç†æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ä¹Ÿå°±æ˜¯è¯´æ•°æ®é›†æœ¬èº«å°±æ˜¯ç¬¦åˆ ClickHouse ç‰©ç†å­˜å‚¨çš„</span></span><br><span class="line">curl -O https://datasets.clickhouse.tech/hits/partitions/hits_v1.tar</span><br><span class="line"><span class="comment"># æ‰€ä»¥æˆ‘ä»¬ç›´æ¥è§£å‹åˆ°æ‹·è´åˆ° /var/lib/clickhouse ç›®å½•ä¸‹å³å¯</span></span><br><span class="line">tar -xvf hits_v1.tar -C /var/lib/clickhouse</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ hits_v1 è¿™å¼ è¡¨äº†ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œå¿…é¡»è¦å…ˆåˆ›å»ºè¡¨ç„¶åå†å¯¼å…¥æ•°æ®ï¼Œå› ä¸ºåˆ›å»ºè¡¨çš„æ—¶å€™ä¼šç”Ÿæˆä¸€äº›å…ƒä¿¡æ¯ï¼Œå­˜å‚¨åœ¨ &#x2F;var&#x2F;lib&#x2F;clickhouse&#x2F;metadata ç›®å½•ä¸‹ï¼Œè€Œå…‰æœ‰æ•°æ®æ²¡æœ‰å…ƒä¿¡æ¯æ˜¯ä¸è¡Œçš„ã€‚ä½†å¯¹äºå½“å‰è€Œè¨€åˆ™ä¸ç”¨äº‹å…ˆåˆ›å»ºè¡¨ï¼Œå› ä¸º ClickHouse å°†å…ƒä¿¡æ¯ä¹Ÿå‡†å¤‡å¥½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ‹·è´è¿‡å»å³å¯ã€‚å‹ç¼©åŒ…è§£å‹ä¹‹åï¼Œä¼šæœ‰ä¸€ä¸ª data ç›®å½•å’Œä¸€ä¸ª metadata ç›®å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬è§£å‹åˆ° &#x2F;var&#x2F;lib&#x2F;clickhouse ä¸­ï¼Œä¼šè‡ªåŠ¨å°† data ç›®å½•é‡Œé¢çš„å†…å®¹åˆå¹¶åˆ° &#x2F;var&#x2F;lib&#x2F;clickhouse çš„ data ç›®å½•ä¸­ï¼Œå°† metadata ç›®å½•é‡Œé¢çš„å†…å®¹åˆå¹¶åˆ° &#x2F;var&#x2F;lib&#x2F;clickhouse çš„ metadata ç›®å½•ä¸­ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori data]<span class="comment"># ls</span></span><br><span class="line">datasets  default  system</span><br><span class="line">[root@satori data]<span class="comment"># ls datasets</span></span><br><span class="line">hits_v1</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹åˆ°é‡Œé¢å¤šäº†ä¸€ä¸ª datasets ç›®å½•ï¼Œdatasets ç›®å½•ä¸‹æ‰æ˜¯ hits_v1ï¼Œæ˜¾ç„¶æˆ‘ä»¬åç»­éœ€è¦ä½¿ç”¨ datasets.hits_v1 è¿›è¡ŒæŸ¥è¯¢ã€‚å½“ç„¶æ•°æ®é›†è¿˜æœ‰ä¸€ä»½ï¼Œæˆ‘ä»¬æŒ‰ç…§ç›¸åŒçš„å¥—è·¯å³å¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">curl <span class="operator">-</span>O https:<span class="operator">/</span><span class="operator">/</span>datasets.clickhouse.tech<span class="operator">/</span>visits<span class="operator">/</span>partitions<span class="operator">/</span>visits_v1.tar</span><br><span class="line">tar <span class="operator">-</span>xvf visits_v1.tar <span class="operator">-</span>C <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>clickhouse</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æ¥ç¡®è®¤ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori datasets]<span class="comment"># ls</span></span><br><span class="line">hits_v1  visits_v1</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶æ•°æ®é›†å·²ç»å‡†å¤‡å®Œæ¯•ï¼Œä¸è¿‡æˆ‘ä»¬å½“å‰ä½¿ç”¨çš„æ˜¯ root ç”¨æˆ·ï¼Œè¿˜åº”è¯¥è¦ç¡®ä¿ clickhouse ç”¨æˆ·æœ‰ç›¸åº”çš„æ“ä½œæƒé™ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> clickhouse:clickhouse /var/lib/clickhouse/data -R</span><br><span class="line"><span class="comment"># ç„¶åé‡å¯ ClickHouseï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ˜¯é€šè¿‡ CREATE TABLE åˆ›å»ºçš„è¡¨</span></span><br><span class="line"><span class="comment"># å› æ­¤è¦é‡å¯ï¼Œä¸ç„¶ ClickHouse æ˜¯ä¸çŸ¥é“æˆ‘ä»¬é€šè¿‡æ‹·è´æ–‡ä»¶çš„æ–¹å¼æ–°å¢äº†ä¸¤å¼ è¡¨</span></span><br><span class="line">clickhouse restart</span><br></pre></td></tr></table></figure>

<p><strong>é‡å¯ä¹‹åï¼Œæ‰§è¡Œ SQL è¯­å¥è¿›è¡ŒæŸ¥çœ‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913183943809-487548377.png" alt="img"></p>
<p><strong>æ•°æ®é‡è¿˜æ˜¯ä¸å°‘çš„ï¼Œdatasets.hits_v1 æœ‰å°†è¿‘ 900 ä¸‡æ¡æ•°æ®ã€å­—æ®µæ•° 130 å¤šä¸ªï¼Œdatasets.visit_v1 æœ‰ 160 å¤šä¸‡æ¡æ•°æ®ã€å­—æ®µæ•°ä¸º 180 å¤šä¸ªï¼Œè¿˜æ˜¯å¾ˆå¤§çš„ã€‚</strong></p>
<blockquote>
<p><strong>å…·ä½“éƒ½æœ‰å“ªäº›å­—æ®µï¼Œå¯ä»¥é€šè¿‡ &#x2F;var&#x2F;lib&#x2F;clickhouse&#x2F;metadata&#x2F;datasets ä¸‹çš„ .sql æ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹ã€‚</strong></p>
</blockquote>
<p><strong>æœ‰äº†æ•°æ®é›†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»‹ç»æŸ¥è¯¢è®¡åˆ’äº†ã€‚å½“ç„¶ä½¿ç”¨è¿™ç§è§„æ¨¡çš„æ•°æ®é›†æœ‰äº›å°é¢˜å¤§åšï¼Œä¸è¿‡æ—¢ç„¶ ClickHouse æ˜¯ä¸ºå¤§æ•°æ®å‡†å¤‡çš„ï¼Œé‚£ä¹ˆä½¿ç”¨å¤§ä¸€ç‚¹çš„æ•°æ®é›†ä¹Ÿæ— å¦¨ï¼Œè€Œä¸”æˆ‘ä»¬åé¢ä¹Ÿä¼šç»å¸¸ä½¿ç”¨è¿™äº›æ•°æ®é›†ã€‚</strong></p>
<h4 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h4><p><strong>åœ¨ MySQL ä¸­æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä½¿ç”¨çš„è¯­æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ²¡é”™ï¼ŒEXPLAINï¼Œåœ¨ ClickHouse ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåªä¸è¿‡ ClickHouse å°† EXPLAIN å˜å¾—æ›´åŠ ä¸°å¯Œã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAN [AST <span class="operator">|</span> SYNTAX <span class="operator">|</span> PLAN <span class="operator">|</span> PIPELINE] [SETTINGS <span class="operator">=</span> <span class="keyword">value</span>, ...]</span><br><span class="line"><span class="keyword">SELECT</span> ... [FORMAT ...]</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªä¸­æ‹¬å·é‡Œé¢çš„å†…å®¹ï¼ŒClickHouse é™¤äº†å¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å¾ˆå¤šå…¶å®ƒå†…å®¹ã€‚</strong></p>
<p><strong>1ï¼‰ASTï¼šæŸ¥çœ‹ç¼–è¯‘ä¹‹åçš„è¯­æ³•æ ‘ï¼Œè¿™ä¸ªä¸æ˜¯å¾ˆå¸¸ç”¨</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN AST</span><br><span class="line"><span class="keyword">SELECT</span> UserID, <span class="built_in">count</span>() <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&lt;</span> toDate(<span class="string">&#x27;2014-03-17&#x27;</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œä¸€ä¸‹ï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„è¯­æ³•æ ‘ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913183954791-1357266678.png" alt="img"></p>
<p><strong>2ï¼‰SYNTAXï¼šç”¨äºä¼˜åŒ–è¯­æ³•ï¼Œæœ‰æ—¶æˆ‘ä»¬æŒ‡å®šçš„æŸ¥è¯¢è¯­å¥æœªå¿…æ˜¯æœ€ä¼˜çš„ï¼Œé‚£ä¹ˆ ClickHouse åœ¨åº•å±‚ä¼šè¿›è¡Œä¼˜åŒ–ï¼ŒEXPLAIN SYNTAX å¯ä»¥è¿”å›å¯¹ä¸€æ¡ SQL è¯­å¥è¿›è¡Œä¼˜åŒ–åçš„ç»“æœã€‚é€šè¿‡å¯¹æ¯”ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„ SQL è¯­å¥ï¼Œå¯ä»¥æœ‰åŠ©äºæˆ‘ä»¬ç†è§£ ClickHouse çš„ä¼˜åŒ–æœºåˆ¶</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> UserID, <span class="built_in">count</span>() count <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&lt;</span> toDate(<span class="string">&#x27;2014-03-17&#x27;</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID <span class="keyword">ORDER</span> <span class="keyword">BY</span> count LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184005381-91963819.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°ä»…ä»…æ˜¯åšäº†ä¸€äº›æ ¼å¼ä¸Šè°ƒæ•´ï¼Œä½†ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„è¯­å¥æœ¬è´¨ä¸Šæ²¡å·®åˆ«ï¼Œè¯æ˜å¯¹äºå½“å‰æŸ¥è¯¢è€Œè¨€ï¼Œæˆ‘ä»¬å†™çš„ SQL è¯­å¥å°±æ˜¯æœ€ä¼˜çš„ã€‚å› ä¸ºè¿™æ¡è¯­å¥å¤ªç®€å•äº†ï¼ŒClickHouse æ²¡æœ‰ä»€ä¹ˆå¯ä¼˜åŒ–çš„ã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬æ¥å†™å‡ ä¸ªéå¸¸è§„çš„è¯­å¥ï¼Œæ¯”å¦‚ä¸‰å…ƒè¡¨è¾¾å¼ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™æ˜¯åµŒå¥—çš„ä¸‰å…ƒè¡¨è¾¾å¼ï¼Œé‚£ä¹ˆ ClickHouse ä¼šæ€ä¹ˆä¼˜åŒ–å‘¢?</span></span><br><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> number <span class="operator">&lt;</span> <span class="number">5</span> ? <span class="string">&#x27;å°äº 5&#x27;</span> : (number <span class="operator">=</span> <span class="number">5</span> ? <span class="string">&#x27;ç­‰äº 5&#x27;</span> : <span class="string">&#x27;å¤§äº 5&#x27;</span>) <span class="keyword">FROM</span> numbers(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184026557-163630040.png" alt="img"></p>
<p><strong>æ³¨æ„ï¼šè¿™é‡Œå¹¶æ²¡æœ‰å¼€å¯ä¼˜åŒ–ï¼Œåªä¸è¿‡æ˜¯å°†ä¸‰å…ƒè¡¨è¾¾å¼ä½¿ç”¨ if è¯­å¥æ›¿æ¢äº†ï¼Œå› ä¸ºæ²¡æœ‰åµŒå¥—çš„ä¸‰å…ƒè¡¨è¾¾å¼åœ¨åº•å±‚å°±æ˜¯å¯¹åº” if å‡½æ•°çš„ä¸€ä¸ªè°ƒç”¨ã€‚åªä¸è¿‡ ClickHouse å°†ä¸€äº›æ¯”è¾ƒç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨ï¼ŒæŠ½è±¡æˆäº†ä¸€äº›è¯­æ³•ç³–ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œæ‰€ä»¥å½“å‰çš„ SQL è¯­å¥å¹¶æ²¡æœ‰å¾—åˆ°ä¼˜åŒ–ã€‚</strong></p>
<p><strong>äº‹å®ä¸Šï¼ŒClickHouse å¯¹ä¸‰å…ƒè¡¨è¾¾å¼çš„ä¼˜åŒ–é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æ‰“å¼€ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è§åçŸ¥æ„ï¼Œå°±æ˜¯å½“å‡ºç° if çš„åµŒå¥—æ—¶ï¼Œä¼˜åŒ–æˆ multiIf</span></span><br><span class="line"><span class="keyword">SET</span> optimize_if_chain_to_multiif <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184036739-210277828.png" alt="img"></p>
<p><strong>SYNTAX è¿˜æ˜¯å¾ˆå¸¸ç”¨çš„ï¼Œæˆ‘ä»¬å†™å®Œä¸€æ¡ SQL è¯­å¥ä¹‹åï¼Œå¯ä»¥ç›´æ¥ EXPLAIN SYNTAX ä¸€ä¸‹ï¼Œç„¶åå°†è¿”å›çš„ç»“æœæ›¿æ¢æ‰æˆ‘ä»¬åŸæ¥çš„ SQL è¯­å¥ã€‚</strong></p>
<p><strong>PLANï¼šæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œé»˜è®¤é€‰é¡¹</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> UserID, <span class="built_in">count</span>() count <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&lt;</span> toDate(<span class="string">&#x27;2014-03-17&#x27;</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID <span class="keyword">ORDER</span> <span class="keyword">BY</span> count LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184015646-1560810255.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°å›¾ä¸­çš„ EXPLAIN åé¢å¹¶æ²¡æœ‰å¸¦ä¸Š PLANï¼Œè¯´æ˜ PLAN æ˜¯é»˜è®¤é€‰é¡¹ï¼Œç„¶åæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æ—¶è¿˜å¯ä»¥è®¾ç½®ä¸€äº›é¢å¤–çš„å‚æ•°ï¼š</strong></p>
<ul>
<li><code>headerï¼šæ‰“å°è®¡åˆ’ä¸­å„ä¸ªæ­¥éª¤çš„ head è¯´æ˜ï¼Œé»˜è®¤å€¼ä¸º 0 è¡¨ç¤ºå…³é—­ï¼Œå¦‚æœå¼€å¯ï¼Œè®¾ç½®ä¸º 1</code></li>
<li><code>descriptionï¼šæ‰“å°è®¡åˆ’ä¸­å„ä¸ªæ­¥éª¤çš„æè¿°ï¼Œå°±æ˜¯å›¾ä¸­æ‹¬å·é‡Œé¢çš„éƒ¨åˆ†ï¼Œé»˜è®¤å€¼ä¸º 1 è¡¨ç¤ºå¼€å¯ï¼Œå¦‚æœå…³é—­ï¼Œè®¾ç½®ä¸º 0</code></li>
<li><code>actionsï¼šæ‰“å°è®¡åˆ’ä¸­å„ä¸ªæ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º 0 è¡¨ç¤ºå…³é—­ï¼Œå¦‚æœå¼€å¯ï¼Œè®¾ç½®ä¸º 1</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN header <span class="operator">=</span> <span class="number">1</span>, actions <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">SELECT</span> UserID, <span class="built_in">count</span>() count <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&lt;</span> toDate(<span class="string">&#x27;2014-03-17&#x27;</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID <span class="keyword">ORDER</span> <span class="keyword">BY</span> count LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><strong>è¾“å‡ºçš„å†…å®¹éå¸¸å¤šï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p><strong>PIPELINEï¼šæŸ¥çœ‹ PIPELINE è®¡åˆ’ï¼Œç±»ä¼¼äº PLAN</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN PIPELINE <span class="keyword">SELECT</span> <span class="built_in">sum</span>(number) <span class="keyword">FROM</span> numbers(<span class="number">100000</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> number <span class="operator">%</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184048889-202343307.png" alt="img"></p>
<p><strong>ç±»ä¼¼äº PLANï¼ŒæŸ¥çœ‹ PIPELINE è®¡åˆ’æ—¶è¿˜å¯ä»¥è®¾ç½®ä¸€äº›é¢å¤–çš„å‚æ•°ï¼š</strong></p>
<ul>
<li><code>headerï¼šæ‰“å°è®¡åˆ’ä¸­å„ä¸ªæ­¥éª¤çš„ head è¯´æ˜ï¼Œé»˜è®¤å€¼ä¸º 0 è¡¨ç¤ºå…³é—­ï¼Œå¦‚æœå¼€å¯ï¼Œè®¾ç½®ä¸º 1</code></li>
<li><code>graphï¼šç”¨ DOT å›¾å½¢è¯­è¨€æè¿°ç®¡é“å›¾ï¼Œé»˜è®¤å…³é—­ï¼Œ</code></li>
<li><code>actionsï¼šè¡¨ç¤ºå½“å¼€å¯ graph ä¹‹åæ˜¯å¦ç´§å‡‘æ‰“å°ï¼Œé»˜è®¤å¼€å¯</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN PIPELINE header <span class="operator">=</span> <span class="number">1</span>, graph <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(number) <span class="keyword">FROM</span> numbers(<span class="number">100000</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> number <span class="operator">%</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥è‡ªå·±æŸ¥çœ‹ä¸€ä¸‹è¾“å‡ºã€‚</strong></p>
<h3 id="å»ºè¡¨ä¼˜åŒ–"><a href="#å»ºè¡¨ä¼˜åŒ–" class="headerlink" title="å»ºè¡¨ä¼˜åŒ–"></a>å»ºè¡¨ä¼˜åŒ–</h3><p><strong>æˆ‘ä»¬åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šçš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ ORDER BYã€è¡¨å¼•æ“ã€è¡¨å‚æ•°ã€åˆ†åŒºå­—æ®µç­‰ç­‰ï¼Œè¿™äº›å¯¹åç»­æ•°æ®çš„æŸ¥è¯¢æ•ˆç‡éƒ½æ˜¯æœ‰å½±å“çš„ï¼Œå½“ç„¶æŒ‡å®šåˆé€‚çš„æ•°æ®ç±»å‹ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚ä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹å¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µã€‚</strong></p>
<h4 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h4><p><strong>åœ¨å»ºè¡¨çš„æ—¶å€™èƒ½ç”¨æ•°å€¼ç±»å‹å’Œæ—¥æœŸæ—¶é—´ç±»å‹è¡¨ç¤ºçš„å­—æ®µå°±ä¸è¦ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œè™½ç„¶å­—ç¬¦ä¸²ç±»å‹åœ¨ä»¥ Hive ä¸ºä¸­å¿ƒçš„æ•°ä»“å»ºè®¾ä¸­éå¸¸å¸¸è§ï¼Œä½† ClickHouse å´å¹¶éå¦‚æ­¤ã€‚æˆ‘ä»¬çŸ¥é“åœ¨ Hive ä¸­ï¼Œæ—¥æœŸä¸€èˆ¬éƒ½ç”¨å­—ç¬¦ä¸²ï¼Œä¸ä¼šç‰¹æ„ä½¿ç”¨ Date ç±»å‹ã€‚ä½†åœ¨ ClickHouse ä¸­ï¼Œèƒ½ä¸è¦ String å°±ä¸è¦ç”¨ï¼Œå› ä¸ºåæœŸè¿˜è¦è½¬æ¢ã€‚</strong></p>
<p><strong>å¯¹äº DateTimeï¼ŒClickHouse åº•å±‚ä¼šè½¬æˆæ—¶é—´æˆ³è¿›è¡Œå­˜å‚¨ï¼Œä½†æˆ‘ä»¬ä¸è¦æ˜¾å¼åœ°ä½¿ç”¨ UInt64 ç±»å‹æ¥å­˜å‚¨ã€‚å› ä¸º DateTime ä¸éœ€è¦ç»è¿‡å‡½æ•°è½¬æ¢å¤„ç†ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ï¼Œå¯è¯»æ€§å¥½ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_t (</span><br><span class="line">    id UInt32,</span><br><span class="line">    product String,</span><br><span class="line">    amount <span class="type">Decimal</span>(<span class="number">16</span>, <span class="number">2</span>),</span><br><span class="line">    create_time UInt32  <span class="comment">-- è¿™é‡Œä½¿ç”¨äº†æ•´æ•°å­˜å‚¨æ—¶é—´</span></span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree(create_time)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMMDD(toDate(create_time))  <span class="comment">-- éœ€è¦è½¬æ¢ä¸€æ¬¡ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>é™¤äº†æ—¥æœŸç±»å‹å’Œæ•°å€¼ç±»å‹ä¸ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºä¹‹å¤–ï¼ŒNull ä¹Ÿæ˜¯æ‹–ç´¯æ€§èƒ½çš„ä¸€ä¸ªç½ªé­ç¥¸é¦–ï¼Œå› ä¸ºå®˜æ–¹å·²ç»æŒ‡å‡º Null ä¼šå½±å“æ€§èƒ½äº†ã€‚å› ä¸ºå­˜å‚¨ Nullable ç±»å‹çš„åˆ—æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé¢å¤–çš„æ–‡ä»¶æ¥å­˜å‚¨ Null æ ‡è®°ï¼Œå¹¶ä¸” Nullable ç±»å‹çš„åˆ—æ— æ³•è¢«ç´¢å¼•ã€‚å› æ­¤é™¤äº†æç‰¹æ®Šçš„æƒ…å†µï¼Œå¦åˆ™ä¸è¦å°†åˆ—è®¾ç½®ä¸º Nullableï¼Œå¯ä»¥ç”¨ä¸€ä¸ªä¸å¯èƒ½å‡ºç°çš„é»˜è®¤å€¼ã€æˆ–è€…åœ¨ä¸šåŠ¡ä¸­æ— æ„ä¹‰çš„æ¥ä»£æŒ‡ç©ºï¼Œä¾‹å¦‚å°† id è®¾ç½®ä¸º -1 è¡¨ç¤ºè¯¥å•†å“æ²¡æœ‰ idï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Nullã€‚</strong></p>
<h4 id="åˆ†åŒºå’Œç´¢å¼•"><a href="#åˆ†åŒºå’Œç´¢å¼•" class="headerlink" title="åˆ†åŒºå’Œç´¢å¼•"></a>åˆ†åŒºå’Œç´¢å¼•</h4><p><strong>åˆ†åŒºç²’åº¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹å†³å®šï¼Œä½†ä¸å®œè¿‡ç²—æˆ–è€…è¿‡ç»†ï¼Œå¦‚æœæ•°æ®ä¹‹é—´æ˜¯ä¸¥æ ¼æŒ‰ç…§æ—¶é—´æ¥åˆ’åˆ†ï¼Œæ¯”å¦‚ç»å¸¸è¦æŒ‰å¤©ã€æŒ‰æœˆæˆ–è€…æŒ‰å¹´æ±‡æ€»å¤„ç†ï¼Œé‚£ä¹ˆä¸å¦¨é€‰æ‹©æŒ‰å¤©åˆ†åŒºæˆ–è€…æŒ‰æœˆåˆ†åŒºï¼›å¦‚æœæ•°æ®æŒ‰ç…§åœ°åŒºæ¥åˆ’åˆ†ï¼Œæ¯”å¦‚ç»å¸¸é’ˆå¯¹ä¸åŒçš„åœ°åŒºå•ç‹¬æ±‡æ€»ï¼Œé‚£ä¹ˆä¸å¦¨æŒ‰ç…§åœ°åŒºåˆ†åŒºã€‚é‚£ä¹ˆåˆ†åŒºåˆ°åº•è¦åˆ†å¤šå°‘ä¸ªåŒºå‘¢ï¼Ÿä»¥å•è¡¨ä¸€äº¿æ¡æ•°æ®ä¸ºä¾‹ï¼Œåˆ†åŒºå¤§å°æ§åˆ¶åœ¨ 10 åˆ° 30 ä¸ªæœ€å¥½ã€‚æ‰€ä»¥å¦‚æœæŒ‰ç…§æ—¶é—´åˆ†åŒºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šæŒ‰å¤©ã€æŒ‰æœˆåˆ†åŒºï¼Œè‡³äºæŒ‰åˆ†é’Ÿåˆ†åŒºåˆ™ darkä¸å¿…ï¼Œå› ä¸ºè¿™æ ·åˆ†åŒºç›®å½•å°±å¤ªå¤šäº†ã€‚</strong></p>
<p><strong>è¿˜æœ‰æŒ‡å®šç´¢å¼•åˆ—ï¼Œé»˜è®¤é€šè¿‡ ORDER BY æŒ‡å®šã€‚ORDER BY åœ¨ ClickHouse ä¸­æ˜¯æœ€é‡è¦çš„ï¼Œå› ä¸ºåˆ†åŒºå†…çš„æ’åºé€šè¿‡ ORDER BY æŒ‡å®šï¼Œä¸»é”®ï¼ˆç´¢å¼•ï¼‰é»˜è®¤ä¹Ÿæ˜¯ç”± ORDER BY æŒ‡å®šï¼Œå³ä½¿æˆ‘ä»¬æ˜¾å¼åœ°ä½¿ç”¨ PRIMARY KEY ä¸ä½¿ç”¨ ORDER BYï¼Œé‚£ä¹ˆä¸»é”®ä¹Ÿå¿…é¡»æ˜¯æ’åºé”®çš„å‰ç¼€ã€‚å½“ç„¶è¿™é‡Œçš„ ORDER BY æŒ‡çš„æ˜¯å»ºè¡¨æ—¶çš„ ORDER BYï¼Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ä¸­çš„ ORDER BYã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬åœ¨é€šè¿‡ ORDER BY æŒ‡å®šç´¢å¼•åˆ—çš„æ—¶å€™ï¼Œåº”è¯¥æŒ‡å®šæŸ¥è¯¢ä¸­ç»å¸¸è¢«ç”¨æ¥å……å½“ç­›é€‰æ¡ä»¶çš„åˆ—ï¼Œå¯ä»¥æ˜¯å•ä¸€ç»´åº¦ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»„åˆç»´åº¦ï¼Œå¦‚æœæ˜¯ç»„åˆç»´åº¦ï¼Œé‚£ä¹ˆç´¢å¼•åˆ—è¦æ»¡è¶³æŸ¥è¯¢é¢‘ç‡å¤§çš„åœ¨å‰åŸåˆ™ã€‚è¿˜æœ‰åŸºæ•°ç‰¹åˆ«å¤§çš„ä¸é€‚åˆåšç´¢å¼•åˆ—ï¼ŒåŸºæ•°å¤§æŒ‡çš„å°±æ˜¯é‚£äº›é‡å¤æ•°æ®éå¸¸å°‘çš„åˆ—ã€‚</strong></p>
<h4 id="è¡¨å‚æ•°"><a href="#è¡¨å‚æ•°" class="headerlink" title="è¡¨å‚æ•°"></a>è¡¨å‚æ•°</h4><p><strong>index_granularity æ˜¯ç”¨æ¥æ§åˆ¶ç´¢å¼•ç²’åº¦çš„ï¼Œé»˜è®¤æ˜¯ 8192ï¼Œå¦‚éå¿…é¡»ä¸å»ºè®®è°ƒæ•´ã€‚å¦å¤–ï¼Œå¦‚æœä¸€å¼ è¡¨ä¸æ˜¯å¿…é¡»è¦ä¿ç•™å…¨é‡å†å²æ•°æ®ï¼Œåˆ™å»ºè®®æŒ‡å®š TTLï¼Œå¯ä»¥å…å»æ‰‹åŠ¨æ¸…ç†è¿‡æœŸå†å²æ•°æ®çš„éº»çƒ¦ï¼ŒTTL ä¹Ÿå¯ä»¥é€šè¿‡ ALTER TABLE è¯­å¥éšæ—¶ä¿®æ”¹ã€‚</strong></p>
<h4 id="å†™å…¥å’Œåˆ é™¤ä¼˜åŒ–"><a href="#å†™å…¥å’Œåˆ é™¤ä¼˜åŒ–" class="headerlink" title="å†™å…¥å’Œåˆ é™¤ä¼˜åŒ–"></a>å†™å…¥å’Œåˆ é™¤ä¼˜åŒ–</h4><p><strong>å°½é‡ä¸è¦æ‰§è¡Œå•æ¡æˆ–å°æ‰¹é‡åˆ é™¤ã€æ’å…¥æ“ä½œï¼Œè¿™æ ·ä¼šäº§ç”Ÿå°åˆ†åŒºæ–‡ä»¶ï¼Œç»™åå° Merge ä»»åŠ¡å¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</strong></p>
<p><strong>ä¸è¦ä¸€æ¬¡å†™å…¥å¤ªå¤šåˆ†åŒºï¼Œæˆ–è€…æ•°æ®å†™å…¥å¤ªå¿«ï¼Œæ•°æ®å†™å…¥å¤ªå¿«ä¼šå¯¼è‡´ Merge é€Ÿåº¦è·Ÿä¸ä¸Šè€ŒæŠ¥é”™ï¼Œä¸€èˆ¬å»ºè®®æ¯ç§’é’Ÿå‘èµ· 2 ~ 3 æ­¤å†™å…¥æ“ä½œï¼Œæ¯æ¬¡æ“ä½œå†™å…¥ 2w ~ 5 w æ¡æ•°æ®ï¼ˆä¾æœåŠ¡å™¨æ€§èƒ½è€Œå®šï¼‰ã€‚</strong></p>
<h4 id="å¸¸è§é…ç½®"><a href="#å¸¸è§é…ç½®" class="headerlink" title="å¸¸è§é…ç½®"></a>å¸¸è§é…ç½®</h4><p><strong>æˆ‘ä»¬çŸ¥é“é…ç½®æ–‡ä»¶ä½äº &#x2F;etc&#x2F;clickhouse-server ç›®å½•ä¸‹ï¼Œé‡Œé¢æœ‰ config.xml å’Œ users.xmlï¼Œæˆ‘ä»¬ä¹‹å‰ä¸€ç›´è¯´ config.xmlï¼Œä½†å…¶å® users.xml ä¹Ÿéå¸¸é‡è¦ã€‚å®ƒä»¬éƒ½è¡¨ç¤ºæœåŠ¡ç«¯çš„é…ç½®ï¼Œè€ŒåŒºåˆ«ä¸»è¦åœ¨äº config.xml é‡Œé¢çš„é…ç½®æ˜¯æ— æ³•è¦†ç›–çš„ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç»å¸¸ä¼šä½¿ç”¨ set å‘½ä»¤å°†æŸä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹ï¼Œè¿™äº›å‚æ•°åˆ™æ˜¯æ”¾åœ¨ users.xml ä¸­ã€‚å½“ç„¶ä¸€ä¸ªè®¾ç½®å³å¯ä»¥åœ¨ users.xml ä¸­å‡ºç°ï¼Œä¹Ÿå¯ä»¥åœ¨ config.xml ä¸­å‡ºç°ï¼ŒæœåŠ¡ç«¯é¦–å…ˆä¼šä» config.xml ä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°å†å» config.xml ä¸­æ‰¾ã€‚</strong></p>
<p><strong>è€Œæˆ‘ä»¬ä¿®æ”¹é…ç½®ä¸»è¦æ˜¯ä¸ºäº†è°ƒæ•´ CPUã€å†…å­˜ã€IOï¼Œç“¶é¢ˆä¸»è¦åœ¨è¿™é‡Œã€‚å› ä¸º ClickHouse ä¼šæœ‰åå°çº¿ç¨‹ Merge æ•°æ®ï¼Œæ‰€ä»¥éå¸¸çš„åƒ CPUï¼›å½“ç„¶åŠ è½½æ•°æ®ï¼Œå¯¹å†…å­˜ä¹Ÿæ˜¯ä¸€ä¸ªè€ƒé‡ï¼›åŒç†è¿˜æœ‰ IOï¼Œå› ä¸ºè¦ä»ç£ç›˜ä¸Šè¯»å–å¤§é‡æ•°æ®ã€‚</strong></p>
<p><strong>ä¸‹é¢æ¥ä»‹ç»ä¸è¿™ä¸‰ä¸ªé…ç½®æœ‰å…³çš„å‚æ•°ã€‚</strong></p>
<p><strong>1ï¼‰CPU</strong></p>
<p><strong>background_pool_sizeï¼šä½äº users.xml ä¸­ï¼Œéå¸¸é‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºåå°çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ•°é‡ï¼ŒMerge çº¿ç¨‹å°±æ˜¯åœ¨è¯¥çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œè¯¥çº¿ç¨‹æ± ä¸ä»…ä»…æ˜¯ç»™ Merge çº¿ç¨‹ç”¨çš„ã€‚é»˜è®¤å€¼ä¸º 16ï¼Œå…è®¸çš„å‰æä¸‹å»ºè®®æ”¹æˆ CPU ä¸ªæ•°çš„äºŒå€ã€‚æ‰€ä»¥ ClickHouse ä¸å»ºè®®å’Œ HDFSã€Yarn ç­‰ä¸€èµ·éƒ¨ç½²ï¼Œå› ä¸º ClickHouse å¤ªåƒèµ„æºäº†ï¼Œä¸ç„¶ä¹Ÿè¾¾ä¸åˆ°å¦‚æ­¤å¯è§‚çš„é€Ÿåº¦</strong></p>
<p><strong>background_schedule_pool_sizeï¼šä½äº users.xml ä¸­ï¼Œè¡¨ç¤ºæ‰§è¡Œåå°ä»»åŠ¡çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼ä¸º 128ï¼Œå…è®¸çš„å‰æä¸‹å»ºè®®æ”¹æˆ CPU ä¸ªæ•°çš„äºŒå€</strong></p>
<p><strong>background_distributed_schedule_pool_sizeï¼šä½äº users.xml ä¸­ï¼Œè¡¨ç¤ºåˆ†å¸ƒå¼å‘é€æ‰§è¡Œåå°ä»»åŠ¡çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤å€¼ä¸º 16ï¼Œå…è®¸çš„å‰æä¸‹å»ºè®®æ”¹æˆ CPU ä¸ªæ•°çš„äºŒå€</strong></p>
<p><strong>max_concurrent_queriesï¼šä½äº config.xml ä¸­ï¼Œè¡¨ç¤ºæœ€å¤§å¹¶å‘å¤„ç†çš„è¯·æ±‚æ•°ï¼ˆåŒ…å« SELECTã€INSERT ç­‰ç­‰ï¼‰ï¼Œé»˜è®¤å€¼ä¸º 100ï¼Œæ¨è 150 ~ 300ï¼Œä¸å¤Ÿå†åŠ </strong></p>
<p><strong>max_threadsï¼šä½äº users.xml ä¸­ï¼Œè¡¨ç¤ºå•ä¸ªæŸ¥è¯¢æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§ CPU ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯ CPU æ ¸æ•°</strong></p>
<p>**ä»¥ä¸Šæ˜¯å…³äº CPU ç›¸å…³çš„è®¾ç½®ï¼Œå¦‚æœå‘ç°æœºå™¨åƒä¸æ¶ˆäº†ï¼Œé‚£ä¹ˆä¸å¦¨å‡å°‘ä¸€ä¸‹çº¿ç¨‹æ•°ã€‚ **</p>
<p><strong>2ï¼‰Memory</strong></p>
<p><strong>max_memory_usageï¼šä½äº users.xml ä¸­ï¼Œè¡¨ç¤ºå•æ¬¡ Query å ç”¨å†…å­˜çš„æœ€å¤§å€¼ï¼Œè¯¥å€¼å¯ä»¥è®¾ç½®çš„å¤§ä¸€äº›ï¼Œè¿™æ ·å¯ä»¥æé«˜é›†ç¾¤æŸ¥è¯¢çš„ä¸Šé™ã€‚å½“ç„¶ä¹Ÿè¦ä¿ç•™ä¸€äº›ç»™ OSï¼Œæ¯”å¦‚ 128G çš„å†…å­˜ï¼Œè®¾ç½®ä¸º 100G å³å¯</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184101340-936437929.png" alt="img"></p>
<p><strong>max_bytes_before_external_group_byï¼šè¡¨ç¤º GROUP BY ä½¿ç”¨çš„å†…å­˜çš„æœ€å¤§å€¼ï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªæœ€å¤§å€¼ï¼Œé‚£ä¹ˆä¼šåˆ·æ–°åˆ°ç£ç›˜è¿›è¡Œ GROUP BYï¼Œä¸€èˆ¬æŒ‰ç…§ max_memory_usage çš„ä¸€åŠè®¾ç½®å³å¯ã€‚å› ä¸º ClickHouse èšåˆåˆ†ä¸¤ä¸ªé˜¶æ®µï¼ŒæŸ¥è¯¢å¹¶å»ºç«‹ä¸­é—´æ•°æ®ã€åˆå¹¶ä¸­é—´æ•°æ®</strong></p>
<p><strong>max_bytes_before_external_sortï¼šè¡¨ç¤º ORDER BY ä½¿ç”¨çš„å†…å­˜çš„æœ€å¤§å€¼ï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªæœ€å¤§å€¼ï¼Œé‚£ä¹ˆä¼šåˆ·æ–°åˆ°ç£ç›˜è¿›è¡Œ ORDER BYã€‚å¦‚æœä¸è®¾ç½®è¯¥å€¼ï¼Œé‚£ä¹ˆå½“å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ç›´æ¥æŠ¥é”™ï¼Œè®¾ç½®äº†è¯¥å€¼ï¼ŒORDER BY åœ¨å†…å­˜ä¸å¤Ÿçš„æ—¶å€™å¯ä»¥åŸºäºç£ç›˜å®Œæˆï¼Œä½†æ˜¯é€Ÿåº¦ç›¸å¯¹å°±æ…¢äº†ï¼ˆå®é™…æµ‹è¯•å‘ç°æ…¢å¾—å¤šï¼Œç”šè‡³æ— æ³•æ¥å—ï¼‰ã€‚è¯¥å‚æ•°å’Œä¸Šä¸€ä¸ªå‚æ•°éƒ½åœ¨ users.xml ä¸­è®¾ç½®ã€‚</strong></p>
<p><strong>max_table_size_to_dropï¼šä½äº config.xml ä¸­ï¼Œåº”ç”¨äºéœ€è¦åˆ é™¤è¡¨æˆ–åˆ†åŒºçš„æƒ…å†µï¼Œé»˜è®¤æ˜¯ 50 GBï¼Œæ„æ€æ˜¯å¦‚æœåˆ é™¤ 50 GB ä»¥ä¸Šçš„æ•°æ®ä¼šå¤±è´¥ã€‚å»ºè®®è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºæ— è®ºåˆ†åŒºè¡¨ å¤šå¤§éƒ½å¯ä»¥åˆ é™¤</strong></p>
<p><strong>3ï¼‰IO</strong></p>
<p><strong>å’Œ HDFS ä¸åŒï¼ŒClickHouse ä¸æ”¯æŒè®¾ç½®å¤šæ•°æ®ç›®å½•ï¼Œä¸ºäº†æå‡ IO æ€§èƒ½ï¼Œå¯ä»¥æŒ‚è½½è™šæ‹Ÿåˆ¸ç»„ï¼ˆå°†å¤šå—ç£ç›˜è™šæ‹Ÿæˆä¸€å—ç£ç›˜ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªåˆ¸ç»„ç»‘å®šå¤šå—ç‰©ç†ç£ç›˜æå‡è¯»å†™æ€§èƒ½ã€‚æˆ–è€…ä½¿ç”¨ SSDï¼Œä½†æ˜¯æˆæœ¬å°±æ¯”è¾ƒé«˜äº†ã€‚</strong></p>
<h3 id="ClickHouse-è¯­æ³•ä¼˜åŒ–è§„åˆ™"><a href="#ClickHouse-è¯­æ³•ä¼˜åŒ–è§„åˆ™" class="headerlink" title="ClickHouse è¯­æ³•ä¼˜åŒ–è§„åˆ™"></a>ClickHouse è¯­æ³•ä¼˜åŒ–è§„åˆ™</h3><p><strong>å¾ˆå¤šæ•°æ®åº“åº•å±‚éƒ½å†…ç½®äº†ä¼˜åŒ–å™¨ï¼Œå®šä¹‰å¥½äº†è®¸å¤šçš„ä¼˜åŒ–è§„åˆ™ï¼Œç”¨äºç»™æˆ‘ä»¬çš„ SQL è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚å¤§å°è¡¨ JOINã€è°“è¯ä¸‹æ¨ç­‰ç­‰ï¼Œå°±æ˜¯ä¸ºäº†é¿å…å¼€å‘äººå‘˜æ‰§è¡Œæ…¢æŸ¥è¯¢ã€‚</strong></p>
<p><strong>é‚£ä¹ˆ ClickHouse ä¼šå¯¹å“ªäº›æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</strong></p>
<h4 id="COUNT-ä¼˜åŒ–"><a href="#COUNT-ä¼˜åŒ–" class="headerlink" title="COUNT ä¼˜åŒ–"></a>COUNT ä¼˜åŒ–</h4><p><strong>æˆ‘ä»¬è¯´å¦‚æœç»Ÿè®¡ä¸€å¼ è¡¨æœ‰å¤šå°‘è¡Œï¼Œé‚£ä¹ˆä½¿ç”¨ count() æˆ–è€… count(*) å³å¯ï¼Œæ­¤æ—¶ä¼šç›´æ¥è¯»å– count.txtã€‚è¿˜è®°å¾—è¿™ä¸ª count.txt æ–‡ä»¶å—ï¼Ÿæˆ‘ä»¬åœ¨ä»‹ç» MergeTree çš„æ—¶å€™è¯´è¿‡ï¼Œè¯¥æ–‡ä»¶é‡Œé¢å­˜å‚¨äº†è¡¨çš„è¡Œæ•°ï¼Œå½“ä½¿ç”¨ count() æˆ–è€… count(*) çš„æ—¶å€™ï¼Œç›´æ¥è¯»å–è¯¥æ–‡ä»¶å³å¯ï¼Œæ­¤æ—¶æ˜¯ä¸éœ€è¦å…¨è¡¨æ‰«æçš„ã€‚ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¹Ÿæ˜¯å¦‚æ­¤ï¼ŒMySQL åœ¨ä½¿ç”¨ count() çš„æ—¶å€™ä¹Ÿæ˜¯ç›´æ¥è®¡ç®—çš„ B+ æ ‘çš„å¶å­ç»“ç‚¹ä¸ªæ•°ã€‚</strong></p>
<p><strong>ä½†å½“æˆ‘ä»¬ count ä¸€ä¸ªå­—æ®µçš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±å¿…é¡»è¦å…¨è¡¨æ‰«æäº†ï¼Œè€Œä¸”æˆ‘ä»¬è¯´è¿‡ count å­—æ®µçš„æ—¶å€™ç»Ÿè®¡çš„æ˜¯è¯¥å­—æ®µä¸­éç©ºçš„å€¼çš„ä¸ªæ•°ã€‚å¦‚æœè¯¥å­—æ®µä¸­æ²¡æœ‰ç©ºå€¼ï¼Œcount(å­—æ®µ) çš„ç»“æœå’Œ count()ã€count(*) æ˜¯ç›¸ç­‰çš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184112282-99248751.png" alt="img"></p>
<p><strong>å¯¹æ¯”è¾“å‡ºä¿¡æ¯çš„è¯ï¼Œæˆ‘ä»¬çœ‹åˆ° count(å­—æ®µ) è¿›è¡Œäº†å…¨è¡¨æ‰«æã€‚</strong></p>
<p><strong>å†æ¯”å¦‚ count(1)ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒä¼šä¸ä¼šè¢«ä¼˜åŒ–ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) EXPLAIN SYNTAX <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">FROM</span> datasets.hits_v1;</span><br><span class="line"></span><br><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line"></span><br><span class="line">Query id: f59337ec<span class="number">-58e3</span><span class="number">-4</span>a37<span class="operator">-</span>b00d<span class="operator">-</span>eaa796f54f65</span><br><span class="line"></span><br><span class="line">â”Œâ”€explainâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="keyword">SELECT</span> <span class="built_in">count</span>()        â”‚</span><br><span class="line">â”‚ <span class="keyword">FROM</span> datasets.hits_v1 â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.004</span> sec.</span><br></pre></td></tr></table></figure>

<p><strong>å› ä¸º 1 æ˜¯ä¸€ä¸ªæ•´å‹ï¼Œæ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œæ‰€ä»¥ç›´æ¥å˜æˆäº† count()ã€‚</strong></p>
<h4 id="è°“è¯ä¸‹æ¨"><a href="#è°“è¯ä¸‹æ¨" class="headerlink" title="è°“è¯ä¸‹æ¨"></a>è°“è¯ä¸‹æ¨</h4><p><strong>åœ¨ SQL ä¸­ï¼Œè°“è¯å°±æ˜¯è¿”å› boolean å€¼çš„å‡½æ•°ï¼Œæˆ–éšå¼è½¬æ¢ä¸º bool çš„å‡½æ•°ï¼Œè¯´ç™½äº†ä½ å°±ç®€å•ç†è§£ä¸º WHERE è¯­å¥å³å¯ã€‚è€Œè°“è¯ä¸‹æ¨æŒ‡çš„æ˜¯å°†è¿‡æ»¤è¡¨è¾¾å¼å°½å¯èƒ½ç§»åŠ¨è‡³é è¿‘æ•°æ®æºçš„ä½ç½®ï¼Œä»äº‹åè¿‡æ»¤å˜æˆäº‹å‰è¿‡æ»¤ã€‚</strong></p>
<p><strong>ä¸¾ä¸ªæœ€ç®€å•çš„æ —å­å°±æ˜¯ WHERE å’Œ HAVINGï¼Œæˆ‘ä»¬çŸ¥é“ WHERE æ˜¯å‘ç”Ÿåœ¨ GROUP BY ä¹‹å‰çš„ï¼ŒHAVAING å‘ç”Ÿåœ¨ GROUP BY ä¹‹åã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> UserID, <span class="built_in">count</span>() <span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID <span class="keyword">HAVING</span> UserID <span class="operator">=</span> <span class="number">1785640464950496314</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€UserIDâ”€â”¬â”€count()â”€â”</span></span><br><span class="line"><span class="comment">â”‚ 1785640464950496314 â”‚     105 â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šé¢è¿™è¡Œ SQL è¯­å¥æ‰§è¡Œçš„æ—¶å€™è™½ç„¶æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªç³Ÿç³•çš„ SQL è¯­å¥ï¼Œå› ä¸ºè¦å…ˆå¯¹å°†è¿‘ 900 ä¸‡çš„æ•°æ®è¿›è¡Œèšåˆï¼Œç„¶åé€‰æ‹© UserID ä¸º 1785640464950496314 çš„è®°å½•ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸èƒ½å…ˆæŠŠ UserID ä¸º 1785640464950496314 çš„è®°å½•é€‰å‡ºæ¥ï¼Œç„¶åå†å•ç‹¬è¿›è¡Œèšåˆå‘¢ï¼Ÿè¿™æ ·çš„è¯æ•°æ®é‡ä¼šå°‘å¾ˆå¤šã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184209516-1021848259.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°åœ¨ä¼˜åŒ–ä¹‹åçš„ SQL è¯­å¥å°†æ¡ä»¶ä» HAVING ç§»åˆ°äº† WHEREï¼Œæ‰€ä»¥å°†è¿‡æ»¤è¡¨è¾¾å¼å°½å¯èƒ½ç§»åŠ¨è‡³é è¿‘æ•°æ®æºçš„ä½ç½®ï¼Œåœ¨è®¡ç®—ä¹‹å‰å…ˆå°†æ— ç”¨æ•°æ®è¿‡æ»¤æ‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯è°“è¯ä¸‹æ¨ã€‚</strong></p>
<p><strong>å½“ç„¶è°“è¯ä¸‹æ¨ä¸ä»…ä»…æ˜¯è¿™é‡Œçš„ HAVINGï¼Œå­æŸ¥è¯¢ä¹Ÿæ”¯æŒï¼Œä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬è¦æ ¹æ® UserID ä» hits_v1 è¡¨ä¸­æŸ¥è¯¢å‡ ä¸ªç”¨æˆ·çš„è®°å½•ï¼Œä½†æ˜¯è¿™äº›å€¼å¿…é¡»å­˜åœ¨äº visits_v1 çš„ UserID å­—æ®µä¸­ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> UserID, URL <span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line"><span class="keyword">WHERE</span> UserID <span class="keyword">IN</span> (<span class="number">329024891984319329</span>, <span class="number">3341630990649416532</span>, <span class="number">3444082748272603552</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ˜¾ç„¶è¿™æ˜¯éå¸¸ç®€å•çš„ï¼Œä½†å¦‚æœæˆ‘ä»¬è§„å®š UserID è¿˜å¿…é¡»è¦å‡ºç°åœ¨ visits_v1 è¡¨çš„ UserID å­—æ®µä¸­ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆåšå‘¢ï¼Ÿæœ€ç®€å•çš„åšæ³•å°±æ˜¯ä¸€ä¸ªæ¡ä»¶å³å¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> UserID, URL</span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line"><span class="keyword">WHERE</span> UserID <span class="keyword">IN</span> (<span class="number">329024891984319329</span>, <span class="number">3341630990649416532</span>, <span class="number">3444082748272603552</span>)</span><br><span class="line">  <span class="keyword">AND</span> UserID <span class="keyword">IN</span> (<span class="keyword">SELECT</span> UserID <span class="keyword">FROM</span> datasets.visits_v1);</span><br></pre></td></tr></table></figure>

<p><strong>ä½†å¾ˆæ˜æ˜¾è¿™æ¡è¯­å¥å°±ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå› ä¸ºå­æŸ¥è¯¢ä¼šæ‰«æå…¨è¡¨ï¼Œä¹Ÿå°±æ˜¯ visits_v1 ä¼šå…¨é‡è¯»å–ã€‚æ—¢ç„¶ UserID è¦åœ¨ä¸¤ä¸ªè¡¨ä¸­éƒ½å‡ºç°ï¼Œé‚£ä¹ˆå°±åº”è¯¥ä¼˜å…ˆæŠŠè¿‡æ»¤æ¡ä»¶æ”¾åœ¨å­æŸ¥è¯¢é‡Œé¢ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> UserID, URL</span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line"><span class="keyword">WHERE</span> UserID <span class="keyword">IN</span></span><br><span class="line">      (<span class="keyword">SELECT</span> UserID  <span class="comment">-- æ•°æ®é‡å¤§çš„è¯ï¼Œè¿˜å¯ä»¥è¿›è¡Œå»é‡</span></span><br><span class="line">       <span class="keyword">FROM</span> datasets.visits_v1</span><br><span class="line">       <span class="keyword">WHERE</span> UserID <span class="keyword">IN</span> (<span class="number">329024891984319329</span>, <span class="number">3341630990649416532</span>, <span class="number">3444082748272603552</span>));</span><br></pre></td></tr></table></figure>

<p><strong>è¿™ç§åšæ³•æ˜¾ç„¶æ›´ä¼˜ï¼Œå› ä¸º visits_v1 ä¸éœ€è¦å…¨é‡è¯»å–ï¼Œä½† ClickHouse ç›®å‰è¿˜åšä¸äº†è¿™ç§ä¼˜åŒ–ï¼ŒClickHouse æ‰€èƒ½åšçš„å­æŸ¥è¯¢è°“è¯ä¸‹æ¨è¿˜æ˜¯å¾ˆæœ‰é™çš„ã€‚å½“ç„¶ä¸å…‰æ˜¯å­æŸ¥è¯¢ï¼Œç›¸æ¯” Hiveï¼ŒClickHouse æ‰€åšçš„ä¼˜åŒ–éå¸¸æœ‰é™ï¼Œä¸åŒçš„ SQL è¯­å¥æ•ˆç‡ç›¸å·®åå€ä»¥ä¸Šéƒ½æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬å†™ SQL å°±ä¸å¯ä»¥è‚†æ— å¿Œæƒ®ã€‚</strong></p>
<h4 id="ä½œä¸ºè¡¨è¿›è¡Œ-JOIN-çš„å­æŸ¥è¯¢ä¼šæ¶ˆé™¤é‡å¤å­—æ®µ"><a href="#ä½œä¸ºè¡¨è¿›è¡Œ-JOIN-çš„å­æŸ¥è¯¢ä¼šæ¶ˆé™¤é‡å¤å­—æ®µ" class="headerlink" title="ä½œä¸ºè¡¨è¿›è¡Œ JOIN çš„å­æŸ¥è¯¢ä¼šæ¶ˆé™¤é‡å¤å­—æ®µ"></a>ä½œä¸ºè¡¨è¿›è¡Œ JOIN çš„å­æŸ¥è¯¢ä¼šæ¶ˆé™¤é‡å¤å­—æ®µ</h4><p><strong>å¦‚æœå­æŸ¥è¯¢ä¸­é‡å¤é€‰æ‹©äº†æŸä¸ªå­—æ®µï¼Œé‚£ä¹ˆå½“å®ƒä½œä¸ºè¡¨è¿›è¡Œ JOIN çš„æ—¶å€™ï¼Œä¼šå»é™¤é‡å¤å­—æ®µã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> a.UserID, b.VisitID, a.URL</span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1 a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> UserID, UserID, VisitID</span><br><span class="line">    <span class="keyword">FROM</span> datasets.visits_v1</span><br><span class="line">) b</span><br><span class="line"><span class="keyword">USING</span>(UserID) LIMIT <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œè¿›è¡Œ JOIN çš„å³è¡¨æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œè€Œåœ¨è¿™ä¸ªå­æŸ¥è¯¢é‡Œé¢æˆ‘ä»¬é€‰æ‹©äº†ä¸¤æ¬¡ UserIDï¼Œé‚£ä¹ˆ ClickHouse ä¼šè¿›è¡Œä¼˜åŒ–ï¼Œå˜æˆåªé€‰æ‹©ä¸€æ¬¡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184200192-1452223116.png" alt="img"></p>
<p><strong>å¯èƒ½æœ‰äººå¥½å¥‡ï¼Œå¦‚æœæˆ‘ç»™ç¬¬äºŒä¸ª UserID èµ·ä¸€ä¸ªåˆ«åä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å³ä½¿èµ·äº†åˆ«åï¼Œä»ç„¶åªä¼šé€‰æ‹©ä¸€æ¬¡ã€‚</strong></p>
<p><strong>æ³¨æ„ï¼šè¿™é‡Œçš„å­æŸ¥è¯¢åœ¨ JOIN çš„æ—¶å€™ä¼šåˆ é™¤é‡å¤å­—æ®µï¼Œä½†å¦‚æœä¸æ˜¯åœ¨ JOIN çš„æ—¶å€™å°±ä¸ä¸€æ ·äº†ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> UserID, URL</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> UserID, UserID, URL</span><br><span class="line">    <span class="keyword">FROM</span> datasets.hits_v1</span><br><span class="line">) LIMIT <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œçš„å­æŸ¥è¯¢å½“ä¸­æˆ‘ä»¬é€‰æ‹©äº†ä¸¤ä¸ª UserIDï¼Œé‚£ä¹ˆ ClickHouse ä¼šä¸ä¼šå˜æˆä¸€ä¸ªå‘¢ï¼Ÿ</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184254606-1791960429.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°å¹¶æ²¡æœ‰ä¼˜åŒ–æ‰ï¼Œæ‰€ä»¥ ClickHouse æ‰€åšçš„ä¼˜åŒ–è¿˜æ˜¯æ¯”è¾ƒæœ‰é™çš„ã€‚</strong></p>
<h4 id="èšåˆè®¡ç®—å¤–æ¨"><a href="#èšåˆè®¡ç®—å¤–æ¨" class="headerlink" title="èšåˆè®¡ç®—å¤–æ¨"></a>èšåˆè®¡ç®—å¤–æ¨</h4><p><strong>ä»€ä¹ˆæ˜¯èšåˆè®¡ç®—å¤–æ¨å‘¢ï¼Ÿä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(RequestNum <span class="operator">*</span> <span class="number">2</span>) <span class="keyword">FROM</span> datasets.hits_v1;</span><br></pre></td></tr></table></figure>

<p><strong>ä½ è§‰å¾—ä¸Šé¢çš„ SQL æœ‰èƒ½å¤Ÿä¼˜åŒ–çš„åœ°æ–¹å—ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ ClickHouse æ˜¯å¦‚ä½•åšçš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184219260-1916876794.png" alt="img"></p>
<p><strong>æ²¡ä¼˜åŒ–çš„æ—¶å€™ï¼Œç›¸å½“äºæ˜¯åœ¨ sum ä¹‹å‰å…ˆç»™æ¯ä¸€æ¡æ•°æ®åšä¸€æ¬¡ä¹˜æ³•è¿ç®—ï¼Œç„¶åè¿›è¡Œ sumï¼›ä¼˜åŒ–ä¹‹ååˆ™æ˜¯å…ˆè¿›æ€§ sumï¼Œæœ€ååªå¯¹æ€»å’Œè¿›è¡Œä¸€æ¬¡ä¹˜æ³•è¿ç®—ï¼Œæ˜¾ç„¶åè€…æ›´ä¼˜ã€‚</strong></p>
<h4 id="èšåˆå‡½æ•°æ¶ˆé™¤"><a href="#èšåˆå‡½æ•°æ¶ˆé™¤" class="headerlink" title="èšåˆå‡½æ•°æ¶ˆé™¤"></a>èšåˆå‡½æ•°æ¶ˆé™¤</h4><p><strong>æˆ‘ä»¬åœ¨ä½¿ç”¨ GROUP BY çš„æ—¶å€™æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œé‚£å°±æ˜¯ SELECT ä¸­æ²¡æœ‰ä½¿ç”¨èšåˆå‡½æ•°çš„å­—æ®µå¿…é¡»å‡ºç°åœ¨åˆ†ç»„å­—æ®µä¸­ã€‚ä¸¾å‡ ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å­—æ®µ b å‡ºç°åœ¨äº† SELECT ä¸­ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨èšåˆå‡½æ•°ï¼Œæ‰€ä»¥å®ƒä¸€å®šè¦å‡ºç°åœ¨åˆ†ç»„å­—æ®µï¼ˆGROUP BYï¼‰ä¸­</span></span><br><span class="line"><span class="comment">-- ä½†æ²¡æœ‰å‡ºç°ï¼Œæ‰€ä»¥æŠ¥é”™</span></span><br><span class="line"><span class="keyword">SELECT</span> a, b, <span class="built_in">count</span>(c) <span class="keyword">FROM</span> t <span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ­¤æ—¶æ²¡æœ‰é—®é¢˜ï¼Œa å’Œ b éƒ½å‡ºç°åœ¨ GROUP BY ä¸­</span></span><br><span class="line"><span class="comment">-- è‡³äºå­—æ®µ cï¼Œå®ƒæ˜¯ä»¥ count(c) çš„å½¢å¼å‡ºç°çš„ï¼Œä½¿ç”¨äº†èšåˆå‡½æ•°ï¼Œæ‰€ä»¥æ²¡é—®é¢˜</span></span><br><span class="line"><span class="keyword">SELECT</span> a, b, <span class="built_in">count</span>(c) <span class="keyword">FROM</span> t <span class="keyword">GROUP</span> <span class="keyword">BY</span> a, b;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿™æ¡è¯­å¥ä¹Ÿæ˜¯éæ³•çš„ï¼Œå› ä¸º b æ²¡æœ‰å‡ºç°åœ¨ GROUP BY ä¸­ï¼Œè‡³äº count(b) å’Œ b æ— å…³</span></span><br><span class="line"><span class="comment">-- æ—¢ç„¶ SELECT ä¸­å‡ºç°äº†æ²¡æœ‰ä½¿ç”¨èšåˆå‡½æ•°çš„å­—æ®µ bï¼Œé‚£ä¹ˆå®ƒå°±å¿…é¡»è¦å‡ºç°åœ¨ GROUP BY ä¸­</span></span><br><span class="line"><span class="keyword">SELECT</span> a, b, <span class="built_in">count</span>(b), <span class="built_in">count</span>(c) <span class="keyword">FROM</span> t <span class="keyword">GROUP</span> <span class="keyword">BY</span> a;</span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶è¿™äº›å±äºåŸºç¡€å†…å®¹äº†ï¼Œæˆ‘ä¸»è¦æƒ³è¡¨è¾¾çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä¸å¯ä»¥å¯¹åˆ†ç»„å­—æ®µä½¿ç”¨èšåˆå‡½æ•°å‘¢ï¼Ÿæ¯”å¦‚è¯´ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(UserID), <span class="built_in">max</span>(Age), <span class="built_in">min</span>(Age), <span class="built_in">sum</span>(Age) <span class="keyword">FROM</span> datasets.hits_v1 <span class="keyword">GROUP</span> <span class="keyword">BY</span> Age</span><br></pre></td></tr></table></figure>

<p><strong>å¾ˆæ˜æ˜¾æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™ä¹ˆåšæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå› ä¸ºåˆ†ç»„å°±æ˜¯æŠŠåˆ†ç»„å­—æ®µå¯¹åº”çš„å€¼ç›¸åŒçš„å½’ä¸ºä¸€ç»„ï¼Œæ¯”å¦‚è¿™é‡Œçš„ ageï¼Œæ‰€ä»¥æ¯ä¸€ç»„çš„ age çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ—¢ç„¶éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆåšèšåˆå°±æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå› æ­¤ ClickHouse ä¼šé‚£äº›å¯¹åˆ†ç»„å­—æ®µä½¿ç”¨ minã€maxã€any çš„èšåˆå‡½æ•°ç»™åˆ æ‰ã€‚å› ä¸ºæ¯ä¸€ç»„çš„æ‰€æœ‰å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæœ€å°å€¼ã€æœ€å¤§å€¼ã€ç¬¬ä¸€è¡Œçš„å€¼ï¼Œä¸‰è€…ä¹‹é—´æ²¡å·®åˆ«ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184230618-757781969.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°èšåˆå‡½æ•° minã€max è¢«å‰¥æ‰äº†ï¼Œåªç•™ä¸‹äº† Age å­—æ®µï¼Œå› ä¸ºåˆ†ç»„å­—æ®µçš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œminã€maxã€any æ²¡æœ‰æ„ä¹‰ã€‚ä½†èšåˆå‡½æ•°ä»…é™äº maxã€minã€anyï¼Œå¦‚æœæ˜¯ sum å°±ä¸ä¼šäº†ï¼Œè™½ç„¶ä»ä¸šåŠ¡çš„è§’åº¦ä¸Šæ¥è¯´ä¹Ÿæ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œä½†æ¯•ç«Ÿ sum æ¶‰åŠåˆ°åŠ æ³•è¿ç®—ï¼Œæ‰€ä»¥å®ƒä¸ä¼šè¢«å‰¥æ‰ã€‚</strong></p>
<h4 id="åˆ é™¤é‡å¤çš„-ORDER-BY-KEY"><a href="#åˆ é™¤é‡å¤çš„-ORDER-BY-KEY" class="headerlink" title="åˆ é™¤é‡å¤çš„ ORDER BY KEY"></a>åˆ é™¤é‡å¤çš„ ORDER BY KEY</h4><p><strong>ç±»ä¼¼äºæ¶ˆé™¤é‡å¤å­—æ®µï¼Œå¦‚æœæŒ‡å®šäº†å¤šä¸ªç›¸åŒçš„æ’åºå­—æ®µï¼Œé‚£ä¹ˆåªä¼šä¿ç•™ä¸€ä¸ªã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX <span class="keyword">SELECT</span> UserID <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> Age, Age, Age <span class="keyword">DESC</span>, Age <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184305683-1408761507.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°å³ä½¿ä¸åŒçš„æ’åºï¼Œä¹Ÿä¼šåªä¿ç•™ç›¸åŒæ’åºå­—æ®µçš„ç¬¬ä¸€ä¸ªï¼Œå› ä¸ºåŒä¸€ä¸ªå­—æ®µå³å‡åºåˆé™åºæœ¬èº«å°±å¾ˆå¥‡æ€ªã€‚</strong></p>
<h4 id="åˆ é™¤é‡å¤çš„-LIMIT-BY-KEY"><a href="#åˆ é™¤é‡å¤çš„-LIMIT-BY-KEY" class="headerlink" title="åˆ é™¤é‡å¤çš„ LIMIT BY KEY"></a>åˆ é™¤é‡å¤çš„ LIMIT BY KEY</h4><p><strong>è¿˜è®°å¾— LIMIT BY å—ï¼Ÿâ€LIMIT N BY å­—æ®µâ€ è¡¨ç¤ºæŒ‰ç…§å­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œç„¶åé€‰å‡ºæ¯ç»„çš„å‰ N æ¡æ•°æ®ã€‚å¦‚æœ BY åé¢çš„å­—æ®µé‡å¤äº†ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ é™¤æ‰ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX <span class="keyword">SELECT</span> UserID, URL <span class="keyword">FROM</span> datasets.hits_v1 </span><br><span class="line">LIMIT <span class="number">3</span> <span class="keyword">BY</span> UserID, UserID</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184316965-1106004376.png" alt="img"></p>
<h4 id="åˆ é™¤é‡å¤çš„-USING-KEY"><a href="#åˆ é™¤é‡å¤çš„-USING-KEY" class="headerlink" title="åˆ é™¤é‡å¤çš„ USING KEY"></a>åˆ é™¤é‡å¤çš„ USING KEY</h4><p><strong>USING ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œç›´æ¥çœ‹ä¾‹å­å§ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line"><span class="keyword">SELECT</span> a.UserID, a.UserID, b.VisitID, a.URL, b.UserID</span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1 a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> datasets.visits_v1 b <span class="keyword">USING</span>(UserID, UserID);</span><br></pre></td></tr></table></figure>

<p><strong>USING é‡Œé¢æŒ‡å®šäº†ä¸¤ä¸ª UserIDï¼Œé‚£ä¹ˆä¼šå˜æˆä¸€ä¸ªã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184328254-1163018829.png" alt="img"></p>
<p><strong>USING é‡Œé¢æŒ‡å®šäº†ä¸¤ä¸ª UserIDï¼Œé‚£ä¹ˆä¼šå˜æˆä¸€ä¸ªï¼Œå³ä½¿æˆ‘ä»¬æŒ‡å®šäº†å‰ç¼€ï¼Œæ¯”å¦‚ USING(a.UserID, b.UserID)ï¼Œé‚£ä¹ˆä¾æ—§ä¼šè¢«ä¼˜åŒ–æˆä¸€ä¸ª UserIDã€‚</strong></p>
<p><strong>ä½†æ˜¯è¯´å®è¯ï¼Œåˆ é™¤é‡å¤çš„ ORDER BY KEYã€LIMIT BY KEYã€USING KEYï¼Œæ­£å¸¸æƒ…å†µä¸‹å¾ˆéš¾å‡ºç°ï¼Œå› ä¸ºè°ä¼šæ²¡äº‹æ•…æ„å°†ä¸€ä¸ªå­—æ®µé‡å¤å†™ä¸¤éå•Šã€‚å½“ç„¶å­—æ®µå¤šäº†å€’æ˜¯æœ‰å¯èƒ½å‘ç”Ÿï¼Œå› ä¸ºå­—æ®µä¸€å¤šå°±å¯èƒ½å¿˜è®°æŸä¸ªå­—æ®µå·²ç»å†™è¿‡ä¸€éäº†ï¼Œä½†æ˜¯å­—æ®µå°‘çš„æƒ…å†µä¸‹å‡ ä¹ä¸å¯èƒ½å‘ç”Ÿã€‚</strong></p>
<p><strong>æ‰€ä»¥è¿™ä¸ª ClickHouse çš„ä¼˜åŒ–æœºåˆ¶æœ‰ç‚¹æŠŠäººå½“å‚»å­ï¼Œå¤§æ¦‚æ„Ÿè§‰å°±æ˜¯å½“ä½ å†™äº†ä¸€ä¸ª 1 + 1 &#x3D; 3ï¼Œé‚£ä¹ˆå®ƒèƒ½å¸®ä½ æ”¹æˆ 1 + 1 &#x3D; 2ï¼Œç„¶è€ŒæŸ¥è¯¢ä¸€æ—¦å¤æ‚ï¼Œå®ƒå°±æ— æ³•ä¼˜åŒ–äº†ã€‚æ‰€ä»¥ä¸€åˆ‡è¿˜éœ€è¦æˆ‘ä»¬æ¥ä¿è¯ï¼Œå½“ç„¶åç»­ ClickHouse çš„ä¼˜åŒ–æœºåˆ¶ä¼šå˜å¾—è¶Šæ¥è¶Šå®Œå–„ã€‚</strong></p>
<h4 id="æ ‡é‡æ›¿æ¢"><a href="#æ ‡é‡æ›¿æ¢" class="headerlink" title="æ ‡é‡æ›¿æ¢"></a>æ ‡é‡æ›¿æ¢</h4><p><strong>è¿™ä¸ªä¸»è¦ä½“ç°åœ¨ WITH å­å¥ä¸Šé¢ï¼Œæˆ‘ä»¬æœ€å¼€å§‹ä»‹ç» WITH å­å¥çš„æ—¶å€™è¯´è¿‡ï¼ŒWITH å­å¥å¯ä»¥ç»™ä¸€ä¸ªæ™®é€šçš„è¡¨è¾¾å¼èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥ç»™ä¸€ä¸ªæŸ¥è¯¢èµ‹å€¼ï¼Œä½†æŸ¥è¯¢åªèƒ½è¿”å›ä¸€è¡Œæ•°ç»„ã€‚æœ€ç»ˆä¼šå°†å…¶ä½œä¸ºä¸€ä¸ªæ ‡é‡ï¼Œåç»­æŸ¥è¯¢æ—¶ç›´æ¥ç”¨è¿™ä¸ªæ ‡é‡è¿›è¡Œæ›¿æ¢å³å¯ã€‚è¿™èƒŒåä¹Ÿæ˜¯ ClickHouse ç»™æˆ‘ä»¬åšçš„ä¼˜åŒ–ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> (<span class="keyword">SELECT</span> <span class="built_in">sum</span>(data_uncompressed_bytes) <span class="keyword">FROM</span> system.columns) <span class="keyword">AS</span> total_bytes</span><br><span class="line"><span class="keyword">SELECT</span> database, </span><br><span class="line">       (<span class="built_in">sum</span>(data_uncompressed_bytes) <span class="operator">/</span> total_bytes) <span class="operator">*</span> <span class="number">100</span> <span class="keyword">AS</span> database_disk_usage</span><br><span class="line"><span class="keyword">FROM</span> system.columns</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> database</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> database_disk_usage <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ WITH è¯­å¥ä¸­çš„ total_bytesï¼Œå®ƒæ˜¯å¯¹ data_uncompressed_bytes è¿›è¡Œ sum æ‰€å¾—åˆ°çš„ç»“æœï¼Œå¦‚æœåœ¨æŸ¥è¯¢ä¸­å¤šæ¬¡ä½¿ç”¨ total_bytesï¼Œé‚£ä¹ˆéš¾é“æ¯æ¬¡éƒ½è¦è®¡ç®—ä¸€éå—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯çš„ï¼Œè¿™ä¸ªå€¼æ˜¯æå‰ç®—å¥½çš„ï¼Œæ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå› ä¸ºåªæœ‰ä¸€è¡Œæ•°æ®ï¼Œå¦‚æœéƒ½å¤šåˆ—å°±æ˜¯ä¸€ä¸ªå…ƒç»„ã€‚åç»­ä½¿ç”¨çš„éƒ½æ˜¯å·²ç»ç®—å¥½çš„å€¼ã€‚</strong></p>
<h4 id="ä¸‰å…ƒè¿ç®—ç¬¦ä¼˜åŒ–"><a href="#ä¸‰å…ƒè¿ç®—ç¬¦ä¼˜åŒ–" class="headerlink" title="ä¸‰å…ƒè¿ç®—ç¬¦ä¼˜åŒ–"></a>ä¸‰å…ƒè¿ç®—ç¬¦ä¼˜åŒ–</h4><p><strong>å¦‚æœå¼€å¯äº† optimize_if_chain_to_multiif å‚æ•°ï¼Œé‚£ä¹ˆä¸‰å…ƒè¿ç®—ç¬¦ä¼šè¢«æ›¿æ¢æˆ ï¼ŒmultiIf å‡½æ•°ï¼Œä¹‹å‰è¯´è¿‡ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</strong></p>
<h3 id="æŸ¥è¯¢ä¼˜åŒ–"><a href="#æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–"></a>æŸ¥è¯¢ä¼˜åŒ–</h3><p><strong>ä»‹ç»äº†ä¸€äº› ClickHouse çš„ä¼˜åŒ–è§„åˆ™ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ç¼–å†™ SQL æ—¶å¦‚ä½•æ‰‹åŠ¨è¿›è¡Œä¼˜åŒ–ï¼Œæˆ–è€…è¯´æœ‰å“ªäº›å¯ä»¥ä¼˜åŒ–çš„ç‚¹ã€‚å› ä¸º ClickHouse çš„ä¼˜åŒ–è§„åˆ™ï¼ˆæˆ–è€…è¯´å†…ç½®çš„ä¼˜åŒ–å™¨ï¼‰å®åœ¨å¤ªç®€å•äº†ï¼Œä½†å‡¡æœ‰ç‚¹å…³ç³»å‹æ•°æ®åº“ç»éªŒçš„äººéƒ½ä¸ä¼šé‚£ä¹ˆå†™ï¼Œå› æ­¤åœ¨ç¼–å†™ SQL è¯­å¥çš„æ—¶å€™åªèƒ½é æˆ‘ä»¬ä¿è¯è´¨é‡ã€‚é‚£ä¹ˆæ¥çœ‹çœ‹éƒ½æœ‰å“ªäº›æ³¨æ„çš„ç‚¹ã€‚</strong></p>
<h4 id="PREWHERE-æ›¿ä»£-WHERE"><a href="#PREWHERE-æ›¿ä»£-WHERE" class="headerlink" title="PREWHERE æ›¿ä»£ WHERE"></a>PREWHERE æ›¿ä»£ WHERE</h4><p><strong>PREWHERE å’Œ WHERE è¯­å¥çš„ä½œç”¨ç›¸åŒï¼Œç”¨æ¥è¿‡æ»¤æ•°æ®ï¼Œä½†æ˜¯ PREWHERE åªæ”¯æŒ MergeTree ç³»åˆ—çš„å¼•æ“ã€‚WHERE è¯­å¥æ˜¯è¯»å–æ‰€æœ‰çš„å­—æ®µï¼Œç„¶åè¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œè€Œ PREWHERE åˆ™æ˜¯æŒ‡å®šäº†å“ªäº›å­—æ®µå°±è¯»å–å“ªäº›å­—æ®µã€‚æ¯”å¦‚ age &gt; 18 and length &gt; 160ï¼ŒWHERE çš„è¯ä¼šè¯»å–å…¨éƒ¨å­—æ®µï¼Œç„¶åè¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œå†æ ¹æ® SELECT ä¸­æŒ‡å®šçš„å­—æ®µè¿›è¡Œä¸¢å¼ƒã€‚PREWHERE åˆ™æ˜¯åªè¯»å– age å’Œ length ä¸¤ä¸ªå­—æ®µï¼Œå› ä¸ºè¿‡æ»¤æ¡ä»¶åªæœ‰è¿™ä¸¤ä¸ªå­—æ®µï¼Œè€Œå°†æ•°æ®è¿‡æ»¤ä¹‹åï¼Œå†æ ¹æ® SELECT ä¸­æŒ‡å®šçš„å­—æ®µè¿›è¡Œè¡¥å…¨ï¼ˆæˆ–ä¸¢å¼ƒï¼‰ã€‚</strong></p>
<p><strong>æ‰€ä»¥ä¸¤è€…çš„åŒºåˆ«åœ¨äºè¯»å–çš„æ•°æ®é‡ä¸åŒï¼Œå½“æŸ¥è¯¢åˆ—æ˜æ˜¾å¤šäºç­›é€‰åˆ—æ—¶ï¼Œä½¿ç”¨ PREWHERE å¯ä»¥åå€æå‡æ€§èƒ½ã€‚å½“ç„¶è¿™äº›æˆ‘ä»¬ä¹‹å‰åœ¨ä»‹ç»å­å¥çš„æ—¶å€™è¯´è¿‡äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬è¯´è¿‡ ClickHouse ä¼šè‡ªåŠ¨å°† WHERE ä¼˜åŒ–æˆ PREWHEREï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥ç”¨ WHERE å°±å¥½ã€‚å½“ç„¶æˆ‘ä»¬è¿˜è¯´äº†æœ‰å‡ ç§æƒ…å†µï¼ŒClickHouse ä¸ä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼Œå› ä¸ºåœ¨è¿™å‡ ç§æƒ…å†µä¸‹ï¼Œä¼˜åŒ–å¸¦æ¥çš„æ€§èƒ½æå‡ä¸å¤§ï¼Œå…·ä½“å¯ä»¥å›å»çœ‹çœ‹ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> datasets.hits_v1 <span class="keyword">WHERE</span> UserID <span class="operator">=</span> <span class="number">610708775678702928</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184338754-748042245.png" alt="img"></p>
<p><strong>åœ¨ä½¿ç”¨ * çš„æ—¶å€™ï¼ŒClickHouse ä¼šè‡ªåŠ¨å±•å¼€æˆæ‰€æœ‰å­—æ®µï¼Œç„¶åé‡ç‚¹æ˜¯æˆ‘ä»¬çœ‹åˆ° WHERE è¢«æ›¿æ¢æˆäº† PREWHEREï¼Œè¯æ˜ç¡®å®ä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼Œå½“ç„¶æˆ‘ä»¬è¯´è¿‡å¯ä»¥é€šè¿‡è®¾ç½® optimize_move_to_prewhere ä¸º 1ã€0 è¿›è¡Œå¼€å¯ã€å…³é—­ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ã€‚å¦å¤–è¿™ä¸ªé…ç½®å¯ä»¥é€šè¿‡ set è®¾ç½®ï¼Œé‚£ä¹ˆå®ƒä½äºå“ªé‡Œå‘¢ï¼Ÿæ²¡é”™ï¼Œæ˜¾ç„¶æ˜¯ users.xml ä¸­ã€‚</strong></p>
<h4 id="æ•°æ®é‡‡æ ·"><a href="#æ•°æ®é‡‡æ ·" class="headerlink" title="æ•°æ®é‡‡æ ·"></a>æ•°æ®é‡‡æ ·</h4><p><strong>å½“æˆ‘ä»¬è¦æ±‚æ•°æ®çš„å®æ—¶æ€§é«˜äºæ•°æ®çš„å‡†ç¡®æ€§æ—¶ï¼Œæ•°æ®é‡‡æ ·å°±å¾ˆæœ‰ç”¨äº†ã€‚è®°å¾—åœ¨å¤§å››å®ä¹ çš„æ—¶å€™ï¼Œå½“æ—¶è´Ÿè´£ç»™å„å¤§ä¸Šå¸‚å…¬å¸åšå®¡è®¡ï¼Œç”±äºæ•°æ®é‡éå¸¸åºå¤§ï¼Œç®—ä¸€æ¬¡è¦èŠ±ä¸Šå¥½å‡ ä¸ªå°æ—¶ã€‚æ‰€ä»¥æ¯æ¬¡éƒ½å…ˆé‡‡æ ·ï¼Œåªç®—ç™¾åˆ†ä¹‹ 10 åˆ°ç™¾åˆ†ä¹‹ 20 çš„æ•°æ®ï¼Œå¦‚æœå¾—å‡ºæ¥çš„ç»“æœç¬¦åˆæ­£å¸¸é¢„æœŸï¼Œé‚£ä¹ˆå†è·‘å…¨é‡æ•°æ®ï¼Œè¿™æ ·ä¼šç¨³å¦¥ä¸€äº›ã€‚å¦‚æœä¸Šæ¥å°±è·‘å…¨é‡æ•°æ®ï¼Œæœ€åå‘ç°ç»“æœç®—çš„ä¸å¯¹å°±å°´å°¬äº†ã€‚</strong></p>
<p><strong>å½“ç„¶æˆ‘å½“æ—¶é€‰æ‹©é‡‡æ ·åªæ˜¯ç®€å•çš„å¯¹ç¨‹åºçš„å‡†ç¡®æ€§è¿›è¡Œä¸€äº›æ£€æµ‹ï¼Œä½†å®é™…ç”Ÿäº§ä¸­çš„ç¨‹åºåŸºæœ¬ä¸Šéƒ½æ˜¯å‡†ç¡®çš„ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœç”¨æˆ·æ‰§è¡Œäº†ä¸€ä¸ªæŸ¥è¯¢ï¼Œé‚£ä¹ˆä¸ºäº†å¾ˆå¿«çš„ç»™å‡ºç»“æœï¼Œé€‰æ‹©éšæœºé‡‡æ ·æ˜¯æœ€åˆé€‚çš„æ–¹å¼ã€‚ä»¥æˆ‘ä¹‹å‰çš„ç»éªŒï¼Œå¦‚æœæ•°æ®å€¾æ–œä¸ä¸¥é‡çš„è¯ï¼Œé‚£ä¹ˆé‡‡æ · 10% çš„æ•°æ®å’Œå…¨é‡æ•°æ®è®¡ç®—å‡ºæ¥çš„ç»“æœå·®åˆ«å¾ˆå°ï¼Œå½“ç„¶å…·ä½“æ€ä¹ˆåšè¿˜æ˜¯è¦å–å†³äºä½ çš„ä¸šåŠ¡ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ... SAMPLE <span class="number">0.1</span></span><br><span class="line"><span class="keyword">WHERE</span> ...</span><br></pre></td></tr></table></figure>

<p><strong>SAMPLE æ”¾åœ¨ FROM ä¹‹åã€WHERE ä¹‹å‰ï¼Œè‡³äºå…·ä½“ç”¨æ³•ä¹‹å‰å·²ç»è¯´è¿‡äº†ï¼Œå¯ä»¥å›å¤´çœ‹ä¸€ä¸‹ã€‚</strong></p>
<h4 id="åˆ—è£å‰ªä¸åˆ†åŒºè£å‰ª"><a href="#åˆ—è£å‰ªä¸åˆ†åŒºè£å‰ª" class="headerlink" title="åˆ—è£å‰ªä¸åˆ†åŒºè£å‰ª"></a>åˆ—è£å‰ªä¸åˆ†åŒºè£å‰ª</h4><p><strong>ClickHouse éå¸¸é€‚åˆå­˜å‚¨å¤§æ•°æ®é‡çš„å®½è¡¨ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥é¿å…ä½¿ç”¨ SELECT * æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å½±å“çš„æ“ä½œã€‚åº”å½“å¯¹åˆ—è¿›è¡Œè£å‰ªï¼Œåªé€‰æ‹©ä½ éœ€è¦çš„åˆ—ï¼Œå› ä¸ºå­—æ®µè¶Šå°‘ï¼Œæ¶ˆè€—çš„ IO èµ„æºå°±è¶Šå°‘ï¼Œä»è€Œæ€§èƒ½å°±è¶Šé«˜ã€‚</strong></p>
<p><strong>è€Œåˆ†åŒºè£å‰ªå°±æ˜¯åªè¯»å–éœ€è¦åˆ†åŒºï¼Œåœ¨è¿‡æ»¤æ¡ä»¶ä¸­æŒ‡å®šï¼Œæ‰€ä»¥è®¾è®¡ä¸€ä¸ªåˆé€‚çš„åˆ†åŒºè¡¨å¯¹åæœŸæŸ¥è¯¢æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚ã€‚</strong></p>
<h4 id="ORDER-BY-åº”å½“äº-WHEREã€LIMIT-ä¸€èµ·ä½¿ç”¨"><a href="#ORDER-BY-åº”å½“äº-WHEREã€LIMIT-ä¸€èµ·ä½¿ç”¨" class="headerlink" title="ORDER BY åº”å½“äº WHEREã€LIMIT ä¸€èµ·ä½¿ç”¨"></a>ORDER BY åº”å½“äº WHEREã€LIMIT ä¸€èµ·ä½¿ç”¨</h4><p><strong>å¯¹åƒä¸‡çº§ä»¥ä¸Šçš„æ•°æ®é›†è¿›è¡Œæ’åºçš„æ—¶å€™ä¸€å®šè¦æ­é… WHERE æˆ– LIMIT ä½¿ç”¨ï¼Œå¯èƒ½æœ‰äººè§‰å¾—æˆ‘åªæ˜¯æ’ä¸ªåºè€Œå·²ï¼Œä¸ºå•¥è¿˜è¦æœ‰è¿™ä¹ˆå¤šé™åˆ¶ã€‚å› ä¸ºäº‹å®ä¸Šæˆ‘ä»¬å¾ˆå°‘ä¼šå¯¹æ•°æ®è¿›è¡Œå…¨å±€æ’åºï¼Œè€Œä¸”æ•°æ®é‡ä¸€å¤§ï¼Œå…¨å±€æ’åºçš„è¯å†…å­˜å¾ˆå®¹æ˜“çˆ†æ‰ï¼›å¦‚æœè®¾ç½®äº† max_bytes_before_external_sortï¼Œé‚£ä¹ˆå…¨å±€æ’åºä¼šåœ¨ç£ç›˜ä¸Šè¿›è¡Œï¼Œæ­¤æ—¶é€Ÿåº¦åˆæ˜¯ä¸€ä¸ªéš¾ä»¥å¿å—çš„åœ°æ–¹ã€‚å› æ­¤åœ¨ä½¿ç”¨ ORDER BY çš„æ—¶å€™ï¼Œéœ€è¦æ­é… WHEREã€LIMITã€‚</strong></p>
<h4 id="é¿å…æ„å»ºè™šæ‹Ÿåˆ—"><a href="#é¿å…æ„å»ºè™šæ‹Ÿåˆ—" class="headerlink" title="é¿å…æ„å»ºè™šæ‹Ÿåˆ—"></a>é¿å…æ„å»ºè™šæ‹Ÿåˆ—</h4><p><strong>è™šæ‹Ÿåˆ—æŒ‡çš„å°±æ˜¯æˆ‘ä»¬è‡ªå·±æ„é€ å‡ºæ¥çš„å­—æ®µï¼Œè€Œåœ¨åŸè¡¨ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A, A <span class="operator">+</span> <span class="number">1</span> <span class="keyword">FROM</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>

<p><strong>A æ˜¯è¡¨ä¸­çš„å­—æ®µï¼Œä½† A + 1 æ˜æ˜¾ä¸æ˜¯ï¼Œå®ƒæ˜¯æˆ‘ä»¬æ„é€ å‡ºæ¥çš„ï¼Œæ‰€ä»¥å«è™šæ‹Ÿåˆ—ã€‚ä½†å¦‚æœéå¿…é¡»çš„è¯ï¼Œæœ€å¥½ä¸è¦å†ç»“æœé›†ä¸Šæ„é€ è™šæ‹Ÿæœºåˆ—ï¼Œå› ä¸ºè™šæ‹Ÿåˆ—éå¸¸æ¶ˆè€—èµ„æºæ€§èƒ½ï¼Œå¯ä»¥è€ƒè™‘åœ¨æ‹¿åˆ°æ•°æ®ä¹‹åç”±å‰åç«¯è¿›è¡Œå¤„ç†ã€‚</strong></p>
<h4 id="uniqCombined-æ›¿ä»£-count-DISTINCT"><a href="#uniqCombined-æ›¿ä»£-count-DISTINCT" class="headerlink" title="uniqCombined æ›¿ä»£ count(DISTINCT)"></a>uniqCombined æ›¿ä»£ count(DISTINCT)</h4><p><strong>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ ClickHouse æä¾›äº†ä¸€äº›è¯­æ³•ç³–ï¼Œä¾‹å¦‚è¿™é‡Œçš„ count(DISTINCT column) å®é™…ä¸Šå°±æ˜¯ countDistinct(column)ï¼Œåªä¸è¿‡ ClickHouse æä¾›äº†ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­ count(DISTINCT) è¯­æ³•ã€‚å¹¶ä¸”åœ¨å…·ä½“æ‰§è¡Œçš„æ—¶å€™ï¼Œåº•å±‚éƒ½å¯¹åº” uniqExact å‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="keyword">DISTINCT</span> UserID), countDistinct(UserID), uniqExact(UserID) </span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184348897-1208726092.png" alt="img"></p>
<p><strong>ä½†è¿˜æ˜¯å»ºè®®ä½¿ç”¨ count(DISTINCT)ï¼Œå› ä¸ºè¿™å‡ ä¸ªéƒ½æ˜¯ç­‰ä»·çš„ï¼Œé‚£ä¹ˆè‡ªç„¶é€‰ä¸€ä¸ªçœ‹èµ·æ¥æœ€ç†Ÿæ‚‰çš„ã€‚é‚£ä¹ˆè¿™ä¸ªæˆ‘ä»¬è¯´çš„ uniqCombined æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼ŸåŸå› æ˜¯ uniqExact æ˜¯ç²¾ç¡®å»é‡å¹¶ç»Ÿè®¡æ•°é‡ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ•°é‡ä¸Šå¯¹ç»Ÿè®¡çš„æ•°æ®çš„è¯¯å·®æœ‰ä¸€å®šçš„å®¹å¿æ€§ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ uniqCombinedï¼Œè¯¥å‡½æ•°ä½¿ç”¨ç±»ä¼¼ HyperLogLog çš„ç®—æ³•ï¼Œåœ¨é€Ÿåº¦ä¸Šå¯ä»¥æå‡ 10 å€ä»¥ä¸Šï¼Œä½†ç‰ºç‰²äº†ä¸€äº›å‡†ç¡®ç‡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184359366-125449336.png" alt="img"></p>
<h4 id="JOIN-æ“ä½œ"><a href="#JOIN-æ“ä½œ" class="headerlink" title="JOIN æ“ä½œ"></a>JOIN æ“ä½œ</h4><p><strong>åœ¨ä»‹ç» JOIN ä¹‹å‰æˆ‘å…ˆè¯´ä¸¤å¥ï¼Œå¾ˆå¤šå…¬å¸åœ¨è®¾è®¡å…³ç³»å‹æ•°æ®åº“çš„è¡¨ç»“æ„æ—¶ï¼Œéƒ½ä¼šéµå¾ªç›¸åº”çš„èŒƒå¼ï¼Œä½†å¯¹äºæ•°æ®ä»“åº“è€Œè¨€æ˜¯å®Œå…¨ä¸éœ€è¦çš„ï¼Œæ•°ä»“çš„é‡ç‚¹åœ¨äºåˆ†å±‚ã€‚å¯¹äº OLAP å‹çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“è€Œè¨€ï¼Œå°¤å…¶æ˜¯ ClickHouseï¼Œèƒ½ä¸ç”¨ JOIN å°±ä¸ç”¨ JOINï¼Œæœ€å¥½æ˜¯å•è¡¨æ“ä½œï¼Œå› æ­¤è¿™å°±éœ€è¦æˆ‘ä»¬ä¿è¯æ•°æ®æœ‰å†—ä½™åº¦ï¼Œä½†è¿™åœ¨æ•°ä»“å»ºè®¾ä¸­å®Œå…¨ OK ã€‚å¹¶ä¸”å¯¹äº ClickHouse è€Œè¨€ï¼Œå®ƒçš„ JOIN ä¹Ÿæ˜¯æ¯”è¾ƒå¥‡è‘©çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</strong></p>
<p><strong>é¦–å…ˆä¸ç®¡æ˜¯ LEFT è¿˜æ˜¯ RIGHTï¼Œå½“ A è¡¨å’Œ B è¡¨è¿›è¡Œ JOIN çš„æ—¶å€™ï¼ŒClickHouse éƒ½ä¼šå°† B è¡¨åŠ è½½åˆ°å†…å­˜ï¼Œç„¶åéå† A è¡¨æ•°æ®ï¼ŒæŸ¥è¯¢ B è¡¨ä¸­æœ‰æ²¡æœ‰èƒ½ä¸ä¹‹å…³è”ä¸Šçš„æ•°æ®ï¼Œå› æ­¤è¿™å°±å¼•å‡ºäº†ç¬¬ä¸€ä¸ªä¼˜åŒ–çš„åŸåˆ™ï¼šå½“å¤§å°è¡¨ JOIN çš„æ—¶å€™ï¼Œè¦ä¿è¯å°è¡¨åœ¨å³ä¾§ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- hits_v1 çš„æ•°æ®é‡è¦è¿œå¤§äº visits_v1ï¼Œç„¶åæˆ‘ä»¬æ¥ JOIN è¯•ä¸€ä¸‹</span></span><br><span class="line"><span class="comment">-- è¿™é‡Œä¸ºäº†é¿å…è¾“å‡ºå¤§é‡ä¿¡æ¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ count(*) ä»£æ›¿</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> datasets.hits_v1 a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> datasets.visits_v1 b</span><br><span class="line"><span class="keyword">USING</span>(CounterID);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¸Šé¢æ˜¯ hits_v1 ä½œä¸ºå·¦è¡¨è¿›è¡Œå·¦å…³è”ï¼Œç­‰ä»·äºå¦‚ä¸‹ï¼šå°† hits_v1 ä½œä¸ºå³è¡¨è¿›è¡Œå³å…³è”</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> datasets.visits_v1 b</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> datasets.hits_v1 a</span><br><span class="line"><span class="keyword">USING</span>(CounterID);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5(%E5%8D%81%E5%85%AD)/1229382-20210913184416415-1275656254.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°æ•ˆç‡ç¡®å®æœ‰å·®å¼‚ï¼Œè€Œ JOIN ä¹‹åçš„æ•°æ®é‡æ¯” hits_v1 è¡¨è¿˜è¦å¤šï¼Œè¯´æ˜ä¸­é—´äº§ç”Ÿäº†ç¬›å¡å°”ç§¯ã€‚å¦‚æœä¸æƒ³äº§ç”Ÿç¬›å¡å°”ç§¯ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨ LEFT JOIN å’Œ RIGHT JOIN çš„å‰é¢åŠ ä¸Š ANY å³å¯ï¼Œé»˜è®¤æ˜¯ ALLã€‚</strong></p>
<blockquote>
<p><strong>ä½†è¿˜æ˜¯ä¸Šé¢é‚£å¥è¯ï¼Œèƒ½ä¸ç”¨ JOIN å°±ä¸è¦ç”¨ JOINï¼Œå½“æ¶‰åŠåˆ°ä¸¤å¼ è¡¨çš„æ—¶å€™ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥ç”¨å­æŸ¥è¯¢æ¥æ›¿ä»£ã€‚</strong></p>
</blockquote>
<p><strong>ç„¶åæ˜¯è°“è¯ä¸‹æ¨ï¼Œæˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.UserID, a.Age, b.CounterID </span><br><span class="line"><span class="keyword">FROM</span> datasets.hits_v1 a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> datasets.visits_v1 b</span><br><span class="line"><span class="keyword">USING</span>(CounterID) <span class="keyword">WHERE</span> a.EventDate <span class="operator">=</span> <span class="string">&#x27;2020-04-17&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šé¢ä¼šå…ˆå¯¹ä¸¤å¼ è¡¨è¿›è¡Œ JOINï¼Œå®Œäº‹ä¹‹åå†è¿›è¡Œè¿‡æ»¤ï¼Œæ—¢ç„¶å¦‚æ­¤çš„è¯ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸èƒ½å…ˆè¿‡æ»¤ç„¶åå†è¿›è¡Œ JOIN å‘¢ï¼Ÿ</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.<span class="operator">*</span>, b.CounterID </span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> UserID, Age <span class="keyword">FROM</span> datasets.hits_v1 <span class="keyword">WHERE</span> EventDate <span class="operator">=</span> <span class="string">&#x27;2020-04-17&#x27;</span>) a</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> datasets.visits_v1 b</span><br><span class="line"><span class="keyword">USING</span>(CounterID) </span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢çš„åšæ³•ä¼šæ¯”ä¸Šé¢è¦å¿«ï¼Œå› ä¸ºåœ¨ JOIN ä¹‹å‰å°±å°†æ•°æ®è¿‡æ»¤æ‰äº†ä¸€éƒ¨åˆ†ï¼Œä¸è¦å°çœ‹è¿™ä¸€ç‚¹ï¼Œæœ‰æ—¶å¯¹æ€§èƒ½çš„å½±å“å¾ˆå¤§ã€‚å¹¶ä¸” ClickHouse ä¸ä¼šä¸»åŠ¨å¸®æˆ‘ä»¬å‘èµ·è°“è¯ä¸‹æ¨çš„æ“ä½œï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨å®Œæˆã€‚å¯èƒ½æœ‰äººå¥½å¥‡ï¼Œå¦‚æœå°†è¿‡æ»¤æ¡ä»¶æ”¾åœ¨ ON å­å¥åé¢ä¼šæ€ä¹ˆæ ·ï¼Œç­”æ¡ˆæ˜¯ä¼šæŠ¥é”™ï¼Œå› ä¸º ClickHouse ä¸å…è®¸ ON å­å¥ä¸­å‡ºç°è¿‡æ»¤æ¡ä»¶ã€‚</strong></p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>ä»¥ä¸Šå°±æ˜¯ ClickHouse å…³äºä¼˜åŒ–æ–¹é¢çš„å†…å®¹ï¼Œè¯´å®è¯éƒ½æ¯”è¾ƒç®€å•ï¼Œæ€»ä¹‹é‡ç‚¹å°±æ˜¯æˆ‘ä»¬åœ¨å†™ SQL çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ï¼Œä¸èƒ½å¤Ÿéšå¿ƒæ‰€æ¬²ï¼Œå› ä¸º ClickHouse æ‰€èƒ½åšåˆ°çš„ä¼˜åŒ–æ˜¯éå¸¸æœ‰é™çš„ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„å‰¯æœ¬ä¸åˆ†ç‰‡(åä¸ƒ)</title>
    <url>/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„å‰¯æœ¬ä¸åˆ†ç‰‡-åä¸ƒ"><a href="#ClickHouse-çš„å‰¯æœ¬ä¸åˆ†ç‰‡-åä¸ƒ" class="headerlink" title="ClickHouse çš„å‰¯æœ¬ä¸åˆ†ç‰‡(åä¸ƒ)"></a>ClickHouse çš„å‰¯æœ¬ä¸åˆ†ç‰‡(åä¸ƒ)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><p><strong>çºµä½¿å•èŠ‚ç‚¹æ€§èƒ½å†å¼ºï¼Œä¹Ÿä¼šæœ‰é‡åˆ°ç“¶é¢ˆçš„é‚£ä¸€å¤©ï¼Œä¸šåŠ¡é‡çš„æŒç»­å¢é•¿ã€æœåŠ¡å™¨çš„æ„å¤–æ•…éšœï¼Œéƒ½æ˜¯ ClickHouse éœ€è¦é¢å¯¹çš„æ´ªæ°´çŒ›å…½ã€‚ä½†å¸¸è¨€é“ï¼šä¸€ä¸ªå¥½æ±‰ä¸‰ä¸ªå¸®ï¼Œä¸€ä¸ªç¯±ç¬†ä¸‰ä¸ªæ¡©ï¼Œæ”¾åœ¨è®¡ç®—æœºé¢†åŸŸå°±æ˜¯ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸å¤Ÿï¼Œå°±å¤šæ¥å‡ ä¸ªèŠ‚ç‚¹ï¼Œä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹ ClickHouse çš„é›†ç¾¤ã€å‰¯æœ¬ä¸åˆ†ç‰‡ã€‚</strong></p>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><strong>é›†ç¾¤æ˜¯å‰¯æœ¬å’Œåˆ†ç‰‡çš„åŸºç¡€ï¼Œå®ƒå°† ClickHouse çš„æœåŠ¡æ‹“æ‰‘ç”±å•èŠ‚ç‚¹å»¶ä¼¸åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œä½†å®ƒå¹¶ä¸åƒ Hadoop ç”Ÿæ€çš„æŸäº›ç³»ç»Ÿé‚£æ ·ï¼Œè¦æ±‚æ‰€æœ‰èŠ‚ç‚¹ç»„æˆä¸€ä¸ªå•ä¸€çš„å¤§é›†ç¾¤ã€‚ClickHouse çš„é›†ç¾¤é…ç½®éå¸¸çµæ´»ï¼Œç”¨æˆ·æ—¢å¯ä»¥å°†æ‰€æœ‰èŠ‚ç‚¹ç»„æˆä¸€ä¸ªå•ä¸€é›†ç¾¤ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§ä¸šåŠ¡çš„è¯‰æ±‚æŠŠèŠ‚ç‚¹åˆ’åˆ†ä¸ºå¤šä¸ªå°çš„é›†ç¾¤ã€‚åœ¨æ¯ä¸ªå°çš„é›†ç¾¤åŒºåŸŸä¹‹é—´ï¼Œå®ƒä»¬çš„èŠ‚ç‚¹ã€åˆ†åŒºå’Œå‰¯æœ¬æ•°é‡å¯ä»¥å„ä¸ç›¸åŒï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202109115-343217210.png" alt="img"></p>
<p><strong>ä»ä½œç”¨æ¥çœ‹ï¼ŒClickHouse é›†ç¾¤çš„å·¥ä½œæ›´å¤šæ˜¯é’ˆå¯¹é€»è¾‘å±‚é¢çš„ï¼Œé›†ç¾¤å®šä¹‰äº†å¤šä¸ªèŠ‚ç‚¹çš„æ‹“æ‰‘å…³ç³»ï¼Œè¿™äº›èŠ‚ç‚¹åœ¨åç»­æœåŠ¡è¿‡ç¨‹ä¸­å¯èƒ½ä¼šååŒå·¥ä½œï¼Œè€Œæ‰§è¡Œå±‚é¢çš„å…·ä½“å·¥ä½œåˆ™äº¤ç»™äº†å‰¯æœ¬å’Œåˆ†ç‰‡æ¥æ‰§è¡Œã€‚</strong></p>
<p><strong>é›†ç¾¤å¾ˆå¥½ç†è§£ï¼Œé‚£å‰¯æœ¬å’Œåˆ†ç‰‡åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™å¯¹åŒèƒèƒå…„å¼Ÿæœ‰æ—¶çœ‹èµ·æ¥æ³¾æ¸­åˆ†æ˜ï¼Œæœ‰æ—¶åˆè®©äººåˆ†è¾¨ä¸æ¸…ã€‚è¿™é‡Œæœ‰ä¸¤ç§åŒºåˆ†åŠæ³•ï¼Œç¬¬ä¸€ç§æ˜¯ä»æ•°æ®å±‚é¢åŒºåˆ†ï¼Œå‡è®¾ ClickHouse çš„ N ä¸ªèŠ‚ç‚¹ç»„æˆäº†ä¸€ä¸ªé›†ç¾¤ï¼Œåœ¨é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€å¼ ç»“æ„ç›¸åŒçš„æ•°æ®è¡¨ Yï¼Œå¦‚æœ Node1 å’Œ Node2 ä¸Šçš„ Y çš„æ•°æ®å®Œå…¨ä¸åŒï¼Œåˆ™ Node1 å’Œ Node2 äº’ä¸ºåˆ†ç‰‡ï¼›å¦‚æœå®ƒä»¬çš„æ•°æ®å®Œå…¨ç›¸åŒï¼Œåˆ™å®ƒä»¬äº’ä¸ºå‰¯æœ¬ã€‚æ¢è¨€ä¹‹ï¼Œåˆ†ç‰‡ä¹‹é—´çš„æ•°æ®æ˜¯ä¸åŒçš„ï¼Œè€Œå‰¯æœ¬ä¹‹é—´çš„æ•°æ®æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚æ‰€ä»¥æŠ›å¼€è¡¨å¼•æ“ä¸åŒï¼Œä½†ä»æ•°æ®å±‚é¢æ¥çœ‹ï¼Œå‰¯æœ¬å’Œåˆ†ç‰‡æœ‰æ—¶å€™åªæœ‰ä¸€çº¿ä¹‹éš”ã€‚</strong></p>
<p><strong>å¦ä¸€ç§æ˜¯ä»åŠŸèƒ½ä½œç”¨å±‚é¢åŒºåˆ†ï¼Œä½¿ç”¨å‰¯æœ¬çš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œå¢åŠ æ•°æ®å­˜å‚¨çš„å†—ä½™ï¼›è€Œä½¿ç”¨åˆ†ç‰‡çš„ä¸»è¦ç›®çš„æ˜¯å®ç°æ•°æ®çš„æ°´å¹³åˆ‡åˆ†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202116274-494268371.png" alt="img"></p>
<p><strong>ä¸‹é¢æˆ‘ä»¬å°±æ¥é€æ­¥ä»‹ç»å‰¯æœ¬ã€åˆ†ç‰‡å’Œé›†ç¾¤çš„ä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å½“å‰æ˜¯åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ 1 ä¸ªåˆ†ç‰‡ï¼Œå¹¶ä¸”æ•°æ®åªæœ‰ä¸€ä»½ï¼Œç›¸å½“äºæ²¡æœ‰å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯ 0 å‰¯æœ¬ã€‚æ³¨æ„ï¼šå…³äºå‰¯æœ¬ï¼Œä¸åŒæ¡†æ¶æœ‰ç€ä¸åŒçš„å®šä¹‰ï¼Œæ¯”å¦‚ HDFS ä¸­çš„ä¸‰å‰¯æœ¬å­˜å‚¨ï¼Œé‚£ä¹ˆæ•°æ®æ€»å…±æœ‰ä¸‰ä»½ï¼Œå¦‚æœæ˜¯ 1 å‰¯æœ¬ï¼Œé‚£ä¹ˆæ•°æ®å°±åªæœ‰ 1 ä»½ã€‚ä½†æ˜¯ ClickHouse ä¸­ 1 å‰¯æœ¬è¡¨ç¤ºæ•°æ®é¢å¤–æœ‰ä¸€ä»½å¤‡ä»½ï¼Œé‚£ä¹ˆè¨€ä¸‹ä¹‹æ„å°±æ˜¯æœ‰ä¸¤ä»½ï¼Œä½†æ˜¯ä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œåç»­æˆ‘ä»¬ä»é‡‡ç”¨å‰¯æœ¬ 1ã€å‰¯æœ¬ 2 æ¥ç§°å‘¼ã€‚å†æ¯”å¦‚ ClickHouse ä¸­çš„ 2 å‰¯æœ¬ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æœ‰ 3 ä»½ï¼Œä½†æˆ‘ä»¬ä¼šç”¨å‰¯æœ¬ 1ã€å‰¯æœ¬ 2ã€å‰¯æœ¬ 3 æ¥ç§°å‘¼ã€‚å½“ç„¶è¿™äº›ä¸œè¥¿ç†è§£å°±å¥½ï¼Œåªæ˜¯ä¸ºäº†é¿å…å‡ºç°æ­§ä¹‰ï¼Œéœ€è¦æå‰å…ˆè¯´æ¸…æ¥šã€‚</strong></p>
<p><strong>è€Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šä»æ•°æ®è¡¨çš„åˆå§‹å½¢æ€ 1 åˆ†ç‰‡ã€0 å‰¯æœ¬å¼€å§‹ä»‹ç»ï¼›ç„¶åå†è¯´å¦‚ä½•ä¸ºå®ƒæ·»åŠ å‰¯æœ¬ï¼Œä»è€Œå½¢æˆ 1 åˆ†ç‰‡ã€1 å‰¯æœ¬çš„çŠ¶æ€ï¼›ç„¶åæ¥ç€å†è¯´å¦‚ä½•å¼•å…¥åˆ†ç‰‡ï¼Œå°†å…¶è½¬åŒ–ä¸ºå¤šåˆ†ç‰‡ã€1 å‰¯æœ¬çš„å½¢æ€ï¼ˆå¤šå‰¯æœ¬çš„å½¢æ€ä»¥æ­¤ç±»æ¨ï¼‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202124155-1493622788.png" alt="img"></p>
<p><strong>è¿™ç§å½¢æ€çš„å˜åŒ–è¿‡ç¨‹åƒæäº†ä¼ä¸šå†…çš„ä¸šåŠ¡å‘å±•è¿‡ç¨‹ï¼Œåœ¨ä¸šåŠ¡åˆæœŸæˆ‘ä»¬ä¼šä»å•å¼ æ•°æ®è¡¨å¼€å§‹ï¼›åœ¨ä¸šåŠ¡ä¸Šçº¿ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¯èƒ½ä¼šä¸ºå®ƒå¢åŠ å‰¯æœ¬ï¼Œä»¥ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œæˆ–è€…å¸Œæœ›è¿›è¡Œè¯»å†™åˆ†ç¦»ä»è€Œå¢åŠ å¹¶å‘é‡ï¼›ä½†éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œæ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼Œå› æ­¤ä¼šè¿›ä¸€æ­¥ä¸ºå…¶å¢åŠ åˆ†ç‰‡ï¼Œä»è€Œå®ç°æ•°æ®çš„æ°´å¹³åˆ‡åˆ†ã€‚</strong></p>
<h2 id="æ•°æ®å‰¯æœ¬"><a href="#æ•°æ®å‰¯æœ¬" class="headerlink" title="æ•°æ®å‰¯æœ¬"></a>æ•°æ®å‰¯æœ¬</h2><p><strong>æˆ‘ä»¬ä¹‹å‰ä»‹ç» MergeTree çš„æ—¶å€™ï¼Œä»‹ç»è¿‡å®ƒçš„å‘½åè§„åˆ™ï¼Œå¦‚æœåœ¨ *MergeTree çš„å‰é¢åŠ ä¸Š Replicated å‰ç¼€ï¼Œåˆ™èƒ½å¤Ÿç»„åˆæˆä¸€ä¸ªæ–°çš„å˜ç§å¼•æ“ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210826121005343-128425369.png" alt="img"></p>
<p><strong>æ¢è¨€ä¹‹ï¼Œåªæœ‰ä½¿ç”¨äº† ReplicatedMergeTree å¤åˆ¶è¡¨ç³»åˆ—å¼•æ“ï¼Œæ‰èƒ½åº”ç”¨å‰¯æœ¬çš„èƒ½åŠ›ï¼ˆåé¢ä¼šè¯´å¦ä¸€ç§å‰¯æœ¬çš„å®ç°æ–¹å¼ï¼‰ï¼›æˆ–è€…ç”¨ä¸€ç§æ›´ä¸ºç›´æ¥çš„æ–¹å¼ç†è§£ï¼Œå³ä½¿ç”¨äº† ReplicatedMergeTree çš„æ•°æ®è¡¨å°±æ˜¯å‰¯æœ¬ã€‚</strong></p>
<p><strong>æ‰€ä»¥ ReplicatedMergeTree æ˜¯ MergeTree çš„æ´¾ç”Ÿå¼•æ“ï¼Œå®ƒåœ¨ MergeTree çš„åŸºç¡€ä¹‹ä¸ŠåŠ å…¥äº†åˆ†å¸ƒå¼ååŒçš„èƒ½åŠ›ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202131736-1374698112.png" alt="img"></p>
<p><strong>åœ¨ MergeTree ä¸­ï¼Œä¸€ä¸ªæ•°æ®åˆ†åŒºåˆå¼€å§‹åˆ›å»ºåˆ°å…¨éƒ¨å®Œæˆï¼Œä¼šç»å†ä¸¤ä¸ªå­˜å‚¨åŒºåŸŸã€‚</strong></p>
<ul>
<li><code>1. å†…å­˜ï¼šæ•°æ®é¦–å…ˆä¼šè¢«å†™å…¥å†…å­˜ç¼“å†²åŒº</code></li>
<li><code>2. æœ¬åœ°ç£ç›˜ï¼šæ•°æ®æ¥ç€ä¼šè¢«å†™å…¥ tmp ä¸´æ—¶ç›®å½•åˆ†åŒºï¼Œå¾…å…¨éƒ¨å®Œæˆä¹‹åå†å°†ä¸´æ—¶ç›®å½•é‡å‘½åä¸ºæ­£å¼åˆ†åŒº</code></li>
</ul>
<p><strong>è€Œ ReplicatedMergeTree åœ¨ä¸Šè¿°åŸºç¡€ä¹‹ä¸Šå¢åŠ äº† ZooKeeper çš„éƒ¨åˆ†ï¼Œå®ƒä¼šè¿›ä¸€æ­¥åœ¨ ZooKeeper å†…åˆ›å»ºä¸€ç³»åˆ—çš„ç›‘å¬èŠ‚ç‚¹ï¼Œå¹¶ä»¥æ­¤å®ç°å¤šä¸ªå®ä¾‹ä¹‹é—´çš„é€šä¿¡ã€‚åœ¨æ•´ä¸ªé€šä¿¡è¿‡ç¨‹ä¸­ï¼ŒZooKeeper å¹¶ä¸ä¼šæ¶‰åŠè¡¨æ•°æ®çš„ä¼ è¾“ã€‚</strong></p>
<h3 id="å‰¯æœ¬çš„ç‰¹ç‚¹"><a href="#å‰¯æœ¬çš„ç‰¹ç‚¹" class="headerlink" title="å‰¯æœ¬çš„ç‰¹ç‚¹"></a>å‰¯æœ¬çš„ç‰¹ç‚¹</h3><p><strong>ä½œä¸ºæ•°æ®å‰¯æœ¬çš„ä¸»è¦å®ç°è½½ä½“ï¼ŒReplicatedMergeTree åœ¨è®¾è®¡ä¸Šæœ‰ä¸€äº›æ˜¾è‘—ç‰¹ç‚¹ã€‚</strong></p>
<ul>
<li><strong>ä¾èµ– ZooKeeperï¼šåœ¨æ‰§è¡Œ INSERT å’Œ ALTER æŸ¥è¯¢çš„æ—¶å€™ï¼ŒReplicatedMergeTree éœ€è¦å€ŸåŠ© ZooKeeper çš„åˆ†å¸ƒå¼ååŒèƒ½åŠ›ï¼Œæ¥å®ç°å¤šä¸ªå‰¯æœ¬ä¹‹é—´çš„åŒæ­¥ã€‚ä½†æ˜¯åœ¨æŸ¥è¯¢å‰¯æœ¬çš„æ—¶å€™ï¼Œå¹¶ä¸éœ€è¦ä½¿ç”¨ ZooKeeperï¼Œå…³äºè¿™æ–¹é¢çš„ä¿¡æ¯ï¼Œåç»­ä¼šè¯¦ç»†ä»‹ç»ã€‚</strong></li>
<li><strong>è¡¨çº§åˆ«çš„å‰¯æœ¬ï¼šå‰¯æœ¬æ˜¯åœ¨è¡¨çº§åˆ«å®šä¹‰çš„ï¼Œæ‰€ä»¥æ¯å¼ è¡¨çš„å‰¯æœ¬é…ç½®éƒ½å¯ä»¥æŒ‰ç…§å®ƒçš„å®é™…éœ€æ±‚è¿›è¡Œä¸ªæ€§åŒ–å®šä¹‰ï¼ŒåŒ…æ‹¬å‰¯æœ¬çš„æ•°é‡ï¼Œä»¥åŠå‰¯æœ¬åœ¨é›†ç¾¤å†…çš„åˆ†å¸ƒä½ç½®ã€‚</strong></li>
<li><strong>å¤šä¸»æ¶æ„ï¼ˆMulti Masterï¼‰ï¼šå¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œ INSERT å’Œ ALTER æŸ¥è¯¢ï¼Œå®ƒä»¬çš„æ•ˆæœæ˜¯ç›¸åŒçš„ï¼Œè¿™äº›æ“ä½œä¼šå€ŸåŠ© ZooKeeper çš„ååŒèƒ½åŠ›è¢«åˆ†å‘è‡³æ¯ä¸ªå‰¯æœ¬ä»¥æœ¬åœ°å½¢å¼æ‰§è¡Œã€‚</strong></li>
<li><strong>Block æ•°æ®å—ï¼šåœ¨æ‰§è¡Œ INSERT å‘½ä»¤å†™å…¥æ•°æ®æ—¶ï¼Œä¼šä¾æ® max_insert_block_size çš„å¤§å°ï¼ˆé»˜è®¤ 1048576 è¡Œï¼‰å°†æ•°æ®åˆ‡åˆ†æˆè‹¥å¹²ä¸ª Block æ•°æ®å—ã€‚å› æ­¤ Block æ•°æ®å—æ˜¯æ•°æ®å†™å…¥çš„åŸºæœ¬å•å…ƒï¼Œå¹¶ä¸”å…·æœ‰å†™å…¥çš„åŸå­æ€§å’Œå”¯ä¸€æ€§ã€‚</strong></li>
<li><strong>åŸå­æ€§ï¼šåœ¨æ•°æ®å†™å…¥æ—¶ï¼Œä¸€ä¸ª Block æ•°æ®å—å†…çš„æ•°æ®è¦ä¹ˆå…¨éƒ¨å†™å…¥æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å†™å…¥å¤±è´¥ã€‚</strong></li>
<li><strong>å”¯ä¸€æ€§ï¼šåœ¨å†™å…¥ä¸€ä¸ª Block æ•°æ®å—çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§å½“å‰ Block æ•°æ®å—çš„æ•°æ®é¡ºåºã€æ•°æ®è¡Œå’Œæ•°æ®å¤§å°ç­‰æŒ‡æ ‡ï¼Œè®¡ç®— Hash ä¿¡æ¯æ‘˜è¦å¹¶è®°å½•ã€‚åœ¨æ­¤ä¹‹åï¼Œå¦‚æœæŸä¸ªå¾…å†™å…¥çš„ Block æ•°æ®å—ä¸å…ˆå‰å·²è¢«å†™å…¥çš„ Block æ•°æ®å—æ‹¥æœ‰ç›¸åŒçš„ Hash æ‘˜è¦ï¼ˆBlock æ•°æ®å—å†…æ•°æ®é¡ºåºã€æ•°æ®å¤§å°å’Œæ•°æ®è¡Œå‡ç›¸åŒï¼‰ï¼Œåˆ™è¯¥ Block æ•°æ®å—ä¼šè¢«å¿½ç•¥ã€‚è¿™é¡¹è®¾ç½®å¯ä»¥é¢„é˜²ç”±å¼‚å¸¸åŸå› å¼•èµ·çš„ Block æ•°æ®å—é‡å¤å†™å…¥çš„é—®é¢˜ã€‚</strong></li>
</ul>
<p><strong>å¦‚æœå…‰çœ‹ä¸Šé¢è¿™äº›æ–‡å­—ä»‹ç»çš„è¯ï¼Œ å¯èƒ½ä¸å¤Ÿç›´è§‚ï¼Œé‚£ä¹ˆä¸‹é¢å°±ç”¨ç¤ºä¾‹é€æ­¥å±•å¼€ã€‚</strong></p>
<h3 id="ZooKeeper-çš„é…ç½®æ–¹å¼"><a href="#ZooKeeper-çš„é…ç½®æ–¹å¼" class="headerlink" title="ZooKeeper çš„é…ç½®æ–¹å¼"></a>ZooKeeper çš„é…ç½®æ–¹å¼</h3><p><strong>åœ¨æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œè¿˜éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œé‚£å°±æ˜¯å®‰è£…å¹¶é…ç½® ZooKeeperï¼Œå› ä¸º ReplicatedMergeTree å¿…é¡»å¯¹æ¥åˆ°å®ƒæ‰èƒ½å·¥ä½œã€‚å…³äº zk çš„å®‰è£…ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ï¼Œä½¿ç”¨ 3.4.5 ä»¥ä¸Šçš„ç‰ˆæœ¬å‡å¯ï¼Œæˆ‘è¿™é‡Œå®‰è£…å®Œæˆï¼Œä¸‹é¢é‡ç‚¹ä»‹ç»å¦‚ä½•åœ¨ ClickHouse ä¸­å¢åŠ  ZooKeeper çš„é…ç½®ã€‚</strong></p>
<p><strong>ClickHouse ä½¿ç”¨ä¸€ç»„ zookeeper æ ‡ç­¾å®šä¹‰ç›¸å…³é…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨ config.xml ä¸­é…ç½®å³å¯ï¼Œå°†é…ç½®å†™åœ¨ config.xml çš„ æ ‡ç­¾é‡Œé¢ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span>  <span class="comment">&lt;!-- ZooKeeper æ‰€åœ¨èŠ‚ç‚¹é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªåœ°å€ --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- èŠ‚ç‚¹ IPï¼Œä¹Ÿæ˜¯å½“å‰ ClickHouse Server æ‰€åœ¨èŠ‚ç‚¹ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span>47.94.174.89<span class="tag">&lt;/<span class="name">host</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- ZooKeeper ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ 2181 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ç”±äºæˆ‘ä»¬åé¢ä¼šæ­å»ºå‰¯æœ¬ï¼Œå¹¶ä¸”åªç”¨è¿™ä¸€ä¸ª ZooKeeperï¼Œæ‰€ä»¥è¦ä¿è¯ 2181 ç«¯å£å¯¹å¤–å¼€æ”¾ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å½“ç„¶ config.xml é‡Œé¢ä¹Ÿæä¾›äº† zookeeper è¿™ä¸ªæ ‡ç­¾ï¼Œä¸è¿‡æ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ç®¡å®ƒï¼Œç›´æ¥æ‹·è´è¿›å»å³å¯ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202140287-1165521929.png" alt="img"></p>
<p><strong>é…ç½®å®Œä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨ clickhouse restart é‡å¯æœåŠ¡ã€‚ç„¶å ClickHouse åœ¨å®ƒçš„ç³»ç»Ÿè¡¨ä¸­è´´å¿ƒåœ°å‡†å¤‡äº†ä¸€å¼ åä¸º zookeeper çš„ä»£ç†è¡¨ï¼Œå¯ä»¥ä½¿ç”¨ SQL æŸ¥è¯¢çš„æ–¹å¼è¯»å–è¿œç«¯ ZooKeeper çš„æ•°æ®ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> czxid, mzxid, name, <span class="keyword">value</span> <span class="keyword">FROM</span> system.zookeeper <span class="keyword">WHERE</span> path <span class="operator">=</span> <span class="string">&#x27;/&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šæŸ¥è¯¢çš„æ—¶å€™å¿…é¡»æŒ‡å®š path è¿›è¡Œæ¡ä»¶ç­›é€‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202148316-1323461086.png" alt="img"></p>
<p><strong>è¿™é‡Œéœ€è¦å…ˆæ¥ç®€å•è¯´ä¸€ä¸‹ ZooKeeper çš„æ•°æ®æ¨¡å‹ï¼ŒZooKeeper çš„æ•°æ®æ¨¡å‹å’Œ UNIX æ–‡ä»¶ç³»ç»Ÿå¾ˆç±»ä¼¼ï¼Œæ•´ä½“ä¸Šå¯ä»¥çœ‹åšæ˜¯ä¸€æ£µæ ‘ã€‚æ ‘ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ç§°ä¹‹ä¸ºä¸€ä¸ª ZNodeï¼Œå¯ä»¥é€šè¿‡è·¯å¾„è¿›è¡Œå”¯ä¸€æ ‡è¯†ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œæˆ‘ä»¬éšä¾¿æŒ‘ä¸¤ä¸ªèŠ‚ç‚¹ç”»å¼ å›¾å°±æ¸…æ™°äº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202154952-1732310430.png" alt="img"></p>
<p><strong>æ ¹èŠ‚ç‚¹å°±æ˜¯ &#x2F;ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸‹é¢å¯ä»¥åˆ›å»ºå¤šä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶å±‚å±‚é€’å½’ä¸‹å»ï¼Œæ‰€ä»¥å°±åƒæ–‡ä»¶ç³»ç»Ÿä¸€æ ·ã€‚è€Œæˆ‘ä»¬åœ¨æŸ¥æ‰¾çš„æ—¶å€™ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œå±‚å±‚ç»„åˆï¼Œå› ä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„åç§°ï¼ŒæŒ‰ç…§é¡ºåºç»„åˆèµ·æ¥å³å¯å¾—åˆ° pathã€‚å› æ­¤æˆ‘ä»¬æŒ‡å®š path ç­‰äº &#x2F; å³å¯æŸ¥åˆ°æ ¹èŠ‚ç‚¹ä¸‹é¢çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè€Œå›¾ä¸­çš„ name å­—æ®µæ˜¾ç¤ºçš„å°±æ˜¯ ZNode çš„åç§°ï¼Œæ³¨æ„ï¼šåªæ˜¾ç¤ºä¸€å±‚ï¼Œä¸ä¼šé€’å½’æ˜¾ç¤ºã€‚</strong></p>
<p><strong>å¹¶ä¸”æ¯ä¸ª ZNode é»˜è®¤èƒ½å¤Ÿå­˜å‚¨ 1MB çš„æ•°æ®ï¼Œè€Œå›¾ä¸­ system.zookeeper çš„ value å­—æ®µæ˜¾ç¤ºçš„å°±æ˜¯ ZNode å­˜å‚¨çš„å€¼ï¼Œè‡³äº ZNode çš„å…¶å®ƒå±æ€§å¯ä»¥è‡ªå·±æŸ¥é˜…ä¸€ä¸‹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚å¦å¤–ï¼Œç”±äºæˆ‘è¿™ ZooKeeper å¾ˆæ—©å°±å­˜åœ¨äº†ï¼Œæ‰€ä»¥é‡Œé¢åŒ…å«äº†å¾ˆå¤šä¸ ClickHouse æ— å…³çš„æ•°æ®ï¼Œå¦‚æœä½ æ˜¯æ–°å®‰è£…çš„ï¼Œé‚£ä¹ˆä¿¡æ¯ä¸ä¼šåƒä¸Šé¢è¿™ä¹ˆå¤šã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œæˆ‘ä»¬æŸ¥è¯¢ clickhouse ä¸‹é¢æ‰€æœ‰çš„ ZNodeï¼Œé‚£ä¹ˆå°†æ¡ä»¶æ”¹æˆ path = &#x27;/clickhouse&#x27; å³å¯</span></span><br><span class="line"><span class="comment">-- å½“å‰åªæœ‰ä¸€ä¸ª task_queueï¼ŒåŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å»ºè¡¨ï¼Œè€Œå»ºè¡¨ä¹‹åï¼Œè¿™é‡Œå°±ä¼šå¤šå‡ºä¸€ä¸ªåä¸º tables çš„ ZNode</span></span><br><span class="line"><span class="comment">-- ç„¶å /clickhouse/tables ä¸‹é¢åˆä¼šå­˜åœ¨åä¸º 01ã€02... çš„ ZNodeï¼Œå¯¹åº”å‰¯æœ¬ 1ã€å‰¯æœ¬ 2....</span></span><br><span class="line"><span class="keyword">SELECT</span> czxid, mzxid, name, <span class="keyword">value</span> <span class="keyword">FROM</span> system.zookeeper</span><br><span class="line"><span class="keyword">WHERE</span> path <span class="operator">=</span> <span class="string">&#x27;/clickhouse&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">â”Œâ”€czxidâ”€â”¬â”€mzxidâ”€â”¬â”€nameâ”€â”€â”€â”€â”€â”€â”€â”¬â”€valueâ”€â”</span></span><br><span class="line"><span class="comment">â”‚  1087 â”‚  1087 â”‚ task_queue â”‚       â”‚</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="å‰¯æœ¬çš„å®šä¹‰å½¢å¼"><a href="#å‰¯æœ¬çš„å®šä¹‰å½¢å¼" class="headerlink" title="å‰¯æœ¬çš„å®šä¹‰å½¢å¼"></a>å‰¯æœ¬çš„å®šä¹‰å½¢å¼</h3><p><strong>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œä½¿ç”¨å‰¯æœ¬çš„å¥½å¤„ç”šå¤šã€‚é¦–å…ˆï¼Œç”±äºå¢åŠ äº†æ•°æ®çš„å­˜å‚¨å†—ä½™ï¼Œæ‰€ä»¥é™ä½äº†æ•°æ®ä¸¢å¤±çš„é£é™©ï¼›å…¶æ¬¡ï¼Œç”±äºå‰¯æœ¬é‡‡ç”¨äº†å¤šä¸»æ¶æ„ï¼Œæ‰€ä»¥æ¯ä¸ªå‰¯æœ¬å®ä¾‹éƒ½å¯ä»¥ä½œä¸ºæ•°æ®è¯»ã€å†™çš„å…¥å£ï¼Œè¿™æ— ç–‘åˆ†æ‘Šäº†èŠ‚ç‚¹çš„è´Ÿè½½ã€‚</strong></p>
<p><strong>åœ¨ä½¿ç”¨å‰¯æœ¬æ—¶ï¼Œä¸éœ€è¦ä¾èµ–ä»»ä½•é›†ç¾¤çš„é…ç½®ï¼ˆå…³äºé›†ç¾¤åé¢è¯´ï¼‰ï¼ŒReplicatedMergeTree ç»“åˆ ZooKeeper å°±èƒ½å®Œæˆå…¨éƒ¨å·¥ä½œã€‚</strong></p>
<p><strong>ReplicatedMergeTree çš„å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = ReplicatedMergeTree(&#x27;zk_path&#x27;, &#x27;replica_name&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨ä¸Šè¿°é…ç½®é¡¹ä¸­ï¼Œæœ‰ zk_path å’Œ replica_name ä¸¤é¡¹ï¼Œé¦–å…ˆä»‹ç» zk_path çš„ä½œç”¨ã€‚</strong></p>
<p><strong>zk_path ç”¨äºæŒ‡å®šåœ¨ ZooKeeper ä¸­åˆ›å»ºçš„æ•°æ®è¡¨çš„è·¯å¾„ï¼Œè·¯å¾„åç§°æ˜¯è‡ªå®šä¹‰çš„ï¼Œå¹¶æ²¡æœ‰å›ºå®šè§„åˆ™ï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®æˆè‡ªå·±å¸Œæœ›çš„ä»»ä½•è·¯å¾„ã€‚å³ä¾¿å¦‚æ­¤ï¼ŒClickHouse è¿˜æ˜¯æä¾›äº†ä¸€äº›çº¦å®šä¿—æˆçš„é…ç½®æ¨¡æ¿ä»¥ä¾›å‚è€ƒï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/clickhouse/tables/&#123;shard&#125;/table_name</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ï¼š</strong></p>
<ul>
<li><strong>&#x2F;clickhouse&#x2F;tables æ˜¯çº¦å®šä¿—æˆçš„è·¯å¾„å›ºå®šå‰ç¼€ï¼Œè¡¨ç¤ºå­˜æ”¾æ•°æ®è¡¨çš„æ ¹è·¯å¾„ã€‚</strong></li>
<li><strong>{shard} è¡¨ç¤ºåˆ†ç‰‡ç¼–å·ï¼Œé€šå¸¸ç”¨æ•°å€¼æ›¿ä»£ï¼Œä¾‹å¦‚ 01ã€02ã€03ï¼Œä¸€å¼ æ•°æ®è¡¨å¯ä»¥æœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œè€Œæ¯ä¸ªåˆ†ç‰‡éƒ½æ‹¥æœ‰è‡ªå·±çš„å‰¯æœ¬ã€‚</strong></li>
<li><strong>table_name è¡¨ç¤ºæ•°æ®è¡¨çš„åç§°ï¼Œä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œé€šå¸¸ä¸ç‰©ç†è¡¨çš„åå­—ç›¸åŒï¼ˆè™½ç„¶ ClickHouse å¹¶ä¸è¦æ±‚è·¯å¾„ä¸­çš„è¡¨åç§°å’Œç‰©ç†è¡¨åå¿…é¡»ä¸€è‡´ï¼‰ï¼›è€Œ replica_name çš„ä½œç”¨æ˜¯å®šä¹‰åœ¨ ZooKeeper ä¸­åˆ›å»ºçš„å‰¯æœ¬åç§°ï¼Œè¯¥åç§°æ˜¯åŒºåˆ†ä¸åŒå‰¯æœ¬å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ã€‚ä¸€ç§çº¦å®šä¿—æˆçš„æ–¹å¼æ˜¯ä½¿ç”¨æ‰€åœ¨æœåŠ¡å™¨çš„åŸŸåç§°ã€‚</strong></li>
</ul>
<p><strong>å¯¹äº zk_path è€Œè¨€ï¼ŒåŒä¸€å¼ æ•°æ®è¡¨çš„åŒä¸€ä¸ªåˆ†ç‰‡çš„ä¸åŒå‰¯æœ¬ï¼Œåº”è¯¥å®šä¹‰ç›¸åŒçš„è·¯å¾„ï¼›è€Œå¯¹äº replica_name è€Œè¨€ï¼ŒåŒä¸€å¼ æ•°æ®è¡¨çš„åŒä¸€ä¸ªåˆ†ç‰‡çš„ä¸åŒå‰¯æœ¬ï¼Œåº”è¯¥å®šä¹‰ä¸åŒçš„åç§°ã€‚è¯»èµ·æ¥å¾ˆæ‹—å£ï¼Œæˆ‘ä»¬ä¸¾ä¸ªæ —å­è¯´æ˜ä¸€ä¸‹ã€‚</strong></p>
<p><strong>1 ä¸ªåˆ†ç‰‡ã€1 ä¸ªå‰¯æœ¬çš„æƒ…å½¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- zk_path ç›¸åŒï¼Œreplica_name ä¸åŒ</span></span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.1&#x27;</span>)</span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å¤šä¸ªåˆ†ç‰‡ã€1 ä¸ªå‰¯æœ¬çš„æƒ…å½¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ†ç‰‡1ï¼ˆ2 åˆ†ç‰‡ã€1 å‰¯æœ¬ï¼‰ï¼Œzk_path ç›¸åŒï¼Œå…¶ä¸­ shard = 01ï¼Œreplica_name ä¸åŒ</span></span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.1&#x27;</span>)</span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ†ç‰‡2ï¼ˆ2 åˆ†ç‰‡ã€1 å‰¯æœ¬ï¼‰ï¼Œzk_path ç›¸åŒï¼Œå…¶ä¸­ shard = 02ï¼Œreplica_name ä¸åŒ</span></span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/02/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.3&#x27;</span>)</span><br><span class="line">ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/02/test_1&#x27;</span>, <span class="string">&#x27;192.168.0.4&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>é¦–å…ˆæ˜¯ zk_pathï¼Œæ— è®ºä¸€å¼ è¡¨æœ‰å¤šå°‘ä¸ªåˆ†ç‰‡ã€å¤šå°‘ä¸ªå‰¯æœ¬ï¼Œå®ƒä»¬ç»ˆå½’å±äºåŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ zk_path çš„æœ€åä¸€éƒ¨åˆ†ã€ä¹Ÿå°±æ˜¯è¡¨åç§°æ˜¯ä¸å˜çš„ï¼Œè¿™é‡Œå§‹ç»ˆæ˜¯ test_1ã€‚ä½†é—®é¢˜æ˜¯å¤šä¸ªåˆ†ç‰‡ä¹‹é—´è¦å¦‚ä½•åŒºåˆ†å‘¢ï¼Ÿæ‰€ä»¥æ­¤æ—¶å°±ä¾èµ–äº {shard}ï¼Œ&#x2F;clickhouse&#x2F;tables&#x2F;01&#x2F;test_1 è¡¨ç¤º test_1 çš„ç¬¬ 1 ä¸ªåˆ†ç‰‡ï¼Œ&#x2F;clickhouse&#x2F;tables&#x2F;02&#x2F;test_1 è¡¨ç¤º test_1 çš„ç¬¬ 2 ä¸ªåˆ†ç‰‡ï¼Œç¬¬ 3ã€4ã€5â€¦.. ä¸ªåˆ†ç‰‡ä¾æ¬¡ç±»æ¨ï¼Œè‡³äºå…¶å®ƒçš„è¡¨ä¹Ÿæ˜¯åŒç†ã€‚</strong></p>
<p><strong>è€Œä¸€ä¸ªåˆ†ç‰‡ä¸ç®¡æœ‰å¤šå°‘ä¸ªå‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬ç»ˆå½’éƒ½å±äºåŒä¸€ä¸ªåˆ†ç‰‡ã€åŒä¸€å¼ è¡¨ã€‚æ‰€ä»¥åŒä¸€å¼ æ•°æ®è¡¨çš„åŒä¸€ä¸ªåˆ†ç‰‡çš„ä¸åŒå‰¯æœ¬ï¼Œåº”è¯¥å®šä¹‰ç›¸åŒçš„è·¯å¾„ï¼›ä¾‹å¦‚è¡¨ test_2 çš„æ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰ 3 ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆä»¥ç¬¬ 8 ä¸ªåˆ†ç‰‡ä¸ºä¾‹ï¼Œå®ƒçš„æ‰€æœ‰å‰¯æœ¬çš„ zk_path å°±éƒ½åº”è¯¥é…æˆï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/clickhouse/tables/08/test_2</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åæ˜¯ replica_nameï¼Œè¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œå› ä¸ºè¦åŒºåˆ†åŒä¸€ä¸ªåˆ†åŒºå†…å¤šä¸ªå‰¯æœ¬ï¼Œæ˜¾ç„¶å®ƒä»¬è¦æœ‰ä¸åŒçš„åç§°ã€‚æ‰€ä»¥ä¸Šé¢è¯»èµ·æ¥å¾ˆæ‹—å£çš„ç¬¬äºŒä¸ªå¥è¯å°±è§£é‡Šå®Œäº†ï¼Œå¯¹äº replica_name è€Œè¨€ï¼ŒåŒä¸€å¼ æ•°æ®è¡¨çš„åŒä¸€ä¸ªåˆ†ç‰‡çš„ä¸åŒå‰¯æœ¬ï¼Œåº”è¯¥å®šä¹‰ä¸åŒçš„åç§°ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨ IP åœ°å€æ›¿ä»£äº†ã€‚</strong></p>
<h2 id="ReplicatedMergeTree-åŸç†è§£æ"><a href="#ReplicatedMergeTree-åŸç†è§£æ" class="headerlink" title="ReplicatedMergeTree åŸç†è§£æ"></a>ReplicatedMergeTree åŸç†è§£æ</h2><p><strong>æ­£å¦‚æˆ‘ä»¬ä¹‹å‰åˆ†æ MergeTree ä¸€æ ·ï¼ŒReplicatedMergeTree ä½œä¸ºå¤åˆ¶è¡¨ç³»åˆ—çš„åŸºç¡€è¡¨å¼•æ“ï¼Œæ¶µç›–äº†æ•°æ®å‰¯æœ¬æœ€ä¸ºæ ¸å¿ƒçš„é€»è¾‘ï¼Œæˆ‘ä»¬å¾ˆæ˜æ˜¾è¦æ‹¿å®ƒå…¥æ‰‹ã€‚åªè¦æ˜ç™½äº† ReplicatedMergeTree çš„æ ¸å¿ƒåŸç†ï¼Œå°±èƒ½æŒæ¡æ•´ä¸ª ReplicatedMergeTree ç³»åˆ—è¡¨å¼•æ“çš„ä½¿ç”¨æ–¹æ³•ã€‚</strong></p>
<h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p><strong>åœ¨ ReplicatedMergeTree çš„æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œå¤§é‡è¿ç”¨äº† ZooKeeper çš„èƒ½åŠ›ï¼Œä»¥å®ç°å¤šä¸ª ReplicatedMergeTree å‰¯æœ¬å®ä¾‹ä¹‹é—´çš„ååŒï¼ŒåŒ…æ‹¬ä¸»å‰¯æœ¬é€‰ä¸¾ã€å‰¯æœ¬çŠ¶æ€æ„ŸçŸ¥ã€æ“ä½œæ—¥å¿—åˆ†å‘ã€ä»»åŠ¡é˜Ÿåˆ—å’Œ BlockID å»é‡åˆ¤æ–­ç­‰ç­‰ã€‚åœ¨æ‰§è¡Œ INSERT æ•°æ®å†™å…¥ã€MERGE åˆ†åŒºå’Œ MUTATION æ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šæ¶‰åŠä¸ ZooKeeper çš„é€šä¿¡ã€‚ä½†æ˜¯åœ¨é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸ä¼šæ¶‰åŠä»»ä½•è¡¨æ•°æ®çš„ä¼ è¾“ï¼Œåœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ä¹Ÿä¸ä¼šè®¿é—® ZooKeeperï¼Œæ‰€ä»¥æ— éœ€æ‹…å¿ƒ ZooKeeper çš„æ‰¿è½½å‹åŠ›ã€‚</strong></p>
<p><strong>å› ä¸º ZooKeeper å¯¹ ReplicatedMergeTree éå¸¸é‡è¦ï¼Œæ‰€ä»¥ä¸‹é¢é¦–å…ˆä»å®ƒçš„æ•°æ®ç»“æ„å¼€å§‹ä»‹ç»ã€‚</strong></p>
<h4 id="ZooKeeper-å†…çš„èŠ‚ç‚¹ç»“æ„"><a href="#ZooKeeper-å†…çš„èŠ‚ç‚¹ç»“æ„" class="headerlink" title="ZooKeeper å†…çš„èŠ‚ç‚¹ç»“æ„"></a>ZooKeeper å†…çš„èŠ‚ç‚¹ç»“æ„</h4><p><strong>ReplicatedMergeTree éœ€è¦ä¾é  ZooKeeper çš„æ—¶é—´ç›‘å¬æœºåˆ¶ä»¥å®ç°å„ä¸ªå‰¯æœ¬ä¹‹é—´çš„åè°ƒï¼Œæ‰€ä»¥åœ¨æ¯å¼  ReplicatedMergeTree è¡¨çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä»¥ zk_path ä¸ºæ ¹è·¯å¾„ï¼Œåœ¨ ZooKeeper ä¸­ä¸ºè¿™å¼ è¡¨åˆ›å»ºä¸€ç»„ç›‘å¬èŠ‚ç‚¹ã€‚è€ŒæŒ‰ç…§ä½œç”¨çš„ä¸åŒï¼Œè¿™äº›ç›‘å¬èŠ‚ç‚¹å¯ä»¥åˆ†æˆå¦‚ä¸‹å‡ ç±»ï¼ˆå…ˆæœ‰ä¸ªå°è±¡ï¼Œåé¢ä¼šé€šè¿‡å®é™…æ¡ˆä¾‹æ¥ä½“ç°ï¼‰ï¼š</strong></p>
<p><strong>1ï¼‰å…ƒæ•°æ®ï¼š</strong></p>
<ul>
<li><code>&#123;zk_path&#125;/metadataï¼šä¿å­˜å…ƒæ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸»é”®ã€åˆ†åŒºé”®ã€é‡‡æ ·è¡¨è¾¾å¼ç­‰</code></li>
<li><code>&#123;zk_path&#125;/columnsï¼šä¿å­˜åˆ—å­—æ®µä¿¡æ¯ï¼ŒåŒ…æ‹¬åˆ—åç§°å’Œæ•°æ®ç±»å‹</code></li>
<li><code>&#123;zk_path&#125;/replicasï¼šä¿å­˜å‰¯æœ¬åç§°ï¼Œå¯¹åº”è®¾ç½®å‚æ•°ä¸­çš„ replica_name</code></li>
</ul>
<p><strong>2ï¼‰åˆ¤æ–­æ ‡è¯†ï¼š</strong></p>
<ul>
<li><code>&#123;zk_path&#125;/leader_electionï¼šç”¨äºä¸»å‰¯æœ¬çš„é€‰ä¸¾å·¥ä½œï¼Œä¸»å‰¯æœ¬ä¼šä¸»å¯¼ MERGE å’Œ MUTATION æ“ä½œï¼ˆALTER DELETE å’Œ ALTER UPDATEï¼Œç±»ä¼¼å…³ç³»å‹æ•°æ®åº“ä¸­çš„ DELETE å’Œ UPDATEï¼‰ï¼Œè¿™äº›ä»»åŠ¡åœ¨ä¸»å‰¯æœ¬å®Œæˆä¹‹åå†å€ŸåŠ© ZooKeeper å°†æ¶ˆæ¯äº‹ä»¶åˆ†å‘è‡³å…¶å®ƒå‰¯æœ¬</code></li>
<li><code>&#123;zk_path&#125;/blocksï¼šè®°å½• Block æ•°æ®å—çš„ Hash ä¿¡æ¯æ‘˜è¦ï¼Œä»¥åŠå¯¹åº”çš„ partition_idï¼Œé€šè¿‡ Hash ä¿¡æ¯æ‘˜è¦èƒ½å¤Ÿåˆ¤æ–­ Block å—æ˜¯å¦é‡å¤ï¼›é€šè¿‡ partition_idï¼Œåˆ™èƒ½å¤Ÿæ‰¾åˆ°éœ€è¦åŒæ­¥çš„æ•°æ®åˆ†åŒº</code></li>
<li><code>&#123;zk_path&#125;/block_numbersï¼šæŒ‰ç…§åˆ†åŒºçš„å†™å…¥é¡ºåºï¼Œä»¥ç›¸åŒçš„é¡ºåºè®°å½• partition_idï¼Œå„ä¸ªå‰¯æœ¬åœ¨æœ¬åœ°è¿›è¡Œ MERGE æ—¶ï¼Œéƒ½ä¼šä¾ç…§ç›¸åŒçš„ block_numbers é¡ºåºè¿›è¡Œ</code></li>
<li><code>&#123;zk_path&#125;/quorumï¼šè®°å½• quorum çš„æ•°é‡ï¼Œå½“è‡³å°‘æœ‰ quorum æ•°é‡çš„å‰¯æœ¬å†™å…¥æˆåŠŸåï¼Œæ•´ä¸ªå†™å…¥æ‰ç®—æˆåŠŸã€‚quorum çš„æ•°é‡ç”± insert_quorum å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 0</code></li>
</ul>
<p><strong>3ï¼‰æ“ä½œæ—¥å¿—ï¼š</strong></p>
<ul>
<li><p><code>&#123;zk_path&#125;/logï¼šå¸¸è§„æ“ä½œæ—¥å¿—èŠ‚ç‚¹ï¼ˆINSERTã€MERGE å’Œ DROP PARTITONï¼‰ï¼Œå®ƒæ˜¯æ•´ä¸ªå·¥ä½œæœºåˆ¶ä¸­æœ€ä¸ºé‡è¦çš„ä¸€ç¯ï¼Œä¿å­˜äº†å‰¯æœ¬éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æŒ‡ä»¤ã€‚log ä½¿ç”¨äº† ZooKeeper çš„æŒä¹…é¡ºåºå‹èŠ‚ç‚¹ï¼Œæ¯æ¡æŒ‡ä»¤çš„åç§°ä»¥ log- ä¸ºå‰ç¼€é€’å¢ï¼Œä¾‹å¦‚ log-0000000000ã€log-0000000001 ç­‰ã€‚æ¯ä¸€ä¸ªå‰¯æœ¬å®ä¾‹éƒ½ä¼šç›‘å¬ /log èŠ‚ç‚¹ï¼Œå½“æœ‰æ–°çš„æŒ‡ä»¤åŠ å…¥æ—¶ï¼Œå®ƒä»¬ä¼šæŠŠæŒ‡ä»¤åŠ å…¥å‰¯æœ¬å„è‡ªçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶æ‰§è¡Œä»»åŠ¡ã€‚å…³äºè¿™æ–¹é¢çš„é€»è¾‘ï¼Œåç»­è¯¦ç»†ä»‹ç»</code></p>
</li>
<li><p><code>&#123;zk_path&#125;/mutationsï¼šMUTATION æ“ä½œæ—¥å¿—èŠ‚ç‚¹ï¼Œä½œç”¨ä¸ log æ—¥å¿—ç±»ä¼¼ï¼Œå½“æ‰§è¡Œ ALTER DELETE å’Œ ALTER UPDATE æŸ¥è¯¢æ—¶ï¼Œæ“ä½œæŒ‡ä»¤ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªç‚¹ã€‚mutations åŒæ ·ä½¿ç”¨äº† ZooKeeper çš„æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼Œä½†æ˜¯å®ƒçš„å‘½åæ²¡æœ‰å‰ç¼€ï¼Œæ¯æ¡æŒ‡ä»¤ç›´æ¥ä»¥é€’å¢æ•°å­—çš„å½¢å¼ä¿å­˜ï¼Œä¾‹å¦‚ 0000000000ã€0000000001 ç­‰ã€‚å…³äºè¿™æ–¹é¢çš„é€»è¾‘ï¼ŒåŒæ ·åç»­å±•å¼€</code></p>
</li>
<li><pre><code>&#123;zk_path&#125;/replicas/&#123;replica_name&#125;/*ï¼šæ¯ä¸ªå‰¯æœ¬å„è‡ªçš„èŠ‚ç‚¹ä¸‹çš„ä¸€ç»„ç›‘å¬èŠ‚ç‚¹ï¼Œç”¨äºæŒ‡å¯¼å‰¯æœ¬åœ¨æœ¬åœ°æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡æŒ‡ä»¤ï¼Œå…¶ä¸­è¾ƒä¸ºé‡è¦çš„èŠ‚ç‚¹æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">  - `&#123;zk_path&#125;/replicas/&#123;replica_name&#125;/queueï¼šä»»åŠ¡é˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç”¨äºæ‰§è¡Œå…·ä½“çš„æ“ä½œä»»åŠ¡ã€‚å½“å‰¯æœ¬ä» /log æˆ– /mutations èŠ‚ç‚¹ç›‘å¬åˆ°æ“ä½œæŒ‡ä»¤æ—¶ï¼Œä¼šå°†æ‰§è¡Œä»»åŠ¡æ·»åŠ è‡³è¯¥èŠ‚ç‚¹ä¸‹ï¼Œå¹¶åŸºäºé˜Ÿåˆ—æ‰§è¡Œ`</span><br><span class="line">  - `&#123;zk_path&#125;/replicas/&#123;replica_name&#125;/log_pointerï¼šlog æ—¥å¿—æŒ‡é’ˆèŠ‚ç‚¹ï¼Œè®°å½•äº†æœ€åä¸€æ¬¡æ‰§è¡Œçš„ log æ—¥å¿—ä¸‹æ ‡ä¿¡æ¯ï¼Œä¾‹å¦‚ log_poniter:4 å¯¹åº”äº† /log/log-0000000003ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰`</span><br><span class="line">  - `&#123;zk_path&#125;/replicas/&#123;replica_name&#125;/mutation_pointerï¼šmutations æ—¥å¿—æŒ‡é’ˆèŠ‚ç‚¹ï¼Œè®°å½•äº†æœ€åä¸€æ¬¡æ‰§è¡Œçš„ mutations æ—¥å¿—åç§°ï¼Œä¾‹å¦‚ mutation_pointer:0000000000 å¯¹åº”äº† &#123;zk_path&#125;/mutations/0000000000`</span><br><span class="line"></span><br><span class="line">#### Entry æ—¥å¿—å¯¹è±¡çš„æ•°æ®ç»“æ„</span><br><span class="line"></span><br><span class="line">**ä»ä¸Šé¢çš„ä»‹ç»å¯çŸ¥ï¼ŒReplicatedMergeTree åœ¨ ZooKeeper ä¸­æœ‰ä¸¤ç»„éå¸¸é‡è¦çš„çˆ¶èŠ‚ç‚¹ï¼Œé‚£å°±æ˜¯ /log å’Œ /mutationsï¼Œä¸ºäº†ç®€ä¾¿ï¼Œæ¥ä¸‹æ¥ä»‹ç»è·¯å¾„æ—¶å€™å°±ä¸å†™ &#123;zk_path&#125; äº†ã€‚å®ƒä»¬çš„ä½œç”¨çŠ¹å¦‚ä¸€åº§é€šä¿¡å¡”ï¼Œæ˜¯åˆ†å‘æ“ä½œæŒ‡ä»¤çš„ä¿¡æ¯é€šé“ï¼Œè€Œåˆ†å‘æ“ä½œä¹‹çµçš„æ–¹å¼ï¼Œåˆ™æ˜¯ä¸ºè¿™äº›çˆ¶èŠ‚ç‚¹æ·»åŠ å­èŠ‚ç‚¹ã€‚æ‰€æœ‰çš„å‰¯æœ¬å®ä¾‹ï¼Œéƒ½ä¼šç›‘å¬çˆ¶èŠ‚ç‚¹çš„å˜åŒ–ï¼Œå½“æœ‰å­èŠ‚ç‚¹è¢«æ·»åŠ æ—¶ï¼Œå®ƒä»¬èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥ã€‚**</span><br><span class="line"></span><br><span class="line">**å½“ç„¶è¿™äº›è¢«æ·»åŠ çš„å­èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­å°±æ˜¯ç›¸åº”çš„ ZNodeï¼Œè€Œ ZNode çš„å­˜å‚¨çš„å€¼åœ¨ ClickHouse ä¸­ç»Ÿä¸€è¢«æŠ½è±¡ä¸º Entry å¯¹è±¡ï¼Œè€Œå…·ä½“å®ç°åˆ™ç”± LogEntry å’Œ MutationEntry å¯¹è±¡æ‰¿è½½ï¼Œåˆ†åˆ«å¯¹åº” /log å’Œ /mutations çš„å­èŠ‚ç‚¹çš„ valueã€‚**</span><br><span class="line"></span><br><span class="line">**1ï¼‰LogEntryï¼š**</span><br><span class="line"></span><br><span class="line">**LogEntry ç”¨äºå°è£… /log çš„å­èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¤§ç™½è¯è§£é‡Šçš„è¯ï¼Œå…¶å® /log ä¸‹é¢çš„ ZNode å­˜å‚¨çš„ value å°±æ˜¯ LogEntryï¼Œå®ƒæ‹¥æœ‰å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒå±æ€§ã€‚**</span><br><span class="line"></span><br><span class="line">- `source replicaï¼šå‘é€è¿™æ¡ Log æŒ‡ä»¤çš„å‰¯æœ¬æ¥æºï¼Œå¯¹åº” replica_name`</span><br><span class="line">- `block_idï¼šå½“å‰åˆ†åŒºçš„ BlockIDï¼Œå¯¹åº” /blocks è·¯å¾„ä¸‹å­èŠ‚ç‚¹çš„åç§°`</span><br><span class="line">- `æ“ä½œæŒ‡ä»¤ç±»å‹ï¼Œä¸»è¦æœ‰ getã€merge å’Œ mutate ä¸‰ç§ï¼Œåˆ†åˆ«å¯¹åº”ä»è¿œç¨‹å‰¯æœ¬ä¸‹è½½åˆ†åŒºã€åˆå¹¶åˆ†åŒºä»¥åŠ MUTATION æ“ä½œ`</span><br><span class="line">- `å½“å‰åˆ†åŒºç›®å½•çš„åç§°`</span><br><span class="line"></span><br><span class="line">**2ï¼‰MutationEntryï¼š**</span><br><span class="line"></span><br><span class="line">**MutationEntry ç”¨äºå°è£… /mutations çš„å­èŠ‚ç‚¹ä¿¡æ¯ï¼Œå®ƒåŒæ ·æ‹¥æœ‰å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒå±æ€§ã€‚**</span><br><span class="line"></span><br><span class="line">- `source replicaï¼šå‘é€è¿™æ¡ MUTATION æŒ‡ä»¤çš„å‰¯æœ¬æ¥æºï¼Œå¯¹åº”replica_name`</span><br><span class="line">- `commandsï¼šæ“ä½œæŒ‡ä»¤ï¼Œä¸»è¦æœ‰ ALTER DELETE å’Œ ALTER UPDATE`</span><br><span class="line">- `mutation_idï¼šMUTATION æ“ä½œçš„ç‰ˆæœ¬å·`</span><br><span class="line">- `partition_idï¼šå½“å‰åˆ†åŒºç›®å½•çš„ ID`</span><br><span class="line"></span><br><span class="line">**ä»¥ä¸Šå°±æ˜¯ Entry æ—¥å¿—å¯¹è±¡çš„æ•°æ®ç»“æ„ä¿¡æ¯ï¼Œåœ¨æ¥ä¸‹æ¥å°†è¦ä»‹ç»çš„æ ¸å¿ƒæµç¨‹ä¸­ï¼Œä¼šçœ‹åˆ°å®ƒä»¬çš„èº«å½±ã€‚**</span><br><span class="line"></span><br><span class="line">### åˆ†åŒºå‰¯æœ¬ååŒçš„æ ¸å¿ƒæµç¨‹</span><br><span class="line"></span><br><span class="line">**å‰¯æœ¬ååŒçš„æ ¸å¿ƒæµç¨‹ä¸»è¦æœ‰ INSERTã€MERGEã€MUTATION å’Œ ALTER å››ç§ï¼Œåˆ†åˆ«å¯¹åº”äº†æ•°æ®å†™å…¥ã€åˆ†åŒºåˆå¹¶ã€æ•°æ®ä¿®æ”¹å’Œå…ƒæ•°æ®ä¿®æ”¹ã€‚INSERT å’Œ ALTER æŸ¥è¯¢æ˜¯åˆ†å¸ƒå¼æ‰§è¡Œçš„ï¼Œå€ŸåŠ© ZooKeeper çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå¤šä¸ªå‰¯æœ¬ä¹‹é—´ä¼šè‡ªåŠ¨è¿›è¡Œæœ‰æ•ˆååŒï¼Œä½†æ˜¯å®ƒä»¬ä¸ä¼šä½¿ç”¨ ZooKeeper å­˜å‚¨ä»»ä½•åˆ†åŒºæ•°æ®ã€‚è‡³äºå…¶ä»–æŸ¥è¯¢å¹¶ä¸æ”¯æŒåˆ†å¸ƒå¼æ‰§è¡Œï¼ŒåŒ…æ‹¬ SELECTã€CREATEã€DROPã€RENAME å’Œ ATTACHã€‚ä¾‹å¦‚ï¼Œä¸ºäº†åˆ›å»ºå¤šä¸ªå‰¯æœ¬ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«ç™»å½•æ¯ä¸ª ClickHouse èŠ‚ç‚¹ï¼Œåœ¨å®ƒä»¬æœ¬åœ°æ‰§è¡Œå„è‡ªçš„ CREATE è¯­å¥ï¼ˆåé¢å°†ä¼šä»‹ç»å¦‚ä½•åˆ©ç”¨é›†å™¨é…ç½®ç®€åŒ–è¿™ä¸€æ“ä½œï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œä¼šä¾æ¬¡ä»‹ç»ä¸Šè¿°æµç¨‹çš„å·¥ä½œæœºç†ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥æ•´ä½“è®¤è¯†ä¸€ä¸‹å„ä¸ªæµç¨‹çš„ä»‹ç»æ–¹æ³•ã€‚**</span><br><span class="line"></span><br><span class="line">**é¦–å…ˆï¼Œæ‹Ÿå®šä¸€ä¸ªæ¼”ç¤ºåœºæ™¯ï¼Œå³ä½¿ç”¨ ReplicatedMergeTree å®ç°ä¸€å¼ æ‹¥æœ‰ 1 åˆ†ç‰‡ã€1 å‰¯æœ¬çš„æ•°æ®è¡¨ï¼Œå¹¶ä»¥æ­¤æ¥è´¯ç©¿æ•´ä¸ªè®²è§£è¿‡ç¨‹ï¼ˆå¯¹äºå¤§äº 1 ä¸ªå‰¯æœ¬çš„åœºæ™¯ï¼Œæµç¨‹ä»¥æ­¤ç±»æ¨ï¼‰ã€‚**</span><br><span class="line"></span><br><span class="line">**æ¥ç€ï¼Œé€šè¿‡å¯¹ ReplicatedMergeTree åˆ†åˆ«æ‰§è¡Œ INSERTã€MERGEã€MUTATION å’Œ ALTER æ“ä½œï¼Œä»¥æ­¤æ¥è®²è§£ç›¸åº”çš„å·¥ä½œåŸç†ã€‚ä¸æ­¤åŒæ—¶ï¼Œé€šè¿‡å®é™…æ¡ˆä¾‹ï¼Œè®ºè¯å·¥ä½œåŸç†ã€‚**</span><br><span class="line"></span><br><span class="line">**é¦–å…ˆåˆ°è¿™é‡Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å°±æœ‰äº›æ‰è¥Ÿè§è‚˜äº†ï¼Œå› ä¸ºæˆ‘ä»¬è¦å®ç° 1 åˆ†ç‰‡ã€1 å‰¯æœ¬ï¼Œé‚£ä¹ˆè‡³å°‘è¦æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ã€‚è€Œåœ¨æˆ‘å½“å‰é˜¿é‡Œäº‘ä¸Šæœ‰ä¸‰å°æœåŠ¡å™¨ï¼Œç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š**</span><br><span class="line"></span><br><span class="line">- `47.94.174.89ï¼Œä¸»æœºåä¸º satoriï¼Œ2 æ ¸å¿ƒ 8GB å†…å­˜`</span><br><span class="line">- `47.93.39.238ï¼Œä¸»æœºåä¸º matsuriï¼Œ2 æ ¸å¿ƒ 4GB å†…å­˜`</span><br><span class="line">- `47.93.235.147ï¼Œä¸»æœºåä¸º aquaï¼Œ2 æ ¸å¿ƒ 4GB å†…å­˜`</span><br><span class="line"></span><br><span class="line">**ä¸»æœº satori å°±æ˜¯æˆ‘ä»¬å½“å‰ä¸€ç›´ä½¿ç”¨çš„èŠ‚ç‚¹ï¼Œç„¶åå†åŠ ä¸Š matsuri èŠ‚ç‚¹æ¥å®ç°æˆ‘ä»¬çš„ 1 åˆ†ç‰‡ã€1 å‰¯æœ¬ã€‚**</span><br><span class="line"></span><br><span class="line">#### INSERT çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹</span><br><span class="line"></span><br><span class="line">**å½“éœ€è¦åœ¨ ReplicatedMergeTree ä¸­æ‰§è¡Œ INSERT æŸ¥è¯¢ä»¥å†™å…¥æ•°æ®æ—¶ï¼Œå³ä¼šè¿›å…¥ INSERT æ ¸å¿ƒæµç¨‹ã€‚è€Œæ•´ä¸ªæµç¨‹æŒ‰ç…§æ—¶é—´ä»ä¸Šå¾€ä¸‹é¡ºåºè¿›è¡Œï¼Œæˆ‘ä»¬å¤§è‡´å°†å…¶åˆ†äº† 8 ä¸ªæ­¥éª¤ï¼Œé‚£ä¹ˆä¸‹é¢å°±ä¾æ¬¡è®²è§£æ¯ä¸€ä¸ªè¿‡ç¨‹ã€‚**</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">**1ï¼‰åˆ›å»ºç¬¬ä¸€ä¸ªå‰¯æœ¬å®ä¾‹**</span><br><span class="line"></span><br><span class="line">**ä½¿ç”¨å‰¯æœ¬ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯ä¸ºäº†è®© satori èŠ‚ç‚¹å’Œ matsuri èŠ‚ç‚¹ç»„åˆå½¢æˆ 1 åˆ†ç‰‡ 1 å‰¯æœ¬ç­–ç•¥ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ config.xmlã€‚é¦–å…ˆå¯¹äº 1 åˆ†ç‰‡å¤šå‰¯æœ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¸éœ€è¦é…ç½®é›†ç¾¤ï¼Œåªéœ€è¦é…ç½®å¥½ ZooKeeper å³å¯ã€‚å½“ç„¶ 1 åˆ†ç‰‡å¤šå‰¯æœ¬ä¹Ÿæ˜¯å¯ä»¥é…ç½®é›†ç¾¤çš„ï¼Œåªä¸è¿‡è¯¥é›†ç¾¤åªæœ‰ä¸€ä¸ªåˆ†ç‰‡ç½¢äº†ï¼Œä½†æˆ‘ä»¬è¯´ä¸é…ç½®ä¹Ÿèƒ½å®ç° 1 åˆ†ç‰‡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±é‡‡ç”¨ä¸é…ç½®é›†ç¾¤çš„æ–¹å¼å®ç°ï¼›è€Œå…³äºé›†ç¾¤çš„é…ç½®ï¼Œæˆ‘ä»¬åœ¨ä»‹ç»å¤šåˆ†ç‰‡çš„æ—¶å€™å†è¯´ï¼Œå› ä¸ºå¦‚æœæ˜¯å¤šåˆ†ç‰‡ï¼Œåˆ™å¿…é¡»è¦é…ç½®é›†ç¾¤ï¼Œå…·ä½“å†…å®¹åé¢è¯´ã€‚ä¸‹é¢æ¥çœ‹çœ‹éœ€è¦ä¿®æ”¹å“ªäº›é…ç½®ï¼š**</span><br><span class="line"></span><br><span class="line">```XML</span><br><span class="line">&lt;!-- é…ç½® ZooKeeperï¼Œæˆ‘ä»¬ä¹‹å‰å°±é…ç½®è¿‡äº†ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ª ZooKeeperï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®å•ä¸ªå°±è¡Œ --&gt;</span><br><span class="line">&lt;zookeeper&gt;   </span><br><span class="line">    &lt;node index=&quot;1&quot;&gt;  </span><br><span class="line">        &lt;host&gt;47.94.174.89&lt;/host&gt;  </span><br><span class="line">        &lt;port&gt;2181&lt;/port&gt;</span><br><span class="line">    &lt;/node&gt;</span><br><span class="line">&lt;/zookeeper&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- å¼€æ”¾ç»™å¤–ç•Œè®¿é—®ï¼Œæˆ‘ä»¬åœ¨æœ€å¼€å§‹çš„æ—¶å€™ä¹Ÿæ”¹è¿‡äº† --&gt;</span><br><span class="line">&lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ IPï¼Œéœ€è¦è¿›è¡Œè®¾ç½®ï¼Œè®©èŠ‚ç‚¹ä¹‹é—´å¯ä»¥äº’ç›¸è®¿é—®ï¼Œå¦åˆ™å‰¯æœ¬æ— æ³•åŒæ­¥ --&gt;</span><br><span class="line">&lt;!-- æ³¨æ„ï¼šæˆ‘å½“å‰ç”¨çš„é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸åœ¨åŒä¸€ä¸ªå†…ç½‘ä¸­ï¼Œæ‰€ä»¥æŒ‡å®šçš„æ˜¯å…¬ç½‘ IP</span><br><span class="line">     ä½†å¦‚æœä½ çš„å¤šä¸ªé˜¿é‡ŒæœåŠ¡å™¨äº‘åœ¨åŒä¸€ä¸ªå†…ç½‘ï¼Œé‚£ä¹ˆå»ºè®®æŒ‡å®šå†…ç½‘ IPï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šä¿¡ä¼šæ¯”ä½¿ç”¨å…¬ç½‘ IP å¿«å¾ˆå¤š --&gt;</span><br><span class="line">&lt;interserver_http_host&gt;47.94.174.89&lt;/interserver_http_host&gt;</span><br><span class="line">&lt;!-- èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ç«¯å£ï¼Œé»˜è®¤ 9009ï¼Œå½“ç„¶ç«¯å£æ— æ‰€è°“ï¼Œåªè¦ä¿è¯å½¼æ­¤ä¹‹é—´æ˜¯å¼€æ”¾çš„å°±è¡Œ --&gt;</span><br><span class="line">&lt;interserver_http_port&gt;9009&lt;/interserver_http_port&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p><strong>ä¿®æ”¹å®Œé…ç½®ä¹‹åé‡å¯ ClickHouseï¼Œç„¶åä» satori èŠ‚ç‚¹ï¼ˆ47.94.174.89ï¼‰å¼€å§‹ï¼Œæ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œä»è€Œåˆ›å»ºç¬¬ä¸€ä¸ªå‰¯æœ¬å®ä¾‹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> replicated_sales_1 (</span><br><span class="line">    id String,</span><br><span class="line">    price Float64,</span><br><span class="line">    create_time DateTime</span><br><span class="line">) </span><br><span class="line"><span class="comment">-- è¿™é‡Œ replica_name æˆ‘ä»¬å°±ä»¥ &quot;ä¸»æœºå_replica&quot; çš„å½¢å¼å‘½å</span></span><br><span class="line">ENGINE<span class="operator">=</span>ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/replicated_sales_1&#x27;</span>, <span class="string">&#x27;satori_replica&#x27;</span>) </span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼ŒReplicatedMergeTree ä¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–åŠ¨ä½œï¼Œä¾‹å¦‚ï¼š</strong></p>
<ul>
<li><code>æ ¹æ® zk_path åˆå§‹åŒ–æ‰€æœ‰çš„ ZooKeeper èŠ‚ç‚¹</code></li>
<li><code>åœ¨ /replicas/ èŠ‚ç‚¹ä¸‹æ³¨å†Œè‡ªå·±çš„å‰¯æœ¬å®ä¾‹ satori_replica</code></li>
<li><code>å¯åŠ¨ç›‘å¬ä»»åŠ¡ï¼Œç›‘å¬ /log æ—¥å¿—èŠ‚ç‚¹</code></li>
<li><code>å‚ä¸å‰¯æœ¬é€‰ä¸¾ï¼Œé€‰ä¸¾å‡ºä¸»å‰¯æœ¬ï¼Œé€‰ä¸¾çš„æ–¹å¼æ˜¯å‘ /leader_election æ’å…¥å­èŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ’å…¥æˆåŠŸçš„å‰¯æœ¬å°±æ˜¯ä¸»å‰¯æœ¬</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202222625-1610669710.png" alt="img"></p>
<p><strong>æ­¤æ—¶åœ¨ satori èŠ‚ç‚¹ä¸Šï¼Œè¯¥è¡¨ï¼ˆå‰¯æœ¬ï¼‰å°±åˆ›å»ºå®Œæ¯•äº†ã€‚</strong></p>
<p><strong>2ï¼‰åˆ›å»ºç¬¬äºŒä¸ªå‰¯æœ¬å®ä¾‹</strong></p>
<p><strong>æ¥ç€åœ¨ matsuri èŠ‚ç‚¹ä¸Šåˆ›å»ºç¬¬äºŒä¸ªå‰¯æœ¬ï¼Œå½“ç„¶è¦å…ˆå®‰è£… ClickHouseï¼Œè¿™é‡Œæˆ‘å·²ç»å®‰è£…å®Œæ¯•äº†ã€‚ç„¶åæˆ‘ä»¬ä¹Ÿè¦ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é…ç½® ZooKeeperï¼ŒZooKeeper åœ¨ satori èŠ‚ç‚¹ä¸Šï¼ŒæŒ‡å®šç›¸å…³ IP å’Œç«¯å£ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span>47.94.174.89<span class="tag">&lt;/<span class="name">host</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- åŒç†ï¼Œå¼€æ”¾ç»™å¤–ç•Œ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ IPï¼Œè¿™é‡Œæ”¹æˆ matsuri èŠ‚ç‚¹çš„ IP --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_host</span>&gt;</span>47.93.39.238<span class="tag">&lt;/<span class="name">interserver_http_host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_port</span>&gt;</span>9009<span class="tag">&lt;/<span class="name">interserver_http_port</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶ä¹‹åï¼Œå¯åŠ¨ ClickHouseï¼Œå¦‚æœå·²ç»å¯åŠ¨ï¼Œé‚£ä¹ˆå°±é‡å¯ ClickHouse ã€‚ç„¶ååˆ›å»ºç¬¬äºŒä¸ªå‰¯æœ¬ï¼Œè¡¨ç»“æ„å’Œ zk_path å’Œç¬¬ä¸€ä¸ªå‰¯æœ¬ç›¸åŒï¼Œè€Œ replica_name åˆ™è®¾ç½®æˆ matsuri èŠ‚ç‚¹çš„ IPã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> replicated_sales_1 (</span><br><span class="line">    id String,</span><br><span class="line">    price Float64,</span><br><span class="line">    create_time DateTime</span><br><span class="line">) </span><br><span class="line"><span class="comment">-- é™¤äº† replica_nameï¼Œå…¶å®ƒä¸å˜</span></span><br><span class="line">ENGINE<span class="operator">=</span>ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/replicated_sales_1&#x27;</span>, <span class="string">&#x27;matsuri_replica&#x27;</span>) </span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(create_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œç¬¬äºŒä¸ª ReplicatedMergeTree åŒæ ·ä¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–åŠ¨ä½œï¼Œä¾‹å¦‚ï¼š</strong></p>
<ul>
<li><code>åœ¨ /replicas/ èŠ‚ç‚¹ä¸‹æ³¨å†Œè‡ªå·±çš„å‰¯æœ¬å®ä¾‹ matsuri_replica</code></li>
<li><code>å¯åŠ¨ç›‘å¬ä»»åŠ¡ï¼Œç›‘å¬ /log æ—¥å¿—èŠ‚ç‚¹</code></li>
<li><code>å‚ä¸å‰¯æœ¬é€‰ä¸¾ï¼Œé€‰ä¸¾å‡ºä¸»å‰¯æœ¬ï¼Œæ˜¾ç„¶å½“å‰çš„ä¸»å‰¯æœ¬æ˜¯ satori_replica å‰¯æœ¬</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202232300-293850742.png" alt="img"></p>
<p><strong>ä¸¤ä¸ªå‰¯æœ¬å…¨éƒ¨åˆ›å»ºå®Œäº†ï¼Œæ¥ä¸‹æ¥è¯¥å¹²å•¥äº†ï¼Œæ²¡é”™ï¼Œå†™å…¥æ•°æ®ã€‚</strong></p>
<p><strong>3ï¼‰å‘ç¬¬ä¸€ä¸ªå‰¯æœ¬å®ä¾‹å†™å…¥æ•°æ®</strong></p>
<p><strong>ç°åœ¨å°è¯•å‘ç¬¬ä¸€ä¸ªå‰¯æœ¬ satori_replica å†™å…¥æ•°æ®ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> replicated_sales_1</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;A001&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;2019-05-10 00:00:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202240184-445553689.png" alt="img"></p>
<p><strong>åœ¨æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œé¦–å…ˆä¼šåœ¨æœ¬åœ°å®Œæˆåˆ†åŒºç›®å½•çš„å†™å…¥ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Renaming temporary part tmp_insert_201905_1_1_0 to 201905_0_0_0</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ç€å‘ &#x2F;blocks èŠ‚ç‚¹å†™å…¥è¯¥æ•°æ®åˆ†åŒºçš„ block_idï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Wrote block with ID &#x27;201905_11789774603085290207_1081647372304402844&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>å¯èƒ½æœ‰äººè§‰å¾—è¿™ä¸ª ID æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œç­”æ¡ˆæ˜¯ä» ZooKeeper ä¸Šé¢æŸ¥çš„ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202313553-1303882622.png" alt="img"></p>
<p><strong>å› ä¸ºç›®å‰åªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥ &#x2F;blocks èŠ‚ç‚¹ä¸‹é¢åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆZNodeï¼‰ï¼ŒZNode çš„åå­—å°±æ˜¯ block_idï¼Œå­˜å‚¨çš„å€¼å°±æ˜¯åˆ†åŒºç›®å½•åã€‚å½“ç„¶è¿™ä¸ª block_id çš„è®¡ç®—è¿‡ç¨‹æˆ‘ä»¬å°±ä¸æ¼”ç¤ºäº†ï¼Œå®ƒä¸æ˜¯é‡ç‚¹ï¼Œåªè¦çŸ¥é“å®ƒæ˜¯ä½œä¸ºåç»­å»é‡æ“ä½œçš„åˆ¤æ–­ä¾æ®å³å¯ã€‚æ¯”å¦‚æˆ‘ä»¬æ­¤æ—¶å†æ‰§è¡Œä¸€æ¬¡åˆšæ‰çš„ SQL è¯­å¥ï¼Œè¯•å›¾å†™å…¥é‡å¤æ•°æ®ï¼Œç„¶åæŸ¥è¯¢æ—¶ä¼šå‘ç°æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202322434-549762506.png" alt="img"></p>
<p><strong>æ‰€ä»¥å‰¯æœ¬ä¼šè‡ªåŠ¨å¿½ç•¥ block_id é‡å¤çš„å¾…å†™å…¥æ•°æ®ã€‚</strong></p>
<p><strong>æ­¤å¤–ï¼Œå¦‚æœè®¾ç½®äº† insert_quorum å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼‰å¹¶ä¸”å€¼å¤§äºç­‰äº 2ï¼Œé‚£ä¹ˆ satori_replica å‰¯æœ¬ä¼šè¿›ä¸€æ­¥ç›‘æ§å·²å®Œæˆå†™å…¥æ“ä½œçš„å‰¯æœ¬ä¸ªæ•°ï¼Œåªæœ‰å½“å†™å…¥å‰¯æœ¬ä¸ªæ•°å¤§äºç­‰äº insert_quorum æ—¶ï¼Œæ•´ä¸ªå†™å…¥æ“ä½œæ‰ç®—æˆåŠŸã€‚</strong></p>
<p><strong>4ï¼‰ç”±ç¬¬ä¸€ä¸ªå‰¯æœ¬å®ä¾‹æ¨é€ Log æ—¥å¿—</strong></p>
<p><strong>åœ¨ç¬¬ 3 ä¸ªæ­¥éª¤å®Œæˆä¹‹åï¼Œä¼šç»§ç»­ç”±æ‰§è¡Œäº† INSERT çš„å‰¯æœ¬å‘ &#x2F;log èŠ‚ç‚¹æ¨é€æ“ä½œæ—¥å¿—ï¼Œåœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œä¼šç”±ç¬¬ä¸€ä¸ªå‰¯æœ¬ satori_replica æ‹…æ­¤é‡ä»»ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202331023-534547670.png" alt="img"></p>
<p><strong>æ˜¾ç„¶é‡Œé¢åªæœ‰ä¸€ä¸ª ZNodeï¼Œå…¶ name å°±æ˜¯æ—¥å¿—çš„ç¼–å·ï¼š&#x2F;log&#x2F;log-0000000000ï¼Œè€Œ value å°±æ˜¯å¯¹åº”çš„ LogEntryã€‚ä½†è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰æ‰“å°ï¼ŒåŸå› æ˜¯é‡Œé¢æœ‰ç‰¹æ®Šçš„æ¢è¡Œï¼Œå¯¼è‡´æ‰“å°çš„æ—¶å€™çœ‹èµ·æ¥éå¸¸çš„ä¸‘ï¼Œè‡³äºå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">format version:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">create_time:</span> <span class="number">2021-09-17 15:07:47</span></span><br><span class="line"><span class="attr">source replica:</span> <span class="string">satori_replica</span></span><br><span class="line"><span class="attr">block_id:</span> <span class="string">201905_11789774603085290207_1081647372304402844</span></span><br><span class="line"><span class="string">get</span></span><br><span class="line"><span class="string">201905_0_0_0</span></span><br><span class="line"><span class="attr">part_type:</span> <span class="string">Compact</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿¡æ¯ä¸éš¾ç†è§£ï¼Œé‡Œé¢çš„ get è¡¨ç¤ºæ“ä½œç±»å‹ï¼Œè¿™é‡Œæ˜¯ä¸‹è½½ã€‚è€Œéœ€è¦ä¸‹è½½çš„åˆ†åŒºæ˜¯ 201905_0_0_0ï¼Œå…¶ä½™æ‰€æœ‰å‰¯æœ¬éƒ½ä¼šåŸºäº Log æ—¥å¿—ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œå‘½ä»¤ã€‚</strong></p>
<p><strong>5ï¼‰ç¬¬äºŒä¸ªå‰¯æœ¬å®ä¾‹æ‹‰å– Log æ—¥å¿—</strong></p>
<p><strong>matsuri_replica å‰¯æœ¬ä¼šä¸€ç›´ç›‘å¬ &#x2F;log èŠ‚ç‚¹å˜åŒ–ï¼Œå½“ satori_replica å‰¯æœ¬æ¨é€äº† &#x2F;log&#x2F;log-0000000000 ä¹‹åï¼Œmatsuri_replica å‰¯æœ¬ä¾¿ä¼šè§¦å‘æ—¥å¿—çš„æ‹‰å–ä»»åŠ¡å¹¶æ›´æ–° log_pointerï¼Œå°†å…¶æŒ‡å‘æœ€æ–°æ—¥å¿—ä¸‹æ ‡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/replicas/matsuri_replica/log_pointer: 1</span><br><span class="line">-- /replicas/matsuri_replica ä¸‹é¢çš„ ZNode æœ‰å¾ˆå¤šï¼Œlog_pointer åªæ˜¯å…¶ä¸­ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œå†é€šè¿‡ name è¿‡æ»¤ä¸€ä¸‹</span><br><span class="line">-- æ³¨æ„ï¼šæˆ‘ä»¬æŸ¥çœ‹çš„æ˜¯ log_pointerï¼Œæ‰€ä»¥ä¸è¦å°† path æŒ‡å®šä¸º /replicas/matsuri_replica/log_pointer</span><br><span class="line">-- ä¸Šé¢çš„åšæ³•ä¸å¯¹çš„ï¼Œå› ä¸ºè¿™ç­‰äºæŸ¥çœ‹ log_pointer ä¸‹é¢æ‰€æœ‰çš„ ZNodeï¼Œè€Œä¸æ˜¯ log_pointer è¿™ä¸ª ZNode</span><br><span class="line">SELECT name, value FROM system.zookeeper</span><br><span class="line">WHERE path = &#x27;/clickhouse/tables/01/replicated_sales_1/replicas/matsuri_replica&#x27;</span><br><span class="line">AND name = &#x27;log_pointer&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202340494-1223174326.png" alt="img"></p>
<p><strong>æ¯æ‹‰å–ä¸€æ¬¡æ—¥å¿—ï¼Œlog_pointer å¯¹åº”çš„ value å°±ä¼šè‡ªå¢ 1ï¼Œåˆå§‹å€¼æ˜¯ 0ã€‚</strong></p>
<p><strong>å½“ matsuri_replica å‰¯æœ¬æ‹‰å–äº† satori_replica å‰¯æœ¬æ¨é€çš„æ—¥å¿—ï¼ˆè¿™é‡Œæ˜¯ &#x2F;log&#x2F;log-0000000000ï¼‰ï¼Œä¾¿ä¼šæ ¹æ®å…¶å†…å®¹ï¼ˆLogEntryï¼‰è¿›è¡Œæ‰§è¡Œã€‚åªä¸è¿‡è¿™ä¸ªåŠ¨ä½œå¹¶ä¸æ˜¯é©¬ä¸Šå°±å‘ç”Ÿçš„ï¼Œè€Œæ˜¯ä¼šå°†å…¶è½¬æˆä»»åŠ¡å¯¹è±¡æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/replicas/matsuri_replica/queue</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œæ”¾å…¥é˜Ÿåˆ—æ˜¯è®©å…¶æˆä¸º &#x2F;replicas&#x2F;matsuri_replica&#x2F;queue çš„å­èŠ‚ç‚¹ï¼ˆZNodeï¼‰ï¼Œè¿™ä¹ˆåšçš„åŸå› æ˜¯åœ¨å¤æ‚çš„æƒ…å†µä¸‹ï¼Œè€ƒè™‘åˆ°åœ¨åŒä¸€ä¸ªæ—¶é—´æ®µå†…å¯èƒ½ä¼šè¿ç»­æ”¶åˆ°è®¸å¤šä¸ª LogEntryï¼Œæ‰€ä»¥é€šè¿‡é˜Ÿåˆ—çš„æ–¹å¼æ¶ˆåŒ–ä»»åŠ¡æ˜¯ä¸€ç§æ›´ä¸ºåˆç†çš„è®¾è®¡ã€‚æ³¨æ„ï¼šæ‹‰å–çš„ LogEntry æ˜¯ä¸€ä¸ªåŒºé—´ï¼Œè¿™åŒæ ·æ˜¯å› ä¸ºå¯èƒ½ä¼šè¿ç»­æ”¶åˆ°å¤šä¸ª LogEntryã€‚ä¸è¿‡å½“å‰åªæœ‰ä¸€ä¸ª LogEntryï¼Œæ‰€ä»¥åŒºé—´çš„å¼€å¤´å’Œç»“å°¾æ˜¯åŒä¸€ä¸ª LogEntryã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Pulling 1 entries to queue: log-0000000000 - log-0000000000</span><br></pre></td></tr></table></figure>

<p><strong>ä½†å¦‚æœæˆ‘ä»¬æ­¤æ—¶æŸ¥çœ‹ &#x2F;replicas&#x2F;matsuri_replica&#x2F;queue çš„è¯ï¼Œä¼šå‘ç°æ‹¿ä¸åˆ°ä»»ä½•çš„ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¾€ satori_replica å‰¯æœ¬å†™å…¥æ•°æ®çš„ä¹‹åï¼Œå¾ˆå¿«å°±åŒæ­¥åˆ° matsuri_replica å‰¯æœ¬å½“ä¸­äº†ï¼Œæ‰€ä»¥æ­¤æ—¶é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å·²ç»è¢«æ¶ˆè´¹æ‰äº†ï¼Œå› æ­¤å°±ä»€ä¹ˆä¹Ÿçœ‹ä¸åˆ°äº†ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ matsuri_replica å‰¯æœ¬ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦çœŸçš„åŒæ­¥è¿‡æ¥äº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202349108-1707497686.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°æ•°æ®å·²ç»åœ¨ matsuri_replica èŠ‚ç‚¹ä¸Šé¢äº†ï¼Œæ‰€ä»¥åˆ›å»ºæ•°æ®è¡¨éœ€è¦æ¯ä¸ªå‰¯æœ¬éƒ½è¦åˆ›å»ºï¼Œä½†æ˜¯æ’å…¥æ•°æ®åªéœ€è¦å¾€ä¸€ä¸ªå‰¯æœ¬ä¸­æ’å…¥å³å¯ï¼Œå‰©ä½™çš„å‰¯æœ¬ä¼šè‡ªåŠ¨åŒæ­¥ã€‚ä¸è¿‡æ•°æ®è™½ç„¶å·²ç»åŒæ­¥è¿‡æ¥äº†ï¼Œä½†æˆ‘ä»¬çš„æ•´ä¸ªæµç¨‹è¿˜æ²¡æœ‰è¯´å®Œã€‚å½“æŠŠ LogEntry è½¬æˆä»»åŠ¡å¯¹è±¡æ”¾åˆ° queue ä¹‹åï¼Œè¯¥åšä»€ä¹ˆäº†å‘¢ï¼Ÿä¸ç”¨æƒ³ï¼Œè‚¯å®šæ˜¯ä» queue å–å‡ºä¾æ¬¡æ‰§è¡Œã€‚</strong></p>
<p><strong>6ï¼‰ç¬¬äºŒä¸ªå‰¯æœ¬å®ä¾‹å‘å…¶å®ƒå‰¯æœ¬å‘èµ·ä¸‹è½½è¯·æ±‚</strong></p>
<p><strong>matsuri_replica åŸºäº queue é˜Ÿåˆ—å‘èµ·ä¸‹è½½ä»»åŠ¡ï¼Œä¾æ¬¡å–å‡ºä»»åŠ¡å¯¹è±¡ï¼ˆå°è£… LogEntryï¼‰è¿›è¡Œæ‰§è¡Œï¼Œå½“çœ‹åˆ°ç±»å‹ä¸º get çš„æ—¶å€™ï¼ŒReplicatedMergeTree å°±ä¼šæ˜ç™½æ­¤æ—¶åœ¨è¿œç«¯çš„å…¶å®ƒå‰¯æœ¬ä¸­å·²ç»æˆåŠŸå†™å…¥äº†æ•°æ®åˆ†åŒºï¼Œè€Œè‡ªå·±éœ€è¦åŒæ­¥è¿™äº›æ•°æ®ã€‚</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">format version:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">create_time:</span> <span class="number">2021-09-17 15:07:47</span></span><br><span class="line"><span class="attr">source replica:</span> <span class="string">satori_replica</span></span><br><span class="line"><span class="attr">block_id:</span> <span class="string">201905_11789774603085290207_1081647372304402844</span></span><br><span class="line"><span class="string">get</span></span><br><span class="line"><span class="string">201905_0_0_0</span></span><br><span class="line"><span class="attr">part_type:</span> <span class="string">Compact</span></span><br></pre></td></tr></table></figure>

<p><strong>å› æ­¤ matsuri_replica å‰¯æœ¬ä¼šå¼€å§‹é€‰æ‹©è¿œç«¯çš„æŸä¸€ä¸ªå‰¯æœ¬ä½œä¸ºä¸‹è½½æ¥æºï¼Œé‚£ä¹ˆè¦é€‰æ‹©å“ªä¸€ä¸ªå‘¢ï¼Ÿç®—æ³•å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li><code>1. ä» /replicas ä¸­æ‹¿åˆ°æ‰€æœ‰çš„å‰¯æœ¬èŠ‚ç‚¹</code></li>
<li><code>2. éå†è¿™äº›å‰¯æœ¬ï¼Œé€‰å–å…¶ä¸­ä¸€ä¸ªï¼Œé€‰å–çš„å‰¯æœ¬éœ€è¦æ‹¥æœ‰æœ€å¤§çš„ log_pointerï¼Œå› ä¸º log_pointer è¶Šå¤§ï¼Œæ‰§è¡Œçš„æ—¥å¿—è¶Šå¤šï¼Œæ•°æ®ä¹Ÿå°±è¶Šå®Œæ•´ã€‚ä»¥æ­¤åŒæ—¶è¿˜è¦ queue ä¸‹çš„ ZNode å°‘çš„ï¼Œå› ä¸º ZNode è¶Šå°‘ï¼Œè¯´æ˜ä»»åŠ¡æ‰§è¡Œè´Ÿæ‹…è¶Šå°</code></li>
</ul>
<p><strong>å½“å‰è¿œç«¯åªæœ‰ satori_replica ä¸€ä¸ªå‰¯æœ¬å®ä¾‹ï¼Œæ‰€ä»¥ä¼šä»å®ƒè¿™é‡Œä¸‹è½½ï¼Œäºæ˜¯ matsuri_replica å‘ satori_replica å‘èµ·äº† HTTP è¯·æ±‚ï¼Œå¸Œæœ›ä¸‹è½½åˆ†åŒº 201905_0_0_0ã€‚</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Fetching part <span class="number">201905</span>_0_0_0 <span class="keyword">from</span> replicas/satori_replica</span><br><span class="line">Sending request to http:<span class="comment">//47.94.174.89:9009/?endpoint=DataPartsExchange</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœç¬¬ä¸€æ¬¡ä¸‹è½½å¤±è´¥ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ matsuri_replica ä¼šå†å°è¯• 4 æ¬¡ï¼Œä¸€å…±ä¼šå°è¯• 5 æ¬¡ã€‚å…·ä½“å°è¯•æ¬¡æ•°ç”± max_fetch_partition_retries_count å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤ä¸º 5ã€‚</strong></p>
<p><strong>7ï¼‰ç¬¬ä¸€ä¸ªå‰¯æœ¬å®ä¾‹å‘å“åº”æ•°æ®ä¸‹è½½</strong></p>
<p><strong>satori_replica çš„ DataPartsExchange ç«¯å£æœåŠ¡æ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚ï¼Œåœ¨å¾—çŸ¥å¯¹æ–¹æ¥æ„ä¹‹åï¼Œæ ¹æ®å‚æ•°åšå‡ºå“åº”ï¼Œå†åŸºäº DataPartsExchange å°†æœ¬åœ°åˆ†åŒº 201905_0_0_0 å“åº”ç»™ matsuri_replicaã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sending part 201905_0_0_0</span><br></pre></td></tr></table></figure>

<p><strong>8ï¼‰ç¬¬äºŒä¸ªå‰¯æœ¬å®ä¾‹ä¸‹è½½æ•°æ®å¹¶å®Œæˆæœ¬åœ°å†™å…¥</strong></p>
<p><strong>matsuri_replica åœ¨æ¥æ”¶åˆ° satori_replica çš„åˆ†åŒºæ•°æ®åï¼Œé¦–å…ˆå°†å…¶å†™è‡³ä¸´æ—¶ç›®å½•ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tmp_fetch_201905_0_0_0</span><br></pre></td></tr></table></figure>

<p><strong>å¾…å…¨éƒ¨æ•°æ®æ¥æ”¶å®Œæˆä¹‹åï¼Œé‡å‘½åè¯¥ç›®å½•ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Renaming temporary part tmp_fetch_201905_0_0_0 to 201905_0_0_0</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤æ•´ä¸ªå†™å…¥æµç¨‹ç»“æŸã€‚</strong></p>
<p><strong>å¯ä»¥çœ‹åˆ°ä»å¤´åˆ°å°¾ï¼Œåœ¨æ•´ä¸ª INSERT å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼ŒZooKeeper æ²¡æœ‰è¿›è¡Œä»»ä½•è¡¨æ•°æ®çš„ä¼ è¾“ï¼Œå®ƒåªæ˜¯èµ·ç€ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒçš„ä½œç”¨ã€‚å®¢æˆ·ç«¯å¾€ä¸€ä¸ªå‰¯æœ¬é‡Œé¢å†™å…¥åˆ†åŒºæ•°æ®ï¼Œç„¶åè¯¥å‰¯æœ¬ä¼šå¾€ ZooKeeper é‡Œé¢æ¨é€ç›¸å…³æ—¥å¿—ï¼Œå…¶å®ƒå‰¯æœ¬å†æ‹‰å–æ—¥å¿—ï¼Œæ ¹æ®æ—¥å¿—å†…å®¹ï¼ˆLogEntryï¼‰ä»è¯¥å‰¯æœ¬è¿™é‡Œä¸‹è½½æ•°æ®å¹¶å†™å…¥å„è‡ªçš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202402797-1086970807.png" alt="img"></p>
<p><strong>å¦å¤–æˆ‘ä»¬è¯´å¦‚æœè®¾ç½®äº† insert_quorum å¹¶ä¸” insert_quorum &gt;&#x3D; 2ï¼Œåˆ™è¿˜ä¼šç”±è¯¥å‰¯æœ¬ç›‘æ§å®Œæˆå†™å…¥çš„å‰¯æœ¬æ•°é‡ã€‚æ€»ä¹‹æ ¸å¿ƒå°±æ˜¯æ•°æ®å†™åœ¨å“ªä¸€ä¸ªå‰¯æœ¬ï¼Œå“ªä¸€ä¸ªå‰¯æœ¬å°±å‘ ZooKeeper é‡Œé¢æ¨æ—¥å¿—ï¼Œç„¶åå…¶å®ƒå‰¯æœ¬æ‹‰æ—¥å¿—ï¼Œæ¥ç€é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„è¿œç«¯å‰¯æœ¬ï¼Œè¿›è¡Œåˆ†åŒºæ•°æ®çš„ç‚¹å¯¹ç‚¹ä¸‹è½½ã€‚</strong></p>
<p><strong>æµç¨‹å›¾æ€»ç»“ï¼š</strong></p>
<p><strong>ä¸‹é¢å†ç”¨ä¸€å¼ å›¾æ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ 8 ä¸ªæ­¥éª¤ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202411365-906877305.png" alt="img"></p>
<h4 id="MERGE-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"><a href="#MERGE-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹" class="headerlink" title="MERGE çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"></a>MERGE çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹</h4><p><strong>å½“å‰æˆ‘ä»¬åªå†™å…¥äº†ä¸€æ¡æ•°æ®ï¼Œå¦‚æœå¾€ 201905 è¿™ä¸ªåˆ†åŒºä¸­å†å†™å…¥ä¸€æ¡æ•°æ®å‘¢ï¼Œæ˜¾ç„¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†åŒºç›®å½•ï¼Œç„¶ååå°çº¿ç¨‹ä¼šåœ¨ä¸€ä¸ªåˆé€‚çš„æ—¶æœºè¿›è¡Œåˆ†åŒºç›®å½•çš„åˆå¹¶ã€‚è¿™é‡Œæˆ‘ä»¬å°±è¿˜å¾€ satori_replica ä¸­å†™ï¼Œç„¶ååœ¨ matsuri_replica ä¸­è¯»ï¼Œé¡ºä¾¿å†æ¬¡éªŒè¯å‰¯æœ¬ä¹‹é—´æ˜¯å¦ä¼šæ­£å¸¸åŒæ­¥ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202419691-1875696001.png" alt="img"></p>
<p><strong>ä¹‹å‰æˆ‘ä»¬è¯´ï¼Œæ¯æ‹‰å–ä¸€æ¬¡æ—¥å¿—ï¼Œlog_pointer å°±ä¼šè‡ªå¢ 1ï¼Œæ—¢ç„¶è¿™é‡Œå‘ç”Ÿäº†æ•°æ®åŒæ­¥ï¼Œé‚£ä¹ˆè‚¯å®šæ¶‰åŠæ—¥å¿—çš„æ‹‰å–ã€‚é‚£ä¹ˆæŒ‰ç…§åˆ†æï¼Œmatsuri_replica çš„ log_pointer åº”è¯¥ä¼šå˜æˆ 2ï¼Œå› ä¸ºä¹‹å‰æ˜¯ 1ï¼Œè¿™é‡Œåˆæ‹‰å–äº†ä¸€æ¬¡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202428263-1099973391.png" alt="img"></p>
<p><strong>æ’å…¥æ•°æ®æˆ‘ä»¬ç®—æ˜¯å·²ç»æ˜ç™½äº†ï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯åˆå¹¶æ•°æ®äº†ï¼Œä¹Ÿå°±æ˜¯ ReplicatedMergeTree çš„åˆ†åŒºåˆå¹¶åŠ¨ä½œï¼šMERGEã€‚</strong></p>
<p><strong>å…¶å®æ— è®º MERGE æ“ä½œä»å“ªä¸ªå‰¯æœ¬å‘èµ·ï¼Œæœ€ç»ˆåˆå¹¶è®¡åˆ’éƒ½ä¼šç”±ä¸»å‰¯æœ¬å†³å®šã€‚åœ¨ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œsatori_replica å·²ç»ç«é€‰ä¸ºä¸»å‰¯æœ¬ï¼Œæ‰€ä»¥ä¸ºäº†è®ºè¯ï¼Œæˆ‘ä»¬å°±ä» matsuri_replica å¼€å§‹ã€‚æ•´ä¸ªæµç¨‹è¿˜æ˜¯æŒ‰ç…§æ—¶é—´ä»ä¸Šå¾€ä¸‹é¡ºåºè¿›è¡Œï¼Œæˆ‘ä»¬å¤§è‡´å°†å…¶åˆ†äº† 5 ä¸ªæ­¥éª¤ï¼Œé‚£ä¹ˆä¸‹é¢å°±ä¾æ¬¡è®²è§£æ¯ä¸€ä¸ªè¿‡ç¨‹ã€‚</strong></p>
<p><strong>1ï¼‰åˆ›å»ºè¿œç¨‹è¿æ¥ï¼Œå°è¯•ä¸ä¸»å‰¯æœ¬é€šä¿¡</strong></p>
<p><strong>é¦–å…ˆåœ¨ matsuri_replica å‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹æ‰§è¡Œ OPTIMIZEï¼Œå¼ºåˆ¶è§¦å‘åˆ†åŒºåˆå¹¶ï¼Œè¿™ä¸ªæ—¶å€™ matsuri_replica ä¼šé€šè¿‡ &#x2F;replicas æ‰¾åˆ° satori_replicaï¼Œå¹¶å°è¯•å»ºç«‹å’Œå®ƒçš„è¿œç¨‹è¿æ¥ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">optimize table replicated_sales_1</span><br><span class="line"><span class="title function_">Connection</span> <span class="params">(<span class="number">47.94</span><span class="number">.174</span><span class="number">.89</span>:<span class="number">9000</span>)</span> : Connetion. Database: <span class="keyword">default</span>. User: <span class="keyword">default</span></span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰ä¸»å‰¯æœ¬æ¥æ”¶é€šä¿¡</strong></p>
<p><strong>ä¸»å‰¯æœ¬æ¥æ”¶å¹¶å»ºç«‹æ¥è‡ªè¿œç«¯å‰¯æœ¬çš„è¿æ¥ã€‚</strong></p>
<p><strong>3ï¼‰ç”±ä¸»å‰¯æœ¬åˆ¶å®š MERGE è®¡åˆ’å¹¶æ¨é€ Log æ—¥å¿—</strong></p>
<p><strong>ç”±ä¸»å‰¯æœ¬ satori_replica åˆ¶å®š MERGE è®¡åˆ’ï¼Œå¹¶åˆ¤æ–­å“ªäº›åˆ†åŒºéœ€è¦åˆå¹¶ï¼Œåœ¨é€‰å®šä¹‹å satori_replica å°†åˆå¹¶è®¡åˆ’è½¬åŒ–ä¸º Log æ—¥å¿—å¯¹è±¡å¹¶æ¨é€ï¼Œä»¥é€šçŸ¥æ‰€æœ‰å‰¯æœ¬å¼€å§‹åˆå¹¶ã€‚é‚£ä¹ˆä¿¡æ¯éƒ½æœ‰å“ªäº›å‘¢ï¼Œç›´æ¥é€šè¿‡ ZooKeeper æŸ¥çœ‹å³å¯ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202436682-1463046358.png" alt="img"></p>
<p><strong>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ DataGrip æŸ¥è¯¢ï¼Œå‘½ä»¤è¡ŒæŸ¥è¯¢çš„è¯ï¼Œè¾“å‡ºçš„å†…å®¹ä¸å¥½çœ‹ã€‚æˆ‘ä»¬æ³¨æ„åˆ° &#x2F;log ä¸‹é¢æœ‰ä¸‰ä¸ª ZNodeï¼Œlog-0000000000 æ˜¯ç¬¬ä¸€æ¬¡å¾€ satori_replica å†™å…¥æ•°æ®æ‰€äº§ç”Ÿçš„æ—¥å¿—ï¼Œlog-0000000001 æ˜¯ç¬¬äºŒæ¬¡å¾€ satori_replica å†™å…¥æ•°æ®æ‰€äº§ç”Ÿçš„æ—¥å¿—ï¼Œè€Œ log-0000000002 æ˜¾ç„¶å°±æ˜¯ MEREG æ“ä½œäº§ç”Ÿçš„æ—¥å¿—ã€‚</strong></p>
<p><strong>æ ¹æ®å†…å®¹ä¸­çš„ merge æˆ‘ä»¬å¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªåˆå¹¶æ“ä½œï¼Œå°† 201905_0_0_0 å’Œ 201905_1_1_1 åˆå¹¶æˆ 201905_0_1_1ã€‚å¹¶ä¸”é€šè¿‡ source replica æˆ‘ä»¬ä¹Ÿèƒ½å¾—çŸ¥ï¼Œåˆå¹¶æ“ä½œæ˜¯ä» matsuri_replica å‰¯æœ¬å‘å‡ºçš„ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸»å‰¯æœ¬è¿˜ä¼šé”ä½æ‰§è¡Œçº¿ç¨‹ï¼Œå¯¹æ—¥å¿—çš„æ¥æ”¶æƒ…å†µè¿›è¡Œç›‘å¬ã€‚å…¶ç›‘å¬è¡Œä¸ºç”± replication_alter_partitions_sync å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 1ã€‚</strong></p>
<ul>
<li><code>å¦‚æœ replication_alter_partitions_sync è®¾ç½®ä¸º 0ï¼Œé‚£ä¹ˆä¸åšä»»ä½•ç­‰å¾…</code></li>
<li><code>å¦‚æœ replication_alter_partitions_sync è®¾ç½®ä¸º 1ï¼Œåªç­‰å¾…ä¸»å‰¯æœ¬è‡ªèº«å®Œæˆ</code></li>
<li><code>å¦‚æœ replication_alter_partitions_sync è®¾ç½®ä¸º 2ï¼Œä¼šç­‰å¾…æ‰€æœ‰å‰¯æœ¬æ‹‰å–å®Œæˆ</code></li>
</ul>
<p><strong>4ï¼‰å„ä¸ªå‰¯æœ¬åˆ†åˆ«æ‹‰å– Log æ—¥å¿—</strong></p>
<p><strong>ä¸»å‰¯æœ¬å°† MERGE è®¡åˆ’åˆ¶å®šå¥½ä¹‹åä¼šæ¨åˆ° ZooKeeper ä¸­ï¼Œç„¶åæ‰€æœ‰å‰¯æœ¬ä¼šè¿›è¡Œæ‹‰å–å¹¶æ¨é€åˆ°ä»»åŠ¡é˜Ÿåˆ— &#x2F;queue ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆä¸ºå®ƒçš„ä¸€ä¸ª ZNodeã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Pulling 1 entries to queue: log-0000000002 - log-0000000002</span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰å„ä¸ªå‰¯æœ¬åˆ†åˆ«åœ¨æœ¬åœ°æ‰§è¡Œ MERGE</strong></p>
<p><strong>satori_replica å’Œ matsuri_replica åŸºäºå„è‡ªçš„ &#x2F;queue é˜Ÿåˆ—æ‰§è¡Œä»»åŠ¡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Executing log entry to merge parts 201905_0_0_0, 201905_1_1_0 to 201905_0_1_1</span><br></pre></td></tr></table></figure>

<p><strong>å„ä¸ªå‰¯æœ¬å¼€å§‹åœ¨æœ¬åœ°æ‰§è¡Œ MERGEï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Merged 2 parts: from 201905_0_0_0 to 201905_1_1_0</span><br></pre></td></tr></table></figure>

<p><strong>åˆ°æ­¤ï¼Œæ•´ä¸ªåˆå¹¶æµç¨‹ç»“æŸã€‚å¯ä»¥çœ‹åˆ°å’Œæ’å…¥æ•°æ®ä¸€æ ·ï¼Œåœ¨ MERGE çš„è¿‡ç¨‹ä¸­ï¼ŒZooKeeper ä¹Ÿä¸ä¼šæ¶‰åŠä»»ä½•è¡¨æ•°æ®çš„ä¼ è¾“ï¼Œæ‰€æœ‰çš„åˆå¹¶æ“ä½œéƒ½æ˜¯ç”±å„ä¸ªå‰¯æœ¬åœ¨æœ¬åœ°å®Œæˆçš„ã€‚å¹¶ä¸”æ— è®ºåˆå¹¶åŠ¨ä½œåœ¨å“ªä¸ªå‰¯æœ¬è¢«è§¦å‘ï¼Œé¦–å…ˆéƒ½ä¼šè¢«è½¬äº¤ç»™ä¸»å‰¯æœ¬ï¼Œå†ç”±ä¸»å‰¯æœ¬è´Ÿè´£åˆå¹¶è®¡åˆ’çš„åˆ¶å®šã€æ¶ˆæ¯æ—¥å¿—çš„æ¨é€ä»¥åŠæ—¥å¿—æ¥æ”¶æƒ…å†µçš„ç›‘æ§ã€‚</strong></p>
<p><strong>æµç¨‹å›¾æ€»ç»“ï¼š</strong></p>
<p><strong>åŒæ ·å¯ä»¥ç”¨ä¸€å¼ æµç¨‹å›¾æ€»ç»“ä¸€ä¸‹ä¸Šé¢ 5 ä¸ªæ­¥éª¤ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202445490-2126247950.png" alt="img"></p>
<h4 id="MUTATION-çš„æ ¸å¿ƒæµç¨‹"><a href="#MUTATION-çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="MUTATION çš„æ ¸å¿ƒæµç¨‹"></a>MUTATION çš„æ ¸å¿ƒæµç¨‹</h4><p><strong>å¯¹ ReplicatedMergeTree æ•°æ®è¡¨æ‰§è¡Œ ALTER DELETE æˆ– ALTER UPDATE æ“ä½œçš„æ—¶å€™ï¼Œä¼šè¿›å…¥ MUTATION éƒ¨åˆ†çš„é€»è¾‘ã€‚å’Œ MERGE ç±»ä¼¼ï¼Œæ— è®º MUTATION æ“ä½œä»å“ªä¸ªå‰¯æœ¬å‘èµ·ï¼Œéƒ½ä¼šç”±ä¸»å‰¯æœ¬è¿›è¡Œå“åº”ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿è®ºè¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»ä¸æ˜¯ä¸»å‰¯æœ¬çš„ matsuri_replica å‰¯æœ¬å¼€å§‹ã€‚æ•´ä¸ªæµç¨‹æŒ‰ç…§æ—¶é—´ä»ä¸Šå¾€ä¸‹é¡ºåºè¿›è¡Œï¼Œå¤§è‡´åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</strong></p>
<p><strong>1ï¼‰æ¨é€ Mutation æ—¥å¿—</strong></p>
<p><strong>åœ¨ matsuri_replica é€šè¿‡ ALTER DELETE æ¥åˆ é™¤æ•°æ®ï¼ˆALTER UPDATE ä¸ä¹‹åŒç†ï¼‰ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> replicated_sales_1 <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œä¹‹åï¼Œè¯¥å‰¯æœ¬ä¼šè¿›è¡Œä¸¤ä¸ªé‡è¦åŠ¨ä½œã€‚</strong></p>
<ul>
<li><strong>åˆ›å»º MUTATION ID</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">created mutation with ID 0000000000</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>å°† MUTATION æ“ä½œè½¬æ¢ä¸º Mutation æ—¥å¿—ï¼Œå¹¶æ¨é€åˆ° &#x2F;mutations&#x2F;0000000000ï¼Œä¹Ÿå°±æ˜¯åœ¨ &#x2F;mutations ä¸‹é¢æ–°å»ºä¸€ä¸ªåä¸º 0000000000 çš„ ZNodeã€‚å…¶ä¸­ 0000000000 å°±æ˜¯ Mutation æ—¥å¿—çš„ nameï¼Œè€Œå¯¹åº”çš„å€¼ã€ä¹Ÿå°±æ˜¯ value è¢«ç§°ä¸º MutationEntryï¼Œè¿™é‡Œå’Œ Log æ—¥å¿—ç±»ä¼¼ã€‚MutationEntry å†…å®¹å¦‚ä¸‹ï¼š</strong></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202453652-1012562048.png" alt="img"></p>
<p><strong>ç”±æ­¤ä¹Ÿèƒ½çŸ¥æ™“ï¼ŒMUTATION çš„æ“ä½œæ—¥å¿—æ˜¯ç»ç”± &#x2F;mutations èŠ‚ç‚¹åˆ†å‘è‡³å„ä¸ªå‰¯æœ¬ä¸­çš„ã€‚</strong></p>
<p><strong>2ï¼‰æ‰€æœ‰å‰¯æœ¬å®ä¾‹å„è‡ªç›‘å¬ Mutation æ—¥å¿—</strong></p>
<p><strong>æ‰€æœ‰å‰¯æœ¬éƒ½ä¼šç›‘å¬ &#x2F;mutations èŠ‚ç‚¹ï¼Œä¸€æ—¦æœ‰æ–°çš„æ—¥å¿—å­èŠ‚ç‚¹åŠ å…¥ï¼Œå®ƒä»¬éƒ½èƒ½å®æ—¶æ„ŸçŸ¥ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Loading 1 mutation entries: 0000000000 - 0000000000</span><br></pre></td></tr></table></figure>

<p><strong>å½“ç›‘å¬åˆ°æœ‰æ–°çš„ Mutation æ—¥å¿—åŠ å…¥æ—¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å‰¯æœ¬éƒ½ä¼šç«‹å³å“åº”ï¼Œå®ƒä»¬ä¼šå…ˆåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯ä¸»å‰¯æœ¬ã€‚</strong></p>
<p><strong>3ï¼‰ç”±ä¸»å‰¯æœ¬å®ä¾‹å“åº” Mutation æ—¥å¿—å¹¶æ¨é€ Log æ—¥å¿—</strong></p>
<p><strong>åªæœ‰ä¸»å‰¯æœ¬æ‰ä¼šå“åº” Mutation æ—¥å¿—ï¼Œåœ¨è¿™ä¸ªæ —å­ä¸­ satori_replica ä¸ºä¸»å‰¯æœ¬ï¼Œæ‰€ä»¥ satori_replica å°† Mutation æ—¥å¿—è½¬æ¢ä¸º Log æ—¥å¿—å¹¶æ¨é€è‡³ &#x2F;log èŠ‚ç‚¹ï¼Œå·²é€šçŸ¥å„ä¸ªå‰¯æœ¬æ‰§è¡Œçš„å…·ä½“æ“ä½œã€‚ä¹‹å‰ &#x2F;log ä¸‹é¢æœ€åä¸€ä¸ª ZNode æ˜¯ log-0000000002ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä¼šå†™å…¥ä¸€ä¸ª log-0000000003ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202500455-101160944.png" alt="img"></p>
<p><strong>ä»æ—¥å¿—å†…å®¹å¯ä»¥çœ‹å‡ºä¸Šè¿°çš„æ“ä½œç±»å‹ä¸º mutateï¼Œè€Œè¿™æ¬¡éœ€è¦å°† 201905_0_1_1 åˆ†åŒºä¿®æ”¹æˆ 201905_0_1_1_2ï¼Œä¿®æ”¹è§„åˆ™ï¼šâ€201905_0_1_1â€ + â€œ_â€ + mutation_idã€‚</strong></p>
<p><strong>4ï¼‰å„ä¸ªå‰¯æœ¬å®ä¾‹åˆ†åˆ«æ‹‰å– Log æ—¥å¿—</strong></p>
<p><strong>satori_replica å‰¯æœ¬å’Œ matsuri_replica å‰¯æœ¬åˆ†åˆ«ç›‘å¬ &#x2F;log&#x2F;log-0000000003 æ—¥å¿—çš„æ¨é€ï¼Œå®ƒä»¬ä¹Ÿä¼šåˆ†åˆ«æ‹‰å–æ—¥å¿—åˆ°æœ¬åœ°ï¼Œé€šæ¨é€åˆ°å„è‡ªçš„ &#x2F;queue ä»»åŠ¡é˜Ÿåˆ—ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Pulling 1 entries to queue: /log/log-0000000003 - /log/log-0000000003</span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰å„ä¸ªå‰¯æœ¬åˆ†åˆ«åœ¨æœ¬åœ°æ‰§è¡Œ MUTATION</strong></p>
<p><strong>satori_replica å‰¯æœ¬å’Œ matsuri_replica å‰¯æœ¬åŸºäºå„è‡ªçš„ &#x2F;queue é˜Ÿåˆ—å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Executing log entry to mutate part 201905_0_1_1 to 201905_0_1_1_2</span><br></pre></td></tr></table></figure>

<p><strong>å„ä¸ªå‰¯æœ¬å¼€å§‹åœ¨æœ¬åœ°æ‰§è¡Œ MUTATION æ“ä½œï¼š</strong></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">Cloning part <span class="number">201905</span>_0_1_1 <span class="selector-tag">to</span> tmp_clone_201905_0_1_1_2</span><br><span class="line">Renaming temporary part tmp_clone_201905_0_1_1_2 <span class="selector-tag">to</span> <span class="number">201905</span>_0_1_1_2</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤ï¼Œæ•´ä¸ª MUTATION æµç¨‹ç»“æŸã€‚</strong></p>
<p><strong>å¯ä»¥çœ‹åˆ°åœ¨ MUTATION çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼ŒZooKeeper åŒæ ·ä¸ä¼šè¿›è¡Œä»»ä½•å®è´¨æ€§çš„æ•°æ®ä¼ è¾“ï¼Œæ‰€æœ‰çš„ MUTATION æ“ä½œæœ€ç»ˆéƒ½æ˜¯ç”±å„ä¸ªå‰¯æœ¬åœ¨æœ¬åœ°å®Œæˆçš„ã€‚è€Œ MUTATION æ“ä½œæ˜¯ç»è¿‡ &#x2F;mutations èŠ‚ç‚¹å®ç°åˆ†å‘çš„ï¼Œæœ¬ç€è°æ‰§è¡Œè°è´Ÿè´£çš„åŸåˆ™ï¼Œå½“å‰æ˜¯ç”± matsuri_replica è´Ÿè´£äº†æ¶ˆæ¯çš„æ¨é€ï¼Œåœ¨ &#x2F;mutations ä¸‹é¢æ–°å»ºäº† &#x2F;mutations&#x2F;0000000000ã€‚ä½†æ— è®º MUTATION æ“ä½œç”±å“ªä¸ªå‰¯æœ¬è§¦å‘ï¼Œæœ€ç»ˆéƒ½ä¼šè½¬äº¤ç»™ä¸»å‰¯æœ¬ï¼Œå†ç”±ä¸»å‰¯æœ¬è´Ÿè´£æ¨é€åˆ° Log æ—¥å¿—ä¸­ï¼Œä»¥é€šçŸ¥å„ä¸ªå‰¯æœ¬æ‰§è¡Œæœ€ç»ˆçš„ MUTATION é€»è¾‘ï¼ŒåŒæ—¶ä¹Ÿç”±ä¸»å‰¯æœ¬å¯¹æ—¥å¿—æ¥æ”¶çš„æƒ…å†µè¿›è¡Œç›‘æ§ã€‚</strong></p>
<p><strong>æµç¨‹å›¾æ€»ç»“ï¼š</strong></p>
<p><strong>åŒæ ·å¯ä»¥ç”¨ä¸€å¼ æµç¨‹å›¾æ€»ç»“ä¸€ä¸‹ä¸Šé¢ 5 ä¸ªæ­¥éª¤ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202509508-862835317.png" alt="img"></p>
<h4 id="ALTER-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"><a href="#ALTER-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹" class="headerlink" title="ALTER çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"></a>ALTER çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹</h4><p><strong>å¯¹ ReplicatedMergeTree æ‰§è¡Œ ALTER æ“ä½œè¿›è¡Œå…ƒæ•°æ®ä¿®æ”¹çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ ALTER éƒ¨åˆ†çš„é€»è¾‘ï¼Œä¾‹å¦‚å¢åŠ ã€åˆ é™¤è¡¨å­—æ®µç­‰ç­‰ã€‚ä½†ä¸ä¹‹å‰çš„å‡ ä¸ªæµç¨‹ç›¸æ¯”ï¼ŒALTER çš„é€»è¾‘è¦æ˜¾å¾—ç®€å•å¾ˆå¤šï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹ä¸æ¶‰åŠ &#x2F;log æ—¥å¿—çš„åˆ†å‘ã€‚æ•´ä¸ªæµç¨‹æŒ‰ç…§æ—¶é—´ä»ä¸Šå¾€ä¸‹é¡ºåºè¿›è¡Œï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸º 3 ä¸ªæ­¥éª¤ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</strong></p>
<p><strong>1ï¼‰ä¿®æ”¹å…±äº«å…ƒæ•°æ®</strong></p>
<p><strong>åœ¨ matsuri_replica å‰¯æœ¬ä¸Šä¿®æ”¹ï¼Œå¢åŠ ä¸€ä¸ªå­—æ®µã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¢åŠ ä¸€ä¸ªå­—æ®µ productï¼Œè¡¨ç¤ºå•†å“çš„åå­—ï¼Œå¹¶ä¸”å°†è¯¥å­—æ®µæ’åœ¨ id åé¢</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> replicated_sales_1 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> product String AFTER id;</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œä¹‹åï¼Œmatsuri_replica å‰¯æœ¬ä¼šä¿®æ”¹ ZooKeeper å†…çš„å…±äº«å…ƒæ•°æ®èŠ‚ç‚¹ &#x2F;metadataã€&#x2F;columnsï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Updated shared metadata nodes in ZooKeeper. Waiting for replicas to apply changes.</span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®ä¿®æ”¹åï¼ŒèŠ‚ç‚¹çš„ç‰ˆæœ¬å·ä¹Ÿä¼šåŒæ—¶æå‡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Version of metadata nodes in ZooKeeper changed. Waiting for structure write lock.</span><br></pre></td></tr></table></figure>

<p><strong>ä¸æ­¤åŒæ—¶ï¼Œmatsuri_replica è¿˜ä¼šè´Ÿè´£ç›‘å¬æ‰€æœ‰å‰¯æœ¬çš„ä¿®æ”¹å®Œæˆæƒ…å†µï¼š</strong></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">Waiting for satori_replica <span class="selector-tag">to</span> apply changes</span><br><span class="line">Waiting for matsuri_replica <span class="selector-tag">to</span> apply changes</span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰ç›‘å¬å…±äº«å…ƒæ•°æ®å˜æ›´å¹¶å„è‡ªæ‰§è¡Œæœ¬åœ°ä¿®æ”¹</strong></p>
<p><strong>satori_replica å’Œ matsuri_replica å„è‡ªç›‘å¬å…±äº«å…ƒæ•°æ®çš„å˜æ›´ï¼Œä¹‹åå®ƒä»¬ä¼šåˆ†åˆ«å¯¹æœ¬åœ°çš„å…ƒæ•°æ®ç‰ˆæœ¬å·å’Œå…±äº«ç‰ˆæœ¬å·è¿›è¡Œå¯¹æ¯”ã€‚åœ¨å½“å‰è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå®ƒä»¬ä¼šå‘ç°æœ¬åœ°ç‰ˆæœ¬å·ä½äºå…±äº«ç‰ˆæœ¬å·ï¼Œäºæ˜¯å¼€å§‹åœ¨å„è‡ªæœ¬åœ°æ‰§è¡Œæ›´æ–°æ“ä½œï¼š</strong></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">Metadata changed in ZooKeeper. Applying changes locally.</span><br><span class="line">Applied changes <span class="selector-tag">to</span> the metadata of the <span class="selector-tag">table</span>.</span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰ç¡®è®¤æ‰€æœ‰å‰¯æœ¬å®Œæˆä¿®æ”¹</strong></p>
<p><strong>matsuri_replica ä¼šç¡®è®¤æ‰€æœ‰å‰¯æœ¬å‡å·²å®Œæˆä¿®æ”¹ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> finished</span><br><span class="line">Done processing query</span><br></pre></td></tr></table></figure>

<p><strong>è‡³æ­¤æ•´ä¸ª ALTER æµç¨‹ç»“æŸï¼Œå¯ä»¥çœ‹å‡ºè¯¥è¿‡ç¨‹ ZooKeeper åŒæ ·ä¸ä¼šæ¶‰åŠå®è´¨æ€§çš„æ•°æ®ä¼ è¾“ï¼Œæ‰€æœ‰çš„ ALTER å‡ä½¿ç”¨å„ä¸ªå‰¯æœ¬åœ¨æœ¬åœ°æ‰€å®Œæˆçš„ã€‚æœ¬ç€è°æ‰§è¡Œè°è´Ÿè´£çš„åŸåˆ™ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ç”± matsuri_replica è´Ÿè´£å¯¹å…±äº«å…ƒæ•°æ®è¿›è¡Œä¿®æ”¹ä»¥åŠå¯¹å„ä¸ªå‰¯æœ¬çš„ä¿®æ”¹è¿›åº¦è¿›è¡Œç›‘æ§ã€‚</strong></p>
<p><strong>å…·ä½“æ‰§è¡Œæ¡ˆä¾‹å¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨ matsuri_replica å‰¯æœ¬ä¸Šå¢åŠ ä¸€ä¸ª product å­—æ®µï¼Œç„¶ååœ¨ satori_replica å‰¯æœ¬ä¸ŠæŸ¥è¯¢åˆ°äº†æ–°å¢åŠ çš„å­—æ®µï¼Œè¯æ˜ç¡®å®è¿›è¡Œäº†åŒæ­¥ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202521412-94419283.png" alt="img"></p>
<p><strong>è‡³äº matsuri_replica å‰¯æœ¬æˆ‘ä»¬å°±ä¸ç”¨çœ‹äº†ï¼Œå®ƒé‡Œé¢è‚¯å®šä¹Ÿæ˜¯ä¼šå¤šå‡ºä¸€ä¸ª product å­—æ®µçš„ã€‚</strong></p>
<p><strong>æµç¨‹å›¾æ€»ç»“ï¼š</strong></p>
<p><strong>åŒæ ·å¯ä»¥ç”¨ä¸€å¼ æµç¨‹å›¾æ€»ç»“ä¸€ä¸‹ä¸Šé¢ 3 ä¸ªæ­¥éª¤ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202527956-802735965.png" alt="img"></p>
<h2 id="æ•°æ®åˆ†ç‰‡"><a href="#æ•°æ®åˆ†ç‰‡" class="headerlink" title="æ•°æ®åˆ†ç‰‡"></a>æ•°æ®åˆ†ç‰‡</h2><p><strong>é€šè¿‡å¼•å…¥æ•°æ®å‰¯æœ¬ï¼Œè™½ç„¶èƒ½å¤Ÿæœ‰æ•ˆé™ä½æ•°æ®ä¸¢å¤±çš„é£é™©ï¼ˆå¤šä»½å­˜å‚¨ï¼‰ï¼Œå¹¶æå‡æŸ¥è¯¢çš„æ€§èƒ½ï¼ˆåˆ†æ‘ŠæŸ¥è¯¢ã€è¯»å†™åˆ†ç¦»ï¼‰ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼Œé‚£å°±æ˜¯æ•°æ®è¡¨çš„å®¹é‡é—®é¢˜ã€‚å› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ¯ä¸ªå‰¯æœ¬è‡ªèº«ä»ç„¶ä¿å­˜äº†æ•°æ®è¡¨çš„å…¨é‡æ•°æ®ï¼Œæ‰€ä»¥åœ¨ä¸šåŠ¡é‡ååˆ†åºå¤§çš„åœºæ™¯ä¸­ï¼Œä¾é å‰¯æœ¬å¹¶ä¸èƒ½è§£å†³å•è¡¨çš„æ€§èƒ½ç“¶é¢ˆã€‚æƒ³è¦ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ç±»é—®é¢˜ï¼Œéœ€è¦å€ŸåŠ©å¦å¤–ä¸€ç§æ‰‹æ®µï¼Œå³è¿›ä¸€æ­¥å°†æ•°æ®æ°´å¹³åˆ‡åˆ†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å°†è¦ä»‹ç»çš„æ•°æ®åˆ†ç‰‡ã€‚</strong></p>
<p><strong>ClickHouse ä¸­çš„æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹éƒ½å¯ä»¥ç§°ä¸ºä¸€ä¸ª shardï¼ˆåˆ†ç‰‡ï¼‰ï¼Œä»ç†è®ºä¸Šæ¥è®²ï¼Œå‡è®¾æœ‰ N å¼ æ•°æ®è¡¨ Tï¼Œåˆ†å¸ƒåœ¨ N ä¸ª ClickHouse æœåŠ¡èŠ‚ç‚¹ï¼Œè€Œè¿™äº›æ•°æ®è¡¨ä¹‹å‰æ²¡æœ‰é‡å¤æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¯´æ•°æ®è¡¨ T æœ‰ N ä¸ªåˆ†ç‰‡ã€‚ä½†æ˜¯åœ¨å·¥ç¨‹å®è·µä¸­ï¼Œå¦‚æœåªæœ‰è¿™äº›åˆ†ç‰‡è¡¨ï¼Œé‚£ä¹ˆæ•´ä¸ª Sharding æ–¹æ¡ˆåŸºæœ¬æ˜¯ä¸å¯ç”¨çš„ã€‚å› ä¸ºå¯¹äºä¸€ä¸ªå®Œæ•´çš„æ–¹æ¡ˆæ¥è¯´ï¼Œè¿˜éœ€è¦è€ƒè™‘æ•°æ®åœ¨å†™å…¥æ—¶ï¼Œå¦‚ä½•è¢«å‡åŒ€åœ°å†™å…¥è‡³å„ä¸ª shardï¼›ä»¥åŠæ•°æ®åœ¨æŸ¥è¯¢æ—¶ï¼Œå¦‚ä½•è·¯ç”±åˆ°æ¯ä¸ª shardï¼Œå¹¶ç»„åˆå½¢æˆç»“æœé›†ã€‚æ‰€ä»¥ ClickHouse çš„æ•°æ®åˆ†ç‰‡éœ€è¦ç»“åˆ Distributed è¡¨å¼•æ“ä¸€åŒä½¿ç”¨ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202535125-1777878576.png" alt="img"></p>
<p><strong>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ Distributed è¡¨å¼•æ“ï¼ŒDistributed æ•°æ®è¡¨æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒåªæ˜¯ä½œä¸ºåˆ†å¸ƒå¼è¡¨çš„ä¸€å±‚é€æ˜ä»£ç†ï¼Œåœ¨é›†ç¾¤å†…éƒ¨è‡ªåŠ¨å¼€å±•æ•°æ®çš„å†™å…¥ã€åˆ†å‘ã€æŸ¥è¯¢ã€è·¯ç”±ç­‰å·¥ä½œã€‚</strong></p>
<h3 id="é›†ç¾¤çš„é…ç½®æ–¹å¼"><a href="#é›†ç¾¤çš„é…ç½®æ–¹å¼" class="headerlink" title="é›†ç¾¤çš„é…ç½®æ–¹å¼"></a>é›†ç¾¤çš„é…ç½®æ–¹å¼</h3><p><strong>åœ¨ ClickHouse ä¸­ï¼Œé›†ç¾¤é…ç½®ç”¨ shard ä»£è¡¨åˆ†ç‰‡ã€replica ä»£è¡¨å‰¯æœ¬ï¼Œé‚£ä¹ˆé€»è¾‘å±‚é¢ï¼Œè¡¨ç¤º 1 åˆ†ç‰‡ 0 å‰¯æœ¬è¯­ä¹‰çš„é…ç½®å°±æ˜¯ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è€Œè¡¨ç¤º 1 åˆ†ç‰‡ã€1 å‰¯æœ¬çš„è¯­ä¹‰åˆ™æ˜¯ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è€Œè¡¨ç¤º 1 åˆ†ç‰‡ã€2 å‰¯æœ¬çš„è¯­ä¹‰åˆ™æ˜¯ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è€Œè¡¨ç¤º 2 åˆ†ç‰‡ã€0 å‰¯æœ¬çš„è¯­ä¹‰åˆ™æ˜¯ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span><span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°è¿™ç§é…ç½®å†æ¬¡ä½“ç°äº†ï¼Œshard åªæ˜¯é€»è¾‘å±‚é¢çš„åˆ†ç»„ï¼Œæœ€ç»ˆçš„æ‰¿è½½éƒ½æ˜¯ç”±å‰¯æœ¬æ¥å®ç°ã€‚</strong></p>
<p><strong>ç›¸ä¿¡åˆ†ç‰‡å’Œå‰¯æœ¬çš„æ¦‚å¿µè¿˜æ˜¯å¾ˆå®¹æ˜“åŒºåˆ†çš„ï¼Œä½ å°±å¯ä»¥ç†è§£ä¸ºåˆ†ç‰‡æ˜¯æŠŠå¤šä¸ªå‰¯æœ¬è¿›è¡Œåˆ†ç»„ï¼Œæ¯ä¸€ç»„å°±æ˜¯ä¸€ä¸ªåˆ†ç‰‡ï¼Œä¸€ä¸ªåˆ†ç‰‡ä¸‹é¢å¯ä»¥æœ‰ä»»æ„ä¸ªå‰¯æœ¬ã€‚å› æ­¤è¿˜æ˜¯é‚£å¥è¯ï¼Œå‰¯æœ¬æ‰æ˜¯ç”¨æ¥å®é™…æ‰¿è½½æ•°æ®çš„ï¼Œè€Œåˆ†ç‰‡åªæ˜¯ä¸€ä¸ªèµ·åˆ°ä¸€ä¸ªé€»è¾‘ç»„ç»‡çš„ä½œç”¨ã€‚åŒä¸€åˆ†ç‰‡ä¸‹é¢çš„æ‰€æœ‰å‰¯æœ¬å­˜æ”¾çš„æ•°æ®ç›¸åŒï¼Œå®ç°é«˜å¯ç”¨ï¼Œä¸€ä¸ªå‰¯æœ¬æŒ‚äº†ï¼Œå…¶å®ƒå‰¯æœ¬é¡¶ä¸Šå»ï¼›ä¸åŒåˆ†ç‰‡ä¸‹çš„å‰¯æœ¬å­˜æ”¾çš„æ•°æ®ä¸åŒï¼Œä»è€Œå®ç°æ•°æ®çš„æ°´å¹³åˆ‡åˆ†ã€‚</strong></p>
<p><strong>ä¸‹é¢å°±æ¥æ­å»ºåˆ†ç‰‡é›†ç¾¤ï¼Œå¦‚æœæ˜¯å¤šåˆ†ç‰‡ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ config.xml ä¸­æ­å»ºé›†ç¾¤é…ç½®äº†ã€‚</strong></p>
<p><strong>è¿™é‡Œæˆ‘ä»¬æ­å»º 3 åˆ†ç‰‡ 0 å‰¯æœ¬ï¼Œé‚£ä¹ˆé…ç½®å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é›†ç¾¤çš„åç§°ï¼Œå…¨å±€å”¯ä¸€ï¼Œæ˜¯åç»­å¼•ç”¨é›†ç¾¤é…ç½®çš„å”¯ä¸€æ ‡è¯† --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶å†…å¯ä»¥å®šä¹‰ä»»æ„ç»„é›†ç¾¤ï¼Œæƒ³ç”¨å“ªä¸€ä¸ªç›´æ¥é€šè¿‡é›†ç¾¤çš„åç§°è¿›è¡Œå¼•ç”¨å³å¯ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ch_cluster_3shard_0replica</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">shard</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡ 1 --&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span> <span class="comment">&lt;!-- è¯¥åˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œç”± satori èŠ‚ç‚¹æ‰¿è½½ --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ³¨æ„ï¼šè¿™é‡Œçš„ host éœ€è¦å†™ä¸»æœºåï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ /etc/hosts ä¸­é…ç½®å…¶å®ƒèŠ‚ç‚¹çš„å…¬ç½‘ IP åˆ°ä¸»æœºåçš„æ˜ å°„ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>satori<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡ 2 --&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span> <span class="comment">&lt;!-- è¯¥åˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œç”± matsuri èŠ‚ç‚¹æ‰¿è½½ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>matsuri<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡ 3 --&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span> <span class="comment">&lt;!-- è¯¥åˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œç”± aqua èŠ‚ç‚¹æ‰¿è½½ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>aqua<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ch_cluster_3shard_0replica</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœåªæ˜¯ 1 åˆ†ç‰‡ï¼Œé‚£ä¹ˆåªéœ€è¦é…ç½® ZooKeeper å³å¯ï¼Œä½†å¦‚æœæ˜¯å¤šåˆ†ç‰‡ï¼Œé‚£ä¹ˆé™¤äº† ZooKeeper ä¹‹å¤–æˆ‘ä»¬è¿˜è¦é…ç½®é›†ç¾¤ã€‚è¿™é‡Œé¦–å…ˆè¦ä¸ºé›†ç¾¤èµ·ä¸€ä¸ªåå­—ï¼Œç„¶åè‡ªå®šä¹‰åˆ†ç‰‡ï¼Œå½“ç„¶æˆ‘ä»¬è¯´åˆ†ç‰‡åªæ˜¯é€»è¾‘å±‚é¢çš„åˆ†ç»„ï¼Œå‰¯æœ¬æ‰æ˜¯çœŸæ­£å­˜å‚¨æ•°æ®çš„ã€‚æ‰€ä»¥è¿˜éœ€è¦åœ¨ shard æ ‡ç­¾ä¸­å®šä¹‰ replica æ ‡ç­¾ï¼Œreplica æ ‡ç­¾ä¸­æŒ‡å®šç›¸åº”çš„ IP å’Œç«¯å£ï¼Œä»é…ç½®ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€ä¸ª shard å¯ä»¥æœ‰å¤šä¸ª replicaï¼Œå…·ä½“æœ‰å¤šå°‘ä¸ªåˆ™ç”±æˆ‘ä»¬è‡ªå·±å†³å®šï¼›æ­¤å¤–ä¹Ÿå¯ä»¥æœ‰å¤šä¸ª shardï¼Œæ¯ä¸ª shard å†…çš„ replica ä¹Ÿå¯ä»¥ä¸åŒã€‚æˆ‘ä»¬ä¸Šé¢ç›¸å½“äºåˆ›å»ºäº† 3 ä¸ª shardï¼Œæ¯ä¸ª shard éƒ½åªæœ‰ 1 ä¸ª replicaï¼Œåœ¨ ClickHouse ä¸­ä¹Ÿå°±æ˜¯ 3 åˆ†ç‰‡ 0 å‰¯æœ¬ã€‚</strong></p>
<p><strong>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè™½ç„¶æˆ‘ä»¬è¿™é‡Œåªæ˜¯æ¼”ç¤ºå¤šåˆ†ç‰‡ï¼Œä½†ä¸Šé¢çš„é…ç½®å¦‚æœçœŸè¦æ”¾åœ¨ç”Ÿäº§ä¸Šä¼šæœ‰ä»€ä¹ˆåæœå‘¢ï¼Ÿæ²¡é”™ï¼Œæ— æ³•è¾¾åˆ°é«˜å¯ç”¨ï¼Œå› ä¸ºæ¯ä¸ªåˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡å°±ä¸å¯ç”¨äº†ï¼Œæ‰€ä»¥æ¯ä¸ª shard åº”è¯¥é…ç½®å¤šä¸ª replicaã€‚è¿™é‡Œæˆ‘ä»¬ä¸ç®¡é‚£ä¹ˆå¤šï¼Œå…ˆçœ‹çœ‹å¦‚ä½•å®ç°å¤šåˆ†ç‰‡ã€‚</strong></p>
<p><strong>æˆ‘ä»¬å…³é—­ satoriã€matsuri èŠ‚ç‚¹ä¸Šçš„ ClickHouse æœåŠ¡ï¼Œç„¶åä¿®æ”¹å…¶ config.xml æ–‡ä»¶ï¼Œå°†ä¸Šé¢çš„é…ç½®æ‹·è´åˆ° remote_servers æ ‡ç­¾ä¸‹é¢å³å¯ã€‚æœ€åæ˜¯ aqua èŠ‚ç‚¹ï¼Œæˆ‘é˜¿é‡Œäº‘ä¸Šæœ‰ä¸‰ä¸ª CentOSï¼Œä¸»æœºååˆ†åˆ«æ˜¯ satoriã€matsuriã€aquaï¼Œç›®å‰ä½¿ç”¨äº†å‰ä¸¤ä¸ªã€‚è€Œ aqua èŠ‚ç‚¹ä¸Šè¿˜æ²¡æœ‰ ClickHouseï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå®‰è£…ï¼Œå®‰è£…ä¹‹åå°†é…ç½®æ‹·è´è¿‡å»ã€‚æ³¨æ„ï¼šé™¤äº†ä¸Šé¢çš„å…³äºé›†ç¾¤çš„é…ç½®ï¼Œè¿˜æœ‰ä¸‹é¢è¿™äº›é…ç½®ä¹Ÿåˆ«å¿˜è®°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å‰ä¸¤ä¸ªèŠ‚ç‚¹ä¸­æ‰€åšçš„é…ç½®ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½åº”ä¿æŒä¸€è‡´ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span>&gt;</span>47.94.174.89<span class="tag">&lt;/<span class="name">host</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å†…éƒ¨é€šä¿¡ IPï¼Œæ”¹æˆ aqua èŠ‚ç‚¹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_host</span>&gt;</span>47.93.235.147<span class="tag">&lt;/<span class="name">interserver_http_host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_port</span>&gt;</span>9009<span class="tag">&lt;/<span class="name">interserver_http_port</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æ‰€æœ‰é…ç½®éƒ½å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯åŠ¨ä¸‰å°èŠ‚ç‚¹ä¸Šçš„ ClickHouseï¼Œç„¶åéªŒè¯é›†ç¾¤æ˜¯å¦æ­å»ºæˆåŠŸã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202549652-1741741732.png" alt="img"></p>
<p><strong>æˆ‘ä»¬åœ¨ aqua èŠ‚ç‚¹ä¸Šè¿›è¡ŒæŸ¥è¯¢ï¼Œcluster åˆ—è¡¨ç¤ºé›†ç¾¤çš„åå­—ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© cluster ä¸º ch_cluster_3shard_0replica çš„è®°å½•ï¼›ç„¶å host_nameã€host_address è¡¨ç¤ºå½“å‰å‰¯æœ¬æ‰€åœ¨çš„èŠ‚ç‚¹çš„ä¸»æœºåã€IPï¼›replica_num è¡¨ç¤ºè¯¥å‰¯æœ¬å±äºå½“å‰æ‰€åœ¨åˆ†ç‰‡çš„ç¬¬å‡ ä¸ªå‰¯æœ¬ï¼Œå› ä¸ºæ¯ä¸ªåˆ†ç‰‡åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯ 1ï¼›shard_num è¡¨ç¤ºè¯¥å‰¯æœ¬æ‰€åœ¨çš„åˆ†ç‰‡æ˜¯ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œæ˜¾ç„¶ satori å‰¯æœ¬å¤„äºç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼Œmatsuri å‰¯æœ¬å¤„äºç¬¬äºŒä¸ªåˆ†ç‰‡ï¼Œaqua å¤„äºç¬¬ä¸‰ä¸ªåˆ†ç‰‡ã€‚</strong></p>
<h3 id="åŸºäºé›†ç¾¤å®ç°åˆ†å¸ƒå¼-DDL"><a href="#åŸºäºé›†ç¾¤å®ç°åˆ†å¸ƒå¼-DDL" class="headerlink" title="åŸºäºé›†ç¾¤å®ç°åˆ†å¸ƒå¼ DDL"></a>åŸºäºé›†ç¾¤å®ç°åˆ†å¸ƒå¼ DDL</h3><p><strong>æˆ‘ä»¬å‰é¢ä»‹ç»å‰¯æœ¬çš„æ—¶å€™ä¸ºäº†åˆ›å»ºå‰¯æœ¬è¡¨ï¼Œéœ€è¦åˆ†åˆ«ç™»å½•åˆ°æ¯ä¸ª ClickHouse èŠ‚ç‚¹ï¼Œåœ¨å®ƒä»¬æœ¬åœ°æ‰§è¡Œå„è‡ªçš„ CREATE è¯­å¥ï¼Œè¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒCREATEã€DROPã€RENAME ç­‰ DDL è¯­å¥ä¸æ”¯æŒåˆ†å¸ƒå¼æ‰§è¡Œã€‚è€Œåœ¨åŠ å…¥é›†ç¾¤é…ç½®ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨æ–°çš„è¯­æ³•å®ç°åˆ†å¸ƒå¼ DDL æ‰§è¡Œäº†ï¼Œè¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE/DROP/RENAME TABLE table_name ON CLUSTER cluster_name ...</span><br></pre></td></tr></table></figure>

<p><strong>ON CLUSTER ä½äº TABLE table_name ä¹‹åï¼Œè¡¨ç¤ºé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œè¯¥ DDL è¯­å¥ï¼Œè€Œ cluster_name å°±æ˜¯é›†ç¾¤çš„åç§°ï¼ŒClickHouse ä¼šé€šè¿‡ cluster_name æ‰¾åˆ°è¯¥é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œç„¶åé¡ºè—¤æ‘¸ç“œï¼Œåˆ†åˆ«å»å„ä¸ªèŠ‚ç‚¹ä¸­æ‰§è¡Œ DDL è¯­å¥ã€‚ä¸‹é¢å°±ç”¨åˆ†å¸ƒå¼ DLL çš„å½¢å¼å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_1 <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica(</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/&#123;shard&#125;/distributed_test_1&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<p><strong>è¯¥è¯­å¥å…ˆä¸è¦æ‰§è¡Œï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›ç»†èŠ‚è¦è¯´ï¼Œé¦–å…ˆå°±æ˜¯è¿™é‡Œ ENGINEï¼Œå¯ä»¥æŒ‡å®šå…¶å®ƒä»»æ„çš„è¡¨å¼•æ“ã€‚ç„¶åæ˜¯ ON CLUSTERï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œè¿™ä¸ªå»ºè¡¨è¯­å¥ï¼Œè€Œ ClickHouse åœ¨çœ‹åˆ° ON CLUSTER ä¹‹åå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ DDLï¼Œä¼šæ ¹æ® ch_cluster_3shard_0replica æ‰¾åˆ°ç›¸å…³çš„é›†ç¾¤é…ç½®ï¼Œç„¶ååœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šä¹Ÿæ‰§è¡Œè¿™ä¸ª DDLã€‚</strong></p>
<p><strong>æœ€åæ˜¯ ReplicatedMergeTreeï¼Œé¦–å…ˆå¦‚æœåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šå»ºè¡¨ï¼Œé‚£ä¹ˆ zk_path å’Œ replica_name æ˜¾ç„¶æ˜¯ä¸åŒçš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸å¯ä»¥å†™æ­»ã€‚å¦åˆ™ ClickHouse åœ¨å¹¿æ’­ DDL ç»™å…¶å®ƒèŠ‚ç‚¹æ‰§è¡Œä¹‹åï¼Œæ‰€æœ‰åˆ†ç‰‡ä¸‹çš„æ‰€æœ‰å‰¯æœ¬çš„ zk_path å’Œ replica_name å°±éƒ½æ˜¯ä¸€æ ·çš„äº†ã€‚å› æ­¤ ClickHouse æä¾›äº†ä¸¤ä¸ªåŠ¨æ€å®å˜é‡ {shard} å’Œ {replica}ï¼Œç”¨äºæ›¿æ¢ä¹‹å‰çš„ç¡¬ç¼–ç æ–¹å¼ï¼Œè€ŒåŠ¨æ€å®å˜é‡çš„å€¼å¯ä»¥é€šè¿‡ç³»ç»Ÿè¡¨ system.macros è¿›è¡ŒæŸ¥çœ‹ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202559072-210194613.png" alt="img"></p>
<p><strong>ä½†é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬çœ‹åˆ°æŸ¥è¯¢çš„ç»“æœæ˜¯ç©ºçš„ï¼ŒåŸå› æ˜¯æˆ‘ä»¬æ²¡æœ‰åœ¨ config.xml ä¸­æ²¡æœ‰è¿›è¡Œé…ç½®ã€‚åœ¨ config.xml ä¸‹é¢æœ‰ä¸€ä¸ª macros æ ‡ç­¾ï¼Œæ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸‹å°±è¡Œäº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202605588-37487189.png" alt="img"></p>
<p><strong>é…ç½®å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- satori èŠ‚ç‚¹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span>satori_name<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- matsuri èŠ‚ç‚¹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span>02<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span>matsuri_name<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- aqua èŠ‚ç‚¹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span>03<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span>aqua_name<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬å°†æ³¨é‡Šæ‰“å¼€ï¼Œåˆ†åˆ«è¿›è¡Œä¿®æ”¹ï¼Œæˆ–è€…ä¸æ‰“å¼€æ³¨é‡Šï¼Œç›´æ¥åœ¨ç²˜è´´åœ¨ yandex æ ‡ç­¾ä¸‹å³å¯ï¼Œç„¶åé‡å¯ä¸‰å°èŠ‚ç‚¹ä¸Šçš„ ClickHouse æœåŠ¡ã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬æŸ¥çœ‹å®å˜é‡æ˜¯å¦ç”Ÿæ•ˆï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202615424-137419479.png" alt="img"></p>
<p><strong>ç°åœ¨æˆ‘ä»¬å°±èƒ½æ‰§è¡Œä¸Šé¢é‚£æ¡åˆ†å¸ƒå¼å»ºè¡¨è¯­å¥äº†ï¼Œç„¶å shard_num å’Œ replica_name ä¼šç”¨ {shard} å’Œ {replica} ä¸¤ä¸ªå®å˜é‡è¿›è¡Œæ›¿ä»£ã€‚æˆ‘ä»¬ä¸‹é¢éšä¾¿æŒ‘ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±åœ¨ matsuri èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸Šé¢é‚£æ¡å»ºè¡¨è¯­å¥å§ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202622496-1056051619.png" alt="img"></p>
<p><strong>æ ¹æ®è¿”å›çš„å†…å®¹ï¼Œæˆ‘ä»¬çœ‹åˆ°è¡¨åœ¨ satoriã€matsuriã€aqua ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šå‡å·²æˆåŠŸåˆ›å»ºã€‚åŒç†ï¼Œå¦‚æœæƒ³åˆ é™¤çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥æ‰§è¡Œåˆ†å¸ƒå¼ DROPã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DROP TABLE distributed_test_1 ON CLUSTER ch_cluster_3shard_0replica</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡æ­å»ºé›†ç¾¤ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æ‰§è¡Œåˆ†å¸ƒå¼ DDLï¼Œè®°å¾—åœ¨ä¸Šé¢ä»‹ç» 1 åˆ†ç‰‡ã€å¤šå‰¯æœ¬çš„æ—¶å€™æˆ‘ä»¬è¯´è¿‡ï¼Œåªæœ‰ 1 ä¸ªåˆ†ç‰‡çš„è¯ï¼Œä¸éœ€è¦æ­å»ºé›†ç¾¤ï¼Œåªéœ€è¦å€ŸåŠ© ZooKeeper å³å¯ã€‚ä½†å¾ˆæ˜æ˜¾ï¼Œ1 åˆ†ç‰‡ã€å¤šå‰¯æœ¬è¿™ç§æ¨¡å¼åªæ˜¯ä¸éœ€è¦æ­å»ºï¼Œä½†ä¸æ˜¯è¯´ä¸èƒ½æ­å»ºï¼Œå¦‚æœæ­å»ºäº†é›†ç¾¤ï¼ˆ1 shardã€å¤š replicaï¼‰ï¼Œä¸€æ ·å¯ä»¥æ‰§è¡Œåˆ†å¸ƒå¼ DLLã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼Œå½“æˆ‘ä»¬åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œåˆ†å¸ƒå¼ DDLï¼Œè¯¥ DDL æ˜¯å¦‚ä½•è¢«å¹¿æ’­åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šçš„ã€‚</strong></p>
<h4 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><p><strong>å’Œ ReplicatedMergeTree ç±»ä¼¼ï¼Œåˆ†å¸ƒå¼ DDL è¯­å¥åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦å€ŸåŠ© ZooKeeper çš„ååŒèƒ½åŠ›ï¼Œä»¥å®ç°æ—¥å¿—åˆ†å‘ã€‚</strong></p>
<p><strong>1ï¼‰ZooKeeper å†…çš„èŠ‚ç‚¹ç»“æ„</strong></p>
<p><strong>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼ DDL åœ¨ ZooKeeper å†…ä½¿ç”¨çš„æ ¹è·¯å¾„ä¸ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/clickhouse/task_queue/ddl</span><br></pre></td></tr></table></figure>

<p><strong>è¯¥è·¯å¾„ç”± config.xml å†…çš„ distributed_ddl é…ç½®æŒ‡å®šï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202629918-1346559146.png" alt="img"></p>
<p><strong>åœ¨æ­¤æ ¹è·¯å¾„ä¸‹ï¼Œè¿˜æœ‰ä¸€äº›å…¶å®ƒçš„ç›‘å¬èŠ‚ç‚¹ï¼Œå…¶ä¸­åŒ…æ‹¬ DDL æ“ä½œæ—¥å¿— &#x2F;query-[seq]ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡åˆ†å¸ƒå¼ DDL æŸ¥è¯¢ï¼Œåœ¨è¯¥èŠ‚ç‚¹ä¸‹å°±ä¼šæ–°å¢ä¸€æ¡æ“ä½œæ—¥å¿—ï¼Œä»¥è®°å½•ç›¸åº”çš„æ“ä½œæŒ‡ä»¤ã€‚å½“å„ä¸ªèŠ‚ç‚¹ç›‘å¬åˆ°æœ‰æ–°æ—¥å¿—åŠ å…¥çš„æ—¶å€™ï¼Œä¾¿ä¼šå“åº”æ‰§è¡Œã€‚DDL æ“ä½œæ—¥å¿—ä½¿ç”¨ ZooKeeper çš„æŒä¹…é¡ºåºå‹èŠ‚ç‚¹ï¼Œæ¯æ¡æŒ‡ä»¤çš„åç§°ä»¥ query- ä¸ºå‰ç¼€ï¼Œåé¢çš„åºå·é€’å¢ï¼Œä¾‹å¦‚ query-0000000000ã€query-0000000001 ç­‰ç­‰ã€‚</strong></p>
<p><strong>å¦å¤–åœ¨æ¯æ¡ query-[seq] æ“ä½œæ—¥å¿—ä¹‹ä¸‹ï¼Œè¿˜æœ‰ä¸¤ä¸ªçŠ¶æ€èŠ‚ç‚¹ï¼š</strong></p>
<ul>
<li><code>1ï¼‰/query-[seq]/activeï¼šç”¨äºçŠ¶æ€ç›‘æ§ç­‰ç”¨é€”ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œè¯¥èŠ‚ç‚¹ä¸‹ä¼šä¸´æ—¶ä¿å­˜å½“å‰é›†ç¾¤å†…çŠ¶æ€ä¸º active çš„èŠ‚ç‚¹</code></li>
<li><code>2ï¼‰/query-[seq]/finishedï¼šç”¨äºæ£€æŸ¥ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼Œåœ¨ä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯å½“é›†ç¾¤å†…çš„æŸä¸ª host èŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¾¿ä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸‹å†™å…¥è®°å½•</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202644867-466036386.png" alt="img"></p>
<p><strong>ä¸Šè¿°è¯­å¥è¡¨ç¤ºé›†ç¾¤å†…çš„ satoriã€matsuriã€aqua ä¸‰ä¸ªèŠ‚ç‚¹å·²ç»å®Œæˆä»»åŠ¡ã€‚</strong></p>
<p><strong>2ï¼‰DDLLogEntry æ—¥å¿—å¯¹è±¡çš„æ•°æ®ç»“æ„</strong></p>
<p><strong>åœ¨ &#x2F;query-[seq] ä¸‹è®°å½•çš„æ—¥å¿—ä¿¡æ¯ç”± DDLLogEntry æ‰¿è½½ï¼Œå®ƒæ‹¥æœ‰å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202638591-1102781642.png" alt="img"></p>
<p><strong>query è®°å½•äº† DDL æŸ¥è¯¢çš„æ‰§è¡Œè¯­å¥ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> default.distributed_test_1</span><br><span class="line">UUID \<span class="string">&#x27;d5d4c459-4e89-47b2-95d4-c4594e8957b2\&#x27;</span></span><br><span class="line"><span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica</span><br><span class="line">(</span><br><span class="line">    `id` UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplicatedMergeTree(\<span class="string">&#x27;/clickhouse/tables/&#123;shard&#125;/distributed_test_1\&#x27;</span>, \<span class="string">&#x27;&#123;replica&#125;\&#x27;</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure>

<p><strong>hosts è®°å½•äº†æŒ‡å®šé›†ç¾¤çš„ hosts ä¸»æœºåˆ—è¡¨ï¼Œé›†ç¾¤ç”±åˆ†å¸ƒå¼ DDL è¯­å¥ä¸­çš„ ON CLUSTER æŒ‡å®šã€‚åœ¨åˆ†å¸ƒå¼ DDL çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ® hosts åˆ—è¡¨é€ä¸ªåˆ¤æ–­å®ƒä»¬çš„æ‰§è¡ŒçŠ¶æ€ã€‚</strong></p>
<p><strong>initiator è®°å½•åˆå§‹åŒ– host ä¸»æœºçš„åç§°ï¼Œè¯´ç™½å°±æ˜¯åˆ†å¸ƒå¼ DDL æœ€å¼€å§‹æ˜¯åœ¨å“ªä¸ªèŠ‚ç‚¹æ‰§è¡Œçš„</strong></p>
<h4 id="åˆ†å¸ƒå¼-DDL-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"><a href="#åˆ†å¸ƒå¼-DDL-çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹" class="headerlink" title="åˆ†å¸ƒå¼ DDL çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹"></a>åˆ†å¸ƒå¼ DDL çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹</h4><p><strong>ä¸å‰¯æœ¬ååŒçš„æ ¸å¿ƒæµç¨‹ç±»ä¼¼ï¼Œæ¥ä¸‹æ¥å°±ä»¥ä¸Šé¢åˆ›å»º distributed_test_1 ä¸ºä¾‹ï¼Œè§£é‡Šåˆ†å¸ƒå¼ DDL çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹ã€‚æ•´ä¸ªæµç¨‹ä»ä¸Šåˆ°ä¸‹æŒ‰ç…§æ—¶é—´é¡ºåºè¿›è¡Œï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</strong></p>
<p><strong>1ï¼‰æ¨é€ DDL æ—¥å¿—</strong></p>
<p><strong>é¦–å…ˆåœ¨ matsuri èŠ‚ç‚¹æ‰§è¡Œ CREATE TABEL ON CLUSTERï¼Œæœ¬ç€è°æ‰§è¡Œè°è´Ÿè´£çš„åŸåˆ™ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ä¹Ÿä¼šç”± matsuri èŠ‚ç‚¹è´Ÿè´£åˆ›å»º DDLLogEntry æ—¥å¿—å¹¶å°†æ—¥å¿—æ¨é€åˆ° ZooKeeperï¼ŒåŒæ—¶ä¹Ÿä¼šç”±è¿™ä¸ªèŠ‚ç‚¹è´Ÿè´£ç›‘æ§ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦ã€‚</strong></p>
<p><strong>2ï¼‰æ‹‰å–æ—¥å¿—å¹¶æ‰§è¡Œ</strong></p>
<p><strong>matsuriã€satoriã€aqua ä¸‰ä¸ªèŠ‚ç‚¹åˆ†åˆ«ç›‘å¬ &#x2F;ddl&#x2F;query-0000000000 æ—¥å¿—çš„æ¨é€ï¼Œäºæ˜¯å®ƒä»¬åˆ†åˆ«æ‹‰å–æ—¥å¿—åˆ°æœ¬åœ°ã€‚é¦–å…ˆå®ƒä»¬ä¼šåˆ¤æ–­å„è‡ªçš„ host æ˜¯å¦è¢«åŒ…å«åœ¨ DDLLogEntry çš„ hosts åˆ—è¡¨ä¸­ï¼Œå¦‚æœåŒ…å«åœ¨å†…ï¼Œåˆ™è¿›å…¥æ‰§è¡Œæµç¨‹ï¼Œæ‰§è¡Œå®Œæ¯•åå†™å…¥ finished èŠ‚ç‚¹ï¼›å¦‚æœä¸åŒ…å«ï¼Œåˆ™å¿½ç•¥è¿™æ¬¡æ—¥å¿—çš„æ¨é€ã€‚</strong></p>
<p><strong>3ï¼‰ç¡®è®¤æ‰§è¡Œè¿›åº¦</strong></p>
<p><strong>åœ¨æ­¥éª¤ 1 æ‰§è¡Œ DDL è¯­å¥ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šé˜»å¡ 180 ç§’ï¼ˆç”±å‚æ•° distributed_ddl_task_timeout æŒ‡å®šï¼‰ï¼Œä»¥æœŸæœ›æ‰€æœ‰ host éƒ½æ‰§è¡Œå®Œè¿™ä¸ªåˆ†å¸ƒå¼ DDLã€‚å¦‚æœé˜»å¡æ—¶é—´è¶…è¿‡äº† 180 ç§’ï¼Œåˆ™ä¼šè½¬å…¥åå°çº¿ç¨‹ç»§ç»­ç­‰å¾…ã€‚</strong></p>
<p><strong>æµç¨‹å›¾æ€»ç»“ï¼š</strong></p>
<p><strong>æˆ‘ä»¬è¿™é‡Œæœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯ä¸ºäº†ç”»å›¾æ–¹ä¾¿ï¼Œå›¾ä¸­åªç”»äº†ä¸¤ä¸ªã€‚å› ä¸º satori_replica å’Œ aqua_replica çš„è¡¨ç°æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ satori_replica å°±ä¸ç”»äº†ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202653371-389429149.png" alt="img"></p>
<h2 id="Distributed-åŸç†è§£æ"><a href="#Distributed-åŸç†è§£æ" class="headerlink" title="Distributed åŸç†è§£æ"></a>Distributed åŸç†è§£æ</h2><p><strong>Distributed è¡¨å¼•æ“æ˜¯åˆ†å¸ƒå¼è¡¨çš„ä»£åè¯ï¼Œå®ƒè‡ªèº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯ä½œä¸ºæ•°æ®åˆ†ç‰‡çš„é€æ˜ä»£ç†ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è·¯ç”±æ•°æ®è‡³é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥ Distributed è¡¨å¼•æ“éœ€è¦å’Œå…¶å®ƒæ•°æ®è¡¨å¼•æ“ä¸€èµ·ååŒå·¥ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202658656-770906243.png" alt="img"></p>
<p><strong>ä»å®ä½“è¡¨çš„å±‚é¢æ¥çœ‹ï¼Œä¸€å¼ åˆ†ç‰‡è¡¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</strong></p>
<ul>
<li><code>æœ¬åœ°è¡¨ï¼šé€šå¸¸ä»¥ _local ä¸ºåç¼€è¿›è¡Œå‘½åï¼Œæœ¬åœ°è¡¨æ˜¯æ‰¿æ¥æ•°æ®çš„è½½ä½“ï¼Œå¯ä»¥ä½¿ç”¨é Distributed çš„ä»»æ„è¡¨å¼•æ“ï¼Œä¸€å¼ æœ¬åœ°è¡¨å¯¹åº”äº†ä¸€ä¸ªæ•°æ®åˆ†ç‰‡</code></li>
<li><code>åˆ†å¸ƒå¼è¡¨ï¼šé€šå¸¸ä»¥ _all ä¸ºåç¼€è¿›è¡Œå‘½åï¼Œåˆ†å¸ƒå¼è¡¨åªèƒ½ä½¿ç”¨ Distributed è¡¨å¼•æ“ï¼Œå®ƒå’Œæœ¬åœ°è¡¨å½¢æˆä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³»ï¼Œåç»­å°†é€šè¿‡åˆ†å¸ƒå¼è¡¨ä»£ç†æ“ä½œå¤šå¼ æœ¬åœ°è¡¨</code></li>
</ul>
<blockquote>
<p><strong>æˆ‘ä»¬åˆšæ‰åœ¨å»ºè¡¨çš„æ—¶å€™ï¼Œå°†è¡¨èµ·åä¸º distributed_test_1 å®é™…ä¸Šæ˜¯ä¸ç¬¦åˆè§„èŒƒçš„ï¼Œåº”è¯¥ä»¥ _local ä¸ºåç¼€è¿›è¡Œå‘½åï¼Œä¸è¿‡æ— æ‰€è°“ï¼Œç†è§£å°±å¥½ã€‚</strong></p>
</blockquote>
<p><strong>å¯¹äºåˆ†å¸ƒå¼è¡¨ä¸æœ¬åœ°è¡¨ä¹‹é—´è¡¨ç»“æ„çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼ŒDistributed è¡¨å¼•æ“é‡‡ç”¨äº†è¯»æ—¶æ£€æŸ¥çš„æœºåˆ¶ï¼Œè¿™æ„å‘³ç€å¦‚æœå®ƒä»¬çš„è¡¨ç»“æ„ä¸å…¼å®¹ï¼Œåªæœ‰åœ¨æŸ¥è¯¢æ—¶æ‰ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè€Œåœ¨åˆ›å»ºè¡¨æ—¶å¹¶ä¸ä¼šè¿›è¡Œæ£€æŸ¥ã€‚å¦å¤–ä¸åŒ ClickHouse èŠ‚ç‚¹ä¸Šæœ¬åœ°è¡¨ä¹‹é—´å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¡¨å¼•æ“ï¼Œä½†æ˜¯é€šå¸¸ä¸å»ºè®®è¿™ä¹ˆåšï¼Œä¿æŒå®ƒä»¬çš„ç»“æ„ä¸€è‡´ï¼Œæœ‰åˆ©äºåæœŸçš„ç»´æŠ¤ã€å¹¶é¿å…é€ æˆä¸å¯é¢„è®¡çš„é”™è¯¯ã€‚</strong></p>
<h3 id="å®šä¹‰å½¢å¼"><a href="#å®šä¹‰å½¢å¼" class="headerlink" title="å®šä¹‰å½¢å¼"></a>å®šä¹‰å½¢å¼</h3><p><strong>Distributed è¡¨å¼•æ“çš„å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ENGINE = Distributed(cluster, database, table [, sharding_key])</span><br></pre></td></tr></table></figure>

<p><strong>é‡Œé¢çš„å‚æ•°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œcluster è¡¨ç¤ºé›†ç¾¤çš„åç§°ï¼Œä¹Ÿå°±æ˜¯åœ¨ config.xml ä¸­é…ç½®çš„é›†ç¾¤åç§°ï¼Œåœ¨åˆ†å¸ƒå¼è¡¨æ‰§è¡Œå†™å…¥å’ŒæŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä½¿ç”¨é›†ç¾¤çš„é…ç½®ä¿¡æ¯æ¥æ‰¾åˆ°ç›¸åº”çš„ host èŠ‚ç‚¹ï¼›database å’Œ table åˆ™è¡¨ç¤ºæ•°æ®åº“å’Œæ•°æ®è¡¨çš„åç§°ï¼Œåˆ†å¸ƒå¼è¡¨ä½¿ç”¨è¿™ç»„é…ç½®æ˜ å°„åˆ°æœ¬åœ°è¡¨ï¼›shard_key è¡¨ç¤ºåˆ†ç‰‡é”®ï¼Œåœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œåˆ†å¸ƒå¼è¡¨ä¼šä¾æ®åˆ†ç‰‡é”®çš„è§„åˆ™ï¼Œå°†æ•°æ®åˆ†å¸ƒåˆ°å„ä¸ª host èŠ‚ç‚¹çš„æœ¬åœ°è¡¨ã€‚</strong></p>
<p><strong>æˆ‘ä»¬ä¹‹å‰åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¸­åˆ›å»ºäº†æœ¬åœ°è¡¨ distributed_test_1ï¼Œä¸‹é¢å°±æ¥åˆ›å»ºä¸€å¼  Distributed è¡¨æ¥ä½œä¸ºå®ƒä»¬çš„ä»£ç†è¡¨ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_1_all <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica(</span><br><span class="line">    id UInt64</span><br><span class="line">)ENGINE <span class="operator">=</span> Distributed(ch_cluster_3shard_0replica, <span class="keyword">default</span>, distributed_test_1, rand());</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šé¢çš„å»ºè¡¨è¯­å¥ä¼šåˆ›å»ºä¸€å¼  Distributed è¡¨ï¼Œåä¸º distributed_test_1_allï¼Œç„¶åé€šè¿‡ ON CLUSTER ä¼šå°†è¯¥å»ºè¡¨è¯­å¥å¹¿æ’­åˆ°é›†ç¾¤çš„æ¯ä¸€ä¸ªåˆ†ç‰‡èŠ‚ç‚¹ä¸Šï¼Œç¡®ä¿å®ƒä»¬éƒ½ä¼šåˆ›å»ºä¸€å¼  Distributed è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å‘èµ·å¯¹æ‰€æœ‰åˆ†ç‰‡çš„è¯»ã€å†™è¯·æ±‚ã€‚å½“ç„¶åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºåˆ†å¸ƒå¼è¡¨ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯åç»­çš„æ“ä½œåªèƒ½åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿›è¡Œã€‚ç„¶åæ˜¯è¡¨å¼•æ“å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä»£ç†çš„æœ¬åœ°è¡¨ä¸º distributed_test_1ï¼Œå…¶åˆ†å¸ƒåœ¨é›†ç¾¤ ch_cluster_3shard_0replica çš„å„ä¸ª shard ä¸­ï¼Œå¹¶ä¸”åœ¨æ•°æ®å†™å…¥çš„æ—¶å€™ä¼šæ ¹æ® rand() éšæœºå‡½æ•°çš„å–å€¼å†³å®šæ•°æ®å†™å…¥å“ªä¸ªåˆ†ç‰‡ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202709609-197121402.png" alt="img"></p>
<p><strong>ä¸‹é¢åœ¨ matsuri èŠ‚ç‚¹æ‰§è¡Œä¸Šè¿° Distributed è¡¨ï¼ˆåˆ†å¸ƒå¼è¡¨ï¼‰çš„å»ºè¡¨è¯­å¥ï¼Œå½“ç„¶åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œéƒ½æ— æ‰€è°“çš„ï¼Œå› ä¸ºæ˜¯åˆ†å¸ƒå¼ DDLï¼Œæ¯ä¸ªåˆ†ç‰‡èŠ‚ç‚¹ä¸Šéƒ½ä¼šæ‰§è¡Œï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202715706-329859055.png" alt="img"></p>
<p><strong>è‡³æ­¤æœ¬åœ°è¡¨å’Œåˆ†å¸ƒå¼è¡¨å°±éƒ½åˆ›å»ºå¥½äº†ï¼Œè¿™é‡Œå†å¤šæä¸€å¥ï¼Œå³ä½¿æ²¡æœ‰æœ¬åœ°è¡¨ï¼Œä¹Ÿæ˜¯å¯ä»¥åˆ›å»ºåˆ†å¸ƒå¼è¡¨çš„ã€‚å› ä¸º Distributed è¡¨è¿ç”¨çš„æ˜¯è¯»æ—¶æ£€æŸ¥çš„æœºåˆ¶ï¼Œæ‰€ä»¥å¯¹äºåˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨çš„åˆ›å»ºé¡ºåºæ²¡æœ‰è¦æ±‚ã€‚</strong></p>
<h3 id="æŸ¥è¯¢ç§ç±»"><a href="#æŸ¥è¯¢ç§ç±»" class="headerlink" title="æŸ¥è¯¢ç§ç±»"></a>æŸ¥è¯¢ç§ç±»</h3><p><strong>Distributed è¡¨çš„æŸ¥è¯¢æ“ä½œå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼š</strong></p>
<p><strong>1ï¼‰ä¼šä½œç”¨äºæœ¬åœ°è¡¨çš„æŸ¥è¯¢ï¼šå¯¹äº INSERT å’Œ SELECT æŸ¥è¯¢ï¼ŒDistributed è¡¨å°†ä¼šä»¥åˆ†å¸ƒå¼çš„æ–¹å¼ä½œç”¨äº local æœ¬åœ°è¡¨ï¼Œè€Œå¯¹äºè¿™äº›æŸ¥è¯¢çš„å…·ä½“è§„åˆ™ï¼Œä¸€ä¼šä»‹ç»ã€‚</strong></p>
<p><strong>2ï¼‰åªä¼šå½±å“ Distributed è¡¨æœ¬èº«ï¼Œä¸ä¼šä½œç”¨äºæœ¬åœ°è¡¨çš„æŸ¥è¯¢ï¼šDistributed è¡¨æ”¯æŒéƒ¨åˆ†å…ƒæ•°æ®çš„æ“ä½œï¼ŒåŒ…æ‹¬ CREATEã€DROPã€RENAME å’Œ ALTERï¼Œå…¶ä¸­ ALTER å¹¶ä¸åŒ…æ‹¬åˆ†åŒºçš„æ“ä½œï¼ˆATTACH PARTITIONã€REPLACE PARTITION ç­‰ï¼‰ã€‚è¿™äº›æŸ¥è¯¢åªä¼šä¿®æ”¹ Distributed è¡¨è‡ªèº«ï¼Œå¹¶ä¸ä¼šä¿®æ”¹ local æœ¬åœ°è¡¨ï¼Œæ‰€ä»¥å¦‚æœæƒ³å°†åˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨éƒ½åˆ æ‰çš„è¯ï¼Œé‚£ä¹ˆè¦åˆ†åˆ«åˆ é™¤ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ é™¤åˆ†å¸ƒå¼è¡¨</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> distributed_test_1_all <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤æœ¬åœ°è¡¨</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> distributed_test_1 <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica;</span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰ä¸æ”¯æŒçš„æŸ¥è¯¢ï¼šDistributed è¡¨ä¸æ”¯æŒä»»ä½• MUTATION ç±»å‹çš„æ“ä½œï¼ŒåŒ…æ‹¬ ALTER DELETE å’Œ ALTER UPDATEã€‚</strong></p>
<h3 id="åˆ†ç‰‡è§„åˆ™"><a href="#åˆ†ç‰‡è§„åˆ™" class="headerlink" title="åˆ†ç‰‡è§„åˆ™"></a>åˆ†ç‰‡è§„åˆ™</h3><p><strong>è¿™é‡Œå†è¿›ä¸€æ­¥è¯´æ˜ä¸€ä¸‹åˆ†ç‰‡çš„è§„åˆ™ï¼Œæˆ‘ä»¬åœ¨åˆ›å»º Distributed è¡¨çš„æ—¶å€™ï¼Œè¡¨å¼•æ“ä¸­æŒ‡å®šäº† sharding_keyï¼Œä¹Ÿå°±æ˜¯åˆ†ç‰‡é”®ã€‚è€Œåˆ†ç‰‡é”®æ˜¯ç”±è¦æ±‚çš„ï¼Œå®ƒå¿…é¡»è¿”å›ä¸€ä¸ªæ•´å‹ç±»å‹çš„å–å€¼ï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŒ‰ç…§ç”¨æˆ· id çš„ä½™æ•°åˆ’åˆ†ï¼Œuserid æ˜¯æ•´å‹</span></span><br><span class="line">ENGINE <span class="operator">=</span> Distributed(cluster, database, <span class="keyword">table</span>, userid)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿”å›æ•´æ•°çš„è¡¨è¾¾å¼ï¼Œæ¯”å¦‚æŒ‰ç…§éšæœºæ•°åˆ’åˆ†</span></span><br><span class="line">ENGINE <span class="operator">=</span> Distributed(cluster, database, <span class="keyword">table</span>, rand())</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŒ‰ç…§ç”¨æˆ· id çš„æ•£åˆ—å€¼åˆ’åˆ†</span></span><br><span class="line">ENGINE <span class="operator">=</span> Distributed(cluster, database, <span class="keyword">table</span>, intHash64(userid))</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä¸å£°æ˜åˆ†ç‰‡é”®ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼è¡¨åªèƒ½åŒ…å«ä¸€ä¸ªåˆ†ç‰‡ï¼Œè¿™æ„å‘³ç€åªèƒ½æ˜ å°„ä¸€å¼ æœ¬åœ°è¡¨ï¼Œå¦åˆ™åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä½†å¦‚æœä¸€å¼ åˆ†å¸ƒå¼è¡¨åªèƒ½åŒ…å«ä¸€ä¸ªåˆ†ç‰‡ï¼Œé‚£è¿˜ä¸å¦‚å•æœºï¼Œæ˜¾ç„¶æ­¤æ—¶å°±æ²¡æ„ä¹‰äº†ã€‚å› æ­¤ï¼Œè™½ç„¶ sharding_key æ˜¯é€‰å¡«å‚æ•°ï¼Œä½†æ˜¯é€šå¸¸éƒ½ä¼šæŒ‰ç…§ä¸šåŠ¡è§„åˆ™è¿›è¡Œè®¾ç½®ã€‚</strong></p>
<p><strong>é‚£ä¹ˆè®¾ç½®å®Œåˆ†ç‰‡é”®ä¹‹åï¼Œæ•°æ®åˆæ˜¯å¦‚ä½•è¢«åˆ’åˆ†çš„å‘¢ï¼Ÿæƒ³è¦ææ¸…æ¥šè¿™ä¸€ç‚¹ï¼Œéœ€è¦å…ˆæ˜ç¡®å‡ ä¸ªæ¦‚å¿µã€‚</strong></p>
<h4 id="1-åˆ†ç‰‡æƒé‡"><a href="#1-åˆ†ç‰‡æƒé‡" class="headerlink" title="1.åˆ†ç‰‡æƒé‡"></a>1.åˆ†ç‰‡æƒé‡</h4><p><strong>åœ¨é›†ç¾¤çš„é…ç½®ä¸­ï¼Œæœ‰ä¸€é¡¹ weightï¼ˆåˆ†ç‰‡æƒé‡ï¼‰çš„è®¾ç½®ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é›†ç¾¤çš„åç§° --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ch_cluster_3shard_0replica</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">shard</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡ 1 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">weight</span>&gt;</span>10<span class="tag">&lt;/<span class="name">weight</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡æƒé‡ --&gt;</span></span><br><span class="line">        ......</span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡ 2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">weight</span>&gt;</span>20<span class="tag">&lt;/<span class="name">weight</span>&gt;</span> <span class="comment">&lt;!-- åˆ†ç‰‡æƒé‡ --&gt;</span></span><br><span class="line">        ......</span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>shard é‡Œé¢ä¸ä»…ä»…å¯ä»¥æŒ‡å®š replicaï¼Œè¿˜å¯ä»¥æŒ‡å®šå…¶å®ƒå±æ€§ï¼Œæ¯”å¦‚ weightï¼ˆæƒé‡ï¼‰ã€‚weight é»˜è®¤ä¸º 1ï¼Œè™½ç„¶å®ƒå¯ä»¥è®¾ç½®æˆä»»æ„æ•´æ•°ï¼Œä½†å®˜æ–¹å»ºè®®åº”è¯¥å°½å¯èƒ½è®¾ç½®æˆè¾ƒå°çš„å€¼ï¼Œåˆ†ç‰‡æƒé‡ä¼šå½±å“æ•°æ®åœ¨åˆ†ç‰‡ä¸­çš„å€¾æ–œç¨‹åº¦ï¼Œä¸€ä¸ªåˆ†ç‰‡çš„æƒé‡å€¼è¶Šå¤§ï¼Œé‚£ä¹ˆå®ƒè¢«å†™å…¥çš„æ•°æ®å°±è¶Šå¤šã€‚</strong></p>
<h4 id="slotï¼ˆæ§½ï¼‰"><a href="#slotï¼ˆæ§½ï¼‰" class="headerlink" title="slotï¼ˆæ§½ï¼‰"></a>slotï¼ˆæ§½ï¼‰</h4><p><strong>å¦‚æœæŠŠæ•°æ®æ¯”ä½œæ˜¯æ°´çš„è¯ï¼Œé‚£ä¹ˆ slot å°±å¯ä»¥ç†è§£ä¸ºè®¸å¤šçš„å°æ°´æ§½ï¼Œæ•°æ®ä¼šé¡ºç€è¿™äº›æ°´æ§½æµè¿›æ¯ä¸ªæ•°æ®åˆ†ç‰‡ã€‚slot çš„æ•°é‡ç­‰äºæ‰€æœ‰åˆ†ç‰‡çš„æƒé‡ä¹‹å’Œï¼Œå‡è®¾æ¯ä¸ªé›†ç¾¤æœ‰ä¸¤ä¸ª shardï¼Œç¬¬ä¸€ä¸ª shard çš„ weight ä¸º 10ï¼Œç¬¬äºŒä¸ª shard çš„ weight ä¸º 20ï¼Œé‚£ä¹ˆ slot çš„æ•°é‡åˆ™ç­‰äº 30ã€‚slot æŒ‰ç…§æƒé‡å…ƒç´ çš„å–å€¼åŒºé—´ï¼Œä¸å¯¹åº”çš„åˆ†ç‰‡å½¢æˆæ˜ å°„å…³ç³»ï¼Œå¦‚æœ slot å€¼è½åœ¨ [0, 10) åŒºé—´ï¼Œåˆ™å¯¹åº”ç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼›å¦‚æœ slot å€¼è½åœ¨ [10, 30) åŒºé—´ï¼Œåˆ™å¯¹åº”ç¬¬äºŒä¸ªåˆ†ç‰‡ã€‚è¿˜æ˜¯æ¯”è¾ƒç®€å•ç²—æš´å¥½ç†è§£çš„ï¼Œå› æ­¤ weight å€¼è¶Šå¤§ï¼Œé‚£ä¹ˆåŒºé—´èŒƒå›´ä¹Ÿå°±è¶Šå¹¿ï¼Œslot å€¼è½åœ¨è¯¥åŒºé—´çš„æ¦‚ç‡ä¹Ÿå°±è¶Šå¤§ã€‚</strong></p>
<h4 id="é€‰æ‹©å‡½æ•°"><a href="#é€‰æ‹©å‡½æ•°" class="headerlink" title="é€‰æ‹©å‡½æ•°"></a>é€‰æ‹©å‡½æ•°</h4><p><strong>é€‰æ‹©å‡½æ•°ç”¨äºåˆ¤æ–­ä¸€è¡Œå¾…å†™å…¥çš„æ•°æ®åº”è¯¥è¢«å†™å…¥å“ªä¸ªåˆ†ç‰‡ï¼Œæ•´ä¸ªåˆ¤æ–­è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š</strong></p>
<p><strong>1ï¼‰å®ƒä¼šæ‰¾å‡º slot çš„å–å€¼ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">slot = shard_value % sum_weight</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­ï¼Œshard_value æ˜¯åˆ†ç‰‡é”®çš„å–å€¼ï¼Œsum_weight æ˜¯æ‰€æœ‰åˆ†ç‰‡çš„æƒé‡ä¹‹å’Œï¼Œslot ç­‰äº shard_value å¯¹ sum_weight å–ä½™ã€‚å‡è®¾æŸä¸€è¡Œçš„æ•°æ®çš„ shard_value æ˜¯ 10ï¼Œsum_weight æ˜¯ 30ï¼ˆä¸¤åˆ†ç‰‡ï¼Œç¬¬ä¸€ä¸ªåˆ†ç‰‡æƒé‡ä¸º 10ï¼Œç¬¬äºŒä¸ªåˆ†ç‰‡æƒé‡ä¸º 20ï¼‰ï¼Œé‚£ä¹ˆ slot å€¼å°±ç­‰äº 10ï¼ˆ10 % 30ï¼‰ï¼›å†æ¯”å¦‚ shard_value å¦‚æœä¸º 90ï¼Œé‚£ä¹ˆ slot å€¼å°±ä¸º 0ï¼ˆ90 % 30ï¼‰ã€‚</strong></p>
<p><strong>2ï¼‰åŸºäº slot å€¼æ‰¾åˆ°å¯¹åº”çš„æ•°æ®åˆ†ç‰‡ï¼Œå½“ slot å€¼ç­‰äº 10 çš„æ—¶å€™ï¼Œå®ƒå±äº [10, 30) åŒºé—´ï¼Œæ­¤æ—¶è¿™è¡Œæ•°æ®ä¼šå¯¹åº”åˆ°ç¬¬äºŒä¸ª shardï¼›å½“ slot å€¼ä¸º 0 çš„æ—¶å€™ï¼Œå®ƒå±äº [0, 10) åŒºé—´ï¼Œæ‰€ä»¥è¿™è¡Œæ•°æ®ä¼šå¯¹åº”åˆ°ç¬¬ä¸€ä¸ªåˆ†ç‰‡ã€‚</strong></p>
<h3 id="åˆ†å¸ƒå¼å†™å…¥çš„æ ¸å¿ƒæµç¨‹"><a href="#åˆ†å¸ƒå¼å†™å…¥çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="åˆ†å¸ƒå¼å†™å…¥çš„æ ¸å¿ƒæµç¨‹"></a>åˆ†å¸ƒå¼å†™å…¥çš„æ ¸å¿ƒæµç¨‹</h3><p><strong>åœ¨å‘é›†ç¾¤å†…çš„åˆ†ç‰‡å†™å…¥æ•°æ®æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ€è·¯ï¼šä¸€ç§æ˜¯å€ŸåŠ©å¤–éƒ¨è®¡ç®—ç³»ç»Ÿï¼Œäº‹å…ˆæ ¹æ®åˆ†ç‰‡æ•°é‡å°†æ•°æ®è®¡ç®—å‡åŒ€ï¼Œå†å€Ÿç”±è®¡ç®—ç³»ç»Ÿç›´æ¥å°†æ•°æ®å†™å…¥ ClickHouse é›†ç¾¤çš„å„ä¸ªæœ¬åœ°è¡¨ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202729066-2120076310.png" alt="img"></p>
<p><strong>ä¸Šè¿°è¿™ç§æ–¹æ¡ˆé€šå¸¸æ‹¥æœ‰æ›´å¥½çš„å†™å…¥æ€§èƒ½ï¼Œå› ä¸ºåˆ†ç‰‡æ•°æ®æ˜¯è¢«å¹¶è¡Œç‚¹å¯¹ç‚¹å†™å…¥çš„ã€‚ä½†è¿™ç§æ–¹æ¡ˆé‡åº¦ä¾èµ–äºå¤–éƒ¨ç³»ç»Ÿï¼Œè€Œä¸åœ¨ ClickHouse è‡ªèº«ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦ä¼šä»‹ç»ç¬¬äºŒç§æ€è·¯ã€‚</strong></p>
<p><strong>ç¬¬äºŒç§æ€è·¯æ˜¯é€šè¿‡ Distributed è¡¨å¼•æ“ä»£ç†å†™å…¥åˆ†ç‰‡æ•°æ®ï¼Œä¸‹é¢å°±æ¥ä»‹ç»æ•´ä¸ªæµç¨‹ã€‚é¦–å…ˆå…³äºæµç¨‹æˆ‘ä»¬å¤§è‡´ä¹Ÿèƒ½çŒœåˆ°ï¼Œå°±æ˜¯ Distributed è¡¨å°†æ•°æ®å†™å…¥åˆ°æ¯ä¸ªåˆ†ç‰‡çš„ä¸€ä¸ªå‰¯æœ¬ä¸­ï¼Œç„¶åè·å¾—æ•°æ®çš„å‰¯æœ¬å†å°†æ•°æ®åŒæ­¥åˆ°è‡ªå·±æ‰€åœ¨åˆ†ç‰‡çš„å…¶å®ƒå‰¯æœ¬ä¸­ã€‚å› æ­¤æ ¸å¿ƒå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ â€œåˆ†ç‰‡å†™å…¥â€ å’Œ â€œå‰¯æœ¬å¤åˆ¶ï¼ˆåŒæ­¥ï¼‰â€ï¼Œç”±äºæˆ‘ä»¬ç›®å‰æ­å»ºçš„æ˜¯ 3 åˆ†ç‰‡ 0 å‰¯æœ¬ï¼Œæ‰€ä»¥å…ˆä»‹ç» â€œåˆ†ç‰‡å†™å…¥â€ï¼›åç»­å†é€šè¿‡ 1 åˆ†ç‰‡ 2 å‰¯æœ¬æ¥ä»‹ç» â€œå‰¯æœ¬å¤åˆ¶â€ï¼Œç”±äºåªæœ‰ä¸‰å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥æ— æ³•ç»™ 3 ä¸ªåˆ†ç‰‡éƒ½é…ç½®å‰¯æœ¬ï¼Œå› ä¸ºè¿™æ ·è‡³å°‘éœ€è¦ 6 å°æœåŠ¡å™¨ï¼Œäºæ˜¯åœ¨ä»‹ç»å‰¯æœ¬å¤åˆ¶çš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨ 1 åˆ†ç‰‡ã€‚å½“ç„¶å‰¯æœ¬å¤åˆ¶å’Œåˆ†ç‰‡æ•°é‡æ— å…³ï¼Œå› ä¸ºæ¯ä¸ªåˆ†ç‰‡ä¹‹é—´çš„å‰¯æœ¬å¤åˆ¶æ‰€åšçš„äº‹æƒ…éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€åœ¨åœ¨ä»‹ç»å‰¯æœ¬å¤åˆ¶çš„æ—¶å€™ï¼Œ1 åˆ†ç‰‡ å’Œ å¤šåˆ†ç‰‡ä¹‹é—´æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ä¸‹é¢å…ˆæ¥çœ‹çœ‹åˆ†ç‰‡å†™å…¥çš„æ•´ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å§ã€‚</strong></p>
<h4 id="å°†æ•°æ®å†™å…¥åˆ†ç‰‡çš„æ ¸å¿ƒæµç¨‹"><a href="#å°†æ•°æ®å†™å…¥åˆ†ç‰‡çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="å°†æ•°æ®å†™å…¥åˆ†ç‰‡çš„æ ¸å¿ƒæµç¨‹"></a>å°†æ•°æ®å†™å…¥åˆ†ç‰‡çš„æ ¸å¿ƒæµç¨‹</h4><p><strong>å¯¹ Distributed è¡¨æ‰§è¡Œ INSERT æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šè¿›å…¥æ•°æ®å†™å…¥åˆ†ç‰‡çš„æ‰§è¡Œé€»è¾‘ï¼Œæˆ‘ä»¬æŒ‰ç…§æ—¶é—´é¡ºåºä»ä¸Šå¾€ä¸‹ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»ã€‚</strong></p>
<p><strong>1ï¼‰åœ¨ç¬¬ä¸€ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å†™å…¥æœ¬åœ°åˆ†ç‰‡æ•°æ®</strong></p>
<p><strong>é¦–å…ˆåœ¨ aqua èŠ‚ç‚¹ï¼Œå¯¹åˆ†å¸ƒå¼è¡¨ distributed_test_1_all æ‰§è¡Œ INSERT æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> distributed_test_1_all </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">10</span>), (<span class="number">30</span>), (<span class="number">50</span>), (<span class="number">200</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œä¹‹ååˆ†å¸ƒå¼è¡¨ä¼šåšä¸¤ä»¶äº‹æƒ…ï¼šç¬¬ä¸€ï¼Œæ ¹æ®åˆ†ç‰‡è§„åˆ™åˆ’åˆ†æ•°æ®ï¼Œä¸è¿‡ç”±äºåˆ†ç‰‡é”®æ˜¯éšæœºå‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸çŸ¥é“æ•°æ®ä¼šå¦‚ä½•åˆ’åˆ†ï¼›ç¬¬äºŒï¼Œå°†æ•°æ®å½“å‰åˆ†ç‰‡çš„æ•°æ®ç›´æ¥å†™å…¥æœ¬åœ°è¡¨ distributed_test_1ã€‚</strong></p>
<blockquote>
<p><strong>å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰åˆ†å¸ƒå¼è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œéƒ½æ˜¯å¯ä»¥çš„ã€‚æ³¨æ„ï¼šæ­¤æ—¶ä¸éœ€è¦åŠ  ON CLUSTERï¼Œæˆ‘ä»¬åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯ï¼Œå¦‚æœåŠ ä¸Š ON CLUSTERï¼Œé‚£ä¹ˆæ¯ä¸ªèŠ‚ç‚¹å°±éƒ½ä¼šæ‰§è¡Œä¸€éï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´æ•°æ®çš„é‡å¤å†™å…¥ã€‚</strong></p>
</blockquote>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202737473-492002322.png" alt="img"></p>
<p><strong>å¯¹äºå½“å‰çš„æ —å­æ¥è¯´ï¼Œ50 ã€10 å’Œ 100 ã€30 åˆ†åˆ«åˆ’åˆ†åˆ°äº†ä¸åŒçš„åˆ†ç‰‡ä¸­ï¼Œæ³¨æ„ï¼šå›¾ä¸­æ‰“å°çš„é¡ºåºä¸ä»£è¡¨åˆ†ç‰‡çš„é¡ºåºï¼Œæ‰€ä»¥å®ƒä»¬åˆ†åˆ«åˆ’åˆ†åˆ°äº†å“ªä¸€ä¸ªåˆ†ç‰‡ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä¸çŸ¥é“çš„ã€‚</strong></p>
<p><strong>2ï¼‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å»ºç«‹è¿œç«¯è¿æ¥ï¼Œå‡†å¤‡å‘é€æ•°æ®</strong></p>
<p><strong>å°†å‘é€ç»™è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹çš„æ•°æ®ä»¥åˆ†åŒºä¸ºå•ä½ï¼ˆæˆ‘ä»¬åˆ›å»ºæœ¬åœ°è¡¨æ—¶æ²¡æœ‰æŒ‡å®š PARTITION BYï¼Œæ‰€ä»¥å½“å‰åªæœ‰ä¸€ä¸ªåˆ†åŒºï¼‰ï¼Œåˆ†åˆ«å†™å…¥ distributed_test_1_all å­˜å‚¨ç›®å½•ä¸‹çš„ä¸´æ—¶ bin æ–‡ä»¶ï¼Œè¯¥æ•°æ®æ–‡ä»¶çš„å‘½åè§„åˆ™å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;database&#125;@&#123;host_name&#125;:&#123;port&#125;/&#123;increase_num&#125;.bin</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æ˜¯åœ¨ aqua èŠ‚ç‚¹ä¸­å†™å…¥çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¹äº aqua èŠ‚ç‚¹æ¥è¯´ï¼Œå®ƒæœ‰ä¸¤ä¸ªè¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹ï¼šsatoriã€matsuriï¼Œå› æ­¤ä¸´æ—¶æ•°æ®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">distributed_test_1_all/<span class="keyword">default</span><span class="meta">@satori</span>/<span class="number">1.</span>bin</span><br><span class="line">distributed_test_1_all/<span class="keyword">default</span><span class="meta">@matsuri</span>/<span class="number">1.</span>bin</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åå’Œè¿œç«¯çš„ satori åˆ†ç‰‡èŠ‚ç‚¹ã€matsuri åˆ†ç‰‡èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼š</strong></p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">Connection</span> (<span class="attribute">satori</span>:<span class="number">9000</span>): <span class="selector-tag">Connetced</span> <span class="selector-tag">to</span> <span class="selector-tag">ClickHouse</span> <span class="selector-tag">server</span></span><br><span class="line"><span class="selector-tag">Connection</span> (<span class="attribute">matsuri</span>:<span class="number">9000</span>): <span class="selector-tag">Connetced</span> <span class="selector-tag">to</span> <span class="selector-tag">ClickHouse</span> <span class="selector-tag">server</span></span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å‘è¿œç«¯å‘é€æ•°æ®</strong></p>
<p><strong>æ­¤æ—¶ä¼šæœ‰å¦ä¸€ç§ç›‘å¬ä»»åŠ¡è´Ÿè´£ç›‘å¬ &#x2F;distributed_test_1_all ç›®å½•ä¸‹çš„æ–‡ä»¶å˜åŒ–ï¼Œè¿™äº›ä»»åŠ¡è´Ÿè´£å°†ç›®å½•æ•°æ®å‘é€è‡³è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">distributed_test_1_all.Distributed.DirectoryMonitor:</span><br><span class="line">Started processing /distributed_test_1_all/default@satori/1.bin</span><br><span class="line">Started processing /distributed_test_1_all/default@matsuri/1.bin</span><br></pre></td></tr></table></figure>

<p><strong>å…¶ä¸­æ¯ä¸ªç›®å½•å°†ä¼šç”±ç‹¬ç«‹çš„çº¿ç¨‹è´Ÿè´£å‘é€ï¼Œæ•°æ®åœ¨ä¼ è¾“ä¹‹å‰ä¼šè¢«å‹ç¼©ã€‚</strong></p>
<p><strong>4ï¼‰å…¶ä½™çš„åˆ†ç‰‡èŠ‚ç‚¹æ¥æ”¶æ•°æ®å¹¶å†™å…¥æœ¬åœ°</strong></p>
<p><strong>satoriã€matsuri èŠ‚ç‚¹ä¼šç¡®è®¤å»ºç«‹å’Œ aqua èŠ‚ç‚¹çš„è¿æ¥ï¼Œç„¶ååœ¨æ”¶åˆ°æ¥ aqua å‘é€çš„æ•°æ®ä¹‹åï¼Œå°†å®ƒä»¬å†™å…¥åˆ°æœ¬åœ°è¡¨ã€‚</strong></p>
<p><strong>5ï¼‰ç”±ç¬¬ä¸€ä¸ªåˆ†ç‰‡ç¡®è®¤å®Œæˆå†™å…¥</strong></p>
<p><strong>æœ€åï¼Œè¿˜æ˜¯ç”± aqua åˆ†ç‰‡èŠ‚ç‚¹ç¡®è®¤æ‰€æœ‰çš„æ•°æ®å‘é€å®Œæ¯•ã€‚è‡³æ­¤ï¼Œæ•´ä¸ªæµç¨‹ç»“æŸï¼Œå› ä¸ºè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æµç¨‹å›¾å°±ä¸ç”»äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ Distributed è¡¨è´Ÿè´£æ‰€æœ‰åˆ†ç‰‡æ˜¯æˆ‘å†™å…¥å·¥ä½œï¼Œæœ¬ç€è°æ‰§è¡Œè°è´Ÿè´£çš„åŸåˆ™ï¼Œåœ¨å½“å‰è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”± aqua èŠ‚ç‚¹çš„åˆ†å¸ƒå¼è¡¨è´Ÿè´£åˆ‡åˆ†æ•°æ®ï¼Œå¹¶å‘æ‰€æœ‰å…¶å®ƒåˆ†ç‰‡èŠ‚ç‚¹å‘é€æ•°æ®ã€‚</strong></p>
<p><strong>åœ¨ç”± Distributed è¡¨è´Ÿè´£å‘è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹å‘é€æ•°æ®æ—¶ï¼Œæœ‰å¼‚æ­¥å†™å’ŒåŒæ­¥å†™ä¸¤ç§æ¨¡å¼ï¼šå¦‚æœæ˜¯å¼‚æ­¥å†™ï¼Œåˆ™åœ¨ Distributed è¡¨å†™å®Œæœ¬åœ°åˆ†ç‰‡ä¹‹åï¼ŒINSERT æŸ¥è¯¢å°±ä¼šè¿”å›æˆåŠŸå†™å…¥çš„ä¿¡æ¯ï¼›å¦‚æœæ˜¯åŒæ­¥å†™ï¼Œåˆ™åœ¨æ‰§è¡Œ INSERT æŸ¥è¯¢ä¹‹åï¼Œä¼šç­‰å¾…æ‰€æœ‰åˆ†ç‰‡å®Œæˆå†™å…¥ã€‚è‡³äºé€‰æ‹©ä½•ç§æ¨¡ï¼Œç”± insert_distributed_sync å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤ä¸º falseï¼Œä¹Ÿå°±æ˜¯å¼‚æ­¥å†™ï¼›å¦‚æœå°†å…¶è®¾ç½®æˆ trueï¼Œé‚£ä¹ˆå¯ä»¥è¿›ä¸€æ­¥é€šè¿‡ insert_distributed_timeout å‚æ•°æ§åˆ¶åŒæ­¥ç­‰å¾…çš„è¶…æ—¶æ—¶é—´ã€‚</strong></p>
<p><strong>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹åœ¨ aqua èŠ‚ç‚¹ä¸Šå†™çš„æ•°æ®ï¼Œæœ‰æ²¡æœ‰è¢«åˆ‡åˆ†ã€å¹¶å†™å…¥åˆ°ä¸åŒçš„åˆ†ç‰‡èŠ‚ç‚¹ä¸­ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202746371-1610187949.png" alt="img"></p>
<p><strong>æ˜¾ç„¶è¾“å‡ºä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ä¸”æ ¹æ®è¾“å‡ºæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼š10 å’Œ 100 è¢«åˆ’åˆ†åˆ°äº† satori åˆ†ç‰‡èŠ‚ç‚¹ï¼ˆshard 1ï¼‰ã€30 è¢«åˆ’åˆ†åˆ°äº† matsuri åˆ†ç‰‡èŠ‚ç‚¹ï¼ˆshard 2ï¼‰ã€50 è¢«åˆ’åˆ†åˆ°äº† aqua åˆ†ç‰‡èŠ‚ç‚¹ï¼ˆshard 3ï¼‰ã€‚</strong></p>
<h4 id="å‰¯æœ¬å¤åˆ¶æ•°æ®çš„æ ¸å¿ƒæµç¨‹"><a href="#å‰¯æœ¬å¤åˆ¶æ•°æ®çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="å‰¯æœ¬å¤åˆ¶æ•°æ®çš„æ ¸å¿ƒæµç¨‹"></a>å‰¯æœ¬å¤åˆ¶æ•°æ®çš„æ ¸å¿ƒæµç¨‹</h4><p><strong>å¦‚æœåœ¨é›†ç¾¤çš„é…ç½®ä¸­åŒ…å«äº†å‰¯æœ¬ï¼Œé‚£ä¹ˆé™¤äº†åˆšæ‰çš„åˆ†ç‰‡å†™å…¥æµç¨‹ä¹‹å¤–ï¼Œè¿˜ä¼šè§¦å‘å‰¯æœ¬æ•°æ®çš„å¤åˆ¶æµç¨‹ã€‚è€Œæ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´ï¼Œæœ‰ä¸¤ç§å¤åˆ¶æ–¹å¼ï¼šç¬¬ä¸€ç§æ˜¯ç»§ç»­å€ŸåŠ© Distributed è¡¨å¼•æ“ï¼Œç”±å®ƒå°†æ•°æ®å†™å…¥å‰¯æœ¬ï¼›ç¬¬äºŒç§æ˜¯å€ŸåŠ©äº ReplicatedMergeTree è¡¨å¼•æ“å®ç°å‰¯æœ¬æ•°æ®çš„åˆ†å‘ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202752365-2031329771.png" alt="img"></p>
<p><strong>1ï¼‰é€šè¿‡ Distributed è¡¨å¤åˆ¶æ•°æ®</strong></p>
<p><strong>ä¸‹é¢æˆ‘ä»¬å¢åŠ ä¸€ä¸‹é…ç½®ï¼Œå®ç° 1 åˆ†ç‰‡ 2 å‰¯æœ¬ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">è¿˜è®°å¾—å—ï¼Œæˆ‘ä»¬ä¹‹å‰é…ç½®è¿‡ 1 åˆ†ç‰‡ 1 å‰¯æœ¬ï¼Œå½“æ—¶æˆ‘ä»¬è¯´ï¼Œå¯¹äºå•åˆ†ç‰‡è€Œè¨€ï¼Œå¯ä»¥ä¸é…ç½®é›†ç¾¤ï¼Œåªé…ç½® ZooKeeper å³å¯ </span></span><br><span class="line"><span class="comment">ä½†å¾ˆæ˜æ˜¾ï¼Œå•åˆ†ç‰‡ä¹Ÿæ˜¯å¯ä»¥é…ç½®é›†ç¾¤çš„</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ch_cluster_1shard_2replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>satori<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>matsuri<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>aqua<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ch_cluster_1shard_2replica</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬å°†ä¸Šé¢çš„é…ç½®å¢åŠ åˆ° config.xml çš„ remote_server æ ‡ç­¾ä¸­ï¼Œè€Œæˆ‘ä»¬ä¹‹é—´çš„ ch_cluster_3shard_0replica ä¸éœ€è¦åŠ¨ï¼Œå› ä¸º ClickHouse æ”¯æŒå¤šä¸ªé›†ç¾¤ï¼Œæˆ‘ä»¬æƒ³ç”¨å“ªä¸€ä¸ªï¼Œç›´æ¥é€šè¿‡é›†ç¾¤çš„åç§°æŒ‡å®šå³å¯ã€‚</strong></p>
<p><strong>ä¿®æ”¹å®Œä¸‰ä¸ªèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¹‹åï¼Œåˆ†åˆ«é‡å¯ ClickHouseã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202801554-1900464415.png" alt="img"></p>
<p><strong>æˆ‘ä»¬æŸ¥çœ‹é›†ç¾¤ï¼Œå‘ç°å·²ç»ç”Ÿæ•ˆäº†ï¼Œå¹¶ä¸” shard_num éƒ½æ˜¯ 1ï¼Œå› ä¸ºåªæœ‰ 1 ä¸ªåˆ†ç‰‡ã€‚ç„¶å replica_num åˆ†åˆ«ä¸º 1ã€2ã€3ï¼Œå› ä¸ºè¯¥åˆ†ç‰‡ä¸‹æœ‰ 3 ä¸ªå‰¯æœ¬ã€‚</strong></p>
<p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨è¿™ä¸ªé›†ç¾¤å†…åˆ›å»ºæ•°æ®è¡¨ï¼Œé¦–å…ˆåˆ›å»ºæœ¬åœ°è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æˆ‘ä»¬ä¹‹å‰ä¸æŒ‡å®šé›†ç¾¤çš„æ—¶å€™ï¼Œéœ€è¦åœ¨æ¯ä¸ªå‰¯æœ¬ä¸Šåˆ†åˆ«æ‰§è¡Œä¸€éå»ºè¡¨è¯­å¥</span></span><br><span class="line"><span class="comment">-- å½“æ­å»ºäº†é›†ç¾¤ä¹‹åï¼Œé€šè¿‡ ON CLUSTER çš„æ–¹å¼åªéœ€è¦åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_2 <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree() </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œæˆ‘ä»¬æŒ‡å®šçš„é›†ç¾¤æ˜¯ ch_cluster_1shard_2replicaï¼Œé‚£ä¹ˆ  ClickHouse ä¼šæ ¹æ®é›†ç¾¤ä¿¡æ¯ï¼Œè‡ªåŠ¨å°†å»ºè¡¨è¯­å¥åˆ†å‘åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚å¹¶ä¸”ï¼Œç”±äºæ˜¯é€šè¿‡ Distributed è¡¨å¤åˆ¶æ•°æ®ï¼Œæ‰€ä»¥å¯¹è¡¨å¼•æ“æ²¡æœ‰ä»»ä½•è¦æ±‚ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202810253-39348292.png" alt="img"></p>
<p><strong>æ˜¾ç„¶åˆ›å»ºæˆåŠŸï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆ›å»ºåˆ†å¸ƒå¼è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_2_all <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> Distributed(ch_cluster_1shard_2replica, <span class="keyword">default</span>, distributed_test_2)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202821448-1355354741.png" alt="img"></p>
<p><strong>ç„¶åæˆ‘ä»¬å‘ Distributed è¡¨å†™å…¥æ•°æ®ï¼Œå®ƒä¼šè´Ÿè´£å°†æ•°æ®å†™å…¥é›†ç¾¤å†…çš„æ¯ä¸ª replicaã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202827490-196325264.png" alt="img"></p>
<p><strong>å½“ç„¶ï¼Œå¦‚æœæŸ¥è¯¢ satori èŠ‚ç‚¹å’Œ aqua èŠ‚ç‚¹çš„æœ¬åœ°è¡¨ï¼Œè‚¯å®šä¹Ÿæ˜¯æœ‰æ•°æ®çš„ã€‚</strong></p>
<p><strong>å¦‚æœæˆ‘ä»¬é…ç½®çš„æ˜¯å¤šåˆ†ç‰‡ã€å¤šå‰¯æœ¬ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ•°æ®ä¼šå†™å…¥åˆ°æ‰€æœ‰åˆ†ç‰‡çš„æ‰€æœ‰å‰¯æœ¬ä¸­ã€‚ä¸è¿‡ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºï¼Œå½“å‰æ–¹æ¡ˆå¯¹ Distributed è¡¨æ‰€åœ¨èŠ‚ç‚¹ä¼šé€ æˆå¾ˆå¤§å‹åŠ›ï¼Œå› ä¸ºå®ƒéœ€è¦åŒæ—¶è´Ÿè´£åˆ†ç‰‡ä»¥åŠæ‰€æœ‰å‰¯æœ¬çš„æ•°æ®å†™å…¥å·¥ä½œï¼Œå› æ­¤å®ƒæœ‰å¯èƒ½æˆä¸ºå†™å…¥çš„å•ç‚¹ç“¶é¢ˆï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸‹é¢çš„ç¬¬äºŒç§æ–¹æ¡ˆã€‚</strong></p>
<p><strong>2ï¼‰é€šè¿‡ ReplicatedMergeTree è¡¨å¤åˆ¶æ•°æ®</strong></p>
<p><strong>å¦‚æœåœ¨é›†ç¾¤çš„ shard é…ç½®ä¸­å¢åŠ  internal_replication å‚æ•°å¹¶å°†å…¶è®¾ç½®ä¸º trueï¼ˆé»˜è®¤ä¸º falseï¼‰ï¼Œé‚£ä¹ˆ Distributed è¡¨åœ¨è¯¥ shard ä¸­åªä¼šé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ replica å¹¶å¯¹å…¶å†™å…¥æ•°æ®ã€‚æ­¤æ—¶ï¼Œå¦‚æœä½¿ç”¨ ReplicatedMergeTree ä½œä¸ºæœ¬åœ°è¡¨çš„å¼•æ“ï¼Œè¯¥ shard å†…çš„å¤šä¸ª replica ä¹‹é—´çš„æ•°æ®åˆ™ä¼šäº¤ç»™ ReplicatedMergeTree è‡ªå·±å¤„ç†ï¼Œä¸å†ç”± Distributed è´Ÿè´£ï¼Œä»è€Œä¸ºå…¶å‡è´Ÿã€‚</strong></p>
<p><strong>åœ¨ shard ä¸­é€‰æ‹© replica çš„ç®—æ³•å¤§è‡´å¦‚ä¸‹ï¼šé¦–å…ˆåœ¨ ClickHouse çš„æœåŠ¡èŠ‚ç‚¹ä¸­ï¼Œæ‹¥æœ‰ä¸€ä¸ªå…¨å±€æŠ€æœ¯å™¨ errors_countï¼Œå½“æœåŠ¡å‡ºç°ä»»ä½•å¼‚å¸¸æ—¶ï¼Œè¯¥è®¡æ•°å™¨éƒ½ä¼šåŠ  1ï¼›ç„¶åå½“ä¸€ä¸ª shard æ‹¥æœ‰å¤šä¸ª replica æ—¶ï¼Œé€‰æ‹© errors_count æœ€å°‘çš„é‚£ä¸ªã€‚ä¸‹é¢æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ch_cluster_1shard_2replica</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å¢åŠ è¯¥é…ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>satori<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>matsuri<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">host</span>&gt;</span>aqua<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ch_cluster_1shard_2replica</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹ä¸‰ä¸ªèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ config.xmlï¼Œç„¶åé‡å¯ ClickHouseã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬åˆ›å»ºè¡¨ï¼Œæ³¨æ„ï¼šç”±äºæŒ‡å®šäº† internal_replication ä¸º trueï¼Œé‚£ä¹ˆ Distributed è¡¨åªä¼šå¾€ä¸€ä¸ªå‰¯æœ¬ä¸­å†™ï¼Œè¿™å°±è¦æ±‚å‰¯æœ¬ä¹‹é—´æ˜¯å¯ä»¥è¿›è¡ŒåŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»æŒ‡å®š Replicated* è¡¨å¼•æ“ã€‚æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼Œå…ˆä»¥ MergeTree ä¸ºä¾‹ï¼Œç„¶åå†ä»¥ ReplicatedMergeTree ä¸ºä¾‹ï¼Œçœ‹çœ‹æ•°æ®åœ¨ä¸¤è€…ä¹‹é—´çš„åŒæ­¥æƒ…å†µã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºæœ¬åœ°è¡¨ï¼Œè¡¨å¼•æ“ä¸º MergeTree</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_3 <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree() </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_3_all <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> Distributed(ch_cluster_1shard_2replica, <span class="keyword">default</span>, distributed_test_3)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202840577-1265892790.png" alt="img"></p>
<p><strong>æŒ‡å®šè¡¨å¼•æ“ä¸º MergeTreeï¼Œå‰¯æœ¬ä¹‹é—´æ— æ³•å‘ç”ŸåŒæ­¥ã€‚ç„¶åæˆ‘ä»¬å†åˆ›å»ºä¸€å¼ è¡¨ï¼Œå°†è¡¨å¼•æ“æŒ‡å®šä¸º ReplicatedMergeTreeï¼Œçœ‹çœ‹å‰¯æœ¬ä¹‹é—´æ˜¯å¦ä¼šå‘ç”ŸåŒæ­¥ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºæœ¬åœ°è¡¨ï¼Œè¡¨å¼•æ“ä¸º ReplicatedMergeTree</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_4 <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line"><span class="comment">-- æ³¨æ„è¿™é‡Œçš„ zk_path å’Œ replica_nameï¼Œzk_path æ˜¾ç„¶éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ replica_name ä¸åŒ</span></span><br><span class="line"><span class="comment">-- æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨ ON CLUSTER å’Œå®å˜é‡ï¼Œè€Œæ˜¯æ¯ä¸ªèŠ‚ç‚¹æ‰‹åŠ¨æ‰§è¡Œä¸€éï¼Œä¸åŒèŠ‚ç‚¹æŒ‡å®šä¸åŒçš„ replica_nameï¼Œåƒæœ€å¼€å§‹ä»‹ç»å‰¯æœ¬é‚£æ ·</span></span><br><span class="line"><span class="comment">-- å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ ON CLUSTERï¼Œåªä¸è¿‡æ­¤æ—¶ä¸åŒå‰¯æœ¬çš„ replica_name ä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å®å˜é‡ &#123;replica&#125;ï¼Œè€Œåœ¨ä¹‹å‰æˆ‘ä»¬å·²ç»é…å¥½äº†</span></span><br><span class="line"><span class="comment">-- ç„¶åæˆ‘ä»¬çŸ¥é“è¿˜æœ‰ä¸€ä¸ªå®å˜é‡ &#123;shard&#125;ï¼Œå› ä¸ºæ˜¯å•åˆ†ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨å®ƒï¼Œå¦‚æœæ˜¯å¤šåˆ†ç‰‡å¤šå‰¯æœ¬ï¼Œé‚£ä¹ˆå°±éœ€è¦æ—¶å€™ç”¨äº†</span></span><br><span class="line">) ENGINE <span class="operator">=</span> ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/01/distributed_test_4&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> distributed_test_4_all <span class="keyword">ON</span> CLUSTER ch_cluster_1shard_2replica (</span><br><span class="line">    id UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> Distributed(ch_cluster_1shard_2replica, <span class="keyword">default</span>, distributed_test_4)</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202850487-1826170754.png" alt="img"></p>
<h3 id="åˆ†å¸ƒå¼æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹"><a href="#åˆ†å¸ƒå¼æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="åˆ†å¸ƒå¼æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹"></a>åˆ†å¸ƒå¼æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹</h3><p><strong>å½“é¢ä¸´æ•°æ®æŸ¥è¯¢æ—¶ï¼Œæ¯«æ— ç–‘é—®è¦é€šè¿‡åˆ†å¸ƒå¼è¡¨å®ç°ï¼Œå½“åˆ†å¸ƒå¼è¡¨æ¥æ”¶åˆ° SELECT æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡æŸ¥è¯¢æ¯ä¸ªåˆ†ç‰‡çš„æ•°æ®ï¼Œå†åˆå¹¶æ±‡æ€»è¿”å›ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å°†æ¯ä¸ªèŠ‚ç‚¹éƒ½æŸ¥è¯¢ä¸€éï¼Œç„¶åæ‰‹åŠ¨æ±‡æ€»ï¼Œä½†æ˜¾ç„¶ä¸ä¼šæœ‰äººè¿™ä¹ˆåšï¼Œä¸ç„¶è¿˜è¦åˆ†å¸ƒå¼è¡¨åšä»€ä¹ˆå‘¢ã€‚ä¸‹é¢å°±æ¥ä»‹ç»åˆ†å¸ƒå¼è¡¨çš„æ•°æ®æŸ¥è¯¢ã€‚</strong></p>
<h4 id="å¤šå‰¯æœ¬çš„è·¯ç”±è§„åˆ™"><a href="#å¤šå‰¯æœ¬çš„è·¯ç”±è§„åˆ™" class="headerlink" title="å¤šå‰¯æœ¬çš„è·¯ç”±è§„åˆ™"></a>å¤šå‰¯æœ¬çš„è·¯ç”±è§„åˆ™</h4><p><strong>åœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœé›†ç¾¤ä¸­çš„ä¸€ä¸ª shard æ‹¥æœ‰å¤šä¸ª replicaï¼Œé‚£ä¹ˆ Distributed è¡¨å¼•æ“éœ€è¦é¢ä¸´å‰¯æœ¬é€‰æ‹©çš„é—®é¢˜ã€‚å®ƒä¼šä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•ä»ä¼—å¤š replica ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œè€Œå…·ä½“ä½¿ç”¨ä½•ç§ç®—æ³•ï¼Œåˆ™ç”± load_balancing å‚æ•°æ§åˆ¶ï¼Œå…¶å–å€¼æœ‰å¦‚ä¸‹å‡ ç§ã€‚</strong></p>
<p><strong>1ï¼‰random</strong></p>
<p><strong>random æ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œæ­£å¦‚å‰æ–‡æ‰€è¿°ï¼Œåœ¨ ClickHouse çš„æœåŠ¡èŠ‚ç‚¹ä¸­ï¼Œæ‹¥æœ‰ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨ errors_countï¼Œå½“æœåŠ¡å‘ç”Ÿä»»ä½•æ•…éšœæ—¶ï¼Œè¯¥è®¡æ•°å™¨éƒ½ä¼šè‡ªå¢ 1ã€‚è€Œ randon ç®—æ³•ä¼šé€‰æ‹© errors_count æœ€å°çš„ replicaï¼Œå¦‚æœæ‹¥æœ‰æœ€å° errors_count çš„ replica æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆå°±ä»ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªã€‚</strong></p>
<p><strong>2ï¼‰nearest_hostname</strong></p>
<p><strong>nearest_hostname å¯ä»¥çœ‹åšæ˜¯ random ç®—æ³•çš„å˜ç§ï¼Œé¦–å…ˆå®ƒä¹Ÿä¼šé€‰æ‹© errors_count æœ€å°çš„ replicaï¼Œä½†å¦‚æœæ‹¥æœ‰æœ€å° errors_count çš„ replica æœ‰å¤šä¸ªï¼Œåˆ™æ¯”è¾ƒé›†ç¾¤é…ç½®ä¸­çš„ hostï¼ˆä¸»æœºåï¼‰å’Œå½“å‰ Distributed è¡¨æ‰€åœ¨èŠ‚ç‚¹çš„ä¸»æœºåçš„ç›¸ä¼¼åº¦ï¼Œé€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„å“ªä¸€ä¸ªã€‚</strong></p>
<p><strong>3ï¼‰in_order</strong></p>
<p><strong>in_order å¯ä»¥åŒæ ·å¯ä»¥çœ‹åšæ˜¯ random ç®—æ³•çš„å˜ç§ï¼Œé¦–å…ˆå®ƒä¹Ÿä¼šé€‰æ‹© errors_count æœ€å°çš„ replicaï¼Œä½†å¦‚æœæ‹¥æœ‰æœ€å° errors_count çš„ replica æœ‰å¤šä¸ªï¼Œåˆ™æ ¹æ®é›†ç¾¤ä¸­ replica çš„å®šä¹‰é¡ºåºè¿›è¡Œé€‰æ‹©ã€‚</strong></p>
<p><strong>4ï¼‰first_or_random</strong></p>
<p><strong>first_or_random å¯ä»¥çœ‹åšæ˜¯ in_order ç®—æ³•çš„å˜ç§ï¼Œé¦–å…ˆå®ƒè¿˜æ˜¯ä¼šé€‰æ‹© errors_count æœ€å°çš„ replicaï¼Œä½†å¦‚æœæ‹¥æœ‰æœ€å° errors_count çš„ replica æœ‰å¤šä¸ªï¼Œåˆ™æ ¹æ®é›†ç¾¤ä¸­ replica çš„å®šä¹‰é¡ºåºè¿›è¡Œé€‰æ‹©ã€‚ä½†å¦‚æœé€‰æ‹©çš„ replica ä¸å¯ç”¨ï¼Œåˆ™è¿›ä¸€æ­¥éšæœºé€‰æ‹©ä¸€ä¸ªå…¶å®ƒçš„ replicaã€‚</strong></p>
<p><strong>æ„Ÿè§‰éƒ½æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§åŒºåˆ«ï¼Œç›´æ¥ä½¿ç”¨ random å°±å¥½ã€‚</strong></p>
<h4 id="å¤šåˆ†ç‰‡æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹"><a href="#å¤šåˆ†ç‰‡æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹" class="headerlink" title="å¤šåˆ†ç‰‡æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹"></a>å¤šåˆ†ç‰‡æŸ¥è¯¢çš„æ ¸å¿ƒæµç¨‹</h4><p><strong>åˆ†å¸ƒå¼æŸ¥è¯¢ä¸åˆ†å¸ƒå¼å†™å…¥ç±»ä¼¼ï¼ŒåŒæ ·æœ¬ç€è°æ‰§è¡Œè°è´Ÿè´£çš„åŸåˆ™ï¼Œå®ƒä¼šæ¥æ”¶ SELECT æŸ¥è¯¢çš„ Distributed è¡¨ï¼Œå¹¶è´Ÿè´£ä¸²è”èµ·æ•´ä¸ªè¿‡ç¨‹ã€‚é¦–å…ˆå®ƒä¼šå°†é’ˆå¯¹åˆ†å¸ƒå¼è¡¨çš„ SQL è¯­å¥ï¼ŒæŒ‰ç…§åˆ†ç‰‡æ•°é‡æ‹†åˆ†æˆè‹¥å¹²ä¸ªé’ˆå¯¹æœ¬åœ°è¡¨çš„å­æŸ¥è¯¢ï¼Œç„¶åå‘å„ä¸ªåˆ†ç‰‡å‘èµ·æŸ¥è¯¢ï¼Œæœ€åå†æ±‡æ€»å„ä¸ªåˆ†ç‰‡çš„è¿”å›ç»“æœã€‚ä»¥æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ distributed_test_1_all ä¸ºä¾‹ï¼Œå¦‚æœå¯¹å®ƒå‘èµ·å¦‚ä¸‹æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM distributed_test_1_all</span><br></pre></td></tr></table></figure>

<p><strong>é‚£ä¹ˆå®ƒä¼šå°†å…¶è½¬åŒ–ä¸ºå¦‚ä¸‹å½¢å¼ï¼Œç„¶åå†å‘é€åˆ°è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹æ¥æ‰§è¡Œï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM distributed_test_1</span><br></pre></td></tr></table></figure>

<p><strong>å†æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT count() FROM distributed_test_1_all</span><br></pre></td></tr></table></figure>

<p><strong>é‚£ä¹ˆ Distributed è¡¨å¼•æ“ä¼šå°†æŸ¥è¯¢è®¡åˆ’è½¬æ¢ä¸ºå¤šä¸ªåˆ†ç‰‡ UNION è”åˆæŸ¥è¯¢ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202858704-678966492.png" alt="img"></p>
<p><strong>æ•´ä¸ªæ‰§è¡Œè®¡åˆ’ä»ä¸Šå¤§å°å¤§è‡´åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œä¸‹é¢è¿›è¡Œä»‹ç»ï¼Œæˆ‘ä»¬å½“å‰æ˜¯åœ¨ aqua èŠ‚ç‚¹æŸ¥è¯¢çš„åˆ†å¸ƒå¼è¡¨ã€‚</strong></p>
<p><strong>1ï¼‰æŸ¥è¯¢å„ä¸ªåˆ†ç‰‡æ•°æ®</strong></p>
<p><strong>åœ¨ä¸Šå›¾ä¸­ï¼ŒOne å’Œ Remote æ­¥éª¤æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå®ƒä»¬åˆ†åˆ«è´Ÿè´£äº†æœ¬åœ°å’Œè¿œç«¯åˆ†ç‰‡çš„æŸ¥è¯¢åŠ¨ä½œã€‚å…¶ä¸­ï¼Œåœ¨ One è¿™ä¸ªæ­¥éª¤ä¼šå°† SQL è½¬æˆå¯¹æœ¬åœ°è¡¨çš„æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT count() FROM default.distributed_test_1</span><br></pre></td></tr></table></figure>

<p><strong>è€Œåœ¨ Remote æ­¥éª¤ä¸­ï¼Œä¼šå’Œå…¶å®ƒä¸¤ä¸ªå‰¯æœ¬èŠ‚ç‚¹ï¼ˆsatoriã€matsuriï¼‰å»ºç«‹è¿æ¥ï¼Œå¹¶å‘å…¶å‘èµ·è¿œç¨‹æŸ¥è¯¢ï¼š</strong></p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">Connection</span> (<span class="attribute">satori</span>:<span class="number">9000</span>): <span class="selector-tag">Connecting</span>. <span class="selector-tag">Database</span>: ...</span><br><span class="line"><span class="selector-tag">Connection</span> (<span class="attribute">matsuri</span>:<span class="number">9000</span>): <span class="selector-tag">Connecting</span>. <span class="selector-tag">Database</span>: ...</span><br></pre></td></tr></table></figure>

<p><strong>satori èŠ‚ç‚¹å’Œ matsuri èŠ‚ç‚¹åœ¨æ”¶åˆ° aqua çš„æŸ¥è¯¢è¯·æ±‚åï¼Œä¼šåˆ†åˆ«åœ¨æœ¬åœ°å¼€å§‹æ‰§è¡Œï¼ŒåŒæ ·ï¼ŒSQL ä¼šè½¬æ¢æˆå¯¹æœ¬åœ°è¡¨çš„æŸ¥è¯¢ã€‚</strong></p>
<p><strong>2ï¼‰åˆå¹¶è¿”å›ç»“æœ</strong></p>
<p><strong>å¤šä¸ªåˆ†ç‰‡æ•°æ®å‡æŸ¥è¯¢è¿”å›åï¼Œåœ¨ aqua èŠ‚ç‚¹å°†å…¶åˆå¹¶ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202906926-1785526205.png" alt="img"></p>
<p><strong>ä»¥ä¸Šæ˜¾ç„¶æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå³ä½¿æ‰§è¡Œä¸€äº›å¤æ‚çš„è¯­å¥ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202913185-300366400.png" alt="img"></p>
<p><strong>æ‰€ä»¥å³ä½¿ SQL è¯­å¥å¤æ‚ï¼Œä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå½“ç„¶æˆ‘ä»¬è¿™ä¸ª SQL è¯­å¥è¯´å¤æ‚å°±æ˜æ˜¾å¤ªè¿‡äº†ã€‚æ€»ä¹‹ä½ å¯¹æ™®é€šè¡¨æ‰€åšçš„æŸ¥è¯¢ï¼Œå¯¹åˆ†å¸ƒå¼è¡¨åŒæ ·å¯ä»¥ï¼Œåƒä¸€èˆ¬çš„ WHERE å­å¥ã€GROUP BY å­å¥ã€ORDER BY å­å¥ã€LIMIT OFFSET å­å¥ï¼Œéƒ½æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</strong></p>
<p><strong>ä½†æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯å­æŸ¥è¯¢ï¼Œä¸åƒå•è¡¨ï¼Œåˆ†å¸ƒå¼è¡¨çš„å­æŸ¥è¯¢æ˜¯ç”±å¾ˆå¤šå‘ç‚¹çš„ã€‚</strong></p>
<h4 id="ä½¿ç”¨-Global-ä¼˜åŒ–åˆ†å¸ƒå¼å­æŸ¥è¯¢"><a href="#ä½¿ç”¨-Global-ä¼˜åŒ–åˆ†å¸ƒå¼å­æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨ Global ä¼˜åŒ–åˆ†å¸ƒå¼å­æŸ¥è¯¢"></a>ä½¿ç”¨ Global ä¼˜åŒ–åˆ†å¸ƒå¼å­æŸ¥è¯¢</h4><p><strong>å¦‚æœåœ¨åˆ†å¸ƒå¼æŸ¥è¯¢ä¸­ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå¯èƒ½ä¼šé¢ä¸´ä¸¤éš¾çš„å±€é¢ã€‚ä¸‹é¢ä¸¾ä¸ªæ —å­ï¼Œé¦–å…ˆä½¿ç”¨ä¹‹å‰çš„ 3 åˆ†ç‰‡ 0 å‰¯æœ¬é›†ç¾¤åˆ›å»ºæœ¬åœ°è¡¨å’Œåˆ†å¸ƒå¼è¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> in_clause_test_1 <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica (</span><br><span class="line">    id UInt64,</span><br><span class="line">    repo UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/tables/&#123;shard&#125;/in_clause_test_1&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> in_clause_test_1_all <span class="keyword">ON</span> CLUSTER ch_cluster_3shard_0replica (</span><br><span class="line">    id UInt64,</span><br><span class="line">    repo UInt64</span><br><span class="line">) ENGINE <span class="operator">=</span> Distributed(ch_cluster_3shard_0replica, <span class="keyword">default</span>, in_clause_test_1)</span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åå†™å…¥æ•°æ®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202920731-1829720220.png" alt="img"></p>
<p><strong>æŸ¥è¯¢ä¸‰å¼ æœ¬åœ°è¡¨çš„æ•°æ®å¦‚å›¾æ‰€ç¤ºï¼Œè€Œå°†å›¾ä¸­çš„ä¸‰ä¸ªç»“æœé›†åˆåœ¨ä¸€å—æ˜¾ç„¶å°±æ˜¯æŸ¥è¯¢åˆ†å¸ƒå¼è¡¨æ‰€å¾—åˆ°çš„ç»“æœã€‚å…¶ä¸­ id ä»£è¡¨ç”¨æˆ·çš„ç¼–å·ï¼Œrepo ä»£è¡¨ä»“åº“çš„ç¼–å·ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202928146-1844830346.png" alt="img"></p>
<p><strong>é‡ç‚¹æ¥äº†ï¼Œå¦‚æœæˆ‘æƒ³æŸ¥è¯¢è‡³å°‘æ‹¥æœ‰ä¸¤ä¸ªä»“åº“çš„ç”¨æˆ· id ä»¥åŠå¯¹åº”çš„ä»“åº“ç¼–å·ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¦‚æœæ˜¯å…³ç³»å‹æ•°æ®åº“ã€æˆ–è€…è¯´ä¸æ˜¯åˆ†å¸ƒå¼è¡¨çš„è¯ï¼Œé‚£ä¹ˆæ˜¾ç„¶ä¸€ä¸ªå­æŸ¥è¯¢å°±æå®šäº†ï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»é€šè¿‡ GROUP BY æŸ¥è¯¢å‡ºäº†ç›¸åº”çš„ idï¼Œç„¶åæ ¹æ® id å»ç­›é€‰å³å¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    repo</span><br><span class="line"><span class="keyword">FROM</span> in_clause_test_1_all</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id</span><br><span class="line">    <span class="keyword">FROM</span> in_clause_test_1_all</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> id</span><br><span class="line">    <span class="keyword">HAVING</span> <span class="built_in">count</span>() <span class="operator">&gt;=</span> <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>é¦–å…ˆå¯ä»¥è‚¯å®šè¿™ä¸ªè¯­å¥æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ‰§è¡Œçš„æ—¶å€™ ClickHouse ä¼šæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Code: 288. DB::Exception: Received from localhost:9000. DB::Exception: Double-distributed IN/JOIN subqueries is denied (distributed_product_mode = &#x27;deny&#x27;). You may rewrite query to use local tables in subqueries, or use GLOBAL keyword, or set distributed_product_mode to suitable value.: While processing in_clause_test_1_all: While processing id IN (SELECT id FROM in_clause_test_1_all GROUP BY id HAVING count() &gt;= 2).</span><br></pre></td></tr></table></figure>

<p><strong>å…¶åŸå› å°±åœ¨äº ClickHouse æ˜¯é»˜è®¤ä¸æ”¯æŒåˆ†å¸ƒå¼å­æŸ¥è¯¢çš„ï¼Œè€Œè§£å†³åŠæ³•æœ‰ä¸¤ç§ã€‚</strong></p>
<p><strong>1ï¼‰é€šè¿‡ distributed_product_mode å‚æ•°è®©å…¶æ”¯æŒåˆ†å¸ƒå¼å­æŸ¥è¯¢</strong></p>
<p><strong>æ ¹æ®æŠ¥é”™ä¿¡æ¯æˆ‘ä»¬çŸ¥é“ distributed_product_mode é»˜è®¤ä¸º â€˜denyâ€™ï¼Œè¡¨ç¤ºç¦æ­¢åˆ†å¸ƒå¼å­æŸ¥è¯¢ï¼Œæˆ‘ä»¬åœ¨ users.xml å°†å…¶è®¾ç½®æˆ â€˜allowâ€™ å³å¯ï¼Œæˆ–è€…ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è®¾ç½®ä¹Ÿè¡Œã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202937479-1952752411.png" alt="img"></p>
<p><strong>å°† distributed_product_mode è®¾ç½®ä¸º â€˜allowâ€™ ä¹‹åå°±å¯ä»¥æˆåŠŸæ‰§è¡Œå¹¶è·å–æ•°æ®äº†ï¼Œè™½ç„¶ç»“æœæ˜¯ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›éœ€è¦æ€è€ƒğŸ¤”çš„ä¸œè¥¿ã€‚é¦–å…ˆä¸ºä»€ä¹ˆ ClickHouse ä¼šé»˜è®¤å°†åˆ†å¸ƒå¼å­æŸ¥è¯¢ç»™ç¦æ­¢å‘¢ï¼Ÿå­æŸ¥è¯¢è¿™ä¹ˆå¸¸è§ï¼Œæ˜æ˜¾ä¸åº”è¯¥ç¦æ­¢å•Šã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç›®å‰è¿™ç§ä½¿ç”¨åˆ†å¸ƒå¼å­æŸ¥è¯¢çš„æ–¹å¼ä¸€å®šæ˜¯å­˜åœ¨å¼Šç«¯çš„ã€‚</strong></p>
<p><strong>ä»”ç»†æ€è€ƒä¸€ä¸‹ä¼šå¾ˆå®¹æ˜“å‘ç°å­˜åœ¨æ•ˆç‡ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“æŸ¥è¯¢åˆ†å¸ƒå¼è¡¨ä¼šä¾æ¬¡æŸ¥è¯¢æ‰€æœ‰çš„æœ¬åœ°è¡¨ï¼Œè€Œå­æŸ¥è¯¢é‡Œé¢æŸ¥è¯¢çš„è¿˜æ˜¯åˆ†å¸ƒå¼è¡¨ï¼Œè¿™å°±å¯¼è‡´äº†æŸ¥è¯¢è¯·æ±‚ä¼šè¢«æ”¾å¤§ N çš„å¹³æ–¹å€ï¼Œå…¶ä¸­ N æ˜¯é›†ç¾¤å†…åˆ†ç‰‡èŠ‚ç‚¹æ•°é‡ã€‚æˆ‘ä»¬ä¸Šé¢åªæœ‰ 3 ä¸ªåˆ†ç‰‡èŠ‚ç‚¹ï¼Œä¼šè¿›è¡Œ 9 æ¬¡æŸ¥è¯¢ï¼Œè¿™è¿˜æ²¡æœ‰ä»€ä¹ˆï¼›ä½†å¦‚æœæœ‰ 100 ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å‘¢ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šå¯¼è‡´ 10000 æ¬¡æŸ¥è¯¢è¯·æ±‚ã€‚è€Œå¸¦æœ‰ä¸€ä¸ªå­æŸ¥è¯¢çš„ SQL ä¼šå¯¼è‡´ 10000 æ¬¡çš„æŸ¥è¯¢è¯·æ±‚ï¼Œä¸ç”¨æƒ³ï¼Œè¿™ç»å¯¹æ˜¯æ— æ³•æ¥å—çš„ã€‚å¹¶ä¸”è¿™é‡Œåªæœ‰ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œå¦‚æœæœ‰å¤šä¸ªå­æŸ¥è¯¢å‘¢ï¼Ÿå¦‚æœæœ‰çš„è€é“æ²¡æœ‰å¯¹ SQL è¿›è¡Œä¼˜åŒ–ï¼Œå¯¼è‡´å­æŸ¥è¯¢å†…éƒ¨åˆåµŒå¥—äº†å­æŸ¥è¯¢ï¼Œé‚£å°±ä¸æ˜¯æŒ‰å¹³æ–¹å€æ‰©å¤§äº†ï¼Œè€Œæ˜¯æŒ‰ç«‹æ–¹å€æ‰©å¤§ã€‚</strong></p>
<p><strong>è€Œä¸ºäº†è§£å†³æŸ¥è¯¢æ”¾å¤§çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ GLOBAL IN è¿›è¡Œä¼˜åŒ–ï¼Œè€Œä»åå­—ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå®ƒå’Œ IN ç›¸æ¯”ï¼Œåœ¨ç»“æœä¸Šæ²¡æœ‰ä»€ä¹ˆå´åˆ«ï¼Œä½†æ˜¯è§£å†³äº†æŸ¥è¯¢æ”¾å¤§çš„é—®é¢˜ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202945368-242588607.png" alt="img"></p>
<p><strong>é‚£ä¹ˆ GLOBAL IN æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</strong></p>
<ul>
<li><code>å°† IN å­å¥å•ç‹¬æå‡ºï¼Œå‘èµ·äº†ä¸€æ¬¡åˆ†å¸ƒå¼æŸ¥è¯¢</code></li>
<li><code>å°†åˆ†å¸ƒå¼è¡¨è½¬æˆæœ¬åœ°è¡¨åï¼Œåˆ†åˆ«æ˜¯åœ¨æœ¬åœ°åˆ†ç‰‡èŠ‚ç‚¹å’Œè¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹æ‰§è¡ŒæŸ¥è¯¢</code></li>
<li><code>å°† IN å­å¥æŸ¥è¯¢çš„ç»“æœè¿›è¡Œæ±‡æ€»ï¼Œå¹¶æ”¾å…¥ä¸€å¼ ä¸´æ—¶çš„å†…å­˜è¡¨è¿›è¡Œä¿å­˜</code></li>
<li><code>å°†å†…å­˜è¡¨å‘é€åˆ°è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹</code></li>
<li><code>å°†åˆ†å¸ƒå¼è¡¨è½¬ä¸ºæœ¬åœ°è¡¨åï¼Œå¼€å§‹æ‰§è¡Œå®Œæ•´çš„ SQL è¯­å¥ï¼ŒIN å­å¥ç›´æ¥ä½¿ç”¨ä¸´æ—¶å†…å­˜è¡¨çš„æ•°æ®</code></li>
</ul>
<p><strong>è‡³æ­¤ï¼Œæ•´ä¸ªæ ¸å¿ƒæµç¨‹ç»“æŸã€‚å¯ä»¥çœ‹åˆ°åœ¨ä½¿ç”¨ GLOBAL ä¿®é¥°ç¬¦ä¹‹åï¼ŒClickHouse ä½¿ç”¨å†…å­˜è¡¨ä¸´æ—¶ä¿å­˜é¥¿äº† IN å­å¥æŸ¥è¯¢åˆ°çš„æ•°æ®ï¼Œå¹¶å°†å…¶å‘é€åˆ°è¿œç«¯åˆ†ç‰‡èŠ‚ç‚¹ï¼Œä»¥æ­¤è¾¾åˆ°äº†æ•°æ®å…±äº«çš„ç›®çš„ï¼Œä»è€Œé¿å…äº†æŸ¥è¯¢æ”¾å¤§çš„é—®é¢˜ã€‚ç”±äºæ•°æ®ä¼šåœ¨ç½‘ç»œé—´åˆ†å‘ï¼Œæ‰€ä»¥éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸´æ—¶è¡¨çš„å¤§å°ï¼ŒIN å­å¥è¿”å›çš„æ•°æ®ä¸å®œè¿‡å¤§ã€‚å¦‚æœè¡¨å†…å­˜åœ¨é‡å¤æ•°æ®ï¼Œä¹Ÿå¯ä»¥äº‹å…ˆåœ¨ IN å­å¥ä¸­åŠ å…¥ DISTINCT è¿›è¡Œå»é‡ï¼Œä»¥å‡å°‘å†…å­˜è¡¨ä¸­çš„æ•°æ®é‡ï¼Œä»è€Œå®ç°æ›´å¿«çš„ä¼ è¾“ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E5%89%AF%E6%9C%AC%E4%B8%8E%E5%88%86%E7%89%87(%E5%8D%81%E4%B8%83)/1229382-20210927202952793-602254934.png" alt="img"></p>
<p><strong>é™¤äº† GLOBAL IN ä¹‹å¤–ï¼Œè¿˜æœ‰ GLOBAL JOIN ä½œç”¨æ˜¯ç›¸ä¼¼çš„ï¼Œä½†æˆ‘ä»¬è¯´èƒ½ä¸ç”¨ JOIN å°±ä¸ç”¨ JOINï¼Œå°†å…¶å­˜æˆä¸€å¼ å®½è¡¨æ˜¯æœ€å¥½çš„ã€‚</strong></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p><strong>ä»¥ä¸Šå°±æ˜¯å‰¯æœ¬ã€åˆ†ç‰‡å’Œé›†ç¾¤çš„ä½¿ç”¨æ–¹æ³•ã€ä½œç”¨ï¼Œä»¥åŠæ ¸å¿ƒæµç¨‹ã€‚</strong></p>
<p><strong>æˆ‘ä»¬é¦–å…ˆä»‹ç»äº†æ•°æ®å‰¯æœ¬çš„ç‰¹ç‚¹ï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† ReplicatedMergeTree è¡¨å¼•æ“ï¼Œå®ƒæ˜¯ MergeTree è¡¨å¼•æ“çš„å˜ç§ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ•°æ®å‰¯æœ¬çš„ä»£åè¯ï¼Œæ¥ç€åˆä»‹ç»äº†æ•°æ®åˆ†ç‰‡çš„ç‰¹ç‚¹å’Œä½œç”¨ã€‚åŒæ—¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¼•å…¥äº† ClickHouse é›†ç¾¤çš„æ¦‚å¿µï¼Œå¹¶è®²è§£äº†å®ƒçš„å·¥ä½œåŸç†ï¼Œæœ€åä»‹ç»äº† Distributed è¡¨å¼•æ“çš„æ ¸å¿ƒåŠŸèƒ½ä¸å·¥ä½œæµç¨‹ï¼Œå€ŸåŠ©å®ƒçš„èƒ½åŠ›ï¼Œå¯ä»¥å®ç°åˆ†å¸ƒå¼å†™å…¥ä¸æŸ¥è¯¢ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„æ•°æ®ç±»å‹(ä¸‰)</title>
    <url>/2023/02/01/ClickHouse%20%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B(%E4%B8%89)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„æ•°æ®ç±»å‹-ä¸‰"><a href="#ClickHouse-çš„æ•°æ®ç±»å‹-ä¸‰" class="headerlink" title="ClickHouse çš„æ•°æ®ç±»å‹(ä¸‰)"></a>ClickHouse çš„æ•°æ®ç±»å‹(ä¸‰)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š (<a href="https://www.cnblogs.com/traditional/p/15218628.html">https://www.cnblogs.com/traditional/p/15218628.html</a>) </p>
<hr>
<h3 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h3><p><strong>ä½œä¸ºä¸€æ¬¾åˆ†æå‹æ•°æ®åº“ï¼ŒClickHouse æä¾›äº†è®¸å¤šæ•°æ®ç±»å‹ï¼Œå®ƒä»¬å¯ä»¥åˆ’åˆ†ä¸ºåŸºç¡€ç±»å‹ã€å¤åˆç±»å‹å’Œç‰¹æ®Šç±»å‹ã€‚å…¶ä¸­åŸºç¡€ç±»å‹ä½¿ ClickHouse å…·å¤‡äº†æè¿°æ•°æ®çš„åŸºæœ¬èƒ½åŠ›ï¼Œè€Œå¦å¤–ä¸¤ç§ç±»å‹åˆ™ä½¿ ClickHouse çš„æ•°æ®è¡¨è¾¾èƒ½åŠ›æ›´åŠ çš„ä¸°å¯Œç«‹ä½“ã€‚</strong></p>
<p><strong>ä¸‹é¢å°±æ¥åˆ†é—¨åˆ«ç±»çš„ä»‹ç»ä¸€ä¸‹ã€‚</strong></p>
<h3 id="åŸºç¡€ç±»å‹"><a href="#åŸºç¡€ç±»å‹" class="headerlink" title="åŸºç¡€ç±»å‹"></a>åŸºç¡€ç±»å‹</h3><p><strong>åŸºç¡€ç±»å‹åªæœ‰æ•°å€¼ã€å­—ç¬¦ä¸²å’Œæ—¶é—´ä¸‰ç§ç±»å‹ï¼Œæ³¨ï¼šå‡†ç¡®æ¥è¯´ï¼Œè¿˜æœ‰å¸ƒå°”ç±»å‹ï¼ˆBoolï¼‰ï¼Œä½†ç”±äºæ²¡æœ‰ trueã€falseï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ç”¨æ•´å‹ï¼ˆUInt8ï¼‰è¡¨ç¤ºå¸ƒå°”ç±»å‹ï¼Œ1 ä¸ºçœŸ 0 ä¸ºå‡ã€‚</strong></p>
<h4 id="æ•°å€¼ç±»å‹"><a href="#æ•°å€¼ç±»å‹" class="headerlink" title="æ•°å€¼ç±»å‹"></a>æ•°å€¼ç±»å‹</h4><p><strong>æ•°å€¼ç±»å‹åˆ†ä¸ºæ•´æ•°ã€æµ®ç‚¹æ•°å’Œ Decimal ä¸‰ç±»ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«è¿›è¡Œè¯´æ˜ã€‚</strong></p>
<p><strong>1ï¼‰Int</strong></p>
<p><strong>åœ¨æ™®éè§‚å¿µä¸­ï¼Œå¸¸ç”¨ Tinyintã€Smallintã€Int å’Œ Bigint æŒ‡ä»£æ•´æ•°çš„ä¸åŒå–å€¼èŒƒå›´ï¼Œè€Œ ClickHouse åˆ™ç›´æ¥ä½¿ç”¨ Int8ã€Int16ã€Int32ã€Int64 æ¥æŒ‡ä»£ 4 ç§å¤§å°çš„ Int ç±»å‹ï¼Œå…¶æœ«å°¾çš„æ•°å­—åˆ™è¡¨ç¤ºè¯¥ç±»å‹çš„æ•´æ•°å å¤šå°‘ä½ã€‚å¯ä»¥è®¤ä¸ºï¼šInt8 ç­‰ä»·äº Tinyintã€Int16 ç­‰ä»·äº Smallintã€Int32 ç­‰ä»·äº Intã€Int64 ç­‰ä»·äº Bigintã€‚</strong></p>
<p><strong>ClickHouse ä¹Ÿæ”¯æŒæ— ç¬¦å·çš„æ•´æ•°ï¼Œä½¿ç”¨å‰ç¼€ U è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼šUInt8ã€UInt16ã€UInt32ã€UInt64ã€‚</strong></p>
<p><strong>2ï¼‰Float</strong></p>
<p><strong>ä¸æ•´æ•°ç±»ä¼¼ï¼ŒClickHouse ç›´æ¥ä½¿ç”¨ Float32 å’Œ Float64 ä»£è¡¨å•ç²¾åº¦æµ®ç‚¹æ•°å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œå¯ä»¥çœ‹æˆæ˜¯ float å’Œ doubleã€‚</strong></p>
<p><strong>ClickHouse çš„æµ®ç‚¹æ•°æ”¯æŒæ­£æ— ç©·ã€è´Ÿæ— ç©·ä»¥åŠéæ•°å­—çš„è¡¨è¾¾æ–¹å¼ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> <span class="number">1</span> <span class="operator">/</span> <span class="number">0</span>, <span class="number">-1</span> <span class="operator">/</span> <span class="number">0</span>, <span class="number">0</span> <span class="operator">/</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="operator">/</span> <span class="number">0</span>,</span><br><span class="line">    <span class="number">-1</span> <span class="operator">/</span> <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span> <span class="operator">/</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query id: e3b3712c<span class="number">-0506</span><span class="number">-4</span>b3b<span class="operator">-</span>b2d8<span class="number">-7</span>f936c548740</span><br><span class="line"></span><br><span class="line">â”Œâ”€divide(<span class="number">1</span>, <span class="number">0</span>)â”€â”¬â”€divide(<span class="number">-1</span>, <span class="number">0</span>)â”€â”¬â”€divide(<span class="number">0</span>, <span class="number">0</span>)â”€â”</span><br><span class="line">â”‚          inf â”‚          <span class="operator">-</span>inf â”‚          nan â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰Decimal</strong></p>
<p><strong>å¦‚æœè¦æ±‚é«˜ç²¾åº¦çš„æ•°å€¼è¿ç®—ï¼Œåˆ™éœ€è¦ä½¿ç”¨Decimalã€å³å®šç‚¹æ•°ï¼ˆç±»ä¼¼äºæµ®ç‚¹æ•°ï¼‰ï¼ŒClickHouse æä¾›äº† Decimal32ã€Decimal64 å’Œ Decimal128 ä¸‰ç§ç²¾åº¦çš„Decimalã€‚åœ¨å®šä¹‰è¡¨å­—æ®µçš„ç±»å‹æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§å½¢å¼å£°æ˜ï¼šç®€å†™æ–¹å¼æœ‰ Decimal32(S)ã€Decimal64(S)ã€Decimal128(S) ä¸‰ç§ï¼ŒåŸç”Ÿæ–¹å¼ä¸º Decimal(P, S)ï¼Œè¡¨ç¤ºè¯¥å®šç‚¹æ•°çš„æ•´æ•°ä½åŠ ä¸Šå°æ•°ä½çš„æ€»é•¿åº¦æœ€å¤§ä¸º Pï¼Œå…¶ä¸­å°æ•°ä½é•¿åº¦æœ€å¤šä¸º Sã€‚Decimal32 çš„ P ä¸º 10ã€Decimal64 çš„ P ä¸º 19ã€Decimal128 çš„ P ä¸º 39ã€‚æ¯”å¦‚æŸä¸ªå­—æ®µç±»å‹æ˜¯ Decimal32(3)ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯¥å­—æ®µå­˜å‚¨çš„å®šç‚¹æ•°ï¼Œå…¶æ•´æ•°ä½åŠ ä¸Šå°æ•°ä½çš„æ€»é•¿åº¦ä¸è¶…è¿‡ 10ï¼Œå…¶ä¸­å°æ•°éƒ¨åˆ†å¦‚æœè¶…è¿‡ 3 ä½åˆ™åªä¿ç•™ 3 ä½ã€‚</strong></p>
<p><strong>è€Œåœ¨ SQL ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ toDecimal32 æˆ– toDecimal64 å°†ä¸€ä¸ªæ•´æ•°æˆ–æµ®ç‚¹æ•°å˜æˆå®šç‚¹æ•°ï¼Œæ¯”å¦‚ï¼štoDecimal32(2, 5) å¾—åˆ°çš„ç»“æœå°±æ˜¯ 2.00000ã€‚å¦å¤–ä½¿ç”¨ä¸¤ä¸ªä¸åŒç²¾åº¦çš„ Decimal è¿›è¡Œå››åˆ™è¿œç®—çš„æ—¶å€™ï¼Œå®ƒä»¬çš„å°æ•°ç‚¹ä½æ•°ä¼š S å‘ç”Ÿå˜åŒ–ã€‚åœ¨è¿›è¡ŒåŠ æ³•å’Œå‡æ³•è¿ç®—æ—¶ï¼ŒS å–æœ€å¤§å€¼ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> toDecimal32(<span class="number">22</span>, <span class="number">3</span>) <span class="operator">+</span> toDecimal32(<span class="number">33</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> toDecimal32(<span class="number">22</span>, <span class="number">3</span>) <span class="operator">+</span> toDecimal32(<span class="number">33</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Query id: a223565d<span class="operator">-</span>e6ba<span class="number">-4</span>db9<span class="operator">-</span>aa7d<span class="number">-1</span>cae37424128</span><br><span class="line"></span><br><span class="line">â”Œâ”€plus(toDecimal32(<span class="number">22</span>, <span class="number">3</span>), toDecimal32(<span class="number">33</span>, <span class="number">2</span>))â”€â”</span><br><span class="line">â”‚                                       <span class="number">55.000</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨è¿›è¡Œä¹˜æ³•è¿ç®—æ—¶ï¼ŒS å–ä¸¤è€…ä¹‹å’Œï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> toDecimal32(<span class="number">22</span>, <span class="number">3</span>) <span class="operator">*</span> toDecimal32(<span class="number">33</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> toDecimal32(<span class="number">22</span>, <span class="number">3</span>) <span class="operator">*</span> toDecimal32(<span class="number">33</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">0</span>f1bd695<span class="number">-9</span>f37<span class="number">-43</span>b4<span class="operator">-</span>a6d1<span class="operator">-</span>b2a62a1dd6c3</span><br><span class="line"></span><br><span class="line">â”Œâ”€multiply(toDecimal32(<span class="number">22</span>, <span class="number">3</span>), toDecimal32(<span class="number">33</span>, <span class="number">2</span>))â”€â”</span><br><span class="line">â”‚                                        <span class="number">726.00000</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨è¿›è¡Œé™¤æ³•è¿ç®—æ—¶ï¼ŒS å–è¢«é™¤æ•°çš„å€¼ï¼Œæ­¤æ—¶è¦æ±‚è¢«é™¤æ•°çš„ S å¿…é¡»å¤§äºé™¤æ•° Sï¼Œå¦åˆ™æŠ¥é”™ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> toDecimal64(<span class="number">6</span>, <span class="number">3</span>) <span class="operator">/</span>  toDecimal64(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> toDecimal64(<span class="number">6</span>, <span class="number">3</span>) <span class="operator">/</span> toDecimal64(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">55</span>b4a58f<span class="operator">-</span>b722<span class="number">-4487</span><span class="number">-8391</span><span class="number">-2</span>c08e6c764ca</span><br><span class="line"></span><br><span class="line">â”Œâ”€divide(toDecimal64(<span class="number">6</span>, <span class="number">3</span>), toDecimal64(<span class="number">3</span>, <span class="number">2</span>))â”€â”</span><br><span class="line">â”‚                                        <span class="number">2.000</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :) <span class="keyword">select</span> toDecimal64(<span class="number">6</span>, <span class="number">3</span>) <span class="operator">/</span>  toDecimal64(<span class="number">3</span>, <span class="number">4</span>)  <span class="comment">-- è¿™é‡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¢«é™¤æ•°çš„ S å°äºé™¤æ•°çš„ S</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> toDecimal64(<span class="number">6</span>, <span class="number">3</span>) <span class="operator">/</span> toDecimal64(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">6</span>f782411<span class="number">-0</span>d15<span class="number">-4</span>ab8<span class="operator">-</span>adab<span class="operator">-</span>be19c9f6b0e2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec.</span><br><span class="line"></span><br><span class="line">Received exception <span class="keyword">from</span> server (version <span class="number">21.7</span><span class="number">.3</span>):</span><br><span class="line">Code: <span class="number">69.</span> DB::Exception: Received <span class="keyword">from</span> localhost:<span class="number">9000.</span> DB::Exception:</span><br><span class="line"><span class="type">Decimal</span> <span class="keyword">result</span><span class="string">&#x27;s scale is less than argument&#x27;</span>s <span class="keyword">one</span>: While processing toDecimal64(<span class="number">6</span>, <span class="number">3</span>) <span class="operator">/</span> toDecimal64(<span class="number">3</span>, <span class="number">4</span>).</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤–è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šç”±äºç°ä»£è®¡ç®—æœºç³»ç»Ÿåªæ”¯æŒ 32 æˆ–è€… 64 ä½ï¼Œæ‰€ä»¥ Decimal128 æ˜¯åœ¨è½¯ä»¶å±‚é¢æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œå®ƒçš„é€Ÿåº¦ä¼šæ¯” Decimal32ã€Decimal64 è¦æ…¢ã€‚</strong></p>
<h4 id="å­—ç¬¦ä¸²ç±»å‹"><a href="#å­—ç¬¦ä¸²ç±»å‹" class="headerlink" title="å­—ç¬¦ä¸²ç±»å‹"></a>å­—ç¬¦ä¸²ç±»å‹</h4><p><strong>å­—ç¬¦ä¸²ç±»å‹å¯ä»¥ç»†åˆ†ä¸º Stringã€FixedString å’Œ UUID ä¸‰ç±»ï¼Œä»å‘½åæ¥çœ‹ä»¿ä½›ä¸åƒæ˜¯ä¸€æ¬¾æ•°æ®åº“æä¾›çš„ç±»å‹ï¼Œåå€’åƒä¸€é—¨ç¼–ç¨‹è¯­è¨€çš„è®¾è®¡ã€‚</strong></p>
<p><strong>1ï¼‰String</strong></p>
<p><strong>å­—ç¬¦ä¸²ç”± String å®šä¹‰ï¼Œé•¿åº¦ä¸é™ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ String çš„æ—¶å€™æ— éœ€å£°æ˜å¤§å°ã€‚å®ƒå®Œå…¨ä»£æ›¿äº†ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ Varcharã€Textã€Clob å’Œ Blob ç­‰å­—ç¬¦ç±»å‹ã€‚String ç±»å‹ä¸é™å®šå­—ç¬¦é›†ï¼Œå› ä¸ºå®ƒæ ¹æœ¬æ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥å¯ä»¥å°†ä»»æ„ç¼–ç çš„å­—ç¬¦ä¸²å­˜å…¥å…¶ä¸­ã€‚ä½†æ˜¯ä¸ºäº†ç¨‹åºçš„è§„èŒƒæ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œåœ¨åŒä¸€å¥—ç¨‹åºä¸­ä½¿ç”¨ç»Ÿä¸€çš„ç¼–ç ï¼Œæ¯”å¦‚ utf-8ï¼Œå°±æ˜¯ä¸€ç§å¾ˆå¥½çš„çº¦å®šã€‚</strong></p>
<p><strong>2ï¼‰FiexedString</strong></p>
<p><strong>FixedString ç±»å‹å’Œä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ Char ç±»å‹æœ‰äº›ç±»ä¼¼ï¼Œå¯¹äºä¸€äº›æœ‰ç€æ˜ç¡®é•¿åº¦çš„åœºåˆï¼Œå¯ä»¥ä½¿ç”¨ FixedString(N) æ¥å£°æ˜å›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²ã€‚ä½†ä¸ char ä¸åŒçš„æ˜¯ï¼ŒFixedString ä½¿ç”¨ NULL å­—èŠ‚æ¥å¡«å……æœ«å°¾å­—ç¬¦ï¼Œè€Œ char é€šå¸¸ä½¿ç”¨ç©ºæ ¼å¡«å……ã€‚</strong></p>
<p><strong>å¯ä»¥ä½¿ç”¨ toFixedString ç”Ÿæˆ FixedStringã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>), length(toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>),</span><br><span class="line">    length(toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>))</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">45</span>fe6e26<span class="number">-0540</span><span class="number">-40</span>de<span class="number">-9</span>eaf<span class="operator">-</span>aeefd12a3a1b</span><br><span class="line"></span><br><span class="line">â”Œâ”€toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>)â”€â”¬â”€length(toFixedString(<span class="string">&#x27;satori&#x27;</span>, <span class="number">7</span>))â”€â”</span><br><span class="line">â”‚ satori                     â”‚                                  <span class="number">7</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰UUID</strong></p>
<p><strong>UUID æ˜¯ä¸€ç§æ•°æ®åº“å¸¸è§çš„ä¸»é”®ç±»å‹ï¼Œåœ¨ ClickHouse ä¸­ç›´æ¥æŠŠå®ƒä½œä¸ºä¸€ç§æ•°æ®ç±»å‹ã€‚UUID å…±æœ‰ 32 ä½ï¼Œå®ƒçš„æ ¼å¼ä¸º 8-4-4-4-12ã€‚å¦‚æœä¸€ä¸ª UUID ç±»å‹çš„å­—æ®µåœ¨å†™å…¥æ•°æ®çš„æ—¶å€™æ²¡æœ‰è¢«èµ‹å€¼ï¼Œé‚£ä¹ˆå®ƒä¼šæŒ‰ç…§ç›¸åº”æ ¼å¼ç”¨ 0 å¡«å……ã€‚</strong></p>
<h4 id="æ—¶é—´ç±»å‹"><a href="#æ—¶é—´ç±»å‹" class="headerlink" title="æ—¶é—´ç±»å‹"></a>æ—¶é—´ç±»å‹</h4><p><strong>æ—¶é—´ç±»å‹åˆ†ä¸º DateTimeã€DateTime64 å’Œ Dateä¸‰ç±»ã€‚</strong></p>
<p><strong>1ï¼‰DateTime</strong></p>
<p><strong>DateTime ç±»å‹åŒ…å«å¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ä¿¡æ¯ï¼Œç²¾ç¡®åˆ°ç§’ï¼Œæ”¯æŒä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹å¼å†™å…¥ï¼›</strong></p>
<p><strong>2ï¼‰DateTime64</strong></p>
<p><strong>DateTime64 å¯ä»¥è®°å½•äºšç§’ï¼Œå®ƒåœ¨ DateTime ä¹‹ä¸Šå¢åŠ äº†ç²¾åº¦çš„è®¾ç½®ã€‚ä¸¾ä¸ªæ —å­ï¼šDateTime64 ç±»å‹çš„æ—¶é—´å¯ä»¥æ˜¯ 2018-01-01 12:12:32.22ï¼›ä½†å¦‚æœæ˜¯ DateTime çš„è¯ï¼Œåˆ™æ˜¯2018-01-01 12:12:32ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€åçš„ .22 æ²¡äº†ã€‚</strong></p>
<p><strong>3ï¼‰Date</strong></p>
<p><strong>Date ç±»å‹ä¸åŒ…å«å…·ä½“çš„æ—¶é—´ä¿¡æ¯ï¼Œåªç²¾ç¡®åˆ°å¤©ï¼Œå¹¶ä¸”å’Œ DateTimeã€DateTime64 ä¸€æ ·ï¼Œæ”¯æŒå­—ç¬¦ä¸²å†™å…¥ã€‚</strong></p>
<h3 id="å¤åˆç±»å‹"><a href="#å¤åˆç±»å‹" class="headerlink" title="å¤åˆç±»å‹"></a>å¤åˆç±»å‹</h3><p><strong>é™¤äº†åŸºç¡€æ•°æ®ç±»å‹ä¹‹å¤–ï¼ŒClickHouse è¿˜æä¾›äº†æ•°ç»„ã€å…ƒç»„ã€æšä¸¾å’ŒåµŒå¥—ï¼Œæ€»å…±å››ç§å¤åˆç±»å‹ã€‚è¿™äº›ç±»å‹é€šå¸¸éƒ½æ˜¯å…¶ä»–æ•°æ®åº“åŸç”Ÿä¸å…·å¤‡çš„ç‰¹æ€§ï¼Œæ‹¥æœ‰äº†å¤åˆç±»å‹ä¹‹åï¼ŒClickHouse çš„æ•°æ®æ¨¡å‹è¡¨è¾¾èƒ½åŠ›å°±æ›´å¼ºäº†ã€‚</strong></p>
<h4 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h4><p><strong>æ•°æ®æœ‰ä¸¤ç§å®šä¹‰å½¢å¼ï¼Œå¸¸è§„æ–¹å¼ Array(T)ï¼Œæ¯”å¦‚æŸä¸ªå­—æ®µæ˜¯åŒ…å« UInt8 çš„æ•°ç»„ï¼Œé‚£ä¹ˆå°±å¯ä»¥å£°æ˜ä¸º Array(UInt8)ï¼›éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒClickHouse ä¸­çš„ç±»å‹æ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼Œæ¯”å¦‚è¿™é‡Œçš„ Array å°±ä¸å¯ä»¥å†™æˆ arrayï¼ŒUInt8 ä¸å¯ä»¥å†™æˆ uint8ã€‚</strong></p>
<p><strong>å½“ç„¶åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ array å‡½æ•°åˆ›å»ºä¸€ä¸ªæ•°ç»„ã€‚æ³¨æ„ï¼šClickHouse ä¸­çš„ç»å¤§éƒ¨åˆ†å‡½æ•°ä¹Ÿæ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼Œåªè¦æ˜¯ä½ åœ¨å…¶å®ƒå…³ç³»å‹æ•°æ®åº“ä¸­æ²¡æœ‰è§è¿‡çš„å‡½æ•°ï¼ŒåŸºæœ¬ä¸Šéƒ½åŒºåˆ†å¤§å°å†™ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>) <span class="keyword">as</span> a, toTypeName(a)  <span class="comment">-- toTypeName è¡¨ç¤ºè·å–å­—æ®µçš„ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>] <span class="keyword">AS</span> a,</span><br><span class="line">    toTypeName(a)</span><br><span class="line"></span><br><span class="line">Query id: b22e371f<span class="operator">-</span>d5fc<span class="number">-4245</span><span class="operator">-</span>b299<span class="operator">-</span>a79a344fc7ea</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”€â”€â”€â”€â”¬â”€toTypeName(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>))â”€â”</span><br><span class="line">â”‚ [<span class="number">1</span>,<span class="number">2</span>] â”‚ <span class="keyword">Array</span>(UInt8)            â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>è¿™é‡Œåªæ˜¯æ¼”ç¤ºï¼Œå…³äºå…·ä½“çš„è¯­æ³•åé¢è¯´ï¼Œ</strong></p>
</blockquote>
<p><strong>åœ¨æŸ¥è¯¢çš„æ—¶å€™ç®€å†™æˆ [v1, v2, v3, â€¦] ä¹Ÿæ˜¯å¯ä»¥çš„ï¼›</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> [<span class="number">1</span>, <span class="number">2</span>] <span class="keyword">as</span> a, toTypeName(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>] <span class="keyword">AS</span> a,</span><br><span class="line">    toTypeName(a)</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">50</span>d4e367<span class="operator">-</span>cd1b<span class="number">-4826</span><span class="operator">-</span>bca8<span class="operator">-</span>eb913e6fbaeb</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”€â”€â”€â”€â”¬â”€toTypeName([<span class="number">1</span>, <span class="number">2</span>])â”€â”</span><br><span class="line">â”‚ [<span class="number">1</span>,<span class="number">2</span>] â”‚ <span class="keyword">Array</span>(UInt8)       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>ä»ä¸Šè¿°çš„ä¾‹å­ä¸­å¯ä»¥å‘ç°ï¼Œåœ¨æŸ¥è¯¢æ—¶å¹¶ä¸éœ€è¦ä¸»åŠ¨å£°æ˜æ•°æ®çš„å…ƒç´ ç±»å‹ï¼Œå› ä¸º ClickHouse çš„æ•°ç»„æ‹¥æœ‰ç±»å‹æ¨æ–­çš„èƒ½åŠ›ï¼Œæ¨æ–­çš„ä¾æ®æ˜¯ï¼šä»¥æœ€å°å­˜å‚¨ä»£ä»·ä¸ºåŸåˆ™ï¼Œå³ä½¿ç”¨æœ€å°å¯è¡¨è¾¾çš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚ï¼š<code>array(1, 2)</code> ä¼šä½¿ç”¨ UInt8 ä½œä¸ºæ•°ç»„ç±»å‹ã€‚ä½†å¦‚æœæ•°ç»„ä¸­å­˜åœ¨ NULL å€¼ï¼Œå…ƒç´ ç±»å‹å°†å˜ä¸º Nullableã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">select</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">NULL</span>] <span class="keyword">as</span> a, toTypeName(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">NULL</span>] <span class="keyword">AS</span> a,</span><br><span class="line">    toTypeName(a)</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">95</span>eb5bfa<span class="number">-5008</span><span class="number">-4</span>bd0<span class="operator">-</span>ac94<span class="operator">-</span>bd2e39de6485</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€toTypeName([<span class="number">1</span>, <span class="number">2</span>, <span class="keyword">NULL</span>])â”€â”</span><br><span class="line">â”‚ [<span class="number">1</span>,<span class="number">2</span>,<span class="keyword">NULL</span>] â”‚ <span class="keyword">Array</span>(Nullable(UInt8))   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>æ•°ç»„é‡Œé¢çš„å…ƒç´ å¯ä»¥æœ‰å¤šç§ï¼Œä½†å‰ææ˜¯å®ƒä»¬å¿…é¡»èƒ½å¤Ÿå…¼å®¹ï¼Œæ¯”å¦‚ï¼š<code>[1, 2.13]</code> å¯ä»¥ï¼Œä½†æ˜¯ <code>[1, &#39;ABC&#39;]</code> åˆ™ä¸è¡Œã€‚è€Œåœ¨å®šä¹‰è¡¨å­—æ®µçš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨ Array ç±»å‹ï¼Œåˆ™éœ€è¦æŒ‡å®šæ˜ç¡®çš„å…ƒç´ ç±»å‹ï¼Œæ¯”å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">	arr <span class="keyword">Array</span>(String)  <span class="comment">--æŒ‡å®šæ˜ç¡®ç±»å‹</span></span><br><span class="line">) ENGINE <span class="operator">=</span> Memory</span><br></pre></td></tr></table></figure>

<h4 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h4><p><strong>å…ƒç»„ç”± 1 ~ n ä¸ªå…ƒç´ ç»„æˆï¼Œæ¯ä¸ªå…ƒç´ ä¹‹é—´å…è®¸è®¾ç½®ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œä¸”å½¼æ­¤ä¹‹é—´ä¸è¦æ±‚å…¼å®¹ã€‚å…ƒç»„åŒæ ·æ”¯æŒç±»å‹æ¨æ–­ï¼Œå…¶æ¨æ–­ä¾æ®ä»ç„¶æ˜¯ä»¥æœ€å°å­˜å‚¨ä»£ä»·ä¸ºåŸåˆ™ã€‚ä¸æ•°ç»„ç±»ä¼¼ï¼Œåœ¨ SQL ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ Tuple(T) æ¥å®šä¹‰ã€‚</strong></p>
<p><strong>ç±»ä¼¼æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tuple å‡½æ•°åœ¨æŸ¥è¯¢çš„æ—¶å€™åˆ›å»ºå…ƒç»„ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">satori :) <span class="keyword">SELECT</span> tuple(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>, now()) <span class="keyword">as</span> a, (<span class="number">1</span>, <span class="number">3</span>, <span class="string">&#x27;666&#x27;</span>) <span class="keyword">as</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    (<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>, now()) <span class="keyword">AS</span> a,</span><br><span class="line">    (<span class="number">1</span>, <span class="number">3</span>, <span class="string">&#x27;666&#x27;</span>) <span class="keyword">AS</span> b</span><br><span class="line"></span><br><span class="line">Query id: ab97ea39<span class="operator">-</span>accd<span class="number">-4</span>eaa<span class="number">-85</span>b0<span class="operator">-</span>c1728fde57e4</span><br><span class="line"></span><br><span class="line">â”Œâ”€aâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€bâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ (<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;2021-08-05 01:10:07&#x27;</span>) â”‚ (<span class="number">1</span>,<span class="number">3</span>,<span class="string">&#x27;666&#x27;</span>) â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.002</span> sec.</span><br><span class="line"></span><br><span class="line">satori :)</span><br></pre></td></tr></table></figure>

<p><strong>å…³äºæ•°ç»„å’Œå…ƒç»„çš„åŒºåˆ«ï¼Œç†Ÿæ‚‰ Python çš„è¯åº”è¯¥å¾ˆæ¸…æ¥šï¼Œç­”æ¡ˆæ˜¯å…ƒç»„ä¸å¯å˜ã€‚åœ¨å®šä¹‰è¡¨å­—æ®µæ—¶ï¼Œå…ƒç»„ä¹Ÿéœ€è¦æŒ‡å®šæ˜ç¡®çš„å…ƒç´ ç±»å‹ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">    <span class="comment">-- å¯ä»¥æŒ‡å®šå¤šä¸ªç±»å‹</span></span><br><span class="line">    <span class="comment">-- ä½†æ˜¯æ³¨æ„ï¼šTuple(String, Int8) è¡¨ç¤º tpl å­—æ®µçš„å€¼åªèƒ½æ˜¯å«æœ‰ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„</span></span><br><span class="line">    <span class="comment">-- å¹¶ä¸”ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º Stringï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸º Int8</span></span><br><span class="line">    tpl Tuple(String, Int8)</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory</span><br></pre></td></tr></table></figure>

<p><strong>è€Œåœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œå†™å…¥ <code>(&#39;abc&#39;, 123)</code> æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ <code>(&#39;abc&#39;, &#39;def&#39;)</code> åˆ™æŠ¥é”™ã€‚</strong></p>
<h4 id="Enum"><a href="#Enum" class="headerlink" title="Enum"></a>Enum</h4><p><strong>ClickHouse æ”¯æŒæšä¸¾ç±»å‹ï¼Œè¿™æ˜¯ä¸€ç§åœ¨å®šä¹‰å¸¸é‡æ—¶ç»å¸¸ä¼šä½¿ç”¨çš„æ•°æ®ç±»å‹ã€‚ClickHouse æä¾›äº† Enum8 å’Œ Enum16 ä¸¤ç§æšä¸¾ç±»å‹ï¼Œå®ƒä»¬ä¹‹é—´é™¤äº†å–å€¼èŒƒå›´ä¸åŒä¹‹å¤–ï¼Œåˆ«æ— äºŒè‡´ã€‚æšä¸¾å›ºå®šä½¿ç”¨ <code>(String:Int)</code> é”®å€¼å¯¹çš„å½¢å¼å®šä¹‰æ•°æ®ï¼Œæ‰€ä»¥ Enum8 å’Œ Enum16 åˆ†åˆ«ä¼šå¯¹åº” (String:Int8) å’Œ (String:Int16)ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name(</span><br><span class="line">	e Enum(<span class="string">&#x27;ready&#x27;</span><span class="operator">=</span><span class="number">1</span>, <span class="string">&#x27;start&#x27;</span><span class="operator">=</span><span class="number">2</span>, <span class="string">&#x27;success&#x27;</span><span class="operator">=</span><span class="number">3</span>, <span class="string">&#x27;error&#x27;</span><span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨å®šä¹‰æšä¸¾é›†åˆçš„æ—¶å€™ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚é¦–å…ˆï¼ŒKey å’Œ Value æ˜¯ä¸å…è®¸é‡å¤çš„ï¼Œè¦ä¿è¯å”¯ä¸€æ€§ã€‚å…¶æ¬¡ï¼ŒKey å’Œ Value çš„å€¼éƒ½ä¸èƒ½ä¸º Nullï¼Œä½† Key å…è®¸ä¸ºç©ºå­—ç¬¦ä¸²ã€‚åœ¨å†™å…¥æšä¸¾æ•°æ®çš„æ—¶å€™ï¼Œåªä¼šç”¨åˆ° Key å­—ç¬¦ä¸²éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name <span class="keyword">VALUES</span>(<span class="string">&#x27;ready&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤–åœ¨æ•°æ®å†™å…¥çš„æ—¶å€™ï¼Œä¼šå¯¹ç…§æšä¸¾é›†åˆé¡¹çš„å†…å®¹è¿›è¡Œé€ä¸€æ£€æŸ¥ï¼Œå¦‚æœ Key å­—ç¬¦ä¸²ä¸å­˜åœ¨é›†åˆèŒƒå›´å†…åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ¯”å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥å°±ä¼šæŠ¥é”™ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name <span class="keyword">VALUES</span>(<span class="string">&#x27;abc&#x27;</span>)  <span class="comment">-- ä¼šæŠ¥é”™</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯èƒ½æœ‰äººè§‰å¾—ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨ String ä»£æ›¿æšä¸¾ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸“é—¨å®ç°æšä¸¾ç±»å‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å‡ºäºå¯¹æ€§èƒ½çš„è€ƒè™‘ã€‚å› ä¸ºè™½ç„¶æšä¸¾ä¸­å®šä¹‰çš„ Key æ˜¯å±äº String ç±»å‹ï¼Œä½†æ˜¯åœ¨åç»­å¯¹æšä¸¾çš„æ‰€æœ‰æ“ä½œä¸­ï¼ˆåŒ…æ‹¬æ’åºã€åˆ†å­ã€å»é‡ã€è¿‡æ»¤ç­‰ï¼‰ï¼Œä¼šä½¿ç”¨ Int ç±»å‹çš„ Value å€¼ã€‚</strong></p>
<h4 id="Nested"><a href="#Nested" class="headerlink" title="Nested"></a>Nested</h4><p><strong>åµŒå¥—ç±»å‹ï¼Œé¡¾åæ€ä¹‰æ˜¯ä¸€ç§åµŒå¥—è¡¨ç»“æ„ã€‚ä¸€å¼ æ•°æ®è¡¨ï¼Œå¯ä»¥å®šä¹‰ä»»æ„å¤šä¸ªåµŒå¥—ç±»å‹å­—æ®µï¼Œä½†æ¯ä¸ªå­—æ®µçš„åµŒå¥—å±‚çº§åªæ”¯æŒä¸€çº§ï¼Œå³åµŒå¥—è¡¨å†…ä¸èƒ½ç»§ç»­ä½¿ç”¨åµŒå¥—ç±»å‹ã€‚å¯¹äºç®€å•åœºæ™¯çš„å±‚çº§å…³ç³»æˆ–å…³è”å…³ç³»ï¼Œä½¿ç”¨åµŒå¥—ç±»å‹ä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸‹é¢åˆ›å»ºä¸€å¼ è¡¨ nested_testï¼Œå…·ä½“çš„å»ºè¡¨é€»è¾‘åé¢ä¼šè¯´ï¼Œå½“ç„¶æœ¬èº«ä¹Ÿä¸æ˜¯ç‰¹åˆ«éš¾çš„ä¸œè¥¿ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> nested_test (</span><br><span class="line">    name String,</span><br><span class="line">    age UInt8,</span><br><span class="line">    dept Nested(</span><br><span class="line">        id UInt32,</span><br><span class="line">        name String</span><br><span class="line">    )</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory;</span><br></pre></td></tr></table></figure>

<p><strong>ClickHouse çš„åµŒå¥—ç±»å‹å’Œä¼ ç»Ÿçš„åµŒå¥—ç±»å‹ä¸ç›¸åŒï¼Œå¯¼è‡´åœ¨åˆæ¬¡æ¥è§¦å®ƒçš„æ—¶å€™ä¼šè®©äººååˆ†å›°æƒ‘ã€‚ä»¥ä¸Šé¢è¿™å¼ è¡¨ä¸ºä¾‹ï¼Œå¦‚æœæŒ‰ç…§å®ƒçš„å­—é¢æ„æ€æ¥ç†è§£ï¼Œä¼šå¾ˆå®¹æ˜“ç†è§£æˆ nested_test ä¸ dept æ˜¯ä¸€å¯¹ä¸€çš„åŒ…å«å…³ç³»ï¼Œå…¶å®è¿™æ˜¯é”™è¯¯çš„ã€‚ä¸ä¿¡å¯ä»¥æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œçœ‹çœ‹ä¼šæ˜¯ä»€ä¹ˆç»“æœ:</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B(%E4%B8%89)/1229382-20210816173421844-1247165096.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°æŠ¥é”™äº†ï¼Œç°åœ¨å¤§å®¶åº”è¯¥æ˜ç™½äº†ï¼ŒåµŒå¥—ç±»å‹æœ¬è´¨æ˜¯ä¸€ç§å¤šç»´æ•°ç»„çš„ç»“æ„ã€‚åµŒå¥—è¡¨ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”è¡Œä¸è¡Œä¹‹é—´æ•°ç»„çš„é•¿åº¦æ— é¡»å¯¹é½ã€‚æ‰€ä»¥éœ€è¦æŠŠåˆšæ‰çš„ INSERT è¯­å¥è°ƒæ•´æˆä¸‹é¢çš„å½¢å¼:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> nested_test <span class="keyword">VALUES</span>(<span class="string">&#x27;nana&#x27;</span>, <span class="number">20</span>, [<span class="number">10000</span>, <span class="number">10001</span>, <span class="number">10002</span>], [<span class="string">&#x27;å”è¾›å­&#x27;</span>, <span class="string">&#x27;ãªãªã‹ãã‚‰&#x27;</span>, <span class="string">&#x27;ã‚´ã‚¦ãƒ&#x27;</span>]);</span><br><span class="line"><span class="comment">-- è¡Œä¸è¡Œä¹‹é—´ï¼Œæ•°ç»„é•¿åº¦æ— éœ€å¯¹é½ã€‚</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> nested_test <span class="keyword">VALUES</span>(<span class="string">&#x27;nana&#x27;</span>, <span class="number">20</span>, [<span class="number">10000</span>, <span class="number">10001</span>], [<span class="string">&#x27;å”è¾›å­&#x27;</span>, <span class="string">&#x27;ãªãªã‹ãã‚‰&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B(%E4%B8%89)/1229382-20210816173429946-443566030.png" alt="img"></p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åŒä¸€è¡Œæ•°æ®å†…æ¯ä¸ªæ•°ç»„å­—æ®µçš„é•¿åº¦å¿…é¡»ç›¸ç­‰ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œç”±äºè¡Œå†…æ•°ç»„å­—æ®µçš„é•¿åº¦æ²¡æœ‰å¯¹é½ï¼Œæ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B(%E4%B8%89)/1229382-20210816173436084-896104477.png" alt="img"></p>
<p><strong>æç¤ºæˆ‘ä»¬é•¿åº¦ä¸ä¸€æ ·ã€‚</strong></p>
<p><strong>åœ¨è®¿é—®åµŒå¥—ç±»å‹çš„æ•°æ®æ—¶éœ€è¦ä½¿ç”¨ç‚¹ç¬¦å·ï¼Œä¾‹å¦‚:</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B(%E4%B8%89)/1229382-20210816173442804-826048657.png" alt="img"></p>
<h3 id="ç‰¹æ®Šç±»å‹"><a href="#ç‰¹æ®Šç±»å‹" class="headerlink" title="ç‰¹æ®Šç±»å‹"></a>ç‰¹æ®Šç±»å‹</h3><p><strong>ClickHouse è¿˜æœ‰ä¸€ç±»ä¸åŒå¯»å¸¸çš„æ•°æ®ç±»å‹ï¼Œå°†å®ƒä»¬å®šä¹‰ä¸ºç‰¹æ®Šç±»å‹ã€‚</strong></p>
<h4 id="Nullable"><a href="#Nullable" class="headerlink" title="Nullable"></a>Nullable</h4><p><strong>å‡†ç¡®æ¥è¯´ï¼ŒNullable å¹¶ä¸èƒ½ç®—æ˜¯ä¸€ç§ç‹¬ç«‹çš„æ•°æ®ç±»å‹ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ç§è¾…åŠ©çš„ä¿®é¥°ç¬¦ï¼Œéœ€è¦ä¸åŸºç¡€æ•°æ®ç±»å‹ä¸€èµ·æ­é…ä½¿ç”¨ã€‚Nullable ç±»å‹ä¸ Python ç±»å‹æ³¨è§£é‡Œé¢çš„ Optional æœ‰äº›ç›¸ä¼¼ï¼Œå®ƒè¡¨ç¤ºæŸä¸ªåŸºç¡€æ•°æ®ç±»å‹å¯ä»¥æ˜¯ NULL å€¼ã€‚å…¶å…·ä½“ç”¨æ³•å¦‚ä¸‹æ‰€ç¤º:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> null_test (</span><br><span class="line">    col1 String,</span><br><span class="line">    col2 Nullable(UInt8)</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ Nullable ä¿®é¥°å col2 å­—æ®µå¯ä»¥è¢«å†™å…¥ NULL å€¼:</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> null_test <span class="keyword">VALUES</span> (<span class="string">&#x27;nana&#x27;</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨ä½¿ç”¨ Nullable ç±»å‹çš„æ—¶å€™è¿˜æœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼šé¦–å…ˆï¼Œå®ƒåªèƒ½å’ŒåŸºç¡€ç±»å‹æ­é…ä½¿ç”¨ï¼Œä¸èƒ½ç”¨äºæ•°ç»„å’Œå…ƒç»„è¿™äº›å¤åˆç±»å‹ï¼Œä¹Ÿä¸èƒ½ä½œä¸ºç´¢å¼•å­—æ®µï¼›å…¶æ¬¡ï¼Œåº”è¯¥æ…ç”¨ Nullable ç±»å‹ï¼ŒåŒ…æ‹¬ Nullable çš„æ•°æ®è¡¨ï¼Œä¸ç„¶ä¼šä½¿æŸ¥è¯¢å’Œå†™å…¥æ€§èƒ½å˜æ…¢ã€‚å› ä¸ºåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåˆ—å­—æ®µçš„æ•°æ®ä¼šè¢«å­˜å‚¨åœ¨å¯¹åº”çš„ [Column].bin æ–‡ä»¶ä¸­ã€‚å¦‚æœä¸€ä¸ªåˆ—å­—æ®µè¢« Nullable ç±»å‹ä¿®é¥°åï¼Œä¼šé¢å¤–ç”Ÿæˆä¸€ä¸ª [Column].null.bin æ–‡ä»¶ä¸“é—¨ä¿å­˜å®ƒçš„ NULL å€¼ã€‚è¿™æ„å‘³ç€åœ¨è¯»å–å’Œå†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦ä¸€å€çš„é¢å¤–æ–‡ä»¶æ“ä½œã€‚</strong></p>
<h4 id="Domain"><a href="#Domain" class="headerlink" title="Domain"></a>Domain</h4><p><strong>åŸŸåç±»å‹åˆ†ä¸º IPv4 å’Œ IPv6 ä¸¤ç±»ï¼Œæœ¬è´¨ä¸Šå®ƒä»¬æ˜¯å¯¹æ•´å‹å’Œå­—ç¬¦ä¸²çš„è¿›ä¸€æ­¥å°è£…ã€‚IPv4 ç±»å‹æ˜¯åŸºäº UInt32 å°è£…çš„ï¼Œå®ƒçš„å…·ä½“ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ip4_test (</span><br><span class="line">    url String,</span><br><span class="line">    ip IPv4</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ip4_test <span class="keyword">VALUES</span> (<span class="string">&#x27;www.nana.com&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ç»†å¿ƒçš„äººå¯èƒ½ä¼šé—®ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ä¸å°±è¡Œäº†å—ï¼Ÿä¸ºä½•å¤šæ­¤ä¸€ä¸¾å‘¢ï¼Ÿè‡³å°‘æœ‰å¦‚ä¸‹ä¸¤ä¸ªåŸå› ï¼š</strong></p>
<p><strong>1ï¼‰å‡ºäºä¾¿æ·æ€§çš„è€ƒé‡ï¼Œä¾‹å¦‚IPv4ç±»å‹æ”¯æŒæ ¼å¼æ£€æŸ¥ï¼Œæ ¼å¼é”™è¯¯çš„IPæ•°æ®æ˜¯æ— æ³•è¢«å†™å…¥çš„ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ip4_test <span class="keyword">VALUES</span>(<span class="string">&#x27;www,nana.com&#x27;</span>, <span class="string">&#x27;192.0.0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Exception <span class="keyword">on</span> client:</span><br><span class="line">Code: <span class="number">441.</span> DB::Exception: Invalid IPv4 value.: data <span class="keyword">for</span> <span class="keyword">INSERT</span> was parsed <span class="keyword">from</span> query</span><br><span class="line"></span><br><span class="line">Connecting <span class="keyword">to</span> localhost:<span class="number">9000</span> <span class="keyword">as</span> <span class="keyword">user</span> default.</span><br><span class="line">Connected <span class="keyword">to</span> ClickHouse server version <span class="number">21.7</span><span class="number">.3</span> revision <span class="number">54449.</span></span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰å‡ºäºæ€§èƒ½çš„è€ƒé‡ï¼ŒåŒæ ·ä»¥ IPv4 ä¸ºä¾‹ï¼ŒIPv4 ä½¿ç”¨ UInt32 å­˜å‚¨ï¼Œç›¸æ¯” String æ›´åŠ ç´§å‡‘ï¼Œå ç”¨çš„ç©ºé—´æ›´å°ï¼ŒæŸ¥è¯¢æ€§èƒ½æ›´å¿«ã€‚IPv6 ç±»å‹æ˜¯åŸºäº FixedString(16) å°è£…çš„ï¼Œå®ƒçš„ä½¿ç”¨æ–¹æ³•ä¸ IPv4 åˆ«æ— äºŒè‡´ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</strong></p>
<p><strong>åœ¨ä½¿ç”¨ Domain ç±»å‹çš„æ—¶å€™è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œè™½ç„¶å®ƒä»è¡¨è±¡ä¸Šçœ‹èµ·æ¥ä¸ String ä¸€æ ·ï¼Œä½† Domain ç±»å‹å¹¶ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å®ƒä¸æ”¯æŒéšå¼çš„è‡ªåŠ¨ç±»å‹è½¬æ¢ã€‚å¦‚æœéœ€è¦è¿”å› IP çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œåˆ™éœ€è¦æ˜¾å¼è°ƒç”¨ IPv4NumToString æˆ– IPv6NumToString å‡½æ•°è¿›è¡Œè½¬æ¢ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„æ¶æ„è®¾è®¡(äºŒ)</title>
    <url>/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„æ¶æ„è®¾è®¡ã€å®‰è£…æ–¹å¼ä»¥åŠè¿æ¥å·¥å…·-äºŒ"><a href="#ClickHouse-çš„æ¶æ„è®¾è®¡ã€å®‰è£…æ–¹å¼ä»¥åŠè¿æ¥å·¥å…·-äºŒ" class="headerlink" title="ClickHouse çš„æ¶æ„è®¾è®¡ã€å®‰è£…æ–¹å¼ä»¥åŠè¿æ¥å·¥å…·(äºŒ)"></a>ClickHouse çš„æ¶æ„è®¾è®¡ã€å®‰è£…æ–¹å¼ä»¥åŠè¿æ¥å·¥å…·(äºŒ)</h1><p>â€‹															</p>
<h3 id="Column-ä¸-Field"><a href="#Column-ä¸-Field" class="headerlink" title="Column ä¸ Field"></a>Column ä¸ Field</h3><p><strong>Column å’Œ Field æ˜¯ ClickHouse ä¸­æœ€åŸºç¡€çš„æ˜ å°„å•å…ƒï¼Œä½œä¸ºä¸€æ¬¾ç™¾åˆ†ç™¾çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“ï¼ŒClickHouse æŒ‰åˆ—å­˜å‚¨æ•°æ®ï¼Œå†…å­˜ä¸­çš„ä¸€ä¸ªåˆ—å°±ç”¨ä¸€ä¸ª Column å¯¹è±¡è¡¨ç¤ºã€‚Column å¯¹è±¡åˆ†ä¸ºæ¥å£å’Œå®ç°ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåœ¨ IColumn æ¥å£å¯¹è±¡ä¸­ï¼Œå®šä¹‰äº†å¯¹æ•°æ®è¿›è¡Œå„ç§å…³ç³»è¿ç®—çš„æ–¹æ³•ï¼Œä¾‹å¦‚æ’å…¥æ•°æ®çš„ insertRangeFrom æ–¹æ³•å’Œ insertFrom æ–¹æ³•ï¼Œç”¨äºåˆ†é¡µçš„ cutï¼Œä»¥åŠç”¨äºæ•°æ®è¿‡æ»¤çš„ filter æ–¹æ³•ç­‰ç­‰ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°å¯¹è±¡åˆ™æ ¹æ®æ•°æ®ç±»å‹çš„ä¸åŒï¼Œç”±ä¸åŒçš„å¯¹è±¡å®ç°ï¼Œä¾‹å¦‚ï¼šColumnStringã€ColumnArray å’Œ ColumnTuple ç­‰ç­‰ã€‚åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼ŒClickHouse éƒ½ä¼šä»¥æ•´åˆ—çš„æ–¹å¼æ“ä½œæ•°æ®ï¼Œä½†å‡¡äº‹ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¦‚æœéœ€è¦æ“ä½œå•ä¸ªå…·ä½“çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯å•åˆ—ä¸­çš„ä¸€è¡Œæ•°æ®ï¼‰ï¼Œåˆ™éœ€è¦ä½¿ç”¨ Field å¯¹è±¡ã€‚Field å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå•å€¼ï¼Œä¸ Column å¯¹è±¡çš„æ³›åŒ–è®¾è®¡æ€è·¯ä¸åŒï¼ŒField å¯¹è±¡ä½¿ç”¨äº†èšåˆçš„è®¾è®¡æ¨¡å¼ã€‚åœ¨ Field å¯¹è±¡å†…éƒ¨èšåˆ Nullã€UInt64ã€String å’Œ Array ç­‰ 13 ç§æ•°æ®ç±»å‹åŠç›¸åº”çš„å¤„ç†é€»è¾‘ï¼Œè¯´ç™½äº†å°±æ˜¯è¿™äº›å€¼çš„ç±»å‹è™½ç„¶ä¸åŒï¼Œä½†å®ƒä»¬éƒ½æ˜¯ Field å¯¹è±¡ï¼Œå› ä¸ºè¿™äº›ç±»å‹çš„æ•°æ®çš„å¤„ç†é€»è¾‘éƒ½åœ¨ Field å¯¹è±¡é‡Œé¢ã€‚</strong></p>
<blockquote>
<p><strong>Column å¯¹è±¡æ˜¯æ•°æ®è¡¨ä¸­çš„ä¸€åˆ—ï¼ŒField å¯¹è±¡ç›¸å½“äºä¸€ä¸ªå•å…ƒæ ¼ã€‚</strong></p>
</blockquote>
<h3 id="DataType"><a href="#DataType" class="headerlink" title="DataType"></a>DataType</h3><p><strong>æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å·¥ä½œç”± DataType è´Ÿè´£ï¼ŒIDataType æ¥å£å®šä¹‰äº†è®¸å¤šæ­£ååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œå®ƒä»¬æˆå¯¹å‡ºç°ï¼Œä¾‹å¦‚ serializeBinary å’Œ deserializeBinaryã€serializeTextJSON å’Œ deserializeTextJSON ç­‰ç­‰ï¼Œæ¶µç›–äº†å¸¸ç”¨çš„äºŒè¿›åˆ¶ã€æ–‡æœ¬ã€JSONã€XMLã€CSV å’Œ Protobuf ç­‰å¤šç§æ ¼å¼ç±»å‹ã€‚IDataType ä¹Ÿä½¿ç”¨äº†æ³›åŒ–çš„è®¾è®¡æ¨¡å¼ï¼Œå…·ä½“æ–¹æ³•çš„å®ç°é€»è¾‘ç”±å¯¹åº”æ•°æ®ç±»å‹çš„å®ä¾‹å¯¹è±¡æ¥æ‰¿è½½ï¼Œä¾‹å¦‚ DataTypeStringã€DataTypeArray ä»¥åŠ DataTypeTuple ç­‰ç­‰ã€‚</strong></p>
<blockquote>
<p><strong>æ¥å£å†…éƒ¨å®šä¹‰ç›¸åº”çš„æ–¹æ³•ï¼Œå…·ä½“çš„æ•°æ®ç±»è´Ÿè´£å®ç°ã€‚å¦‚æœæŸä¸ªç±»å®ç°äº†æ¥å£å†…éƒ¨å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå…¶å®ä¾‹å¯¹è±¡å°±å¯ä»¥èµ‹å€¼ç»™æ¥å£ï¼Œé€šè¿‡æ¥å£æ¥è°ƒç”¨å†…éƒ¨çš„æ–¹æ³•ã€‚å½“ç„¶è°ƒç”¨çš„æ–¹æ³•å¿…é¡»æ˜¯æ¥å£å†…éƒ¨å·²ç»å£°æ˜çš„ï¼Œå¦‚æœé™¤äº†æ¥å£å†…éƒ¨å®šä¹‰çš„æ–¹æ³•ä¹‹å¤–ï¼Œè¯¥ç±»è¿˜å®šä¹‰äº†å…¶å®ƒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™äº›å…¶å®ƒçš„æ–¹æ³•å°±ä¸èƒ½é€šè¿‡æ¥å£è°ƒç”¨äº†ã€‚</strong></p>
<p><strong>é‚£ä¹ˆæ¥å£è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿé¦–å…ˆæœ€ç›´è§‚çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å®ç°äº†å¤šæ€ï¼Œå› ä¸ºä¸ç®¡æ˜¯ä»€ä¹ˆç±»ï¼Œåªè¦å®ƒå®ç°äº†æ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶å®ä¾‹å¯¹è±¡å°±å¯ä»¥èµ‹å€¼ç»™æ¥å£ï¼Œå³ï¼šä¸€ä¸ªæ¥å£ï¼Œå¤šç§å®ç°ã€‚</strong></p>
</blockquote>
<p><strong>å¦å¤– DataType è™½ç„¶è´Ÿè´£åºåˆ—åŒ–ç›¸å…³å·¥ä½œï¼Œä½†å®ƒå¹¶ä¸ç›´æ¥è´Ÿè´£æ•°æ®çš„è¯»å–ï¼Œè€Œæ˜¯ä» Column å¯¹è±¡æˆ– Field å¯¹è±¡ä¸­è¯»å–ã€‚åœ¨ DataType çš„å®ç°ç±»ä¸­ï¼Œèšåˆäº†ç›¸åº”æ•°æ®ç±»å‹çš„ Column å¯¹è±¡å’Œ Field å¯¹è±¡ã€‚ä¾‹å¦‚ DataTypeString ä¼šå¼•ç”¨å­—ç¬¦ä¸²ç±»å‹çš„ ColumnStringï¼Œè€Œ DataTypeArray åˆ™ä¼šå¼•ç”¨æ•°ç»„ç±»å‹çš„ ColumnArrayï¼Œä»¥æ­¤ç±»æ¨ã€‚</strong></p>
<h3 id="Block-å’Œ-Blockæµ"><a href="#Block-å’Œ-Blockæµ" class="headerlink" title="Block å’Œ Blockæµ"></a>Block å’Œ Blockæµ</h3><p><strong>ClickHouse å†…éƒ¨çš„æ•°æ®æ“ä½œæ˜¯é¢å‘ Block å¯¹è±¡è¿›è¡Œçš„ï¼Œå¹¶ä¸”é‡‡ç”¨äº†æµçš„å½¢å¼ï¼Œè™½ç„¶ Column å¯¹è±¡å’Œ Field å¯¹è±¡ç»„æˆäº†æ•°æ®çš„åŸºæœ¬æ˜ å°„å•å…ƒï¼Œä½†å¯¹åº”åˆ°å®é™…æ“ä½œï¼Œå®ƒä»¬è¿˜å°‘äº†ä¸€äº›å¿…è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®çš„ç±»å‹å’Œåˆ—çš„åç§°ã€‚äºæ˜¯ ClickHouse è®¾è®¡äº† Block å¯¹è±¡ï¼ŒBlock å¯¹è±¡å¯ä»¥çœ‹æˆæ˜¯æ•°æ®è¡¨çš„å­é›†ï¼ŒBlock å¯¹è±¡çš„æœ¬è´¨æ˜¯ç”±æ•°æ®å¯¹è±¡ã€æ•°æ®ç±»å‹å’Œåˆ—åç§°ç»„æˆçš„ä¸‰å…ƒç»„ï¼Œå³ Columnã€DataTypeã€åˆ—åç§°å­—ç¬¦ä¸²ã€‚Column æä¾›äº†æ•°æ®çš„è¯»å–èƒ½åŠ›ï¼Œè€Œ DataType çŸ¥é“å¦‚ä½•æ­£ååºåˆ—åŒ–ï¼Œæ‰€ä»¥ Block å¯¹è±¡åœ¨è¿™äº›å¯¹è±¡çš„åŸºç¡€ä¸Šå®ç°äº†è¿›ä¸€æ­¥çš„æŠ½è±¡å’Œå°è£…ï¼Œä»è€Œç®€åŒ–äº†æ•´ä¸ªä½¿ç”¨çš„è¿‡ç¨‹ï¼Œä»…é€šè¿‡ Block å¯¹è±¡å°±èƒ½å®Œæˆä¸€ç³»åˆ—çš„æ•°æ®æ“ä½œã€‚åªä¸è¿‡åœ¨å…·ä½“çš„å®ç°è¿‡ç¨‹ä¸­ï¼ŒBlock å¹¶æ²¡æœ‰ç›´æ¥èšåˆ Column å’Œ DataType å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ ColumnWithAndName å¯¹è±¡è¿›è¡Œé—´æ¥å¼•ç”¨ã€‚</strong></p>
<p><strong>æœ‰äº† Block å¯¹è±¡çš„è¿™ä¸€å±‚å°è£…ä¹‹åï¼Œå¯¹ Block æµçš„è®¾è®¡å°±æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…äº†ï¼Œæµæ“ä½œæœ‰ä¸¤ç»„é¡¶å±‚æ¥å£ï¼šIBlockInputStream è´Ÿè´£æ•°æ®çš„è¯»å–å’Œå…³é”®è¿ç®—ï¼ŒIBlockOutputStream è´Ÿè´£å°†æ•°æ®è¾“å‡ºåˆ°ä¸‹ä¸€ç¯èŠ‚ã€‚Block æµä¹Ÿæ˜¯ç”¨äº†æ³›åŒ–çš„è®¾è®¡æ¨¡å¼ï¼Œå¯¹æ•°æ®çš„å„ç§æ“ä½œéƒ½ä¼šè½¬æ¢æˆå…¶ä¸­ä¸€ç§æµçš„å®ç°ã€‚æ‰€ä»¥ IBlockInputStream ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨å®šä¹‰äº†è¯»å–æ•°æ®çš„è‹¥å¹²ä¸ª read è™šæ–¹æ³•ï¼Œè€Œå…·ä½“çš„å®ç°é€»è¾‘åˆ™äº¤ç»™å®ƒçš„å®ç°ç±»æ¥å¡«å……ï¼ŒIBlockOutputStream åŒç†ã€‚</strong></p>
<p><strong>æ€»å…±æœ‰ 60 å¤šä¸ªç±»å®ç°äº† IBlockInputStream æ¥å£ï¼Œå®ƒä»¬è¦†ç›–äº† ClickHouse æ•°æ®æ‘„å–çš„æ–¹æ–¹é¢é¢ã€‚è¿™äº›å®ç°ç±»å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šç¬¬ä¸€ç±»ç”¨äºå¤„ç†æ•°æ®å®šä¹‰çš„ DDL æ“ä½œï¼Œä¾‹å¦‚ DDLQueryStatusInputStream ç­‰ï¼›ç¬¬äºŒç±»ç”¨äºå¤„ç†æ•°æ®å…³ç³»è¿ç®—çš„ç›¸å…³æ“ä½œï¼Œä¾‹å¦‚ LimitBlockInputStreamã€JoinBlockInputStreamã€AggregatingBlockInputStreamç­‰ï¼›ç¬¬ä¸‰ç±»åˆ™æ˜¯ä¸å¼•æ“å‘¼åº”ï¼Œæ¯ä¸€ç§å¼•æ“éƒ½æ‹¥æœ‰ä¸ä¹‹å¯¹åº”çš„ BlockInputStream å®ç°ï¼Œä¾‹å¦‚ MergeTreeBaseSelectBlockInputStreamï¼ˆMergeTree å¼•æ“ï¼‰ã€TinyLogBlockInputStreamï¼ˆTinyLog å¼•æ“ï¼‰ä»¥åŠ KafkaBlockInputStreamï¼ˆKafka å¼•æ“ï¼‰ç­‰ã€‚</strong></p>
<p><strong>IBlockOutputStream çš„è®¾è®¡ä¹Ÿä¸ IBlockInputStream å¦‚å‡ºä¸€è¾™ï¼ŒIBlockOutputStream æ¥å£åŒæ ·å®šä¹‰äº†è‹¥å¹²å†™å…¥æ•°æ®çš„ write è™šæ–¹æ³•ã€‚ä½†å®ƒçš„å®ç°ç±»æ¯”èµ· IBlockInputStream è¦å°‘å¾ˆå¤šï¼Œä¸€å…±åªæœ‰ 20 å¤šç§ï¼Œè¿™äº›å®ç°ç±»åŸºæœ¬ç”¨äºå¼•æ“çš„ç›¸å…³å¤„ç†ï¼Œè´Ÿè´£å°†æ•°æ®å†™å…¥ä¸‹ä¸€ç¯èŠ‚æˆ–è€…æœ€ç»ˆç›®çš„åœ°ï¼Œä¾‹å¦‚ï¼šMergeTreeBlockOutputStreamã€TinyLogBlockOutputStream ä»¥åŠ StorageFileBlockOutputStream ç­‰ã€‚</strong></p>
<h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><p><strong>åœ¨æ•°æ®è¡¨çš„åº•å±‚è®¾è®¡ä¸­å¹¶æ²¡æœ‰æ‰€è°“çš„ Table å¯¹è±¡ï¼Œå®ƒæ˜¯ç›´æ¥ä½¿ç”¨ IStroge æ¥å£æŒ‡ä»£æ•°æ®è¡¨ï¼Œè¡¨çš„å¼•æ“æ˜¯ ClickHouse çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹å¾ï¼Œä¸åŒçš„è¡¨çš„å¼•æ“ç”±ä¸åŒçš„å­ç±»å®ç°ã€‚ä¾‹å¦‚ï¼šIStorageSystemOneBlockï¼ˆç³»ç»Ÿè¡¨ï¼‰ã€StorageMergeTreeï¼ˆåˆå¹¶æ ‘å¼•æ“ï¼‰å’Œ StorageTinyLogï¼ˆæ—¥å¿—è¡¨å¼•æ“ï¼‰ç­‰ã€‚IStorage æ¥å£å®šä¹‰äº† DDLï¼ˆå¦‚ ALTERã€RENAMEã€OPTIMIZE å’Œ DROP ç­‰ï¼‰ã€read å’Œ write æ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«è´Ÿè´£æ•°æ®çš„å®šä¹‰ã€æŸ¥è¯¢ä¸å†™å…¥ã€‚åœ¨æ•°æ®æŸ¥è¯¢æ—¶ï¼ŒIStorage è´Ÿè´£æ ¹æ® AST æŸ¥è¯¢è¯­å¥çš„æŒ‡ç¤ºè¦æ±‚ï¼Œè¿”å›æŒ‡å®šåˆ—çš„åŸå§‹æ•°æ®ã€‚åç»­å¯¹æ•°æ®çš„è¿›ä¸€æ­¥åŠ å·¥ã€è®¡ç®—å’Œè¿‡æ»¤åˆ™ä¼šç»Ÿä¸€äº¤ç”± Interpreter è§£é‡Šå™¨å¯¹è±¡å¤„ç†ã€‚å¯¹ Table å‘èµ·çš„ä¸€æ¬¡æ“ä½œé€šå¸¸éƒ½ä¼šç»å†è¿™æ ·çš„è¿‡ç¨‹ï¼Œæ¥æ”¶ AST æŸ¥è¯¢è¯­å¥ã€æ ¹æ® AST è¿”å›æŒ‡å®šåˆ—çš„æ•°æ®ï¼Œä¹‹åå†å°†æ•°æ®äº¤ç»™ Interpreter åšè¿›ä¸€æ­¥å¤„ç†ã€‚</strong></p>
<h3 id="Parser-å’Œ-Interpreter"><a href="#Parser-å’Œ-Interpreter" class="headerlink" title="Parser å’Œ Interpreter"></a>Parser å’Œ Interpreter</h3><p><strong>Parser å’Œ Interpreter æ˜¯éå¸¸é‡è¦çš„ä¸¤ç»„æ¥å£ï¼šParser åˆ†æå™¨è´Ÿè´£åˆ›å»º AST å¯¹è±¡ï¼›è€Œ Interpreter è§£é‡Šå™¨å¯¹è±¡åˆ™è´Ÿè´£è§£é‡Š ASTï¼Œå¹¶è¿›ä¸€æ­¥åˆ›å»ºæŸ¥è¯¢çš„æ‰§è¡Œç®¡é“ï¼Œå®ƒä»¬ä¸ IStorage ä¸€èµ·ï¼Œä¸²è”èµ·äº†æ•´ä¸ªæ•°æ®æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚</strong></p>
<p><strong>Parser åˆ†æå™¨å¯ä»¥å°†ä¸€æ¡ SQL è¯­å¥ä»¥é€’å½’ä¸‹é™çš„æ–¹æ³•è§£ææˆ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œä¸åŒçš„ SQL è¯­å¥ä¼šäº¤ç»™ä¸åŒçš„ Parser å®ç°ç±»æ¥è§£æã€‚ä¾‹å¦‚ï¼Œæœ‰è´Ÿè´£è§£æ DDL æŸ¥è¯¢è¯­å¥çš„ ParserRenameQueryã€ParserDropQuery å’Œ ParserAlterQuery è§£æå™¨ï¼Œè¿˜æœ‰è´Ÿè´£è§£æ INSERT è¯­å¥çš„ ParserInsertQuery è§£æå™¨ï¼Œè¿˜æœ‰è´Ÿè´£ SELECT è¯­å¥çš„ ParserSelectQuery ç­‰ç­‰ã€‚æ‰€ä»¥å°½ç®¡ SQL è¯­å¥æœ€ç»ˆéƒ½ä¼šè¢«è§£ææˆ ASTï¼Œä½†ä¸åŒçš„ SQL è¯­å¥ä¼šäº¤ç»™ä¸åŒçš„ Parser å®ç°ç±»è¿›è¡Œè§£æ</strong></p>
<p><strong>Interpreter è§£é‡Šå™¨çš„ä½œç”¨åŸŸå°±åƒ Service æœåŠ¡å™¨ä¸€æ ·ï¼Œèµ·åˆ°ä¸²è”æ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹çš„ä½œç”¨ï¼Œå®ƒä¼šæ ¹æ®è§£é‡Šå™¨çš„ç±»å‹ï¼Œèšåˆå®ƒæ‰€éœ€è¦çš„èµ„æºã€‚é¦–å…ˆå®ƒä¼šè§£æ AST å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œ â€œä¸šåŠ¡é€»è¾‘â€ï¼ˆä¾‹å¦‚åˆ†æ”¯åˆ¤æ–­ã€è®¾ç½®å‚æ•°ã€è°ƒç”¨æ¥å£ç­‰ï¼‰ï¼›æœ€ç»ˆè¿”å› IBlock å¯¹è±¡ï¼Œä»¥çº¿ç¨‹çš„å½¢å¼å»ºç«‹èµ·ä¸€ä¸ªæŸ¥è¯¢æ‰§è¡Œç®¡é“ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20201012235617320-1692152376.png" alt="img"></p>
<h3 id="Functions-ä¸-Aggregate-Functions"><a href="#Functions-ä¸-Aggregate-Functions" class="headerlink" title="Functions ä¸ Aggregate Functions"></a>Functions ä¸ Aggregate Functions</h3><p><strong>ClickHouse ä¸»è¦æä¾›ä¸¤ç±»å‡½æ•°ï¼šæ™®é€šå‡½æ•°å’Œèšåˆå‡½æ•°ï¼Œæ™®é€šå‡½æ•°ç”± IFunction æ¥å£å®šä¹‰ï¼Œæ‹¥æœ‰æ•°åç§å‡½æ•°å®ç°ï¼Œä¾‹å¦‚ FunctionFormatDataTimeã€FunctionSubstring ç­‰ã€‚é™¤äº†ä¸€äº›å¸¸è§çš„å‡½æ•°ï¼ˆè¯¸å¦‚å››åˆ™è¿ç®—ã€æ—¥æœŸè½¬æ¢ï¼‰ä¹‹å¤–ï¼Œä¹Ÿä¸ä¹ä¸€äº›éå¸¸ä½¿ç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚ç½‘å€æå–å‡½æ•°ã€IP åœ°å€è„±æ•å‡½æ•°ç­‰ã€‚æ™®é€šå‡½æ•°æ˜¯æ²¡æœ‰çŠ¶æ€çš„ï¼Œå‡½æ•°æ•ˆæœä½œç”¨äºæ¯è¡Œæ•°æ®ä¹‹ä¸Šã€‚å½“ç„¶ï¼Œåœ¨å‡½æ•°å…·ä½“æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸ä¼šä¸€è¡Œä¸€è¡Œçš„è¿ç®—ï¼Œè€Œæ˜¯é‡‡ç”¨å‘é‡åŒ–æ‰§è¡Œçš„æ–¹å¼ç›´æ¥ä½œç”¨äºä¸€æ•´åˆ—æ•°æ®ã€‚</strong></p>
<p><strong>èšåˆå‡½æ•°ç”± IAggregateFunction æ¥å£å®šä¹‰ï¼Œç›¸æ¯”æ— çŠ¶æ€çš„æ™®é€šå‡½æ•°ï¼Œèšåˆå‡½æ•°æ˜¯æœ‰çŠ¶æ€çš„ã€‚ä»¥ COUNT èšåˆå‡½æ•°ä¸ºä¾‹ï¼Œå…¶ AggregateFunctionCount çš„çŠ¶æ€ä½¿ç”¨æ•´å‹UInt64è®°å½•ã€‚èšåˆå‡½æ•°çš„çŠ¶æ€æ”¯æŒåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥èƒ½å¤Ÿåœ¨åˆ†å¸ƒå¼èŠ‚ç‚¹ç›´æ¥è¿›è¡Œä¼ è¾“ï¼Œä»¥å®ç°å¢é‡è®¡ç®—ã€‚</strong></p>
<h3 id="Cluster-ä¸-Replication"><a href="#Cluster-ä¸-Replication" class="headerlink" title="Cluster ä¸ Replication"></a>Cluster ä¸ Replication</h3><p><strong>ClickHouse çš„é›†ç¾¤ç”±åˆ†ç‰‡ï¼ˆShardï¼‰ç»„æˆï¼Œè€Œæ¯ä¸ªåˆ†ç‰‡åˆé€šè¿‡å‰¯æœ¬ï¼ˆReplicaï¼‰ç»„æˆï¼Œè¿™ç§åˆ†å±‚çš„æ¦‚å¿µï¼Œåœ¨ä¸€äº›æµè¡Œçš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸æ™®éã€‚ä¾‹å¦‚ï¼Œåœ¨ Elasticsearch ä¸­ï¼Œä¸€ä¸ªç´¢å¼•ç”±åˆ†ç‰‡å’Œå‰¯æœ¬ç»„æˆï¼Œå‰¯æœ¬å¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆ†ç‰‡ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•ç”± 5 ä¸ªåˆ†ç‰‡ç»„æˆï¼Œå‰¯æœ¬çš„åŸºæ•°æ˜¯ 1ï¼Œé‚£ä¹ˆè¿™ä¸ªç´¢å¼•ä¸€å…±ä¼šæ‹¥æœ‰ 10 ä¸ªåˆ†ç‰‡ï¼ˆæ¯ 1 ä¸ªåˆ†ç‰‡å¯¹åº” 1 ä¸ªå‰¯æœ¬ï¼‰ã€‚</strong></p>
<p><strong>è€Œå¦‚æœä½ ä½¿ç”¨åŒæ ·çš„æ–¹å¼æ¥ç†è§£ ClickHouse çš„åˆ†ç‰‡ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šæ ½ä¸€ä¸ªè·Ÿå¤´ï¼ŒClickHouse çš„æŸäº›è®¾è®¡æ€»æ˜¯æ˜¾å¾—ç‹¬æ ‘ä¸€å¸œï¼Œè€Œé›†ç¾¤ä¸åˆ†ç‰‡ä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚è¿™é‡Œæœ‰å‡ ä¸ªä¸ä¼—ä¸åŒçš„ç‰¹æ€§ï¼š</strong></p>
<ul>
<li><code>1. ClickHouse çš„ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æœ‰ 1 ä¸ªåˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè¦å®ç° 1 åˆ†ç‰‡ã€1 å‰¯æœ¬ï¼Œåˆ™è‡³å°‘éœ€è¦ä¸¤ä¸ªæœåŠ¡èŠ‚ç‚¹</code></li>
<li><code>2. åˆ†ç‰‡åªæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œå…¶ç‰©ç†æ‰¿è½½è¿˜æ˜¯è¦ç”±å‰¯æœ¬æ¥æ‰¿æ‹…çš„</code></li>
</ul>
<p><strong>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ClickHouse çš„é›†ç¾¤é…ç½®ï¼Œè¿™é‡Œå°†ä¼šåœ¨åé¢è¯¦ç»†è¯´ï¼Œç›®å‰å…ˆçœ‹çœ‹æœ‰ä¸ªå°è±¡å³å¯ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ch_cluster</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">host</span>&gt;</span>47.94.174.89<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ch_cluster</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä»å­—é¢å«ä¹‰ä¸Šæ¥ç†è§£çš„è¯ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯è‡ªå®šä¹‰é›†ç¾¤ ch_cluster æ‹¥æœ‰ä¸€ä¸ª shardï¼ˆåˆ†ç‰‡ï¼‰å’Œä¸€ä¸ªreplicaï¼ˆå‰¯æœ¬ï¼‰ï¼Œä¸”è¯¥å‰¯æœ¬ç”± 47.94.174.89 æœåŠ¡èŠ‚ç‚¹æ‰¿è½½ã€‚</strong></p>
<p><strong>ä½†æ˜¯ä»æœ¬è´¨ä¸Šæ¥ç†è§£çš„è¯ï¼Œ1 åˆ†ç‰‡ã€1 å‰¯æœ¬çš„é…ç½®åœ¨ ClickHouse ä¸­åªæœ‰ 1 ä¸ªç‰©ç†å‰¯æœ¬ï¼Œæ‰€ä»¥å®ƒçš„æ­£ç¡®è¯­ä¹‰åº”è¯¥æ˜¯ 1 åˆ†ç‰‡ã€0 å‰¯æœ¬ã€‚åˆ†ç‰‡æ›´åƒæ˜¯é€»è¾‘å±‚çš„åˆ†ç»„ï¼Œåœ¨ç‰©ç†å­˜å‚¨å±‚é¢åˆ™ç»Ÿä¸€ä½¿ç”¨å‰¯æœ¬æ¥ä»£è¡¨ â€œåˆ†ç‰‡å’Œå‰¯æœ¬â€ã€‚æ‰€ä»¥å¦‚æœæƒ³çœŸæ­£è¡¨ç¤º 1 åˆ†ç‰‡ã€1 å‰¯æœ¬è¯­ä¹‰çš„é…ç½®ï¼Œåº”è¯¥æ”¹ä¸º 1 ä¸ªåˆ†ç‰‡å’Œ 2 ä¸ªå‰¯æœ¬ï¼Œé…ç½®å¯ä»¥æ”¹ä¸ºå¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ch_cluster</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">host</span>&gt;</span>47.94.174.89<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">host</span>&gt;</span>47.93.39.238<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ch_cluster</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šå°±æ˜¯ ClickHouse çš„æ¶æ„è®¾è®¡ï¼Œè¿™äº›å†…å®¹æ„Ÿè§‰æœ‰ç‚¹æ¯ç‡¥ç”šè‡³ä¸å¥½ç†è§£ï¼Œä¸‹é¢å°±æ¥å®‰è£… ClickHouseï¼Œè¿›å…¥å®é™…æ“ä½œç¯èŠ‚ã€‚</strong></p>
<h2 id="ClickHouse-çš„å®‰è£…ä»¥åŠè¿æ¥å·¥å…·"><a href="#ClickHouse-çš„å®‰è£…ä»¥åŠè¿æ¥å·¥å…·" class="headerlink" title="ClickHouse çš„å®‰è£…ä»¥åŠè¿æ¥å·¥å…·"></a>ClickHouse çš„å®‰è£…ä»¥åŠè¿æ¥å·¥å…·</h2><p><strong>ç›¸è¾ƒäº Hadoop ç”Ÿæ€ä¸­çš„ä¸€äº›ç³»ç»Ÿï¼ŒClickHouse çš„å®‰è£…æ˜¾å¾—å°¤ä¸ºç®€å•ï¼Œå› ä¸ºå®ƒè‡ªæˆä¸€ä½“ï¼Œåœ¨å•èŠ‚ç‚¹çš„æƒ…å†µä¸‹ä¸éœ€è¦é¢å¤–çš„ä¾èµ–ï¼Œé›†ç¾¤çš„è¯åé¢ä¼šè¯´ã€‚</strong></p>
<p><strong>ClickHouse æ”¯æŒè¿è¡Œåœ¨ä¸»æµ 64 ä½ CPU æ¶æ„çš„ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œå¯ä»¥é€šè¿‡æºç ç¼–è¯‘ã€é¢„ç¼–è¯‘å‹ç¼©åŒ…ã€Docker é•œåƒå’Œ RPM ç­‰å¤šç§æ–¹æ³•è¿›è¡Œå®‰è£…ã€‚è¿™é‡Œæˆ‘ä»¬ç€é‡ä»‹ç»ä¸€ä¸‹ç¦»çº¿ RPM çš„å®‰è£…æ–¹æ³•ï¼Œå› ä¸ºå®ƒæœ€å¸¸ç”¨ã€‚</strong></p>
<p><strong>å…ˆä»‹ç»ä¸€ä¸‹ç¯å¢ƒï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿä¸º CentOS 7ï¼Œæ˜¯æˆ‘åœ¨é˜¿é‡Œäº‘ä¸Šçš„æœåŠ¡å™¨ï¼Œè€Œ ClickHouse æˆ‘ä»¬é€‰æ‹© 21.7.3.14 ç‰ˆæœ¬ï¼Œä¸€ä¸ªéå¸¸æ–°çš„ç‰ˆæœ¬ã€‚</strong></p>
<p><strong>1. ä¸‹è½½ RPM å®‰è£…åŒ…</strong></p>
<p><strong>ç”¨äºå®‰è£…çš„ RPM åŒ…å¯ä»¥ä»ä»“åº“ <a href="https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/">https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/</a> ä¸­è¿›è¡Œä¸‹è½½ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰ç‰ˆæœ¬çš„ ClickHouseã€‚</strong></p>
<p><strong>æˆ‘ä»¬éœ€è¦ä¸‹è½½ä»¥ä¸‹å››ä¸ªå®‰è£…åŒ…æ–‡ä»¶ï¼š</strong></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">clickho<span class="built_in">use-client</span><span class="literal">-21</span>.<span class="number">7.3</span>.<span class="number">14</span><span class="literal">-2</span>.noarch.rpm</span><br><span class="line">clickho<span class="built_in">use-common</span><span class="literal">-static-21</span>.<span class="number">7.3</span>.<span class="number">14</span><span class="literal">-2</span>.x86_64.rpm</span><br><span class="line">clickho<span class="built_in">use-common</span><span class="literal">-static-dbg-21</span>.<span class="number">7.3</span>.<span class="number">14</span><span class="literal">-2</span>.x86_64.rpm</span><br><span class="line">clickho<span class="built_in">use-server</span><span class="literal">-21</span>.<span class="number">7.3</span>.<span class="number">14</span><span class="literal">-2</span>.noarch.rpm</span><br></pre></td></tr></table></figure>

<p><strong>2. å…³é—­é˜²ç«å¢™å¹¶æ£€æŸ¥ç¯å¢ƒä¾èµ–</strong></p>
<p><strong>é¦–å…ˆï¼Œè€ƒè™‘åˆ°åç»­çš„é›†ç¾¤éƒ¨ç½²ï¼Œé€šå¸¸å»ºè®®å…³é—­æœ¬æœºçš„é˜²ç«å¢™ï¼Œåœ¨ CentOS 7 ä¸­å…³é—­é˜²ç«å¢™çš„æ–¹æ³•å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"><span class="comment"># ç¦ç”¨å¼€æœºå¯åŠ¨é¡¹</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ç€éœ€è¦éªŒè¯å½“å‰æœåŠ¡å™¨çš„ CPU æ˜¯å¦æ”¯æŒ SSE 4.2 æŒ‡ä»¤é›†ï¼Œå› ä¸ºå‘é‡åŒ–æ‰§è¡Œéœ€è¦ç”¨åˆ°è¿™é¡¹ç‰¹æ€§ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">grep -q sse4_2 /proc/cpuinfo &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;æ”¯æŒ SSE 4.2 æŒ‡ä»¤é›†&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;ä¸æ”¯æŒ SSE 4.2 æŒ‡ä»¤é›†&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173136749-2106854624.png" alt="img"></p>
<p><strong>å¦‚æœä¸æ”¯æŒ SSE æŒ‡ä»¤é›†ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨ä¸Šé¢ä¸‹è½½çš„ RPM å®‰è£…åŒ…ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨æºç ç¼–è¯‘çš„æ–¹å¼å®‰è£…ï¼Œå½“ç„¶ç°åœ¨çš„ CPU åŸºæœ¬ä¸Šéƒ½æ˜¯æ”¯æŒçš„ã€‚</strong></p>
<p><strong>3. å®‰è£… ClickHouse</strong></p>
<p><strong>æˆ‘ä»¬å°†ä¸Šé¢ä¸‹è½½åœ° RPM åŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åè¿›è¡Œå®‰è£…ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨é€šé…ç¬¦ï¼Œä¼šå°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„ rpm åŒ…å…¨éƒ¨ä¾æ¬¡å®‰è£…ï¼Œéå¸¸æ–¹ä¾¿</span></span><br><span class="line"><span class="comment"># å› ä¸ºæˆ‘ä»¬æ˜¯å®‰è£… ClickHouseï¼Œæ‰€ä»¥è¯¥ç›®å½•é™¤äº† ClickHouse çš„ rpm åŒ…ä¹‹å¤–ï¼Œæœ€å¥½ä¸è¦æœ‰å…¶å®ƒçš„ rpm åŒ…</span></span><br><span class="line">rpm -ivh ./*.rpm</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼Œåœ¨å®‰è£…åˆ° clickhouse-server çš„æ—¶å€™ä¼šæç¤ºä½ è®¾ç½®å¯†ç ï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173147043-888452747.png" alt="img"></p>
<p><strong>å› ä¸º ClickHouse åœ¨å®‰è£…çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„ default ç”¨æˆ·ï¼Œè¿™é‡Œä¼šæç¤ºä½ ç»™ default è®¾ç½®å¯†ç ï¼Œå› ä¸º ClickHouse å’Œ MySQLã€PostgreSQL ç­‰æ•°æ®åº“ä¸€æ ·ï¼Œä¹Ÿå…·æœ‰ç”¨æˆ·ç®¡ç†æƒé™ã€‚è€ç‰ˆæœ¬é»˜è®¤æ²¡æœ‰å¯†ç ï¼Œæ–°ç‰ˆæœ¬ä¼šè®©ä½ ä¸»åŠ¨è®¾ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸è®¾ç½®äº†ï¼Œç›´æ¥å›è½¦å°±å¥½ï¼Œè¿™æ ·åç»­åœ¨è¿æ¥çš„æ—¶å€™å°±ä¸éœ€è¦å¯†ç äº†ã€‚</strong></p>
<p><strong>æœ€åï¼Œå¦‚æœæƒ³å¸è½½ ClickHouse ä¹Ÿå¾ˆç®€å•ï¼Œè‡³äºä»¥ä¸‹å‡ æ­¥ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum remove clickhouse-client clickhouse-common-static clickhouse-common-static-dbg clickhouse-server -y</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/clickhouse</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/clickhouse-*</span><br><span class="line"><span class="built_in">rm</span> -rf /var/log/clickhouse-server</span><br></pre></td></tr></table></figure>

<h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><p><strong>ç¨‹åºåœ¨å®‰è£…çš„æ—¶å€™ä¼šè‡ªåŠ¨æ„å»ºæ•´å¥—ç›®å½•ç»“æ„ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«è¯´æ˜å®ƒä»¬çš„ä½œç”¨ã€‚</strong></p>
<p><strong>1) é¦–å…ˆæ˜¯æ ¸å¿ƒç›®å½•éƒ¨åˆ†</strong></p>
<p><strong>&#x2F;etc&#x2F;clickhouse-serverï¼šæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶ç›®å½•, åŒ…æ‹¬å…¨å±€é…ç½® config.xml å’Œç”¨æˆ·é…ç½® users.xml ç­‰ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173157010-600531378.png" alt="img"></p>
<p><strong>&#x2F;var&#x2F;lib&#x2F;clickhouseï¼šé»˜è®¤çš„æ•°æ®å­˜å‚¨ç›®å½•ï¼ˆé€šå¸¸ä¼šä¿®æ”¹é»˜è®¤å­˜å‚¨è·¯å¾„ï¼Œå°†æ•°æ®ä¿å­˜åˆ°å¤§å®¹é‡ç£ç›˜æŒ‚è½½çš„è·¯å¾„ï¼‰ï¼Œé€šè¿‡ config.xml è¿›è¡Œä¿®æ”¹ã€‚</strong></p>
<p><strong>&#x2F;var&#x2F;log&#x2F;clickhouse-serverï¼šé»˜è®¤ä¿å­˜æ—¥å¿—çš„ç›®å½•ï¼ˆé€šå¸¸ä¼šä¿®æ”¹é»˜è®¤å­˜å‚¨è·¯å¾„ï¼Œå°†æ—¥å¿—ä¿å­˜åˆ°å¤§å®¹é‡ç£ç›˜æŒ‚è½½çš„è·¯å¾„ï¼‰ï¼Œé€šè¿‡ config.xml è¿›è¡Œä¿®æ”¹ã€‚</strong></p>
<p><strong>2) æ¥ä¸‹æ¥æ˜¯é…ç½®æ–‡ä»¶éƒ¨åˆ†</strong></p>
<p><strong>&#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;clickhouse.confï¼šæ–‡ä»¶å¥æŸ„æ•°é‡çš„é…ç½®ï¼Œé»˜è®¤å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cat /etc/security/limits.d/clickhouse.conf</span></span><br><span class="line">clickhouse	soft	nofile	262144</span><br><span class="line">clickhouse	hard	nofile	262144</span><br><span class="line">[root@satori ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>è¯¥é…ç½®ä¹Ÿå¯ä»¥é€šè¿‡ config.xml ä¸­çš„ max_open_files å‚æ•°æŒ‡å®šã€‚</strong></p>
<p><strong>&#x2F;etc&#x2F;cron.d&#x2F;clickhouse-serverï¼šcron å®šæ—¶ä»»åŠ¡é…ç½®, ç”¨äºæ¢å¤å› å¼‚å¸¸åŸå› ä¸­æ–­çš„ ClickHouse æœåŠ¡è¿›ç¨‹, å…¶é»˜è®¤çš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># cat /etc/cron.d/clickhouse-server</span></span><br><span class="line"><span class="comment">#*/10 * * * * root ((which service &gt; /dev/null 2&gt;&amp;1 &amp;&amp; (service clickhouse-server condstart ||:)) || /etc/init.d/clickhouse-server condstart) &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line">[root@satori ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ä»¥çœ‹åˆ°é»˜è®¤æƒ…å†µï¼Œæ¯éš” 10 ç§’å°±ä¼šä½¿ç”¨ condstart å°è¯•å¯åŠ¨ä¸€æ¬¡ ClickHouse æœåŠ¡ï¼Œå¦‚æœ ClickHouse æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œåˆ™è·³è¿‡ï¼›å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œåˆ™å¯åŠ¨ã€‚</strong></p>
<p><strong>3) æœ€åæ˜¯åœ¨ &#x2F;usr&#x2F;bin ç›®å½•ä¸‹çš„å¯åŠ¨æ–‡ä»¶</strong></p>
<p><strong>ClickHouse ç›¸å…³çš„å¯åŠ¨æ–‡ä»¶éƒ½ä½äº &#x2F;usr&#x2F;bin ç›®å½•ä¸‹ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173206870-757028996.png" alt="img"></p>
<p><strong>å¯æ‰§è¡Œæ–‡ä»¶æ•°é‡è¿˜æ˜¯è›®å¤šçš„ï¼Œå…¶ä¸­å››ä¸ªæœ€å¸¸ç”¨ã€‚</strong></p>
<ul>
<li><code>clickhouse: ä¸»ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶</code></li>
<li><code>clickhouse-client: ä¸€ä¸ªæŒ‡å‘ ClickHouse å¯æ‰§è¡Œæ–‡ä»¶çš„è½¯è¿æ¥, ä¾›å®¢æˆ·ç«¯è¿æ¥ä½¿ç”¨</code></li>
<li><code>clickhouse-server: ä¸€ä¸ªæŒ‡å‘ ClickHouse å¯æ‰§è¡Œæ–‡ä»¶çš„è½¯è¿æ¥, ä¾›æœåŠ¡ç«¯å¯åŠ¨ä½¿ç”¨</code></li>
<li><code>clickhouse-compressor: å†…ç½®æä¾›çš„å‹ç¼©å·¥å…·, å¯ç”¨äºæ•°æ®çš„æ­£å‹åè§£</code></li>
</ul>
<h3 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h3><p><strong>ClickHouse ç»™æˆ‘ä»¬æä¾›äº†éå¸¸ä¼˜é›…çš„å¯åŠ¨æ–¹å¼ã€‚</strong></p>
<ul>
<li><strong>å¯åŠ¨ ClickHouseï¼šclickhouse start</strong></li>
<li><strong>å…³é—­ ClickHouseï¼šclickhouse stop</strong></li>
<li><strong>é‡å¯ ClickHouseï¼šclickhouse restart</strong></li>
</ul>
<p><strong>æ³¨æ„ï¼šåœ¨å®‰è£… ClickHouse çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåä¸º clickhouse çš„ç”¨æˆ·ï¼Œå¯åŠ¨è„šæœ¬ä¼šåŸºäºæ­¤ç”¨æˆ·æ¥å¯åŠ¨æœåŠ¡ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°† clickhouse ç”¨æˆ·å…·å¤‡ç›¸å…³ç›®å½•çš„æƒé™ï¼Œå¦‚æœä¸èµ‹æƒé™ï¼ŒClickHouse å¯èƒ½ä¼šå¯åŠ¨å¤±è´¥ã€‚</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> clickhouse.clickhouse /var/log/clickhouse-server/ -R </span><br><span class="line"><span class="built_in">chown</span> clickhouse.clickhouse /var/lib/clickhouse/ -R </span><br><span class="line"><span class="comment"># å¦‚æœåç»­ä½ ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œæ”¹å˜äº† ClickHouse çš„æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé‚£ä¹ˆä¹Ÿè¦è®°å¾—èµ‹ç»™å®ƒç›¸åº”çš„æƒé™</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦å¤–ï¼Œä¸Šé¢é€šè¿‡ clickhouse start å¯åŠ¨çš„æ—¶å€™æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œæ²¡é”™ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯åŠ¨çš„è¯ï¼Œä¼šè‡ªåŠ¨åŠ è½½ &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xmlã€‚</strong></p>
<p><strong>ä½†å¦‚æœæˆ‘ä»¬æƒ³æ‰‹åŠ¨æŒ‡å®šé…ç½®æ–‡ä»¶çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ clickhouse-serverã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">clickhouse-server --config-file /etc/clickhouse-server/config.xml --daemon</span><br></pre></td></tr></table></figure>

<p><strong>â€“config-file è´Ÿè´£æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿™æ ·å³ä½¿å°†é…ç½®æ–‡ä»¶æ”¾åœ¨äº†åˆ«çš„åœ°æ–¹ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥æ˜¾å¼åœ°æŒ‡å®šå®ƒçš„ä½ç½®ï¼›â€“daemon è¡¨ç¤ºåå°å¯åŠ¨ï¼Œå› ä¸ºé»˜è®¤æ˜¯å‰å°å¯åŠ¨çš„ã€‚</strong></p>
<p><strong>ä½†æ˜¯æ³¨æ„ï¼šä½¿ç”¨ clickhouse-server å¯åŠ¨çš„è¯ï¼Œä¸èƒ½ä½¿ç”¨ rootï¼Œéœ€è¦åˆ‡æ¢åˆ° clickhouse ç”¨æˆ·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥è¿™ä¹ˆåšã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo -u clickhouse clickhouse-server --config-file /etc/clickhouse-server/config.xml --daemon</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šsudo -u åé¢çš„ clickhouse æŒ‡çš„æ˜¯åä¸º clickhouse çš„ç”¨æˆ·ï¼Œclickhouse start é‡Œé¢çš„ clickhouse æŒ‡çš„æ˜¯ &#x2F;usr&#x2F;bin é‡Œé¢çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™é‡Œç”±äºæˆ‘ä»¬é…ç½®æ–‡ä»¶å°±åœ¨é»˜è®¤è·¯å¾„ä¸‹ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ clickhouse start å¯åŠ¨ï¼Œé»˜è®¤åŠ è½½ &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xmlã€å¹¶ä¸”åå°å¯åŠ¨ã€‚è‡³äºå…³é—­çš„è¯ï¼Œç›´æ¥ clickhouse stop å³å¯ã€‚</strong></p>
<h3 id="å®¢æˆ·ç«¯çš„è®¿é—®æ¥å£"><a href="#å®¢æˆ·ç«¯çš„è®¿é—®æ¥å£" class="headerlink" title="å®¢æˆ·ç«¯çš„è®¿é—®æ¥å£"></a>å®¢æˆ·ç«¯çš„è®¿é—®æ¥å£</h3><p><strong>ClickHouse æœåŠ¡ç«¯çš„åº•å±‚è®¿é—®æ¥å£æ”¯æŒ TCP å’Œ HTTP ä¸¤ç§æ–¹å¼ï¼Œå…¶ä¸­ TCP æ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå…¶é»˜è®¤ç›‘å¬ 9000 ç«¯å£ï¼Œä¸»è¦ç”¨äºé›†ç¾¤é—´çš„å†…éƒ¨é€šä¿¡åŠ clickhouse-client å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼›è€Œ HTTP åè®®åˆ™æ‹¥æœ‰æ›´å¥½çš„å…¼å®¹æ€§ï¼Œå¯ä»¥é€šè¿‡ REST æœåŠ¡çš„å½¢å¼è¢«å¹¿æ³›ç”¨äºç¼–ç¨‹è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå…¶é»˜è®¤ç›‘å¬ 8123 ç«¯å£ã€‚</strong></p>
<p><strong>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»å‡ ç§è¿æ¥æ–¹å¼ã€‚</strong></p>
<h4 id="ä½¿ç”¨å®¢æˆ·ç«¯-clickhouse-client-è¿æ¥æœåŠ¡ç«¯"><a href="#ä½¿ç”¨å®¢æˆ·ç«¯-clickhouse-client-è¿æ¥æœåŠ¡ç«¯" class="headerlink" title="ä½¿ç”¨å®¢æˆ·ç«¯ clickhouse-client è¿æ¥æœåŠ¡ç«¯"></a>ä½¿ç”¨å®¢æˆ·ç«¯ clickhouse-client è¿æ¥æœåŠ¡ç«¯</h4><p><strong>é€šè¿‡ clickhouse start å°†æœåŠ¡å¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥äº†ï¼Œé€šè¿‡ clickhouse-clientï¼Œé»˜è®¤ä¼šè¿æ¥åˆ°æœ¬æœºçš„ 9000 ç«¯å£ï¼Œå¹¶ä½¿ç”¨ default ç”¨æˆ·ï¼Œå¦‚æœæƒ³å•ç‹¬æŒ‡å®šçš„è¯å¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">clickhouse-client --host åœ°å€ --port ç«¯å£ --user ç”¨æˆ· --password å¯†ç </span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œæˆ‘ä»¬çš„æœåŠ¡ç«¯é»˜è®¤ä¹Ÿæ˜¯ç›‘å¬ 9000 ç«¯å£ï¼Œå¹¶ä¸” default ç”¨æˆ·è¿˜æ²¡æœ‰å¯†ç ï¼Œæ‰€ä»¥ç›´æ¥è¾“å…¥ clickhouse-client å³å¯è¿æ¥ä¸Šã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173219404-1535534933.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°è¿æ¥æˆåŠŸï¼Œå¹¶ä¸”ä¹ŸæŸ¥è¯¢æˆåŠŸäº†ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹å›¾ä¸­ show databases å‰é¢çš„æç¤ºå†…å®¹ï¼Œå¾ˆæ˜æ˜¾å®ƒå°±æ˜¯æˆ‘ä»¬åˆšæ‰è®¾ç½®çš„ FQDNã€‚è‡³æ­¤ï¼Œå•èŠ‚ç‚¹ ClickHouse çš„å®‰è£…å°±ç®—å®Œæ¯•äº†ï¼Œè‡³äºé›†ç¾¤çš„æ­å»ºæˆ‘ä»¬åé¢ä¼šè¯´ã€‚</strong></p>
<p><strong>æ’å¥é¢˜å¤–è¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ–° ClickHouseï¼Œé‚£ä¹ˆç›´æ¥ä¸‹è½½æ–°ç‰ˆçš„ ClickHouse RPM åŒ…å³å¯ï¼Œç„¶åè¿›è¡Œæ›´æ–°ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rpm -Uvh ./*.rpm</span><br></pre></td></tr></table></figure>

<p><strong>å‡çº§çš„æ—¶å€™ï¼ŒåŸæœ‰çš„é…ç½®å‡ä¼šä¿ç•™ã€‚</strong></p>
<p><strong>ç„¶åæˆ‘ä»¬å†æ¥èŠä¸€ä¸‹ clickhouse-clientï¼Œæˆ‘ä»¬ä¸Šé¢é€šè¿‡è¾“å…¥ clickhouse-client è¿›å…¥å‘½ä»¤è¡Œã€ç„¶åå†æ‰§è¡Œ SQL çš„æ–¹å¼å«åš â€œäº¤äº’å¼æ‰§è¡Œâ€ï¼Œä¸€èˆ¬ç”¨äºè°ƒè¯•ã€è¿ç»´ã€å¼€å‘å’Œæµ‹è¯•ç­‰åœºæ™¯ã€‚</strong></p>
<p><strong>é€šè¿‡äº¤äº’å¼æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œç›¸å…³æŸ¥è¯¢ç»“æœä¼šç»Ÿä¸€è®°å½•åˆ° ~&#x2F;.clickhouse-client-history æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½œä¸ºå®¡è®¡ä¹‹ç”¨ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173228787-1516845254.png" alt="img"></p>
<p><strong>ä½†é™¤äº†äº¤äº’å¼æ‰§è¡Œä¹‹å¤–ï¼Œè¿˜æœ‰éäº¤äº’å¼æ‰§è¡Œã€‚éäº¤äº’å¼æ‰§è¡Œä¸»è¦ç”¨äºæ‰¹å¤„ç†åœºæ™¯ï¼Œè¯¸å¦‚å¯¹æ•°æ®çš„å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œï¼Œåœ¨æ‰§è¡Œè„šæœ¬å‘½ä»¤æ—¶ï¼Œéœ€è¦è¿½åŠ  â€“query å‚æ•°æŒ‡å®šæ‰§è¡Œçš„ SQL è¯­å¥ã€‚ä¸¾ä¸ªæ —å­ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> xxx.csv | clickhouse-client --query <span class="string">&quot;INSERT INTO some_table FORMAT CSV&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨å¯¼å…¥æ•°æ®æ—¶ï¼Œå®ƒå¯ä»¥æ¥æ”¶æ“ä½œç³»ç»Ÿçš„ stdin æ ‡å‡†è¾“å…¥ä½œä¸ºå†™å…¥çš„æ•°æ®ã€‚æ‰€ä»¥ cat å‘½ä»¤è¯»å–çš„æ–‡ä»¶æµï¼Œå°†ä¼šä½œä¸º INSERT æŸ¥è¯¢çš„æ•°æ®è¾“å…¥ï¼Œè€Œåœ¨æ•°æ®å¯¼å‡ºæ—¶ï¼Œåˆ™å¯ä»¥è¾“å‡ºæµé‡å®šå‘åˆ°æ–‡ä»¶ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">clickhouse-client --query <span class="string">&quot;SELECT * FROM some_table&quot;</span> &gt;&gt; xxx.csv</span><br></pre></td></tr></table></figure>

<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œclickhouse-client ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€æ¡ SQL è¯­å¥ï¼Œå¦‚æœéœ€è¦æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œåˆ™éœ€è¦åœ¨å¾ªç¯ä¸­é‡å¤æ‰§è¡Œï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ã€‚æ­¤æ—¶å¯ä»¥è¿½åŠ  â€“multiquery å‚æ•°ï¼Œå®ƒå¯ä»¥æ”¯æŒä¸€æ¬¡è¿è¡Œå¤šæ¡SQLæŸ¥è¯¢ï¼Œå¤šæ¡æŸ¥è¯¢ä¹‹é—´ä½¿ç”¨åˆ†å·åˆ†éš”ï¼Œæ¯”å¦‚ï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173243014-1287564968.png" alt="img"></p>
<p><strong>å¤šæ¡ SQL çš„æŸ¥è¯¢ç»“æœé›†ä¼šä¾æ¬¡æŒ‰ç…§é¡ºåºè¿”å›ã€‚</strong></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ clickhouse-client çš„ä¸¤ç§è¿è¡Œæ–¹å¼ï¼Œç”±äºæä¾›äº†éäº¤äº’å¼æ‰§è¡Œçš„åŠŸèƒ½ï¼Œæ‰€ä»¥ ClickHouse çš„å®¢æˆ·ç«¯æ¯”å…¶å®ƒæ•°æ®åº“çš„å®¢æˆ·ç«¯è¦å¼ºå¤§ä¸€äº›ã€‚ä¸‹é¢æ•´ç†ä¸€ä¸‹ clickhouse-client å¸¸ç”¨çš„ç›¸å…³å‚æ•°ï¼š</strong></p>
<ul>
<li><code>--host/-h: æŒ‡å®šè¿æ¥çš„æœåŠ¡ç«¯çš„åœ°å€, é»˜è®¤æ˜¯ localhostï¼Œå¦‚æœæœåŠ¡ç«¯çš„åœ°å€ä¸æ˜¯ localhost, åˆ™éœ€è¦ä¾é æ­¤å‚æ•°è¿›è¡ŒæŒ‡å®š, ä¾‹å¦‚ clickhouse-client -h xx.xx.xx.xx</code></li>
<li><code>--port: æœåŠ¡ç«¯çš„ TCP ç«¯å£, é»˜è®¤æ˜¯ 9000ï¼Œå¦‚æœæœåŠ¡ç«¯ç›‘å¬çš„ä¸æ˜¯ 9000, åˆ™éœ€è¦æ­¤å‚æ•°æŒ‡å®š</code></li>
<li><code>--user/-u: ç™»å½•çš„ç”¨æˆ·å, é»˜è®¤æ˜¯ defaultã€‚å¦‚æœä½¿ç”¨é default çš„ç”¨æˆ·åç™»å½•, åˆ™éœ€è¦ä½¿ç”¨æ­¤å‚æ•°æŒ‡å®š</code></li>
<li><code>--password: ç™»å½•çš„å¯†ç , é»˜è®¤å€¼ä¸ºç©ºã€‚å¦‚æœåœ¨ç”¨æˆ·å®šä¹‰ä¸­æœªè®¾ç½®å¯†ç , åˆ™æ— éœ€å¡«å†™ï¼ˆæ¯”å¦‚é»˜è®¤çš„ default ç”¨æˆ·ï¼Œæˆ‘ä»¬æ²¡æœ‰è®¾ç½®å¯†ç ï¼‰</code></li>
<li><code>--database/-d: ç™»å½•ä¹‹åæ‰€åœ¨çš„æ•°æ®åº“, é»˜è®¤ä¸º default</code></li>
<li><code>--query/-q: åªèƒ½åœ¨éäº¤äº’å¼æŸ¥è¯¢æ—¶ä½¿ç”¨, ç”¨äºæ‰§è¡ŒæŒ‡å®šçš„ SQL è¯­å¥</code></li>
<li><code>--multiquery/-n: åœ¨éäº¤äº’å¼æ‰§è¡Œæ—¶, å…è®¸ä¸€æ¬¡è¿è¡Œå¤šæ¡ SQL è¯­å¥, å¤šæ¡è¯­å¥ä¹‹é—´ç”¨åˆ†å·éš”å¼€</code></li>
<li><code>--time/-t: åœ¨éäº¤äº’å¼æ‰§è¡Œæ—¶, ä¼šæ‰“å°æ¯æ¡ SQL çš„æ‰§è¡Œæ—¶é—´</code></li>
</ul>
<p><strong>æ›´å¤šå‚æ•°å¯ä»¥é€šè¿‡ clickhouse-client â€“help æŸ¥çœ‹ï¼Œæ•°é‡å¤šåˆ°ææ€–ã€‚</strong></p>
<h4 id="Python-è¿æ¥-ClickHouse-æœåŠ¡ç«¯"><a href="#Python-è¿æ¥-ClickHouse-æœåŠ¡ç«¯" class="headerlink" title="Python è¿æ¥ ClickHouse æœåŠ¡ç«¯"></a>Python è¿æ¥ ClickHouse æœåŠ¡ç«¯</h4><p><strong>é¦–å…ˆ ClickHouse æ”¯æŒä½¿ç”¨ JDBC è¿æ¥ï¼Œä½†æˆ‘æœ¬èº«ä¸æ˜¯ JAVA æ–¹å‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»ä½¿ç”¨ Python è¿æ¥ ClickHouse çš„æ–¹å¼ã€‚</strong></p>
<blockquote>
<p><strong>Python è¿æ¥ ClickHouse çš„è¯éœ€è¦å®‰è£…ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œç›´æ¥ pip install clickhouse-driver å³å¯ã€‚</strong></p>
</blockquote>
<p><strong>æ³¨æ„ï¼šæˆ‘ä»¬è¯´ HTTP åè®®ä½¿ç”¨çš„æ˜¯ 8123 ç«¯å£ï¼Œä½†æ˜¯ Python è¿™ä¸ªåŒ…æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå’Œ clickhouse-client ä¸€æ ·ï¼Œä½¿ç”¨çš„ä¹Ÿæ˜¯ TCP åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´ç«¯å£éœ€è¦æŒ‡å®šä¸º 9000ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173251635-1249075618.png" alt="img"></p>
<p><strong>ä½¿ç”¨ Python æ˜¯å¯ä»¥è¿æ¥çš„ï¼Œä½†æ˜¯æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œæ˜¯åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ Python è¿æ¥çš„ï¼Œå¦‚æœéœ€è¦åœ¨å…¶å®ƒæœºå™¨ä¸Šè¿æ¥çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä½¿ç”¨ localhost äº†ã€‚</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> clickhouse_driver <span class="keyword">import</span> Client</span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€è¦æŒ‡å®šå…·ä½“çš„ ip</span></span><br><span class="line">client = Client(host=<span class="string">&quot;47.94.174.89&quot;</span>, port=<span class="number">9000</span>)</span><br><span class="line"><span class="built_in">print</span>(client.execute(<span class="string">&quot;show databases&quot;</span>))</span><br></pre></td></tr></table></figure>

<p><strong>ä¸è¿‡æ­¤æ—¶ä»æ— æ³•åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šè®¿é—®ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹æœåŠ¡ç«¯çš„é…ç½®ï¼Œvim &#x2F;etc&#x2F;clickhouse-server&#x2F;config.xmlï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173300172-176175199.png" alt="img"></p>
<p><strong>listen_host è¿™ä¸ªæ ‡ç­¾é»˜è®¤æ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œä¹Ÿå°±æ˜¯åªç›‘å¬æ¥è‡ªæœ¬æœºçš„è¯·æ±‚ã€‚è¿™é‡Œæˆ‘ä»¬å°†æ³¨é‡Šæ‰“å¼€ï¼Œæˆ–è€…ä¸ç®¡æ³¨é‡Šï¼Œç›´æ¥æ‰‹åŠ¨å¢åŠ ä¸€æ¡ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ”¹æˆ 0.0.0.0ï¼Œè¿™æ ·å³å¯æ¥æ”¶æ¥è‡ªå…¶å®ƒæœºå™¨ä¸Šçš„è¯·æ±‚ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶ Python å³å¯åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šè®¿é—®äº†ï¼Œæ³¨æ„ï¼šæœåŠ¡å™¨çš„ 9000 ç«¯å£æ˜¯è¦å¯¹å¤–å¼€æ”¾çš„ï¼Œè¿™é‡Œæˆ‘é˜¿é‡Œäº‘æœåŠ¡å™¨çš„ 9000ã€8123 ç«¯å£éƒ½å·²ç»å¯¹å¤–äº†ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173307872-1755060506.png" alt="img"></p>
<p><strong>æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ sqlalchemy å»è¿æ¥ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ sqlalchemy æ‰¾ä¸åˆ°å¯¹åº”çš„ dialectï¼Œæˆ‘ä»¬éœ€è¦å†å®‰è£…ä¸€ä¸ªæ¨¡å—ï¼špip install sqlalchemy_clickhouseï¼Œå®‰è£…ä¹‹åå°±å¯ä»¥ä½¿ç”¨äº†ã€‚</strong></p>
<p><strong>ä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šä½¿ç”¨ sqlalchemy_clickhouse çš„è¯ï¼Œé‚£ä¹ˆè¿æ¥çš„ç«¯å£å°±ä¸èƒ½æ˜¯ 9000 äº†ï¼Œè€Œæ˜¯ 8123ã€‚æ›´å‡†ç¡®çš„è¯´ï¼Œéœ€è¦ä½¿ç”¨ HTTP ç«¯å£ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173314413-994480208.png" alt="img"></p>
<p><strong>ä»¥ä¸Šå°±æ˜¯ Python è¿æ¥ ClickHouse çš„ä¸¤ç§æ–¹å¼ï¼Œè¿˜æ˜¯æŒºå®¹æ˜“çš„ã€‚</strong></p>
<h4 id="DataGrip-è¿æ¥-ClickHouse-æœåŠ¡ç«¯"><a href="#DataGrip-è¿æ¥-ClickHouse-æœåŠ¡ç«¯" class="headerlink" title="DataGrip è¿æ¥ ClickHouse æœåŠ¡ç«¯"></a>DataGrip è¿æ¥ ClickHouse æœåŠ¡ç«¯</h4><p><strong>DataGrip æ˜¯ JetBrains å…¬å¸å¼€å‘çš„ä¸€ä¸ª IDEï¼Œä¸“é—¨è´Ÿè´£è¿æ¥æ•°æ®åº“ï¼Œå…¶ä¸­ä¹ŸåŒ…å«äº†å¯¹ ClickHouse çš„æ”¯æŒã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173323068-652157345.png" alt="img"></p>
<p><strong>ç‚¹å‡»ä¹‹åä¸‹è½½ç›¸åº”çš„é©±åŠ¨ï¼Œç„¶åè¾“å…¥ç›¸å…³ä¿¡æ¯å³å¯ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173335772-2053147215.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°è¿æ¥æˆåŠŸï¼Œé‡Œé¢è¿˜æ˜¾ç¤ºäº† ClickHouse æ”¯æŒçš„å†…ç½®å‡½æ•°ã€‚ç„¶åæˆ‘ä»¬æ‰§è¡Œ SQL è¯­å¥æµ‹è¯•ä¸€ä¸‹ï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173345219-323654674.png" alt="img"></p>
<h3 id="å†…ç½®çš„å®ç”¨å·¥å…·"><a href="#å†…ç½®çš„å®ç”¨å·¥å…·" class="headerlink" title="å†…ç½®çš„å®ç”¨å·¥å…·"></a>å†…ç½®çš„å®ç”¨å·¥å…·</h3><p><strong>æˆ‘ä»¬è¯´ &#x2F;usr&#x2F;bin ä¸‹é¢åŒ…å«äº†å¾ˆå¤šå…³äº ClickHouse çš„å¯åŠ¨æ–‡ä»¶ï¼Œé™¤äº†ä¹‹å‰ä»‹ç»çš„å››ä¸ªï¼Œè¿™é‡Œå†ä»‹ç»ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ clickhouse-local å’Œ clickhouse-benchmarkã€‚</strong></p>
<h4 id="clickhouse-local"><a href="#clickhouse-local" class="headerlink" title="clickhouse-local"></a>clickhouse-local</h4><p><strong>clickhouse-local å¯ä»¥ç‹¬ç«‹è¿è¡Œå¤§éƒ¨åˆ†çš„ SQL æŸ¥è¯¢ï¼Œä¸éœ€è¦ä¾èµ–ä»»ä½• ClickHouse æœåŠ¡ç«¯ç¨‹åºï¼Œå®ƒå¯ä»¥ç†è§£ä¸º ClickHouse æœåŠ¡çš„å•æœºç‰ˆå†…æ ¸ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§çš„åº”ç”¨ç¨‹åºã€‚clickhouse-local åªèƒ½å¤Ÿä½¿ç”¨ File å¼•æ“ï¼ˆæˆ–è€…ç§°ä¹‹ä¸ºè¡¨å¼•æ“ï¼‰ï¼Œå…³äºå¼•æ“åé¢ä¼šå±•å¼€ã€‚å®ƒçš„æ•°æ®ä¸åŒæœºè¿è¡Œçš„ ClickHouse æœåŠ¡ä¹‹é—´ä¹Ÿæ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œäº’ç›¸å¹¶ä¸èƒ½è®¿é—®ã€‚</strong></p>
<p><strong>clickhouse-local æ˜¯éäº¤äº’å¼çš„ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½éœ€è¦æŒ‡å®šæ•°æ®æ¥æºï¼Œä¾‹å¦‚é€šè¿‡ stdin æ ‡å‡†è¾“å…¥ï¼Œä»¥ echo æ‰“å°ä½œä¸ºæ•°æ®æ¥æºï¼š</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173352370-520401822.png" alt="img"></p>
<p><strong>ä¹Ÿå¯ä»¥å€ŸåŠ©æ“ä½œç³»ç»Ÿçš„å‘½ä»¤ï¼Œå®ç°å¯¹ç³»ç»Ÿç”¨æˆ·å†…å­˜ç”¨é‡çš„æŸ¥è¯¢ã€‚</strong></p>
<p><img src="/2023/02/01/ClickHouse%20%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BB%A5%E5%8F%8A%E8%BF%9E%E6%8E%A5%E5%B7%A5%E5%85%B7(%E4%BA%8C)/1229382-20210816173358237-1560136843.png" alt="img"></p>
<p><strong>clickhouse-local çš„å‚æ•°ç”¨æ³•å¯ä»¥é€šè¿‡ â€“help æŸ¥çœ‹ï¼Œä½†æ˜¯ä¸ªäººè§‰å¾—ä¸æ˜¯å¾ˆå¸¸ç”¨ã€‚</strong></p>
<h4 id="clickhouse-benchmark"><a href="#clickhouse-benchmark" class="headerlink" title="clickhouse-benchmark"></a>clickhouse-benchmark</h4><p><strong>clickhouse-benchmark æ˜¯åŸºå‡†æµ‹è¯•çš„å°å·¥å…·ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨è¿è¡Œ SQL æŸ¥è¯¢ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„è¿è¡ŒæŒ‡æ ‡æŠ¥å‘Šï¼Œä¾‹å¦‚æ‰§è¡Œä¸‹é¢çš„è¯­å¥å¯åŠ¨æµ‹è¯•ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SELECT * FROM table&quot;</span> | clickhouse-benchmark -i 5</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œä¹‹åï¼ŒæŒ‰ç…§æŒ‡å®šå‚æ•°çš„æŸ¥è¯¢ä¼šè¢«æ‰§è¡Œ 5 æ¬¡ã€‚æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¼šæ˜¾ç¤ºåŒ…å« QPSã€RPS ç­‰æŒ‡æ ‡ä¿¡æ¯çš„æŠ¥å‘Šï¼Œè¿˜ä¼šåˆ—å‡ºå„ç™¾åˆ†ä½çš„æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ã€‚</strong></p>
<p><strong>å¦‚æœæƒ³æµ‹è¯•å¤šæ¡ SQLï¼Œæ­¤æ—¶å°±éœ€è¦å°† SQL å†™åœ¨æ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡ clickhouse-benchmark -i 5 &lt; æ–‡ä»¶è·¯å¾„ï¼Œå°†é‡Œé¢çš„ SQL æŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</strong></p>
<blockquote>
<p><strong>è¿™é‡Œæˆ‘å°±ä¸ä½¿ç”¨å…·ä½“çš„æ•°æ®æµ‹è¯•äº†ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹ã€‚</strong></p>
</blockquote>
<p><strong>clickhouse-benchmark çš„ä¸€äº›æ ¸å¿ƒå‚æ•°å¯ä»¥é€šè¿‡ â€“help æŸ¥çœ‹ã€‚</strong></p>
<p><strong>ä»¥ä¸Šæˆ‘ä»¬ä»‹ç»äº†åŸºäºç¦»çº¿ RPM åŒ…å®‰è£… ClickHouse çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒæ–¹å¼å®‰è£…ï¼Œæ¯”å¦‚ï¼šåœ¨çº¿å®‰è£…ã€æˆ–è€…ä½¿ç”¨ docker ç­‰ç­‰ã€‚äº‹å®ä¸Šï¼Œè¿™ç§ç¦»çº¿å®‰è£…çš„æ–¹å¼ä¹Ÿä¸éº»çƒ¦ï¼Œç›¸åä¸ªäººè§‰å¾—è¿˜å¾ˆç®€å•ã€‚ç„¶åè¿˜ä»‹ç»äº†è®¿é—® ClickHouse çš„ä¸¤ä¸ªæ¥å£ï¼ŒTCP æ¥å£å’Œ HTTP æ¥å£ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ Python å»è®¿é—®ã€‚é‚£ä¹ˆå°±æ¥å­¦ä¹  ClickHouse çš„å…·ä½“è¯­æ³•äº†ï¼Œé¦–å…ˆä¼šä»æ•°æ®å®šä¹‰å¼€å§‹ã€‚</strong></p>
<p>â€‹																		æœ¬æ–‡æ¥æºï¼š (<a href="https://www.cnblogs.com/traditional/p/15218595.html">https://www.cnblogs.com/traditional/p/15218595.html</a>) </p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„ç®¡ç†ä¸è¿ç»´(åä¹)</title>
    <url>/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„ç®¡ç†ä¸è¿ç»´-åä¹"><a href="#ClickHouse-çš„ç®¡ç†ä¸è¿ç»´-åä¹" class="headerlink" title="ClickHouse çš„ç®¡ç†ä¸è¿ç»´(åä¹)"></a>ClickHouse çš„ç®¡ç†ä¸è¿ç»´(åä¹)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><p><strong>ä¸‹é¢æ¥è¯´ä¸€ä¸‹ ClickHouse ç®¡ç†å’Œè¿ç»´ç›¸å…³çš„çŸ¥è¯†ï¼Œè¯¥éƒ¨åˆ†å¯ä»¥è®© ClickHouse å˜å¾—æ›´åŠ å®‰å…¨ä¸å¥å£®ã€‚åœ¨å‰é¢æ¼”ç¤ºçš„æ¡ˆä¾‹ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨é»˜è®¤çš„ default ç”¨æˆ·ï¼Œå¹¶ä¸”æ²¡æœ‰é…ç½®å¯†ç ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç”Ÿäº§ç¯å¢ƒçš„è¦æ±‚ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä»‹ç» ClickHouse çš„æƒé™ã€ç†”æ–­æœºåˆ¶ã€æ•°æ®å¤‡ä»½å’ŒæœåŠ¡ç›‘æ§ç­‰çŸ¥è¯†ã€‚</strong></p>
<h2 id="ç”¨æˆ·é…ç½®"><a href="#ç”¨æˆ·é…ç½®" class="headerlink" title="ç”¨æˆ·é…ç½®"></a>ç”¨æˆ·é…ç½®</h2><p><strong>users.xml é…ç½®æ–‡ä»¶é»˜è®¤ä½äº &#x2F;etc&#x2F;clickhouse-server è·¯å¾„ä¸‹ï¼ŒClickHouse ç”¨å®ƒæ¥å®šä¹‰ç”¨æˆ·ç›¸å…³çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ç³»ç»Ÿå‚æ•°çš„è®¾å®šã€ç”¨æˆ·çš„å®šä¹‰ã€æƒé™ä»¥åŠç†”æ–­æœºåˆ¶ç­‰ã€‚</strong></p>
<h3 id="ç”¨æˆ·çš„è§’è‰²é…ç½®ï¼ˆprofileï¼‰"><a href="#ç”¨æˆ·çš„è§’è‰²é…ç½®ï¼ˆprofileï¼‰" class="headerlink" title="ç”¨æˆ·çš„è§’è‰²é…ç½®ï¼ˆprofileï¼‰"></a>ç”¨æˆ·çš„è§’è‰²é…ç½®ï¼ˆprofileï¼‰</h3><p><strong>åœ¨ users.xml ä¸­æœ‰ä¸€ä¸ª profiles æ ‡ç­¾ï¼Œåœ¨è¯¥æ ‡ç­¾ä¸­æˆ‘ä»¬å¯ä»¥å®šä¹‰ç”¨æˆ·è§’è‰²ï¼Œå…ˆçœ‹çœ‹é»˜è®¤é…ç½®ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182628794-2170109.png" alt="img"></p>
<p><strong>è¿™æ˜¯ ClickHouse çš„é»˜è®¤é…ç½®ï¼Œæ˜¾ç„¶é»˜è®¤æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯ default å’Œ readonlyã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ default å’Œ readonly æŒ‡çš„æ˜¯è§’è‰²ï¼Œæ¯ä¸€ä¸ªç”¨æˆ·éƒ½å…·æœ‰ä¸€ä¸ªè§’è‰²ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ CLI ä¸­ç›´æ¥åˆ‡æ¢åˆ°æƒ³è¦çš„è§’è‰²ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SET profile = &#x27;è§’è‰²å&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œé¦–å…ˆæˆ‘ä»¬é»˜è®¤ä½¿ç”¨çš„æ˜¯ default ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²é»˜è®¤ä¹Ÿæ˜¯ defaultã€‚ç„¶åè¿˜æœ‰ä¸€ä¸ª readonly è§’è‰²ï¼Œä»åå­—ä¸Šä¹Ÿèƒ½çœ‹å‡ºè¯¥è§’è‰²åªèƒ½è¯»æ•°æ®ï¼Œæ— æ³•å†™æ•°æ®ï¼Œå› ä¸ºå†…éƒ¨çš„ readonly å±æ€§ä¸º 1ï¼Œé»˜è®¤ä¸º 0ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182636026-1515976262.png" alt="img"></p>
<p><strong>å½“ default ç”¨æˆ·å…·æœ‰ default è§’è‰²æ—¶ï¼Œå†™æ•°æ®ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯å°† default ç”¨æˆ·çš„è§’è‰²åˆ‡æ¢ä¸º readonly æ—¶åˆ™è¢«å‘ŠçŸ¥ï¼šCannot execute query in readonly modeã€‚å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ default è§’è‰²å¯¹åº”é…ç½®ä¸­ä¹ŸåŠ ä¸Š 1ï¼Œé‚£ä¹ˆå…·æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·åŒæ ·ä¹Ÿä¼šæ— æ³•å†™æ•°æ®ã€‚</strong></p>
<p><strong>åœ¨æ‰€æœ‰çš„è§’è‰²é…ç½®ï¼ˆprofileï¼‰ä¸­ï¼Œåç§°ä¸º default çš„ profile å°†ä½œä¸ºé»˜è®¤çš„é…ç½®è¢«åŠ è½½ï¼Œæ‰€ä»¥å®ƒå¿…é¡»å­˜åœ¨ã€‚å¦‚æœç¼ºå¤±åä¸º default çš„ profileï¼Œé‚£ä¹ˆ ClickHouse Server ä¼šå¯åŠ¨å¤±è´¥ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Application: DB::Exception: Settings profile`default`not found</span><br></pre></td></tr></table></figure>

<p><strong>profile è¿˜æ”¯æŒç»§æ‰¿ï¼Œå®ç°ç»§æ‰¿çš„æ–¹å¼æ˜¯åœ¨å®šä¹‰ä¸­å¼•ç”¨å…¶ä»–çš„ profile åç§°ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">my_role</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;profile&gt;default2&lt;/profile&gt; å¯ä»¥ç»§æ‰¿å¤šä¸ª--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributed_product_mode</span>&gt;</span>deny<span class="tag">&lt;/<span class="name">distributed_product_mode</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">my_role</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç›¸å½“äºæ–°å»ºäº†ä¸€ä¸ªåä¸º my_role çš„è§’è‰²ï¼Œç„¶ååœ¨å¯¹åº”çš„ profile ä¸­ç»§æ‰¿äº† default çš„æ‰€æœ‰é…ç½®é¡¹ï¼Œå¹¶ä¸”ä½¿ç”¨æ–°çš„å‚æ•°å€¼è¦†ç›–äº† default ä¸­åŸæœ‰çš„ distributed_product_mode é…ç½®é¡¹ã€‚</strong></p>
<h3 id="é…ç½®çº¦æŸ"><a href="#é…ç½®çº¦æŸ" class="headerlink" title="é…ç½®çº¦æŸ"></a>é…ç½®çº¦æŸ</h3><p><strong>constraints æ ‡ç­¾å¯ä»¥è®¾ç½®ä¸€ç»„çº¦æŸæ¡ä»¶ï¼Œä»¥ä¿éšœ profile å†…çš„å‚æ•°å€¼ä¸ä¼šè¢«éšæ„ä¿®æ”¹ï¼Œçº¦æŸæ¡ä»¶æœ‰å¦‚ä¸‹ä¸‰ç§è§„åˆ™ï¼š</strong></p>
<ul>
<li><code>minï¼šæœ€å°å€¼çº¦æŸï¼Œåœ¨è®¾ç½®ç›¸åº”å‚æ•°çš„æ—¶å€™ï¼Œå–å€¼ä¸èƒ½å°äºè¯¥é˜ˆå€¼</code></li>
<li><code>maxï¼šæœ€å°å€¼çº¦æŸï¼Œåœ¨è®¾ç½®ç›¸åº”å‚æ•°çš„æ—¶å€™ï¼Œå–å€¼ä¸èƒ½å¤§äºè¯¥é˜ˆå€¼</code></li>
<li><code>readonlyï¼šåªè¯»çº¦æŸï¼Œè¯¥å‚æ•°å€¼ä¸èƒ½è¢«ä¿®æ”¹</code></li>
</ul>
<p><strong>ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182646442-224064581.png" alt="img"></p>
<p><strong>ä»ä¸Šé¢çš„é…ç½®å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ default é»˜è®¤çš„ profile å†…ï¼Œç»™ä¸¤ç»„å‚æ•°è®¾ç½®äº†çº¦æŸã€‚é¦–å…ˆä¸º max_memory_usage è®¾ç½®äº† min å’Œ max é˜ˆå€¼ï¼›å…¶æ¬¡ä¸º distributed_product_mode è®¾ç½®äº†åªè¯»çº¦æŸã€‚ç„¶åé‡å¯ ClickHouseï¼Œå¹¶å°è¯•ä¿®æ”¹ max_memory_usage å‚æ•°ï¼Œå°†å®ƒæ”¹ä¸º 50ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182654179-1342486270.png" alt="img"></p>
<p><strong>å¯ä»¥çœ‹åˆ°æœ€å°å€¼çº¦æŸé˜»æ­¢äº†è¿™æ¬¡ä¿®æ”¹ï¼Œæ¥ç€ç»§ç»­ä¿®æ”¹ distributed_product_mode çš„å€¼ï¼š</strong></p>
<p><img src="https://img2020.cnblogs.com/blog/1229382/202110/1229382-20211008182703966-1769998673.png" alt="img"></p>
<p><strong>åŒæ ·é…ç½®çº¦æŸæˆåŠŸé˜»æ­¢äº†é¢„æœŸå¤–çš„ä¿®æ”¹ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ˜ç¡®ï¼Œåœ¨ default ä¸­é»˜è®¤å®šä¹‰çš„ constraints çº¦æŸï¼Œå°†ä½œä¸ºé»˜è®¤çš„å…¨å±€çº¦æŸï¼Œè‡ªåŠ¨è¢«å…¶å®ƒ profile ç»§æ‰¿ã€‚</strong></p>
<h3 id="ç”¨æˆ·"><a href="#ç”¨æˆ·" class="headerlink" title="ç”¨æˆ·"></a>ç”¨æˆ·</h3><p><strong>é€šè¿‡ profiles æ ‡ç­¾å¯ä»¥ä¸ºç”¨æˆ·å®šä¹‰è§’è‰²ï¼Œé‚£ä¹ˆå¯ä¸å¯ä»¥å®šä¹‰ç”¨æˆ·å‘¢ï¼Ÿæ˜¾ç„¶æ˜¯å¯ä»¥çš„ï¼Œé€šè¿‡ users æ ‡ç­¾å³å¯ã€‚å¦‚æœæ‰“å¼€é…ç½®æ–‡ä»¶ï¼Œä¼šå‘ç° users æ ‡ç­¾ä¸‹å·²ç»æœ‰ä¸€ä¸ªé»˜è®¤çš„ default ç”¨æˆ·ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ä¸€ç›´éƒ½æ˜¯è¿™ä¸ªç”¨æˆ·ï¼Œè€Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œä½†å¿…é¡»åŒ…å«å¦‚ä¸‹å±æ€§ï¼š</strong></p>
<p><strong>password</strong></p>
<p><strong>password ç”¨äºè®¾ç½®ç™»å½•å¯†ç ï¼Œæ”¯æŒæ˜æ–‡ã€SHA256 åŠ å¯†å’Œ double_sha1 åŠ å¯†ä¸‰ç§å½¢å¼ï¼Œå¯ä»¥ä»»é€‰å…¶ä¸­ä¸€ç§è¿›è¡Œè®¾ç½®ã€‚ç°åœ¨åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ã€‚</strong></p>
<p><strong>1ï¼‰æ˜æ–‡å¯†ç ï¼šåœ¨ä½¿ç”¨æ˜æ–‡å¯†ç çš„æ—¶å€™ï¼Œç›´æ¥é€šè¿‡ password æ ‡ç­¾å®šä¹‰ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœ password ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå…å¯†ç ç™»å½•ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰SHA256 åŠ å¯†ï¼šåœ¨ä½¿ç”¨ SHA256 åŠ å¯†ç®—æ³•çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ password_sha256_hex æ ‡ç­¾å®šä¹‰å¯†ç ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">password_sha256_hexs</span>&gt;</span>a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3<span class="tag">&lt;/<span class="name">password_sha256_hexs</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è‡³äºè®¡ç®—çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œæ¯”å¦‚å¯¹ 123 è¿›è¡ŒåŠ å¯†ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># echo -n 123 |openssl dgst -sha256</span></span><br><span class="line">(stdin)= a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3</span><br></pre></td></tr></table></figure>

<p><strong>æˆ–è€…ä½¿ç”¨ Pythonï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hashlib.sha256(<span class="string">b&quot;123&quot;</span>).hexdigest()</span><br><span class="line"><span class="string">&#x27;a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>3ï¼‰double_sha1 åŠ å¯†ï¼šåœ¨ä½¿ç”¨ double_sha1 åŠ å¯†ç®—æ³•çš„æ—¶å€™ï¼Œåˆ™éœ€è¦é€šè¿‡ password_double_sha1_hex æ ‡ç­¾å®šä¹‰å¯†ç ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">password_double_sha1_hex</span>&gt;</span>23ae809ddacaf96af0fd78ed04b6a265e05aa257<span class="tag">&lt;/<span class="name">password_double_sha1_hex</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è‡³äºè®¡ç®—çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œæ¯”å¦‚å¯¹ 123 è¿›è¡ŒåŠ å¯†ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@satori ~]<span class="comment"># echo -n 123 | openssl dgst -sha1 -binary | openssl dgst -sha1</span></span><br><span class="line">(stdin)= 23ae809ddacaf96af0fd78ed04b6a265e05aa257</span><br></pre></td></tr></table></figure>

<p><strong>æˆ–è€…ä½¿ç”¨ Pythonï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>_ = hashlib.sha1(<span class="string">b&quot;123&quot;</span>).digest()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hashlib.sha1(_).hexdigest()</span><br><span class="line"><span class="string">&#x27;23ae809ddacaf96af0fd78ed04b6a265e05aa257&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p><strong>networks</strong></p>
<p><strong>networks è¡¨ç¤ºè¢«å…è®¸ç™»å½•çš„ç½‘ç»œåœ°å€ï¼Œç”¨äºé™åˆ¶ç”¨æˆ·ç™»å½•çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå…³äºè¿™æ–¹é¢çš„ä»‹ç»å°†ä¼šåœ¨åç»­å±•å¼€ã€‚</strong></p>
<p><strong>profile</strong></p>
<p><strong>ç”¨æˆ·æ‰€ä½¿ç”¨çš„è§’è‰²ï¼Œç›´æ¥å¼•ç”¨ç›¸åº”çš„åç§°å³å¯ï¼Œä¾‹å¦‚ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span>profile_1<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>è¯¥é…ç½®çš„è¯­ä¹‰è¡¨ç¤ºï¼šè¯¥ç”¨æˆ·ä½¿ç”¨äº†åä¸º profile_1 çš„è§’è‰²ã€‚</strong></p>
<p><strong>quota</strong></p>
<p><strong>quota ç”¨äºè®¾ç½®è¯¥ç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé™é¢ï¼Œå¯ä»¥ç†è§£æˆä¸€ç§ç†”æ–­æœºåˆ¶ã€‚å…³äºè¿™æ–¹é¢çš„ä»‹ç»åŒæ ·å°†ä¼šåœ¨åç»­å±•å¼€ã€‚</strong></p>
<p><strong>ä¸‹é¢æˆ‘ä»¬å°±æ¥å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„å®ä¾‹æ¥å®šä¹‰ä¸‰ä¸ªç”¨æˆ·ï¼Œå¯†ç åˆ†åˆ«ä½¿ç”¨æ˜æ–‡å¯†ç ã€sha256 åŠ å¯†ã€double sha1 åŠ å¯†ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span>  <span class="comment">&lt;!-- é»˜è®¤ç”¨æˆ· --&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä½¿ç”¨æ˜æ–‡å¯†ç  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user_plaintext</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user_plaintext</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä½¿ç”¨ sha256 åŠ å¯† --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user_sha256</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password_sha256_hex</span>&gt;</span>a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3<span class="tag">&lt;/<span class="name">password_sha256_hex</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user_sha256</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä½¿ç”¨ double sha1 åŠ å¯† --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user_double_sha1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password_double_sha1_hex</span>&gt;</span>23ae809ddacaf96af0fd78ed04b6a265e05aa257<span class="tag">&lt;/<span class="name">password_double_sha1_hex</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user_double_sha1</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç”±äºé…ç½®äº†å¯†ç ï¼Œé‚£ä¹ˆä»¥åä½¿ç”¨æŒ‡å®šç”¨æˆ·ç™»å½•æ—¶ï¼Œå°±å¿…é¡»æŒ‡å®šå¯†ç äº†ï¼Œä¸¾ä¸ªæ —å­ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182722735-2046681283.png" alt="img"></p>
<p><strong>â€“host æŒ‡å®š IPï¼Œâ€“port æŒ‡å®šç«¯å£ï¼Œâ€“user æŒ‡å®šç”¨æˆ·ï¼Œæˆ‘ä»¬çœ‹åˆ°æŒ‡å®šç”¨æˆ·ä¸º user_plaintext è¿›è¡Œç™»å½•çš„æ—¶å€™æŠ¥é”™çš„ï¼ŒåŸå› å°±æ˜¯è¯¥ç”¨æˆ·è®¾ç½®äº†å¯†ç ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šã€‚è€Œé€šè¿‡ â€“password æŒ‡å®šå¯†ç ä¹‹åï¼Œä¾¿å¯ç™»å½•æˆåŠŸäº†ã€‚</strong></p>
<p><strong>è‡³äºå…¶å®ƒç”¨æˆ·ç±»ä¼¼ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶ä¸­å†™çš„æ˜¯åŠ å¯†åçš„ç»“æœï¼Œä½†æ˜¯ç™»å½•æ—¶ï¼Œå¯†ç è¿˜æ˜¯ä½¿ç”¨åŠ å¯†å‰çš„ç»“æœï¼Œè¿™é‡Œæ˜¯ 123</span></span><br><span class="line">clickhouse-client --user user_sha256 --password 123</span><br><span class="line">clickhouse-client --user user_double_sha1 --password 123</span><br></pre></td></tr></table></figure>

<h2 id="æƒé™ç®¡ç†"><a href="#æƒé™ç®¡ç†" class="headerlink" title="æƒé™ç®¡ç†"></a>æƒé™ç®¡ç†</h2><p><strong>æƒé™ç®¡ç†æ˜¯ä¸€ä¸ªå§‹ç»ˆéƒ½ç»•ä¸å¼€çš„è¯é¢˜ï¼ŒClickHouse åˆ†åˆ«ä»è®¿é—®ã€æŸ¥è¯¢å’Œæ•°æ®ç­‰è§’åº¦å‡ºå‘ï¼Œå±‚å±‚é€’è¿›ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè¾ƒä¸ºç«‹ä½“çš„æƒé™ä½“ç³»ã€‚</strong></p>
<h3 id="è®¿é—®æƒé™"><a href="#è®¿é—®æƒé™" class="headerlink" title="è®¿é—®æƒé™"></a>è®¿é—®æƒé™</h3><p><strong>è®¿é—®å±‚æ§åˆ¶æ˜¯æ•´ä¸ªæƒé™ä½“ç³»çš„ç¬¬ä¸€å±‚é˜²æŠ¤ï¼Œå®ƒåˆå¯è¿›ä¸€æ­¥ç»†åˆ†æˆä¸¤ç±»æƒé™ã€‚</strong></p>
<p><strong>ç½‘ç»œè®¿é—®æƒé™</strong></p>
<p><strong>ç½‘ç»œè®¿é—®æƒé™ä½¿ç”¨ networks æ ‡ç­¾è®¾ç½®ï¼Œç”¨äºé™åˆ¶å®¢æˆ·ç«¯ç™»å½•çš„åœ°å€ï¼Œé™åˆ¶æ–¹å¼å¯ä»¥é€šè¿‡ IP åœ°å€ã€host ä¸»æœºåç§°å®ç°ï¼Œä¸¤è€…é€‰å…¶ä¸€å³å¯ã€‚</strong></p>
<p><strong>æ¯”å¦‚é€šè¿‡ IP åœ°å€è®¾ç½®ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- åªèƒ½é€šè¿‡ IP ä¸º 127.0.0.1 çš„ä¸»æœºè®¿é—® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ip</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ host ä¸»æœºåç§°è®¾ç½®ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- åªèƒ½é€šè¿‡ä¸»æœºåä¸º satori çš„ä¸»æœºè®¿é—®ï¼Œå¦å¤–è¿™é‡Œé…ç½®ä¸»æœºåçš„æ—¶å€™è¿˜å¯ä»¥ä½¿ç”¨æ­£åˆ™ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span>&gt;</span>satori<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æ•°æ®åº“ä¸å­—å…¸è®¿é—®æƒé™</strong></p>
<p><strong>åœ¨å®¢æˆ·ç«¯è¿å…¥æœåŠ¡ä¹‹åï¼Œå¯ä»¥è¿›ä¸€æ­¥é™åˆ¶æŸä¸ªç”¨æˆ·æ•°æ®åº“å’Œå­—å…¸çš„è®¿é—®æƒé™ï¼Œå®ƒä»¬åˆ†åˆ«é€šè¿‡ allow_databases å’Œ allow_dictionaries æ ‡ç­¾è¿›è¡Œè®¾ç½®ã€‚å¦‚æœä¸è¿›è¡Œå®šä¹‰ï¼Œåˆ™è¡¨ç¤ºä¸è¿›è¡Œé™åˆ¶ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user_plaintext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">allow_databases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">database</span>&gt;</span>default<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">database</span>&gt;</span>kagura_nana<span class="tag">&lt;/<span class="name">database</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">allow_databases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow_dictionaries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dictionary</span>&gt;</span>test_dict<span class="tag">&lt;/<span class="name">dictionary</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">allow_dictionaries</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">user_plaintext</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ä¸Šè¿°æ“ä½œï¼Œè¯¥ç”¨æˆ·åœ¨ç™»å½•ä¹‹åï¼Œå°†åªèƒ½çœ‹åˆ°ä¸ºå…¶å¼€æ”¾äº†è®¿é—®æƒé™çš„æ•°æ®åº“å’Œå­—å…¸ã€‚</strong></p>
<h3 id="æŸ¥è¯¢æƒé™"><a href="#æŸ¥è¯¢æƒé™" class="headerlink" title="æŸ¥è¯¢æƒé™"></a>æŸ¥è¯¢æƒé™</h3><p><strong>æŸ¥è¯¢æƒé™æ˜¯æ•´ä¸ªæƒé™ä½“ç³»çš„ç¬¬äºŒå±‚é˜²æŠ¤ï¼Œè®¾ç½®åœ¨ profile ä¸­ï¼Œå®ƒå†³å®šäº†æ‹¥æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥ï¼ŒæŸ¥è¯¢æƒé™å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š</strong></p>
<ul>
<li><code>è¯»æƒé™ï¼šåŒ…æ‹¬ SELECTã€EXISTSã€SHOW å’Œ DESCRIBE æŸ¥è¯¢</code></li>
<li><code>å†™æƒé™ï¼šåŒ…æ‹¬ INSERT å’Œ OPTIMIZE æŸ¥è¯¢</code></li>
<li><code>è®¾ç½®æƒé™ï¼šåŒ…æ‹¬ SET æŸ¥è¯¢</code></li>
<li><code>DDL æƒé™ï¼šåŒ…æ‹¬ CREATEã€DROPã€ALTERã€RENAMEã€ATTACHã€DETACH å’Œ TRUNCATE æŸ¥è¯¢</code></li>
<li><code>å…¶å®ƒæƒé™ï¼šåŒ…æ‹¬ KILL å’Œ USE æŸ¥è¯¢ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥æ‰§è¡Œè¿™äº›æŸ¥è¯¢</code></li>
</ul>
<p><strong>ä¸Šè¿°æƒé™ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤é¡¹é…ç½®æ ‡ç­¾æ§åˆ¶ï¼š</strong></p>
<ul>
<li><strong>1ï¼‰readonlyï¼šè¯»æƒé™ã€å†™æƒé™å’Œè®¾ç½®æƒé™å‡ç”±æ­¤æ ‡ç­¾æ§åˆ¶ï¼Œå®ƒæœ‰ä¸‰ç§å–å€¼ï¼š</strong><ul>
<li><code>å½“å–å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºä¸è¿›è¡Œä»»ä½•é™åˆ¶ï¼ˆé»˜è®¤å€¼ï¼‰</code></li>
<li><code>å½“å–å€¼ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºåªæ‹¥æœ‰è¯»æƒé™ï¼Œå³åªèƒ½æ‰§è¡Œ SELECT ã€EXISTSã€SHOW å’Œ DESCRIBE</code></li>
<li><code>å½“å–å€¼ä¸º 2 æ—¶ï¼Œè¡¨ç¤ºæ‹¥æœ‰è¯»æƒé™å’Œè®¾ç½®æƒé™ï¼Œç›¸å½“äºåœ¨è¯»æƒé™çš„åŸºç¡€ä¸Šå¢åŠ äº† SET æŸ¥è¯¢</code></li>
</ul>
</li>
<li><strong>2ï¼‰allow_ddlï¼šDDL æƒé™ç”±æ­¤æ ‡ç­¾æ§åˆ¶ï¼Œå®ƒæœ‰ä¸¤ç§å–å€¼ï¼š</strong><ul>
<li><code>å½“å–å€¼ä¸º 0 æ—¶ï¼Œä¸å…è®¸ DDL æŸ¥è¯¢</code></li>
<li><code>å½“å–å€¼ä¸º 1 æ—¶ï¼Œå…è®¸ DDL æŸ¥è¯¢ï¼ˆé»˜è®¤å€¼ï¼‰</code></li>
</ul>
</li>
</ul>
<p><strong>ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªè§’è‰²ã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span>...<span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">readonly</span>&gt;</span>...<span class="tag">&lt;/<span class="name">readonly</span>&gt;</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">profile_test</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readonly</span>&gt;</span>1<span class="tag">&lt;/<span class="name">readonly</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">allow_ddl</span>&gt;</span>0<span class="tag">&lt;/<span class="name">allow_ddl</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile_test</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹åï¼Œé‡å¯ ClickHouseï¼Œç„¶åè¿æ¥ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182735704-1294115794.png" alt="img"></p>
<p><strong>æˆ‘ä»¬çœ‹åˆ°åˆ‡æ¢è§’è‰²ä¹‹åï¼Œä¸å†å…·æœ‰ DDL æ‰§è¡Œæƒé™ã€‚å½“ç„¶æ•°æ®ä¹Ÿæ˜¯åªè¯»æ¨¡å¼ï¼Œæ­¤æ—¶å†™å…¥æ•°æ®æ˜¯å¤±è´¥çš„ã€‚</strong></p>
<p><strong>è‡³æ­¤ï¼Œæƒé™è®¾ç½®å·²ç„¶ç”Ÿæ•ˆã€‚</strong></p>
<h3 id="æ•°æ®è¡Œçº§æƒé™"><a href="#æ•°æ®è¡Œçº§æƒé™" class="headerlink" title="æ•°æ®è¡Œçº§æƒé™"></a>æ•°æ®è¡Œçº§æƒé™</h3><p><strong>æ•°æ®æƒé™æ˜¯æ•´ä¸ªæƒé™ä½“ç³»ä¸­çš„ç¬¬ä¸‰å±‚é˜²æŠ¤ï¼Œå®ƒå†³å®šäº†ä¸€ä¸ªç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°ä»€ä¹ˆæ•°æ®ï¼Œè¯´äººè¯å°±æ˜¯æ•°æ®ç²’åº¦æ›´ç»†äº†ï¼Œå¯ä»¥åªå°†ä¸€å¼ è¡¨çš„éƒ¨åˆ†æ•°æ®æš´éœ²ç»™ç”¨æˆ·ã€‚</strong></p>
<p><strong>è€Œè¯¥æƒé™ä½¿ç”¨ database æ ‡ç­¾å®šä¹‰ï¼ˆä½äº users æ ‡ç­¾å†…éƒ¨ï¼‰ï¼Œdatabase é€šè¿‡å®šä¹‰ç”¨æˆ·çº§åˆ«çš„æŸ¥è¯¢è¿‡æ»¤å™¨æ¥å®ç°æ•°æ®çš„è¡Œçº§ç²’åº¦æƒé™ï¼Œå®ƒçš„å®šä¹‰è§„åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">databases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database_name</span>&gt;</span>  <span class="comment">&lt;!-- æ•°æ®åº“åç§° --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table_name</span>&gt;</span> <span class="comment">&lt;!-- è¡¨åç§° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileter</span>&gt;</span>id &gt; 10<span class="tag">&lt;/<span class="name">fileter</span>&gt;</span>  <span class="comment">&lt;!-- æ•°æ®è¿‡æ»¤æ¡ä»¶ï¼Œä¹Ÿå¯ä»¥å†™å¤æ‚çš„æ¡ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table_name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">database_name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">databases</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>æˆ‘ä»¬ä»¥ä¹‹å‰çš„ distributed_test_1 ä¸ºä¾‹ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user_test_2</span>&gt;</span>  <span class="comment">&lt;!-- æ–°å»ºä¸€ä¸ªè§’è‰² --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">databases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">distributed_test_1</span>&gt;</span> </span><br><span class="line">                <span class="tag">&lt;<span class="name">filter</span>&gt;</span>id &gt; 10<span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">distributed_test_1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">databases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user_test_2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¿®æ”¹ä¹‹åé‡å¯ ClickHouseï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182745284-100788997.png" alt="img"></p>
<p><strong>æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œé‚£ä¹ˆ ClickHouse åº•å±‚æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ filter æ ‡ç­¾çš„å†…å®¹ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå°±æ˜¯è¿½åŠ äº†ä¸€ä¸ª WHERE æ¡ä»¶ã€‚</strong></p>
<p><strong>å¯¹äºæ•°æ®æƒé™çš„ä½¿ç”¨æœ‰ä¸€ç‚¹éœ€è¦æ˜ç¡®ï¼Œåœ¨ä½¿ç”¨äº†è¿™é¡¹åŠŸèƒ½ä¹‹åï¼ŒPREWHERE ä¼˜åŒ–å°†ä¸å†ç”Ÿæ•ˆã€‚æ‰€ä»¥æ˜¯ç›´æ¥åˆ©ç”¨ ClickHouse çš„å†…ç½®è¿‡æ»¤å™¨ï¼Œè¿˜æ˜¯é€šè¿‡æ‹¼æ¥ WHERE æŸ¥è¯¢æ¡ä»¶çš„æ–¹å¼å®ç°è¡Œçº§è¿‡æ»¤ï¼Œéœ€è¦æ ¹æ®ä½¿ç”¨åœºæ™¯è¿›è¡Œæƒè¡¡ã€‚</strong></p>
<h2 id="ç†”æ–­æœºåˆ¶"><a href="#ç†”æ–­æœºåˆ¶" class="headerlink" title="ç†”æ–­æœºåˆ¶"></a>ç†”æ–­æœºåˆ¶</h2><p><strong>ç†”æ–­æ˜¯é™åˆ¶èµ„æºè¢«è¿‡åº¦ä½¿ç”¨çš„ä¸€ç§è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå½“ä½¿ç”¨çš„èµ„æºæ•°é‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œé‚£ä¹ˆæ­£åœ¨è¿›è¡Œçš„æ“ä½œä¼šè¢«è‡ªåŠ¨ä¸­æ–­ã€‚è€ŒæŒ‰ç…§ä½¿ç”¨èµ„æºç»Ÿè®¡æ–¹å¼çš„ä¸åŒï¼Œç†”æ–­æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤ç±»ã€‚</strong></p>
<h4 id="æ ¹æ®æ—¶é—´å‘¨æœŸçš„ç´¯ç§¯ç”¨é‡ç†”æ–­"><a href="#æ ¹æ®æ—¶é—´å‘¨æœŸçš„ç´¯ç§¯ç”¨é‡ç†”æ–­" class="headerlink" title="æ ¹æ®æ—¶é—´å‘¨æœŸçš„ç´¯ç§¯ç”¨é‡ç†”æ–­"></a>æ ¹æ®æ—¶é—´å‘¨æœŸçš„ç´¯ç§¯ç”¨é‡ç†”æ–­</h4><p><strong>åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œç³»ç»Ÿèµ„æºçš„ç”¨é‡æ˜¯æŒ‰ç…§æ—¶é—´å‘¨æœŸç´¯ç§¯ç»Ÿè®¡çš„ï¼Œå½“ç´¯ç§¯é‡è¾¾åˆ°é˜šå€¼ï¼Œåˆ™ç›´åˆ°ä¸‹ä¸ªè®¡ç®—å‘¨æœŸå¼€å§‹ä¹‹å‰ï¼Œè¯¥ç”¨æˆ·å°†æ— æ³•ç»§ç»­è¿›è¡Œæ“ä½œã€‚è¿™ç§æ–¹å¼é€šè¿‡ users.xml å†…çš„ quotas æ ‡ç­¾æ¥å®šä¹‰èµ„æºé…é¢ï¼Œä»¥é»˜è®¤çš„é…ç½®ä¸ºä¾‹ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182755378-1601344871.png" alt="img"></p>
<p><strong>çœ‹å›¾ä¸­æœ€åä¸€è¡Œï¼Œæ˜¯ ï¼Œæ˜¾ç„¶åˆ°æ­¤é…ç½®æ–‡ä»¶å°±ç»“æŸäº†ï¼Œæ‰€ä»¥ users.xml ä¸­æœ€å¤–å±‚æ˜¯ yandex æ ‡ç­¾ï¼Œç„¶å yandex æ ‡ç­¾é‡Œé¢æœ‰ä¸‰ä¸ªå­æ ‡ç­¾ï¼Œåˆ†åˆ«æ˜¯ profilesã€usersã€quotasï¼Œåˆ†åˆ«ç”¨äºå®šä¹‰è§’è‰²ã€å®šä¹‰ç”¨æˆ·ã€ç†”æ–­é™æµï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ•´ä¸ªç»“æ„æ¯”è¾ƒæ¸…æ™°ã€‚ç„¶åçœ‹çœ‹ quotas æ ‡ç­¾é‡Œé¢çš„å†…å®¹éƒ½ä»£è¡¨ä»€ä¹ˆå«ä¹‰å§ã€‚</strong></p>
<ul>
<li><code>defaultï¼šè‡ªå®šä¹‰åç§°ï¼Œå…¨å±€å”¯ä¸€</code></li>
<li><code>durationï¼šç´¯ç§¯çš„æ—¶é—´å‘¨æœŸï¼Œå•ä½ç§’</code></li>
<li><code>queriesï¼šåœ¨å‘¨æœŸå†…å…è®¸æ‰§è¡Œçš„æŸ¥è¯¢æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</code></li>
<li><code>errorsï¼šåœ¨å‘¨æœŸå†…å…è®¸å‘ç”Ÿå¼‚å¸¸çš„æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</code></li>
<li><code>result_rowï¼šåœ¨å‘¨æœŸå†…å…è®¸æŸ¥è¯¢è¿”å›çš„ç»“æœè¡Œæ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</code></li>
<li><code>read_rowï¼šåœ¨å‘¨æœŸå†…ï¼Œåœ¨åˆ†å¸ƒå¼æŸ¥è¯¢ä¸­ï¼Œå…è®¸è¿œç«¯èŠ‚ç‚¹è¯»å–çš„æ•°æ®è¡Œæ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</code></li>
<li><code>execution_timeï¼šå‘¨æœŸå†…å…è®¸æ‰§è¡Œçš„æŸ¥è¯¢æ—¶é—´ï¼Œå•ä½ç§’ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</code></li>
</ul>
<p><strong>æˆ‘ä»¬æ¥é…ç½®ä¸€ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- åœ¨ quotas æ ‡ç­¾ä¸­å¢åŠ å¦‚ä¸‹é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">limit_1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interval</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">duration</span>&gt;</span>3600<span class="tag">&lt;/<span class="name">duration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">queries</span>&gt;</span>2<span class="tag">&lt;/<span class="name">queries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">errors</span>&gt;</span>0<span class="tag">&lt;/<span class="name">errors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result_rows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">result_rows</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">read_rows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">read_rows</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution_time</span>&gt;</span>0<span class="tag">&lt;/<span class="name">execution_time</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interval</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">limit_1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>åœ¨åä¸º limit_1 çš„é…ç½®ä¸­ï¼Œ1 ä¸ªå°æ—¶çš„å‘¨æœŸå†…åªå…è®¸æœ€å¤š 2 æ¬¡æŸ¥è¯¢ï¼Œä¸‹é¢è®©å…¶ä½œç”¨åœ¨ user_test_2 ç”¨æˆ·ä¸Šã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user_test_2</span>&gt;</span> </span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">quota</span>&gt;</span>limit_1<span class="tag">&lt;/<span class="name">quota</span>&gt;</span> <span class="comment">&lt;!-- å…¶å®ƒéƒ¨åˆ†ä¸å˜ï¼Œå°† quota çš„å€¼ä» default æ”¹æˆ limit_1 --&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">user_test_2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç„¶åé‡å¯ ClickHouseï¼Œå¹¶ä»¥ user_test_2 ç”¨æˆ·å¯åŠ¨ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182808290-1843836494.png" alt="img"></p>
<p><strong>æ‰§è¡Œä¸¤æ¬¡æŸ¥è¯¢ä¹‹åï¼Œå¦‚æœå†æ‰§è¡Œçš„è¯å°±ä¼šæŠ¥é”™ï¼Œè¯æ˜ç†”æ–­æœºåˆ¶ç¡®å®å·²ç»ç”Ÿæ•ˆã€‚</strong></p>
<h4 id="æ ¹æ®å•æ¬¡æŸ¥è¯¢çš„ç”¨é‡ç†”æ–­"><a href="#æ ¹æ®å•æ¬¡æŸ¥è¯¢çš„ç”¨é‡ç†”æ–­" class="headerlink" title="æ ¹æ®å•æ¬¡æŸ¥è¯¢çš„ç”¨é‡ç†”æ–­"></a>æ ¹æ®å•æ¬¡æŸ¥è¯¢çš„ç”¨é‡ç†”æ–­</h4><p><strong>åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œç³»ç»Ÿèµ„æºçš„ç”¨é‡æ˜¯æŒ‰ç…§å•æ¬¡æŸ¥è¯¢ç»Ÿè®¡çš„ï¼Œè€Œå…·ä½“çš„ç†”æ–­è§„åˆ™ï¼Œåˆ™æ˜¯ç”±è®¸å¤šä¸åŒé…ç½®é¡¹ç»„æˆçš„ï¼Œè¿™äº›é…ç½®é¡¹éœ€è¦å®šä¹‰åœ¨ç”¨æˆ· profile ä¸­ã€‚å¦‚æœæŸæ¬¡æŸ¥è¯¢ä½¿ç”¨çš„èµ„æºç”¨é‡è¾¾åˆ°äº†é˜ˆå€¼ï¼Œåˆ™ä¼šè¢«ä¸­æ–­ã€‚ä»¥é…ç½®é¡¹ max memory_usage ä¸ºä¾‹ï¼Œå®ƒé™å®šäº†å•æ¬¡æŸ¥è¯¢å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç”¨é‡ï¼Œåœ¨é»˜è®¤çš„æƒ…å†µä¸‹å…¶è§„å®šä¸å¾—è¶…è¿‡ 10 GBï¼Œå¦‚æœä¸€æ¬¡æŸ¥è¯¢çš„å†…å­˜ç”¨é‡è¶…è¿‡ 10 GBï¼Œåˆ™ä¼šå¾—åˆ°å¼‚å¸¸ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å•æ¬¡æŸ¥è¯¢çš„ç”¨é‡ç»Ÿè®¡ä¸­ï¼ŒClickHouse æ˜¯ä»¥åˆ†åŒºä¸ºæœ€å°å•å…ƒè¿›è¡Œç»Ÿè®¡çš„ï¼ˆä¸æ˜¯æ•°æ®è¡Œçš„ç²’åº¦ï¼‰ï¼Œè¿™æ„å‘³ç€å•æ¬¡æŸ¥è¯¢çš„å®é™…å†…å­˜ç”¨é‡æ˜¯æœ‰å¯èƒ½è¶…è¿‡é˜ˆå€¼çš„ã€‚</strong></p>
<p><strong>ç†”æ–­ç›¸å…³çš„é…ç½®æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„ã€‚</strong></p>
<p><strong>1ï¼‰max_memory_usageï¼šåœ¨å•ä¸ª ClickHouse æœåŠ¡è¿›ç¨‹ä¸­ï¼Œè¿è¡Œä¸€æ¬¡æŸ¥è¯¢é™åˆ¶ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ï¼Œé»˜è®¤å€¼ä¸º 10GBã€‚</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">max_memory_usage</span>&gt;</span>10000000000<span class="tag">&lt;/<span class="name">max_memory_usage</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2ï¼‰max_memory_usage_for_userï¼šåœ¨å•ä¸ª ClickHouse æœåŠ¡è¿›ç¨‹ä¸­ï¼Œä»¥ç”¨æˆ·ä¸ºå•ä½è¿›è¡Œç»Ÿè®¡ï¼Œå•ä¸ªç”¨æˆ·åœ¨è¿è¡ŒæŸ¥è¯¢æ—¶é™åˆ¶ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œå³ä¸åšé™åˆ¶ã€‚</strong></p>
<p><strong>3ï¼‰max_memory_usage_for_all_queriesï¼šåœ¨å•ä¸ª ClickHouse æœåŠ¡è¿›ç¨‹ä¸­ï¼Œæ‰€æœ‰è¿è¡Œçš„æŸ¥è¯¢ç´¯åŠ åœ¨ä¸€èµ·æ‰€é™åˆ¶ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œå³ä¸åšé™åˆ¶ã€‚</strong></p>
<p><strong>4ï¼‰max_partitions_per_insert_blockï¼šåœ¨å•æ¬¡ INSERT å†™å…¥çš„æ—¶å€™ï¼Œé™åˆ¶åˆ›å»ºçš„æœ€å¤§åˆ†åŒºä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º 100 ä¸ªã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°†ä¼šå‡ºç°å¼‚å¸¸ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Too many partitions for single INSERT block Â·Â·Â·Â·Â·Â·</span><br></pre></td></tr></table></figure>

<p><strong>5ï¼‰max_rows_to_group_byï¼šåœ¨æ‰§è¡Œ GROUP BY èšåˆæŸ¥è¯¢çš„æ—¶å€™ï¼Œé™åˆ¶å»é‡åçš„èšåˆ KEY çš„æœ€å¤§ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œä¸åšé™åˆ¶ã€‚å½“è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå…¶å¤„ç†æ–¹å¼ç”± group_by_overflow_mode å†³å®šã€‚</strong></p>
<p><strong>6ï¼‰group_by_overflow_modeï¼šå½“ max_rows_to_group_by ç†”æ–­è§„åˆ™è§¦å‘æ—¶ï¼Œgroup_by_overflow_mode å°†ä¼šæä¾›ä¸‰ç§å¤„ç†æ–¹å¼ã€‚</strong></p>
<ul>
<li><code>throwï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤ä¹ƒé»˜è®¤å€¼</code></li>
<li><code>breakï¼šç«‹å³åœæ­¢æŸ¥è¯¢ï¼Œå¹¶è¿”å›å½“å‰æ•°æ®</code></li>
<li><code>anyï¼šä»…æ ¹æ®å½“å‰å·²å­˜åœ¨çš„èšåˆ KEY ç»§ç»­å®ŒæˆèšåˆæŸ¥è¯¢</code></li>
</ul>
<p><strong>7ï¼‰max_bytes_before_external_group_byï¼šåœ¨æ‰§è¡Œ GROUP BY æŸ¥è¯¢çš„æ—¶å€™ï¼Œé™åˆ¶ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œä¸åšé™åˆ¶ã€‚å½“è¶…è¿‡é˜ˆå€¼æ—¶ï¼ŒèšåˆæŸ¥è¯¢å°†ä¼šè¿›ä¸€æ­¥å€Ÿç”¨æœ¬åœ°ç£ç›˜ã€‚</strong></p>
<h2 id="æ•°æ®å¤‡ä»½"><a href="#æ•°æ®å¤‡ä»½" class="headerlink" title="æ•°æ®å¤‡ä»½"></a>æ•°æ®å¤‡ä»½</h2><p><strong>åœ¨ä¹‹å‰çš„ç³»åˆ—ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†æ•°æ®å‰¯æœ¬çš„ä½¿ç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ—¢ç„¶å·²ç»æœ‰äº†æ•°æ®å‰¯æœ¬ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æ•°æ®å¤‡ä»½å—ï¼Ÿæ˜¾ç„¶æ•°æ®å¤‡ä»½æ˜¯éœ€è¦çš„ï¼Œå› ä¸ºæ•°æ®å‰¯æœ¬å¹¶ä¸èƒ½å¤„ç†è¯¯åˆ æ•°æ®è¿™ç±»è¡Œä¸ºã€‚ClickHouseè‡ªèº«æä¾›äº†å¤šç§å¤‡ä»½æ•°æ®çš„æ–¹æ³•ï¼Œæ ¹æ®æ•°æ®è§„æ¨¡çš„ä¸åŒï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„å½¢å¼ã€‚</strong></p>
<h4 id="å¯¼å‡ºæ–‡ä»¶å¤‡ä»½"><a href="#å¯¼å‡ºæ–‡ä»¶å¤‡ä»½" class="headerlink" title="å¯¼å‡ºæ–‡ä»¶å¤‡ä»½"></a>å¯¼å‡ºæ–‡ä»¶å¤‡ä»½</h4><p><strong>å¦‚æœæ•°æ®çš„ä½“é‡è¾ƒå°ï¼Œå¯ä»¥é€šè¿‡ dump å½¢å¼å°†æ•°æ®å¯¼å‡ºä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œè¯­å¥å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">clickhouse-client --query=&quot;SELECT * FROM table_name&quot; &gt; table_name.tsv</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæƒ³å°†å¤‡ä»½æ•°æ®å¯¼å…¥çš„è¯ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat table_name.csv | clickhouse-client --query=&quot;INSERT INTO table_name FORMAT TSV&quot;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°è¿™ç§ dump å½¢å¼çš„ä¼˜åŠ¿åœ¨äºï¼Œå¯ä»¥åˆ©ç”¨ SELECT æŸ¥è¯¢å¹¶ç­›é€‰æ•°æ®ï¼Œç„¶åæŒ‰éœ€å¤‡ä»½ã€‚å¦‚æœæ˜¯å¤‡ä»½æ•´ä¸ªè¡¨çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¤åˆ¶å®ƒçš„æ•´ä¸ªç›®å½•æ–‡ä»¶ã€‚</strong></p>
<h4 id="é€šè¿‡å¿«ç…§è¡¨å¤‡ä»½"><a href="#é€šè¿‡å¿«ç…§è¡¨å¤‡ä»½" class="headerlink" title="é€šè¿‡å¿«ç…§è¡¨å¤‡ä»½"></a>é€šè¿‡å¿«ç…§è¡¨å¤‡ä»½</h4><p><strong>å¿«ç…§è¡¨å®è´¨ä¸Šå°±æ˜¯æ™®é€šçš„æ•°æ®è¡¨ï¼Œå®ƒé€šå¸¸æŒ‰ç…§ä¸šåŠ¡è§„å®šçš„å¤‡ä»½é¢‘ç‡åˆ›å»ºï¼Œä¾‹å¦‚æŒ‰å¤©æˆ–è€…æŒ‰å‘¨åˆ›å»ºã€‚æ‰€ä»¥é¦–å…ˆéœ€è¦å»ºç«‹ä¸€å¼ ä¸åŸè¡¨ç»“æ„ç›¸åŒçš„æ•°æ®è¡¨ï¼Œç„¶åå†ä½¿ç”¨ INSERT INTO SELECTå¥å¼ï¼Œç‚¹å¯¹ç‚¹åœ°å°†æ•°æ®ä»åŸè¡¨å†™äººå¤‡ä»½è¡¨ã€‚å‡è®¾æ•°æ®è¡¨ table_name éœ€è¦æŒ‰æ—¥è¿›è¡Œå¤‡ä»½ï¼Œç°åœ¨ä¸ºå®ƒåˆ›å»ºå½“å¤©çš„å¤‡ä»½è¡¨ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE table_name_bak AS table_name</span><br></pre></td></tr></table></figure>

<p><strong>æœ‰äº†å¤‡ä»½è¡¨ä¹‹åå°±å¯ä»¥ç‚¹å¯¹ç‚¹åœ°å¤‡ä»½æ•°æ®äº†ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO table_name_bak SELECT * FROM table_name</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœè€ƒè™‘åˆ°å®¹ç¾é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å°†å¤‡ä»½è¡¨æ”¾åœ¨ä¸åŒçš„ ClickHouse èŠ‚ç‚¹ä¸Šï¼Œæ­¤æ—¶éœ€è¦å°† SQL è¯­å¥æ”¹æˆè¿œç¨‹æŸ¥è¯¢çš„å½¢å¼ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO table_name_bak SELECT * FROM remote(&#x27;xx.xx.xx.xx:9000&#x27;, &#x27;default&#x27;, &#x27;table_name&#x27;, &#x27;default&#x27;)</span><br></pre></td></tr></table></figure>

<h4 id="æŒ‰åˆ†åŒºå¤‡ä»½"><a href="#æŒ‰åˆ†åŒºå¤‡ä»½" class="headerlink" title="æŒ‰åˆ†åŒºå¤‡ä»½"></a>æŒ‰åˆ†åŒºå¤‡ä»½</h4><p><strong>åŸºäºæ•°æ®åˆ†åŒºçš„å¤‡ä»½ï¼ŒClickHouse ç›®å‰æä¾›äº† FREEZE å’Œ FETCH ä¸¤ç§æ–¹å¼ï¼Œç°åœ¨åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ã€‚</strong></p>
<p><strong>ä½¿ç”¨ FREEZE å¤‡ä»½</strong></p>
<p><strong>FREEZE çš„å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE table_name FREEZE PARTITION partition_expr</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†åŒºåœ¨è¢«å¤‡ä»½ä¹‹åï¼Œä¼šè¢«ç»Ÿä¸€ä¿å­˜åˆ° ClickHouse æ ¹è·¯å¾„ &#x2F;shadow&#x2F;N å­ç›®å½•ä¸‹ã€‚å…¶ä¸­ N æ˜¯ä¸€ä¸ªè‡ªå¢é•¿çš„æ•´æ•°ï¼Œå®ƒçš„å«ä¹‰æ˜¯å¤‡ä»½çš„æ¬¡æ•°ï¼ˆFREEZE æ‰§è¡Œè¿‡å¤šå°‘æ¬¡ï¼‰ï¼Œå…·ä½“æ¬¡æ•°ç”± shadow å­ç›®å½•ä¸‹çš„ increment.txt æ–‡ä»¶è´Ÿè´£è®°å½•ã€‚è€Œåˆ†åŒºå¤‡ä»½å®è´¨ä¸Šæ˜¯å¯¹åŸå§‹ç›®å½•æ–‡ä»¶è¿›è¡Œç¡¬é“¾æ¥æ“ä½œï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå¯¼è‡´é¢å¤–çš„å­˜å‚¨ç©ºé—´ã€‚æ•´ä¸ªå¤‡ä»½çš„ç›®å½•ä¼šä¸€ç›´å‘ä¸Šè¿½æº¯è‡³ data æ ¹è·¯å¾„çš„æ•´ä¸ªé“¾è·¯ï¼š</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182818378-543092889.png" alt="img"></p>
<p><strong>ä¸Šé¢å¯¹ partition_test_v1 è¡¨çš„ 202008 åˆ†åŒºè¿›è¡Œäº†å¤‡ä»½ï¼Œç„¶åæˆ‘ä»¬è¿›å…¥ shadow å­ç›®å½•ï¼Œä¾¿å¯çœ‹åˆ°ä¹‹å‰å¤‡ä»½çš„åˆ†åŒºç›®å½•ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182826343-1704242937.png" alt="img"></p>
<p><strong>å¦‚æœæƒ³è¿˜åŸåˆ†åŒºï¼Œåˆ™éœ€è¦å€ŸåŠ©äº ATTACH è£…è½½åˆ†åŒºçš„æ–¹å¼å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°† shadow å­ç›®å½•ä¸‹çš„åˆ†åŒºæ–‡ä»¶å¤åˆ¶åˆ°ç›¸åº”æ•°æ®è¡¨çš„ detached ç›®å½•ä¸‹ï¼Œç„¶åå†ä½¿ç”¨ ATTACH è¯­å¥è£…è½½ã€‚</strong></p>
<p><strong>ä½¿ç”¨ FETCH å¤‡ä»½</strong></p>
<p><strong>FETCH åªæ”¯æŒ ReplicatedMergeTree ç³»åˆ—çš„è¡¨å¼•æ“ï¼Œå…¶å®Œæ•´è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE table_name FETCH PARTITION partition_id FROM zk_path</span><br></pre></td></tr></table></figure>

<p><strong>å…¶å·¥ä½œåŸç†ä¸ ReplicatedMergeTree åŒæ­¥æ•°æ®çš„åŸç†ç±»ä¼¼ï¼ŒFETCH é€šè¿‡æŒ‡å®šçš„ zk_path æ‰¾åˆ° ReplicatedMergeTree çš„æ‰€æœ‰å‰¯æœ¬å®ä¾‹ï¼Œç„¶åä»ä¸­é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„å‰¯æœ¬ï¼Œå¹¶ä¸‹è½½ç›¸åº”çš„åˆ†åŒºæ•°æ®ã€‚ä¾‹å¦‚æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE test_fetch FETCH PARTITION 202009 FROM &#x27;/clickhouse/tables/02/test_fetch&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>è¡¨ç¤ºå°† test_fetch çš„ 201909 åˆ†åŒºä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶ä¿å­˜åˆ°å¯¹åº”æ•°æ®è¡¨çš„ detached ç›®å½•ä¸‹ï¼Œç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data/default/test_fetch/detached/202009_0_0_0</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ FREEZE ä¸€æ ·ï¼Œå¯¹äºå¤‡ä»½åˆ†åŒºçš„è¿˜åŸæ“ä½œï¼Œä¹Ÿéœ€è¦å€ŸåŠ© ATTACH è£…è½½åˆ†åŒºæ¥å®ç°ã€‚ å¦å¤– FREEZE å’Œ FETCH è™½ç„¶éƒ½èƒ½å®ç°å¯¹åˆ†åŒºæ–‡ä»¶çš„å¤‡ä»½ï¼Œä½†æ˜¯å®ƒä»¬å¹¶ä¸ä¼šå¤‡ä»½æ•°æ®è¡¨çš„å…ƒæ•°æ®ã€‚æ‰€ä»¥è¯´å¦‚æœæƒ³åšåˆ°ä¸‡æ— ä¸€å¤±çš„å¤‡ä»½ï¼Œè¿˜éœ€è¦å¯¹æ•°æ®è¡¨çš„å…ƒæ•°æ®è¿›è¡Œå¤‡ä»½ï¼Œå®ƒä»¬æ˜¯ &#x2F;data&#x2F;metadata ç›®å½•ä¸‹çš„ [table].sql æ–‡ä»¶ï¼Œç›®å‰è¿™äº›å…ƒæ•°æ®éœ€è¦ç”¨æˆ·é€šè¿‡å¤åˆ¶çš„å½¢å¼å•ç‹¬å¤‡ä»½ã€‚</strong></p>
<h2 id="æœåŠ¡ç›‘æ§"><a href="#æœåŠ¡ç›‘æ§" class="headerlink" title="æœåŠ¡ç›‘æ§"></a>æœåŠ¡ç›‘æ§</h2><p><strong>åŸºäºåŸç”ŸåŠŸèƒ½å¯¹ ClickHouse è¿›è¡Œç›‘æ§ï¼Œå¯ä»¥ä»ä¸¤æ–¹é¢å…¥æ‰‹ï¼šç³»ç»Ÿè¡¨å’ŒæŸ¥è¯¢æ—¥å¿—ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ã€‚</strong></p>
<h3 id="ç³»ç»Ÿè¡¨"><a href="#ç³»ç»Ÿè¡¨" class="headerlink" title="ç³»ç»Ÿè¡¨"></a>ç³»ç»Ÿè¡¨</h3><p><strong>åœ¨ä¼—å¤šçš„ SYSTEM ç³»ç»Ÿè¡¨ä¸­ï¼Œä¸»è¦ç”±ä»¥ä¸‹ä¸‰å¼ è¡¨æ”¯æ’‘äº†å¯¹ ClickHouse è¿è¡ŒæŒ‡æ ‡çš„æŸ¥è¯¢ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ metricsã€events å’Œ asynchronous_metricsã€‚</strong></p>
<h4 id="1ï¼‰metrics"><a href="#1ï¼‰metrics" class="headerlink" title="1ï¼‰metrics"></a>1ï¼‰metrics</h4><p><strong>metrics è¡¨ç”¨äºç»Ÿè®¡ ClickHouse æœåŠ¡åœ¨è¿è¡Œæ—¶ï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„é«˜å±‚æ¬¡çš„æ¦‚è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢æ€»æ¬¡æ•°ã€æ­£åœ¨å‘ç”Ÿåˆå¹¶çš„æ“ä½œæ€»æ¬¡æ•°ç­‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182838146-1057679332.png" alt="img"></p>
<h4 id="events"><a href="#events" class="headerlink" title="events"></a>events</h4><p><strong>events è¡¨ç”¨äºç»Ÿè®¡ ClickHouse æœåŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå·²ç»æ‰§è¡Œè¿‡çš„é«˜å±‚æ¬¡çš„ç´¯ç§¯æ¦‚è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ€»çš„æŸ¥è¯¢æ¬¡æ•°ã€æ€»çš„ SELECT æŸ¥è¯¢æ¬¡æ•°ç­‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182846652-1175367593.png" alt="img"></p>
<h4 id="asynchronous-metrics"><a href="#asynchronous-metrics" class="headerlink" title="asynchronous_metrics"></a>asynchronous_metrics</h4><p><strong>asynchronous_metrics è¡¨ç”¨äºç»Ÿè®¡ ClickHouse æœåŠ¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“å‰åå°æ­£åœ¨å¼‚æ­¥è¿è¡Œçš„é«˜å±‚æ¬¡çš„æ¦‚è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰åˆ†é…çš„å†…å­˜ã€æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ç­‰ã€‚</strong></p>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8E%E8%BF%90%E7%BB%B4(%E5%8D%81%E4%B9%9D)/1229382-20211008182853513-131246570.png" alt="img"></p>
<h3 id="æŸ¥è¯¢æ—¥å¿—"><a href="#æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="æŸ¥è¯¢æ—¥å¿—"></a>æŸ¥è¯¢æ—¥å¿—</h3><p><strong>æŸ¥è¯¢æ—¥å¿—ç›®å‰ä¸»è¦æœ‰ 6 ç§ç±»å‹ï¼Œå®ƒä»¬åˆ†åˆ«ä»ä¸åŒè§’åº¦è®°å½•äº† ClickHouse çš„æ“ä½œè¡Œä¸ºã€‚æ‰€æœ‰æŸ¥è¯¢æ—¥å¿—åœ¨é»˜è®¤é…ç½®ä¸‹éƒ½æ˜¯å…³é—­çŠ¶æ€ï¼Œéœ€è¦åœ¨ config.xml é…ç½®ä¸­è¿›è¡Œæ›´æ”¹ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„å¼€å¯æ–¹æ³•ã€‚åœ¨é…ç½®è¢«å¼€å¯ä¹‹åï¼ŒClickHouse ä¼šä¸ºæ¯ç§ç±»å‹çš„æŸ¥è¯¢æ—¥å¿—è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ç³»ç»Ÿè¡¨ä»¥ä¾›æŸ¥è¯¢ã€‚</strong></p>
<h4 id="1-query-log"><a href="#1-query-log" class="headerlink" title="1. query_log"></a>1. query_log</h4><p><strong>query_log æ˜¯æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ—¥å¿—ï¼Œå®ƒè®°å½•äº† ClickHouse æœåŠ¡ä¸­æ‰€æœ‰å·²ç»æ‰§è¡Œçš„æŸ¥è¯¢è®°å½•ï¼Œå®ƒçš„å…¨å±€å®šä¹‰æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">query_log</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database</span>&gt;</span>system<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span>query_log<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition_by</span>&gt;</span>toYYYYMM(event_date)<span class="tag">&lt;/<span class="name">partition_by</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- åˆ·æ–°å‘¨æœŸ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flush_interval_milliseconds</span>&gt;</span>7500<span class="tag">&lt;/<span class="name">flush_interval_milliseconds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">query_log</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœåªå¸Œæœ›å…·æœ‰æŸäº›è§’è‰²ç”¨æˆ·æ‰èƒ½å¼€å¯ query_logï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ users.xml çš„ç”¨æˆ· profile ä¸­å¢åŠ ä¸€ä¸ªæ ‡ç­¾ï¼š1ã€‚</strong></p>
<p><strong>query_log å¼€å¯åï¼Œå³å¯é€šè¿‡ç›¸åº”çš„ç³»ç»Ÿè¡¨å¯¹è®°å½•è¿›è¡ŒæŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM system.query_log</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›çš„æ—¥å¿—ä¿¡æ¯ååˆ†å®Œå–„ï¼Œæ¶µç›–äº†æŸ¥è¯¢è¯­å¥ã€æ‰§è¡Œæ—¶é—´ã€è¿”å›çš„æ•°æ®é‡å’Œæ‰§è¡Œç”¨æˆ·ç­‰ã€‚</strong></p>
<h4 id="2-query-thread-log"><a href="#2-query-thread-log" class="headerlink" title="2. query_thread_log"></a>2. query_thread_log</h4><p><strong>query_thread_log è®°å½•äº†æ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡ŒæŸ¥è¯¢çš„ä¿¡æ¯ï¼Œå®ƒçš„å…¨å±€å®šä¹‰æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">query_thread_log</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database</span>&gt;</span>system<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span>query_thread_log<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition_by</span>&gt;</span>toYYYYMM(event_date)<span class="tag">&lt;/<span class="name">partition_by</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- åˆ·æ–°å‘¨æœŸ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flush_interval_milliseconds</span>&gt;</span>7500<span class="tag">&lt;/<span class="name">flush_interval_milliseconds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">query_thread_log</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœåªå¸Œæœ›å…·æœ‰æŸäº›è§’è‰²ç”¨æˆ·æ‰èƒ½å¼€å¯ query_logï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ users.xml çš„ç”¨æˆ· profile ä¸­å¢åŠ ä¸€ä¸ªæ ‡ç­¾ï¼š1ã€‚</strong></p>
<p><strong>log_query_thread å¼€å¯åï¼Œå³å¯é€šè¿‡ç›¸åº”çš„ç³»ç»Ÿè¡¨å¯¹è®°å½•è¿›è¡ŒæŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM system.log_query_thread</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›çš„æ—¥å¿—ä¿¡æ¯ååˆ†å®Œå–„ï¼Œæ¶µç›–äº†çº¿ç¨‹åç§°ã€æŸ¥è¯¢è¯­å¥ã€æ‰§è¡Œæ—¶é—´ã€å’Œå†…å­˜ä½¿ç”¨é‡ç­‰ã€‚</strong></p>
<h4 id="3-part-log"><a href="#3-part-log" class="headerlink" title="3. part_log"></a>3. part_log</h4><p><strong>part_log è®°å½•äº† MergeTree ç³»åˆ—è¡¨å¼•æ“çš„åˆ†åŒºæ“ä½œæ—¥å¿—ï¼Œå…¶å…¨å±€å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">part_log</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database</span>&gt;</span>system<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span>part_log<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flush_interval_milliseconds</span>&gt;</span>7500<span class="tag">&lt;/<span class="name">flush_interval_milliseconds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">part_log</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>part_log å¼€å¯åï¼Œå³å¯é€šè¿‡ç›¸åº”çš„ç³»ç»Ÿè¡¨å¯¹è®°å½•è¿›è¡ŒæŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM system.part_log</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›çš„æ—¥å¿—ä¿¡æ¯ååˆ†å®Œå–„ï¼Œæ¶µç›–äº†æ“çºµç±»å‹ã€è¡¨åç§°ã€åˆ†åŒºä¿¡æ¯å’Œæ‰§è¡Œæ—¶é—´ç­‰ã€‚</strong></p>
<h4 id="4-text-log"><a href="#4-text-log" class="headerlink" title="4. text_log"></a>4. text_log</h4><p><strong>text_log æ—¥å¿—è®°å½•äº† ClickHouse è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ç³»åˆ—æ‰“å°æ—¥å¿—ï¼ŒåŒ…æ‹¬ INFOã€DEBUG å’Œ TRACEï¼Œå®ƒçš„å…¨å±€å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">text_log</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database</span>&gt;</span>system<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span>text_log<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flush_interval_milliseconds</span>&gt;</span>7500<span class="tag">&lt;/<span class="name">flush_interval_milliseconds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">text_log</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>text_log å¼€å¯åï¼Œå³å¯é€šè¿‡ç›¸åº”çš„ç³»ç»Ÿè¡¨å¯¹è®°å½•è¿›è¡ŒæŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM system.text_log</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›çš„æ—¥å¿—ä¿¡æ¯ååˆ†å®Œå–„ï¼Œæ¶µç›–äº†çº¿ç¨‹åç§°ã€æ—¥å¿—å¯¹è±¡ã€æ—¥å¿—ä¿¡æ¯å’Œæ‰§è¡Œæ—¶é—´ç­‰ç­‰ã€‚</strong></p>
<h4 id="5-metric-log"><a href="#5-metric-log" class="headerlink" title="5. metric_log"></a>5. metric_log</h4><p><strong>metric_log æ—¥å¿—ç”¨äºå°† system.metrics å’Œ system.events ä¸­çš„æ•°æ®æ±‡èšåˆ°ä¸€èµ·ï¼Œå®ƒçš„å…¨å±€å®šä¹‰æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">metric_log</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">database</span>&gt;</span>system<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span>metric_log<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flush_interval_milliseconds</span>&gt;</span>7500<span class="tag">&lt;/<span class="name">flush_interval_milliseconds</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- æ”¶é›† metrics å’Œ event çš„æ—¶é—´ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collect_interval_milliseconds</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">collect_interval_milliseconds</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">metric_log</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>metric_log å¼€å¯åï¼Œå³å¯é€šè¿‡ç›¸åº”çš„ç³»ç»Ÿè¡¨å¯¹è®°å½•è¿›è¡ŒæŸ¥è¯¢ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM system.metric_log</span><br></pre></td></tr></table></figure>

<p><strong>ä»¥ä¸Šå°±æ˜¯å‡ ç§æŸ¥è¯¢æ—¥å¿—ï¼Œå½“ç„¶ï¼Œé™¤äº†è¿™äº›è‡ªèº«çš„æŸ¥è¯¢æ—¥å¿—ä¹‹å¤–ï¼ŒClickHouse è¿˜èƒ½å¤Ÿä¸ä¼—å¤šçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆï¼Œæ¯”å¦‚ Prometheusã€‚å½“ç„¶ç›‘æ§ç³»ç»Ÿåˆæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„è¯é¢˜äº†ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ï¼Œæœ‰å…´è¶£å¯ä»¥å»è°ƒç ”ä¸€ä¸‹ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>ClickHouse çš„ç³»ç»Ÿè¡¨(åå…«)</title>
    <url>/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/</url>
    <content><![CDATA[<h1 id="ClickHouse-çš„ç³»ç»Ÿè¡¨-åå…«"><a href="#ClickHouse-çš„ç³»ç»Ÿè¡¨-åå…«" class="headerlink" title="ClickHouse çš„ç³»ç»Ÿè¡¨(åå…«)"></a>ClickHouse çš„ç³»ç»Ÿè¡¨(åå…«)</h1><p>â€‹																	æœ¬æ–‡æ¥æºï¼š ( <a href="https://www.cnblogs.com/traditional/tag/ClickHouse%EF%BC%9A%E4%B8%80%E6%AC%BE%E9%80%9F%E5%BA%A6%E5%BF%AB%E5%88%B0%E8%AE%A9%E4%BA%BA%E5%8F%91%E6%8C%87%E7%9A%84%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E5%BA%93/">https://www.cnblogs.com/traditional/tag/ClickHouseï¼šä¸€æ¬¾é€Ÿåº¦å¿«åˆ°è®©äººå‘æŒ‡çš„åˆ—å¼å­˜å‚¨æ•°æ®åº“/</a> ) </p>
<hr>
<h4 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h4><p><strong>æˆ‘ä»¬çŸ¥é“ ClickHouse è‡ªå¸¦ä¸¤ä¸ªåº“ï¼Œåˆ†åˆ«æ˜¯ default å’Œ systemï¼Œdefault æ˜¯é»˜è®¤çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬åˆ›å»ºè¡¨çš„æ—¶å€™å¦‚æœä¸æŒ‡å®šåº“åï¼Œé‚£ä¹ˆé»˜è®¤ä¼šåœ¨ default ä¸‹åˆ›å»ºã€‚è€Œ system åˆ™æ˜¯ç³»ç»Ÿåº“ï¼Œé‡Œé¢å­˜æ”¾äº†å¤§é‡ä¸ç³»ç»Ÿç›¸å…³çš„è¡¨ï¼Œé€šè¿‡è¿™äº›ç³»ç»Ÿè¡¨æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æœåŠ¡å™¨çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ã€‚</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">use <span class="keyword">system</span>;</span><br><span class="line"><span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150412313-687075072.png" alt="img"></p>
<p><strong>æ€»å…±æœ‰ 69 ä¸ªç³»ç»Ÿè¡¨ï¼Œé€šè¿‡è¿™äº›ç³»ç»Ÿè¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç‰¢ç‰¢æŠŠæ§ ClickHouse æœåŠ¡ç«¯çš„è¿è¡ŒçŠ¶æ€ã€‚ä¸‹é¢æ¥çœ‹çœ‹å°±æ¥æŒ‘å‡ ä¸ªä»‹ç»ä¸€ä¸‹ã€‚</strong></p>
<h4 id="system-asynchronous-metrics"><a href="#system-asynchronous-metrics" class="headerlink" title="system.asynchronous_metrics"></a>system.asynchronous_metrics</h4><p><strong>ClickHouse åœ¨åå°ä¼šå®šæœŸå¯¹ä¸€äº›æŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å†…å­˜çš„ä½¿ç”¨é‡ï¼Œè¯¥è¡¨è´Ÿè´£å­˜å‚¨ç›¸å…³æŒ‡æ ‡ä»¥åŠå¯¹åº”çš„å€¼ã€‚</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>metricï¼šæŒ‡æ ‡åï¼ŒString ç±»å‹</code></li>
<li><code>valueï¼šæŒ‡æ ‡å€¼ï¼ŒFloat64 ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150422218-1683570183.png" alt="img"></p>
<h4 id="system-asynchronous-metric-log"><a href="#system-asynchronous-metric-log" class="headerlink" title="system.asynchronous_metric_log"></a>system.asynchronous_metric_log</h4><p><strong>å’Œ system.asynchronous_metric ä½œç”¨ç›¸åŒï¼Œä½†æ˜¯å¤šäº†ä¸€äº›æ—¶é—´å­—æ®µã€‚</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>event_dateï¼šæ—¥æœŸï¼ŒDate ç±»å‹</code></li>
<li><code>event_timeï¼šæ—¶é—´ï¼ŒDateTime ç±»å‹</code></li>
<li><code>event_time_microsecondsï¼šå¸¦æ¯«ç§’çš„æ—¶é—´ï¼ŒDateTime64 ç±»å‹</code></li>
<li><code>nameï¼šæŒ‡æ ‡åï¼ŒString ç±»å‹</code></li>
<li><code>valueï¼šæŒ‡æ ‡å€¼ï¼ŒFloat64 ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150430234-577632248.png" alt="img"></p>
<h4 id="system-clusters"><a href="#system-clusters" class="headerlink" title="system.clusters"></a>system.clusters</h4><p><strong>è€ç†Ÿäººäº†è¿™ä¸ªï¼Œè´Ÿè´£å­˜å‚¨é…ç½®æ–‡ä»¶ä¸­çš„å¯ç”¨é›†ç¾¤ä¿¡æ¯ã€‚</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>clusterï¼šé›†ç¾¤åç§°ï¼ŒString ç±»å‹</code></li>
<li><code>shard_numï¼šé›†ç¾¤ä¸­çš„ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä» 1 å¼€å§‹ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>shard_weightï¼šåˆ†ç‰‡çš„æƒé‡ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>replica_numï¼šä¸€ä¸ªåˆ†ç‰‡ä¸­çš„ç¬¬å‡ ä¸ªå‰¯æœ¬ï¼Œä» 1 å¼€å§‹ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>host_nameï¼šå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹çš„ä¸»æœºåï¼ŒString ç±»å‹</code></li>
<li><code>host_addressï¼šå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹çš„ IP åœ°å€ï¼ŒString ç±»å‹</code></li>
<li><code>portï¼šå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹çš„ç«¯å£ï¼ŒUInt16 ç±»å‹</code></li>
<li><code>is_localï¼šæ˜¯å¦ä¸ºæœ¬åœ°èŠ‚ç‚¹ï¼ˆå’Œå½“å‰æ‰§è¡Œ SELECT ... FROM syst.clusters çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼‰ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>userï¼šè¿æ¥è‡³æœåŠ¡ç«¯çš„ç”¨æˆ·ï¼ŒString ç±»å‹</code></li>
<li><code>default_databaseï¼šé»˜è®¤æ•°æ®åº“ï¼ŒString ç±»å‹</code></li>
<li><code>errors_countï¼šè¯¥èŠ‚ç‚¹è¿æ¥å‰¯æœ¬å¤±è´¥çš„æ¬¡æ•°ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>slowdowns_countï¼šå½“ä½¿ç”¨å¯¹å†²è¯·æ±‚å»ºç«‹è¿æ¥æ—¶ï¼Œå¯¼è‡´æ›´æ”¹å‰¯æœ¬å˜æ…¢çš„æ¬¡æ•°ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>estimated_recovery_timeï¼šè·ç¦»å‰¯æœ¬é”™è¯¯å½’é›¶å¹¶è¢«è®¤ä¸ºæ¢å¤æ­£å¸¸è¿˜å‰©å¤šå°‘ç§’ï¼ŒUInt32 ç±»å‹</code></li>
</ul>
<h4 id="system-columns"><a href="#system-columns" class="headerlink" title="system.columns"></a>system.columns</h4><p><strong>éå¸¸å¸¸ç”¨çš„ä¸€å¼ è¡¨ï¼Œè´Ÿè´£å­˜å‚¨è¡¨çš„å­—æ®µä¿¡æ¯ã€‚</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>databaseï¼šæ•°æ®åº“åï¼ŒString ç±»å‹</code></li>
<li><code>tableï¼šè¡¨åï¼ŒString ç±»å‹</code></li>
<li><code>nameï¼šå­—æ®µåï¼ŒString ç±»å‹</code></li>
<li><code>typeï¼šå­—æ®µçš„ç±»å‹ï¼ŒString ç±»å‹</code></li>
<li><code>positionï¼šå­—æ®µåœ¨è¡¨ä¸­ä½äºç¬¬å‡ åˆ—ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>default_kindï¼šé»˜è®¤å€¼è¡¨è¾¾å¼ç±»å‹ï¼Œå¦‚ DEFAULTã€MATERIALIZEDã€ALIASï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼ŒString ç±»å‹</code></li>
<li><code>default_expressionï¼šé»˜è®¤å€¼è¡¨è¾¾å¼çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼ŒString ç±»å‹</code></li>
<li><code>data_compressed_bytesï¼šè¯¥åˆ—æ•°æ®åœ¨å‹ç¼©ä¹‹åçš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>data_uncompressed_bytesï¼šè¯¥åˆ—æ•°æ®æœªå‹ç¼©æ—¶çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>marks_bytesï¼šæ ‡è®°çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>commentï¼šå­—æ®µçš„æ³¨é‡Šï¼ŒString ç±»å‹</code></li>
<li><code>is_in_partition_keyï¼šè¯¥åˆ—æ˜¯å¦åœ¨åˆ†åŒºè¡¨è¾¾å¼ä¸­ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>is_in_sorting_keyï¼šè¯¥åˆ—æ˜¯å¦åœ¨æ’åºé”®è¡¨è¾¾å¼ä¸­ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>is_in_primary_keyï¼šè¯¥åˆ—æ˜¯å¦åœ¨ä¸»é”®è¡¨è¾¾å¼ä¸­ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>is_in_sampling_keyï¼šè¯¥åˆ—æ˜¯å¦åœ¨ sampling key è¡¨è¾¾å¼ä¸­ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>compression_codecï¼šå‹ç¼©å™¨çš„åç§°ï¼ŒString ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150438818-1598358889.png" alt="img"></p>
<h4 id="system-crash-log"><a href="#system-crash-log" class="headerlink" title="system.crash_log"></a>system.crash_log</h4><p><strong>è´Ÿè´£è®°å½•å‘ç”Ÿè‡´å‘½é”™è¯¯æ—¶çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ system åº“ä¸­ä¸å­˜åœ¨è¯¥è¡¨ï¼Œåªæœ‰åœ¨å‘ç”Ÿè‡´å‘½é”™è¯¯æ—¶è¯¥è¡¨æ‰ä¼šåˆ›å»ºã€‚</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>event_dateï¼šé”™è¯¯å‘ç”Ÿæ—¥æœŸï¼ŒDate ç±»å‹</code></li>
<li><code>event_timeï¼šé”™è¯¯å‘ç”Ÿæ—¶é—´ï¼ŒDateTime ç±»å‹</code></li>
<li><code>timestamp_nsï¼šé”™è¯¯å‘ç”Ÿæ—¶çš„æ—¶é—´æˆ³ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>signalï¼šä¿¡å·å€¼ï¼ŒInt32 ç±»å‹</code></li>
<li><code>thread_idï¼šé”™è¯¯å‘ç”Ÿæ—¶çš„çº¿ç¨‹ IDï¼ŒUInt64 ç±»å‹</code></li>
<li><code>query_idï¼šé”™è¯¯å‘ç”Ÿæ—¶çš„æŸ¥è¯¢ IDï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå“ªä¸ªæŸ¥è¯¢å‘ç”Ÿäº†è‡´å‘½é”™è¯¯ï¼ŒString ç±»å‹</code></li>
<li><code>traceï¼šå´©æºƒæ—¶çš„å †æ ˆè·Ÿè¸ªï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ ClickHouse æœåŠ¡è¿›ç¨‹ä¸­çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼ŒArray(UInt64) ç±»å‹</code></li>
<li><code>trace_fullï¼šå´©æºƒæ—¶çš„å †æ ˆè·Ÿè¸ªï¼Œæ¯ä¸ªå…ƒç´ åœ¨ ClickHouse æœåŠ¡è¿›ç¨‹ä¸­éƒ½åŒ…å«ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•ï¼ŒArray(String) ç±»å‹</code></li>
<li><code>versionï¼šClickHouse æœåŠ¡å™¨ç‰ˆæœ¬ï¼ŒString ç±»å‹</code></li>
<li><code>reversionï¼šClickHouse æœåŠ¡å™¨ç‰ˆæœ¬ï¼ŒUInt32 ç±»å‹</code></li>
<li><code>build_idï¼šç¼–è¯‘å™¨ç”Ÿæˆçš„ BuildIDï¼ŒString ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150446364-1806332141.png" alt="img"></p>
<h4 id="system-data-skipping-indices"><a href="#system-data-skipping-indices" class="headerlink" title="system.data_skipping_indices"></a>system.data_skipping_indices</h4><p><strong>è´Ÿè´£è®°å½•æ‰€æœ‰è¡¨ä¸­å·²å­˜åœ¨çš„è·³æ•°ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>databaseï¼šæ•°æ®åº“åï¼ŒString ç±»å‹</code></li>
<li><code>tableï¼šè¡¨åï¼ŒString ç±»å‹</code></li>
<li><code>nameï¼šç´¢å¼•åï¼ŒString ç±»å‹</code></li>
<li><code>typeï¼šç´¢å¼•ç±»å‹ï¼ŒString ç±»å‹</code></li>
<li><code>exprï¼šç´¢å¼•è®¡ç®—çš„è¡¨è¾¾å¼ï¼ŒString ç±»å‹</code></li>
<li><code>granularityï¼šç´¢å¼•ç²’åº¦ï¼ŒUInt64 ç±»å‹</code></li>
</ul>
<h4 id="system-databases"><a href="#system-databases" class="headerlink" title="system.databases"></a>system.databases</h4><p><strong>è´Ÿè´£è®°å½•å·²å­˜åœ¨çš„æ•°æ®åº“çš„ä¿¡æ¯ï¼ˆå½“ç„¶ç”¨æˆ·å¯ä»¥çœ‹åˆ°çš„æ•°æ®åº“ï¼‰</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>nameï¼šæ•°æ®åº“åç§°ï¼ŒString ç±»å‹</code></li>
<li><code>engineï¼šå®šä¹‰æ•°æ®åº“æ—¶æ‰€ä½¿ç”¨çš„å¼•æ“ï¼ŒString ç±»å‹</code></li>
<li><code>data_pathï¼šè¯¥æ•°æ®åº“ä¸‹æ•°æ®è¡¨çš„ç‰©ç†å­˜å‚¨è·¯å¾„ï¼ŒString ç±»å‹</code></li>
<li><code>metadata_pathï¼šæ•°æ®è¡¨çš„å…ƒæ•°æ®çš„å­˜å‚¨è·¯å¾„ï¼ŒString ç±»å‹</code></li>
<li><code>uuidï¼šæ•°æ®åº“å¯¹åº”çš„ UUIDï¼Œæ¯ä¸ªæ•°æ®åº“åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šæœ‰ä¸€ä¸ª UUIDï¼ŒUUID ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150455634-1076094929.png" alt="img"></p>
<h4 id="system-disks"><a href="#system-disks" class="headerlink" title="system.disks"></a>system.disks</h4><p><strong>è´Ÿè´£è®°å½•é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ç£ç›˜ä¿¡æ¯</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>nameï¼šç£ç›˜åç§°ï¼ŒString ç±»å‹</code></li>
<li><code>pathï¼šåœ¨ç‰©ç†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŒ‚è½½ç‚¹ï¼ŒString ç±»å‹</code></li>
<li><code>free_spaceï¼šç£ç›˜çš„å¯ç”¨ç©ºé—´ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>total_spaceï¼šç£ç›˜çš„å¯ç”¨ç©ºé—´ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>keep_free_spaceï¼šç£ç›˜åº”ä¿ç•™çš„ç©ºé—²å¯ç”¨ç©ºé—´ï¼Œé€šè¿‡ keep_free_space_bytes æ ‡ç­¾å®šä¹‰ï¼ŒUInt64 ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150504125-906133554.png" alt="img"></p>
<h4 id="system-distributed-ddl-queue"><a href="#system-distributed-ddl-queue" class="headerlink" title="system.distributed_ddl_queue"></a>system.distributed_ddl_queue</h4><p><strong>è´Ÿè´£è®°å½•æ‰§è¡Œè¿‡çš„åˆ†å¸ƒå¼ DDL æŸ¥è¯¢</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>entryï¼šquery idï¼ŒString ç±»å‹</code></li>
<li><code>host_nameï¼šæ‰§è¡Œåˆ†å¸ƒå¼ DDL æŸ¥è¯¢çš„èŠ‚ç‚¹çš„ä¸»æœºåï¼ŒString ç±»å‹</code></li>
<li><code>host_addressï¼šæ‰§è¡Œåˆ†å¸ƒå¼ DDL æŸ¥è¯¢çš„èŠ‚ç‚¹çš„ IP åœ°å€ï¼ŒString ç±»å‹</code></li>
<li><code>portï¼šæ‰§è¡Œåˆ†å¸ƒå¼ DDL æŸ¥è¯¢çš„èŠ‚ç‚¹ç›‘å¬çš„ç«¯å£ï¼ŒUInt16 ç±»å‹</code></li>
<li><code>statusï¼šæŸ¥è¯¢çš„æ‰§è¡ŒçŠ¶æ€ï¼ŒEnum8 ç±»å‹</code></li>
<li><code>clusterï¼šé›†ç¾¤åç§°ï¼ŒString ç±»å‹</code></li>
<li><code>queryï¼šæ‰§è¡Œçš„ queryï¼ŒString ç±»å‹</code></li>
<li><code>initiatorï¼šæ‰§è¡ŒæŸ¥è¯¢çš„èŠ‚ç‚¹ï¼ŒString ç±»å‹</code></li>
<li><code>query_start_timeï¼šæŸ¥è¯¢å¼€å§‹æ—¶é—´ï¼ŒDateTime ç±»å‹</code></li>
<li><code>query_finish_timeï¼šæŸ¥è¯¢ç»“æŸæ—¶é—´ï¼ŒDateTime ç±»å‹</code></li>
<li><code>query_duration_msï¼šæŸ¥è¯¢æ‰§è¡Œæ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼ŒUInt64 ç±»å‹</code></li>
<li><code>exception_codeï¼šæ¥è‡ª ZooKeeper çš„å¼‚å¸¸ç ï¼ŒEnum8 ç±»å‹</code></li>
</ul>
<p><img src="/2023/04/11/ClickHouse%20%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%A1%A8(%E5%8D%81%E5%85%AB)/1229382-20210928150511320-2137346480.png" alt="img"></p>
<h4 id="system-tables"><a href="#system-tables" class="headerlink" title="system.tables"></a>system.tables</h4><p><strong>è´Ÿè´£è®°å½•å·²å­˜åœ¨çš„æ‰€æœ‰è¡¨çš„å…ƒæ•°æ®ä¿¡æ¯</strong></p>
<p><strong>å­—æ®µï¼š</strong></p>
<ul>
<li><code>databaseï¼šæ•°æ®åº“åï¼ŒString ç±»å‹</code></li>
<li><code>nameï¼šè¡¨åï¼ŒString ç±»å‹</code></li>
<li><code>uuidï¼šåˆ›å»ºè¡¨æ—¶ç”Ÿæˆçš„ UUIDï¼ŒUUID ç±»å‹</code></li>
<li><code>engineï¼šè¡¨ä½¿ç”¨çš„å¼•æ“ï¼ŒString ç±»å‹</code></li>
<li><code>is_temporaryï¼šæ˜¯å¦æ˜¯ä¸´æ—¶è¡¨ï¼ŒUInt8 ç±»å‹</code></li>
<li><code>data_pathsï¼šè¡¨æ•°æ®åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç‰©ç†è·¯å¾„ï¼Œstring ç±»å‹</code></li>
<li><code>metadata_pathï¼šè¡¨å…ƒæ•°æ®åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç‰©ç†è·¯å¾„ï¼ŒString ç±»å‹</code></li>
<li><code>metadata_modification_timeï¼šè¡¨å…ƒæ•°æ®æœ€è¿‘ä¸€æ¬¡çš„ä¿®æ”¹æ—¶é—´ï¼ŒDateTime ç±»å‹</code></li>
<li><code>dependencies_databaseï¼šæ•°æ®åº“ä¾èµ–å…³ç³»ï¼ŒArray(String) ç±»å‹</code></li>
<li><code>dependencies_tableï¼šè¡¨ä¾èµ–å…³ç³»ï¼Œé’ˆå¯¹ç‰©åŒ–è§†å›¾ï¼ŒArray(String) ç±»å‹</code></li>
<li><code>create_table_queryï¼šåˆ›å»ºè¯¥è¡¨æ—¶çš„ SQL è¯­å¥ï¼ŒString ç±»å‹</code></li>
<li><code>engine_fullï¼šè¡¨å¼•æ“çš„å‚æ•°ï¼ŒString ç±»å‹</code></li>
<li><code>partition_keyï¼šåˆ†åŒºé”®è¡¨è¾¾å¼ï¼ŒString ç±»å‹</code></li>
<li><code>sorting_keyï¼šæ’åºé”®è¡¨è¾¾å¼ï¼ŒString ç±»å‹</code></li>
<li><code>primary_keyï¼šä¸»é”®è¡¨è¾¾å¼ï¼ŒString ç±»å‹</code></li>
<li><code>sampling_keyï¼šsampling key è¡¨è¾¾å¼ï¼ŒString ç±»å‹</code></li>
<li><code>storage_policyï¼šå­˜å‚¨ç­–ç•¥ï¼ŒString ç±»å‹</code></li>
<li><code>total_rowsï¼šæ•°æ®è¡¨çš„æ€»è¡Œæ•°ï¼ŒNullable(UInt64)</code></li>
<li><code>total_bytesï¼šæ•°æ®è¡¨çš„æ€»å¤§å°ã€‚å¦‚æœè¡¨å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œè¿”å›ä½¿ç”¨ç£ç›˜ç©ºé—´ï¼ˆå‹ç¼©ä¹‹åçš„ï¼‰ï¼›å¦‚æœè¡¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿”å›ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œå•ä½å­—èŠ‚ï¼ŒNullable(UInt64) ç±»å‹</code></li>
<li><code>lifetime_rowsï¼šè‡ªæœåŠ¡å¯åŠ¨ä»¥æ¥ï¼Œæ’å…¥çš„æ•°æ®çš„æ€»è¡Œæ•°ï¼Œä»…é€‚ç”¨äº Buffer è¡¨ï¼ŒNullable(UInt64) ç±»å‹</code></li>
<li><code>lifetime_bytesï¼šè‡ªæœåŠ¡å¯åŠ¨ä»¥æ¥ï¼Œæ’å…¥çš„æ•°æ®æ‰€å çš„æ€»å­—èŠ‚æ•°ï¼Œä»…é€‚ç”¨äº Buffer è¡¨ï¼ŒNullable(UInt64) ç±»å‹</code></li>
<li><code>commentï¼šè¡¨æ³¨é‡Š</code></li>
</ul>
<p><strong>æˆ‘ä»¬ä½¿ç”¨ show tables ç­‰ä»·äº SELECT * FROM system.tables WHERE database &#x3D; â€˜xxxâ€™ã€‚</strong></p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p><strong>ä»¥ä¸Šæˆ‘ä»¬å°±ä»‹ç»äº†ä¸€äº›ç³»ç»Ÿè¡¨ï¼Œå½“ç„¶ ClickHouse ä¸­çš„ç³»ç»Ÿè¡¨è¿œä¸æ­¢æˆ‘ä»¬è¯´çš„è¿™äº›ï¼Œæ›´å¤šå†…å®¹å¯ä»¥å‰å¾€<a href="https://clickhouse.com/docs/en/operations/system-tables/">å®˜ç½‘</a>æŸ¥çœ‹ï¼Œå†™çš„è¿˜æ˜¯æ¯”è¾ƒè¯¦ç»†çš„ã€‚å½“ç„¶æˆ‘ä»¬åé¢åœ¨è¯´ ClickHouse æƒé™ç®¡ç†çš„æ—¶å€™ï¼Œè¿˜ä¼šå†ä»‹ç»å‡ ä¸ªç³»ç»Ÿè¡¨ã€‚</strong></p>
]]></content>
      <categories>
        <category>ClickHouse</category>
      </categories>
      <tags>
        <tag>ClickHouse</tag>
      </tags>
  </entry>
  <entry>
    <title>Java8å¼‚æ­¥åˆ©å™¨ï¼šCompletableFutureä½¿ç”¨æ•™ç¨‹</title>
    <url>/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>CompletableFutureæ˜¯jdk8çš„æ–°ç‰¹æ€§ã€‚CompletableFutureå®ç°äº†CompletionStageæ¥å£å’ŒFutureæ¥å£ï¼Œå‰è€…æ˜¯å¯¹åè€…çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¢åŠ äº†å¼‚æ­¥ä¼šç‚¹ã€æµå¼å¤„ç†ã€å¤šä¸ªFutureç»„åˆå¤„ç†çš„èƒ½åŠ›ï¼Œä½¿Javaåœ¨å¤„ç†å¤šä»»åŠ¡çš„ååŒå·¥ä½œæ—¶æ›´åŠ é¡ºç•…ä¾¿åˆ©ã€‚</p>
<h2 id="ä¸€ã€åˆ›å»ºå¼‚æ­¥ä»»åŠ¡"><a href="#ä¸€ã€åˆ›å»ºå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="ä¸€ã€åˆ›å»ºå¼‚æ­¥ä»»åŠ¡"></a>ä¸€ã€åˆ›å»ºå¼‚æ­¥ä»»åŠ¡</h2><h3 id="1-supplyAsync"><a href="#1-supplyAsync" class="headerlink" title="1. supplyAsync"></a>1. supplyAsync</h3><p>supplyAsyncæ˜¯åˆ›å»ºå¸¦æœ‰è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡ã€‚å®ƒæœ‰å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼ˆForkJoinPool.commonPool()ï¼‰çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¸¦æœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± çš„é‡è½½æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¸¦è¿”å›å€¼å¼‚æ­¥è¯·æ±‚ï¼Œé»˜è®¤çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦è¿”å›å€¼çš„å¼‚æ­¥è¯·æ±‚ï¼Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç»“æœ-&gt;&quot;</span> + cf.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        CompletableFuture&lt;String&gt; cf = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">        &#125;, executorService);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç»“æœ-&gt;&quot;</span> + cf.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680242908549.png" alt="1680242908549"></p>
<h3 id="2-runAsync"><a href="#2-runAsync" class="headerlink" title="2. runAsync"></a>2. runAsync</h3><p>runAsyncæ˜¯åˆ›å»ºæ²¡æœ‰è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡ã€‚å®ƒæœ‰å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼ˆForkJoinPool.commonPool()ï¼‰çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¸¦æœ‰è‡ªå®šä¹‰çº¿ç¨‹æ± çš„é‡è½½æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸å¸¦è¿”å›å€¼çš„å¼‚æ­¥è¯·æ±‚ï¼Œé»˜è®¤çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// ä¸å¸¦è¿”å›å€¼çš„å¼‚æ­¥è¯·æ±‚ï¼Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç»“æœ-&gt;&quot;</span> + cf.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;do something....&quot;</span>);</span><br><span class="line">        &#125;, executorService);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ç»“æœ-&gt;&quot;</span> + cf.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680242980061.png" alt="1680242980061"><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680250853857.png" alt="1680250853857"></p>
<h3 id="3-è·å–ä»»åŠ¡ç»“æœçš„æ–¹æ³•"><a href="#3-è·å–ä»»åŠ¡ç»“æœçš„æ–¹æ³•" class="headerlink" title="3.è·å–ä»»åŠ¡ç»“æœçš„æ–¹æ³•"></a>3.è·å–ä»»åŠ¡ç»“æœçš„æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœå®Œæˆåˆ™è¿”å›ç»“æœï¼Œå¦åˆ™å°±æŠ›å‡ºå…·ä½“çš„å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span><br><span class="line"> </span><br><span class="line"><span class="comment">// æœ€å¤§æ—¶é—´ç­‰å¾…è¿”å›ç»“æœï¼Œå¦åˆ™å°±æŠ›å‡ºå…·ä½“å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å®Œæˆæ—¶è¿”å›ç»“æœå€¼ï¼Œå¦åˆ™æŠ›å‡ºuncheckedå¼‚å¸¸ã€‚ä¸ºäº†æ›´å¥½åœ°ç¬¦åˆé€šç”¨å‡½æ•°å½¢å¼çš„ä½¿ç”¨ï¼Œå¦‚æœå®Œæˆæ­¤ CompletableFutureæ‰€æ¶‰åŠçš„è®¡ç®—å¼•å‘å¼‚å¸¸ï¼Œåˆ™æ­¤æ–¹æ³•å°†å¼•å‘uncheckedå¼‚å¸¸å¹¶å°†åº•å±‚å¼‚å¸¸ä½œä¸ºå…¶åŸå› </span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">join</span><span class="params">()</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å¦‚æœå®Œæˆåˆ™è¿”å›ç»“æœå€¼ï¼ˆæˆ–æŠ›å‡ºä»»ä½•é‡åˆ°çš„å¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è¿”å›ç»™å®šçš„ valueIfAbsentã€‚</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">getNow</span><span class="params">(T valueIfAbsent)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œè¿”å›çš„å€¼è®¾ç½®ä¸ºç»™å®šå€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">complete</span><span class="params">(T value)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œå°±æŠ›å‡ºç»™å®šå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">completeExceptionally</span><span class="params">(Throwable ex)</span> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h2 id="äºŒã€å¼‚æ­¥å›è°ƒå¤„ç†"><a href="#äºŒã€å¼‚æ­¥å›è°ƒå¤„ç†" class="headerlink" title="äºŒã€å¼‚æ­¥å›è°ƒå¤„ç†"></a>äºŒã€å¼‚æ­¥å›è°ƒå¤„ç†</h2><h3 id="1-thenApplyå’ŒthenApplyAsync"><a href="#1-thenApplyå’ŒthenApplyAsync" class="headerlink" title="1. thenApplyå’ŒthenApplyAsync"></a>1. thenApplyå’ŒthenApplyAsync</h3><p>thenApply è¡¨ç¤ºæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œçš„åŠ¨ä½œï¼Œå³å›è°ƒæ–¹æ³•ï¼Œä¼šå°†è¯¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœå³æ–¹æ³•è¿”å›å€¼ä½œä¸ºå…¥å‚ä¼ é€’åˆ°å›è°ƒæ–¹æ³•ä¸­ï¼Œå¸¦æœ‰è¿”å›å€¼ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = cf1.thenApplyAsync((result) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            result += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf1ç»“æœ-&gt;&quot;</span> + cf1.get());</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = cf1.thenApply((result) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            result += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf1ç»“æœ-&gt;&quot;</span> + cf1.get());</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680243133808.png" alt="å›¾ç‰‡"><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680250915645.png" alt="1680250915645"></p>
<p>ä»ä¸Šé¢ä»£ç å’Œæµ‹è¯•ç»“æœæˆ‘ä»¬å‘ç°thenApplyå’ŒthenApplyAsyncåŒºåˆ«åœ¨äºï¼Œä½¿ç”¨thenApplyæ–¹æ³•æ—¶å­ä»»åŠ¡ä¸çˆ¶ä»»åŠ¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè€ŒthenApplyAsyncåœ¨å­ä»»åŠ¡ä¸­æ˜¯å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¸”thenApplyAsyncå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé»˜è®¤çš„ä½¿ç”¨ForkJoinPool.commonPool()çº¿ç¨‹æ± ã€‚</p>
<h3 id="2-thenAcceptå’ŒthenAcceptAsync"><a href="#2-thenAcceptå’ŒthenAcceptAsync" class="headerlink" title="2. thenAcceptå’ŒthenAcceptAsync"></a>2. thenAcceptå’ŒthenAcceptAsync</h3><p>thenAccepè¡¨ç¤ºæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œçš„åŠ¨ä½œï¼Œå³å›è°ƒæ–¹æ³•ï¼Œä¼šå°†è¯¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœå³æ–¹æ³•è¿”å›å€¼ä½œä¸ºå…¥å‚ä¼ é€’åˆ°å›è°ƒæ–¹æ³•ä¸­ï¼Œæ— è¿”å›å€¼ã€‚</p>
<p>æµ‹è¯•ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf2 = cf1.thenAccept((result) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf1ç»“æœ-&gt;&quot;</span> + cf1.get());</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf2 = cf1.thenAcceptAsync((result) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf1ç»“æœ-&gt;&quot;</span> + cf1.get());</span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680250407628.png" alt="1680250407628"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252474421.png" alt="1680252474421"></p>
<p>ä»ä¸Šé¢ä»£ç å’Œæµ‹è¯•ç»“æœæˆ‘ä»¬å‘ç°thenAccepå’ŒthenAccepAsyncåŒºåˆ«åœ¨äºï¼Œä½¿ç”¨thenAccepæ–¹æ³•æ—¶å­ä»»åŠ¡ä¸çˆ¶ä»»åŠ¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè€ŒthenAccepAsyncåœ¨å­ä»»åŠ¡ä¸­å¯èƒ½æ˜¯å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¸”thenAccepAsyncå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé»˜è®¤çš„ä½¿ç”¨ForkJoinPool.commonPool()çº¿ç¨‹æ± ã€‚</p>
<h3 id="3-thenRunå’ŒthenRunAsync"><a href="#3-thenRunå’ŒthenRunAsync" class="headerlink" title="3.thenRunå’ŒthenRunAsync"></a>3.thenRunå’ŒthenRunAsync</h3><p>thenRunè¡¨ç¤ºæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œçš„åŠ¨ä½œï¼Œå³å›è°ƒæ–¹æ³•ï¼Œæ— å…¥å‚ï¼Œæ— è¿”å›å€¼ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + &quot; cf1 do something....&quot;);</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf2 = cf1.thenRun(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + &quot; cf2 do something....&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        //ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span><br><span class="line">        System.out.println(&quot;cf1ç»“æœ-&gt;&quot; + cf1.get());</span><br><span class="line">        //ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span><br><span class="line">        System.out.println(&quot;cf2ç»“æœ-&gt;&quot; + cf2.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + &quot; cf1 do something....&quot;);</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf2 = cf1.thenRunAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + &quot; cf2 do something....&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        //ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span><br><span class="line">        System.out.println(&quot;cf1ç»“æœ-&gt;&quot; + cf1.get());</span><br><span class="line">        //ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span><br><span class="line">        System.out.println(&quot;cf2ç»“æœ-&gt;&quot; + cf2.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252558062.png" alt="1680252558062"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252599639.png" alt="1680252599639"></p>
<p>ä»ä¸Šé¢ä»£ç å’Œæµ‹è¯•ç»“æœæˆ‘ä»¬å‘ç°thenRunå’ŒthenRunAsyncåŒºåˆ«åœ¨äºï¼Œä½¿ç”¨thenRunæ–¹æ³•æ—¶å­ä»»åŠ¡ä¸çˆ¶ä»»åŠ¡ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè€ŒthenRunAsyncåœ¨å­ä»»åŠ¡ä¸­å¯èƒ½æ˜¯å¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¸”thenRunAsyncå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé»˜è®¤çš„ä½¿ç”¨ForkJoinPool.commonPool()çº¿ç¨‹æ± ã€‚</p>
<h3 id="4-whenCompleteå’ŒwhenCompleteAsync"><a href="#4-whenCompleteå’ŒwhenCompleteAsync" class="headerlink" title="4.whenCompleteå’ŒwhenCompleteAsync"></a>4.whenCompleteå’ŒwhenCompleteAsync</h3><p>whenCompleteæ˜¯å½“æŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œçš„å›è°ƒæ–¹æ³•ï¼Œä¼šå°†æ‰§è¡Œç»“æœæˆ–è€…æ‰§è¡ŒæœŸé—´æŠ›å‡ºçš„å¼‚å¸¸ä¼ é€’ç»™å›è°ƒæ–¹æ³•ï¼Œå¦‚æœæ˜¯æ­£å¸¸æ‰§è¡Œåˆ™å¼‚å¸¸ä¸ºnullï¼Œå›è°ƒæ–¹æ³•å¯¹åº”çš„CompletableFutureçš„resultå’Œè¯¥ä»»åŠ¡ä¸€è‡´ï¼Œå¦‚æœè¯¥ä»»åŠ¡æ­£å¸¸æ‰§è¡Œï¼Œåˆ™getæ–¹æ³•è¿”å›æ‰§è¡Œç»“æœï¼Œå¦‚æœæ˜¯æ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™getæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = cf1.whenComplete((result, e) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸Šä¸ªä»»åŠ¡ç»“æœï¼š&quot;</span> + result);</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸Šä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼š&quot;</span> + e);</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//        //ç­‰å¾…ä»»åŠ¡1æ‰§è¡Œå®Œæˆ</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;cf1ç»“æœ-&gt;&quot; + cf1.get());</span></span><br><span class="line"><span class="comment">//        //ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252678256.png" alt="1680252678256"></p>
<p>whenCompleteAsyncå’ŒwhenCompleteåŒºåˆ«ä¹Ÿæ˜¯whenCompleteAsyncå¯èƒ½ä¼šå¦èµ·ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¸”thenRunAsyncå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé»˜è®¤çš„ä½¿ç”¨ForkJoinPool.commonPool()çº¿ç¨‹æ± ã€‚</p>
<h3 id="5-handleå’ŒhandleAsync"><a href="#5-handleå’ŒhandleAsync" class="headerlink" title="5.handleå’ŒhandleAsync"></a>5.handleå’ŒhandleAsync</h3><p>è·ŸwhenCompleteåŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºhandleçš„å›è°ƒæ–¹æ³•æœ‰è¿”å›å€¼ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="comment">// int a = 1/0;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = cf1.handle((result, e) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸Šä¸ªä»»åŠ¡ç»“æœï¼š&quot;</span> + result);</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸Šä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼š&quot;</span> + e);</span><br><span class="line">            <span class="keyword">return</span> result+<span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//ç­‰å¾…ä»»åŠ¡2æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cf2ç»“æœ-&gt;&quot;</span> + cf2.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœ ï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252727458.png" alt="1680252727458"></p>
<h2 id="ä¸‰ã€å¤šä»»åŠ¡ç»„åˆå¤„ç†"><a href="#ä¸‰ã€å¤šä»»åŠ¡ç»„åˆå¤„ç†" class="headerlink" title="ä¸‰ã€å¤šä»»åŠ¡ç»„åˆå¤„ç†"></a>ä¸‰ã€å¤šä»»åŠ¡ç»„åˆå¤„ç†</h2><h3 id="1-thenCombineã€thenAcceptBoth-å’ŒrunAfterBoth"><a href="#1-thenCombineã€thenAcceptBoth-å’ŒrunAfterBoth" class="headerlink" title="1. thenCombineã€thenAcceptBoth å’ŒrunAfterBoth"></a>1. thenCombineã€thenAcceptBoth å’ŒrunAfterBoth</h3><p>è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯å°†ä¸¤ä¸ªCompletableFutureç»„åˆèµ·æ¥å¤„ç†ï¼Œåªæœ‰ä¸¤ä¸ªä»»åŠ¡éƒ½æ­£å¸¸å®Œæˆæ—¶ï¼Œæ‰è¿›è¡Œä¸‹é˜¶æ®µä»»åŠ¡ã€‚</p>
<p>åŒºåˆ«ï¼šthenCombineä¼šå°†ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ‰€æä¾›å‡½æ•°çš„å‚æ•°ï¼Œä¸”è¯¥æ–¹æ³•æœ‰è¿”å›å€¼ï¼›thenAcceptBothåŒæ ·å°†ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä½†æ˜¯æ— è¿”å›å€¼ï¼›runAfterBothæ²¡æœ‰å…¥å‚ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚æ³¨æ„ä¸¤ä¸ªä»»åŠ¡ä¸­åªè¦æœ‰ä¸€ä¸ªæ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™å°†è¯¥å¼‚å¸¸ä¿¡æ¯ä½œä¸ºæŒ‡å®šä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf3 = cf1.thenCombine(cf2, (a, b) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf3 = cf1.thenAcceptBoth(cf2, (a, b) -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">            System.out.println(a + b);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Integer&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf3 = cf1.runAfterBoth(cf2, () -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252820126.png" alt="1680252820126"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252857615.png" alt="1680252857615"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680252909115.png" alt="1680252909115"></p>
<h3 id="2-applyToEitherã€acceptEitherå’ŒrunAfterEither"><a href="#2-applyToEitherã€acceptEitherå’ŒrunAfterEither" class="headerlink" title="2.applyToEitherã€acceptEitherå’ŒrunAfterEither"></a>2.applyToEitherã€acceptEitherå’ŒrunAfterEither</h3><p>è¿™ä¸‰ä¸ªæ–¹æ³•å’Œä¸Šé¢ä¸€æ ·ä¹Ÿæ˜¯å°†ä¸¤ä¸ªCompletableFutureç»„åˆèµ·æ¥å¤„ç†ï¼Œå½“æœ‰ä¸€ä¸ªä»»åŠ¡æ­£å¸¸å®Œæˆæ—¶ï¼Œå°±ä¼šè¿›è¡Œä¸‹é˜¶æ®µä»»åŠ¡ã€‚</p>
<p>åŒºåˆ«ï¼šapplyToEitherä¼šå°†å·²ç»å®Œæˆä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ‰€æä¾›å‡½æ•°çš„å‚æ•°ï¼Œä¸”è¯¥æ–¹æ³•æœ‰è¿”å›å€¼ï¼›acceptEitheråŒæ ·å°†å·²ç»å®Œæˆä»»åŠ¡çš„æ‰§è¡Œç»“æœä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œä½†æ˜¯æ— è¿”å›å€¼ï¼›runAfterEitheræ²¡æœ‰å…¥å‚ï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf3 = cf1.applyToEither(cf2, (result) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°&quot;</span> + result);</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf3 = cf1.acceptEither(cf2, (result) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ¥æ”¶åˆ°&quot;</span> + result);</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cf3 = cf1.runAfterEither(cf2, () -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot; cf3 do something....&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        System.out.println(<span class="string">&quot;cf3ç»“æœ-&gt;&quot;</span> + cf3.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680253073210.png" alt="1680253073210"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680253114302.png" alt="1680253114302"></p>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºcf1ä»»åŠ¡å®Œæˆéœ€è¦2ç§’ï¼Œcf2ä»»åŠ¡å®Œæˆéœ€è¦5ç§’ï¼Œä½¿ç”¨applyToEitherç»„åˆä¸¤ä¸ªä»»åŠ¡æ—¶ï¼Œåªè¦æœ‰å…¶ä¸­ä¸€ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œå°±ä¼šæ‰§è¡Œcf3ä»»åŠ¡ï¼Œæ˜¾ç„¶cf1ä»»åŠ¡å…ˆå®Œæˆäº†å¹¶ä¸”å°†è‡ªå·±ä»»åŠ¡çš„ç»“æœä¼ å€¼ç»™äº†cf3ä»»åŠ¡ï¼Œcf3ä»»åŠ¡ä¸­æ‰“å°äº†æ¥æ”¶åˆ°cf1ä»»åŠ¡å®Œæˆï¼Œæ¥ç€å®Œæˆè‡ªå·±çš„ä»»åŠ¡ï¼Œå¹¶è¿”å›cf3ä»»åŠ¡å®Œæˆï¼›acceptEitherå’ŒrunAfterEitherç±»ä¼¼ï¼ŒacceptEitherä¼šå°†cf1ä»»åŠ¡çš„ç»“æœä½œä¸ºcf3ä»»åŠ¡çš„å…¥å‚ï¼Œä½†cf3ä»»åŠ¡å®Œæˆæ—¶å¹¶æ— è¿”å›å€¼ï¼›runAfterEitherä¸ä¼šå°†cf1ä»»åŠ¡çš„ç»“æœä½œä¸ºcf3ä»»åŠ¡çš„å…¥å‚ï¼Œå®ƒæ˜¯æ²¡æœ‰ä»»åŠ¡å…¥å‚ï¼Œæ‰§è¡Œå®Œè‡ªå·±çš„ä»»åŠ¡åä¹Ÿå¹¶æ— è¿”å›å€¼ã€‚</p>
<h3 id="3-allOf-x2F-anyOf"><a href="#3-allOf-x2F-anyOf" class="headerlink" title="3. allOf &#x2F; anyOf"></a>3. allOf &#x2F; anyOf</h3><p>allOfï¼šCompletableFutureæ˜¯å¤šä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåæ‰ä¼šæ‰§è¡Œï¼Œåªæœ‰æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™è¿”å›çš„CompletableFutureæ‰§è¡Œgetæ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœéƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œåˆ™getè¿”å›nullã€‚</p>
<p>anyOf ï¼šCompletableFutureæ˜¯å¤šä¸ªä»»åŠ¡åªè¦æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œåˆ™è¿”å›çš„CompletableFutureæ‰§è¡Œgetæ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœéƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼Œåˆ™getè¿”å›æ‰§è¡Œå®Œæˆä»»åŠ¡çš„ç»“æœã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf3 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Void&gt; cfAll = CompletableFuture.allOf(cf1, cf2, cf3);</span><br><span class="line">        System.out.println(<span class="string">&quot;cfAllç»“æœ-&gt;&quot;</span> + cfAll.get());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;String&gt; cf1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf1 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf1 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf2 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;String&gt; cf3 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot; cf2 do something....&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cf3 ä»»åŠ¡å®Œæˆ&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        CompletableFuture&lt;Object&gt; cfAll = CompletableFuture.anyOf(cf1, cf2, cf3);</span><br><span class="line">        System.out.println(<span class="string">&quot;cfAllç»“æœ-&gt;&quot;</span> + cfAll.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœï¼š</p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680253292909.png" alt="1680253292909"></p>
<p><img src="/2023/03/31/Java8%E5%BC%82%E6%AD%A5%E5%88%A9%E5%99%A8%EF%BC%9ACompletableFuture%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/1680253328002.png" alt="1680253328002"></p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>base</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLä¼˜åŒ–ä¸‡èƒ½å…¬å¼ï¼š5 å¤§æ­¥éª¤ + 10 ä¸ªæ¡ˆä¾‹</title>
    <url>/2022/08/16/SQL%E4%BC%98%E5%8C%96%E4%B8%87%E8%83%BD%E5%85%AC%E5%BC%8F%EF%BC%9A5%20%E5%A4%A7%E6%AD%A5%E9%AA%A4%20+%2010%20%E4%B8%AA%E6%A1%88%E4%BE%8B-sql-you-hua-wan-neng-gong-shi-5da-bu-zhou-10ge-an-li/</url>
    <content><![CDATA[<h2 id="1ã€å‰è¨€"><a href="#1ã€å‰è¨€" class="headerlink" title="1ã€å‰è¨€"></a>1ã€å‰è¨€</h2><p>åœ¨åº”ç”¨å¼€å‘çš„æ—©æœŸï¼Œæ•°æ®é‡å°‘ï¼Œå¼€å‘äººå‘˜å¼€å‘åŠŸèƒ½æ—¶æ›´é‡è§†åŠŸèƒ½ä¸Šçš„å®ç°ï¼Œéšç€ç”Ÿäº§æ•°æ®çš„å¢é•¿ï¼Œå¾ˆå¤šSQLè¯­å¥å¼€å§‹æš´éœ²å‡ºæ€§èƒ½é—®é¢˜ï¼Œå¯¹ç”Ÿäº§çš„å½±å“ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œæœ‰æ—¶å¯èƒ½è¿™äº›æœ‰é—®é¢˜çš„SQLå°±æ˜¯æ•´ä¸ªç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆã€‚</p>
<h2 id="2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤"><a href="#2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤" class="headerlink" title="2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤"></a>2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤</h2><p><strong>1ã€é€šè¿‡æ…¢æŸ¥æ—¥å¿—ç­‰å®šä½é‚£äº›æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„SQLè¯­å¥</strong></p>
<p><strong>2ã€explain åˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’</strong></p>
<p>éœ€è¦é‡ç‚¹å…³æ³¨typeã€rowsã€filteredã€extraã€‚</p>
<p>typeç”±ä¸Šè‡³ä¸‹ï¼Œæ•ˆç‡è¶Šæ¥è¶Šé«˜</p>
<ul>
<li>ALL å…¨è¡¨æ‰«æ</li>
<li>index ç´¢å¼•å…¨æ‰«æ</li>
<li>range ç´¢å¼•èŒƒå›´æ‰«æï¼Œå¸¸ç”¨è¯­&lt;,&lt;&#x3D;,&gt;&#x3D;,between,inç­‰æ“ä½œ</li>
<li>ref ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æ‰«ææˆ–å”¯ä¸€ç´¢å¼•å‰ç¼€æ‰«æï¼Œè¿”å›å•æ¡è®°å½•ï¼Œå¸¸å‡ºç°åœ¨å…³è”æŸ¥è¯¢ä¸­</li>
<li>eq_ref ç±»ä¼¼refï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨çš„æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä½¿ç”¨ä¸»é”®çš„å…³è”æŸ¥è¯¢</li>
<li>const&#x2F;system å•æ¡è®°å½•ï¼Œç³»ç»Ÿä¼šæŠŠåŒ¹é…è¡Œä¸­çš„å…¶ä»–åˆ—ä½œä¸ºå¸¸æ•°å¤„ç†ï¼Œå¦‚ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢</li>
<li>null MySQLä¸è®¿é—®ä»»ä½•è¡¨æˆ–ç´¢å¼•ï¼Œç›´æ¥è¿”å›ç»“æœ</li>
<li>è™½ç„¶ä¸Šè‡³ä¸‹ï¼Œæ•ˆç‡è¶Šæ¥è¶Šé«˜ï¼Œä½†æ˜¯æ ¹æ®costæ¨¡å‹ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªç´¢å¼•idx1(a, b, c),idx2(a, c)ï¼ŒSQLä¸ºâ€select * from t where a &#x3D; 1 and b in (1, 2) order by câ€;å¦‚æœèµ°idx1ï¼Œé‚£ä¹ˆæ˜¯typeä¸ºrangeï¼Œå¦‚æœèµ°idx2ï¼Œé‚£ä¹ˆtypeæ˜¯refï¼›å½“éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œä½¿ç”¨idx2å¤§çº¦æ˜¯idx1çš„5å€ä»¥ä¸Šæ—¶ï¼Œä¼šç”¨idx1ï¼Œå¦åˆ™ä¼šç”¨idx2</li>
</ul>
<p>Extra</p>
<ul>
<li>Using filesortï¼šMySQLéœ€è¦é¢å¤–çš„ä¸€æ¬¡ä¼ é€’ï¼Œä»¥æ‰¾å‡ºå¦‚ä½•æŒ‰æ’åºé¡ºåºæ£€ç´¢è¡Œã€‚é€šè¿‡æ ¹æ®è”æ¥ç±»å‹æµè§ˆæ‰€æœ‰è¡Œå¹¶ä¸ºæ‰€æœ‰åŒ¹é…WHEREå­å¥çš„è¡Œä¿å­˜æ’åºå…³é”®å­—å’Œè¡Œçš„æŒ‡é’ˆæ¥å®Œæˆæ’åºã€‚ç„¶åå…³é”®å­—è¢«æ’åºï¼Œå¹¶æŒ‰æ’åºé¡ºåºæ£€ç´¢è¡Œã€‚</li>
<li>Using temporaryï¼šä½¿ç”¨äº†ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼Œæ€§èƒ½ç‰¹åˆ«å·®ï¼Œéœ€è¦é‡ç‚¹ä¼˜åŒ–</li>
<li>Using indexï¼šè¡¨ç¤ºç›¸åº”çš„ select æ“ä½œä¸­ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ˆCoveing Indexï¼‰,é¿å…è®¿é—®äº†è¡¨çš„æ•°æ®è¡Œï¼Œæ•ˆç‡ä¸é”™ï¼å¦‚æœåŒæ—¶å‡ºç° using whereï¼Œæ„å‘³ç€æ— æ³•ç›´æ¥é€šè¿‡ç´¢å¼•æŸ¥æ‰¾æ¥æŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</li>
<li>Using index conditionï¼šMySQL5.6ä¹‹åæ–°å¢çš„ICPï¼Œusing index condtionå°±æ˜¯ä½¿ç”¨äº†ICPï¼ˆç´¢å¼•ä¸‹æ¨ï¼‰ï¼Œåœ¨å­˜å‚¨å¼•æ“å±‚è¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å±‚è¿‡æ»¤ï¼Œåˆ©ç”¨ç´¢å¼•ç°æœ‰çš„æ•°æ®å‡å°‘å›è¡¨çš„æ•°æ®ã€‚</li>
</ul>
<p><strong>3ã€show profile åˆ†æ</strong></p>
<p>äº†è§£SQLæ‰§è¡Œçš„çº¿ç¨‹çš„çŠ¶æ€åŠæ¶ˆè€—çš„æ—¶é—´ã€‚</p>
<p>é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¼€å¯è¯­å¥â€œset profiling &#x3D; 1;â€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROFILES ;<span class="keyword">SHOW</span> PROFILE <span class="keyword">FOR</span> QUERY  #&#123;id&#125;;</span><br></pre></td></tr></table></figure>



<p><strong>4ã€trace</strong></p>
<p>traceåˆ†æä¼˜åŒ–å™¨å¦‚ä½•é€‰æ‹©æ‰§è¡Œè®¡åˆ’ï¼Œé€šè¿‡traceæ–‡ä»¶èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ä¸ºä»€ä¹ˆä¼˜æƒ åˆ¸é€‰æ‹©Aæ‰§è¡Œè®¡åˆ’è€Œä¸é€‰æ‹©Bæ‰§è¡Œè®¡åˆ’ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span>&quot;enabled=on&quot;;<span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace;</span><br></pre></td></tr></table></figure>



<p><strong>5ã€ç¡®å®šé—®é¢˜å¹¶é‡‡ç”¨ç›¸åº”çš„æªæ–½</strong></p>
<ul>
<li>ä¼˜åŒ–ç´¢å¼•</li>
<li>ä¼˜åŒ–SQLè¯­å¥ï¼šä¿®æ”¹SQLã€IN æŸ¥è¯¢åˆ†æ®µã€æ—¶é—´æŸ¥è¯¢åˆ†æ®µã€åŸºäºä¸Šä¸€æ¬¡æ•°æ®è¿‡æ»¤</li>
<li>æ”¹ç”¨å…¶ä»–å®ç°æ–¹å¼ï¼šESã€æ•°ä»“ç­‰</li>
<li>æ•°æ®ç¢ç‰‡å¤„ç†</li>
</ul>
<h2 id="3ã€åœºæ™¯åˆ†æ"><a href="#3ã€åœºæ™¯åˆ†æ" class="headerlink" title="3ã€åœºæ™¯åˆ†æ"></a>3ã€åœºæ™¯åˆ†æ</h2><p><strong>æ¡ˆä¾‹1ã€æœ€å·¦åŒ¹é…</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_orderno` (`shop_id`,`order_no`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> orderno<span class="operator">=</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>æŸ¥è¯¢åŒ¹é…ä»å·¦å¾€å³åŒ¹é…ï¼Œè¦ä½¿ç”¨order_noèµ°ç´¢å¼•ï¼Œå¿…é¡»æŸ¥è¯¢æ¡ä»¶æºå¸¦shop_idæˆ–è€…ç´¢å¼•(shop_id,order_no)è°ƒæ¢å‰åé¡ºåº</p>
<p><strong>æ¡ˆä¾‹2ã€éšå¼è½¬æ¢</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_mobile` (`mobile`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _user <span class="keyword">where</span> mobile<span class="operator">=</span><span class="number">12345678901</span></span><br></pre></td></tr></table></figure>



<p>éšå¼è½¬æ¢ç›¸å½“äºåœ¨ç´¢å¼•ä¸Šåšè¿ç®—ï¼Œä¼šè®©ç´¢å¼•å¤±æ•ˆã€‚mobileæ˜¯å­—ç¬¦ç±»å‹ï¼Œä½¿ç”¨äº†æ•°å­—ï¼Œåº”è¯¥ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¦åˆ™MySQLä¼šç”¨åˆ°éšå¼æ›¿æ¢ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</p>
<p><strong>æ¡ˆä¾‹3ã€å¤§åˆ†é¡µ</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_a_b_c` (`a`, `b`, `c`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="operator">=</span> <span class="number">2</span> <span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span> limit <span class="number">10000</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºå¤§åˆ†é¡µçš„åœºæ™¯ï¼Œå¯ä»¥ä¼˜å…ˆè®©äº§å“ä¼˜åŒ–éœ€æ±‚ï¼Œå¦‚æœæ²¡æœ‰ä¼˜åŒ–çš„ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§ä¼˜åŒ–æ–¹å¼ï¼Œ</p>
<p>ä¸€ç§æ˜¯æŠŠä¸Šä¸€æ¬¡çš„æœ€åä¸€æ¡æ•°æ®ï¼Œä¹Ÿå³ä¸Šé¢çš„cä¼ è¿‡æ¥ï¼Œç„¶ååšâ€œc &lt; xxxâ€å¤„ç†ï¼Œä½†æ˜¯è¿™ç§ä¸€èˆ¬éœ€è¦æ”¹æ¥å£åè®®ï¼Œå¹¶ä¸ä¸€å®šå¯è¡Œã€‚</p>
<p>å¦ä¸€ç§æ˜¯é‡‡ç”¨å»¶è¿Ÿå…³è”çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå‡å°‘SQLå›è¡¨ï¼Œä½†æ˜¯è¦è®°å¾—ç´¢å¼•éœ€è¦å®Œå…¨è¦†ç›–æ‰æœ‰æ•ˆæœï¼ŒSQLæ”¹åŠ¨å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select t1.* from _t t1, (select id from _t where a = 1 and b = 2 order by c desc limit 10000, 10) t2 where t1.id = t2.id;</span><br></pre></td></tr></table></figure>



<p><strong>æ¡ˆä¾‹4ã€in + order by</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_status_created` (`shop_id`, `order_status`, `created_at`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> order_status <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_at <span class="keyword">desc</span> limit <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>inæŸ¥è¯¢åœ¨MySQLåº•å±‚æ˜¯é€šè¿‡n*mçš„æ–¹å¼å»æœç´¢ï¼Œç±»ä¼¼unionï¼Œä½†æ˜¯æ•ˆç‡æ¯”unioné«˜ã€‚</p>
<p>inæŸ¥è¯¢åœ¨è¿›è¡Œcostä»£ä»·è®¡ç®—æ—¶ï¼ˆä»£ä»· &#x3D; å…ƒç»„æ•° * IOå¹³å‡å€¼ï¼‰ï¼Œæ˜¯é€šè¿‡å°†inåŒ…å«çš„æ•°å€¼ï¼Œä¸€æ¡æ¡å»æŸ¥è¯¢è·å–å…ƒç»„æ•°çš„ï¼Œå› æ­¤è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ä¼šæ¯”è¾ƒçš„æ…¢ï¼Œæ‰€ä»¥MySQLè®¾ç½®äº†ä¸ªä¸´ç•Œå€¼(eq_range_index_dive_limit)ï¼Œ5.6ä¹‹åè¶…è¿‡è¿™ä¸ªä¸´ç•Œå€¼åè¯¥åˆ—çš„costå°±ä¸å‚ä¸è®¡ç®—äº†ã€‚å› æ­¤ä¼šå¯¼è‡´æ‰§è¡Œè®¡åˆ’é€‰æ‹©ä¸å‡†ç¡®ã€‚é»˜è®¤æ˜¯200ï¼Œå³inæ¡ä»¶è¶…è¿‡äº†200ä¸ªæ•°æ®ï¼Œä¼šå¯¼è‡´inçš„ä»£ä»·è®¡ç®—å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´Mysqlé€‰æ‹©çš„ç´¢å¼•ä¸å‡†ç¡®ã€‚</p>
<p>å¤„ç†æ–¹å¼ï¼Œå¯ä»¥(order_status, created_at)äº’æ¢å‰åé¡ºåºï¼Œå¹¶ä¸”è°ƒæ•´SQLä¸ºå»¶è¿Ÿå…³è”ã€‚</p>
<p><strong>æ¡ˆä¾‹5ã€èŒƒå›´æŸ¥è¯¢é˜»æ–­ï¼Œåç»­å­—æ®µä¸èƒ½èµ°ç´¢å¼•</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_created_status` (`shop_id`, `created_at`, `order_status`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> created_at <span class="operator">&gt;</span> <span class="string">&#x27;2021-01-01 00:00:00&#x27;</span> <span class="keyword">and</span> order_status <span class="operator">=</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>èŒƒå›´æŸ¥è¯¢è¿˜æœ‰â€œINã€betweenâ€</p>
<p><strong>æ¡ˆä¾‹6ã€ä¸ç­‰äºã€ä¸åŒ…å«ä¸èƒ½ç”¨åˆ°ç´¢å¼•çš„å¿«é€Ÿæœç´¢ã€‚ï¼ˆå¯ä»¥ç”¨åˆ°ICPï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> order_status <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>)<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> order_status <span class="operator">!=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>åœ¨ç´¢å¼•ä¸Šï¼Œé¿å…ä½¿ç”¨NOTã€!&#x3D;ã€&lt;&gt;ã€!&lt;ã€!&gt;ã€NOT EXISTSã€NOT INã€NOT LIKEç­‰</p>
<p><strong>æ¡ˆä¾‹7ã€ä¼˜åŒ–å™¨é€‰æ‹©ä¸ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µ</strong></p>
<p>å¦‚æœè¦æ±‚è®¿é—®çš„æ•°æ®é‡å¾ˆå°ï¼Œåˆ™ä¼˜åŒ–å™¨è¿˜æ˜¯ä¼šé€‰æ‹©è¾…åŠ©ç´¢å¼•ï¼Œä½†æ˜¯å½“è®¿é—®çš„æ•°æ®å æ•´ä¸ªè¡¨ä¸­æ•°æ®çš„è›®å¤§ä¸€éƒ¨åˆ†æ—¶ï¼ˆä¸€èˆ¬æ˜¯20%å·¦å³ï¼‰ï¼Œä¼˜åŒ–å™¨ä¼šé€‰æ‹©é€šè¿‡èšé›†ç´¢å¼•æ¥æŸ¥æ‰¾æ•°æ®ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span>  order_status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>æŸ¥è¯¢å‡ºæ‰€æœ‰æœªæ”¯ä»˜çš„è®¢å•ï¼Œä¸€èˆ¬è¿™ç§è®¢å•æ˜¯å¾ˆå°‘çš„ï¼Œå³ä½¿å»ºäº†ç´¢å¼•ï¼Œä¹Ÿæ²¡æ³•ä½¿ç”¨ç´¢å¼•ã€‚</p>
<p><strong>æ¡ˆä¾‹8ã€å¤æ‚æŸ¥è¯¢</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(amt) <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="string">&#x27;2020-01-01&#x27;</span>;<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="string">&#x27;2020-01-01&#x27;</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>å¦‚æœæ˜¯ç»Ÿè®¡æŸäº›æ•°æ®ï¼Œå¯èƒ½æ”¹ç”¨æ•°ä»“è¿›è¡Œè§£å†³ï¼›</p>
<p>å¦‚æœæ˜¯ä¸šåŠ¡ä¸Šå°±æœ‰é‚£ä¹ˆå¤æ‚çš„æŸ¥è¯¢ï¼Œå¯èƒ½å°±ä¸å»ºè®®ç»§ç»­èµ°SQLäº†ï¼Œè€Œæ˜¯é‡‡ç”¨å…¶ä»–çš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œæ¯”å¦‚ä½¿ç”¨ESç­‰è¿›è¡Œè§£å†³ã€‚</p>
<p><strong>æ¡ˆä¾‹9ã€ascå’Œdescæ··ç”¨</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> b <span class="keyword">desc</span>, c <span class="keyword">asc</span></span><br></pre></td></tr></table></figure>



<p>desc å’Œascæ··ç”¨æ—¶ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ</p>
<p><strong>æ¡ˆä¾‹10ã€å¤§æ•°æ®</strong></p>
<p>å¯¹äºæ¨é€ä¸šåŠ¡çš„æ•°æ®å­˜å‚¨ï¼Œå¯èƒ½æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œå¦‚æœåœ¨æ–¹æ¡ˆçš„é€‰æ‹©ä¸Šï¼Œæœ€ç»ˆé€‰æ‹©å­˜å‚¨åœ¨MySQLä¸Šï¼Œå¹¶ä¸”åš7å¤©ç­‰æœ‰æ•ˆæœŸçš„ä¿å­˜ã€‚</p>
<p>é‚£ä¹ˆéœ€è¦æ³¨æ„ï¼Œé¢‘ç¹çš„æ¸…ç†æ•°æ®ï¼Œä¼šç…§æˆæ•°æ®ç¢ç‰‡ï¼Œéœ€è¦è”ç³»DBAè¿›è¡Œæ•°æ®ç¢ç‰‡å¤„ç†</p>
<p>æ¥æºï¼šcnblogs.com&#x2F;powercto&#x2F;p&#x2F;14410128.html</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>hashmapåº•å±‚æ•°æ®ç»“æ„</title>
    <url>/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<h2 id="ä¸€ã€HashMapç®€ä»‹"><a href="#ä¸€ã€HashMapç®€ä»‹" class="headerlink" title="ä¸€ã€HashMapç®€ä»‹"></a>ä¸€ã€HashMapç®€ä»‹</h2><p>1ã€å®ƒæ˜¯ä¸€ä¸ªé€šè¿‡Mapæ¥å£å®ç°çš„ä¸€ä¸ªåŒåˆ—é›†åˆï¼Œä¸»è¦æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹éƒ½æœ‰ä¸€ä¸ªé”®å’Œä¸€ä¸ªå€¼ã€‚</p>
<p>2ã€æ¯ä¸€ä¸ªé”®éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå€¼å¯ä»¥é‡å¤ï¼Œåé¢æ·»åŠ çš„é”®ä¼šè¦†ç›–å‰é¢ç›¸åŒçš„é”®ã€‚</p>
<p>3ã€HashMapå­˜å‚¨ç»“æ„é‡‡ç”¨çš„æ˜¯å“ˆå¸Œè¡¨çš„ç»“æ„ï¼Œå…ƒç´ çš„å­˜å‚¨é¡ºåºä¸èƒ½ä¿å­˜ä¸€è‡´ï¼Œå¦‚æœé”®æ˜¯è‡ªå®šä¹‰çš„å¯¹è±¡çš„è¯ï¼Œéœ€è¦é‡å†™hashcodeæ–¹æ³•ä¸equalsæ–¹æ³•ï¼Œæ‰èƒ½ä¿è¯é”®çš„å”¯ä¸€ã€‚</p>
<h2 id="äºŒã€HashMapå­˜å‚¨çš„åŸç†"><a href="#äºŒã€HashMapå­˜å‚¨çš„åŸç†" class="headerlink" title="äºŒã€HashMapå­˜å‚¨çš„åŸç†"></a>äºŒã€HashMapå­˜å‚¨çš„åŸç†</h2><h3 id="1ã€ç‰ˆæœ¬åŒºåˆ«"><a href="#1ã€ç‰ˆæœ¬åŒºåˆ«" class="headerlink" title="1ã€ç‰ˆæœ¬åŒºåˆ«"></a>1ã€ç‰ˆæœ¬åŒºåˆ«</h3><p><strong>jdk8ä»¥å‰ï¼š</strong></p>
<p>åœ¨jdk1.7ä¸­ï¼Œé¦–å…ˆæ˜¯æŠŠå…ƒç´ æ”¾åœ¨ä¸€ä¸ªä¸ªæ•°ç»„é‡Œé¢ï¼Œåæ¥å­˜æ”¾çš„æ•°æ®å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œäºæ˜¯å°±å‡ºç°äº†é“¾è¡¨ï¼Œå¯¹äºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½å¯ä»¥æœ‰ä¸€æ¡é“¾è¡¨æ¥å­˜å‚¨å…ƒç´ ã€‚è¿™å°±æ˜¯æœ‰åçš„â€œæ‹‰é“¾å¼â€å­˜å‚¨æ–¹æ³•ã€‚<br><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-840e869c0ea34c8cad5655d3d316d8e4.png" alt="image.png"></p>
<p><strong>jdk8ä»¥åï¼š</strong></p>
<p>ç”±äºå­˜å‚¨çš„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œé“¾è¡¨ä¹Ÿè¶Šæ¥è¶Šé•¿ï¼Œåœ¨æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ æ—¶å€™æ•ˆç‡ä¸ä»…æ²¡æœ‰æé«˜ï¼ˆé“¾è¡¨ä¸é€‚åˆæŸ¥æ‰¾ï¼Œé€‚åˆå¢åˆ ï¼‰ï¼Œåå€’æ˜¯ä¸‹é™äº†ä¸å°‘ï¼Œäºæ˜¯å°±å¯¹è¿™æ¡é“¾è¡¨è¿›è¡Œäº†ä¸€ä¸ªæ”¹è¿›ã€‚å¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿå°±æ˜¯æŠŠè¿™æ¡é“¾è¡¨å˜æˆä¸€ä¸ªé€‚åˆæŸ¥æ‰¾çš„æ ‘å½¢ç»“æ„ï¼Œæ²¡é”™å°±æ˜¯çº¢é»‘æ ‘ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºéœ€è¦ä¸ºäº†é€€åŒ–æˆé“¾è¡¨å’Œéå†åšå‡†å¤‡ï¼Œè¿™ä¸ªçº¢é»‘æ ‘å¹¶ä¸æ˜¯çº¯çº¢é»‘æ ‘ï¼Œè€Œæ˜¯çº¢é»‘æ ‘å’ŒåŒå‘é“¾è¡¨çš„å åŠ ç»“æ„ã€‚</p>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-ab9163a96dc44373910d0ef343bc8db6.png" alt="image.png"></p>
<h3 id="2ã€å­˜å‚¨çš„æµç¨‹"><a href="#2ã€å­˜å‚¨çš„æµç¨‹" class="headerlink" title="2ã€å­˜å‚¨çš„æµç¨‹"></a>2ã€å­˜å‚¨çš„æµç¨‹</h3><p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-e3c1b70070d14acf9a3d26733f1a2de3.png" alt="image.png"></p>
<h3 id><a href="#" class="headerlink" title></a></h3><h2 id="ä¸‰ã€HashMapæ•°æ®ç»“æ„"><a href="#ä¸‰ã€HashMapæ•°æ®ç»“æ„" class="headerlink" title="ä¸‰ã€HashMapæ•°æ®ç»“æ„"></a>ä¸‰ã€HashMapæ•°æ®ç»“æ„</h2><h3 id="1ã€hashè¡¨æ•°æ®ç»“æ„"><a href="#1ã€hashè¡¨æ•°æ®ç»“æ„" class="headerlink" title="1ã€hashè¡¨æ•°æ®ç»“æ„"></a>1ã€hashè¡¨æ•°æ®ç»“æ„</h3><h4 id="1ï¼‰ç®€ä»‹"><a href="#1ï¼‰ç®€ä»‹" class="headerlink" title="1ï¼‰ç®€ä»‹"></a>1ï¼‰ç®€ä»‹</h4><p>å“ˆå¸Œè¡¨æ˜¯ä¸€ä¸ªé€šè¿‡æ•°ç»„å’Œé“¾è¡¨ç›¸ç»“åˆè€Œæˆçš„æ•°æ®ç»“æ„ï¼Œæ—¢é¿å…äº†æ•°ç»„çš„å¢åˆ æ…¢ï¼Œä¹Ÿé¿å…äº†é“¾è¡¨æŸ¥è¯¢æŸ¥è¯¢æ…¢çš„çš„ç¼ºé™·ã€‚</p>
<p><strong>æ•°ç»„</strong> ï¼š</p>
<p>æ•°ç»„çš„å­˜å‚¨åŒºæ˜¯è¿ç»­çš„ï¼Œå ç”¨å†…å­˜ä¸¥é‡ï¼Œæ•…ç©ºé—´å¤æ‚åº¦å¾ˆå¤§ã€‚ä½†æ•°ç»„çš„äºŒåˆ†æŸ¥æ‰¾æ—¶é—´åº¦å°ï¼›æ•°ç»„çš„ç‰¹ç‚¹ï¼šå¯»å€å®¹æ˜“ï¼Œæ’å…¥å’Œåˆ é™¤å›°éš¾ã€‚</p>
<p><strong>é“¾è¡¨</strong> ï¼š</p>
<p>é“¾è¡¨çš„å‚¨å­˜åŒºç¦»æ•£ï¼Œå ç”¨å†…å­˜æ¯”è¾ƒå®½æ¾ï¼Œæ•…ç©ºé—´å¤æ‚åº¦å¾ˆå°ï¼Œä½†æ—¶é—´å¤æ‚åº¦å¤§ï¼›</p>
<p>é“¾è¡¨çš„ç‰¹ç‚¹ï¼šå¯»å€å›°éš¾ï¼Œæ’å…¥å’Œåˆ é™¤å®¹æ˜“ã€‚</p>
<h4 id="2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†"><a href="#2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†" class="headerlink" title="2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†"></a>2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†</h4><ol>
<li><p>å½“HashMapé›†åˆå­˜å‚¨å…ƒç´ çš„æ—¶å€™,å°±ä¼šè°ƒç”¨è¯¥å…ƒç´ çš„hashCode0æ–¹æ³•è®¡ç®—å“ˆå¸Œå€¼</p>
</li>
<li><p>åˆ¤æ–­è¯¥å“ˆå¸Œå€¼å¯¹åº”çš„ä½ç½®ä¸Šæ˜¯å¦æœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ </p>
</li>
<li><p>å¦‚æœè¯¥ä½ç½®ä¸Šæ²¡æœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ ,å°±ç›´æ¥å­˜å‚¨</p>
</li>
<li><p>å¦‚æœè¯¥ä½ç½®ä¸Šæœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ ,å°±è¯´æ˜äº§ç”Ÿäº†å“ˆå¸Œå†²çª</p>
</li>
<li><p>äº§ç”Ÿäº†å“ˆå¸Œå†²å®,å°±å¾—è°ƒç”¨è¯¥å…ƒç´ çš„equalsæ–¹æ³•,ä¸è¯¥å“ˆå¸Œå€¼ä½ç½®ä¸Šçš„æ‰€æœ‰å…ƒç´ è¿›è¡Œ-æ¯”è¾ƒ</p>
</li>
<li><p>å¦‚æœæ¯”è¾ƒå®Œå,æ²¡æœ‰ä¸€ä¸ªå…ƒç´ ä¸è¯¥å…ƒç´ ç›¸åŒ,å°±ç›´æ¥å­˜å‚¨</p>
</li>
<li><p>å¦‚æœæ¯”è¾ƒå®Œå,åªè¦æœ‰ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸è¯¥å…ƒç´ ç›¸åŒ,å°±ä¸å­˜å‚¨</p>
</li>
</ol>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-5e50cc4ebbdf4cd59e62ef6f41491a37.png" alt="image.png"></p>
<h3 id="3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„"><a href="#3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„" class="headerlink" title="3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„"></a>3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„</h3><h4 id="1ï¼‰ç®€ä»‹-1"><a href="#1ï¼‰ç®€ä»‹-1" class="headerlink" title="1ï¼‰ç®€ä»‹"></a>1ï¼‰ç®€ä»‹</h4><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ç”¨åˆ°çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯åœ¨1972å¹´ç”±Rudolf Bayerå‘æ˜çš„ï¼Œå½“æ—¶è¢«ç§°ä¹‹ä¸ºå¹³è¡¡äºŒå‰Bæ ‘ï¼Œåæ¥ï¼Œåœ¨1978å¹´è¢«Leoj.Guibaså’ŒRobert Sedgewickä¿®æ”¹ä¸ºå¦‚ä»Šçš„â€çº¢é»‘æ ‘â€ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å­˜å‚¨ä½è¡¨ç¤ºèŠ‚ç‚¹çš„é¢œè‰²ï¼Œå¯ä»¥æ˜¯çº¢æˆ–è€…é»‘ï¼›</p>
<p>çº¢é»‘æ ‘ä¸æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå®ƒçš„å¹³è¡¡æ˜¯é€šè¿‡â€çº¢é»‘æ ‘çš„ç‰¹æ€§â€è¿›è¡Œå®ç°çš„ï¼›</p>
<h4 id="2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§"><a href="#2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§" class="headerlink" title="2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§"></a>2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§</h4><ol>
<li><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ–æ˜¯çº¢è‰²çš„ï¼Œæˆ–è€…æ˜¯é»‘è‰²çš„ã€‚</p>
</li>
<li><p>æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²</p>
</li>
<li><p>æ¯ä¸ªå¶èŠ‚ç‚¹(Nil)æ˜¯é»‘è‰²çš„ï¼›ï¼ˆå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹æˆ–è€…çˆ¶èŠ‚ç‚¹ï¼Œåˆ™è¯¥èŠ‚ç‚¹ç›¸åº”çš„æŒ‡é’ˆå±æ€§å€¼ä¸ºNilï¼Œè¿™äº›Nilè§†ä¸ºå¶èŠ‚ç‚¹ï¼‰</p>
</li>
<li><p>å¦‚æœæŸä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²(ä¸èƒ½å‡ºç°ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿çš„æƒ…å†µ)</p>
</li>
<li><p>å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»è¯¥èŠ‚ç‚¹åˆ°å…¶æ‰€æœ‰åä»£å¶èŠ‚ç‚¹çš„ç®€å•è·¯å¾„ä¸Šï¼Œå‡åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ï¼›</p>
</li>
<li><p>åœ¨è¿›è¡Œå…ƒç´ æ’å…¥çš„æ—¶å€™ï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼› æ¯ä¸€æ¬¡æ’å…¥å®Œæ¯•ä»¥åï¼Œä½¿ç”¨é»‘è‰²è§„åˆ™è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸æ»¡è¶³çº¢é»‘è§„åˆ™ï¼Œå°±éœ€è¦é€šè¿‡å˜è‰²ï¼Œå·¦æ—‹å’Œå³æ—‹æ¥è°ƒæ•´æ ‘ï¼Œä½¿å…¶æ»¡è¶³çº¢é»‘è§„åˆ™ï¼›</p>
</li>
</ol>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-4bf5d88b307548c7bb2a52a715858cad.png" alt="image.png"></p>
<h4 id="3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«"><a href="#3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«" class="headerlink" title="3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«"></a>3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«</h4><p> 1ã€çº¢é»‘æ ‘æ”¾å¼ƒäº†è¿½æ±‚å®Œå…¨å¹³è¡¡ï¼Œè¿½æ±‚å¤§è‡´å¹³è¡¡ï¼Œåœ¨ä¸å¹³è¡¡äºŒå‰æ ‘çš„æ—¶é—´å¤æ‚åº¦ç›¸å·®ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ¯æ¬¡æ’å…¥æœ€å¤šåªéœ€è¦ä¸‰æ¬¡æ—‹è½¬å°±èƒ½è¾¾åˆ°å¹³è¡¡ï¼Œå®ç°èµ·æ¥ä¹Ÿæ›´ä¸ºç®€å•ã€‚</p>
<p> 2ã€å¹³è¡¡äºŒå‰æ ‘è¿½æ±‚ç»å¯¹å¹³è¡¡ï¼Œæ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯æ¬¡æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åéœ€è¦æ—‹è½¬çš„æ¬¡æ•°ä¸èƒ½é¢„çŸ¥ã€‚</p>
<h2 id="å››ã€ç®—æ³•"><a href="#å››ã€ç®—æ³•" class="headerlink" title="å››ã€ç®—æ³•"></a>å››ã€ç®—æ³•</h2><h4 id="1ã€è´Ÿè½½å› å­ï¼ˆload-factorï¼‰"><a href="#1ã€è´Ÿè½½å› å­ï¼ˆload-factorï¼‰" class="headerlink" title="1ã€è´Ÿè½½å› å­ï¼ˆload factorï¼‰"></a>1ã€è´Ÿè½½å› å­ï¼ˆload factorï¼‰</h4><p>   å¦‚æœä¸€ä¸ªhashè¡¨ä¸­æ¡¶çš„ä¸ªæ•°ä¸º size , å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°ä¸ºused .åˆ™æˆ‘ä»¬ç§° used &#x2F; size ä¸ºè´Ÿè½½å› å­loadFactor . ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œå½“loadFactor&lt;&#x3D;1æ—¶ï¼Œhashè¡¨æŸ¥æ‰¾çš„æœŸæœ›å¤æ‚åº¦ä¸ºO(1). å› æ­¤ã€‚æ¯æ¬¡å¾€hashè¡¨ä¸­åŠ å…¥å…ƒç´ æ—¶ã€‚æˆ‘ä»¬å¿…é¡»ä¿è¯æ˜¯åœ¨loadFactor &lt;1çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥åŠ å…¥ã€‚</p>
<h4 id="2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹"><a href="#2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹" class="headerlink" title="2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹"></a>2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹</h4><p>HashMapçš„åˆå§‹å®¹é‡ä¸º16ï¼ŒHashtableåˆå§‹å®¹é‡ä¸º11ï¼Œä¸¤è€…çš„è´Ÿè½½å¡«å……å› å­é»˜è®¤éƒ½æ˜¯0.75ã€‚</p>
<p>å¦‚æœsizeå¤§å°åˆ°è¾¾é˜ˆå€¼ï¼Œåˆ™æ‰©å®¹ä¸€å€ï¼Œä¾æ—§ä¸º2çš„æ•´æ¬¡å¹‚</p>
<p>æœ€å¤§å®¹é‡ï¼šå› ä¸ºè®¡ç®—é‡‡ç”¨intå€¼ï¼Œintå€¼æœ€å¤§ä¸º2çš„31æ¬¡-1ï¼Œè¾¾ä¸åˆ°2çš„31æ¬¡ï¼Œæ‰€ä»¥ä¸º2çš„30æ¬¡ã€‚</p>
<h4 id="3ã€æ‰©å®¹çš„å®ç°"><a href="#3ã€æ‰©å®¹çš„å®ç°" class="headerlink" title="3ã€æ‰©å®¹çš„å®ç°"></a>3ã€æ‰©å®¹çš„å®ç°</h4><p>å½“æˆ‘ä»¬åŠ å…¥ä¸€ä¸ªæ–°å…ƒç´ æ—¶ã€‚ä¸€æ—¦loadFactorå¤§äºç­‰äº1äº†ï¼Œæˆ‘ä»¬ä¸èƒ½å•çº¯çš„å¾€hashè¡¨é‡Œè¾¹åŠ å…¥å…ƒç´ ã€‚</p>
<p>ç”±äºåŠ å…¥å®Œä¹‹åï¼ŒloadFactorå°†å¤§äº1ï¼Œè¿™æ ·ä¹Ÿå°±ä¸èƒ½ä¿è¯æŸ¥æ‰¾çš„æœŸæœ›æ—¶é—´å¤æ‚åº¦ä¸ºå¸¸æ•°çº§äº†ã€‚è¿™æ—¶ã€‚æˆ‘ä»¬åº”è¯¥å¯¹æ¡¶æ•°ç»„è¿›è¡Œä¸€æ¬¡å®¹é‡æ‰©å¼ ï¼Œè®©sizeå¢å¤§ ã€‚</p>
<p>è¿™æ ·å°±èƒ½ä¿è¯åŠ å…¥å…ƒç´ å used &#x2F; size ä»ç„¶å°äºç­‰äº1 ï¼Œ ä»è€Œä¿è¯æŸ¥æ‰¾çš„æœŸæœ›æ—¶é—´å¤æ‚åº¦ä¸ºO(1).å¯æ˜¯ã€‚æ€æ ·è¿›è¡Œå®¹é‡æ‰©å¼ å‘¢ï¼Ÿ C++ä¸­çš„vectorçš„å®¹é‡æ‰©å¼ æ˜¯ä¸€ç§å¥½æ–¹æ³•ã€‚</p>
<p>äºæ˜¯æœ‰äº†ä¾‹å¦‚ä»¥ä¸‹æ€è·¯ ï¼šã€€Hashè¡¨ä¸­æ¯æ¬¡å‘ç°loadFactor&#x3D;&#x3D;1æ—¶ï¼Œå°±å¼€è¾Ÿä¸€ä¸ªåŸæ¥æ¡¶æ•°ç»„çš„ä¸¤å€ç©ºé—´ï¼ˆç§°ä¸ºæ–°æ¡¶æ•°ç»„ï¼‰ï¼Œç„¶åæŠŠåŸæ¥çš„æ¡¶æ•°ç»„ä¸­å…ƒç´ æ‰€æœ‰è½¬ç§»è¿‡æ¥åˆ°æ–°çš„æ¡¶æ•°ç»„ä¸­ã€‚æ³¨æ„è¿™é‡Œè½¬ç§»æ˜¯é¡»è¦å…ƒç´ ä¸€ä¸ªä¸ªåˆä¸€æ¬¡å“ˆå¸Œåˆ°æ–°æ¡¶ä¸­çš„ã€‚åŸå› åé¢ä¼šè®²åˆ°ã€‚</p>
<p>   è¿™æ ·çš„æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œå®¹é‡æ‰©å¼ æ˜¯ä¸€æ¬¡å®Œæ¯•çš„ï¼ŒæœŸé—´è¦èŠ±éå¸¸é•¿æ—¶é—´ä¸€æ¬¡è½¬ç§»hashè¡¨ä¸­çš„å…¨éƒ¨å…ƒç´ ã€‚è¿™æ ·åœ¨hashè¡¨ä¸­loadFactor&#x3D;&#x3D;1æ—¶ã€‚å¾€é‡Œè¾¹æ’å…¥ä¸€ä¸ªå…ƒç´ å°†ä¼šç­‰å€™éå¸¸é•¿çš„æ—¶é—´ã€‚</p>
<h4 id="4ã€Redisä¸­çš„å®ç°"><a href="#4ã€Redisä¸­çš„å®ç°" class="headerlink" title="4ã€Redisä¸­çš„å®ç°"></a>4ã€Redisä¸­çš„å®ç°</h4><ol>
<li><p>Redis æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ key-value ç¼“å­˜ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåŸºäºé”®å€¼å¯¹çš„æ•°æ®åº“ã€‚</p>
</li>
<li><p>Redisä¹Ÿæ˜¯é‡‡å–<strong>é“¾åœ°å€æ³•</strong>è§£å†³å“ˆå¸Œå†²çªã€‚</p>
</li>
<li><p>æˆ‘ä»¬çŸ¥é“ï¼ŒJavaå‘ç”Ÿæ‰©å®¹çš„ç¬é—´ï¼Œæ˜¯éœ€è¦å…ˆå°†åŸå“ˆå¸Œè¡¨ä¸­æ‰€æœ‰é”®å€¼å¯¹éƒ½è½¬ç§»åˆ°æ–°çš„å“ˆå¸Œè¡¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œæ­¤æ—¶æ’å…¥è¯¥å…ƒç´ çš„æ€§èƒ½ç›¸å½“ä½ã€‚</p>
</li>
<li><p>è€ŒRediså¯¹äºè¿™ä¸€éƒ¨åˆ†ï¼Œé‡‡å–çš„æ˜¯<strong>åˆ†æ‘Šè½¬ç§»</strong>çš„æ–¹å¼ã€‚å³å½“æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ xè§¦å‘äº†æ‰©å®¹æ—¶ï¼Œå…ˆè½¬ç§»ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„æ¡¶åˆ°æ–°çš„å“ˆå¸Œè¡¨ï¼Œç„¶åå°†è¯¥å…ƒç´ æ’å…¥ã€‚è€Œä¸‹ä¸€æ¬¡å†æ¬¡æ’å…¥æ—¶ï¼Œç»§ç»­è½¬ç§»æ—§å“ˆå¸Œè¡¨ä¸­ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„æ¡¶ï¼Œå†æ’å…¥å…ƒç´ ã€‚ç›´è‡³æ—§å“ˆå¸Œè¡¨ä¸ºç©ºä¸ºæ­¢ã€‚è¿™æ ·ä¸€æ¥ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæ’å…¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ã€‚</p>
</li>
<li><p>åœ¨Redisçš„å®ç°ä¸­ï¼Œæ–°æ’å…¥çš„é”®å€¼å¯¹ä¼šæ”¾åœ¨ç®±å­ä¸­é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯åœ¨å°¾éƒ¨ç»§ç»­æ’å…¥ã€‚</p>
</li>
<li><p>è¿™ç§æ–¹æ¡ˆæ˜¯åŸºäºä¸¤ç‚¹è€ƒè™‘ï¼š</p>
</li>
<li><p>ä¸€æ˜¯ç”±äºæ‰¾åˆ°é“¾è¡¨å°¾éƒ¨çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œä¸”éœ€è¦é¢å¤–çš„å†…å­˜åœ°å€æ¥ä¿å­˜é“¾è¡¨çš„å°¾éƒ¨ä½ç½®ï¼Œè€Œå¤´æ’æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p>
</li>
<li><p>äºŒæ˜¯å¤„äºRedisçš„å®é™…åº”ç”¨åœºæ™¯æ¥è€ƒè™‘ã€‚å¯¹äºä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿæ¥è¯´ï¼Œæœ€æ–°æ’å…¥çš„æ•°æ®å¾€å¾€æ›´å¯èƒ½é¢‘ç¹åœ°è¢«è·å–ï¼Œæ‰€ä»¥è¿™æ ·ä¹Ÿèƒ½èŠ‚çœæŸ¥æ‰¾çš„è€—æ—¶</p>
</li>
</ol>
<h2 id="äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«"><a href="#äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«" class="headerlink" title="äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«"></a>äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«</h2><h3 id="1ã€HashMap"><a href="#1ã€HashMap" class="headerlink" title="1ã€HashMap"></a>1ã€HashMap</h3><p>å› ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨Hashmapè¿›è¡Œputæ“ä½œå¯èƒ½ä¼šå¼•èµ·æ­»é”ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨HashMapã€‚ã€PSï¼šHashMap æ˜¯å…è®¸keyå€¼ä¸ºç©ºçš„ã€‘</p>
<h3 id="2ã€HashTable"><a href="#2ã€HashTable" class="headerlink" title="2ã€HashTable"></a>2ã€HashTable</h3><p>Hashtableå®¹å™¨ä½¿ç”¨synchronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹Hashtableçš„æ•ˆç‡éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®Hashtableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—®Hashtableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ã€‚å¦‚çº¿ç¨‹1ä½¿ç”¨putè¿›è¡Œæ·»åŠ å…ƒç´ ï¼Œçº¿ç¨‹2ä¸ä½†ä¸èƒ½ä½¿ç”¨putæ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ä½¿ç”¨getæ–¹æ³•æ¥è·å–å…ƒç´ ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-ba4fef5ef17740c79a373e929b5db03f.png" alt="image.png"></p>
<h3 id="3ã€ConcurrentHashMap"><a href="#3ã€ConcurrentHashMap" class="headerlink" title="3ã€ConcurrentHashMap"></a>3ã€ConcurrentHashMap</h3><p><strong>1ï¼‰jdk7ç‰ˆæœ¬</strong></p>
<p>ConcurrentHashMapå’ŒHashMapè®¾è®¡æ€è·¯å·®ä¸å¤šï¼Œä½†æ˜¯ä¸ºæ”¯æŒå¹¶å‘æ“ä½œï¼Œåšäº†ä¸€å®šçš„æ”¹è¿›ï¼ŒConcurrentHashMapå¼•å…¥Segment çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†mapæ‹†åˆ†æˆå¤šä¸ªSegment(é»˜è®¤16ä¸ª)ã€‚æ“ä½œConcurrentHashMapç»†åŒ–åˆ°æ“ä½œæŸä¸€ä¸ªSegmentã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸åŒçº¿ç¨‹æ“ä½œä¸åŒçš„Segmentï¼Œä»–ä»¬äº’ä¸å½±å“ï¼Œè¿™ä¾¿å¯å®ç°å¹¶å‘æ“ä½œã€‚</p>
<p><strong>2ï¼‰jdk8ç‰ˆæœ¬</strong></p>
<p>jdk8ç‰ˆæœ¬çš„ConcurrentHashMapç›¸å¯¹äºjdk7ç‰ˆæœ¬ï¼Œå‘é€äº†å¾ˆå¤§æ”¹åŠ¨ï¼Œjdk8ç›´æ¥æŠ›å¼ƒäº†Segmentçš„è®¾è®¡ï¼Œé‡‡ç”¨äº†  è¾ƒä¸ºè½»æ·çš„Node + CAS + Synchronizedè®¾è®¡ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p><strong>3ï¼‰æ€»ç»“</strong></p>
<p>1ã€getæ–¹æ³•ä¸åŠ é”ï¼›</p>
<p>2ã€putã€removeæ–¹æ³•è¦ä½¿ç”¨é”</p>
<p>jdk7ä½¿ç”¨é”åˆ†ç¦»æœºåˆ¶(Segmentåˆ†æ®µåŠ é”)</p>
<p>jdk8ä½¿ç”¨cas + synchronized å®ç°é”æ“ä½œ</p>
<p>3ã€Iteratorå¯¹è±¡çš„ä½¿ç”¨ï¼Œè¿è¡Œä¸€è¾¹æ›´æ–°ï¼Œä¸€ééå†(å¯ä»¥æ ¹æ®åŸç†è‡ªå·±æ‹“å±•)</p>
<p>4ã€å¤åˆæ“ä½œï¼Œæ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦é¢å¤–åŠ é”ä¿è¯</p>
<p>5ã€å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒConcurrentHashMap æ•ˆç‡è¾ƒCollections.synchronizedMap()æ›´é«˜</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>fastdfsåº”ç”¨</title>
    <url>/2021/07/22/fastdfs%E5%BA%94%E7%94%A8-fastdfs%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<ul>
<li><h3 id="ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶"><a href="#ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶" class="headerlink" title="ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶"></a>ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶</h3></li>
<li><h3 id="fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜"><a href="#fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜" class="headerlink" title="fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜"></a>fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜</h3></li>
</ul>
<h2 id><a href="#" class="headerlink" title></a></h2><h2 id="ç›¸å…³çš„æ–‡ç« "><a href="#ç›¸å…³çš„æ–‡ç« " class="headerlink" title="ç›¸å…³çš„æ–‡ç« "></a>ç›¸å…³çš„æ–‡ç« </h2><p>1ã€å•ä½“å®‰è£…æ•™ç¨‹ <a href="https://blog.csdn.net/suoyanming/article/details/88797360">https://blog.csdn.net/suoyanming/article/details/88797360</a></p>
<p>2ã€å¼€æºä¸­å›½fastdfsä¸»é¡µ <a href="https://www.oschina.net/p/fastdfs">p&#x2F;fastdfs</a></p>
<p>3ã€githubä¸»é¡µï¼ˆä¸ç¡®å®šæ˜¯å¦æ˜¯åŸä½œè€…ç»´æŠ¤ï¼‰ <a href="https://github.com/happyfish100/fastdfs">happyfish100&#x2F;fastdfs</a></p>
<p>4ã€å¯¹fastdfs-nginx-module å®ç°åŸç†è®²çš„éå¸¸æ¸…æ¥š <strong><a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></strong>   </p>
<h1 id="ä¸€ã€FastDFS"><a href="#ä¸€ã€FastDFS" class="headerlink" title="ä¸€ã€FastDFS"></a><strong>ä¸€ã€FastDFS</strong></h1><p>1ã€FastDFSæ˜¯ä¸€ä¸ªå¼€æºçš„è½»é‡çº§<a href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/1250388">åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</a>ï¼Œå®ƒå¯¹æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å­˜å‚¨ã€æ–‡ä»¶åŒæ­¥ã€æ–‡ä»¶è®¿é—®ï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ï¼‰ç­‰ï¼Œè§£å†³äº†å¤§å®¹é‡å­˜å‚¨å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ã€‚ç‰¹åˆ«é€‚åˆä»¥æ–‡ä»¶ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ï¼Œå¦‚ç›¸å†Œç½‘ç«™ã€è§†é¢‘ç½‘ç«™ç­‰ç­‰ã€‚</p>
<p>2ã€FastDFSä¸ºäº’è”ç½‘é‡èº«å®šåˆ¶ï¼Œå……åˆ†è€ƒè™‘äº†å†—ä½™å¤‡ä»½ã€è´Ÿè½½å‡è¡¡ã€çº¿æ€§æ‰©å®¹ç­‰æœºåˆ¶ï¼Œå¹¶æ³¨é‡é«˜å¯ç”¨ã€é«˜æ€§èƒ½ç­‰æŒ‡æ ‡ï¼Œä½¿ç”¨FastDFSå¾ˆå®¹æ˜“æ­å»ºä¸€å¥—é«˜æ€§èƒ½çš„æ–‡ä»¶æœåŠ¡å™¨é›†ç¾¤æä¾›æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ç­‰æœåŠ¡ã€‚</p>
<h1 id="äºŒã€æ·±å…¥è®¤è¯†FastDFS"><a href="#äºŒã€æ·±å…¥è®¤è¯†FastDFS" class="headerlink" title="äºŒã€æ·±å…¥è®¤è¯†FastDFS"></a><strong>äºŒã€æ·±å…¥è®¤è¯†FastDFS</strong></h1><ul>
<li>ä»»ä½•ä¸€ä¸ªä¸­é—´ä»¶çš„åº”ç”¨ï¼Œéƒ½å¿…é¡»æ·±å…¥äº†è§£è¯¥ä¸­é—´ä»¶å†…éƒ¨å„ç»„ä»¶çš„æ‰¿æ‹…çš„åŠŸèƒ½è§’è‰²ã€è¿è¡Œæœºåˆ¶ï¼Œèƒ½æ·±å…¥äº†è§£å„ç»„ä»¶çš„å®ç°åŸç†æ›´å¥½ã€‚è¿™æ ·æ‰èƒ½çµæ´»åº”å¯¹å®é™…åº”ç”¨åœºæ™¯ã€å¤šå˜çš„ä¸šåŠ¡éœ€æ±‚ã€ç”Ÿäº§ç¯å¢ƒåº”æ€¥ç­‰é—®é¢˜ï¼Œå¿«é€Ÿå®æ–½æ¶æ„è°ƒæ•´ã€‚</li>
<li>æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨FastDFSä½œä¸ºå›¾ç‰‡æ–‡ä»¶æ•°æ®åº“ï¼Œéƒ¨ç½²æ¶æ„ä¸ºå•ä½“ï¼ˆå³ï¼šä¸€ä¸ªtrackerã€ä¸€ä¸ªstorageã€ä¸€ä¸ªgroupï¼‰,ç”±äºæœ¬æ¬¡ç”¨äºéƒ¨ç½²fastdfsçš„æœåŠ¡å™¨ç¡¬ç›˜ç©ºé—´æŠ¥è­¦ï¼Œå½“åŠ¡ä¹‹æ€¥å¿…é¡»æ›´æ”¹fastdfséƒ¨ç½²æ¶æ„ï¼Œæ‰©å±•å­˜å‚¨ã€‚</li>
<li>ä¸‹é¢ä»é¡¹ç›®æ€»ä½“æƒ…å†µã€tracker ã€storageã€fastdfs-nginx-module ã€group ç»„ä»¶è¯¦ç»†è¯´æ˜å…¶åŠŸèƒ½è§’è‰²åŠè¿è¡Œæœºåˆ¶</li>
</ul>
<h2 id="1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ"><a href="#1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ" class="headerlink" title="1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ"></a><strong>1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ</strong></h2><ul>
<li>â€‹    fastdfsæ˜¯å¼€æºçš„é¡¹ç›®</li>
<li>â€‹    é€šè¿‡githubæºç å¯çœ‹å‡ºï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäºCè¯­è¨€å¼€å‘çš„</li>
<li>â€‹    fastdfsæ˜¯åŸºäºæ“ä½œç³»ç»ŸOSçš„æ–‡ä»¶ç®¡ç†ç³»ç»ŸåŠŸèƒ½ä¹‹ä¸Šè¿›è¡Œåˆ†å¸ƒå¼æ–‡ä»¶ç®¡ç†ï¼ˆLinuxã€FreeBSDç­‰ï¼‰ï¼Œé€šè¿‡çœ‹æ–‡ä»¶åœ¨ç¡¬ç›˜çš„ä¿å­˜æ–¹å¼ä¹Ÿå¯ä»¥å¾—å‡º</li>
<li>â€‹    æä¾›Cã€Javaå’ŒPHP APIæ¥å£</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325165732189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325165748158.png" alt="img"></p>
<h2 id="2ã€trackerè·Ÿè¸ªå™¨"><a href="#2ã€trackerè·Ÿè¸ªå™¨" class="headerlink" title="2ã€trackerè·Ÿè¸ªå™¨"></a><strong>2ã€trackerè·Ÿè¸ªå™¨</strong></h2><ul>
<li><p><strong>ä¸»è¦åšè°ƒåº¦å·¥ä½œï¼Œ èµ·è´Ÿè½½å‡è¡¡çš„ä½œç”¨</strong></p>
</li>
<li><p><strong>åœ¨å†…å­˜ä¸­è®°å½•é›†ç¾¤ä¸­æ‰€æœ‰å­˜å‚¨ç»„groupå’Œå­˜å‚¨æœåŠ¡å™¨storage çš„çŠ¶æ€ä¿¡æ¯, æ˜¯å®¢æˆ·ç«¯å’Œæ•°æ®æœåŠ¡å™¨äº¤äº’çš„æ¢çº½</strong></p>
</li>
<li><p><strong>trackerçš„æ ¸å¿ƒå·¥ä½œå†…å®¹</strong>ï¼š</p>
</li>
</ul>
<p>ï¼ˆ1ï¼‰ è®°å½•é›†ç¾¤ä¸­æœ‰å¤šå°‘ä¸ªgroupï¼ˆgroup1\group2â€¦.ï¼‰</p>
<p>(2) æ¯ä¸ªgroup åˆ†å¸ƒåœ¨é‚£ä¸ªå‡ ä¸ªstorageä¸Šï¼Œä»¥åŠstorageæ‰€åœ¨æœºå™¨çš„ipï¼Œç«¯å£ç­‰ä¿¡æ¯ï¼Œgroupä¹‹é—´çš„åŒæ­¥ç”±tracker å’Œstorageä¸€èµ·å®Œæˆï¼ˆåé¢ç»†è®²ï¼‰</p>
<p>ï¼ˆ3ï¼‰å¦‚æœåŒä¸€ä¸ªgroup å­˜åœ¨å¤šä¸ªstorage, è€Œè¿™äº›storageåˆè¢«åˆ†å¸ƒåœ¨ä¸€å°æˆ–å¤šå°æœºå™¨ä¸Šï¼Œé‚£ä¹ˆå¯¹è¯¥groupä¸Šä¼ æˆ–è¯»å–æ–‡ä»¶å…·ä½“è½åˆ°é‚£ä¸ªæœºå™¨ä¸Šï¼ˆå³é‚£ä¸ªstorageï¼‰ï¼Ÿï¼ˆæœ‰ç‚¹ç»•ï¼‰</p>
<p>trackerå®Œç¾çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼šå¤šgroupã€å¤šstorageçš„ä¸Šä¼ å’Œä¸‹è½½åšè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé€šè¿‡é…ç½®tracker.confå¯å®ç°å…·ä½“è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
<p>(4) tracker å¯éƒ¨ç½²å¤šå°ï¼Œå¤šä¸ªtrackeråœ¨æœåŠ¡å™¨å†…å­˜ä¸­è®°å½•çš„ä¿¡æ¯æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡nginxå¯¹trackeråšè´Ÿè½½å‡è¡¡ï¼Œä»¥æé«˜å¹¶å‘æ€§èƒ½åŠå®¹ç¾èƒ½åŠ›</p>
<p>ï¼ˆ5ï¼‰tracker ä¸å»ä¸»åŠ¨è¯»å–storageçš„ç›¸å…³ä¿¡æ¯ï¼Œè€Œæ˜¯ç”±storageä¸»åŠ¨æ¨é€ç»™tracker ï¼ˆ<strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¿…é¡»å…ˆå¯åŠ¨trackerçš„åŸå› </strong>ï¼‰ </p>
<p>ï¼ˆ6ï¼‰ä»¥ä¸‹å›¾ç‰‡æ‘˜è‡ªç½‘ä¸Š ï¼š ä¸Šä¼ æ–‡ä»¶è¿‡ç¨‹ ã€ä¸‹è½½æ–‡ä»¶è¿‡ç¨‹ï¼Œé€šè¿‡å›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼Œtrackerçš„æ ¸å¿ƒå·¥ä½œæ˜¯ä¸ºå®¢æˆ·ç«¯æ‰¾åˆ°ä¸€ä¸ªstorage, clientå®¢æˆ·ç«¯å’Œstorageè¿›è¡Œä¸Šä¼ ä¸‹è½½é€šä¿¡ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/201903251658268.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<ul>
<li><h6 id="tracker-conf-åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker-confä¸­"><a href="#tracker-conf-åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker-confä¸­" class="headerlink" title="tracker.conf (åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker.confä¸­)"></a><strong>tracker.conf (åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker.confä¸­)</strong></h6><h2 id="æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜"><a href="#æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜" class="headerlink" title="æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜"></a>æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜</h2></li>
</ul>
<h3 id="ï¼ˆ1ï¼‰disabled-x3D-false"><a href="#ï¼ˆ1ï¼‰disabled-x3D-false" class="headerlink" title="ï¼ˆ1ï¼‰disabled&#x3D;false"></a>ï¼ˆ1ï¼‰disabled&#x3D;false</h3><p>â€‹     <strong>#é…ç½®æ–‡ä»¶æ˜¯å¦å¤±æ•ˆ</strong></p>
<p>â€‹     # is this config file disabled</p>
<p>â€‹    # false for enabled</p>
<p>â€‹    # true for disabled disabled&#x3D;false</p>
<p>â€‹    # is this config file disabled # false for enabled # true for disabled</p>
<h3 id="ï¼ˆ2ï¼‰port-x3D-22122"><a href="#ï¼ˆ2ï¼‰port-x3D-22122" class="headerlink" title="ï¼ˆ2ï¼‰port&#x3D;22122"></a>ï¼ˆ2ï¼‰port&#x3D;22122</h3><p>â€‹      #æœåŠ¡ç«¯å£</p>
<p>â€‹      # the tracker server port</p>
<h3 id="ï¼ˆ3ï¼‰-base-path-x3D-x2F-data-x2F-fastdfs-x2F-tracker"><a href="#ï¼ˆ3ï¼‰-base-path-x3D-x2F-data-x2F-fastdfs-x2F-tracker" class="headerlink" title="ï¼ˆ3ï¼‰ base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;tracker"></a><strong>ï¼ˆ3ï¼‰ base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;tracker</strong></h3><p>â€‹       # å­˜æ”¾track æ•°æ®åŠæ—¥å¿—æ–‡ä»¶ç›®å½• </p>
<p>â€‹       # the base path to store data and log files</p>
<p>â€‹		work_threads&#x3D;4</p>
<p>â€‹     #æ—¶çº¿ç¨‹æ•°ï¼šä¸€èˆ¬å’Œcpuçš„ä¸ªæ•°è®¾ä¸ºåŒä¸€ä¸ªå€¼     </p>
<p>â€‹     # work thread count, should &lt;&#x3D; max_connections</p>
<p>â€‹     # default value is 4</p>
<p>â€‹      # since V2.00</p>
<h3 id="ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰-store-lookup-x3D-1"><a href="#ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰-store-lookup-x3D-1" class="headerlink" title="ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰ store_lookup&#x3D;1"></a><strong>ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰ store_lookup&#x3D;1</strong></h3><p><strong>ä¸Šä¼ æ–‡ä»¶é€‰æ‹©å“ªä¸ªä¸€ä¸ªgroup çš„ ç­–ç•¥ï¼š0ï¼šè½®è¯¢ï¼›1:æŒ‡å®šç»„ ï¼› 2ï¼š è´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©å‰©ä½™å­˜å‚¨ç©ºé—´æœ€å¤§çš„ç»„group ä¸Šä¼ æ–‡ä»¶</strong></p>
<p>â€‹       # the method of selecting group to upload files</p>
<p>â€‹       # 0: round robin</p>
<p>â€‹       # 1: specify group</p>
<p>â€‹      # 2: load balance, select the max free space group to <strong>upload file</strong></p>
<h3 id="ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰-store-group-x3D-group2"><a href="#ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰-store-group-x3D-group2" class="headerlink" title="ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰ store_group&#x3D;group2"></a><strong>ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰ store_group&#x3D;group2</strong></h3><p>â€‹    # å½“ store_lookup&#x3D;1 æ—¶ï¼Œè¯¥é…ç½®æœ‰æ•ˆï¼ŒæŒ‡å®šå­˜å‚¨çš„ç»„å</p>
<p>â€‹     # which group to upload file</p>
<p>â€‹     # when store_lookup set to 1, must set store_group to the group name</p>
<h3 id="ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰-store-server-x3D-0"><a href="#ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰-store-server-x3D-0" class="headerlink" title="ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰ store_server&#x3D;0"></a><strong>ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰ store_server&#x3D;0</strong></h3><p>â€‹    # åº”ç”¨åœºæ™¯ï¼š å­˜åœ¨å¤šä¸ªç›¸åŒçš„ç»„ï¼Œä¾‹å¦‚group1 ï¼Œ åœ¨å¤šä¸ªstorage æœåŠ¡å™¨ä¸Š ä¾‹å¦‚ï¼š192.168.0.171 ã€ï¼Œ</p>
<p>â€‹              å½“ä¸Šä¼ æ–‡ä»¶æ—¶ä¼˜å…ˆé€‰æ‹©é‚£ä¸ªstorageçš„ç­–ç•¥é…ç½®<strong>ï¼š~ 0ï¼šè½®è¯¢ ï¼›1ï¼šæŒ‰ipå‡åºæ’åºåé€‰æ‹©ç¬¬ä¸€ä¸ªipï¼Œå³æœ€å°çš„é‚£ä¸ªip (192.168.0.164)ï¼›2ï¼šæŒ‰ä¼˜å…ˆçº§æ’åˆ—çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨é¡ºåºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Š é«˜ï¼ŒstorageæœåŠ¡å™¨çš„ä¼˜å…ˆåœ¨storage.confä¸­é…ç½® upload_priority å‚æ•°</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20190325165901337.png" alt="img"></p>
<p>  # <strong>which storage server to upload file</strong></p>
<p>â€‹    # 0: round robin (default)</p>
<p>â€‹    # 1: the first server order by ip address</p>
<p>â€‹    # 2: the first server order by priority (the minimal)</p>
<h3 id="ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰-store-path-x3D-0"><a href="#ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰-store-path-x3D-0" class="headerlink" title="ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰ store_path&#x3D;0"></a><strong>ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰ store_path&#x3D;0</strong></h3><p>â€‹    # åº”ç”¨åœºæ™¯ï¼šé€‰æ‹©å…·ä½“ä¸€ä¸ªç»„çš„é‚£ä¸€æ¡å­˜å‚¨è·¯å¾„ï¼ˆ<strong>ä¸€ä¸ªgroupæœ‰å¤šæ¡å­˜å‚¨è·¯å¾„ï¼Œä¸€èˆ¬ä¸€ä¸ªæœåŠ¡å™¨æœ‰ä¸¤å—å¤§ç¡¬ç›˜æŒ‚è½½åˆ°äº†ä¸¤ä¸ªè·¯å¾„ä¸‹ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾æ–‡ä»¶</strong>ï¼‰ï¼Œ~0ï¼šè½®è¯¢ï¼Œ2ï¼šè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©å‰©ä½™ç©ºé—´æœ€å¤§çš„è·¯å¾„ </p>
<p>â€‹     ï¼ˆ<strong>é€»è¾‘~é‡è¦</strong>ï¼‰ é€šè¿‡ä¸Šé¢çš„é…ç½®å‚æ•°ç¡®å®šäº†3ä»¶äº‹çš„åŸºç¡€ä¸Šï¼Œè¯¥é…ç½®æ‰ä¼šèµ·ä½œç”¨ï¼š</p>
<p>â€‹    ï¼ˆ1ï¼‰ç¡®å®šäº†è¦å­˜å‚¨åœ¨é‚£ä¸ªgroupä¸Šï¼Œä¾‹å¦‚group1ï¼›ï¼ˆ2ï¼‰ç¡®å®šä¸Šä¼ æ–‡ä»¶è¦ä¿å­˜åœ¨é‚£ä¸€å°storage ä¸­çš„group1ï¼Œå‡å¦‚æ˜¯192.168.0.171ï¼›ï¼ˆ3ï¼‰ æ­¤æ—¶å¦‚æœ 192.168.0.171 ä¸Šçš„storage serverä¸­group1 æœ‰ä¸¤ä¸ªå­˜å‚¨è·¯å¾„ï¼Œå³store_path0,store_path1**,(å¯¹åº”çš„æ–‡ä»¶è·¯å¾„å³M00,M01)**</p>
<p><img src="https://img-blog.csdnimg.cn/20190325165922761.png" alt="img"></p>
<p> # which path(means disk or mount point) of the storage server to upload file</p>
<p>â€‹    # 0: round robin</p>
<p>   # 2: load balance, select the max free space path to upload file</p>
<h3 id="ï¼ˆ8ï¼‰download-server-x3D-0"><a href="#ï¼ˆ8ï¼‰download-server-x3D-0" class="headerlink" title="ï¼ˆ8ï¼‰download_server&#x3D;0"></a><strong>ï¼ˆ8ï¼‰download_server&#x3D;0</strong></h3><p>â€‹    # ä¸‹è½½æ–‡ä»¶æ—¶å­˜å‚¨æœåŠ¡å™¨çš„é€‰æ‹©ç­–ç•¥ï¼› åº”ç”¨åœºæ™¯ï¼šè¦ä¸‹è½½çš„æ–‡ä»¶æ‰€åœ¨group å­˜åœ¨å¤šä¸ªstorage æœåŠ¡å™¨ä¸Šï¼Œ ~0ï¼šè½®è¯¢ ï¼›1ï¼šå½“å‰æ–‡ä»¶ä¸Šè½½åˆ°çš„æºå­˜å‚¨æœåŠ¡å™¨</p>
<p>â€‹    # which storage server to download file</p>
<p>â€‹    # 0: round robin (default)</p>
<p>â€‹    # 1: the source storage server which the current file uploaded to</p>
<h3 id="ï¼ˆ9ï¼‰reserved-storage-space-x3D-10"><a href="#ï¼ˆ9ï¼‰reserved-storage-space-x3D-10" class="headerlink" title="ï¼ˆ9ï¼‰reserved_storage_space &#x3D; 10%"></a><strong>ï¼ˆ9ï¼‰reserved_storage_space &#x3D; 10%</strong></h3><p>  # ç»™ç³»ç»Ÿæˆ–å…¶ä»–åº”ç”¨ç¨‹åºé¢„ç•™å­˜å‚¨ç©ºé—´è®¾ç½® </p>
<p>  #ï¼ˆ<strong>é‡è¦</strong>ï¼‰åœºæ™¯ï¼šæŸä¸€ä¸ªgroupæ‰€åœ¨æŸä¸€ä¸ªstorageæœåŠ¡å™¨ï¼ˆå¯èƒ½å­˜åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼‰å‰©ä½™çš„å­˜å‚¨ç©ºé—´å°äºç­‰äºè¿™ä¸ªé˜€å€¼æ—¶ï¼Œåˆ™æ–‡ä»¶ä¸èƒ½è¢«ä¿å­˜ï¼Œå³ä½¿è¯¥groupçš„å…¶ä»–storageæœåŠ¡å™¨è¿˜æœ‰å¾ˆå¤§çš„å­˜å‚¨ç©ºé—´</p>
<p>  # reserved storage space for system or other applications.</p>
<p>  # if the free(available) space of any stoarge server in</p>
<p>  # a group &lt;&#x3D; reserved_storage_space,</p>
<p>  # no file can be uploaded to this group.</p>
<p>  # bytes unit can be one of follows:</p>
<p>  ### G or g for gigabyte(GB)</p>
<p>  ### M or m for megabyte(MB)</p>
<p>  ### K or k for kilobyte(KB)</p>
<p>  ### no unit for byte(B)</p>
<p>  ### XX.XX% as ratio such as reserved_storage_space &#x3D; 10%</p>
<p><img src="https://img-blog.csdnimg.cn/20190325165954851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/2019032517001063.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325170031269.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h2 id="3ã€storage-å­˜å‚¨æœåŠ¡å™¨"><a href="#3ã€storage-å­˜å‚¨æœåŠ¡å™¨" class="headerlink" title="3ã€storage å­˜å‚¨æœåŠ¡å™¨"></a><strong>3ã€storage å­˜å‚¨æœåŠ¡å™¨</strong></h2><ul>
<li><p>storage å®šæœŸå‘trackerå‘é€å¿ƒè·³ï¼ŒæŠ¥å‘Šè‡ªå·±çš„çŠ¶æ€ï¼Œtrackerä¼šå°†åŒç»„çš„ storage serverä¿¡æ¯è¿”å›ç»™storage ï¼ˆè¯¥éƒ¨åˆ†é€»è¾‘åé¢å†ç»†è®²ï¼‰ </p>
</li>
<li><p>trackerä¸è´Ÿè´£å…·ä½“çš„æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½å®ç°ï¼Œè¿™äº›éƒ½æ˜¯æœ‰storageå®Œæˆçš„</p>
</li>
<li><p>storageä¿å­˜æ–‡ä»¶å’Œæ–‡ä»¶çš„å±æ€§</p>
</li>
<li><p>storage serveræ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿè¿›è¡Œæ–‡ä»¶ç®¡ç†çš„ï¼ˆä¸Šé¢æœ‰æåˆ°ï¼‰</p>
</li>
<li><p>groupä¹‹é—´æ–‡ä»¶åŒæ­¥ç”±storage server å’Œtacker serverä¸€èµ·å®Œæˆçš„ï¼ˆè¯¥éƒ¨åˆ†é€»è¾‘åé¢å†ç»†è®²ï¼‰ </p>
</li>
<li><p>storage serverçš„çŠ¶æ€ï¼ˆ7ä¸ªï¼‰</p>
</li>
<li><p>FDFS_STORAGE_STATUS_INIT :åˆå§‹åŒ–ï¼Œå°šæœªå¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨</p>
</li>
<li><p>FDFS_STORAGE_STATUS_WAIT_SYNC :ç­‰å¾…åŒæ­¥ï¼Œå·²å¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨</p>
</li>
<li><p>FDFS_STORAGE_STATUS_SYNCING :åŒæ­¥ä¸­</p>
</li>
<li><p>FDFS_STORAGE_STATUS_DELETED :å·²åˆ é™¤ï¼Œè¯¥æœåŠ¡å™¨ä»æœ¬ç»„ä¸­æ‘˜é™¤ï¼ˆæ³¨ï¼šæœ¬çŠ¶æ€çš„åŠŸèƒ½å°šæœªå®ç°ï¼‰</p>
</li>
<li><p>FDFS_STORAGE_STATUS_OFFLINE :ç¦»çº¿</p>
</li>
<li><p>FDFS_STORAGE_STATUS_ONLINE :åœ¨çº¿ï¼Œå°šä¸èƒ½æä¾›æœåŠ¡</p>
</li>
<li><p>FDFS_STORAGE_STATUS_ACTIVE :åœ¨çº¿ï¼Œå¯ä»¥æä¾›æœåŠ¡</p>
</li>
</ul>
<h3 id="storage-conf-æ ¸å¿ƒå‚æ•°é…ç½®"><a href="#storage-conf-æ ¸å¿ƒå‚æ•°é…ç½®" class="headerlink" title="storage.conf æ ¸å¿ƒå‚æ•°é…ç½®"></a>storage.conf æ ¸å¿ƒå‚æ•°é…ç½®</h3><h3 id="ï¼ˆ1ï¼‰port-x3D-23000"><a href="#ï¼ˆ1ï¼‰port-x3D-23000" class="headerlink" title="ï¼ˆ1ï¼‰port&#x3D;23000"></a>ï¼ˆ1ï¼‰port&#x3D;23000</h3><p>   # storage æœåŠ¡ç«¯å£</p>
<p>   # the storage server port</p>
<h3 id="ï¼ˆ2ï¼‰base-path-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage"><a href="#ï¼ˆ2ï¼‰base-path-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage" class="headerlink" title="ï¼ˆ2ï¼‰base_path&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage"></a>ï¼ˆ2ï¼‰base_path&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage</h3><p>   #å­˜æ”¾storage æœåŠ¡çš„æ•°æ®å’Œæ—¥å¿—</p>
<p>   # the base path to store data and log files</p>
<h3 id="ï¼ˆ3ï¼‰store-path0-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage"><a href="#ï¼ˆ3ï¼‰store-path0-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage" class="headerlink" title="ï¼ˆ3ï¼‰store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage"></a><strong>ï¼ˆ3ï¼‰store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage</strong></h3><p>   # å­˜å‚¨è·¯å¾„é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œå¯¹åº”çš„ store_path_count&#x3D;1 å‚æ•°éœ€è¦ç´¯åŠ </p>
<p>   # store_path#, based 0, if store_path0 not exists, itâ€™s value is base_path</p>
<p>   # the paths must be exist</p>
<p>   #store_path1&#x3D;&#x2F;home&#x2F;yuqing&#x2F;fastdfs2</p>
<h3 id="ï¼ˆ4ï¼‰tracker-server-x3D-192-168-0-171-22122"><a href="#ï¼ˆ4ï¼‰tracker-server-x3D-192-168-0-171-22122" class="headerlink" title="ï¼ˆ4ï¼‰tracker_server&#x3D;192.168.0.171:22122"></a><strong>ï¼ˆ4ï¼‰tracker_server&#x3D;192.168.0.171:22122</strong></h3><p>   #tracker æœåŠ¡çš„ ipå’Œç«¯å£ï¼Œ ipæ›¿æ¢ä¸ºåŸŸåä¹Ÿå¯ä»¥ï¼Œå¯ä»¥é…ç½®å¤šä¸ª </p>
<p>   # tracker_server can ocur more than once, and tracker_server format is</p>
<p>   # â€œhost:portâ€, host can be hostname or ip address</p>
<h3 id="ï¼ˆ5ï¼‰file-distribute-path-mode-x3D-0"><a href="#ï¼ˆ5ï¼‰file-distribute-path-mode-x3D-0" class="headerlink" title="ï¼ˆ5ï¼‰file_distribute_path_mode&#x3D;0"></a><strong>ï¼ˆ5ï¼‰file_distribute_path_mode&#x3D;0</strong></h3><p>  # åˆ†å¸ƒå¼å­˜å‚¨æ–‡ä»¶ç­–ç•¥ï¼š å½“storageä¸‹æœ‰å¤šä¸ªå­˜å‚¨è·¯å¾„æ—¶ï¼Œè¯¥é…ç½®èµ·ä½œç”¨ ~ # 0: è½®è¯¢   # 1: æ ¹æ®æ–‡ä»¶åhashç»“æœéšæœºå­˜å‚¨</p>
<p>  # the mode of the files distributed to the data path</p>
<p>  # 0: round robin(default)</p>
<p>  # 1: random, distributted by hash code </p>
<h3 id="ï¼ˆ6ï¼‰upload-priority-x3D-10-ï¼ˆåœ¨tracker-conf-ä¸­æœ‰æåˆ°ï¼‰"><a href="#ï¼ˆ6ï¼‰upload-priority-x3D-10-ï¼ˆåœ¨tracker-conf-ä¸­æœ‰æåˆ°ï¼‰" class="headerlink" title="ï¼ˆ6ï¼‰upload_priority&#x3D;10 ï¼ˆåœ¨tracker.conf ä¸­æœ‰æåˆ°ï¼‰"></a>ï¼ˆ6ï¼‰upload_priority&#x3D;10 ï¼ˆåœ¨tracker.conf ä¸­æœ‰æåˆ°ï¼‰</h3><p># ä¸Šä¼ æ–‡ä»¶äº‹ï¼ŒåŒç»„å†…çš„storage æœåŠ¡å™¨ä¼˜å…ˆçº§è®¾ç½®ï¼Œä¸”å½“ tracker.conf ä¸­store_server&#x3D; 2æ—¶ èµ·ä½œç”¨ï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</p>
<p># the priority as a source server for uploading file.</p>
<p># the lower this value, the higher its uploading priority.</p>
<p># default value is 10</p>
<h2 id="4ã€group"><a href="#4ã€group" class="headerlink" title="4ã€group"></a><strong>4ã€group</strong></h2><ul>
<li>group åˆ†ç»„æ˜¯fastdfsåº”å¯¹å¤§æµé‡åº”ç”¨ç³»ç»Ÿä¸­å¤„ç†é«˜å¹¶å‘ã€é«˜å®¹ç¾çš„ç»å…¸è®¾è®¡ï¼Œå¹¶ä¸”groupè¿˜èµ·åˆ°äº†åº”ç”¨éš”ç¦»çš„åŠŸèƒ½</li>
<li>ä¸€ä¸ªgroupå¯ä»¥å­˜åœ¨å¤šä¸ªstorageä¸­ï¼ˆåœ¨storageä¸­ä¹Ÿå¯ä»¥æåˆ°ï¼‰</li>
<li>æ ¹æ®clientç«¯çš„è¯·æ±‚åˆ†é…åˆ°ä¸åŒçš„groupï¼Œæ–‡ä»¶ç³»ç»Ÿå…·å¤‡ç›´æ¥çš„è´Ÿè½½å‡è¡¡ï¼›</li>
<li>groupå†…æœ‰storageæœåŠ¡èŠ‚ç‚¹åæ‰æ—¶ï¼Œéœ€ä»å…¶ä»–groupå†…æ¢å¤æ•°æ®</li>
</ul>
<h2 id="5ã€-fastdfs-nginx-module"><a href="#5ã€-fastdfs-nginx-module" class="headerlink" title="5ã€ fastdfs-nginx-module"></a><strong>5ã€ fastdfs-nginx-module</strong></h2><ul>
<li><p>fastdfs ä¸­storageã€tracker å‡æä¾›çš„httpæœåŠ¡ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æ–‡ä»¶ï¼Œä½†è€ƒè™‘åˆ°æ€§èƒ½åŠè´Ÿè½½å®ç°éš¾æ˜“åº¦çš„é—®é¢˜ï¼Œä¸€èˆ¬éƒ½ç”¨webæœåŠ¡å™¨æ¥ä¸‹è½½æ–‡ä»¶ï¼Œä¾‹å¦‚nginxã€apache</p>
</li>
<li><p>fastdfs-nginx-module å°±æ˜¯fastdfsåŸºäºngnixå®ç°æ–‡ä»¶httpä¼ è¾“çš„ç»„ä»¶ï¼Œä»¥nginx moduleçš„æ–¹å¼æ·»åŠ åˆ°nginx ç¨‹åºä¸­</p>
</li>
<li><p>æ¯ä¸ªstorage å‡éœ€å®‰è£… fastdfs-nginx-module ã€Nginx ï¼Œå½“å‰storageæ‰¾ä¸åˆ°æ–‡ä»¶æ—¶ï¼Œå‘<strong>æºstorage</strong>ä¸»æœºå‘èµ·redirecté‡å®šå‘æˆ–proxyè½¬å‘ä»£ç†åŠ¨ä½œ</p>
</li>
<li><p>fastdfs-nginx-module å®‰è£…åç›®å½•ç»“æ„å¦‚ä¸‹å›¾</p>
<p>è¯´æ˜åŠå›¾ç‰‡ æ‘˜è‡ªï¼š<a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></p>
</li>
</ul>
<p>â€‹     (1)ngx_http_fastdfs_module.c  ~ nginx æ¨¡å—æ¥å£å®ç°æ–‡ä»¶ï¼Œç”¨äºå‘nginx æ¥å…¥fastdfs-moduleæ ¸å¿ƒæ¨¡å—é€»è¾‘</p>
<p>â€‹    ï¼ˆ2ï¼‰common.c  ~ fastdfs-moduleæ ¸å¿ƒæ¨¡å—ï¼Œå®ç°äº†åˆå§‹åŒ–ã€æ–‡ä»¶ä¸‹è½½çš„ä¸»è¦é€»è¾‘</p>
<p>â€‹    ï¼ˆ3ï¼‰config   ~ ç¼–è¯‘æ¨¡å—æ‰€ç”¨çš„é…ç½®ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›é‡è¦çš„å¸¸é‡ï¼Œè°ƒç”¨fastdfsåŸºç¡€ç»„ä»¶åŠŸèƒ½ï¼Œä»¥åŠæ‰©å±•é…ç½®æ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶ä¸‹è½½chunkå¤§å°</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">ï¼ˆ4ï¼‰mod_fastdfs.conf  ~æ‰©å±•é…ç½®æ–‡ä»¶çš„demoï¼Œä¸€èˆ¬ä¼šå°†è¯¥æ–‡ä»¶æ‹·è´åˆ°configæŒ‡å®šçš„ç›®å½•ä¸‹ ä¾‹å¦‚ï¼š/etc/fdfs</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190325170102450.png" alt="img"></p>
<ul>
<li>åˆå§‹åŒ–ï¼š nginxå¯åŠ¨æ—¶ï¼Œ  fastdfs-nginx-module è¦å®Œæˆåˆå§‹åŒ–å¦‚ä¸‹å›¾ ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨mod_fastdfs.confé…ç½®å‚æ•°ï¼Œå¦‚ä¸‹å›¾</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325170132699.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/2019032517015280.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325170205559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><strong>ï¼ˆé‡è¦ï¼‰ï¼š fastdfs-nginx-module åˆå§‹åŒ–çš„è¿‡ç¨‹è¦åŠ è½½mod_fastdfs.confå‚æ•°ï¼Œå¦‚æœæœ¬æœºå™¨ä¸‹å­˜åœ¨å¤šä¸ªstorage,ä¸”æœ‰å¤šä¸ªgroupï¼ˆgroup1ã€group2ï¼‰,åˆ™ mod_fastdfs.conf é…ç½®éœ€åšå¦‚ä¸‹å˜åŠ¨</strong></p>
<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><p><strong>ï¼ˆ1ï¼‰ç»„åï¼šgroup_name&#x3D;group1&#x2F;group2   å¤šä¸ªç”¨&#x2F;åŒºåˆ†å¼€</strong></p>
<p><strong>ï¼ˆ2ï¼‰è®¾ç½®ç»„ä¸ªæ•°ï¼šgroup_count &#x3D; 4</strong></p>
<p><strong>ï¼ˆ4ï¼‰è®¾ç½®å„groupä¿¡æ¯ï¼š</strong></p>
<p><strong>[group1]</strong></p>
<p><strong>group_name&#x3D;group1</strong></p>
<p><strong>storage_server_port&#x3D;23000</strong></p>
<p><strong>store_path_count&#x3D;1</strong></p>
<p><strong>store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;storage</strong></p>
<p><strong>[group2]</strong></p>
<p><strong>group_name&#x3D;group2</strong></p>
<p><em><strong>*storage_server_port&#x3D;23010*</strong></em></p>
<p><strong>store_path_count&#x3D;1</strong></p>
<p><strong>store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;storage</strong></p>
<h3 id="ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx-ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps-www-cnblogs-com-littleatp-p-4361318-html"><a href="#ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx-ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps-www-cnblogs-com-littleatp-p-4361318-html" class="headerlink" title="ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps://www.cnblogs.com/littleatp/p/4361318.html"></a><strong>ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒ<a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170230230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“-é‡è¦"><a href="#6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“-é‡è¦" class="headerlink" title="6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“**(é‡è¦)**"></a>6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“**(é‡è¦)**</h3><ul>
<li>â€‹    ä¸€ä¸ªgroup å¯¹åº”å¤šä¸ª storage (1:N)</li>
<li>â€‹    ä¸€ä¸ªstorageå¯¹åº”ä¸€ä¸ªgroup  (1:1)</li>
<li>â€‹    ä¸€ä¸ªtrackerå¯¹åº”å¤šä¸ªstorage(1:N)</li>
<li>â€‹    ä¸€ä¸ªstorageå¯¹åº”å¤šä¸ªtracker(1:N) , tracker å’Œstorageçš„å…³ç³»æ˜¯å¤šå¯¹å¤šï¼ˆN:Mï¼‰</li>
<li>â€‹    ä¸€ä¸ªstorageä¸‹æœ‰å¤šä¸ªå­˜å‚¨è·¯å¾„ store_path(1:N)</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325170336507.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»"><a href="#7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»" class="headerlink" title="7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»"></a><strong>7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»</strong></h3><h3 id="1ï¼‰å•ä½“éƒ¨ç½²-å•group-å•storage-å•tracker"><a href="#1ï¼‰å•ä½“éƒ¨ç½²-å•group-å•storage-å•tracker" class="headerlink" title="1ï¼‰å•ä½“éƒ¨ç½²: å•group\å•storage\å•tracker"></a>1ï¼‰å•ä½“éƒ¨ç½²: å•group\å•storage\å•tracker</h3><p><img src="https://img-blog.csdnimg.cn/20190325170402345.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²-ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰"><a href="#2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²-ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰" class="headerlink" title="2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²*ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰*"></a><strong>2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²*<em>ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰*</em></strong></h3><h3 id="å¤šgroup-å¤šstorage-å•tracker"><a href="#å¤šgroup-å¤šstorage-å•tracker" class="headerlink" title="å¤šgroup\å¤šstorage\å•tracker"></a><strong>å¤šgroup\å¤šstorage\å•tracker</strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170430665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰"><a href="#3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰" class="headerlink" title="3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰"></a>3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•tracker<strong>ï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰</strong></h3><p>   ç”±äºç›®å‰æœåŠ¡å™¨èµ„æºç´§ç¼ºæš‚ä¸åšgroupäº’å¤‡ï¼Œåé¢éœ€è¦åšgroupäº’å¤‡</p>
<p><img src="https://img-blog.csdnimg.cn/20190325170500305.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<ul>
<li><h3 id="éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®"><a href="#éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®" class="headerlink" title="éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®"></a><strong>éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®</strong></h3><p>ï¼ˆ1ï¼‰ä¸¤å°æœåŠ¡å™¨åˆ†åˆ«ä¸º192.168.0.171ã€192.168.0.164ï¼Œ 171æœåŠ¡å™¨æ‹…ä»»çš„åŠŸèƒ½è§’è‰²æ›´å¤šä¸€äº›: æ–‡ä»¶ä¸‹è½½è¯·æ±‚ nginxåŒä¸€å…¥å£ï¼ˆåˆ†å‘åˆ°storage1ã€stroage2ï¼‰ã€tracker server  ã€storage1 - group0ï¼ˆfastdfs-nginx-moduleï¼‰ã€‚</p>
<p>164æœåŠ¡å™¨ä¸»è¦è´Ÿè´£storage1 -group2 çš„å­˜å‚¨ã€ä¸‹è½½åŠŸèƒ½ï¼Œæ²¡æœ‰tacker serverï¼Œç›´æ¥è¿æ¥171æœåŠ¡å™¨çš„tracker,éœ€è¦å®‰è£…nginx ã€ fastdfs-nginx-module</p>
</li>
</ul>
<p>ï¼ˆ2) 171ã€ 164 éƒ½éœ€è¦å®‰è£… fastdfs ã€fastdfs-nginx-moduleã€ nginx å®‰è£…æ­¥éª¤ ä¸ çŸ¥è¯†åº“æ–‡æ¡£  <a href="http://192.168.0.109:8090/pages/viewpage.action?pageId=1606067">Centos7 ä¸Šå®‰è£… FastDFS</a> ä¸€è‡´ ï¼Œä½†æ³¨æ„ä¸€ç‚¹164æœåŠ¡å™¨ä¸ç”¨å¯åŠ¨åŠé…ç½®tracker</p>
<p>ï¼ˆ 3ï¼‰ 171 tracker.conf é…ç½®</p>
<p>   <strong>171 tracker.conf æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># is this config file disabled</span><br><span class="line"></span><br><span class="line"># false for enabled</span><br><span class="line"></span><br><span class="line"># true for disabled</span><br><span class="line"></span><br><span class="line">disabled=false</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the tracker server port</span><br><span class="line"></span><br><span class="line">port=22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/tracker</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the method of selecting group to upload files</span><br><span class="line"></span><br><span class="line"># 0: round robin</span><br><span class="line"></span><br><span class="line"># 1: specify group</span><br><span class="line"></span><br><span class="line"># 2: load balance, select the max free space group to upload file</span><br><span class="line"></span><br><span class="line">store_lookup=1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which group to upload file</span><br><span class="line"></span><br><span class="line"># when store_lookup set to 1, must set store_group to the group name</span><br><span class="line"></span><br><span class="line">store_group=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which storage server to upload file</span><br><span class="line"></span><br><span class="line"># 0: round robin (default)</span><br><span class="line"></span><br><span class="line"># 1: the first server order by ip address</span><br><span class="line"></span><br><span class="line"># 2: the first server order by priority (the minimal)</span><br><span class="line"></span><br><span class="line">store_server=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which path(means disk or mount point) of the storage server to upload file</span><br><span class="line"></span><br><span class="line"># 0: round robin</span><br><span class="line"></span><br><span class="line"># 2: load balance, select the max free space path to upload file</span><br><span class="line"></span><br><span class="line">store_path=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which storage server to download file</span><br><span class="line"></span><br><span class="line"># 0: round robin (default)</span><br><span class="line"></span><br><span class="line"># 1: the source storage server which the current file uploaded to</span><br><span class="line"></span><br><span class="line">download_server=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># reserved storage space for system or other applications.</span><br><span class="line"></span><br><span class="line"># if the free(available) space of any stoarge server in</span><br><span class="line"></span><br><span class="line"># a group &lt;= reserved_storage_space,</span><br><span class="line"></span><br><span class="line"># no file can be uploaded to this group.</span><br><span class="line"></span><br><span class="line"># bytes unit can be one of follows:</span><br><span class="line"></span><br><span class="line">### G or g for gigabyte(GB)</span><br><span class="line"></span><br><span class="line">### M or m for megabyte(MB)</span><br><span class="line"></span><br><span class="line">### K or k for kilobyte(KB)</span><br><span class="line"></span><br><span class="line">### no unit for byte(B)</span><br><span class="line"></span><br><span class="line">### XX.XX% as ratio such as reserved_storage_space = 10%</span><br><span class="line"></span><br><span class="line">reserved_storage_space = 10%</span><br></pre></td></tr></table></figure>



<h3 id="ï¼ˆ4ï¼‰171-storage-conf-é…ç½®"><a href="#ï¼ˆ4ï¼‰171-storage-conf-é…ç½®" class="headerlink" title="ï¼ˆ4ï¼‰171 storage.conf é…ç½®"></a>ï¼ˆ4ï¼‰171 storage.conf é…ç½®</h3><p><strong>171 storage æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the name of the group this storage server belongs to</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># comment or remove this item for fetching from tracker server,</span><br><span class="line"></span><br><span class="line"># in this case, use_storage_id must set to true in tracker.conf,</span><br><span class="line"></span><br><span class="line"># and storage_ids.conf must be configed correctly.</span><br><span class="line"></span><br><span class="line">group_name=group0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the storage server port</span><br><span class="line"></span><br><span class="line">port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1</span><br><span class="line"></span><br><span class="line">store_path_count=1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path</span><br><span class="line"></span><br><span class="line"># the paths must be exist</span><br><span class="line"></span><br><span class="line">store_path0=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># tracker_server can ocur more than once, and tracker_server format is</span><br><span class="line"></span><br><span class="line">#  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the priority as a source server for uploading file.</span><br><span class="line"></span><br><span class="line"># the lower this value, the higher its uploading priority.</span><br><span class="line"></span><br><span class="line"># default value is 10</span><br><span class="line"></span><br><span class="line">upload_priority=10</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ5ï¼‰171-fastdfs-nginx-module-é…ç½®å‚æ•°-ï¼ˆmod-fastdfs-confï¼‰"><a href="#ï¼ˆ5ï¼‰171-fastdfs-nginx-module-é…ç½®å‚æ•°-ï¼ˆmod-fastdfs-confï¼‰" class="headerlink" title="ï¼ˆ5ï¼‰171 fastdfs_nginx_module é…ç½®å‚æ•° ï¼ˆmod_fastdfs.confï¼‰"></a>ï¼ˆ5ï¼‰171 fastdfs_nginx_module é…ç½®å‚æ•° ï¼ˆmod_fastdfs.confï¼‰</h3><p><strong>171 mod_fastdfs.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the base path to store log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if load FastDFS parameters from tracker server # since V1.12 # default value is false</span><br><span class="line"></span><br><span class="line">load_fdfs_parameters_from_tracker=true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># FastDFS tracker_server can ocur more than once, and tracker_server format is</span><br><span class="line"></span><br><span class="line">#  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line"># valid only when load_fdfs_parameters_from_tracker is true</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the port of the local storage server # the default value is 23000</span><br><span class="line"></span><br><span class="line">storage_server_port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the group name of the local storage server group_name=group0</span><br><span class="line"></span><br><span class="line"># if the url / uri including the group name # set to false when uri like /M00/00/00/xxx # set to true when uri like $&#123;group_name&#125;/M00/00/00/xxx, such as group1/M00/xxx # default value is false</span><br><span class="line"></span><br><span class="line">url_have_group_name = true</span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 # must same as storage.conf store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path # the paths must be exist # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path0=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># set the group count # set to none zero to support multi-group</span><br><span class="line"></span><br><span class="line"># set to 0  for single group only</span><br><span class="line"></span><br><span class="line"># groups settings section as [group1], [group2], ..., [groupN]</span><br><span class="line"></span><br><span class="line"># default value is 0 # since v1.14</span><br><span class="line"></span><br><span class="line">group_count = 0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># group settings for group #1 # since v1.14</span><br><span class="line"></span><br><span class="line"># when support multi-group, uncomment following section</span><br><span class="line"></span><br><span class="line">#[group1] #group_name=group1 #storage_server_port=23000</span><br><span class="line"></span><br><span class="line">#store_path_count=2</span><br><span class="line"></span><br><span class="line">#store_path0=/home/yuqing/fastdfs</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># group settings for group #2</span><br><span class="line"></span><br><span class="line"># since v1.14</span><br><span class="line"></span><br><span class="line"># when support multi-group, uncomment following section as neccessary</span><br><span class="line"></span><br><span class="line">#[group2] #group_name=group2</span><br><span class="line"></span><br><span class="line">#storage_server_port=23000</span><br><span class="line"></span><br><span class="line">#store_path_count=1</span><br><span class="line"></span><br><span class="line">#store_path0=/home/yuqing/fastdfs</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ6ï¼‰171-nginx-å‚æ•°é…ç½®-nginx-conf"><a href="#ï¼ˆ6ï¼‰171-nginx-å‚æ•°é…ç½®-nginx-conf" class="headerlink" title="ï¼ˆ6ï¼‰171 nginx å‚æ•°é…ç½® nginx.conf"></a>ï¼ˆ6ï¼‰171 nginx å‚æ•°é…ç½® nginx.conf</h3><p><strong>171 nginx.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œè¯¦è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">events &#123;</span><br><span class="line"></span><br><span class="line">    worker_connections  1024;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;    </span><br><span class="line"></span><br><span class="line">    include       mime.types;    </span><br><span class="line"></span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;    </span><br><span class="line"></span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">        #keepalive_timeout  0;    </span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">        #gzip  on;</span><br><span class="line"></span><br><span class="line">    # 192.168.0.164 storage group2 </span><br><span class="line"></span><br><span class="line">    upstream fdfs_group2_164 &#123; </span><br><span class="line"></span><br><span class="line">        server 192.168.0.164:8288 weight=1 max_fails=2 fail_timeout=30s; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    server &#123;        </span><br><span class="line"></span><br><span class="line">        listen       8070;        </span><br><span class="line"></span><br><span class="line">        server_name  localhost,192.168.0.171;</span><br><span class="line"></span><br><span class="line">            #charset koi8-r;</span><br><span class="line"></span><br><span class="line">            #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">            location / &#123;            </span><br><span class="line"></span><br><span class="line">            root   html;            </span><br><span class="line"></span><br><span class="line">            max_ranges 1;            </span><br><span class="line"></span><br><span class="line">            index  index.html index.htm;        </span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location /group0/M00&#123;            </span><br><span class="line"></span><br><span class="line">            root /data/fastdfs/storage/data;            </span><br><span class="line"></span><br><span class="line">            ngx_fastdfs_module;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;OPTIONS&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;               </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Content-Type&#x27; &#x27;text/plain charset=UTF-8&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Content-Length&#x27; 0;                </span><br><span class="line"></span><br><span class="line">                return 204;              &#125;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;POST&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;              &#125;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;GET&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Accept-Ranges, Content-Encoding, Content-Length, Content-Range&#x27;;              &#125;      </span><br><span class="line"></span><br><span class="line">            if ($arg_attname ~* \.(doc|docx|txt|pdf|zip|rar|txt|jpg|png|gif|bmp)$) &#123;</span><br><span class="line"></span><br><span class="line">                add_header &quot;Content-Disposition&quot; &quot;attachment;filename=$arg_attname&quot;;</span><br><span class="line"></span><br><span class="line">                    &#125;        </span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location ~* /group2/(M00|M01) &#123;  </span><br><span class="line"></span><br><span class="line">                proxy_next_upstream http_502 http_504 error timeout invalid_header; </span><br><span class="line"></span><br><span class="line">                proxy_pass http://fdfs_group2_164;</span><br><span class="line"></span><br><span class="line">                expires 30d; </span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">         error_page   500 502 503 504  /50x.html;        </span><br><span class="line"></span><br><span class="line">        location = /50x.html &#123;             root   html;         &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ7ï¼‰164-storageå‚æ•°é…ç½®"><a href="#ï¼ˆ7ï¼‰164-storageå‚æ•°é…ç½®" class="headerlink" title="ï¼ˆ7ï¼‰164 storageå‚æ•°é…ç½®"></a>ï¼ˆ7ï¼‰164 storageå‚æ•°é…ç½®</h3><p><strong>164 storage.con æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the name of the group this storage server belongs to # # comment or remove this item for fetching from tracker server, # in this case, use_storage_id must set to true in tracker.conf,</span><br><span class="line"></span><br><span class="line"># and storage_ids.conf must be configed correctly.</span><br><span class="line"></span><br><span class="line">group_name=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the storage server</span><br><span class="line"></span><br><span class="line"> port port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path # the paths must be exist</span><br><span class="line"></span><br><span class="line">store_path0=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># tracker_server can ocur more than once, and tracker_server format is #  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the priority as a source server for uploading file. # the lower this value, the higher its uploading priority. # default value is 10</span><br><span class="line"></span><br><span class="line">upload_priority=10</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ8ï¼‰-164-fastdfs-nginx-module-å‚æ•°é…ç½®-ï¼ˆmod-fastdfs-confï¼‰"><a href="#ï¼ˆ8ï¼‰-164-fastdfs-nginx-module-å‚æ•°é…ç½®-ï¼ˆmod-fastdfs-confï¼‰" class="headerlink" title="ï¼ˆ8ï¼‰ 164 fastdfs_nginx_module å‚æ•°é…ç½® ï¼ˆmod_fastdfs.confï¼‰"></a>ï¼ˆ8ï¼‰ 164 fastdfs_nginx_module å‚æ•°é…ç½® ï¼ˆmod_fastdfs.confï¼‰</h3><p><strong>164 mod_fastdfs.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the base path to store log files</span><br><span class="line"></span><br><span class="line">base_path=/usr/local/fastdfs/</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if load FastDFS parameters from tracker server # since V1.12 # default value is false</span><br><span class="line"></span><br><span class="line">load_fdfs_parameters_from_tracker=true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># FastDFS tracker_server can ocur more than once, and tracker_server format is #  &quot;host:port&quot;, host can be hostname or ip address # valid only when load_fdfs_parameters_from_tracker is true tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"># the port of the local storage server # the default value is 23000</span><br><span class="line"></span><br><span class="line">storage_server_port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the group name of the local storage server</span><br><span class="line"></span><br><span class="line">group_name=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if the url / uri including the group name</span><br><span class="line"></span><br><span class="line"># set to false when uri like /M00/00/00/xxx</span><br><span class="line"></span><br><span class="line"># set to true when uri like $&#123;group_name&#125;/M00/00/00/xxx, such as group1/M00/xxx</span><br><span class="line"></span><br><span class="line"># default value is false</span><br><span class="line"></span><br><span class="line">url_have_group_name = true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path</span><br><span class="line"></span><br><span class="line"># the paths must be exist # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path0=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># set the group count # set to none zero to support multi-group</span><br><span class="line"></span><br><span class="line"># set to 0  for single group only</span><br><span class="line"></span><br><span class="line"># groups settings section as [group1], [group2], ..., [groupN]</span><br><span class="line"></span><br><span class="line"># default value is 0 # since v1.14</span><br><span class="line"></span><br><span class="line">group_count = 0</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ9ï¼‰164-nginxå‚æ•°é…ç½®ï¼Œnginx-conf"><a href="#ï¼ˆ9ï¼‰164-nginxå‚æ•°é…ç½®ï¼Œnginx-conf" class="headerlink" title="ï¼ˆ9ï¼‰164 nginxå‚æ•°é…ç½®ï¼Œnginx.conf"></a>ï¼ˆ9ï¼‰164 nginxå‚æ•°é…ç½®ï¼Œnginx.conf</h3><p><strong>164 nginx.conf å‚æ•°é…ç½®ï¼Œè¯¦è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user  www  www;</span><br><span class="line"></span><br><span class="line">worker_processes  12;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line"></span><br><span class="line">    worker_connections  1024;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    include       mime.types;</span><br><span class="line"></span><br><span class="line">     default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">       client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen       8288;</span><br><span class="line"></span><br><span class="line">        server_name  192.168.0.164,localhost;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location /group2/M00/&#123;</span><br><span class="line"></span><br><span class="line">            root /usr/local/fastdfs/fdfs_storage/data;</span><br><span class="line"></span><br><span class="line">             ngx_fastdfs_module;</span><br><span class="line"></span><br><span class="line">        if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Content-Type&#x27; &#x27;text/plain charset=UTF-8&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Content-Length&#x27; 0;</span><br><span class="line"></span><br><span class="line">                 return 204;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             if ($request_method = &#x27;POST&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             if ($request_method = &#x27;GET&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Accept-Ranges, Content-Encoding, Content-Length, Content-Range&#x27;;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                if ($arg_attname ~* \.(doc|docx|txt|pdf|zip|rar|txt|jpg|png|gif|bmp)$) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &quot;Content-Disposition&quot; &quot;attachment;filename=$arg_attname&quot;;</span><br><span class="line"></span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">         &#125;  </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker"><a href="#4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker" class="headerlink" title="4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker"></a><strong>4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker</strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170807597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>shiroä½¿ç”¨</title>
    <url>/2021/07/12/shiro%E4%BD%BF%E7%94%A8-shiro%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="shiro"><a href="#shiro" class="headerlink" title="shiro"></a>shiro</h1><h2 id="ä¸€ã€shiroæ˜¯ä»€ä¹ˆ"><a href="#ä¸€ã€shiroæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸€ã€shiroæ˜¯ä»€ä¹ˆ?"></a>ä¸€ã€shiroæ˜¯ä»€ä¹ˆ?</h2><p>â€‹	 Shiroæ˜¯Apacheä¸‹çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚shiroå±äºè½»é‡çº§æ¡†æ¶ï¼Œç›¸å¯¹äºSpringSecurityç®€å•çš„å¤šï¼Œä¹Ÿæ²¡æœ‰SpringSecurityé‚£ä¹ˆå¤æ‚ ã€‚</p>
<h2 id="äºŒã€ä¸»è¦åŠŸèƒ½"><a href="#äºŒã€ä¸»è¦åŠŸèƒ½" class="headerlink" title="äºŒã€ä¸»è¦åŠŸèƒ½"></a>äºŒã€ä¸»è¦åŠŸèƒ½</h2><h3 id="shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š"><a href="#shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š" class="headerlink" title="shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š"></a>shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š</h3><h6 id="1-Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚"><a href="#1-Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚" class="headerlink" title="1. Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚"></a>1. Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚</h6><h6 id="2-SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚-ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet"><a href="#2-SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚-ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet" class="headerlink" title="2. SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚(ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet)"></a>2. SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚(ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet)</h6><h6 id="3-Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚"><a href="#3-Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚" class="headerlink" title="3. Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚"></a>3. Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚</h6><h3 id="ç»†åˆ†åŠŸèƒ½"><a href="#ç»†åˆ†åŠŸèƒ½" class="headerlink" title="ç»†åˆ†åŠŸèƒ½"></a>ç»†åˆ†åŠŸèƒ½</h3><h6 id="1-Authenticationï¼šèº«ä»½è®¤è¯-x2F-ç™»å½•-è´¦å·å¯†ç éªŒè¯-ã€‚"><a href="#1-Authenticationï¼šèº«ä»½è®¤è¯-x2F-ç™»å½•-è´¦å·å¯†ç éªŒè¯-ã€‚" class="headerlink" title="1. Authenticationï¼šèº«ä»½è®¤è¯&#x2F;ç™»å½•(è´¦å·å¯†ç éªŒè¯)ã€‚"></a>1. Authenticationï¼šèº«ä»½è®¤è¯&#x2F;ç™»å½•(è´¦å·å¯†ç éªŒè¯)ã€‚</h6><h6 id="2-Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚"><a href="#2-Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚" class="headerlink" title="2. Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚"></a>2. Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚</h6><h6 id="3-Session-Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚"><a href="#3-Session-Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚" class="headerlink" title="3. Session Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚"></a>3. Session Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚</h6><h6 id="4-Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚"><a href="#4-Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚" class="headerlink" title="4. Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚"></a>4. Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚</h6><h6 id="5-Web-Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚"><a href="#5-Web-Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚" class="headerlink" title="5. Web Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚"></a>5. Web Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚</h6><h6 id="6-Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚"><a href="#6-Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚" class="headerlink" title="6. Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚"></a>6. Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚</h6><h6 id="7-Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚"><a href="#7-Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚" class="headerlink" title="7. Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚"></a>7. Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚</h6><h6 id="8-Testingï¼šæµ‹è¯•æ”¯æŒï¼›"><a href="#8-Testingï¼šæµ‹è¯•æ”¯æŒï¼›" class="headerlink" title="8. Testingï¼šæµ‹è¯•æ”¯æŒï¼›"></a>8. Testingï¼šæµ‹è¯•æ”¯æŒï¼›</h6><h6 id="9-Run-Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚"><a href="#9-Run-Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚" class="headerlink" title="9. Run Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚"></a>9. Run Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚</h6><h6 id="10-Remember-Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†"><a href="#10-Remember-Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†" class="headerlink" title="10. Remember Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†"></a>10. Remember Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†</h6><h3 id="ä¸‰ã€å…·ä½“å®ç°"><a href="#ä¸‰ã€å…·ä½“å®ç°" class="headerlink" title="ä¸‰ã€å…·ä½“å®ç°"></a>ä¸‰ã€å…·ä½“å®ç°</h3><h3 id="1ã€é¡¹ç›®ç›®å½•"><a href="#1ã€é¡¹ç›®ç›®å½•" class="headerlink" title="1ã€é¡¹ç›®ç›®å½•"></a>1ã€é¡¹ç›®ç›®å½•</h3><p><img src="/2021/07/12/shiro%E4%BD%BF%E7%94%A8-shiro%E4%BD%BF%E7%94%A8/1604471130107-03fd3901e8644ec985962a56e1d4f28d.png" alt="1604471130107.png"></p>
<h3 id="pom-xmlä¾èµ–æ–‡ä»¶"><a href="#pom-xmlä¾èµ–æ–‡ä»¶" class="headerlink" title="pom.xmlä¾èµ–æ–‡ä»¶"></a>pom.xmlä¾èµ–æ–‡ä»¶</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.shiro.version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">spring.shiro.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- shiro --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é¡µé¢æ¨¡æ¿ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--çƒ­éƒ¨ç½²ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Permissionsæƒé™å®ä½“ç±»"><a href="#Permissionsæƒé™å®ä½“ç±»" class="headerlink" title="Permissionsæƒé™å®ä½“ç±»"></a>Permissionsæƒé™å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Permissions</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String permissionsName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Roleè§’è‰²å®ä½“"><a href="#Roleè§’è‰²å®ä½“" class="headerlink" title="Roleè§’è‰²å®ä½“"></a>Roleè§’è‰²å®ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§’è‰²å¯¹åº”æƒé™é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Permissions&gt; permissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Userå®ä½“"><a href="#Userå®ä½“" class="headerlink" title="Userå®ä½“"></a>Userå®ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Role&gt; roles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“"><a href="#ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“" class="headerlink" title="ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“"></a>ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.Permissions;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.Role;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.example.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByName</span><span class="params">(String getMapByName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getMapByName(getMapByName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> User</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">getMapByName</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">Permissions</span> <span class="variable">permissions1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Permissions</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;query&quot;</span>);</span><br><span class="line">        <span class="type">Permissions</span> <span class="variable">permissions2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Permissions</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">        Set&lt;Permissions&gt; permissionsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        permissionsSet.add(permissions1);</span><br><span class="line">        permissionsSet.add(permissions2);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">role</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Role</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;admin&quot;</span>, permissionsSet);</span><br><span class="line">        Set&lt;Role&gt; roleSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        roleSet.add(role);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;wsl&quot;</span>, <span class="string">&quot;123456&quot;</span>, roleSet);</span><br><span class="line">        Map&lt;String, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(user.getUserName(), user);</span><br><span class="line"></span><br><span class="line">        Set&lt;Permissions&gt; permissionsSet1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        permissionsSet1.add(permissions1);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">role1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Role</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;user&quot;</span>, permissionsSet1);</span><br><span class="line">        Set&lt;Role&gt; roleSet1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        roleSet1.add(role1);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;123456&quot;</span>, roleSet1);</span><br><span class="line">        map.put(user1.getUserName(), user1);</span><br><span class="line">        <span class="keyword">return</span> map.get(userName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»"><a href="#CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»" class="headerlink" title="CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»"></a>CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.example.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æƒé™æ§åˆ¶ä»¥åŠæƒé™è®¤è¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™é…ç½®ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principalCollection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰ç™»å½•ç”¨æˆ·å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> principalCollection.getPrimaryPrincipal().toString();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginService.getUserByName(userName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ·»åŠ è§’è‰²å’Œæƒé™</span></span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">simpleAuthorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        user.getRoles().forEach(role -&gt; &#123;</span><br><span class="line">            simpleAuthorizationInfo.addRole(role.getRoleName());</span><br><span class="line">            role.getPermissions().forEach(permission -&gt; simpleAuthorizationInfo.addStringPermission(permission.getPermissionsName()));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™è®¤è¯ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">username</span> <span class="operator">=</span> authenticationToken.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> username.toString();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginService.getUserByName(name);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œè¿”å›åä¼šæŠ¥å‡ºå¯¹åº”å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡ŒéªŒè¯authenticationTokenå’ŒsimpleAuthenticationInfoçš„ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(name, user.getPassword(), getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="shiroé…ç½®ç±»"><a href="#shiroé…ç½®ç±»" class="headerlink" title="shiroé…ç½®ç±»"></a>shiroé…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.example.shiro.CustomRealm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shiroå…·ä½“é…ç½®ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">defaultAAP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">        defaultAAP.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAAP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†è‡ªå·±çš„éªŒè¯æ–¹å¼åŠ å…¥å®¹å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomRealm <span class="title function_">myShiroRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomRealm</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™ç®¡ç†ï¼Œé…ç½®ä¸»è¦æ˜¯Realmçš„ç®¡ç†è®¤è¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Filterå·¥å‚ï¼Œè®¾ç½®å¯¹åº”çš„è¿‡æ»¤æ¡ä»¶å’Œè·³è½¬æ¡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//ç™»å‡º</span></span><br><span class="line">        map.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">        <span class="comment">//å¯¹æ‰€æœ‰ç”¨æˆ·è®¤è¯</span></span><br><span class="line">        map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        <span class="comment">//ç™»å½•</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="comment">//é¦–é¡µ</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="comment">//é”™è¯¯é¡µé¢ï¼Œè®¤è¯ä¸é€šè¿‡è·³è½¬</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/error&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(map);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">authorizationAttributeSourceAdvisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»"><a href="#ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»" class="headerlink" title="ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»"></a>ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ErrorHandler</span><span class="params">(AuthorizationException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ²¡æœ‰é€šè¿‡æƒé™éªŒè¯ï¼&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ²¡æœ‰é€šè¿‡æƒé™éªŒè¯ï¼&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresPermissions;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresRoles;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(user.getUserName()) || StringUtils.isEmpty(user.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç”¨æˆ·è®¤è¯ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">usernamePasswordToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(</span><br><span class="line">                user.getUserName(),</span><br><span class="line">                user.getPassword()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è¿›è¡ŒéªŒè¯ï¼Œè¿™é‡Œå¯ä»¥æ•è·å¼‚å¸¸ï¼Œç„¶åè¿”å›å¯¹åº”ä¿¡æ¯</span></span><br><span class="line">            subject.login(usernamePasswordToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·åä¸å­˜åœ¨ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ç”¨æˆ·åä¸å­˜åœ¨ï¼&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯ï¼&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthorizationException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æ²¡æœ‰æƒé™ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;æ²¡æœ‰æƒé™&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresRoles(&quot;admin&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;query&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;add&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;add success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æƒé™</category>
      </categories>
      <tags>
        <tag>æƒé™</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†</title>
    <url>/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/</url>
    <content><![CDATA[<h1 id="springboot-ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†"><a href="#springboot-ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†" class="headerlink" title="springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†"></a>springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†</h1><p>å‰è¨€ï¼šéšç€å‰åç«¯åˆ†ç¦»è¿™ç§æ¨¡å¼çš„è¶‹åŠ¿ä¸‹ï¼Œåç«¯å¼€å‘äººå‘˜æ›´æ³¨é‡åç«¯æ–¹é¢çš„ä»£ç ï¼Œä½†æ˜¯å¯¹åç«¯äººå‘˜åœ¨ä»£ç ç¼–å†™çš„è¿‡ç¨‹å½“ä¸­éœ€è¦è¶Šæ¥è¶Šè§„èŒƒï¼Œè¿™æ ·ä¸ä»…å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œæ›´å¯ä»¥è®©ä»£ç åæœŸç»´æŠ¤èµ·æ¥æ›´åŠ çš„æ–¹ä¾¿ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å½“æ¥å£è¿”å›çš„ç»Ÿä¸€å¤„ç†ï¼Œèƒ½å¤Ÿè®©å‰ç«¯äººå‘˜æœ‰ä¸ªç»Ÿä¸€çš„æ¥æ”¶åå°çš„æ¥å£è¿”å›ã€‚</p>
<h2 id="1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç "><a href="#1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç " class="headerlink" title="1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç "></a>1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰çŠ¶æ€ç æšä¸¾</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultCode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC200(<span class="number">200</span>, <span class="string">&quot;æ“ä½œæˆåŠŸ&quot;</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ“ä½œå¤±è´¥</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC900(<span class="number">900</span>, <span class="string">&quot;æ“ä½œå¤±è´¥&quot;</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC500(<span class="number">500</span>, <span class="string">&quot;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰æè¿°</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultCode(<span class="type">int</span> code, String message) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å¯ä»¥å®šä¹‰å®šä¹‰ä¸€äº›å…¶ä»–çŠ¶æ€ç ï¼Œå¯ä»¥è®©å‰ç«¯æ ¹æ®ä¸åŒçš„çŠ¶æ€ç è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œè¿™é‡Œåªå®šä¹‰éƒ¨åˆ†å¸¸ç”¨çŠ¶æ€ç ã€‚</p>
<h2 id="2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»"><a href="#2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»" class="headerlink" title="2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»"></a>2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ç»“æœåŒ…è£…ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResultData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›çš„ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰ç»“æœè¿”å›å€¼æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC200.getCode());</span><br><span class="line">        resultData.setMessage(ResultCode.RC200.getMessage());</span><br><span class="line">        resultData.setData(data);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— ç»“æœè¿”å›å€¼æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC200.getCode());</span><br><span class="line">        resultData.setMessage(ResultCode.RC200.getMessage());</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰çŠ¶æ€ç çš„å¤±è´¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message å¤±è´¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">fail</span><span class="params">(<span class="type">int</span> code, String message)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(code);</span><br><span class="line">        resultData.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— çŠ¶æ€ç çš„å¤±è´¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message å¤±è´¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">fail</span><span class="params">( String message)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC999.getCode());</span><br><span class="line">        resultData.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªå°è£…çš„éƒ¨åˆ†æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å°è£…ä¸åŒæ–¹æ³•ã€‚</p>
<p><strong>å†™ä¸€ä¸ªç®€å•çš„è¯·æ±‚demo</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getHi&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">getHi</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ResultData.success(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›ç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/1.png"></p>
<p><strong>æ¨¡æ‹Ÿä¸€ä¸ªæœåŠ¡å™¨çš„å¼‚å¸¸</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getHi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">getHi</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/2.png" alt="2"></p>
<p>è¿™ç§è¿”å›ç»“æœè‚¯å®šä¸æ˜¯å‰ç«¯å¼€å‘äººå‘˜æƒ³å¤„ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å¯¹æœåŠ¡ç«¯å¦‚æœå‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¹Ÿéœ€è¦å¤„ç†ç»Ÿä¸€çš„è¿”å›æ ¼å¼ã€‚</p>
<h2 id="3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†"><a href="#3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†" class="headerlink" title="3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†"></a>3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ä¹‰åŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BizException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResultCode resultCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BizException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BizException</span><span class="params">(ResultCode resultCode)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(resultCode.getMessage());</span><br><span class="line">        <span class="built_in">this</span>.resultCode = resultCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultData;</span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¨å±€ç»Ÿä¸€å¼‚å¸¸å¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResultData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(BizException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.EXPECTATION_FAILED)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">exception</span><span class="params">(BizException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å…¨å±€å¼‚å¸¸ä¿¡æ¯ e=&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResultData.fail(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é»˜è®¤å…¨å±€å¼‚å¸¸å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResultData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å…¨å±€å¼‚å¸¸ä¿¡æ¯ e=&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResultData.fail(ResultCode.RC500.getCode(),e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿è¡Œç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/3.png" alt="3"></p>
<p>èƒ½å¤Ÿæ­£ç¡®çš„è¿”å›ã€‚</p>
<p>å½“æ—¶å›å¤´ä¸€æƒ³ï¼Œç»Ÿä¸€å¤„ç†ä½†æ˜¯æ¯æ¬¡è¿”å›ç»“æœçš„æ—¶å€™è‡ªå·±éƒ½å¾—é‡å¤æ‰‹åŠ¨åŒ…è£…ä¸€ä¸‹è‡ªå®šä¹‰çš„ç±»ï¼Œè¿™æ ·å¯ä»¥ç”¨ä»£ç æ¥å¤„ç†ï¼Œæ‰€ä»¥ä¸‹é¢å®ç°è‡ªåŠ¨åŒ…è£…è¿”å›çš„ç»“æœã€‚</p>
<h2 id="4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»"><a href="#4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»" class="headerlink" title="4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»"></a>4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultData;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿä¸€åŒ…è£…è¿”å›ç»“æœ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseAdvice</span> <span class="keyword">implements</span> <span class="title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(MethodParameter methodParameter, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="comment">//è¿”å›trueåˆ™å¯¹è¿”å›å€¼éœ€è¦å¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥å£è¿”å›å‰åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">beforeBodyWrite</span><span class="params">(Object o, MethodParameter methodParameter, MediaType mediaType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse)</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯Stringç±»å‹ï¼Œè½¬ä¸ºjson</span></span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.writeValueAsString(ResultData.success(o));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå¼‚å¸¸ã€æ–‡ä»¶å½¢å¼ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ResultData || o <span class="keyword">instanceof</span> Resource ) &#123;</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†™ä¸ªdemoæµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;getWorld&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Order <span class="title function_">getWorld</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>,<span class="string">&quot;è´­ç‰©è½¦&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/getError&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Order <span class="title function_">getError</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;å¤±è´¥äº†&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›ç»“æœï¼š</p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/5.png" alt="5"><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/6.png" alt="6"></p>
<p>è¿™æ ·å°±å¯ä»¥ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å€¼çš„å¤„ç†ã€‚</p>
<h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„:"></a>æ³¨æ„:</h3><p>ç‰¹åˆ«æ³¨æ„è¿™ä¸ªç±»çš„åˆ¤æ–­ï¼ï¼ï¼</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot+mybatis_pluså®ç°è¯»å†™åˆ†ç¦»</title>
    <url>/2021/10/10/springboot+mybatis_plus%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-springbootmybatisplus%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
    <content><![CDATA[<h3 id="1ã€å¼•è¨€"><a href="#1ã€å¼•è¨€" class="headerlink" title="1ã€å¼•è¨€"></a>1ã€å¼•è¨€</h3><p>è¯»å†™åˆ†ç¦»è¦åšçš„äº‹æƒ…å°±æ˜¯å¯¹äºä¸€æ¡SQLè¯¥é€‰æ‹©å“ªä¸ªæ•°æ®åº“å»æ‰§è¡Œï¼Œè‡³äºè°æ¥åšé€‰æ‹©æ•°æ®åº“è¿™ä»¶äº‹å„¿ï¼Œæ— éä¸¤ä¸ªï¼Œè¦ä¹ˆä¸­é—´ä»¶å¸®æˆ‘ä»¬åšï¼Œè¦ä¹ˆç¨‹åºè‡ªå·±åšã€‚</p>
<p>å› æ­¤ï¼Œä¸€èˆ¬æ¥è®²ï¼Œè¯»å†™åˆ†ç¦»æœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯ä¾é ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ï¼šMyCatï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´åº”ç”¨ç¨‹åºè¿æ¥åˆ°ä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶å¸®æˆ‘ä»¬åšSQLåˆ†ç¦»ï¼›ç¬¬äºŒç§æ˜¯åº”ç”¨ç¨‹åºè‡ªå·±å»åšåˆ†ç¦»ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç¨‹åºè‡ªå·±æ¥åšï¼Œä¸»è¦æ˜¯åˆ©ç”¨Springæä¾›çš„è·¯ç”±æ•°æ®æºï¼Œä»¥åŠAOP</p>
<p>ç„¶è€Œï¼Œåº”ç”¨ç¨‹åºå±‚é¢å»åšè¯»å†™åˆ†ç¦»æœ€å¤§çš„å¼±ç‚¹ï¼ˆä¸è¶³ä¹‹å¤„ï¼‰åœ¨äºæ— æ³•åŠ¨æ€å¢åŠ æ•°æ®åº“èŠ‚ç‚¹ï¼Œå› ä¸ºæ•°æ®æºé…ç½®éƒ½æ˜¯å†™åœ¨é…ç½®ä¸­çš„ï¼Œæ–°å¢æ•°æ®åº“æ„å‘³ç€æ–°åŠ ä¸€ä¸ªæ•°æ®æºï¼Œå¿…ç„¶æ”¹é…ç½®ï¼Œå¹¶é‡å¯åº”ç”¨ã€‚å½“ç„¶ï¼Œå¥½å¤„å°±æ˜¯ç›¸å¯¹ç®€å•ã€‚</p>
<h4 id="1-1é¡¹ç›®åœ°å€"><a href="#1-1é¡¹ç›®åœ°å€" class="headerlink" title="1.1é¡¹ç›®åœ°å€"></a>1.1é¡¹ç›®åœ°å€</h4><p><strong>git-hub</strong>:<a href="https://github.com/wenlinshan/wenlinshan/tree/main/master-slave-demo">https://github.com/wenlinshan/wenlinshan/tree/main/master-slave-demo</a></p>
<h3 id="2ã€AbstractRoutingDataSource"><a href="#2ã€AbstractRoutingDataSource" class="headerlink" title="2ã€AbstractRoutingDataSource"></a>2ã€AbstractRoutingDataSource</h3><p>åŸºäºç‰¹å®šçš„æŸ¥æ‰¾keyè·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®æºã€‚å®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„ç›®æ ‡æ•°æ®æºï¼Œå¹¶ä¸”åšäº†è·¯ç”±keyä¸ç›®æ ‡æ•°æ®æºä¹‹é—´çš„æ˜ å°„ï¼Œæä¾›åŸºäºkeyæŸ¥æ‰¾æ•°æ®æºçš„æ–¹æ³•ã€‚</p>
<h3 id="3ã€å®è·µ"><a href="#3ã€å®è·µ" class="headerlink" title="3ã€å®è·µ"></a>3ã€å®è·µ</h3><h4 id="3-1-mavenä¾èµ–"><a href="#3-1-mavenä¾èµ–" class="headerlink" title="3.1. mavenä¾èµ–"></a>3.1. mavenä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.wenlinshan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é©±åŠ¨--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- druid --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-2-æ•°æ®æºé…ç½®"><a href="#3-2-æ•°æ®æºé…ç½®" class="headerlink" title="3.2. æ•°æ®æºé…ç½®"></a>3.2. æ•°æ®æºé…ç½®</h4><p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#é…ç½®æ•°æ®æºï¼Œæ ¹æ®ä¸åŒåº“æ¨¡æ‹Ÿä¸»ä»åº“</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/m1?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">slave1:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/s1?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">slave2:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">wen</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/s2?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="comment"># å¦‚æœæ˜¯æ”¾åœ¨src/main/javaç›®å½•ä¸‹ classpath:/com/yourpackage/*/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="comment"># å¦‚æœæ˜¯æ”¾åœ¨resourceç›®å½• classpath:/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="comment">#å®ä½“æ‰«æï¼Œå¤šä¸ªpackageç”¨é€—å·æˆ–è€…åˆ†å·åˆ†éš”</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">com.seawatebt.ssm.entity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#é…ç½®è¿”å›æ•°æ®åº“(columnä¸‹åˆ’çº¿å‘½å&amp;&amp;è¿”å›javaå®ä½“æ˜¯é©¼å³°å‘½å)ï¼Œè‡ªåŠ¨åŒ¹é…æ— éœ€asï¼ˆæ²¡å¼€å¯è¿™ä¸ªï¼ŒSQLéœ€è¦å†™asï¼š select user_id as userIdï¼‰</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#é…ç½®JdbcTypeForNull, oracleæ•°æ®åº“å¿…é¡»é…ç½®</span></span><br><span class="line">    <span class="attr">jdbc-type-for-null:</span> <span class="string">&#x27;null&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-è®¾ç½®è·¯ç”±key-x2F-æŸ¥æ‰¾æ•°æ®æº"><a href="#3-3-è®¾ç½®è·¯ç”±key-x2F-æŸ¥æ‰¾æ•°æ®æº" class="headerlink" title="3.3. è®¾ç½®è·¯ç”±key &#x2F; æŸ¥æ‰¾æ•°æ®æº"></a>3.3. è®¾ç½®è·¯ç”±key &#x2F; æŸ¥æ‰¾æ•°æ®æº</h4><p>ç›®æ ‡æ•°æ®æºå°±æ˜¯é‚£å‰3ä¸ªè¿™ä¸ªæˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™æ˜¯å¦‚æœæŸ¥æ‰¾æ•°æ®æºçš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæšä¸¾æ¥ä»£è¡¨è¿™ä¸‰ä¸ªæ•°æ®æº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> æ•°æ®åº“ç±»å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DBTypeEnum</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MASTER,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SLAVE1,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SLAVE2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>æ–°å»ºDataSourceContextHolder</strong></p>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ThreadLocalå°†æ•°æ®æºè®¾ç½®åˆ°æ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.constant.DBTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ThreadLocalå°†æ•°æ®æºè®¾ç½®åˆ°æ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceContextHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DBTypeEnum&gt; CONTEXT_HOLDER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">COUNTER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(DBTypeEnum dbType)</span> &#123;</span><br><span class="line">        CONTEXT_HOLDER.set(dbType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DBTypeEnum <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT_HOLDER.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;</span><br><span class="line">        CONTEXT_HOLDER.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">master</span><span class="params">()</span> &#123;</span><br><span class="line">        set(DBTypeEnum.MASTER);</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°master&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">slave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//  è½®è¯¢</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> COUNTER.getAndIncrement() % <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (COUNTER.get() &gt; <span class="number">9999</span>) &#123;</span><br><span class="line">            COUNTER.set(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE1);</span><br><span class="line">            System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°slave1&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE2);</span><br><span class="line">            System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°slave2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®è·¯ç”±key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å£°æ˜è·¯ç”±æ•°æ®æºkey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRoutingDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceContextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>å¤šæ•°æ®æºé…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.constant.DBTypeEnum;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…³äºæ•°æ®æºé…ç½®ï¼Œå‚è€ƒSpringBootå®˜æ–¹æ–‡æ¡£ç¬¬79ç« ã€ŠData Accessã€‹</span></span><br><span class="line"><span class="comment"> * 79. Data Access</span></span><br><span class="line"><span class="comment"> * 79.1 Configure a Custom DataSource</span></span><br><span class="line"><span class="comment"> * 79.2 Configure Two DataSources</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä¸»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;master&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.master&quot; )</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;slave1&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.slave1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave1DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;slave2&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.slave2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave2DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®è·¯ç”±æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> masterDataSource ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slave1DataSource ä»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slave2DataSource ä»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">myRoutingDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;master&quot;)</span> DataSource masterDataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave1&quot;)</span> DataSource slave1DataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave2&quot;)</span> DataSource slave2DataSource)</span> &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.MASTER, masterDataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE1, slave1DataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE2, slave2DataSource);</span><br><span class="line">        <span class="type">MyRoutingDataSource</span> <span class="variable">myRoutingDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRoutingDataSource</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®é»˜è®¤æ•°æ®æº</span></span><br><span class="line">        myRoutingDataSource.setDefaultTargetDataSource(masterDataSource);</span><br><span class="line">        myRoutingDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="keyword">return</span> myRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬é…ç½®äº†4ä¸ªæ•°æ®æºï¼Œ1ä¸ªmasterï¼Œ2ä¸¤ä¸ªslaveï¼Œ1ä¸ªè·¯ç”±æ•°æ®æºã€‚å‰3ä¸ªæ•°æ®æºéƒ½æ˜¯ä¸ºäº†ç”Ÿæˆç¬¬4ä¸ªæ•°æ®æºï¼Œè€Œä¸”åç»­æˆ‘ä»¬åªç”¨è¿™æœ€åä¸€ä¸ªè·¯ç”±æ•°æ®æºã€‚</p>
<p><strong>MyBatisé…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.MybatisConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.omg.PortableInterceptor.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mybatis é…ç½®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;myRoutingDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> DataSource myRoutingDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MybatisSqlSessionFactoryBean</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBean</span>();</span><br><span class="line">        sqlSessionFactory.setDataSource(myRoutingDataSource);</span><br><span class="line">        <span class="type">MybatisConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisConfiguration</span>();</span><br><span class="line">        configuration.setJdbcTypeForNull(JdbcType.NULL);</span><br><span class="line">        configuration.setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">        configuration.setCacheEnabled(<span class="literal">false</span>);</span><br><span class="line">        sqlSessionFactory.setConfiguration(configuration);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">platformTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(myRoutingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºSpringå®¹å™¨ä¸­ç°åœ¨æœ‰4ä¸ªæ•°æ®æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºäº‹åŠ¡ç®¡ç†å™¨å’ŒMyBatisæ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªæ˜ç¡®çš„æ•°æ®æºã€‚</p>
<h4 id="3-4-ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢"><a href="#3-4-ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢" class="headerlink" title="3.4 ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢"></a>3.4 ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½èµ°ä»åº“ï¼Œæ’å…¥&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤èµ°ä¸»åº“ã€‚æˆ‘ä»¬é€šè¿‡æ–¹æ³•åæ¥åŒºåˆ†æ“ä½œç±»å‹ï¼ˆCRUDï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.config.DataSourceContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½®åˆ‡é¢ æ‰§è¡Œå…·ä½“æ–¹æ³•é€‰æ‹©çš„æ•°æ®æº</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAop</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éœ€è¦è¯»çš„æ–¹æ³•,åˆ‡é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;!@annotation(com.wenlinshan.masterslavedemo.annotation.Master)&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; (execution(* com.wenlinshan.masterslavedemo.service..*.select*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.get*(..)))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readPointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†™åˆ‡é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.wenlinshan.masterslavedemo.annotation.Master) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.insert*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.save*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.add*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.update*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.edit*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.delete*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.remove*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writePointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;readPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.slave();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;writePointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.master();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;readPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readAfter</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;writePointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeAfter</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€èˆ¬æƒ…å†µå°±æœ‰ç‰¹æ®Šæƒ…å†µï¼Œç‰¹æ®Šæƒ…å†µæ˜¯æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è¯»ä¸»åº“ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¸»é”®ï¼Œç”¨è¯¥æ³¨è§£æ ‡æ³¨çš„å°±è¯»ä¸»åº“</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.annotation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Master &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Goodsè¡¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;`name`&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;quantity&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_ID</span> <span class="operator">=</span> <span class="string">&quot;id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_NAME</span> <span class="operator">=</span> <span class="string">&quot;name&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_QUANTITY</span> <span class="operator">=</span> <span class="string">&quot;quantity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_PRICE</span> <span class="operator">=</span> <span class="string">&quot;price&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4ã€æµ‹è¯•"><a href="#4ã€æµ‹è¯•" class="headerlink" title="4ã€æµ‹è¯•"></a>4ã€æµ‹è¯•</h3><p><strong>service</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.annotation.Master;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.domain.Goods;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.mapper.GoodsMapper;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.service.GoodsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;GoodsMapper, Goods&gt; <span class="keyword">implements</span> <span class="title class_">GoodsService</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goods å•†å“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveGoods</span><span class="params">(Goods goods)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.save(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteGoods</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.removeById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Goods&gt; <span class="title function_">getGoodsAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å•ä¸ª</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å•†å“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Master</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Goods <span class="title function_">getGoodsById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>controller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.annotation.Master;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.domain.Goods;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.service.GoodsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.DeleteMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goods å•†å“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/saveGoods&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveGoods</span><span class="params">(Goods goods)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.saveGoods(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/deleteGoods&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteGoods</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.deleteGoods(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getGoodsAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Goods&gt; <span class="title function_">getGoodsAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.getGoodsAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å•ä¸ª</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å•†å“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;getGoodsById&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Goods <span class="title function_">getGoodsById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.getGoodsById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>springboot+redissonå®ç°åˆ†å¸ƒå¼é”</title>
    <url>/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/</url>
    <content><![CDATA[<h2 id="redisson-springboot-å®ç°åˆ†å¸ƒå¼é”"><a href="#redisson-springboot-å®ç°åˆ†å¸ƒå¼é”" class="headerlink" title="redisson+springboot å®ç°åˆ†å¸ƒå¼é”"></a>redisson+springboot å®ç°åˆ†å¸ƒå¼é”</h2><p>åœ¨ä¸€äº›åœºæ™¯æ—¶ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„ä¸é‡å¤ï¼Œä»¥åŠæ•°æ®çš„å‡†ç¡®æ€§ï¼Œç‰¹åˆ«æ˜¯ç‰¹å®šä¸‹ï¼ŒæŸäº›æ•°æ®çš„å‡†ç¡®æ€§æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™è¦ä¿è¯æŸä¸ªæ–¹æ³•åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚åœ¨å•æœºæƒ…å†µä¸‹å¯ä»¥ç”¨jdkçš„ä¹è§‚é”è¿›è¡Œä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ã€‚è€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™ç§jdkçš„é”å°±æ— æ³•æ»¡è¶³è¿™ç§åœºæ™¯ã€‚</p>
<p>æ‰€ä»¥éœ€è¦ä½¿ç”¨redssionå®ç°åˆ†å¸ƒå¼é”ï¼Œå®ƒä¸ä»…å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼Œä¹Ÿå¯ä»¥åœ¨æŸäº›æƒ…å†µä¸‹ä¿è¯ä¸é‡å¤æäº¤ï¼Œä¿è¯æ¥å£çš„å¹‚ç­‰æ€§ã€‚</p>
<p>redissonæ˜¯åŸºäºrediså®ç°çš„åˆ†å¸ƒå¼é”ï¼Œå› ä¸ºredisæ‰§è¡Œå‘½ä»¤æ“ä½œæ—¶æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–å®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚zkï¼ŒMongoDBç­‰ã€‚</p>
<h4 id="ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹"><a href="#ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹" class="headerlink" title="ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹"></a>ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹</h4><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°åŸç†</th>
<th>ä¼˜ç‚¹</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>MongoDB</td>
<td>1.åŠ é”ï¼šæ‰§è¡ŒfindAndModifyåŸå­å‘½ä»¤æŸ¥æ‰¾documentï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ–°å¢<br>2.è§£é”ï¼šåˆ é™¤document</td>
<td>å®ç°è¾ƒä¸ºç®€å•</td>
<td>1.å¤§éƒ¨åˆ†å…¬å¸æ•°æ®åº“ç”¨MySQLï¼Œå¯èƒ½ç¼ºä¹ç›¸åº”çš„MongoDBè¿ç»´ã€å¼€å‘äººå‘˜<br>2.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶</td>
</tr>
<tr>
<td>ZooKeepe</td>
<td>1.åŠ é”ï¼šåœ¨&#x2F;lockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼Œåˆ¤æ–­åˆ›å»ºçš„èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°ã€‚è‹¥æ˜¯ï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼›å¦ï¼Œåˆ™åˆ™watch &#x2F;lockç›®å½•ä¸‹åºå·æ¯”è‡ªèº«å°çš„å‰ä¸€ä¸ªèŠ‚ç‚¹<br>2.è§£é”ï¼šåˆ é™¤èŠ‚ç‚¹</td>
<td>1.ç”±zkä¿éšœç³»ç»Ÿé«˜å¯ç”¨<br>2.Curatoræ¡†æ¶å·²åŸç”Ÿæ”¯æŒç³»åˆ—åˆ†å¸ƒå¼é”å‘½ä»¤ï¼Œä½¿ç”¨ç®€å•</td>
<td>éœ€å•ç‹¬ç»´æŠ¤ä¸€å¥—zké›†ç¾¤ï¼Œç»´ä¿æˆæœ¬é«˜</td>
</tr>
<tr>
<td>redis</td>
<td>1. åŠ é”ï¼šæ‰§è¡Œsetnxï¼Œè‹¥æˆåŠŸå†æ‰§è¡Œexpireæ·»åŠ è¿‡æœŸæ—¶é—´<br>2. è§£é”ï¼šæ‰§è¡Œdeleteå‘½ä»¤</td>
<td>å®ç°ç®€å•ï¼Œç›¸æ¯”æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å®ç°ï¼Œè¯¥æ–¹æ¡ˆæœ€è½»ï¼Œæ€§èƒ½æœ€å¥½</td>
<td>1.setnxå’Œexpireåˆ†2æ­¥æ‰§è¡Œï¼ŒéåŸå­æ“ä½œï¼›è‹¥setnxæ‰§è¡ŒæˆåŠŸï¼Œä½†expireæ‰§è¡Œå¤±è´¥ï¼Œå°±å¯èƒ½å‡ºç°æ­»é”<br>2.deleteå‘½ä»¤å­˜åœ¨è¯¯åˆ é™¤éå½“å‰çº¿ç¨‹æŒæœ‰çš„é”çš„å¯èƒ½<br>3.ä¸æ”¯æŒé˜»å¡ç­‰å¾…ã€ä¸å¯é‡å…¥</td>
</tr>
<tr>
<td>redis Luaè„šæœ¬èƒ½åŠ›</td>
<td>1. åŠ é”ï¼šæ‰§è¡ŒSET lock_name random_value EX seconds NX å‘½ä»¤ <br>2. è§£é”ï¼šæ‰§è¡ŒLuaè„šæœ¬ï¼Œé‡Šæ”¾é”æ—¶éªŒè¯random_value â€“ ARGV[1]ä¸ºrandom_value, KEYS[1]ä¸ºlock_name</td>
<td>åŒä¸Šï¼›å®ç°é€»è¾‘ä¸Šä¹Ÿæ›´ä¸¥è°¨ï¼Œé™¤äº†å•ç‚¹é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç”¨è¿™ç§æ–¹æ¡ˆï¼Œé—®é¢˜ä¹Ÿä¸å¤§ã€‚</td>
<td>ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾…</td>
</tr>
<tr>
<td>redisson</td>
<td>redissonè¿™ä¸ªæ¡†æ¶é‡åº¦ä¾èµ–äº†Luaè„šæœ¬å’ŒNettyï¼ŒåŠ é”ã€è§£é”Luaè„šæœ¬æ˜¯redissonåˆ†å¸ƒå¼é”</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶"><a href="#åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶" class="headerlink" title="åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶"></a>åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶</h4><p>é¦–å…ˆï¼Œä¸ºäº†ç¡®ä¿åˆ†å¸ƒå¼é”å¯ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘è¦ç¡®ä¿é”çš„å®ç°åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>äº’æ–¥æ€§ã€‚åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚</li>
<li>ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚å³ä½¿æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒè€Œæ²¡æœ‰ä¸»åŠ¨è§£é”ï¼Œä¹Ÿèƒ½ä¿è¯åç»­å…¶ä»–å®¢æˆ·ç«¯èƒ½åŠ é”ã€‚</li>
<li>è§£é“ƒè¿˜é¡»ç³»é“ƒäººã€‚åŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è‡ªå·±ä¸èƒ½æŠŠåˆ«äººåŠ çš„é”ç»™è§£äº†ï¼Œå³ä¸èƒ½è¯¯è§£é”ã€‚</li>
<li>å…·æœ‰å®¹é”™æ€§ã€‚åªè¦å¤§å¤šæ•°RedisèŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œå®¢æˆ·ç«¯å°±èƒ½å¤Ÿè·å–å’Œé‡Šæ”¾é”</li>
</ol>
<h4 id="redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹"><a href="#redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹" class="headerlink" title="redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹"></a>redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹</h4><h5 id="1ã€å¯¼å…¥ä¾èµ–"><a href="#1ã€å¯¼å…¥ä¾èµ–" class="headerlink" title="1ã€å¯¼å…¥ä¾èµ–"></a>1ã€å¯¼å…¥ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.redisson/redisson --&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;redisson&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">            &lt;version&gt;3.12.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="2ã€é…ç½®redisson-single-å•æœº"><a href="#2ã€é…ç½®redisson-single-å•æœº" class="headerlink" title="2ã€é…ç½®redisson-single(å•æœº)"></a>2ã€é…ç½®redisson-single(å•æœº)</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å•æœº</span></span><br><span class="line"><span class="attr">singleServerConfig:</span></span><br><span class="line">  <span class="attr">idleConnectionTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">pingTimeout:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">retryAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">retryInterval:</span> <span class="number">1500</span></span><br><span class="line">  <span class="attr">reconnectionTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">failedAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">subscriptionsPerConnection:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">clientName:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">&quot;redis://localhost:6379&quot;</span></span><br><span class="line">  <span class="attr">subscriptionConnectionMinimumIdleSize:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">subscriptionConnectionPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">connectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="attr">connectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">#åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­dnsçš„æ£€æŸ¥æ“ä½œä¼šç›´æ¥æŠ¥é”™ æ‰€ä»¥æˆ‘ç›´æ¥æ³¨é‡Šæ‰äº†</span></span><br><span class="line">  <span class="comment">#dnsMonitoring: false</span></span><br><span class="line">  <span class="attr">dnsMonitoringInterval:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">threads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">nettyThreads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">codec:</span> <span class="type">!&lt;org.redisson.codec.JsonJacksonCodec&gt;</span> &#123;&#125;</span><br><span class="line"><span class="attr">transportMode :</span> <span class="string">&quot;NIO&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="3ã€é…ç½®application"><a href="#3ã€é…ç½®application" class="headerlink" title="3ã€é…ç½®application"></a>3ã€é…ç½®application</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>

<h5 id="4ã€ç¼–å†™redissoné…ç½®ç±»"><a href="#4ã€ç¼–å†™redissoné…ç½®ç±»" class="headerlink" title="4ã€ç¼–å†™redissoné…ç½®ç±»"></a>4ã€ç¼–å†™redissoné…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redisson</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(</span><br><span class="line">                Config.fromYAML(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;redisson-single.yml&quot;</span>).getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5ã€å…·ä½“ä¸šåŠ¡å®ç°"><a href="#5ã€å…·ä½“ä¸šåŠ¡å®ç°" class="headerlink" title="5ã€å…·ä½“ä¸šåŠ¡å®ç°"></a>5ã€å…·ä½“ä¸šåŠ¡å®ç°</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;GoodsMapper, Goods&gt; <span class="keyword">implements</span> <span class="title class_">GoodsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_KEY</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº“å­˜é€’å‡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id  id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">killGoods</span><span class="params">(Long id, Integer num)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> LOCK_KEY + id;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(key);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ä¸Šé”</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">            <span class="keyword">if</span> (goods.getQuantity()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;åº“å­˜æ•°é‡======&quot;</span>+goods.getQuantity());</span><br><span class="line">            <span class="comment">//å°†åº“å­˜å‡æ“ä½œ</span></span><br><span class="line">            goods.setQuantity(goods.getQuantity()-<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">this</span>.updateById(goods);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//è§£é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="6ã€æ¥å£å®ç°"><a href="#6ã€æ¥å£å®ç°" class="headerlink" title="6ã€æ¥å£å®ç°"></a>6ã€æ¥å£å®ç°</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrderTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!goodsService.killGoods(<span class="number">1405065181720055809L</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;åˆ›å»ºè®¢å•æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·"><a href="#7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·" class="headerlink" title="7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·"></a>7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·</h5><p>æ¨¡æ‹Ÿ200ä¸ªå¹¶å‘æµ‹è¯•</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\develop\Apache24\bin&gt;ab  -n 200 -c 200 &quot;http://localhost:8080/test&quot;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<p><img src="/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/1623922545310-b997fe37fc3c4af18ecef38b4e142ff8.png" alt="1623922545310.png"></p>
<p><img src="/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/1623922677743-deda4b67d30e452696770467e442c5f9.png" alt="1623922677743.png"></p>
<p>æ²¡æœ‰åº“å­˜å˜æˆè´Ÿæ•°çš„æƒ…å†µï¼Œè¯´æ˜åˆ†å¸ƒå¼é”å·²ç”Ÿæ•ˆ</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼é”</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>springäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</title>
    <url>/2022/10/25/spring%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA-spring-shi-wu-de-chuan-bo-xing-wei/</url>
    <content><![CDATA[<h2 id="ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­"><a href="#ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­" class="headerlink" title="ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­"></a>ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­</h2><p>æ–¹æ³•Aæ˜¯ä¸€ä¸ªäº‹åŠ¡çš„æ–¹æ³•ï¼Œæ–¹æ³•Aæ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†æ–¹æ³•Bï¼Œé‚£ä¹ˆæ–¹æ³•Bæœ‰æ— äº‹åŠ¡ä»¥åŠæ–¹æ³•Bå¯¹äº‹åŠ¡çš„è¦æ±‚ä¸åŒéƒ½ä¼šå¯¹æ–¹æ³•Açš„äº‹åŠ¡å…·ä½“æ‰§è¡Œé€ æˆå½±å“ï¼ŒåŒæ—¶æ–¹æ³•Açš„äº‹åŠ¡å¯¹æ–¹æ³•Bçš„äº‹åŠ¡æ‰§è¡Œä¹Ÿæœ‰å½±å“ï¼Œè¿™ç§å½±å“å…·ä½“æ˜¯ä»€ä¹ˆå°±ç”±ä¸¤ä¸ªæ–¹æ³•æ‰€å®šä¹‰çš„äº‹åŠ¡ä¼ æ’­ç±»å‹æ‰€å†³å®šã€‚</p>
<p><strong>REQUIRED</strong>ï¼ˆSpringé»˜è®¤çš„äº‹åŠ¡ä¼ æ’­ç±»å‹ï¼‰ï¼šå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è‡ªå·±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¿™ä¸ªäº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–¹æ³•Bé‡Œé¢çš„sqläº‹åŠ¡æ”¾åœ¨ä¸€èµ·ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlå°±ä¼šåŠ å…¥æ–¹æ³•Açš„sqlçš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚</p>
<p><strong>SUPPORTS</strong>:å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹æ³•æ‰§è¡Œã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bé‡Œé¢çš„sqlåˆ™ä¼šåŠ å…¥æ–¹æ³•Açš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlå°±ä¼šä»¥éäº‹åŠ¡è¿è¡Œã€‚</p>
<p><strong>MANDATORY</strong>:å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bé‡Œé¢çš„sqlåˆ™ä¼šåŠ å…¥æ–¹æ³•Açš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><strong>REQUIRES_NEW</strong>:åˆ›å»ºä¸€ä¸ªæ–°äº‹ç‰©ï¼Œå¦‚æœå­˜åœ¨å½“å‰äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·è¯¥äº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼ŒåŒæ—¶æ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlä¹Ÿæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œæ–¹æ³•Aé‡Œé¢çš„äº‹åŠ¡ï¼Œå†å»æ‰§è¡Œæ–¹æ³•Bé‡Œé¢çš„äº‹åŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒAäº‹åŠ¡å›æ»šå°±åªæ˜¯å›æ»šAè‡ªå·±çš„äº‹åŠ¡ï¼ŒBäº¦æ˜¯å¦‚æ­¤ã€‚</p>
<p><strong>NOT_SUPPORTED</strong>:ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Aé‡Œé¢çš„sqlå•ç‹¬åœ¨äº‹åŠ¡é‡Œæ‰§è¡Œï¼Œæ–¹æ³•Bé‡Œé¢çš„sqlä¸€å®šæ˜¯ä»¥éäº‹åŠ¡è¿è¡Œã€‚å¦‚æœæ–¹æ³•Aé‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Aä¸æ–¹æ³•Bé‡Œé¢çš„sqléƒ½æ˜¯ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚</p>
<p><strong>NEVER</strong>:ä¸ä½¿ç”¨äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><strong>NESTED</strong>:å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™REQUIREDçš„æ“ä½œä¸€æ ·ï¼ˆå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼‰ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„sqlåˆ™ä¼šåµŒå¥—åœ¨æ–¹æ³•Açš„äº‹åŠ¡ä¸­æ‰§è¡Œã€‚</p>
<p><strong>NESTED</strong>å’Œ<strong>REQUIRES_NEW</strong>çš„åŒºåˆ«:<strong>REQUIRES_NEW</strong>æ˜¯æ–°å»ºä¸€ä¸ªäº‹åŠ¡å¹¶ä¸”æ–°å¼€å¯çš„è¿™ä¸ªäº‹åŠ¡ä¸åŸäº‹åŠ¡æ— å…³ï¼Œè€Œ<strong>NESTED</strong>åˆ™æ˜¯å½“å‰å­˜åœ¨äº‹åŠ¡æ—¶ï¼ˆæˆ‘ä»¬æŠŠå½“å‰äº‹åŠ¡ç§°ä¹‹ä¸ºçˆ¶äº‹åŠ¡ï¼‰ä¼šå¼€å¯ä¸€ä¸ªåµŒå¥—äº‹åŠ¡ï¼ˆç§°ä¹‹ä¸ºä¸€ä¸ªå­äº‹åŠ¡ï¼‰ã€‚åœ¨<strong>NESTED</strong>æƒ…å†µä¸‹çˆ¶äº‹åŠ¡å›æ»šæ—¶ï¼Œå­äº‹åŠ¡ä¹Ÿä¼šå›æ»šï¼Œè€Œåœ¨<strong>REQUIRES_NEW</strong>çš„æƒ…å†µä¸‹ï¼ŒåŸæœ‰äº‹åŠ¡å›æ»šï¼Œä¸ä¼šå½±å“æ–°å¼€å¯çš„äº‹åŠ¡ã€‚</p>
<h2 id="äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"><a href="#äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§" class="headerlink" title="äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"></a>äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§</h2><p>1ã€why<br>ä¸ºä»€ä¹ˆä¼šæœ‰äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Ÿ</p>
<p>åœºæ™¯ä¸€ï¼š serviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä½†ä¸¤ä¸ªæ–¹æ³•éƒ½æœ‰äº‹åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœ serviceB æ–¹æ³•å¼‚å¸¸ï¼Œæ˜¯è®© serviceB æ–¹æ³•æäº¤ï¼Œè¿˜æ˜¯ä¸¤ä¸ªä¸€èµ·å›æ»šã€‚åœºæ™¯äºŒï¼šserviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ serviceA æ–¹æ³•åŠ äº†äº‹åŠ¡ï¼Œæ˜¯å¦æŠŠ serviceB ä¹ŸåŠ å…¥ serviceA çš„äº‹åŠ¡ï¼Œå¦‚æœ serviceB å¼‚å¸¸ï¼Œæ˜¯å¦å›æ»š serviceA ã€‚åœºæ™¯ä¸‰ï¼šserviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä¸¤è€…éƒ½æœ‰äº‹åŠ¡ï¼ŒserviceB å·²ç»æ­£å¸¸æ‰§è¡Œå®Œï¼Œä½† serviceA å¼‚å¸¸ï¼Œæ˜¯å¦éœ€è¦å›æ»š serviceB çš„æ•°æ®ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å¯¹åº”çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶æ¥æ§åˆ¶äº‹åŠ¡ã€‚</p>
<p>2ã€ä¼ æ’­æœºåˆ¶ç”Ÿæ•ˆçš„æ¡ä»¶<br>æœ‰äº†springäº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Œé‚£è¿™ç§æœºåˆ¶å­˜åœ¨çš„æ¡ä»¶å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œspringçš„äº‹åŠ¡æ˜¯åŸºäºaopçš„ï¼Œç¡®åˆ‡æ¥è¯´ï¼Œæ˜¯åŸºäºJDKåŠ¨æ€ä»£ç†çš„AOPï¼Œè¿™ç§AOPæœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ å®ƒæ˜¯åŸºäºç±»æˆ–è€…æ¥å£çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ @Transactionalå†™åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šè¢«springåŠ¨æ€ä»£ç†ï¼Œ ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œ å¯¹åŸæ–¹æ³•è¿›è¡Œä¿®é¥°å¢å¼ºï¼Œä½†æ˜¯è¦æ³¨æ„ï¼ï¼ åŸå…ˆçš„æ–¹æ³•çš„ç±»å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œå¹¶æ²¡æœ‰äº‹åŠ¡ï¼ŒspringåŠ¨æ€ä»£ç†è¿™ä¸ªç±»ç”Ÿæˆçš„ä»£ç†ç±»æ‰æœ‰äº‹åŠ¡ï¼Œæ‰æœ‰å¢å¼ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åŒä¸€ä¸ªç±»é‡Œé¢é€šè¿‡this.xx()è°ƒç”¨æœ¬ç±»çš„äº‹åŠ¡æ–¹æ³•æ—¶ï¼Œäº‹åŠ¡æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œå› ä¸ºä½ è°ƒç”¨çš„ä¸æ˜¯ä»£ç†ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; <span class="built_in">this</span>.method2(); &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">xx </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>å…³é”®åœ¨äºè·å–ç±»çš„ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡thiså»è°ƒç”¨ï¼Œæ‰€ä»¥ä»¥ä¸‹æ–¹æ³•éƒ½æ˜¯åŸºäºè¿™ä¸ªå…³é”®ç‚¹å»è§£å†³çš„ã€‚</p>
<p>1ã€æœ€ç®€å•çš„ï¼Œä¸¤ä¸ªäº‹åŠ¡æ–¹æ³•æ”¾åœ¨ä¸åŒçš„serviceé‡Œé¢ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç»™ä¾‹å­äº†ã€‚ï¼ˆæ¨èï¼‰</p>
<p>2ã€AOPä¸Šä¸‹æ–‡ã€‚springæä¾›äº†AOPä¸Šä¸‹æ–‡AopContextï¼Œå› æ­¤é€šè¿‡AopContextï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–åˆ°ä»£ç†å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myservice</span>&#123; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; </span><br><span class="line">		((Myservice)AopContext.currentProxy()).method2(); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">		xx </span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€è¿è¡Œï¼ŒæŠ¥é”™äº†ï¼Œå› ä¸ºexposeProxyé»˜è®¤ä¸ºfalseï¼Œæˆ‘ä»¬è¦æš´éœ²ä»£ç†ç±»ï¼Œå°±è¦è®¾ç½®ä¸ºtrueï¼Œå¯ä»¥åœ¨springbootå¯åŠ¨ç±»ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£</p>
<p>@EnableAspectJAutoProxy(exposeProxy &#x3D; true)<br>3ã€ApplicationContextã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myservice</span>&#123; </span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	ApplicationContext context; </span><br><span class="line"></span><br><span class="line">	Myservice service; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span> <span class="comment">//åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œä¸åŠ ä¹Ÿè¡Œ </span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> 	<span class="title function_">getMyservice</span><span class="params">()</span> &#123; </span><br><span class="line">		service = context.getBean(Myservice.class); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; </span><br><span class="line">		service.method2(); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">		xx </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒå’Œç¬¬ä¸‰ç§çš„åŒºåˆ«å°±åœ¨äºï¼Œ2æ˜¯ç›´æ¥è·å–ä»£ç†ç±»ï¼Œ3æ˜¯é€šè¿‡è°ƒç”¨getBeané—´æ¥è·å–ä»£ç†ç±»ï¼Œæ€»çš„æ¥è¯´ï¼Œç¬¬ä¸€ç§æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œä¹Ÿæ˜¯æœ€æ¨èçš„åšæ³•ã€‚</p>
<p>3ã€ä¼ æ’­æœºåˆ¶ç±»å‹<br>ä¸‹é¢çš„ç±»å‹éƒ½æ˜¯é’ˆå¯¹äºè¢«è°ƒç”¨æ–¹æ³•æ¥è¯´çš„ï¼Œç†è§£èµ·æ¥è¦æƒ³è±¡æˆä¸¤ä¸ª service æ–¹æ³•çš„è°ƒç”¨æ‰å¯ä»¥ã€‚</p>
<p><strong>PROPAGATION_REQUIRED:</strong> (é»˜è®¤) æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œåˆå¹¶æˆä¸€ä¸ªäº‹åŠ¡<br><strong>REQUIRES_NEW:</strong> ï¼ˆä¸€èˆ¬ç”¨åœ¨å­æ–¹æ³•éœ€è¦å•ç‹¬äº‹åŠ¡ï¼‰ æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·è¿™ä¸ªæ–¹æ³•ä¼šç‹¬ç«‹æäº¤äº‹åŠ¡ï¼Œä¸å—è°ƒç”¨è€…çš„äº‹åŠ¡å½±å“ï¼Œçˆ¶çº§å¼‚å¸¸ï¼Œå®ƒä¹Ÿæ˜¯æ­£å¸¸æäº¤<br>ï¼ˆä¸Šé¢ä¸¤ä¸ªç±»å‹æ˜¯å¸¸ç”¨çš„ï¼Œä¸‹é¢çš„æ¯”è¾ƒå°‘ç”¨ï¼‰</p>
<p><strong>NESTED:</strong>  å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå®ƒå°†ä¼šæˆä¸ºçˆ¶çº§äº‹åŠ¡çš„ä¸€ä¸ªå­äº‹åŠ¡ï¼Œæ–¹æ³•ç»“æŸåå¹¶æ²¡æœ‰æäº¤ï¼Œåªæœ‰ç­‰çˆ¶äº‹åŠ¡ç»“æŸæ‰æäº¤,å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡å¦‚æœå®ƒå¼‚å¸¸ï¼Œçˆ¶çº§å¯ä»¥æ•è·å®ƒçš„å¼‚å¸¸è€Œä¸è¿›è¡Œå›æ»šï¼Œæ­£å¸¸æäº¤,ä½†å¦‚æœçˆ¶çº§å¼‚å¸¸ï¼Œå®ƒå¿…ç„¶å›æ»šï¼Œè¿™å°±æ˜¯å’Œ  <strong>REQUIRES_NEW</strong>  çš„åŒºåˆ«<br><strong>SUPPORTS:</strong>  å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥äº‹åŠ¡å¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œè¿™ä¸ªå’Œä¸å†™æ²¡åŒºåˆ«<br><strong>NOT_SUPPORTED:</strong> ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·<br><strong>MANDATORY:</strong> å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è¿è¡Œåœ¨å½“å‰äº‹åŠ¡ä¸­å¦‚æœå½“å‰æ— äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå³çˆ¶çº§æ–¹æ³•å¿…é¡»æœ‰äº‹åŠ¡<br><strong>NEVER:</strong> ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå³çˆ¶çº§æ–¹æ³•å¿…é¡»æ— äº‹åŠ¡</p>
]]></content>
  </entry>
  <entry>
    <title>zookeeperè‡ªå·±å®ç°åˆ†å¸ƒå¼é”</title>
    <url>/2022/08/22/zookeeper%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-zookeeper-zi-ji-shi-xian-fen-bu-shi-suo/</url>
    <content><![CDATA[<pre><code>åœ¨ä¸€äº›å¹¶å‘è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œåœ¨åŒä¸€æ—¶åˆ»åªèƒ½å…è®¸ä¸€ä¸ªè¯·æ±‚å¯¹åŒä¸€æ¡æ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œã€‚åœ¨ä¹‹å‰çš„å•æœºåº”ç”¨å½“ä¸­ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°åˆ©ç”¨jdkçš„é”æ¥å®ç°ï¼Œä¾‹å¦‚ synchronizedæˆ–è€…lock ã€‚ä½†æ˜¯åœ¨å¦‚ä»Šä¸šåŠ¡å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­jdkçš„é”å¹¶ä¸é€‚ç”¨ï¼Œæ‰€ä»¥å¿…é¡»è¦è¦ç”¨åˆ†å¸ƒå¼é”ã€‚
</code></pre>
<p>å¸¸è§çš„å‡ ç§åˆ†å¸ƒå¼é”çš„å®ç°æ–¹æ¡ˆï¼ŒRedisã€Mysql ã€zookeeperï¼›</p>
<p>æœ¬æ–‡ä¸»è¦è®²çš„æ˜¯å¦‚ä½•ä½¿ç”¨zkå®ç°åˆ†å¸ƒå¼é”ï¼š</p>
<pre><code>     ZooKeeperæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œä»–ä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›äº†é«˜æ•ˆä¸”å¯é çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†è¯¸å¦‚ç»Ÿä¸€å‘½åç©ºé—´æœåŠ¡ï¼Œé…ç½®æœåŠ¡å’Œåˆ†å¸ƒå¼é”ç­‰åˆ†å¸ƒå¼åŸºç¡€æœåŠ¡ã€‚ 

    ZooKeeperçš„æ•°æ®æ¨¡å‹æ˜¯å†…å­˜ä¸­çš„ä¸€ä¸ªZNodeæ•°ï¼Œç”±æ–œæ (/)è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ªZNodeï¼Œæ¯ä¸ªZNodeä¸Šé™¤äº†ä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼Œè¿˜ä¿å­˜ä¸€ç³»åˆ—å±æ€§ä¿¡æ¯ã€‚

    ZooKeeperä¸­çš„æ•°æ®èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ï¼šæŒä¹…èŠ‚ç‚¹å’Œä¸´æ—¶èŠ‚ç‚¹ã€‚æ‰€è°“çš„æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦è¿™ä¸ªZNodeåˆ›å»ºæˆåŠŸï¼Œé™¤éä¸»åŠ¨è¿›è¡ŒZNodeçš„ç§»é™¤æ“ä½œï¼ŒèŠ‚ç‚¹ä¼šä¸€ç›´ä¿å­˜åœ¨ZooKeeperä¸Šï¼›è€Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿå®¢æˆ·ç«¯çš„ï¼ˆSessionï¼‰ä¼šè¯ç›¸å…³è”çš„ï¼Œä¸€æ—¦å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œè¿™ä¸ªä¼šè¯ä¸Šçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹éƒ½ä¼šè¢«è‡ªåŠ¨ç§»é™¤ã€‚
</code></pre>
<p><strong>å…·ä½“æ€è·¯ï¼š</strong></p>
<p>1ã€é¦–å…ˆzookeeperä¸­æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª&#x2F;distributed_lockæŒä¹…åŒ–èŠ‚ç‚¹<br>2ã€ç„¶åå†åœ¨&#x2F;distributed_lockèŠ‚ç‚¹ä¸‹åˆ›å»ºè‡ªå·±çš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œæ¯”å¦‚ï¼š&#x2F;distributed_lock&#x2F;task_00000000008<br>3ã€è·å–æ‰€æœ‰çš„&#x2F;distributed_lockä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¹¶æ’åº<br>4ã€åˆ¤è¯»è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æœ€å°å€¼ï¼ˆç¬¬ä¸€ä½ï¼‰<br>5ã€å¦‚æœæ˜¯ï¼Œåˆ™è·å–å¾—åˆ°é”ï¼Œæ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€ååˆ é™¤è¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹ã€‚<br>6ã€å¦‚æœä¸æ˜¯æœ€å°å€¼ï¼Œåˆ™éœ€è¦ç›‘å¬è‡ªå·±åˆ›å»ºèŠ‚ç‚¹å‰ä¸€ä½èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–ï¼Œå¹¶é˜»å¡ã€‚<br>7ã€å½“å‰ä¸€ä½èŠ‚ç‚¹è¢«åˆ é™¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é€’å½’æ¥åˆ¤æ–­è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦åœ¨æ˜¯æœ€å°çš„ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œ5ï¼‰ï¼›å¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œ6ï¼‰ï¼ˆå°±æ˜¯é€’å½’å¾ªç¯çš„åˆ¤æ–­ï¼‰</p>
<h3 id="ä¸€ã€å¯¼å…¥ä¾èµ–"><a href="#ä¸€ã€å¯¼å…¥ä¾èµ–" class="headerlink" title="ä¸€ã€å¯¼å…¥ä¾èµ–"></a>ä¸€ã€å¯¼å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦åŒ…æ‹¬äº†zkå®¢æˆ·ç«¯çš„ä¾èµ–ï¼Œmybatis-plusçš„ä¾èµ–ã€‚</p>
<h3 id="äºŒã€æ•°æ®çš„é…ç½®"><a href="#äºŒã€æ•°æ®çš„é…ç½®" class="headerlink" title="äºŒã€æ•°æ®çš„é…ç½®"></a>äºŒã€æ•°æ®çš„é…ç½®</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®åº“</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/db3?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¸‰ã€å…·ä½“ä»£ç å®ç°"><a href="#ä¸‰ã€å…·ä½“ä»£ç å®ç°" class="headerlink" title="ä¸‰ã€å…·ä½“ä»£ç å®ç°"></a>ä¸‰ã€å…·ä½“ä»£ç å®ç°</h3><p>åˆ†å¸ƒå¼é”å·¥å…·ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zk_lock.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.IZkDataListener;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.ZkClient;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.ZkConnection;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.exception.ZkNodeExistsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¸¸é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONNECTION_STRING</span> <span class="operator">=</span> <span class="string">&quot;localhost:2181&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_NODE</span> <span class="operator">=</span> <span class="string">&quot;/distributed_lock&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHILDREN_NODE</span> <span class="operator">=</span> <span class="string">&quot;/lock_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DistributedLockUtil distributedLockUtil;</span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> ZkClient zkClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºzkClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLockUtil</span><span class="params">()</span> &#123;</span><br><span class="line">        distributedLockUtil = <span class="built_in">this</span>;</span><br><span class="line">        <span class="comment">// è¿æ¥åˆ°Zookeeper</span></span><br><span class="line">        zkClient = <span class="keyword">new</span> <span class="title class_">ZkClient</span>(<span class="keyword">new</span> <span class="title class_">ZkConnection</span>(CONNECTION_STRING));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(LOCK_NODE)) &#123;</span><br><span class="line">            zkClient.create(LOCK_NODE, <span class="string">&quot;åˆ†å¸ƒå¼é”èŠ‚ç‚¹&quot;</span>, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é”åå­—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.åœ¨ZookeeperæŒ‡å®šèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">lockName</span> <span class="operator">=</span> zkClient.createEphemeralSequential(LOCK_NODE + CHILDREN_NODE, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">            acquireLock(lockName);</span><br><span class="line">            <span class="keyword">return</span> lockName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">acquireLock</span><span class="params">(String lockName)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 2.è·å–lockèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</span></span><br><span class="line">        List&lt;String&gt; childrenList = zkClient.getChildren(LOCK_NODE);</span><br><span class="line">        <span class="comment">// 3.å¯¹å­èŠ‚ç‚¹è¿›è¡Œæ’åº,è·å–æœ€å°å€¼</span></span><br><span class="line">        childrenList.sort(<span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String o1, String o2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Integer.parseInt(o1.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]) - Integer.parseInt(o2.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦åœ¨ç¬¬ä¸€ä½</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lockPosition</span> <span class="operator">=</span> childrenList.indexOf(lockName.split(<span class="string">&quot;/&quot;</span>)[lockName.split(<span class="string">&quot;/&quot;</span>).length - <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (lockPosition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZkNodeExistsException</span>(<span class="string">&quot;ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼š&quot;</span> + lockName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lockPosition == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åˆ°é”</span></span><br><span class="line">            log.info(<span class="string">&quot;è·å–åˆ°é”ï¼š&quot;</span> + lockName);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœªè·å–åˆ°é”ï¼Œé˜»å¡</span></span><br><span class="line">        log.info(<span class="string">&quot;...... æœªè·å–åˆ°é”ï¼Œé˜»å¡ç­‰å¾… ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">        <span class="comment">// 5.å¦‚æœæœªè·å–å¾—åˆ°é”,ç›‘å¬å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹å‰ä¸€ä½çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">IZkDataListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IZkDataListener</span>() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å½“è¢«åˆ é™¤æ—¶çš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> dataPath èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span> Exception å¼‚å¸¸</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDataDeleted</span><span class="params">(String dataPath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 6.å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤,å½“ä¸ä¿è¯è½®åˆ°è‡ªå·±</span></span><br><span class="line">                log.info(<span class="string">&quot;ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤  ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">                acquireLock(lockName);</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDataChange</span><span class="params">(String dataPath, Object data)</span> &#123;</span><br><span class="line">                <span class="comment">//èŠ‚ç‚¹è¢«æ”¹å˜</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            zkClient.subscribeDataChanges(LOCK_NODE + <span class="string">&quot;/&quot;</span> + childrenList.get(lockPosition - <span class="number">1</span>), listener);</span><br><span class="line">            <span class="comment">//é˜»å¡</span></span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;ã€‚ã€‚ã€‚ã€‚ã€‚å–æ¶ˆè®¢é˜…ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">            <span class="comment">//å–æ¶ˆç›‘å¬</span></span><br><span class="line">            zkClient.unsubscribeDataChanges(LOCK_NODE + <span class="string">&quot;/&quot;</span> + childrenList.get(lockPosition - <span class="number">1</span>), listener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockName é”åå­—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">releaseLock</span><span class="params">(String lockName)</span> &#123;</span><br><span class="line">        zkClient.delete(lockName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeZkClient</span><span class="params">()</span> &#123;</span><br><span class="line">        zkClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>å…·ä½“ä¸šåŠ¡å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº“å­˜é€’å‡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id  id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">killGoods</span><span class="params">(Long id, Integer num)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> DistributedLockUtil.getLock();</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(lock)) &#123;</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">            <span class="keyword">if</span> (goods.getQuantity() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//åº“å­˜æ•°é‡ä¸è¶³,é‡Šæ”¾é”</span></span><br><span class="line">                DistributedLockUtil.releaseLock(lock);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;åº“å­˜æ•°é‡======&quot;</span> + goods.getQuantity());</span><br><span class="line">            <span class="comment">//å°†åº“å­˜å‡æ“ä½œ</span></span><br><span class="line">            goods.setQuantity(goods.getQuantity() - <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">this</span>.updateById(goods);</span><br><span class="line">            DistributedLockUtil.releaseLock(lock);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">**</span><br><span class="line"> * <span class="meta">@author</span> wenlinshan</span><br><span class="line"> * <span class="meta">@version</span> <span class="number">1.0</span></span><br><span class="line"> * <span class="meta">@date</span> <span class="number">2021</span>/<span class="number">6</span>/<span class="number">16</span> <span class="number">11</span>:<span class="number">06</span></span><br><span class="line"> * <span class="meta">@desc</span></span><br><span class="line"> */</span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrderTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!goodsService.killGoods(<span class="number">1405065181720055809L</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;åˆ›å»ºè®¢å•æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;close&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">closeZk</span><span class="params">()</span>&#123;</span><br><span class="line">        DistributedLockUtil.closeZkClient();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å…³é—­æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼é”çš„demoå·²ç»å®ç°ã€‚<br>é™¤æ­¤ä¹‹å¤–å¯ä»¥ä½¿ç”¨ç°æˆçš„æ¡†æ¶curatoræ¥ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼é”</category>
      </categories>
  </entry>
  <entry>
    <title>åˆ†äº«ä¸€ç¯‡æ–‡ç« -ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³•</title>
    <url>/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/</url>
    <content><![CDATA[<h1 id="ç¥å¥‡çš„-SQL-ä¹‹åˆ«æ ·çš„å†™æ³•-â†’-è¡Œè¡Œæ¯”è¾ƒ"><a href="#ç¥å¥‡çš„-SQL-ä¹‹åˆ«æ ·çš„å†™æ³•-â†’-è¡Œè¡Œæ¯”è¾ƒ" class="headerlink" title="ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³• â†’ è¡Œè¡Œæ¯”è¾ƒ"></a>ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³• â†’ è¡Œè¡Œæ¯”è¾ƒ</h1><p>â€‹																							æœ¬æ–‡é“¾æ¥ï¼šcnblogs.com&#x2F;youzhibing&#x2F;p&#x2F;15101096.html</p>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>ã€€ã€€æ•°æ®åº“ç‰ˆæœ¬ï¼š MySQL 5.7.20-log </p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812093924974-1727100840-5f29462b905c4e689c2edaa5e5fd8656.png" alt="747662202108120939249741727100840.png"><br>ã€€ã€€å»ºè¡¨ SQL</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812101129712-1532849175-bbdd23d16de14dbcad4767d644ec77dd.png"><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `t_ware_sale_statistics`;</span><br><span class="line">CREATE TABLE `t_ware_sale_statistics` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®id&#x27;,</span><br><span class="line">  `business_id` bigint(20) NOT NULL COMMENT &#x27;ä¸šåŠ¡æœºæ„ç¼–ç &#x27;,</span><br><span class="line">  `ware_inside_code` bigint(20) NOT NULL COMMENT &#x27;å•†å“è‡ªç¼–ç &#x27;,</span><br><span class="line">  `weight_sale_cnt_day` double(16,4) DEFAULT NULL COMMENT &#x27;å¹³å‡æ—¥é”€é‡&#x27;,</span><br><span class="line">  `last_thirty_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘30å¤©é”€é‡&#x27;,</span><br><span class="line">  `last_sixty_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘60å¤©é”€é‡&#x27;,</span><br><span class="line">  `last_ninety_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘90å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_thirty` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ30å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_sixty` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ60å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_ninety` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ90å¤©é”€é‡&#x27;,</span><br><span class="line">  `create_user` bigint(20) DEFAULT NULL COMMENT &#x27;åˆ›å»ºäºº&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `modify_user` bigint(20) DEFAULT NULL COMMENT &#x27;æœ€ç»ˆä¿®æ”¹äºº&#x27;,</span><br><span class="line">  `modify_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æœ€ç»ˆä¿®æ”¹æ—¶é—´&#x27;,</span><br><span class="line">  `is_delete` tinyint(2) DEFAULT &#x27;2&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼Œ1ï¼šæ˜¯ï¼Œ2ï¼šå¦&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  KEY `idx_business_ware` (`business_id`,`ware_inside_code`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT=&#x27;å•†å“é”€å”®ç»Ÿè®¡&#x27;;</span><br></pre></td></tr></table></figure>

<p>ã€€ã€€åˆå§‹åŒ–æ•°æ®</p>
<p>ã€€ã€€ã€€ã€€å‡†å¤‡äº† 769063 æ¡æ•°æ®</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812101326865-671080270-b45b9d3614094235ac973bbccbb533ff.png" alt="74766220210812101326865671080270.png"></p>
<h2 id="éœ€æ±‚èƒŒæ™¯"><a href="#éœ€æ±‚èƒŒæ™¯" class="headerlink" title="éœ€æ±‚èƒŒæ™¯"></a>éœ€æ±‚èƒŒæ™¯</h2><p>ã€€ã€€ä¸šåŠ¡æœºæ„ä¸‹é”€å”®å•†å“ï¼ŒåŒä¸ªä¸šåŠ¡æœºæ„å¯ä»¥é”€å”®ä¸åŒçš„å•†å“ï¼ŒåŒä¸ªå•†å“å¯ä»¥åœ¨ä¸åŒçš„ä¸šåŠ¡æœºæ„é”€å”®ï¼Œä¹Ÿå°±è¯´ï¼šä¸šåŠ¡æœºæ„ä¸å•†å“æ˜¯å¤šå¯¹å¤šçš„å…³ç³»</p>
<p>ã€€ã€€å‡è®¾ç°åœ¨æœ‰ n ä¸ªæœºæ„ï¼Œæ¯ä¸ªæœºæ„ä¸‹æœ‰å‡ ä¸ªå•†å“ï¼Œå¦‚ä½•æŸ¥è¯¢å‡ºè¿™å‡ ä¸ªé—¨åº—ä¸‹å„è‡ªå•†å“çš„é”€å”®æƒ…å†µï¼Ÿ</p>
<p>ã€€ã€€å…·ä½“ç‚¹ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-54d46ffcf96a41b1b031a9bbb6cb048f.png" alt="image.png"></p>
<p>ã€€ã€€å¦‚ä½•æŸ¥å‡º 100001 ä¸‹å•†å“ 1000ã€1001ã€1003 ã€ 100002 ä¸‹å•†å“ 1003ã€1004 ã€ 100003 ä¸‹å•†å“ 1006ã€1008ã€1009 çš„é”€å”®æƒ…å†µ</p>
<p>ã€€ã€€ç›¸å½“äºæ˜¯åŒå±‚åˆ—è¡¨ï¼ˆä¸šåŠ¡æœºæ„åˆ—è¡¨ä¸­å¥—å•†å“åˆ—è¡¨ï¼‰çš„æŸ¥è¯¢ï¼›ä¸šåŠ¡æœºæ„åˆ—è¡¨å’Œå•†å“åˆ—è¡¨éƒ½ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯åŠ¨æ€çš„</p>
<p>ã€€ã€€é‚£ä¹ˆé—®é¢˜å°±æ˜¯ï¼šå¦‚ä½•æŸ¥è¯¢å¤šä¸ªä¸šåŠ¡æœºæ„ä¸‹ï¼ŒæŸäº›å•†å“çš„é”€å”®æƒ…å†µ</p>
<p>ã€€ã€€ï¼ˆé—®é¢˜ç»æˆ‘ä¸€æè¿°ï¼Œå¯èƒ½æ›´æ¨¡ç³Šäº†ï¼Œå¤§å®¶æ˜ç™½æ„æ€äº†å°±å¥½ï¼ï¼‰</p>
<h2 id="å¾ªç¯æŸ¥è¯¢"><a href="#å¾ªç¯æŸ¥è¯¢" class="headerlink" title="å¾ªç¯æŸ¥è¯¢"></a>å¾ªç¯æŸ¥è¯¢</h2><p>ã€€ã€€è¿™ä¸ªå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œåœ¨ä»£ç å±‚é¢å¾ªç¯ä¸šåŠ¡æœºæ„åˆ—è¡¨ï¼Œæ¯ä¸ªä¸šåŠ¡æœºæ„æŸ¥ä¸€æ¬¡æ•°æ®åº“ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-a3ac667739d5455c919bcecd75f15bff.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-074d4491afe3486dac874d8d490430b2.png" alt="image.png"></p>
<p>ã€€ã€€SQL èƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-e5cf8ad05afa4ed5acd18d6e02350666.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œä¸€åˆ‡çœ‹èµ·æ¥ä¼¼ä¹å¾ˆå®Œç¾</p>
<p>ã€€ã€€ç„¶è€Œç°å®æ˜¯ï¼šéƒ¨é—¨å¼€å‘è§„èŒƒçº¦æŸï¼Œä¸èƒ½å¾ªç¯æŸ¥æ•°æ®åº“</p>
<p>ã€€ã€€å“¦è±ï¼Œè¿™ç§æ–¹å¼åªèƒ½æ”¾å¼ƒï¼Œå¦å¯»å…¶ä»–æ–¹å¼äº†</p>
<h2 id="OR-æ‹¼æ¥"><a href="#OR-æ‹¼æ¥" class="headerlink" title="OR æ‹¼æ¥"></a>OR æ‹¼æ¥</h2><p>ã€€ã€€é€šè¿‡ MyBatis çš„ åŠ¨æ€ SQL åŠŸèƒ½ï¼Œè¿›è¡Œ SQL æ‹¼æ¥ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-d29c4ea236a44e6090958ca5b928b5fe.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-0e12a2c6179a4d86b207cae587539247.png" alt="image.png"></p>
<p>ã€€ã€€SQL ä¹Ÿèƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-8d7ba0be6aba4adaa40b03c8d0c9de94.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œè²Œä¼¼å¯è¡Œ</p>
<p>ã€€ã€€å”¯ä¸€å¯æƒœçš„æ˜¯ï¼šæœ‰ç‚¹è´¹ ORï¼Œå¦‚æœä¸šåŠ¡æœºæ„æ¯”è¾ƒå¤šï¼Œé‚£ SQL ä¼šæ¯”è¾ƒé•¿</p>
<p>ã€€ã€€ä½œä¸ºå€™é€‰äººä¹‹ä¸€å§ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p>
<h2 id="æ··æŸ¥è¿‡æ»¤"><a href="#æ··æŸ¥è¿‡æ»¤" class="headerlink" title="æ··æŸ¥è¿‡æ»¤"></a>æ··æŸ¥è¿‡æ»¤</h2><p>ã€€ã€€åŒæ ·æ˜¯åˆ©ç”¨ Mybatis çš„ åŠ¨æ€ SQL ï¼Œå°† business_id åˆ—è¡¨æ‹¼åœ¨ä¸€èµ·ã€ ware_inside_code æ‹¼åœ¨ä¸€èµ·ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-bf46b637269849438a7714ea7b551442.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-328446ff1a134354ae9468bfe122402a.png" alt="image.png"></p>
<p>ã€€ã€€SQL ä¹Ÿèƒ½èµ°ç´¢å¼•<br><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-bee2180d1e54452a9f83faa314693d72.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œä¼¼ä¹å¯è¡Œ</p>
<p>ã€€ã€€ä½†æ˜¯ï¼šæŸ¥å‡ºæ¥çš„ç»“æœé›†å¤§äºç­‰äºæˆ‘ä»¬æƒ³è¦çš„ç»“æœé›†ï¼Œä½ å“ï¼Œä½ ç»†å“ï¼</p>
<p>ã€€ã€€æ‰€ä»¥è¿˜éœ€è¦å¯¹æŸ¥å‡ºæ¥çš„ç»“æœé›†è¿›è¡Œä¸€æ¬¡è¿‡æ»¤ï¼Œè¿‡æ»¤å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœé›†</p>
<p>ã€€ã€€å§‘ä¸”ä¹Ÿä½œä¸ºå€™é€‰äººä¹‹ä¸€å§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p>
<h2 id="è¡Œè¡Œæ¯”è¾ƒ"><a href="#è¡Œè¡Œæ¯”è¾ƒ" class="headerlink" title="è¡Œè¡Œæ¯”è¾ƒ"></a>è¡Œè¡Œæ¯”è¾ƒ</h2><p>ã€€ã€€SQL-92 ä¸­åŠ å…¥äº†è¡Œä¸è¡Œæ¯”è¾ƒçš„åŠŸèƒ½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ¯”è¾ƒè°“è¯ &#x3D; ã€&lt; ã€&gt; å’Œ IN è°“è¯çš„å‚æ•°å°±ä¸å†åªæ˜¯æ ‡é‡å€¼äº†ï¼Œè¿˜å¯ä»¥æ˜¯å€¼åˆ—è¡¨äº†</p>
<p>ã€€ã€€å½“ç„¶ï¼Œè¿˜æ˜¯å¾—ç”¨åˆ° Mybatis çš„ åŠ¨æ€ SQL ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-3ed941854ff448a2afca75acfb7201cf.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-e9794c1ebbf44fb3a3034de018e80e98.png" alt="image.png"></p>
<p>ã€€ã€€SQL åŒæ ·èƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-793ecb0c293c4bfabef1401a36589a15.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œæ„Ÿè§‰å¯è¡Œ</p>
<p>ã€€ã€€åªæ˜¯ï¼šæœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬å¹³æ—¶è¿™ä¹ˆç”¨çš„å°‘ï¼Œæ‰€ä»¥è¿™ç§å†™æ³•çœ‹èµ·æ¥å¾ˆé™Œç”Ÿ</p>
<p>ã€€ã€€å¦å¤–ï¼Œè¡Œè¡Œæ¯”è¾ƒæ˜¯ SQL è§„èŒƒï¼Œä¸æ˜¯æŸä¸ªå…³ç³»å‹æ•°æ®åº“çš„è§„èŒƒï¼Œä¹Ÿå°±è¯´å…³ç³»å‹æ•°æ®åº“éƒ½åº”è¯¥æ”¯æŒè¿™ç§å†™æ³•</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ã€€ã€€1ã€æœ€åé€‰æ‹©äº† è¡Œè¡Œæ¯”è¾ƒ è¿™ç§æ–¹å¼æ¥å®ç°äº†éœ€æ±‚</p>
<p>ã€€ã€€ã€€ã€€åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œé—®å°±æ˜¯é€¼æ ¼é«˜ï¼</p>
<p>ã€€ã€€2ã€æŸä¸€ä¸ªéœ€æ±‚çš„å®ç°å¾€å¾€æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆä¸šåŠ¡ä»¥åŠå„ç§çº¦æŸç»¼åˆè€ƒè™‘ï¼Œé€‰æ‹©æœ€åˆé€‚çš„é‚£ä¸ª</p>
<p>ã€€ã€€3ã€è¡Œè¡Œæ¯”è¾ƒæ˜¯ SQL-92 ä¸­å¼•å…¥çš„ï¼ŒSQL-92 æ˜¯ 1992 å¹´åˆ¶å®šçš„è§„èŒƒ</p>
<p>ã€€ã€€ã€€ã€€è¡Œè¡Œæ¯”è¾ƒä¸æ˜¯æ–°ç‰¹æ€§ï¼Œè€Œæ˜¯å¾ˆæ—©å°±å­˜åœ¨çš„åŸºç¡€åŠŸèƒ½</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£Redis</title>
    <url>/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/</url>
    <content><![CDATA[<h2 id="ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ</h2><p>redisæ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“</p>
<h3 id="1ã€NOSQL"><a href="#1ã€NOSQL" class="headerlink" title="1ã€NOSQL"></a>1ã€NOSQL</h3><p>å³ Not-Only SQLï¼ˆ æ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼‰ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å……ã€‚</p>
<h3 id="2ã€ä¸»è¦ä½œç”¨"><a href="#2ã€ä¸»è¦ä½œç”¨" class="headerlink" title="2ã€ä¸»è¦ä½œç”¨"></a>2ã€ä¸»è¦ä½œç”¨</h3><p>ï¼ˆ1ï¼‰ä¸ºçƒ­ç‚¹æ•°æ®åŠ é€ŸæŸ¥è¯¢ï¼ˆä¸»è¦åœºæ™¯ï¼‰ã€‚å¦‚çƒ­ç‚¹å•†å“ã€çƒ­ç‚¹æ–°é—»ã€çƒ­ç‚¹èµ„è®¯ã€æ¨å¹¿ç±»ç­‰é«˜è®¿é—®é‡ä¿¡æ¯ç­‰ã€‚</p>
<p>ï¼ˆ2ï¼‰å³æ—¶ä¿¡æ¯æŸ¥è¯¢ã€‚å¦‚å„ä½æ’è¡Œæ¦œã€å„ç±»ç½‘ç«™è®¿é—®ç»Ÿè®¡ã€å…¬äº¤åˆ°ç«™ä¿¡æ¯ã€åœ¨çº¿äººæ•°ä¿¡æ¯ï¼ˆèŠå¤©å®¤ã€ç½‘ç«™ï¼‰ã€è®¾å¤‡ä¿¡å·ç­‰ã€‚</p>
<p>ï¼ˆ3ï¼‰æ—¶æ•ˆæ€§ä¿¡æ¯æ§åˆ¶ã€‚å¦‚éªŒè¯ç æ§åˆ¶ã€æŠ•ç¥¨æ§åˆ¶ç­‰ã€‚</p>
<p>ï¼ˆ4ï¼‰åˆ†å¸ƒå¼æ•°æ®å…±äº«ã€‚å¦‚åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸­çš„ session åˆ†ç¦»æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<h2 id="äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰"><a href="#äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰" class="headerlink" title="äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰"></a>äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰</h2><h3 id="1ã€String"><a href="#1ã€String" class="headerlink" title="1ã€String"></a>1ã€String</h3><p>ä»¥key-valueçš„æ–¹å¼è¿›è¡Œå­˜å‚¨</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-5efbb45995f141b9a9c3762d8e0f9b2a.png" alt="image.png"></p>
<h3 id="2ã€hash"><a href="#2ã€hash" class="headerlink" title="2ã€hash"></a>2ã€hash</h3><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-4c9f503efbe2476b9e2d56d7b7c105bc.png" alt="image.png"></p>
<h3 id="3ã€list"><a href="#3ã€list" class="headerlink" title="3ã€list"></a>3ã€list</h3><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-f7bd516f28f540158964f23626beef7e.png" alt="image.png"></p>
<h3 id="4ã€set"><a href="#4ã€set" class="headerlink" title="4ã€set"></a>4ã€set</h3><p>setç±»å‹ï¼šä¸hashå­˜å‚¨ç»“æ„å®Œå…¨ç›¸åŒï¼Œä»…å­˜å‚¨é”®ï¼Œä¸å­˜å‚¨å€¼ï¼ˆnilï¼‰ï¼Œå¹¶ä¸”å€¼æ˜¯ä¸å…è®¸é‡å¤çš„</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-026d5d4a5ea64ee7bdc5ef3d3fdaed9b.png" alt="image.png"><br><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-122cdbd1b2304d2792c20b26d418f633.png" alt="image.png"></p>
<h3 id="5ã€zset"><a href="#5ã€zset" class="headerlink" title="5ã€zset"></a>5ã€zset</h3><h2 id="ä¸‰ã€Jedis"><a href="#ä¸‰ã€Jedis" class="headerlink" title="ä¸‰ã€Jedis"></a>ä¸‰ã€Jedis</h2><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-ed7ac2231b2a4fad9073ee67a62d09fe.png" alt="image.png"></p>
<h3 id="1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥"><a href="#1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥" class="headerlink" title="1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥"></a>1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥</h3><p>JedisPoolï¼šJedisæä¾›çš„è¿æ¥æ± æŠ€æœ¯ </p>
<p>poolConfig:è¿æ¥æ± é…ç½®å¯¹è±¡ </p>
<p>host:redisæœåŠ¡åœ°å€</p>
<p>port:redisæœåŠ¡ç«¯å£å·</p>
<p>åˆ›å»ºjedisçš„é…ç½®æ–‡ä»¶ï¼šjedis.properties</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jedis.host=192.168.40.130  </span><br><span class="line">jedis.port=6379  </span><br><span class="line">jedis.maxTotal=50  </span><br><span class="line">jedis.maxIdle=10</span><br></pre></td></tr></table></figure>

<p> åˆ›å»ºJedisUtilsï¼Œä½¿ç”¨é™æ€ä»£ç å—åˆå§‹åŒ–èµ„æº</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class JedisUtils &#123;</span><br><span class="line">    private static int maxTotal;</span><br><span class="line">    private static int maxIdel;</span><br><span class="line">    private static String host;</span><br><span class="line">    private static int port;</span><br><span class="line">    private static JedisPoolConfig jpc;</span><br><span class="line">    private static JedisPool jp;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        ResourceBundle bundle = ResourceBundle.getBundle(&quot;redis&quot;);</span><br><span class="line">        maxTotal = Integer.parseInt(bundle.getString(&quot;redis.maxTotal&quot;));</span><br><span class="line">        maxIdel = Integer.parseInt(bundle.getString(&quot;redis.maxIdel&quot;));</span><br><span class="line">        host = bundle.getString(&quot;redis.host&quot;);</span><br><span class="line">        port = Integer.parseInt(bundle.getString(&quot;redis.port&quot;));</span><br><span class="line">        //Jedisè¿æ¥æ± é…ç½®</span><br><span class="line">        jpc = new JedisPoolConfig();</span><br><span class="line">        jpc.setMaxTotal(maxTotal);</span><br><span class="line">        jpc.setMaxIdle(maxIdel);</span><br><span class="line">        jp = new JedisPool(jpc,host,port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> å¯¹å¤–è®¿é—®æ¥å£ï¼Œæä¾›jedisè¿æ¥å¯¹è±¡ï¼Œè¿æ¥ä»è¿æ¥æ± è·å–ï¼Œåœ¨JedisUtilsä¸­æ·»åŠ ä¸€ä¸ªè·å–jedisçš„æ–¹æ³•ï¼šgetJedis</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static Jedis getJedis()&#123;</span><br><span class="line">	Jedis jedis = jedisPool.getResource();</span><br><span class="line">	return jedis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥"><a href="#å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥" class="headerlink" title="å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥"></a>å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥</h2><h3 id="1ã€å®šæ—¶åˆ é™¤"><a href="#1ã€å®šæ—¶åˆ é™¤" class="headerlink" title="1ã€å®šæ—¶åˆ é™¤"></a>1ã€å®šæ—¶åˆ é™¤</h3><p>åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“keyè®¾ç½®æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸”è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±å®šæ—¶å™¨ä»»åŠ¡ç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ</p>
<ul>
<li><p><strong>ä¼˜ç‚¹</strong>ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨</p>
</li>
<li><p><strong>ç¼ºç‚¹</strong>ï¼šCPUå‹åŠ›å¾ˆå¤§ï¼Œæ— è®ºCPUæ­¤æ—¶è´Ÿè½½é‡å¤šé«˜ï¼Œå‡å ç”¨CPUï¼Œä¼šå½±å“redisæœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰</p>
</li>
</ul>
<h3 id="2ã€æƒ°æ€§åˆ é™¤"><a href="#2ã€æƒ°æ€§åˆ é™¤" class="headerlink" title="2ã€æƒ°æ€§åˆ é™¤"></a>2ã€æƒ°æ€§åˆ é™¤</h3><p>æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ï¼Œä¸åšå¤„ç†ã€‚ç­‰ä¸‹æ¬¡è®¿é—®è¯¥æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­</p>
<ol>
<li>å¦‚æœæœªè¿‡æœŸï¼Œè¿”å›æ•°æ®</li>
<li>å‘ç°å·²è¿‡æœŸï¼Œåˆ é™¤ï¼Œè¿”å›ä¸å­˜åœ¨</li>
</ol>
<ul>
<li><p><strong>ä¼˜ç‚¹</strong>ï¼šèŠ‚çº¦CPUæ€§èƒ½ï¼Œå‘ç°å¿…é¡»åˆ é™¤çš„æ—¶å€™æ‰åˆ é™¤</p>
</li>
<li><p><strong>ç¼ºç‚¹</strong>ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿ç©ºé—´æ¢æ—¶é—´ï¼‰</p>
</li>
</ul>
<h3 id="3ã€å®šæœŸåˆ é™¤"><a href="#3ã€å®šæœŸåˆ é™¤" class="headerlink" title="3ã€å®šæœŸåˆ é™¤"></a>3ã€å®šæœŸåˆ é™¤</h3><ul>
<li><p>Rediså¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½®server.hzçš„å€¼ï¼Œé»˜è®¤ä¸º10</p>
</li>
<li><p>æ¯ç§’é’Ÿæ‰§è¡Œserver.hzæ¬¡<strong>serverCron()</strong>â€”â€”â€“&gt;<strong>databasesCron()</strong>â€”â€”â€”&gt;<strong>activeExpireCycle()</strong></p>
</li>
<li><p>**activeExpireCycle()*<em>å¯¹æ¯ä¸ªexpires[</em>]é€ä¸€è¿›è¡Œæ£€æµ‹ï¼Œæ¯æ¬¡æ‰§è¡Œè€—æ—¶ï¼š250ms&#x2F;server.hz</p>
</li>
<li><p>å¯¹æŸä¸ªexpires[*]æ£€æµ‹æ—¶ï¼ŒéšæœºæŒ‘é€‰Wä¸ªkeyæ£€æµ‹</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å¦‚æœkeyè¶…æ—¶ï¼Œåˆ é™¤key</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡&gt;W*25%ï¼Œå¾ªç¯è¯¥è¿‡ç¨‹</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡â‰¤W*25%ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªexpires[*]ï¼Œ0-15å¾ªç¯</span><br><span class="line"></span><br><span class="line">Wå–å€¼=ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOPå±æ€§å€¼</span><br></pre></td></tr></table></figure>

<ul>
<li>å‚æ•°current_dbç”¨äºè®°å½•<strong>activeExpireCycle()</strong> è¿›å…¥å“ªä¸ªexpires[*] æ‰§è¡Œ</li>
<li>å¦‚æœactiveExpireCycle()æ‰§è¡Œæ—¶é—´åˆ°æœŸï¼Œä¸‹æ¬¡ä»current_dbç»§ç»­å‘ä¸‹æ‰§è¡Œ</li>
</ul>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-eaaeab2df1fa4b34a80b616ccf0e1250.png" alt="image.png"></p>
<p>æ€»çš„æ¥è¯´ï¼šå®šæœŸåˆ é™¤å°±æ˜¯å‘¨æœŸæ€§è½®è¯¢redisåº“ä¸­çš„æ—¶æ•ˆæ€§æ•°æ®ï¼Œé‡‡ç”¨éšæœºæŠ½å–çš„ç­–ç•¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦</p>
<ul>
<li><p><strong>ç‰¹ç‚¹1</strong>ï¼šCPUæ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½®</p>
</li>
<li><p><strong>ç‰¹ç‚¹2</strong>ï¼šå†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šå‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰</p>
</li>
</ul>
<h3 id="4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰"><a href="#4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰" class="headerlink" title="4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰"></a>4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰</h3><p>å½“æ–°æ•°æ®è¿›å…¥redisæ—¶ï¼Œå¦‚æœå†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨<strong>freeMemoryIfNeeded()<strong>æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–° åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼Œredisè¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ã€‚æ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸ºé€å‡ºç®—æ³•ã€‚</strong>ï¼ˆ3ç±»8ç§ï¼‰</strong></p>
<p><strong>ç¬¬ä¸€ç±»</strong>ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›†server.db[i].expires ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">volatile-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-lfuï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-ttlï¼šæŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</span><br></pre></td></tr></table></figure>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-9d92b3d0047f4e65b66bdfce123d13bd.png" alt="image.png"></p>
<p><strong>ç¬¬äºŒç±»</strong>ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›†server.db[i].dict ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">allkeys-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span><br><span class="line">allkeLyRs-lfuï¼šï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span><br><span class="line">allkeys-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰ç±»</strong>ï¼šæ”¾å¼ƒæ•°æ®é©±é€</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">no-envictionï¼ˆé©±é€ï¼‰ï¼šç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory)</span><br></pre></td></tr></table></figure>

<h2 id="äº”ã€redisé›†ç¾¤"><a href="#äº”ã€redisé›†ç¾¤" class="headerlink" title="äº”ã€redisé›†ç¾¤"></a>äº”ã€redisé›†ç¾¤</h2><h3 id="1ã€ä¸»ä»å¤åˆ¶"><a href="#1ã€ä¸»ä»å¤åˆ¶" class="headerlink" title="1ã€ä¸»ä»å¤åˆ¶"></a>1ã€ä¸»ä»å¤åˆ¶</h3><p>å•æœºçš„ redisï¼Œèƒ½å¤Ÿæ‰¿è½½çš„ QPS å¤§æ¦‚å°±åœ¨ä¸Šä¸‡åˆ°å‡ ä¸‡ä¸ç­‰ã€‚å¯¹äºç¼“å­˜æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘<strong>è¯»é«˜å¹¶å‘</strong>çš„ã€‚å› æ­¤æ¶æ„åšæˆä¸»ä»(master-slave)æ¶æ„ï¼Œä¸€ä¸»å¤šä»ï¼Œä¸»è´Ÿè´£å†™ï¼Œå¹¶ä¸”å°†æ•°æ®å¤åˆ¶åˆ°å…¶å®ƒçš„ slave èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»ã€‚æ‰€æœ‰çš„<strong>è¯»è¯·æ±‚å…¨éƒ¨èµ°ä»èŠ‚ç‚¹</strong>ã€‚è¿™æ ·ä¹Ÿå¯ä»¥å¾ˆè½»æ¾å®ç°æ°´å¹³æ‰©å®¹ï¼Œ<strong>æ”¯æ’‘è¯»é«˜å¹¶å‘</strong>ã€‚</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-d313f43c4d2f431196ddec6f20e08972.png" alt="image.png"></p>
<h4 id="1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨"><a href="#1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨" class="headerlink" title="1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h4><ul>
<li><p>è¯»å†™åˆ†ç¦»ï¼šmasterå†™ã€slaveè¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ›</p>
</li>
<li><p>è´Ÿè½½å‡è¡¡ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”±slaveåˆ†æ‹…masterè´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜slaveçš„æ•° é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜RedisæœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡</p>
</li>
<li><p>æ•…éšœæ¢å¤ï¼šå½“masterå‡ºç°é—®é¢˜æ—¶ï¼Œç”±slaveæä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤</p>
</li>
<li><p>æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</p>
</li>
<li><p>é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç°Redisçš„é«˜å¯ç”¨æ–¹æ¡ˆ</p>
</li>
</ul>
<h4 id="2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹"><a href="#2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹" class="headerlink" title="2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹"></a>2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹</h4><p>ä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µ</p>
<ul>
<li><p>å»ºç«‹è¿æ¥é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰</p>
</li>
<li><p>æ•°æ®åŒæ­¥é˜¶æ®µ</p>
</li>
<li><p>å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼ˆåå¤åŒæ­¥ï¼‰<br><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-0b915a6d7314481b9e5f03c7eb6cf48d.png" alt="image.png"></p>
</li>
</ul>
<h5 id="é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥"><a href="#é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥" class="headerlink" title="é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥"></a>é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥</h5><p>å»ºç«‹slaveåˆ°masterçš„è¿æ¥ï¼Œä½¿masterèƒ½å¤Ÿè¯†åˆ«slaveï¼Œå¹¶ä¿å­˜slaveç«¯å£å·</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>æ­¥éª¤1ï¼šè®¾ç½®masterçš„åœ°å€å’Œç«¯å£ï¼Œä¿å­˜masterä¿¡æ¯</p>
</li>
<li><p>æ­¥éª¤2ï¼šå»ºç«‹socketè¿æ¥</p>
</li>
<li><p>æ­¥éª¤3ï¼šå‘é€pingå‘½ä»¤ï¼ˆå®šæ—¶å™¨ä»»åŠ¡ï¼‰</p>
</li>
<li><p>æ­¥éª¤4ï¼šèº«ä»½éªŒè¯</p>
</li>
<li><p>æ­¥éª¤5ï¼šå‘é€slaveç«¯å£ä¿¡æ¯</p>
</li>
</ol>
<p>è‡³æ­¤ï¼Œä¸»ä»è¿æ¥æˆåŠŸï¼</p>
<p>å½“å‰çŠ¶æ€ï¼š</p>
<p>slaveï¼šä¿å­˜masterçš„åœ°å€ä¸ç«¯å£</p>
<p>masterï¼šä¿å­˜slaveçš„ç«¯å£</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-5218299629984afeb49550cb754c4dcc.png" alt="image.png"></p>
<h5 id="é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥"><a href="#é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥" class="headerlink" title="é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥"></a>é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥</h5><ul>
<li>åœ¨slaveåˆæ¬¡è¿æ¥masteråï¼Œå¤åˆ¶masterä¸­çš„æ‰€æœ‰æ•°æ®åˆ°slave</li>
<li>å°†slaveçš„æ•°æ®åº“çŠ¶æ€æ›´æ–°æˆmasterå½“å‰çš„æ•°æ®åº“çŠ¶æ€</li>
</ul>
<p>åŒæ­¥è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>æ­¥éª¤1ï¼šè¯·æ±‚åŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤2ï¼šåˆ›å»ºRDBåŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤3ï¼šæ¢å¤RDBåŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤4ï¼šè¯·æ±‚éƒ¨åˆ†åŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤5ï¼šæ¢å¤éƒ¨åˆ†åŒæ­¥æ•°æ®</p>
</li>
</ol>
<p>è‡³æ­¤ï¼Œæ•°æ®åŒæ­¥å·¥ä½œå®Œæˆï¼</p>
<p>å½“å‰çŠ¶æ€ï¼š</p>
<p>slaveï¼šå…·æœ‰masterç«¯å…¨éƒ¨æ•°æ®ï¼ŒåŒ…å«RDBè¿‡ç¨‹æ¥æ”¶çš„æ•°æ®</p>
<p>masterï¼šä¿å­˜slaveå½“å‰æ•°æ®åŒæ­¥çš„ä½ç½®</p>
<p>æ€»ä½“ï¼šä¹‹é—´å®Œæˆäº†æ•°æ®å…‹éš†</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-bcd8b524679c43d2b683535ef58192f4.png" alt="image.png"></p>
<p><strong>æ•°æ®åŒæ­¥é˜¶æ®µmasterè¯´æ˜</strong></p>
<p>1ï¼šå¦‚æœmasteræ•°æ®é‡å·¨å¤§ï¼Œæ•°æ®åŒæ­¥é˜¶æ®µåº”é¿å¼€æµé‡é«˜å³°æœŸï¼Œé¿å…é€ æˆmasteré˜»å¡ï¼Œå½±å“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œ</p>
<p>2ï¼šå¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´æ•°æ®æº¢å‡ºã€‚å¦‚è¿›è¡Œå…¨é‡å¤åˆ¶å‘¨æœŸå¤ªé•¿ï¼Œè¿›è¡Œéƒ¨åˆ†å¤åˆ¶æ—¶å‘ç°æ•°æ®å·²ç»å­˜åœ¨ä¸¢å¤±çš„æƒ…å†µï¼Œå¿…é¡»è¿›è¡Œç¬¬äºŒæ¬¡å…¨é‡å¤åˆ¶ï¼Œè‡´ä½¿slaveé™·å…¥æ­»å¾ªç¯çŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">repl-backlog-size ?mb</span><br></pre></td></tr></table></figure>

<ol>
<li>masterå•æœºå†…å­˜å ç”¨ä¸»æœºå†…å­˜çš„æ¯”ä¾‹ä¸åº”è¿‡å¤§ï¼Œå»ºè®®ä½¿ç”¨50%-70%çš„å†…å­˜ï¼Œç•™ä¸‹30%-50%çš„å†…å­˜ç”¨äºæ‰§ è¡Œbgsaveå‘½ä»¤å’Œåˆ›å»ºå¤åˆ¶ç¼“å†²åŒº</li>
</ol>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-f80b80cac8d84ea5a6f1f9c7b5faf1a0.png" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/2396018/1599985757856-9f821705-f68d-4bf4-a7bb-b4db0ce971ab.png" alt="img"></p>
<p><strong>æ•°æ®åŒæ­¥é˜¶æ®µslaveè¯´æ˜</strong></p>
<ol>
<li>ä¸ºé¿å…slaveè¿›è¡Œå…¨é‡å¤åˆ¶ã€éƒ¨åˆ†å¤åˆ¶æ—¶æœåŠ¡å™¨å“åº”é˜»å¡æˆ–æ•°æ®ä¸åŒæ­¥ï¼Œå»ºè®®å…³é—­æ­¤æœŸé—´çš„å¯¹å¤–æœåŠ¡</li>
</ol>
<p>  slave-serve-stale-data yes|no</p>
<ol>
<li><p>æ•°æ®åŒæ­¥é˜¶æ®µï¼Œmasterå‘é€ç»™slaveä¿¡æ¯å¯ä»¥ç†è§£masteræ˜¯slaveçš„ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸»åŠ¨å‘slaveå‘é€å‘½ä»¤</p>
</li>
<li><p>å¤šä¸ªslaveåŒæ—¶å¯¹masterè¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmasterå‘é€çš„RDBæ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œå¦‚æœmasterå¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³°</p>
</li>
<li><p>slaveè¿‡å¤šæ—¶ï¼Œå»ºè®®è°ƒæ•´æ‹“æ‰‘ç»“æ„ï¼Œç”±ä¸€ä¸»å¤šä»ç»“æ„å˜ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œä¸­é—´çš„èŠ‚ç‚¹æ—¢æ˜¯masterï¼Œä¹Ÿæ˜¯ slaveã€‚æ³¨æ„ä½¿ç”¨æ ‘çŠ¶ç»“æ„æ—¶ï¼Œç”±äºå±‚çº§æ·±åº¦ï¼Œå¯¼è‡´æ·±åº¦è¶Šé«˜çš„slaveä¸æœ€é¡¶å±‚masteré—´æ•°æ®åŒæ­¥å»¶è¿Ÿ è¾ƒå¤§ï¼Œæ•°æ®ä¸€è‡´æ€§å˜å·®ï¼Œåº”è°¨æ…é€‰æ‹©</p>
</li>
</ol>
<h5 id="2-2-1-3-é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­"><a href="#2-2-1-3-é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­" class="headerlink" title="2.2.1.3 é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­"></a>2.2.1.3 é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­</h5><ul>
<li>å½“masteræ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹åï¼Œå¯¼è‡´ä¸»ä»æœåŠ¡å™¨æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ­¤æ—¶éœ€è¦è®©ä¸»ä»æ•°æ®åŒæ­¥åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼ŒåŒæ­¥çš„åŠ¨ä½œç§°ä¸ºå‘½ä»¤ä¼ æ’­</li>
<li>masterå°†æ¥æ”¶åˆ°çš„æ•°æ®å˜æ›´å‘½ä»¤å‘é€ç»™slaveï¼Œslaveæ¥æ”¶å‘½ä»¤åæ‰§è¡Œå‘½ä»¤</li>
</ul>
<p><strong>å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„éƒ¨åˆ†å¤åˆ¶</strong></p>
<p>å‘½ä»¤ä¼ æ’­é˜¶æ®µå‡ºç°äº†æ–­ç½‘ç°è±¡ï¼š</p>
<p>ç½‘ç»œé—ªæ–­é—ªè¿ï¼šå¿½ç•¥</p>
<p>çŸ­æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šéƒ¨åˆ†å¤åˆ¶</p>
<p>é•¿æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šå…¨é‡å¤åˆ¶</p>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹éƒ¨åˆ†å¤åˆ¶ï¼Œéƒ¨åˆ†å¤åˆ¶çš„ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ </p>
<ol>
<li><p>æœåŠ¡å™¨çš„è¿è¡Œ idï¼ˆrun idï¼‰</p>
</li>
<li><p>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</p>
</li>
<li><p>ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</p>
</li>
</ol>
<p><strong>æœåŠ¡å™¨è¿è¡ŒIDï¼ˆrunidï¼‰</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¦‚å¿µï¼šæœåŠ¡å™¨è¿è¡ŒIDæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œidç»„æˆï¼šè¿è¡Œidç”±40ä½å­—ç¬¦ç»„æˆï¼Œæ˜¯ä¸€ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ä¾‹å¦‚ï¼šfdc9ff13b9bbaab28db42b3d50f852bb5e3fcdceä½œç”¨ï¼šè¿è¡Œidè¢«ç”¨äºåœ¨æœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“ï¼Œè¯†åˆ«èº«ä»½å¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œå¿…é¡»æ¯æ¬¡æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œidï¼Œç”¨äºå¯¹æ–¹è¯†åˆ«å®ç°æ–¹å¼ï¼šè¿è¡Œidåœ¨æ¯å°æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œmasteråœ¨é¦–æ¬¡è¿æ¥slaveæ—¶ï¼Œä¼šå°†è‡ªå·±çš„è¿è¡ŒIDå‘é€ç»™slaveï¼Œslaveä¿å­˜æ­¤IDï¼Œé€šè¿‡info Serverå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„runid</span><br></pre></td></tr></table></figure>

<p><strong>å¤åˆ¶ç¼“å†²åŒº</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¦‚å¿µï¼šå¤åˆ¶ç¼“å†²åŒºï¼Œåˆåå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨æœåŠ¡å™¨æ‰§è¡Œè¿‡çš„å‘½ä»¤ï¼Œæ¯æ¬¡ä¼ æ’­å‘½ä»¤ï¼Œmasteréƒ½ä¼šå°†ä¼ æ’­çš„å‘½ä»¤è®°å½•ä¸‹æ¥ï¼Œå¹¶å­˜å‚¨åœ¨å¤åˆ¶ç¼“å†²åŒº	å¤åˆ¶ç¼“å†²åŒºé»˜è®¤æ•°æ®å­˜å‚¨ç©ºé—´å¤§å°æ˜¯1M	å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œè€Œæ–°å…ƒç´ ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ä½œç”¨ï¼šç”¨äºä¿å­˜masteræ”¶åˆ°çš„æ‰€æœ‰æŒ‡ä»¤ï¼ˆä»…å½±å“æ•°æ®å˜æ›´çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚setï¼Œselectï¼‰æ•°æ®æ¥æºï¼šå½“masteræ¥æ”¶åˆ°ä¸»å®¢æˆ·ç«¯çš„æŒ‡ä»¤æ—¶ï¼Œé™¤äº†å°†æŒ‡ä»¤æ‰§è¡Œï¼Œä¼šå°†è¯¥æŒ‡ä»¤å­˜å‚¨åˆ°ç¼“å†²åŒºä¸­</span><br><span class="line">â€‹```![]()![]()</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼â€”â€”çŠ¶æ€æ¨¡å¼</title>
    <url>/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>åœ¨ä¸€äº›å¤æ‚çš„ä¸šåŠ¡å½“ä¸­ï¼Œæ¶‰åŠåˆ°æŸä¸ªä¸šåŠ¡æœ‰å¤šä¸ªçŠ¶æ€ï¼ŒæŒ‰ç…§ä¼ ç»Ÿå†™æ³•æ— éå°±æ˜¯<code>if else </code>ï¼Œå…¶å®è¿˜æ˜¯æœ‰ä¸€ç§æ¯”è¾ƒä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå°±æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„çŠ¶æ€æœºæ¨¡å¼ã€‚æ²¡æœ‰springä¹‹å‰è™½ç„¶ä¹Ÿèƒ½å®ç°çŠ¶æ€æœºæ¨¡å¼ï¼Œä½†æ˜¯å¹¶ä¸ä¼˜é›…ã€‚ä¸‹é¢æ¥è¯´ä¸€ä¸ªç”¨springbootæ¥å®ç°çŠ¶æ€æœºæ¨¡å¼çš„æ¡ˆä¾‹ã€‚</p>
<pre><code>  ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è®¢å•ï¼šè®¢å•å½“ä¸­æ¶‰åŠåˆ°å¤šä¸ªçŠ¶æ€çš„è·³è½¬ï¼Œæœ‰çš„æ—¶å€™è¿˜éœ€è¦å¯¹ä¿®æ”¹çŠ¶æ€å‰çš„é€»è¾‘è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™ç”¨çŠ¶æ€æœºæ¨¡å¼å°±æ˜¯å¾ˆå¥½çš„å®ç°ã€‚
</code></pre>
<h5 id="1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–"><a href="#1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–" class="headerlink" title="1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–"></a>1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="ä¸»è¦çš„åŒ…ç»“æ„"><a href="#ä¸»è¦çš„åŒ…ç»“æ„" class="headerlink" title="ä¸»è¦çš„åŒ…ç»“æ„:"></a>ä¸»è¦çš„åŒ…ç»“æ„:</h5><p><img src="/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/Snipaste_2021-06-09_22-35-07-d55e4019a7c149b39de4eaa9e76a5e05.png" alt="Snipaste_20210609_223507.png"></p>
<h5 id="2ã€è®¢å•ç±»ï¼š"><a href="#2ã€è®¢å•ç±»ï¼š" class="headerlink" title="2ã€è®¢å•ç±»ï¼š"></a>2ã€è®¢å•ç±»ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:33</span></span><br><span class="line"><span class="comment"> * è®¢å•ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡‘é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çŠ¶æ€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»"><a href="#3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»" class="headerlink" title="3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»"></a>3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:43</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€å¤„ç†è¶…ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderState</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸæ¥çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newOrder æ–°è®¢å•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldOrder è€è®¢å•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder,Order oldOrder)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»"><a href="#4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»" class="headerlink" title="4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»"></a>4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:46</span></span><br><span class="line"><span class="comment"> * è®¢å•å„çŠ¶æ€å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateCommon</span> <span class="keyword">implements</span> <span class="title class_">OrderState</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆæ—¥å¿—</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order è®¢å•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildOrderLog</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿å­˜æ—¥å¿—è®¢å•çŠ¶æ€: &quot;</span> + order.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor1</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(oldOrder))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸åšæ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:1 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor2</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:2 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor3</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:3 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5ã€å·¥å‚ç±»"><a href="#5ã€å·¥å‚ç±»" class="headerlink" title="5ã€å·¥å‚ç±»"></a>5ã€å·¥å‚ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wenlinshan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰beanåå­—å‰ç¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_STATUS</span> <span class="operator">=</span> <span class="string">&quot;orderStatus&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨å…¥åˆ°å®¹å™¨é‡Œé¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Map&lt;String, OrderState&gt; states = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å¯¹åº”çŠ¶æ€çš„æ‰§è¡Œç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…·ä½“çŠ¶æ€çš„æ‰§è¡Œç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OrderState <span class="title function_">getState</span><span class="params">(Integer status)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (states.containsKey(ORDER_STATUS + status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> states.get(ORDER_STATUS + status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æœªæ‰¾åˆ°æ‰§è¡ŒçŠ¶æ€çš„ç±»&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç "><a href="#6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç " class="headerlink" title="6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç "></a>6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç </h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.bll.OrderState;</span><br><span class="line"><span class="keyword">import</span> org.example.bll.OrderStateFactory;</span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.example.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IOrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderStateFactory factory;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveOrUpdateOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾å‡ºåŸæ¥çš„è®¢å•</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">oldOrder</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(order.getId());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(oldOrder)) &#123;</span><br><span class="line">            <span class="comment">//æ–°å¢</span></span><br><span class="line">            <span class="built_in">this</span>.save(order);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(order.getStatus())) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨çŠ¶æ€æœº</span></span><br><span class="line">                factory.getState(order.getStatus()).handle(order,<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®æ”¹</span></span><br><span class="line">        <span class="type">OrderState</span> <span class="variable">orderState</span> <span class="operator">=</span> Objects.isNull(order.getStatus()) ? factory.getState(oldOrder.getStatus()) : factory.getState(order.getStatus());</span><br><span class="line">        orderState.handle(order,oldOrder);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å·²å®ç°ï¼Œä¸‹é¢å¼€å§‹æ¼”ç¤ºâ€˜</p>
<h5 id="7ã€æµ‹è¯•ç±»ï¼š"><a href="#7ã€æµ‹è¯•ç±»ï¼š" class="headerlink" title="7ã€æµ‹è¯•ç±»ï¼š"></a>7ã€æµ‹è¯•ç±»ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.example.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 22:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOrder1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>, BigDecimal.ONE, <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        orderService.saveOrUpdateOrder(order);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/Snipaste_2021-06-09_22-44-33-75bd239201e04e57ae2fd7865222739e.png" alt="Snipaste_20210609_224433.png"></p>
]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
</search>

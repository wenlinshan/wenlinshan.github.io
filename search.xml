<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Beanæ³¨å…¥çš„å››ç§æ–¹å¼</title>
    <url>/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="Beanæ³¨å…¥çš„å››ç§æ–¹å¼"><a href="#Beanæ³¨å…¥çš„å››ç§æ–¹å¼" class="headerlink" title="Beanæ³¨å…¥çš„å››ç§æ–¹å¼"></a>Beanæ³¨å…¥çš„å››ç§æ–¹å¼</h1><h2 id="xml-æ–¹å¼"><a href="#xml-æ–¹å¼" class="headerlink" title="xml æ–¹å¼"></a>xml æ–¹å¼</h2><p>ä¾ç¨€è®°å¾—æœ€æ—©æ¥è§¦<code>Spring</code>çš„æ—¶å€™ï¼Œç”¨çš„è¿˜æ˜¯<code>SSH</code>æ¡†æ¶ï¼Œä¸çŸ¥é“å¤§å®¶å¯¹è¿™ä¸ªè¿˜æœ‰å°è±¡å—ï¼Ÿæ‰€æœ‰çš„<code>bean</code>çš„æ³¨å…¥å¾—ä¾é <code>xml</code>æ–‡ä»¶æ¥å®Œæˆã€‚</p>
<p>å®ƒçš„æ³¨å…¥æ–¹å¼åˆ†ä¸ºï¼š<code>set</code>æ–¹æ³•æ³¨å…¥ã€æ„é€ æ–¹æ³•æ³¨å…¥ã€å­—æ®µæ³¨å…¥ï¼Œè€Œæ³¨å…¥ç±»å‹åˆ†ä¸ºå€¼ç±»å‹æ³¨å…¥ï¼ˆ8ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼‰å’Œå¼•ç”¨ç±»å‹æ³¨å…¥ï¼ˆå°†ä¾èµ–å¯¹è±¡æ³¨å…¥ï¼‰ã€‚</p>
<p>ä»¥ä¸‹æ˜¯<code>set</code>æ–¹æ³•æ³¨å…¥çš„ç®€å•æ ·ä¾‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;teacher&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.vipwen.domain.Teacher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vipwen&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„å®ä½“ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>xmlæ–¹å¼å­˜åœ¨çš„ç¼ºç‚¹å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li><code>xml</code>æ–‡ä»¶é…ç½®èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ—¢è¦ç»´æŠ¤ä»£ç åˆè¦ç»´æŠ¤é…ç½®æ–‡ä»¶ï¼Œå¼€å‘æ•ˆç‡ä½ï¼›</li>
<li>é¡¹ç›®ä¸­é…ç½®æ–‡ä»¶è¿‡å¤šï¼Œç»´æŠ¤èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼›</li>
<li>ç¨‹åºç¼–è¯‘æœŸé—´æ— æ³•å¯¹é…ç½®é¡¹çš„æ­£ç¡®æ€§è¿›è¡ŒéªŒè¯ï¼Œåªèƒ½åœ¨è¿è¡ŒæœŸå‘ç°å¹¶ä¸”å‡ºé”™ä¹‹åä¸æ˜“æ’æŸ¥ï¼›</li>
<li>è§£æ<code>xml</code>æ—¶ï¼Œæ— è®ºæ˜¯å°†<code>xml</code>ä¸€æ¬¡æ€§è£…è¿›å†…å­˜ï¼Œè¿˜æ˜¯ä¸€è¡Œä¸€è¡Œè§£æï¼Œéƒ½ä¼šå ç”¨å†…å­˜èµ„æºï¼Œå½±å“æ€§èƒ½ã€‚</li>
</ol>
<h2 id="æ³¨è§£æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼"></a>æ³¨è§£æ–¹å¼</h2><p>éšç€<code>Spring</code>çš„å‘å±•ï¼Œ<code>Spring 2.5</code>å¼€å§‹å‡ºç°äº†ä¸€ç³»åˆ—æ³¨è§£ï¼Œé™¤äº†æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„@Controllerã€@Serviceã€@Repositoryã€@Component ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•äº†è§£ä¸‹ã€‚</p>
<h3 id="Configuration-Bean"><a href="#Configuration-Bean" class="headerlink" title="@Configuration + @Bean"></a>@Configuration + @Bean</h3><p>å½“æˆ‘ä»¬éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„<code>jar</code>åŒ…æ—¶ï¼Œå¯ä»¥ç”¨<code>@Bean</code>æ³¨è§£æ¥æ ‡æ³¨ï¼ŒåŒæ—¶éœ€è¦æ­é…<code>@Configuration</code>æ¥ä½¿ç”¨ã€‚</p>
<ul>
<li><code>@Configuration</code>ç”¨æ¥å£°æ˜ä¸€ä¸ªé…ç½®ç±»ï¼Œå¯ä»¥ç†è§£ä¸º<code>xml</code>çš„&#96;&#96;æ ‡ç­¾</li>
<li><code>@Bean</code> ç”¨æ¥å£°æ˜ä¸€ä¸ª<code>bean</code>ï¼Œå°†å…¶åŠ å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­ï¼Œå¯ä»¥ç†è§£ä¸º<code>xml</code>çš„&#96;&#96;æ ‡ç­¾</li>
</ul>
<p><strong>ç®€å•æ ·ä¾‹ï¼šå°† RedisTemplate æ³¨å…¥ Spring</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼</span></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// key</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">// æŒ‡å®šè¦åºåˆ—åŒ–çš„åŸŸ(field,get,set)ï¼Œè®¿é—®ä¿®é¥°ç¬¦(public,private,protected)</span></span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        <span class="comment">//value</span></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        redisTemplate.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><p>æˆ‘ä»¬åœ¨ç¿»çœ‹<code>Spring</code>æºç çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šçœ‹åˆ°<code>@Import</code>æ³¨è§£ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨æ¥å°†ç¬¬ä¸‰æ–¹<code>jar</code>åŒ…æ³¨å…¥<code>Spring</code>ï¼Œä½†æ˜¯å®ƒåªå¯ä»¥ä½œç”¨åœ¨<strong>ç±»</strong>ä¸Šã€‚</p>
<p>ä¾‹å¦‚åœ¨æ³¨è§£<code>EnableSpringConfigured</code>ä¸Šå°±åŒ…å«äº†<code>@Import</code>æ³¨è§£ï¼Œç”¨äºå°†<code>SpringConfiguredConfiguration</code>é…ç½®æ–‡ä»¶åŠ è½½è¿›<code>Spring</code>å®¹å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(SpringConfiguredConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableSpringConfigured &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Import</code>çš„<code>value</code>å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªä¸€ä¸ªæ³¨å…¥æ¯”è¾ƒç¹çï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ­é…<code>ImportSelector</code>æ¥å£æ¥ä½¿ç”¨ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(MySelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;org.springframework.data.redis.core.RedisTemplate&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>selectImports</code>æ–¹æ³•è¿”å›çš„æ•°ç»„å°±ä¼šé€šè¿‡<code>@Import</code>æ³¨è§£æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­ã€‚</p>
<p>æ— ç‹¬æœ‰å¶ï¼Œ<code>ImportBeanDefinitionRegistrar</code>æ¥å£ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ³¨å…¥<code>bean</code>çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(AspectJAutoProxyRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç‚¹å‡»<code>AspectJAutoProxyRegistrar</code>ç±»ï¼Œå‘ç°å®ƒå®ç°äº†<code>ImportBeanDefinitionRegistrar</code>æ¥å£ï¼Œå®ƒçš„<code>registerBeanDefinitions</code>æ–¹æ³•ä¾¿æ˜¯æ³¨å…¥<code>bean</code>çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒä¸‹ã€‚</p>
<p>å¦‚æœè§‰å¾—æºä»£ç æ¯”è¾ƒéš¾æ‡‚ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(value = &#123;MyImportBeanDefinitionRegistrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span><br><span class="line"><span class="params">                                        BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">            <span class="type">RootBeanDefinition</span> <span class="variable">tDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Teacher.class);</span><br><span class="line">            <span class="comment">// æ³¨å†Œ Beanï¼Œå¹¶æŒ‡å®šbeançš„åç§°å’Œç±»å‹</span></span><br><span class="line">            registry.registerBeanDefinition(<span class="string">&quot;teacher&quot;</span>, tDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±æŠŠ<code>Teacher</code>ç±»æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­äº†ã€‚</p>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><p>æåˆ°<code>FactoryBean</code>ï¼Œå°±ä¸å¾—ä¸ä¸<code>BeanFactory</code>æ¯”è¾ƒä¸€ç•ªã€‚</p>
<ul>
<li><code>BeanFactory</code> : æ˜¯ <code>Factory</code>ï¼Œ <code>IOC</code>å®¹å™¨æˆ–è€…å¯¹è±¡å·¥å‚ï¼Œæ‰€æœ‰çš„<code>Bean</code>éƒ½ç”±å®ƒè¿›è¡Œç®¡ç†</li>
<li><code>FactoryBean</code> : æ˜¯<code>Bean</code> ï¼Œæ˜¯ä¸€ä¸ªèƒ½äº§ç”Ÿæˆ–è€…ä¿®é¥°å¯¹è±¡ç”Ÿæˆçš„å·¥å‚ <code>Bean</code>ï¼Œå®ç°ä¸å·¥å‚æ¨¡å¼å’Œä¿®é¥°å™¨æ¨¡å¼ç±»ä¼¼</li>
</ul>
<p>é‚£ä¹ˆ<code>FactoryBean</code>æ˜¯å¦‚ä½•å®ç°<code>bean</code>æ³¨å…¥çš„å‘¢ï¼Ÿ</p>
<p>å…ˆå®šä¹‰å®ç°äº†<code>FactoryBean</code>æ¥å£çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeacherFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Teacher&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ­¤å·¥å‚ç®¡ç†çš„å¯¹è±¡å®ä¾‹</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Teacher <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Teacher</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ­¤ FactoryBean åˆ›å»ºçš„å¯¹è±¡çš„ç±»å‹</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Teacher.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åé€šè¿‡ @Configuration + @Beançš„æ–¹å¼å°†<code>TeacherFactoryBean</code>åŠ å…¥åˆ°å®¹å™¨ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TeacherFactoryBean <span class="title function_">teacherFactoryBean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TeacherFactoryBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰å‘å®¹å™¨ä¸­æ³¨å…¥<code>Teacher</code>, è€Œæ˜¯ç›´æ¥æ³¨å…¥çš„<code>TeacherFactoryBean</code>ï¼Œç„¶åä»å®¹å™¨ä¸­æ‹¿<code>Teacher</code>è¿™ä¸ªç±»å‹çš„<code>bean</code>ï¼ŒæˆåŠŸè¿è¡Œã€‚</p>
<h2 id="BDRegistryPostProcessor"><a href="#BDRegistryPostProcessor" class="headerlink" title="BDRegistryPostProcessor"></a>BDRegistryPostProcessor</h2><p>çœ‹åˆ°è¿™ä¸ªæ¥å£ï¼Œä¸çŸ¥é“å¯¹äºç¿»çœ‹è¿‡<code>Spring</code>æºç çš„ä½ æ¥è¯´ç†Ÿä¸ç†Ÿæ‚‰ã€‚å¦‚æœä¸ç†Ÿæ‚‰çš„è¯è¯·å¾€ä¸‹çœ‹ï¼Œè¦æ˜¯ç†Ÿæ‚‰çš„è¯å°±å†çœ‹ä¸€éå§ğŸ˜ƒã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨å†Œbeanåˆ°springå®¹å™¨ä¸­</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BeanFactoryPostProcessor</code>æ¥å£æ˜¯<code>BeanFactory</code>çš„åç½®å¤„ç†å™¨ï¼Œæ–¹æ³•<code>postProcessBeanFactory</code>å¯¹<code>bean</code>çš„å®šä¹‰è¿›è¡Œæ§åˆ¶ã€‚ä»Šå¤©æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ï¼šå®ƒçš„å‚æ•°æ˜¯<code>BeanDefinitionRegistry</code>ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸<code>BeanDefinition</code>æ³¨å†Œç›¸å…³çš„ã€‚</p>
<p><img src="/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/0_jpg-43676f4ff0144f669b179cba83a80b61.jpg" alt="0_jpg"></p>
<p>é€šè¿‡è§‚å¯Ÿè¯¥ç±»ï¼Œæˆ‘ä»¬å‘ç°å®ƒé‡Œè¾¹åŒ…å«äº†<code>registerBeanDefinition</code>æ–¹æ³•ï¼Œè¿™ä¸ªä¸å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„å—ï¼Ÿä¸ºäº†èƒ½æ›´å¥½çš„ä½¿ç”¨è¯¥æ¥å£æ¥è¾¾åˆ°æ³¨å…¥<code>bean</code>çš„ç›®çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>Spring</code>æ˜¯å¦‚ä½•æ“ä½œæ­¤æ¥å£çš„ã€‚</p>
<p><img src="/2022/12/01/Bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F-bean%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/1_jpg-2bc8a40570474895a3ada3f73ac531d4.jpg"></p>
<p>çœ‹ä¸‹<code>invokeBeanFactoryPostProcessors</code>æ–¹æ³•ï¼Œä¼šå‘ç°æ²¡æœ‰å®ç°<code>PriorityOrdered</code>å’Œ<code>Ordered</code>çš„<code>bean</code>ï¼ˆè¿™ç§è·Ÿæˆ‘ä»¬è‡ªå®šä¹‰çš„å®ç°ç±»æœ‰å…³ï¼‰ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">    ......</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥è¯¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanDefinitionRegistryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">    Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, </span></span><br><span class="line"><span class="params">    BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">        postProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°å®ç°äº†<code>BeanDefinitionRegistryPostProcessor</code>æ¥å£çš„<code>bean</code>ï¼Œå…¶<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰æ¥å£å®ç°è¯¥æ¥å£ï¼Œå®ƒçš„<code>postProcessBeanDefinitionRegistry</code>æ–¹æ³•ä¹Ÿä¼šè¢«æ‰§è¡Œã€‚</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç ã€‚è‡ªå®šä¹‰æ¥å£å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanDefinitionRegistryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¿‡ç¨‹ä¸­å…ˆæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">RootBeanDefinition</span> <span class="variable">rootBeanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Teacher.class);</span><br><span class="line">        <span class="comment">//Teacher çš„å®šä¹‰æ³¨å†Œåˆ°springå®¹å™¨ä¸­</span></span><br><span class="line">        registry.registerBeanDefinition(<span class="string">&quot;teacher&quot;</span>, rootBeanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¿‡ç¨‹ä¸­åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ç±»ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">    <span class="type">MyBeanDefinitionRegistryPostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBeanDefinitionRegistryPostProcessor</span>();</span><br><span class="line">    <span class="comment">//å°†è‡ªå®šä¹‰å®ç°ç±»åŠ å…¥ Spring å®¹å™¨</span></span><br><span class="line">    context.addBeanFactoryPostProcessor(postProcessor);</span><br><span class="line">    context.refresh();</span><br><span class="line">    <span class="type">Teacher</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Teacher.class);</span><br><span class="line">    System.out.println(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨å¹¶æ‰“å°ç»“æœ</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">org.springframework.demo.model.Teacher@2473d930</span><br></pre></td></tr></table></figure>

<p>å‘ç°å·²ç»æ³¨å…¥åˆ°<code>Spring</code>å®¹å™¨ä¸­äº†ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>fastdfsåº”ç”¨</title>
    <url>/2021/07/22/fastdfs%E5%BA%94%E7%94%A8-fastdfs%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<ul>
<li><h3 id="ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶"><a href="#ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶" class="headerlink" title="ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶"></a>ä»åº”ç”¨å±‚é¢è¯¦è§£fastdfså„ç»„ä»¶</h3></li>
<li><h3 id="fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜"><a href="#fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜" class="headerlink" title="fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜"></a>fastdfsçš„å¤šæœåŠ¡å™¨åœºæ™¯ä½¿ç”¨åŠéƒ¨ç½²é…ç½®è¯´æ˜</h3></li>
</ul>
<h2 id><a href="#" class="headerlink" title></a></h2><h2 id="ç›¸å…³çš„æ–‡ç« "><a href="#ç›¸å…³çš„æ–‡ç« " class="headerlink" title="ç›¸å…³çš„æ–‡ç« "></a>ç›¸å…³çš„æ–‡ç« </h2><p>1ã€å•ä½“å®‰è£…æ•™ç¨‹ <a href="https://blog.csdn.net/suoyanming/article/details/88797360">https://blog.csdn.net/suoyanming/article/details/88797360</a></p>
<p>2ã€å¼€æºä¸­å›½fastdfsä¸»é¡µ <a href="https://www.oschina.net/p/fastdfs">p&#x2F;fastdfs</a></p>
<p>3ã€githubä¸»é¡µï¼ˆä¸ç¡®å®šæ˜¯å¦æ˜¯åŸä½œè€…ç»´æŠ¤ï¼‰ <a href="https://github.com/happyfish100/fastdfs">happyfish100&#x2F;fastdfs</a></p>
<p>4ã€å¯¹fastdfs-nginx-module å®ç°åŸç†è®²çš„éå¸¸æ¸…æ¥š <strong><a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></strong>   </p>
<h1 id="ä¸€ã€FastDFS"><a href="#ä¸€ã€FastDFS" class="headerlink" title="ä¸€ã€FastDFS"></a><strong>ä¸€ã€FastDFS</strong></h1><p>1ã€FastDFSæ˜¯ä¸€ä¸ªå¼€æºçš„è½»é‡çº§<a href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/1250388">åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</a>ï¼Œå®ƒå¯¹æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å­˜å‚¨ã€æ–‡ä»¶åŒæ­¥ã€æ–‡ä»¶è®¿é—®ï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ï¼‰ç­‰ï¼Œè§£å†³äº†å¤§å®¹é‡å­˜å‚¨å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ã€‚ç‰¹åˆ«é€‚åˆä»¥æ–‡ä»¶ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ï¼Œå¦‚ç›¸å†Œç½‘ç«™ã€è§†é¢‘ç½‘ç«™ç­‰ç­‰ã€‚</p>
<p>2ã€FastDFSä¸ºäº’è”ç½‘é‡èº«å®šåˆ¶ï¼Œå……åˆ†è€ƒè™‘äº†å†—ä½™å¤‡ä»½ã€è´Ÿè½½å‡è¡¡ã€çº¿æ€§æ‰©å®¹ç­‰æœºåˆ¶ï¼Œå¹¶æ³¨é‡é«˜å¯ç”¨ã€é«˜æ€§èƒ½ç­‰æŒ‡æ ‡ï¼Œä½¿ç”¨FastDFSå¾ˆå®¹æ˜“æ­å»ºä¸€å¥—é«˜æ€§èƒ½çš„æ–‡ä»¶æœåŠ¡å™¨é›†ç¾¤æä¾›æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ç­‰æœåŠ¡ã€‚</p>
<h1 id="äºŒã€æ·±å…¥è®¤è¯†FastDFS"><a href="#äºŒã€æ·±å…¥è®¤è¯†FastDFS" class="headerlink" title="äºŒã€æ·±å…¥è®¤è¯†FastDFS"></a><strong>äºŒã€æ·±å…¥è®¤è¯†FastDFS</strong></h1><ul>
<li>ä»»ä½•ä¸€ä¸ªä¸­é—´ä»¶çš„åº”ç”¨ï¼Œéƒ½å¿…é¡»æ·±å…¥äº†è§£è¯¥ä¸­é—´ä»¶å†…éƒ¨å„ç»„ä»¶çš„æ‰¿æ‹…çš„åŠŸèƒ½è§’è‰²ã€è¿è¡Œæœºåˆ¶ï¼Œèƒ½æ·±å…¥äº†è§£å„ç»„ä»¶çš„å®ç°åŸç†æ›´å¥½ã€‚è¿™æ ·æ‰èƒ½çµæ´»åº”å¯¹å®é™…åº”ç”¨åœºæ™¯ã€å¤šå˜çš„ä¸šåŠ¡éœ€æ±‚ã€ç”Ÿäº§ç¯å¢ƒåº”æ€¥ç­‰é—®é¢˜ï¼Œå¿«é€Ÿå®æ–½æ¶æ„è°ƒæ•´ã€‚</li>
<li>æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨FastDFSä½œä¸ºå›¾ç‰‡æ–‡ä»¶æ•°æ®åº“ï¼Œéƒ¨ç½²æ¶æ„ä¸ºå•ä½“ï¼ˆå³ï¼šä¸€ä¸ªtrackerã€ä¸€ä¸ªstorageã€ä¸€ä¸ªgroupï¼‰,ç”±äºæœ¬æ¬¡ç”¨äºéƒ¨ç½²fastdfsçš„æœåŠ¡å™¨ç¡¬ç›˜ç©ºé—´æŠ¥è­¦ï¼Œå½“åŠ¡ä¹‹æ€¥å¿…é¡»æ›´æ”¹fastdfséƒ¨ç½²æ¶æ„ï¼Œæ‰©å±•å­˜å‚¨ã€‚</li>
<li>ä¸‹é¢ä»é¡¹ç›®æ€»ä½“æƒ…å†µã€tracker ã€storageã€fastdfs-nginx-module ã€group ç»„ä»¶è¯¦ç»†è¯´æ˜å…¶åŠŸèƒ½è§’è‰²åŠè¿è¡Œæœºåˆ¶</li>
</ul>
<h2 id="1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ"><a href="#1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ" class="headerlink" title="1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ"></a><strong>1ã€é¡¹ç›®æ€»ä½“æƒ…å†µ</strong></h2><ul>
<li>â€‹    fastdfsæ˜¯å¼€æºçš„é¡¹ç›®</li>
<li>â€‹    é€šè¿‡githubæºç å¯çœ‹å‡ºï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäºCè¯­è¨€å¼€å‘çš„</li>
<li>â€‹    fastdfsæ˜¯åŸºäºæ“ä½œç³»ç»ŸOSçš„æ–‡ä»¶ç®¡ç†ç³»ç»ŸåŠŸèƒ½ä¹‹ä¸Šè¿›è¡Œåˆ†å¸ƒå¼æ–‡ä»¶ç®¡ç†ï¼ˆLinuxã€FreeBSDç­‰ï¼‰ï¼Œé€šè¿‡çœ‹æ–‡ä»¶åœ¨ç¡¬ç›˜çš„ä¿å­˜æ–¹å¼ä¹Ÿå¯ä»¥å¾—å‡º</li>
<li>â€‹    æä¾›Cã€Javaå’ŒPHP APIæ¥å£</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325165732189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325165748158.png" alt="img"></p>
<h2 id="2ã€trackerè·Ÿè¸ªå™¨"><a href="#2ã€trackerè·Ÿè¸ªå™¨" class="headerlink" title="2ã€trackerè·Ÿè¸ªå™¨"></a><strong>2ã€trackerè·Ÿè¸ªå™¨</strong></h2><ul>
<li><p><strong>ä¸»è¦åšè°ƒåº¦å·¥ä½œï¼Œ èµ·è´Ÿè½½å‡è¡¡çš„ä½œç”¨</strong></p>
</li>
<li><p><strong>åœ¨å†…å­˜ä¸­è®°å½•é›†ç¾¤ä¸­æ‰€æœ‰å­˜å‚¨ç»„groupå’Œå­˜å‚¨æœåŠ¡å™¨storage çš„çŠ¶æ€ä¿¡æ¯, æ˜¯å®¢æˆ·ç«¯å’Œæ•°æ®æœåŠ¡å™¨äº¤äº’çš„æ¢çº½</strong></p>
</li>
<li><p><strong>trackerçš„æ ¸å¿ƒå·¥ä½œå†…å®¹</strong>ï¼š</p>
</li>
</ul>
<p>ï¼ˆ1ï¼‰ è®°å½•é›†ç¾¤ä¸­æœ‰å¤šå°‘ä¸ªgroupï¼ˆgroup1\group2â€¦.ï¼‰</p>
<p>(2) æ¯ä¸ªgroup åˆ†å¸ƒåœ¨é‚£ä¸ªå‡ ä¸ªstorageä¸Šï¼Œä»¥åŠstorageæ‰€åœ¨æœºå™¨çš„ipï¼Œç«¯å£ç­‰ä¿¡æ¯ï¼Œgroupä¹‹é—´çš„åŒæ­¥ç”±tracker å’Œstorageä¸€èµ·å®Œæˆï¼ˆåé¢ç»†è®²ï¼‰</p>
<p>ï¼ˆ3ï¼‰å¦‚æœåŒä¸€ä¸ªgroup å­˜åœ¨å¤šä¸ªstorage, è€Œè¿™äº›storageåˆè¢«åˆ†å¸ƒåœ¨ä¸€å°æˆ–å¤šå°æœºå™¨ä¸Šï¼Œé‚£ä¹ˆå¯¹è¯¥groupä¸Šä¼ æˆ–è¯»å–æ–‡ä»¶å…·ä½“è½åˆ°é‚£ä¸ªæœºå™¨ä¸Šï¼ˆå³é‚£ä¸ªstorageï¼‰ï¼Ÿï¼ˆæœ‰ç‚¹ç»•ï¼‰</p>
<p>trackerå®Œç¾çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼šå¤šgroupã€å¤šstorageçš„ä¸Šä¼ å’Œä¸‹è½½åšè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé€šè¿‡é…ç½®tracker.confå¯å®ç°å…·ä½“è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
<p>(4) tracker å¯éƒ¨ç½²å¤šå°ï¼Œå¤šä¸ªtrackeråœ¨æœåŠ¡å™¨å†…å­˜ä¸­è®°å½•çš„ä¿¡æ¯æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡nginxå¯¹trackeråšè´Ÿè½½å‡è¡¡ï¼Œä»¥æé«˜å¹¶å‘æ€§èƒ½åŠå®¹ç¾èƒ½åŠ›</p>
<p>ï¼ˆ5ï¼‰tracker ä¸å»ä¸»åŠ¨è¯»å–storageçš„ç›¸å…³ä¿¡æ¯ï¼Œè€Œæ˜¯ç”±storageä¸»åŠ¨æ¨é€ç»™tracker ï¼ˆ<strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¿…é¡»å…ˆå¯åŠ¨trackerçš„åŸå› </strong>ï¼‰ </p>
<p>ï¼ˆ6ï¼‰ä»¥ä¸‹å›¾ç‰‡æ‘˜è‡ªç½‘ä¸Š ï¼š ä¸Šä¼ æ–‡ä»¶è¿‡ç¨‹ ã€ä¸‹è½½æ–‡ä»¶è¿‡ç¨‹ï¼Œé€šè¿‡å›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼Œtrackerçš„æ ¸å¿ƒå·¥ä½œæ˜¯ä¸ºå®¢æˆ·ç«¯æ‰¾åˆ°ä¸€ä¸ªstorage, clientå®¢æˆ·ç«¯å’Œstorageè¿›è¡Œä¸Šä¼ ä¸‹è½½é€šä¿¡ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/201903251658268.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<ul>
<li><h6 id="tracker-conf-åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker-confä¸­"><a href="#tracker-conf-åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker-confä¸­" class="headerlink" title="tracker.conf (åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker.confä¸­)"></a><strong>tracker.conf (åœ¨åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„ä¸‹ï¼Œé€šè¿‡trackerè´Ÿè½½å‡è¡¡ç»™clientç«¯è¿”å›ç‰¹å®šstorageä¿¡æ¯ï¼Œè€Œè´Ÿè½½å‡è¡¡çš„ç­–ç•¥é…ç½®ä¸»è¦åœ¨tracker.confä¸­)</strong></h6><h2 id="æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜"><a href="#æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜" class="headerlink" title="æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜"></a>æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜</h2></li>
</ul>
<h3 id="ï¼ˆ1ï¼‰disabled-x3D-false"><a href="#ï¼ˆ1ï¼‰disabled-x3D-false" class="headerlink" title="ï¼ˆ1ï¼‰disabled&#x3D;false"></a>ï¼ˆ1ï¼‰disabled&#x3D;false</h3><p>â€‹     <strong>#é…ç½®æ–‡ä»¶æ˜¯å¦å¤±æ•ˆ</strong></p>
<p>â€‹     # is this config file disabled</p>
<p>â€‹    # false for enabled</p>
<p>â€‹    # true for disabled disabled&#x3D;false</p>
<p>â€‹    # is this config file disabled # false for enabled # true for disabled</p>
<h3 id="ï¼ˆ2ï¼‰port-x3D-22122"><a href="#ï¼ˆ2ï¼‰port-x3D-22122" class="headerlink" title="ï¼ˆ2ï¼‰port&#x3D;22122"></a>ï¼ˆ2ï¼‰port&#x3D;22122</h3><p>â€‹      #æœåŠ¡ç«¯å£</p>
<p>â€‹      # the tracker server port</p>
<h3 id="ï¼ˆ3ï¼‰-base-path-x3D-x2F-data-x2F-fastdfs-x2F-tracker"><a href="#ï¼ˆ3ï¼‰-base-path-x3D-x2F-data-x2F-fastdfs-x2F-tracker" class="headerlink" title="ï¼ˆ3ï¼‰ base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;tracker"></a><strong>ï¼ˆ3ï¼‰ base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;tracker</strong></h3><p>â€‹       # å­˜æ”¾track æ•°æ®åŠæ—¥å¿—æ–‡ä»¶ç›®å½• </p>
<p>â€‹       # the base path to store data and log files</p>
<p>â€‹		work_threads&#x3D;4</p>
<p>â€‹     #æ—¶çº¿ç¨‹æ•°ï¼šä¸€èˆ¬å’Œcpuçš„ä¸ªæ•°è®¾ä¸ºåŒä¸€ä¸ªå€¼     </p>
<p>â€‹     # work thread count, should &lt;&#x3D; max_connections</p>
<p>â€‹     # default value is 4</p>
<p>â€‹      # since V2.00</p>
<h3 id="ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰-store-lookup-x3D-1"><a href="#ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰-store-lookup-x3D-1" class="headerlink" title="ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰ store_lookup&#x3D;1"></a><strong>ï¼ˆ4ï¼‰ï¼ˆé‡è¦ï¼‰ store_lookup&#x3D;1</strong></h3><p><strong>ä¸Šä¼ æ–‡ä»¶é€‰æ‹©å“ªä¸ªä¸€ä¸ªgroup çš„ ç­–ç•¥ï¼š0ï¼šè½®è¯¢ï¼›1:æŒ‡å®šç»„ ï¼› 2ï¼š è´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©å‰©ä½™å­˜å‚¨ç©ºé—´æœ€å¤§çš„ç»„group ä¸Šä¼ æ–‡ä»¶</strong></p>
<p>â€‹       # the method of selecting group to upload files</p>
<p>â€‹       # 0: round robin</p>
<p>â€‹       # 1: specify group</p>
<p>â€‹      # 2: load balance, select the max free space group to <strong>upload file</strong></p>
<h3 id="ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰-store-group-x3D-group2"><a href="#ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰-store-group-x3D-group2" class="headerlink" title="ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰ store_group&#x3D;group2"></a><strong>ï¼ˆ5ï¼‰ï¼ˆé‡è¦ï¼‰ store_group&#x3D;group2</strong></h3><p>â€‹    # å½“ store_lookup&#x3D;1 æ—¶ï¼Œè¯¥é…ç½®æœ‰æ•ˆï¼ŒæŒ‡å®šå­˜å‚¨çš„ç»„å</p>
<p>â€‹     # which group to upload file</p>
<p>â€‹     # when store_lookup set to 1, must set store_group to the group name</p>
<h3 id="ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰-store-server-x3D-0"><a href="#ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰-store-server-x3D-0" class="headerlink" title="ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰ store_server&#x3D;0"></a><strong>ï¼ˆ6ï¼‰ï¼ˆé‡è¦ï¼‰ store_server&#x3D;0</strong></h3><p>â€‹    # åº”ç”¨åœºæ™¯ï¼š å­˜åœ¨å¤šä¸ªç›¸åŒçš„ç»„ï¼Œä¾‹å¦‚group1 ï¼Œ åœ¨å¤šä¸ªstorage æœåŠ¡å™¨ä¸Š ä¾‹å¦‚ï¼š192.168.0.171 ã€ï¼Œ</p>
<p>â€‹              å½“ä¸Šä¼ æ–‡ä»¶æ—¶ä¼˜å…ˆé€‰æ‹©é‚£ä¸ªstorageçš„ç­–ç•¥é…ç½®<strong>ï¼š~ 0ï¼šè½®è¯¢ ï¼›1ï¼šæŒ‰ipå‡åºæ’åºåé€‰æ‹©ç¬¬ä¸€ä¸ªipï¼Œå³æœ€å°çš„é‚£ä¸ªip (192.168.0.164)ï¼›2ï¼šæŒ‰ä¼˜å…ˆçº§æ’åˆ—çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨é¡ºåºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Š é«˜ï¼ŒstorageæœåŠ¡å™¨çš„ä¼˜å…ˆåœ¨storage.confä¸­é…ç½® upload_priority å‚æ•°</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20190325165901337.png" alt="img"></p>
<p>  # <strong>which storage server to upload file</strong></p>
<p>â€‹    # 0: round robin (default)</p>
<p>â€‹    # 1: the first server order by ip address</p>
<p>â€‹    # 2: the first server order by priority (the minimal)</p>
<h3 id="ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰-store-path-x3D-0"><a href="#ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰-store-path-x3D-0" class="headerlink" title="ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰ store_path&#x3D;0"></a><strong>ï¼ˆ7ï¼‰ï¼ˆé‡è¦ï¼‰ store_path&#x3D;0</strong></h3><p>â€‹    # åº”ç”¨åœºæ™¯ï¼šé€‰æ‹©å…·ä½“ä¸€ä¸ªç»„çš„é‚£ä¸€æ¡å­˜å‚¨è·¯å¾„ï¼ˆ<strong>ä¸€ä¸ªgroupæœ‰å¤šæ¡å­˜å‚¨è·¯å¾„ï¼Œä¸€èˆ¬ä¸€ä¸ªæœåŠ¡å™¨æœ‰ä¸¤å—å¤§ç¡¬ç›˜æŒ‚è½½åˆ°äº†ä¸¤ä¸ªè·¯å¾„ä¸‹ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾æ–‡ä»¶</strong>ï¼‰ï¼Œ~0ï¼šè½®è¯¢ï¼Œ2ï¼šè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©å‰©ä½™ç©ºé—´æœ€å¤§çš„è·¯å¾„ </p>
<p>â€‹     ï¼ˆ<strong>é€»è¾‘~é‡è¦</strong>ï¼‰ é€šè¿‡ä¸Šé¢çš„é…ç½®å‚æ•°ç¡®å®šäº†3ä»¶äº‹çš„åŸºç¡€ä¸Šï¼Œè¯¥é…ç½®æ‰ä¼šèµ·ä½œç”¨ï¼š</p>
<p>â€‹    ï¼ˆ1ï¼‰ç¡®å®šäº†è¦å­˜å‚¨åœ¨é‚£ä¸ªgroupä¸Šï¼Œä¾‹å¦‚group1ï¼›ï¼ˆ2ï¼‰ç¡®å®šä¸Šä¼ æ–‡ä»¶è¦ä¿å­˜åœ¨é‚£ä¸€å°storage ä¸­çš„group1ï¼Œå‡å¦‚æ˜¯192.168.0.171ï¼›ï¼ˆ3ï¼‰ æ­¤æ—¶å¦‚æœ 192.168.0.171 ä¸Šçš„storage serverä¸­group1 æœ‰ä¸¤ä¸ªå­˜å‚¨è·¯å¾„ï¼Œå³store_path0,store_path1**,(å¯¹åº”çš„æ–‡ä»¶è·¯å¾„å³M00,M01)**</p>
<p><img src="https://img-blog.csdnimg.cn/20190325165922761.png" alt="img"></p>
<p> # which path(means disk or mount point) of the storage server to upload file</p>
<p>â€‹    # 0: round robin</p>
<p>   # 2: load balance, select the max free space path to upload file</p>
<h3 id="ï¼ˆ8ï¼‰download-server-x3D-0"><a href="#ï¼ˆ8ï¼‰download-server-x3D-0" class="headerlink" title="ï¼ˆ8ï¼‰download_server&#x3D;0"></a><strong>ï¼ˆ8ï¼‰download_server&#x3D;0</strong></h3><p>â€‹    # ä¸‹è½½æ–‡ä»¶æ—¶å­˜å‚¨æœåŠ¡å™¨çš„é€‰æ‹©ç­–ç•¥ï¼› åº”ç”¨åœºæ™¯ï¼šè¦ä¸‹è½½çš„æ–‡ä»¶æ‰€åœ¨group å­˜åœ¨å¤šä¸ªstorage æœåŠ¡å™¨ä¸Šï¼Œ ~0ï¼šè½®è¯¢ ï¼›1ï¼šå½“å‰æ–‡ä»¶ä¸Šè½½åˆ°çš„æºå­˜å‚¨æœåŠ¡å™¨</p>
<p>â€‹    # which storage server to download file</p>
<p>â€‹    # 0: round robin (default)</p>
<p>â€‹    # 1: the source storage server which the current file uploaded to</p>
<h3 id="ï¼ˆ9ï¼‰reserved-storage-space-x3D-10"><a href="#ï¼ˆ9ï¼‰reserved-storage-space-x3D-10" class="headerlink" title="ï¼ˆ9ï¼‰reserved_storage_space &#x3D; 10%"></a><strong>ï¼ˆ9ï¼‰reserved_storage_space &#x3D; 10%</strong></h3><p>  # ç»™ç³»ç»Ÿæˆ–å…¶ä»–åº”ç”¨ç¨‹åºé¢„ç•™å­˜å‚¨ç©ºé—´è®¾ç½® </p>
<p>  #ï¼ˆ<strong>é‡è¦</strong>ï¼‰åœºæ™¯ï¼šæŸä¸€ä¸ªgroupæ‰€åœ¨æŸä¸€ä¸ªstorageæœåŠ¡å™¨ï¼ˆå¯èƒ½å­˜åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼‰å‰©ä½™çš„å­˜å‚¨ç©ºé—´å°äºç­‰äºè¿™ä¸ªé˜€å€¼æ—¶ï¼Œåˆ™æ–‡ä»¶ä¸èƒ½è¢«ä¿å­˜ï¼Œå³ä½¿è¯¥groupçš„å…¶ä»–storageæœåŠ¡å™¨è¿˜æœ‰å¾ˆå¤§çš„å­˜å‚¨ç©ºé—´</p>
<p>  # reserved storage space for system or other applications.</p>
<p>  # if the free(available) space of any stoarge server in</p>
<p>  # a group &lt;&#x3D; reserved_storage_space,</p>
<p>  # no file can be uploaded to this group.</p>
<p>  # bytes unit can be one of follows:</p>
<p>  ### G or g for gigabyte(GB)</p>
<p>  ### M or m for megabyte(MB)</p>
<p>  ### K or k for kilobyte(KB)</p>
<p>  ### no unit for byte(B)</p>
<p>  ### XX.XX% as ratio such as reserved_storage_space &#x3D; 10%</p>
<p><img src="https://img-blog.csdnimg.cn/20190325165954851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/2019032517001063.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325170031269.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h2 id="3ã€storage-å­˜å‚¨æœåŠ¡å™¨"><a href="#3ã€storage-å­˜å‚¨æœåŠ¡å™¨" class="headerlink" title="3ã€storage å­˜å‚¨æœåŠ¡å™¨"></a><strong>3ã€storage å­˜å‚¨æœåŠ¡å™¨</strong></h2><ul>
<li><p>storage å®šæœŸå‘trackerå‘é€å¿ƒè·³ï¼ŒæŠ¥å‘Šè‡ªå·±çš„çŠ¶æ€ï¼Œtrackerä¼šå°†åŒç»„çš„ storage serverä¿¡æ¯è¿”å›ç»™storage ï¼ˆè¯¥éƒ¨åˆ†é€»è¾‘åé¢å†ç»†è®²ï¼‰ </p>
</li>
<li><p>trackerä¸è´Ÿè´£å…·ä½“çš„æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½å®ç°ï¼Œè¿™äº›éƒ½æ˜¯æœ‰storageå®Œæˆçš„</p>
</li>
<li><p>storageä¿å­˜æ–‡ä»¶å’Œæ–‡ä»¶çš„å±æ€§</p>
</li>
<li><p>storage serveræ˜¯åŸºäºæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿè¿›è¡Œæ–‡ä»¶ç®¡ç†çš„ï¼ˆä¸Šé¢æœ‰æåˆ°ï¼‰</p>
</li>
<li><p>groupä¹‹é—´æ–‡ä»¶åŒæ­¥ç”±storage server å’Œtacker serverä¸€èµ·å®Œæˆçš„ï¼ˆè¯¥éƒ¨åˆ†é€»è¾‘åé¢å†ç»†è®²ï¼‰ </p>
</li>
<li><p>storage serverçš„çŠ¶æ€ï¼ˆ7ä¸ªï¼‰</p>
</li>
<li><p>FDFS_STORAGE_STATUS_INIT :åˆå§‹åŒ–ï¼Œå°šæœªå¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨</p>
</li>
<li><p>FDFS_STORAGE_STATUS_WAIT_SYNC :ç­‰å¾…åŒæ­¥ï¼Œå·²å¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨</p>
</li>
<li><p>FDFS_STORAGE_STATUS_SYNCING :åŒæ­¥ä¸­</p>
</li>
<li><p>FDFS_STORAGE_STATUS_DELETED :å·²åˆ é™¤ï¼Œè¯¥æœåŠ¡å™¨ä»æœ¬ç»„ä¸­æ‘˜é™¤ï¼ˆæ³¨ï¼šæœ¬çŠ¶æ€çš„åŠŸèƒ½å°šæœªå®ç°ï¼‰</p>
</li>
<li><p>FDFS_STORAGE_STATUS_OFFLINE :ç¦»çº¿</p>
</li>
<li><p>FDFS_STORAGE_STATUS_ONLINE :åœ¨çº¿ï¼Œå°šä¸èƒ½æä¾›æœåŠ¡</p>
</li>
<li><p>FDFS_STORAGE_STATUS_ACTIVE :åœ¨çº¿ï¼Œå¯ä»¥æä¾›æœåŠ¡</p>
</li>
</ul>
<h3 id="storage-conf-æ ¸å¿ƒå‚æ•°é…ç½®"><a href="#storage-conf-æ ¸å¿ƒå‚æ•°é…ç½®" class="headerlink" title="storage.conf æ ¸å¿ƒå‚æ•°é…ç½®"></a>storage.conf æ ¸å¿ƒå‚æ•°é…ç½®</h3><h3 id="ï¼ˆ1ï¼‰port-x3D-23000"><a href="#ï¼ˆ1ï¼‰port-x3D-23000" class="headerlink" title="ï¼ˆ1ï¼‰port&#x3D;23000"></a>ï¼ˆ1ï¼‰port&#x3D;23000</h3><p>   # storage æœåŠ¡ç«¯å£</p>
<p>   # the storage server port</p>
<h3 id="ï¼ˆ2ï¼‰base-path-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage"><a href="#ï¼ˆ2ï¼‰base-path-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage" class="headerlink" title="ï¼ˆ2ï¼‰base_path&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage"></a>ï¼ˆ2ï¼‰base_path&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage</h3><p>   #å­˜æ”¾storage æœåŠ¡çš„æ•°æ®å’Œæ—¥å¿—</p>
<p>   # the base path to store data and log files</p>
<h3 id="ï¼ˆ3ï¼‰store-path0-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage"><a href="#ï¼ˆ3ï¼‰store-path0-x3D-x2F-usr-x2F-local-x2F-fastdfs-x2F-fdfs-storage" class="headerlink" title="ï¼ˆ3ï¼‰store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage"></a><strong>ï¼ˆ3ï¼‰store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;fdfs_storage</strong></h3><p>   # å­˜å‚¨è·¯å¾„é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œå¯¹åº”çš„ store_path_count&#x3D;1 å‚æ•°éœ€è¦ç´¯åŠ </p>
<p>   # store_path#, based 0, if store_path0 not exists, itâ€™s value is base_path</p>
<p>   # the paths must be exist</p>
<p>   #store_path1&#x3D;&#x2F;home&#x2F;yuqing&#x2F;fastdfs2</p>
<h3 id="ï¼ˆ4ï¼‰tracker-server-x3D-192-168-0-171-22122"><a href="#ï¼ˆ4ï¼‰tracker-server-x3D-192-168-0-171-22122" class="headerlink" title="ï¼ˆ4ï¼‰tracker_server&#x3D;192.168.0.171:22122"></a><strong>ï¼ˆ4ï¼‰tracker_server&#x3D;192.168.0.171:22122</strong></h3><p>   #tracker æœåŠ¡çš„ ipå’Œç«¯å£ï¼Œ ipæ›¿æ¢ä¸ºåŸŸåä¹Ÿå¯ä»¥ï¼Œå¯ä»¥é…ç½®å¤šä¸ª </p>
<p>   # tracker_server can ocur more than once, and tracker_server format is</p>
<p>   # â€œhost:portâ€, host can be hostname or ip address</p>
<h3 id="ï¼ˆ5ï¼‰file-distribute-path-mode-x3D-0"><a href="#ï¼ˆ5ï¼‰file-distribute-path-mode-x3D-0" class="headerlink" title="ï¼ˆ5ï¼‰file_distribute_path_mode&#x3D;0"></a><strong>ï¼ˆ5ï¼‰file_distribute_path_mode&#x3D;0</strong></h3><p>  # åˆ†å¸ƒå¼å­˜å‚¨æ–‡ä»¶ç­–ç•¥ï¼š å½“storageä¸‹æœ‰å¤šä¸ªå­˜å‚¨è·¯å¾„æ—¶ï¼Œè¯¥é…ç½®èµ·ä½œç”¨ ~ # 0: è½®è¯¢   # 1: æ ¹æ®æ–‡ä»¶åhashç»“æœéšæœºå­˜å‚¨</p>
<p>  # the mode of the files distributed to the data path</p>
<p>  # 0: round robin(default)</p>
<p>  # 1: random, distributted by hash code </p>
<h3 id="ï¼ˆ6ï¼‰upload-priority-x3D-10-ï¼ˆåœ¨tracker-conf-ä¸­æœ‰æåˆ°ï¼‰"><a href="#ï¼ˆ6ï¼‰upload-priority-x3D-10-ï¼ˆåœ¨tracker-conf-ä¸­æœ‰æåˆ°ï¼‰" class="headerlink" title="ï¼ˆ6ï¼‰upload_priority&#x3D;10 ï¼ˆåœ¨tracker.conf ä¸­æœ‰æåˆ°ï¼‰"></a>ï¼ˆ6ï¼‰upload_priority&#x3D;10 ï¼ˆåœ¨tracker.conf ä¸­æœ‰æåˆ°ï¼‰</h3><p># ä¸Šä¼ æ–‡ä»¶äº‹ï¼ŒåŒç»„å†…çš„storage æœåŠ¡å™¨ä¼˜å…ˆçº§è®¾ç½®ï¼Œä¸”å½“ tracker.conf ä¸­store_server&#x3D; 2æ—¶ èµ·ä½œç”¨ï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</p>
<p># the priority as a source server for uploading file.</p>
<p># the lower this value, the higher its uploading priority.</p>
<p># default value is 10</p>
<h2 id="4ã€group"><a href="#4ã€group" class="headerlink" title="4ã€group"></a><strong>4ã€group</strong></h2><ul>
<li>group åˆ†ç»„æ˜¯fastdfsåº”å¯¹å¤§æµé‡åº”ç”¨ç³»ç»Ÿä¸­å¤„ç†é«˜å¹¶å‘ã€é«˜å®¹ç¾çš„ç»å…¸è®¾è®¡ï¼Œå¹¶ä¸”groupè¿˜èµ·åˆ°äº†åº”ç”¨éš”ç¦»çš„åŠŸèƒ½</li>
<li>ä¸€ä¸ªgroupå¯ä»¥å­˜åœ¨å¤šä¸ªstorageä¸­ï¼ˆåœ¨storageä¸­ä¹Ÿå¯ä»¥æåˆ°ï¼‰</li>
<li>æ ¹æ®clientç«¯çš„è¯·æ±‚åˆ†é…åˆ°ä¸åŒçš„groupï¼Œæ–‡ä»¶ç³»ç»Ÿå…·å¤‡ç›´æ¥çš„è´Ÿè½½å‡è¡¡ï¼›</li>
<li>groupå†…æœ‰storageæœåŠ¡èŠ‚ç‚¹åæ‰æ—¶ï¼Œéœ€ä»å…¶ä»–groupå†…æ¢å¤æ•°æ®</li>
</ul>
<h2 id="5ã€-fastdfs-nginx-module"><a href="#5ã€-fastdfs-nginx-module" class="headerlink" title="5ã€ fastdfs-nginx-module"></a><strong>5ã€ fastdfs-nginx-module</strong></h2><ul>
<li><p>fastdfs ä¸­storageã€tracker å‡æä¾›çš„httpæœåŠ¡ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æ–‡ä»¶ï¼Œä½†è€ƒè™‘åˆ°æ€§èƒ½åŠè´Ÿè½½å®ç°éš¾æ˜“åº¦çš„é—®é¢˜ï¼Œä¸€èˆ¬éƒ½ç”¨webæœåŠ¡å™¨æ¥ä¸‹è½½æ–‡ä»¶ï¼Œä¾‹å¦‚nginxã€apache</p>
</li>
<li><p>fastdfs-nginx-module å°±æ˜¯fastdfsåŸºäºngnixå®ç°æ–‡ä»¶httpä¼ è¾“çš„ç»„ä»¶ï¼Œä»¥nginx moduleçš„æ–¹å¼æ·»åŠ åˆ°nginx ç¨‹åºä¸­</p>
</li>
<li><p>æ¯ä¸ªstorage å‡éœ€å®‰è£… fastdfs-nginx-module ã€Nginx ï¼Œå½“å‰storageæ‰¾ä¸åˆ°æ–‡ä»¶æ—¶ï¼Œå‘<strong>æºstorage</strong>ä¸»æœºå‘èµ·redirecté‡å®šå‘æˆ–proxyè½¬å‘ä»£ç†åŠ¨ä½œ</p>
</li>
<li><p>fastdfs-nginx-module å®‰è£…åç›®å½•ç»“æ„å¦‚ä¸‹å›¾</p>
<p>è¯´æ˜åŠå›¾ç‰‡ æ‘˜è‡ªï¼š<a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></p>
</li>
</ul>
<p>â€‹     (1)ngx_http_fastdfs_module.c  ~ nginx æ¨¡å—æ¥å£å®ç°æ–‡ä»¶ï¼Œç”¨äºå‘nginx æ¥å…¥fastdfs-moduleæ ¸å¿ƒæ¨¡å—é€»è¾‘</p>
<p>â€‹    ï¼ˆ2ï¼‰common.c  ~ fastdfs-moduleæ ¸å¿ƒæ¨¡å—ï¼Œå®ç°äº†åˆå§‹åŒ–ã€æ–‡ä»¶ä¸‹è½½çš„ä¸»è¦é€»è¾‘</p>
<p>â€‹    ï¼ˆ3ï¼‰config   ~ ç¼–è¯‘æ¨¡å—æ‰€ç”¨çš„é…ç½®ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›é‡è¦çš„å¸¸é‡ï¼Œè°ƒç”¨fastdfsåŸºç¡€ç»„ä»¶åŠŸèƒ½ï¼Œä»¥åŠæ‰©å±•é…ç½®æ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶ä¸‹è½½chunkå¤§å°</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">ï¼ˆ4ï¼‰mod_fastdfs.conf  ~æ‰©å±•é…ç½®æ–‡ä»¶çš„demoï¼Œä¸€èˆ¬ä¼šå°†è¯¥æ–‡ä»¶æ‹·è´åˆ°configæŒ‡å®šçš„ç›®å½•ä¸‹ ä¾‹å¦‚ï¼š/etc/fdfs</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190325170102450.png" alt="img"></p>
<ul>
<li>åˆå§‹åŒ–ï¼š nginxå¯åŠ¨æ—¶ï¼Œ  fastdfs-nginx-module è¦å®Œæˆåˆå§‹åŒ–å¦‚ä¸‹å›¾ ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨mod_fastdfs.confé…ç½®å‚æ•°ï¼Œå¦‚ä¸‹å›¾</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325170132699.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/2019032517015280.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20190325170205559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><strong>ï¼ˆé‡è¦ï¼‰ï¼š fastdfs-nginx-module åˆå§‹åŒ–çš„è¿‡ç¨‹è¦åŠ è½½mod_fastdfs.confå‚æ•°ï¼Œå¦‚æœæœ¬æœºå™¨ä¸‹å­˜åœ¨å¤šä¸ªstorage,ä¸”æœ‰å¤šä¸ªgroupï¼ˆgroup1ã€group2ï¼‰,åˆ™ mod_fastdfs.conf é…ç½®éœ€åšå¦‚ä¸‹å˜åŠ¨</strong></p>
<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><p><strong>ï¼ˆ1ï¼‰ç»„åï¼šgroup_name&#x3D;group1&#x2F;group2   å¤šä¸ªç”¨&#x2F;åŒºåˆ†å¼€</strong></p>
<p><strong>ï¼ˆ2ï¼‰è®¾ç½®ç»„ä¸ªæ•°ï¼šgroup_count &#x3D; 4</strong></p>
<p><strong>ï¼ˆ4ï¼‰è®¾ç½®å„groupä¿¡æ¯ï¼š</strong></p>
<p><strong>[group1]</strong></p>
<p><strong>group_name&#x3D;group1</strong></p>
<p><strong>storage_server_port&#x3D;23000</strong></p>
<p><strong>store_path_count&#x3D;1</strong></p>
<p><strong>store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;storage</strong></p>
<p><strong>[group2]</strong></p>
<p><strong>group_name&#x3D;group2</strong></p>
<p><em><strong>*storage_server_port&#x3D;23010*</strong></em></p>
<p><strong>store_path_count&#x3D;1</strong></p>
<p><strong>store_path0&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs&#x2F;storage</strong></p>
<h3 id="ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx-ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps-www-cnblogs-com-littleatp-p-4361318-html"><a href="#ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx-ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps-www-cnblogs-com-littleatp-p-4361318-html" class="headerlink" title="ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒhttps://www.cnblogs.com/littleatp/p/4361318.html"></a><strong>ï¼ˆé‡è¦ï¼‰é€šè¿‡nginx ä»fastdfsä¸‹è½½æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜å¯å‚è€ƒ<a href="https://www.cnblogs.com/littleatp/p/4361318.html">https://www.cnblogs.com/littleatp/p/4361318.html</a></strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170230230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“-é‡è¦"><a href="#6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“-é‡è¦" class="headerlink" title="6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“**(é‡è¦)**"></a>6ã€å„ç»„ä»¶è¿è¡Œæœºåˆ¶æ€»ç»“**(é‡è¦)**</h3><ul>
<li>â€‹    ä¸€ä¸ªgroup å¯¹åº”å¤šä¸ª storage (1:N)</li>
<li>â€‹    ä¸€ä¸ªstorageå¯¹åº”ä¸€ä¸ªgroup  (1:1)</li>
<li>â€‹    ä¸€ä¸ªtrackerå¯¹åº”å¤šä¸ªstorage(1:N)</li>
<li>â€‹    ä¸€ä¸ªstorageå¯¹åº”å¤šä¸ªtracker(1:N) , tracker å’Œstorageçš„å…³ç³»æ˜¯å¤šå¯¹å¤šï¼ˆN:Mï¼‰</li>
<li>â€‹    ä¸€ä¸ªstorageä¸‹æœ‰å¤šä¸ªå­˜å‚¨è·¯å¾„ store_path(1:N)</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190325170336507.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»"><a href="#7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»" class="headerlink" title="7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»"></a><strong>7ã€éƒ¨ç½²æ¶æ„æ±‡æ€»</strong></h3><h3 id="1ï¼‰å•ä½“éƒ¨ç½²-å•group-å•storage-å•tracker"><a href="#1ï¼‰å•ä½“éƒ¨ç½²-å•group-å•storage-å•tracker" class="headerlink" title="1ï¼‰å•ä½“éƒ¨ç½²: å•group\å•storage\å•tracker"></a>1ï¼‰å•ä½“éƒ¨ç½²: å•group\å•storage\å•tracker</h3><p><img src="https://img-blog.csdnimg.cn/20190325170402345.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²-ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰"><a href="#2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²-ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰" class="headerlink" title="2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²*ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰*"></a><strong>2ï¼‰å•æœåŠ¡å™¨å¤šstorageéƒ¨ç½²*<em>ï¼ˆåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰æ„ä¹‰ï¼‰*</em></strong></h3><h3 id="å¤šgroup-å¤šstorage-å•tracker"><a href="#å¤šgroup-å¤šstorage-å•tracker" class="headerlink" title="å¤šgroup\å¤šstorage\å•tracker"></a><strong>å¤šgroup\å¤šstorage\å•tracker</strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170430665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰"><a href="#3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰" class="headerlink" title="3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•trackerï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰"></a>3ï¼‰å¤šæœåŠ¡å™¨å¤šgroupä¸”groupä¸äº’å¤‡ï¼Œå•tracker<strong>ï¼ˆæˆ‘ä»¬é¡¹ç›®æœ¬æ¬¡ç¡¬ç›˜æ‰©å±•éƒ¨ç½²æ¶æ„ï¼‰</strong></h3><p>   ç”±äºç›®å‰æœåŠ¡å™¨èµ„æºç´§ç¼ºæš‚ä¸åšgroupäº’å¤‡ï¼Œåé¢éœ€è¦åšgroupäº’å¤‡</p>
<p><img src="https://img-blog.csdnimg.cn/20190325170500305.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
<ul>
<li><h3 id="éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®"><a href="#éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®" class="headerlink" title="éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®"></a><strong>éƒ¨ç½²æ­¥éª¤åŠå‚æ•°é…ç½®</strong></h3><p>ï¼ˆ1ï¼‰ä¸¤å°æœåŠ¡å™¨åˆ†åˆ«ä¸º192.168.0.171ã€192.168.0.164ï¼Œ 171æœåŠ¡å™¨æ‹…ä»»çš„åŠŸèƒ½è§’è‰²æ›´å¤šä¸€äº›: æ–‡ä»¶ä¸‹è½½è¯·æ±‚ nginxåŒä¸€å…¥å£ï¼ˆåˆ†å‘åˆ°storage1ã€stroage2ï¼‰ã€tracker server  ã€storage1 - group0ï¼ˆfastdfs-nginx-moduleï¼‰ã€‚</p>
<p>164æœåŠ¡å™¨ä¸»è¦è´Ÿè´£storage1 -group2 çš„å­˜å‚¨ã€ä¸‹è½½åŠŸèƒ½ï¼Œæ²¡æœ‰tacker serverï¼Œç›´æ¥è¿æ¥171æœåŠ¡å™¨çš„tracker,éœ€è¦å®‰è£…nginx ã€ fastdfs-nginx-module</p>
</li>
</ul>
<p>ï¼ˆ2) 171ã€ 164 éƒ½éœ€è¦å®‰è£… fastdfs ã€fastdfs-nginx-moduleã€ nginx å®‰è£…æ­¥éª¤ ä¸ çŸ¥è¯†åº“æ–‡æ¡£  <a href="http://192.168.0.109:8090/pages/viewpage.action?pageId=1606067">Centos7 ä¸Šå®‰è£… FastDFS</a> ä¸€è‡´ ï¼Œä½†æ³¨æ„ä¸€ç‚¹164æœåŠ¡å™¨ä¸ç”¨å¯åŠ¨åŠé…ç½®tracker</p>
<p>ï¼ˆ 3ï¼‰ 171 tracker.conf é…ç½®</p>
<p>   <strong>171 tracker.conf æ ¸å¿ƒå‚æ•°é…ç½®è¯´æ˜ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># is this config file disabled</span><br><span class="line"></span><br><span class="line"># false for enabled</span><br><span class="line"></span><br><span class="line"># true for disabled</span><br><span class="line"></span><br><span class="line">disabled=false</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the tracker server port</span><br><span class="line"></span><br><span class="line">port=22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/tracker</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the method of selecting group to upload files</span><br><span class="line"></span><br><span class="line"># 0: round robin</span><br><span class="line"></span><br><span class="line"># 1: specify group</span><br><span class="line"></span><br><span class="line"># 2: load balance, select the max free space group to upload file</span><br><span class="line"></span><br><span class="line">store_lookup=1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which group to upload file</span><br><span class="line"></span><br><span class="line"># when store_lookup set to 1, must set store_group to the group name</span><br><span class="line"></span><br><span class="line">store_group=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which storage server to upload file</span><br><span class="line"></span><br><span class="line"># 0: round robin (default)</span><br><span class="line"></span><br><span class="line"># 1: the first server order by ip address</span><br><span class="line"></span><br><span class="line"># 2: the first server order by priority (the minimal)</span><br><span class="line"></span><br><span class="line">store_server=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which path(means disk or mount point) of the storage server to upload file</span><br><span class="line"></span><br><span class="line"># 0: round robin</span><br><span class="line"></span><br><span class="line"># 2: load balance, select the max free space path to upload file</span><br><span class="line"></span><br><span class="line">store_path=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># which storage server to download file</span><br><span class="line"></span><br><span class="line"># 0: round robin (default)</span><br><span class="line"></span><br><span class="line"># 1: the source storage server which the current file uploaded to</span><br><span class="line"></span><br><span class="line">download_server=0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># reserved storage space for system or other applications.</span><br><span class="line"></span><br><span class="line"># if the free(available) space of any stoarge server in</span><br><span class="line"></span><br><span class="line"># a group &lt;= reserved_storage_space,</span><br><span class="line"></span><br><span class="line"># no file can be uploaded to this group.</span><br><span class="line"></span><br><span class="line"># bytes unit can be one of follows:</span><br><span class="line"></span><br><span class="line">### G or g for gigabyte(GB)</span><br><span class="line"></span><br><span class="line">### M or m for megabyte(MB)</span><br><span class="line"></span><br><span class="line">### K or k for kilobyte(KB)</span><br><span class="line"></span><br><span class="line">### no unit for byte(B)</span><br><span class="line"></span><br><span class="line">### XX.XX% as ratio such as reserved_storage_space = 10%</span><br><span class="line"></span><br><span class="line">reserved_storage_space = 10%</span><br></pre></td></tr></table></figure>



<h3 id="ï¼ˆ4ï¼‰171-storage-conf-é…ç½®"><a href="#ï¼ˆ4ï¼‰171-storage-conf-é…ç½®" class="headerlink" title="ï¼ˆ4ï¼‰171 storage.conf é…ç½®"></a>ï¼ˆ4ï¼‰171 storage.conf é…ç½®</h3><p><strong>171 storage æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the name of the group this storage server belongs to</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># comment or remove this item for fetching from tracker server,</span><br><span class="line"></span><br><span class="line"># in this case, use_storage_id must set to true in tracker.conf,</span><br><span class="line"></span><br><span class="line"># and storage_ids.conf must be configed correctly.</span><br><span class="line"></span><br><span class="line">group_name=group0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the storage server port</span><br><span class="line"></span><br><span class="line">port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1</span><br><span class="line"></span><br><span class="line">store_path_count=1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path</span><br><span class="line"></span><br><span class="line"># the paths must be exist</span><br><span class="line"></span><br><span class="line">store_path0=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># tracker_server can ocur more than once, and tracker_server format is</span><br><span class="line"></span><br><span class="line">#  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the priority as a source server for uploading file.</span><br><span class="line"></span><br><span class="line"># the lower this value, the higher its uploading priority.</span><br><span class="line"></span><br><span class="line"># default value is 10</span><br><span class="line"></span><br><span class="line">upload_priority=10</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ5ï¼‰171-fastdfs-nginx-module-é…ç½®å‚æ•°-ï¼ˆmod-fastdfs-confï¼‰"><a href="#ï¼ˆ5ï¼‰171-fastdfs-nginx-module-é…ç½®å‚æ•°-ï¼ˆmod-fastdfs-confï¼‰" class="headerlink" title="ï¼ˆ5ï¼‰171 fastdfs_nginx_module é…ç½®å‚æ•° ï¼ˆmod_fastdfs.confï¼‰"></a>ï¼ˆ5ï¼‰171 fastdfs_nginx_module é…ç½®å‚æ•° ï¼ˆmod_fastdfs.confï¼‰</h3><p><strong>171 mod_fastdfs.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the base path to store log files</span><br><span class="line"></span><br><span class="line">base_path=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if load FastDFS parameters from tracker server # since V1.12 # default value is false</span><br><span class="line"></span><br><span class="line">load_fdfs_parameters_from_tracker=true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># FastDFS tracker_server can ocur more than once, and tracker_server format is</span><br><span class="line"></span><br><span class="line">#  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line"># valid only when load_fdfs_parameters_from_tracker is true</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the port of the local storage server # the default value is 23000</span><br><span class="line"></span><br><span class="line">storage_server_port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the group name of the local storage server group_name=group0</span><br><span class="line"></span><br><span class="line"># if the url / uri including the group name # set to false when uri like /M00/00/00/xxx # set to true when uri like $&#123;group_name&#125;/M00/00/00/xxx, such as group1/M00/xxx # default value is false</span><br><span class="line"></span><br><span class="line">url_have_group_name = true</span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 # must same as storage.conf store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path # the paths must be exist # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path0=/data/fastdfs/storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># set the group count # set to none zero to support multi-group</span><br><span class="line"></span><br><span class="line"># set to 0  for single group only</span><br><span class="line"></span><br><span class="line"># groups settings section as [group1], [group2], ..., [groupN]</span><br><span class="line"></span><br><span class="line"># default value is 0 # since v1.14</span><br><span class="line"></span><br><span class="line">group_count = 0</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># group settings for group #1 # since v1.14</span><br><span class="line"></span><br><span class="line"># when support multi-group, uncomment following section</span><br><span class="line"></span><br><span class="line">#[group1] #group_name=group1 #storage_server_port=23000</span><br><span class="line"></span><br><span class="line">#store_path_count=2</span><br><span class="line"></span><br><span class="line">#store_path0=/home/yuqing/fastdfs</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># group settings for group #2</span><br><span class="line"></span><br><span class="line"># since v1.14</span><br><span class="line"></span><br><span class="line"># when support multi-group, uncomment following section as neccessary</span><br><span class="line"></span><br><span class="line">#[group2] #group_name=group2</span><br><span class="line"></span><br><span class="line">#storage_server_port=23000</span><br><span class="line"></span><br><span class="line">#store_path_count=1</span><br><span class="line"></span><br><span class="line">#store_path0=/home/yuqing/fastdfs</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ6ï¼‰171-nginx-å‚æ•°é…ç½®-nginx-conf"><a href="#ï¼ˆ6ï¼‰171-nginx-å‚æ•°é…ç½®-nginx-conf" class="headerlink" title="ï¼ˆ6ï¼‰171 nginx å‚æ•°é…ç½® nginx.conf"></a>ï¼ˆ6ï¼‰171 nginx å‚æ•°é…ç½® nginx.conf</h3><p><strong>171 nginx.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œè¯¦è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">events &#123;</span><br><span class="line"></span><br><span class="line">    worker_connections  1024;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;    </span><br><span class="line"></span><br><span class="line">    include       mime.types;    </span><br><span class="line"></span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;    </span><br><span class="line"></span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">        #keepalive_timeout  0;    </span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">        #gzip  on;</span><br><span class="line"></span><br><span class="line">    # 192.168.0.164 storage group2 </span><br><span class="line"></span><br><span class="line">    upstream fdfs_group2_164 &#123; </span><br><span class="line"></span><br><span class="line">        server 192.168.0.164:8288 weight=1 max_fails=2 fail_timeout=30s; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    server &#123;        </span><br><span class="line"></span><br><span class="line">        listen       8070;        </span><br><span class="line"></span><br><span class="line">        server_name  localhost,192.168.0.171;</span><br><span class="line"></span><br><span class="line">            #charset koi8-r;</span><br><span class="line"></span><br><span class="line">            #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">            location / &#123;            </span><br><span class="line"></span><br><span class="line">            root   html;            </span><br><span class="line"></span><br><span class="line">            max_ranges 1;            </span><br><span class="line"></span><br><span class="line">            index  index.html index.htm;        </span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location /group0/M00&#123;            </span><br><span class="line"></span><br><span class="line">            root /data/fastdfs/storage/data;            </span><br><span class="line"></span><br><span class="line">            ngx_fastdfs_module;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;OPTIONS&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;               </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Content-Type&#x27; &#x27;text/plain charset=UTF-8&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Content-Length&#x27; 0;                </span><br><span class="line"></span><br><span class="line">                return 204;              &#125;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;POST&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;              &#125;            </span><br><span class="line"></span><br><span class="line">            if ($request_method = &#x27;GET&#x27;) &#123;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;                </span><br><span class="line"></span><br><span class="line">                add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Accept-Ranges, Content-Encoding, Content-Length, Content-Range&#x27;;              &#125;      </span><br><span class="line"></span><br><span class="line">            if ($arg_attname ~* \.(doc|docx|txt|pdf|zip|rar|txt|jpg|png|gif|bmp)$) &#123;</span><br><span class="line"></span><br><span class="line">                add_header &quot;Content-Disposition&quot; &quot;attachment;filename=$arg_attname&quot;;</span><br><span class="line"></span><br><span class="line">                    &#125;        </span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location ~* /group2/(M00|M01) &#123;  </span><br><span class="line"></span><br><span class="line">                proxy_next_upstream http_502 http_504 error timeout invalid_header; </span><br><span class="line"></span><br><span class="line">                proxy_pass http://fdfs_group2_164;</span><br><span class="line"></span><br><span class="line">                expires 30d; </span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">         error_page   500 502 503 504  /50x.html;        </span><br><span class="line"></span><br><span class="line">        location = /50x.html &#123;             root   html;         &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ7ï¼‰164-storageå‚æ•°é…ç½®"><a href="#ï¼ˆ7ï¼‰164-storageå‚æ•°é…ç½®" class="headerlink" title="ï¼ˆ7ï¼‰164 storageå‚æ•°é…ç½®"></a>ï¼ˆ7ï¼‰164 storageå‚æ•°é…ç½®</h3><p><strong>164 storage.con æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the name of the group this storage server belongs to # # comment or remove this item for fetching from tracker server, # in this case, use_storage_id must set to true in tracker.conf,</span><br><span class="line"></span><br><span class="line"># and storage_ids.conf must be configed correctly.</span><br><span class="line"></span><br><span class="line">group_name=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the storage server</span><br><span class="line"></span><br><span class="line"> port port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the base path to store data and log files</span><br><span class="line"></span><br><span class="line">base_path=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path # the paths must be exist</span><br><span class="line"></span><br><span class="line">store_path0=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># tracker_server can ocur more than once, and tracker_server format is #  &quot;host:port&quot;, host can be hostname or ip address</span><br><span class="line"></span><br><span class="line">tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the priority as a source server for uploading file. # the lower this value, the higher its uploading priority. # default value is 10</span><br><span class="line"></span><br><span class="line">upload_priority=10</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ8ï¼‰-164-fastdfs-nginx-module-å‚æ•°é…ç½®-ï¼ˆmod-fastdfs-confï¼‰"><a href="#ï¼ˆ8ï¼‰-164-fastdfs-nginx-module-å‚æ•°é…ç½®-ï¼ˆmod-fastdfs-confï¼‰" class="headerlink" title="ï¼ˆ8ï¼‰ 164 fastdfs_nginx_module å‚æ•°é…ç½® ï¼ˆmod_fastdfs.confï¼‰"></a>ï¼ˆ8ï¼‰ 164 fastdfs_nginx_module å‚æ•°é…ç½® ï¼ˆmod_fastdfs.confï¼‰</h3><p><strong>164 mod_fastdfs.conf æ ¸å¿ƒå‚æ•°é…ç½®ï¼Œå…¶ä»–å‚æ•°è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># the base path to store log files</span><br><span class="line"></span><br><span class="line">base_path=/usr/local/fastdfs/</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if load FastDFS parameters from tracker server # since V1.12 # default value is false</span><br><span class="line"></span><br><span class="line">load_fdfs_parameters_from_tracker=true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># FastDFS tracker_server can ocur more than once, and tracker_server format is #  &quot;host:port&quot;, host can be hostname or ip address # valid only when load_fdfs_parameters_from_tracker is true tracker_server=192.168.0.171:22122</span><br><span class="line"></span><br><span class="line"># the port of the local storage server # the default value is 23000</span><br><span class="line"></span><br><span class="line">storage_server_port=23000</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># the group name of the local storage server</span><br><span class="line"></span><br><span class="line">group_name=group2</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># if the url / uri including the group name</span><br><span class="line"></span><br><span class="line"># set to false when uri like /M00/00/00/xxx</span><br><span class="line"></span><br><span class="line"># set to true when uri like $&#123;group_name&#125;/M00/00/00/xxx, such as group1/M00/xxx</span><br><span class="line"></span><br><span class="line"># default value is false</span><br><span class="line"></span><br><span class="line">url_have_group_name = true</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># path(disk or mount point) count, default value is 1 # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path_count=1</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path</span><br><span class="line"></span><br><span class="line"># the paths must be exist # must same as storage.conf</span><br><span class="line"></span><br><span class="line">store_path0=/usr/local/fastdfs/fdfs_storage</span><br><span class="line"></span><br><span class="line">#store_path1=/home/yuqing/fastdfs1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># set the group count # set to none zero to support multi-group</span><br><span class="line"></span><br><span class="line"># set to 0  for single group only</span><br><span class="line"></span><br><span class="line"># groups settings section as [group1], [group2], ..., [groupN]</span><br><span class="line"></span><br><span class="line"># default value is 0 # since v1.14</span><br><span class="line"></span><br><span class="line">group_count = 0</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆ9ï¼‰164-nginxå‚æ•°é…ç½®ï¼Œnginx-conf"><a href="#ï¼ˆ9ï¼‰164-nginxå‚æ•°é…ç½®ï¼Œnginx-conf" class="headerlink" title="ï¼ˆ9ï¼‰164 nginxå‚æ•°é…ç½®ï¼Œnginx.conf"></a>ï¼ˆ9ï¼‰164 nginxå‚æ•°é…ç½®ï¼Œnginx.conf</h3><p><strong>164 nginx.conf å‚æ•°é…ç½®ï¼Œè¯¦è§é™„ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user  www  www;</span><br><span class="line"></span><br><span class="line">worker_processes  12;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line"></span><br><span class="line">    worker_connections  1024;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    include       mime.types;</span><br><span class="line"></span><br><span class="line">     default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">       client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen       8288;</span><br><span class="line"></span><br><span class="line">        server_name  192.168.0.164,localhost;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        location /group2/M00/&#123;</span><br><span class="line"></span><br><span class="line">            root /usr/local/fastdfs/fdfs_storage/data;</span><br><span class="line"></span><br><span class="line">             ngx_fastdfs_module;</span><br><span class="line"></span><br><span class="line">        if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Content-Type&#x27; &#x27;text/plain charset=UTF-8&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Content-Length&#x27; 0;</span><br><span class="line"></span><br><span class="line">                 return 204;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             if ($request_method = &#x27;POST&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             if ($request_method = &#x27;GET&#x27;) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line"></span><br><span class="line">                 add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Accept-Ranges, Content-Encoding, Content-Length, Content-Range&#x27;;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                if ($arg_attname ~* \.(doc|docx|txt|pdf|zip|rar|txt|jpg|png|gif|bmp)$) &#123;</span><br><span class="line"></span><br><span class="line">                 add_header &quot;Content-Disposition&quot; &quot;attachment;filename=$arg_attname&quot;;</span><br><span class="line"></span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">         &#125;  </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker"><a href="#4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker" class="headerlink" title="4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker"></a><strong>4ï¼‰çœŸæ­£åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼šå¤šæœåŠ¡å™¨å¤šgroupä¸”groupé—´äº’å¤‡ï¼Œå¤štracker</strong></h3><p><img src="https://img-blog.csdnimg.cn/20190325170807597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1b3lhbm1pbmc=,size_16,color_FFFFFF,t_70" alt="img"></p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLä¼˜åŒ–ä¸‡èƒ½å…¬å¼ï¼š5 å¤§æ­¥éª¤ + 10 ä¸ªæ¡ˆä¾‹</title>
    <url>/2022/08/16/SQL%E4%BC%98%E5%8C%96%E4%B8%87%E8%83%BD%E5%85%AC%E5%BC%8F%EF%BC%9A5%20%E5%A4%A7%E6%AD%A5%E9%AA%A4%20+%2010%20%E4%B8%AA%E6%A1%88%E4%BE%8B-sql-you-hua-wan-neng-gong-shi-5da-bu-zhou-10ge-an-li/</url>
    <content><![CDATA[<h2 id="1ã€å‰è¨€"><a href="#1ã€å‰è¨€" class="headerlink" title="1ã€å‰è¨€"></a>1ã€å‰è¨€</h2><p>åœ¨åº”ç”¨å¼€å‘çš„æ—©æœŸï¼Œæ•°æ®é‡å°‘ï¼Œå¼€å‘äººå‘˜å¼€å‘åŠŸèƒ½æ—¶æ›´é‡è§†åŠŸèƒ½ä¸Šçš„å®ç°ï¼Œéšç€ç”Ÿäº§æ•°æ®çš„å¢é•¿ï¼Œå¾ˆå¤šSQLè¯­å¥å¼€å§‹æš´éœ²å‡ºæ€§èƒ½é—®é¢˜ï¼Œå¯¹ç”Ÿäº§çš„å½±å“ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œæœ‰æ—¶å¯èƒ½è¿™äº›æœ‰é—®é¢˜çš„SQLå°±æ˜¯æ•´ä¸ªç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆã€‚</p>
<h2 id="2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤"><a href="#2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤" class="headerlink" title="2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤"></a>2ã€SQLä¼˜åŒ–ä¸€èˆ¬æ­¥éª¤</h2><p><strong>1ã€é€šè¿‡æ…¢æŸ¥æ—¥å¿—ç­‰å®šä½é‚£äº›æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„SQLè¯­å¥</strong></p>
<p><strong>2ã€explain åˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’</strong></p>
<p>éœ€è¦é‡ç‚¹å…³æ³¨typeã€rowsã€filteredã€extraã€‚</p>
<p>typeç”±ä¸Šè‡³ä¸‹ï¼Œæ•ˆç‡è¶Šæ¥è¶Šé«˜</p>
<ul>
<li>ALL å…¨è¡¨æ‰«æ</li>
<li>index ç´¢å¼•å…¨æ‰«æ</li>
<li>range ç´¢å¼•èŒƒå›´æ‰«æï¼Œå¸¸ç”¨è¯­&lt;,&lt;&#x3D;,&gt;&#x3D;,between,inç­‰æ“ä½œ</li>
<li>ref ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æ‰«ææˆ–å”¯ä¸€ç´¢å¼•å‰ç¼€æ‰«æï¼Œè¿”å›å•æ¡è®°å½•ï¼Œå¸¸å‡ºç°åœ¨å…³è”æŸ¥è¯¢ä¸­</li>
<li>eq_ref ç±»ä¼¼refï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨çš„æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä½¿ç”¨ä¸»é”®çš„å…³è”æŸ¥è¯¢</li>
<li>const&#x2F;system å•æ¡è®°å½•ï¼Œç³»ç»Ÿä¼šæŠŠåŒ¹é…è¡Œä¸­çš„å…¶ä»–åˆ—ä½œä¸ºå¸¸æ•°å¤„ç†ï¼Œå¦‚ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢</li>
<li>null MySQLä¸è®¿é—®ä»»ä½•è¡¨æˆ–ç´¢å¼•ï¼Œç›´æ¥è¿”å›ç»“æœ</li>
<li>è™½ç„¶ä¸Šè‡³ä¸‹ï¼Œæ•ˆç‡è¶Šæ¥è¶Šé«˜ï¼Œä½†æ˜¯æ ¹æ®costæ¨¡å‹ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªç´¢å¼•idx1(a, b, c),idx2(a, c)ï¼ŒSQLä¸ºâ€select * from t where a &#x3D; 1 and b in (1, 2) order by câ€;å¦‚æœèµ°idx1ï¼Œé‚£ä¹ˆæ˜¯typeä¸ºrangeï¼Œå¦‚æœèµ°idx2ï¼Œé‚£ä¹ˆtypeæ˜¯refï¼›å½“éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œä½¿ç”¨idx2å¤§çº¦æ˜¯idx1çš„5å€ä»¥ä¸Šæ—¶ï¼Œä¼šç”¨idx1ï¼Œå¦åˆ™ä¼šç”¨idx2</li>
</ul>
<p>Extra</p>
<ul>
<li>Using filesortï¼šMySQLéœ€è¦é¢å¤–çš„ä¸€æ¬¡ä¼ é€’ï¼Œä»¥æ‰¾å‡ºå¦‚ä½•æŒ‰æ’åºé¡ºåºæ£€ç´¢è¡Œã€‚é€šè¿‡æ ¹æ®è”æ¥ç±»å‹æµè§ˆæ‰€æœ‰è¡Œå¹¶ä¸ºæ‰€æœ‰åŒ¹é…WHEREå­å¥çš„è¡Œä¿å­˜æ’åºå…³é”®å­—å’Œè¡Œçš„æŒ‡é’ˆæ¥å®Œæˆæ’åºã€‚ç„¶åå…³é”®å­—è¢«æ’åºï¼Œå¹¶æŒ‰æ’åºé¡ºåºæ£€ç´¢è¡Œã€‚</li>
<li>Using temporaryï¼šä½¿ç”¨äº†ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼Œæ€§èƒ½ç‰¹åˆ«å·®ï¼Œéœ€è¦é‡ç‚¹ä¼˜åŒ–</li>
<li>Using indexï¼šè¡¨ç¤ºç›¸åº”çš„ select æ“ä½œä¸­ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ˆCoveing Indexï¼‰,é¿å…è®¿é—®äº†è¡¨çš„æ•°æ®è¡Œï¼Œæ•ˆç‡ä¸é”™ï¼å¦‚æœåŒæ—¶å‡ºç° using whereï¼Œæ„å‘³ç€æ— æ³•ç›´æ¥é€šè¿‡ç´¢å¼•æŸ¥æ‰¾æ¥æŸ¥è¯¢åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</li>
<li>Using index conditionï¼šMySQL5.6ä¹‹åæ–°å¢çš„ICPï¼Œusing index condtionå°±æ˜¯ä½¿ç”¨äº†ICPï¼ˆç´¢å¼•ä¸‹æ¨ï¼‰ï¼Œåœ¨å­˜å‚¨å¼•æ“å±‚è¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡å±‚è¿‡æ»¤ï¼Œåˆ©ç”¨ç´¢å¼•ç°æœ‰çš„æ•°æ®å‡å°‘å›è¡¨çš„æ•°æ®ã€‚</li>
</ul>
<p><strong>3ã€show profile åˆ†æ</strong></p>
<p>äº†è§£SQLæ‰§è¡Œçš„çº¿ç¨‹çš„çŠ¶æ€åŠæ¶ˆè€—çš„æ—¶é—´ã€‚</p>
<p>é»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¼€å¯è¯­å¥â€œset profiling &#x3D; 1;â€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROFILES ;<span class="keyword">SHOW</span> PROFILE <span class="keyword">FOR</span> QUERY  #&#123;id&#125;;</span><br></pre></td></tr></table></figure>



<p><strong>4ã€trace</strong></p>
<p>traceåˆ†æä¼˜åŒ–å™¨å¦‚ä½•é€‰æ‹©æ‰§è¡Œè®¡åˆ’ï¼Œé€šè¿‡traceæ–‡ä»¶èƒ½å¤Ÿè¿›ä¸€æ­¥äº†è§£ä¸ºä»€ä¹ˆä¼˜æƒ åˆ¸é€‰æ‹©Aæ‰§è¡Œè®¡åˆ’è€Œä¸é€‰æ‹©Bæ‰§è¡Œè®¡åˆ’ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span>&quot;enabled=on&quot;;<span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace;</span><br></pre></td></tr></table></figure>



<p><strong>5ã€ç¡®å®šé—®é¢˜å¹¶é‡‡ç”¨ç›¸åº”çš„æªæ–½</strong></p>
<ul>
<li>ä¼˜åŒ–ç´¢å¼•</li>
<li>ä¼˜åŒ–SQLè¯­å¥ï¼šä¿®æ”¹SQLã€IN æŸ¥è¯¢åˆ†æ®µã€æ—¶é—´æŸ¥è¯¢åˆ†æ®µã€åŸºäºä¸Šä¸€æ¬¡æ•°æ®è¿‡æ»¤</li>
<li>æ”¹ç”¨å…¶ä»–å®ç°æ–¹å¼ï¼šESã€æ•°ä»“ç­‰</li>
<li>æ•°æ®ç¢ç‰‡å¤„ç†</li>
</ul>
<h2 id="3ã€åœºæ™¯åˆ†æ"><a href="#3ã€åœºæ™¯åˆ†æ" class="headerlink" title="3ã€åœºæ™¯åˆ†æ"></a>3ã€åœºæ™¯åˆ†æ</h2><p><strong>æ¡ˆä¾‹1ã€æœ€å·¦åŒ¹é…</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_orderno` (`shop_id`,`order_no`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> orderno<span class="operator">=</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>æŸ¥è¯¢åŒ¹é…ä»å·¦å¾€å³åŒ¹é…ï¼Œè¦ä½¿ç”¨order_noèµ°ç´¢å¼•ï¼Œå¿…é¡»æŸ¥è¯¢æ¡ä»¶æºå¸¦shop_idæˆ–è€…ç´¢å¼•(shop_id,order_no)è°ƒæ¢å‰åé¡ºåº</p>
<p><strong>æ¡ˆä¾‹2ã€éšå¼è½¬æ¢</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_mobile` (`mobile`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _user <span class="keyword">where</span> mobile<span class="operator">=</span><span class="number">12345678901</span></span><br></pre></td></tr></table></figure>



<p>éšå¼è½¬æ¢ç›¸å½“äºåœ¨ç´¢å¼•ä¸Šåšè¿ç®—ï¼Œä¼šè®©ç´¢å¼•å¤±æ•ˆã€‚mobileæ˜¯å­—ç¬¦ç±»å‹ï¼Œä½¿ç”¨äº†æ•°å­—ï¼Œåº”è¯¥ä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¦åˆ™MySQLä¼šç”¨åˆ°éšå¼æ›¿æ¢ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</p>
<p><strong>æ¡ˆä¾‹3ã€å¤§åˆ†é¡µ</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_a_b_c` (`a`, `b`, `c`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="operator">=</span> <span class="number">2</span> <span class="keyword">order</span> <span class="keyword">by</span> c <span class="keyword">desc</span> limit <span class="number">10000</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>å¯¹äºå¤§åˆ†é¡µçš„åœºæ™¯ï¼Œå¯ä»¥ä¼˜å…ˆè®©äº§å“ä¼˜åŒ–éœ€æ±‚ï¼Œå¦‚æœæ²¡æœ‰ä¼˜åŒ–çš„ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§ä¼˜åŒ–æ–¹å¼ï¼Œ</p>
<p>ä¸€ç§æ˜¯æŠŠä¸Šä¸€æ¬¡çš„æœ€åä¸€æ¡æ•°æ®ï¼Œä¹Ÿå³ä¸Šé¢çš„cä¼ è¿‡æ¥ï¼Œç„¶ååšâ€œc &lt; xxxâ€å¤„ç†ï¼Œä½†æ˜¯è¿™ç§ä¸€èˆ¬éœ€è¦æ”¹æ¥å£åè®®ï¼Œå¹¶ä¸ä¸€å®šå¯è¡Œã€‚</p>
<p>å¦ä¸€ç§æ˜¯é‡‡ç”¨å»¶è¿Ÿå…³è”çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå‡å°‘SQLå›è¡¨ï¼Œä½†æ˜¯è¦è®°å¾—ç´¢å¼•éœ€è¦å®Œå…¨è¦†ç›–æ‰æœ‰æ•ˆæœï¼ŒSQLæ”¹åŠ¨å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select t1.* from _t t1, (select id from _t where a = 1 and b = 2 order by c desc limit 10000, 10) t2 where t1.id = t2.id;</span><br></pre></td></tr></table></figure>



<p><strong>æ¡ˆä¾‹4ã€in + order by</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_status_created` (`shop_id`, `order_status`, `created_at`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> order_status <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_at <span class="keyword">desc</span> limit <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>inæŸ¥è¯¢åœ¨MySQLåº•å±‚æ˜¯é€šè¿‡n*mçš„æ–¹å¼å»æœç´¢ï¼Œç±»ä¼¼unionï¼Œä½†æ˜¯æ•ˆç‡æ¯”unioné«˜ã€‚</p>
<p>inæŸ¥è¯¢åœ¨è¿›è¡Œcostä»£ä»·è®¡ç®—æ—¶ï¼ˆä»£ä»· &#x3D; å…ƒç»„æ•° * IOå¹³å‡å€¼ï¼‰ï¼Œæ˜¯é€šè¿‡å°†inåŒ…å«çš„æ•°å€¼ï¼Œä¸€æ¡æ¡å»æŸ¥è¯¢è·å–å…ƒç»„æ•°çš„ï¼Œå› æ­¤è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ä¼šæ¯”è¾ƒçš„æ…¢ï¼Œæ‰€ä»¥MySQLè®¾ç½®äº†ä¸ªä¸´ç•Œå€¼(eq_range_index_dive_limit)ï¼Œ5.6ä¹‹åè¶…è¿‡è¿™ä¸ªä¸´ç•Œå€¼åè¯¥åˆ—çš„costå°±ä¸å‚ä¸è®¡ç®—äº†ã€‚å› æ­¤ä¼šå¯¼è‡´æ‰§è¡Œè®¡åˆ’é€‰æ‹©ä¸å‡†ç¡®ã€‚é»˜è®¤æ˜¯200ï¼Œå³inæ¡ä»¶è¶…è¿‡äº†200ä¸ªæ•°æ®ï¼Œä¼šå¯¼è‡´inçš„ä»£ä»·è®¡ç®—å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´Mysqlé€‰æ‹©çš„ç´¢å¼•ä¸å‡†ç¡®ã€‚</p>
<p>å¤„ç†æ–¹å¼ï¼Œå¯ä»¥(order_status, created_at)äº’æ¢å‰åé¡ºåºï¼Œå¹¶ä¸”è°ƒæ•´SQLä¸ºå»¶è¿Ÿå…³è”ã€‚</p>
<p><strong>æ¡ˆä¾‹5ã€èŒƒå›´æŸ¥è¯¢é˜»æ–­ï¼Œåç»­å­—æ®µä¸èƒ½èµ°ç´¢å¼•</strong></p>
<p>ç´¢å¼•</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">KEY `idx_shopid_created_status` (`shop_id`, `created_at`, `order_status`)</span><br></pre></td></tr></table></figure>



<p>SQLè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> created_at <span class="operator">&gt;</span> <span class="string">&#x27;2021-01-01 00:00:00&#x27;</span> <span class="keyword">and</span> order_status <span class="operator">=</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>èŒƒå›´æŸ¥è¯¢è¿˜æœ‰â€œINã€betweenâ€</p>
<p><strong>æ¡ˆä¾‹6ã€ä¸ç­‰äºã€ä¸åŒ…å«ä¸èƒ½ç”¨åˆ°ç´¢å¼•çš„å¿«é€Ÿæœç´¢ã€‚ï¼ˆå¯ä»¥ç”¨åˆ°ICPï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> order_status <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>)<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span> shop_id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> order_status <span class="operator">!=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>åœ¨ç´¢å¼•ä¸Šï¼Œé¿å…ä½¿ç”¨NOTã€!&#x3D;ã€&lt;&gt;ã€!&lt;ã€!&gt;ã€NOT EXISTSã€NOT INã€NOT LIKEç­‰</p>
<p><strong>æ¡ˆä¾‹7ã€ä¼˜åŒ–å™¨é€‰æ‹©ä¸ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µ</strong></p>
<p>å¦‚æœè¦æ±‚è®¿é—®çš„æ•°æ®é‡å¾ˆå°ï¼Œåˆ™ä¼˜åŒ–å™¨è¿˜æ˜¯ä¼šé€‰æ‹©è¾…åŠ©ç´¢å¼•ï¼Œä½†æ˜¯å½“è®¿é—®çš„æ•°æ®å æ•´ä¸ªè¡¨ä¸­æ•°æ®çš„è›®å¤§ä¸€éƒ¨åˆ†æ—¶ï¼ˆä¸€èˆ¬æ˜¯20%å·¦å³ï¼‰ï¼Œä¼˜åŒ–å™¨ä¼šé€‰æ‹©é€šè¿‡èšé›†ç´¢å¼•æ¥æŸ¥æ‰¾æ•°æ®ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _order <span class="keyword">where</span>  order_status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>æŸ¥è¯¢å‡ºæ‰€æœ‰æœªæ”¯ä»˜çš„è®¢å•ï¼Œä¸€èˆ¬è¿™ç§è®¢å•æ˜¯å¾ˆå°‘çš„ï¼Œå³ä½¿å»ºäº†ç´¢å¼•ï¼Œä¹Ÿæ²¡æ³•ä½¿ç”¨ç´¢å¼•ã€‚</p>
<p><strong>æ¡ˆä¾‹8ã€å¤æ‚æŸ¥è¯¢</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(amt) <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="string">&#x27;2020-01-01&#x27;</span>;<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="keyword">and</span> c <span class="operator">&gt;</span> <span class="string">&#x27;2020-01-01&#x27;</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>å¦‚æœæ˜¯ç»Ÿè®¡æŸäº›æ•°æ®ï¼Œå¯èƒ½æ”¹ç”¨æ•°ä»“è¿›è¡Œè§£å†³ï¼›</p>
<p>å¦‚æœæ˜¯ä¸šåŠ¡ä¸Šå°±æœ‰é‚£ä¹ˆå¤æ‚çš„æŸ¥è¯¢ï¼Œå¯èƒ½å°±ä¸å»ºè®®ç»§ç»­èµ°SQLäº†ï¼Œè€Œæ˜¯é‡‡ç”¨å…¶ä»–çš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œæ¯”å¦‚ä½¿ç”¨ESç­‰è¿›è¡Œè§£å†³ã€‚</p>
<p><strong>æ¡ˆä¾‹9ã€ascå’Œdescæ··ç”¨</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> _t <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> b <span class="keyword">desc</span>, c <span class="keyword">asc</span></span><br></pre></td></tr></table></figure>



<p>desc å’Œascæ··ç”¨æ—¶ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ</p>
<p><strong>æ¡ˆä¾‹10ã€å¤§æ•°æ®</strong></p>
<p>å¯¹äºæ¨é€ä¸šåŠ¡çš„æ•°æ®å­˜å‚¨ï¼Œå¯èƒ½æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œå¦‚æœåœ¨æ–¹æ¡ˆçš„é€‰æ‹©ä¸Šï¼Œæœ€ç»ˆé€‰æ‹©å­˜å‚¨åœ¨MySQLä¸Šï¼Œå¹¶ä¸”åš7å¤©ç­‰æœ‰æ•ˆæœŸçš„ä¿å­˜ã€‚</p>
<p>é‚£ä¹ˆéœ€è¦æ³¨æ„ï¼Œé¢‘ç¹çš„æ¸…ç†æ•°æ®ï¼Œä¼šç…§æˆæ•°æ®ç¢ç‰‡ï¼Œéœ€è¦è”ç³»DBAè¿›è¡Œæ•°æ®ç¢ç‰‡å¤„ç†</p>
<p>æ¥æºï¼šcnblogs.com&#x2F;powercto&#x2F;p&#x2F;14410128.html</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>shiroä½¿ç”¨</title>
    <url>/2021/07/12/shiro%E4%BD%BF%E7%94%A8-shiro%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="shiro"><a href="#shiro" class="headerlink" title="shiro"></a>shiro</h1><h2 id="ä¸€ã€shiroæ˜¯ä»€ä¹ˆ"><a href="#ä¸€ã€shiroæ˜¯ä»€ä¹ˆ" class="headerlink" title="ä¸€ã€shiroæ˜¯ä»€ä¹ˆ?"></a>ä¸€ã€shiroæ˜¯ä»€ä¹ˆ?</h2><p>â€‹	 Shiroæ˜¯Apacheä¸‹çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚shiroå±äºè½»é‡çº§æ¡†æ¶ï¼Œç›¸å¯¹äºSpringSecurityç®€å•çš„å¤šï¼Œä¹Ÿæ²¡æœ‰SpringSecurityé‚£ä¹ˆå¤æ‚ ã€‚</p>
<h2 id="äºŒã€ä¸»è¦åŠŸèƒ½"><a href="#äºŒã€ä¸»è¦åŠŸèƒ½" class="headerlink" title="äºŒã€ä¸»è¦åŠŸèƒ½"></a>äºŒã€ä¸»è¦åŠŸèƒ½</h2><h3 id="shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š"><a href="#shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š" class="headerlink" title="shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š"></a>shiroä¸»è¦æœ‰ä¸‰å¤§åŠŸèƒ½æ¨¡å—ï¼š</h3><h6 id="1-Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚"><a href="#1-Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚" class="headerlink" title="1. Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚"></a>1. Subjectï¼šä¸»ä½“ï¼Œä¸€èˆ¬æŒ‡ç”¨æˆ·ã€‚</h6><h6 id="2-SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚-ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet"><a href="#2-SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚-ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet" class="headerlink" title="2. SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚(ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet)"></a>2. SecurityManagerï¼šå®‰å…¨ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰Subjectï¼Œå¯ä»¥é…åˆå†…éƒ¨å®‰å…¨ç»„ä»¶ã€‚(ç±»ä¼¼äºSpringMVCä¸­çš„DispatcherServlet)</h6><h6 id="3-Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚"><a href="#3-Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚" class="headerlink" title="3. Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚"></a>3. Realmsï¼šç”¨äºè¿›è¡Œæƒé™ä¿¡æ¯çš„éªŒè¯ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±å®ç°ã€‚</h6><h3 id="ç»†åˆ†åŠŸèƒ½"><a href="#ç»†åˆ†åŠŸèƒ½" class="headerlink" title="ç»†åˆ†åŠŸèƒ½"></a>ç»†åˆ†åŠŸèƒ½</h3><h6 id="1-Authenticationï¼šèº«ä»½è®¤è¯-x2F-ç™»å½•-è´¦å·å¯†ç éªŒè¯-ã€‚"><a href="#1-Authenticationï¼šèº«ä»½è®¤è¯-x2F-ç™»å½•-è´¦å·å¯†ç éªŒè¯-ã€‚" class="headerlink" title="1. Authenticationï¼šèº«ä»½è®¤è¯&#x2F;ç™»å½•(è´¦å·å¯†ç éªŒè¯)ã€‚"></a>1. Authenticationï¼šèº«ä»½è®¤è¯&#x2F;ç™»å½•(è´¦å·å¯†ç éªŒè¯)ã€‚</h6><h6 id="2-Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚"><a href="#2-Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚" class="headerlink" title="2. Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚"></a>2. Authorizationï¼šæˆæƒï¼Œå³è§’è‰²æˆ–è€…æƒé™éªŒè¯ã€‚</h6><h6 id="3-Session-Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚"><a href="#3-Session-Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚" class="headerlink" title="3. Session Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚"></a>3. Session Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»å½•åçš„sessionç›¸å…³ç®¡ç†ã€‚</h6><h6 id="4-Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚"><a href="#4-Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚" class="headerlink" title="4. Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚"></a>4. Cryptographyï¼šåŠ å¯†ï¼Œå¯†ç åŠ å¯†ç­‰ã€‚</h6><h6 id="5-Web-Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚"><a href="#5-Web-Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚" class="headerlink" title="5. Web Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚"></a>5. Web Supportï¼šWebæ”¯æŒï¼Œé›†æˆWebç¯å¢ƒã€‚</h6><h6 id="6-Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚"><a href="#6-Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚" class="headerlink" title="6. Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚"></a>6. Cachingï¼šç¼“å­˜ï¼Œç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ã€æƒé™ç­‰ç¼“å­˜åˆ°å¦‚redisç­‰ç¼“å­˜ä¸­ã€‚</h6><h6 id="7-Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚"><a href="#7-Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚" class="headerlink" title="7. Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚"></a>7. Concurrencyï¼šå¤šçº¿ç¨‹å¹¶å‘éªŒè¯ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ã€‚</h6><h6 id="8-Testingï¼šæµ‹è¯•æ”¯æŒï¼›"><a href="#8-Testingï¼šæµ‹è¯•æ”¯æŒï¼›" class="headerlink" title="8. Testingï¼šæµ‹è¯•æ”¯æŒï¼›"></a>8. Testingï¼šæµ‹è¯•æ”¯æŒï¼›</h6><h6 id="9-Run-Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚"><a href="#9-Run-Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚" class="headerlink" title="9. Run Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚"></a>9. Run Asï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ã€‚</h6><h6 id="10-Remember-Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†"><a href="#10-Remember-Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†" class="headerlink" title="10. Remember Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†"></a>10. Remember Meï¼šè®°ä½æˆ‘ï¼Œç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†</h6><h3 id="ä¸‰ã€å…·ä½“å®ç°"><a href="#ä¸‰ã€å…·ä½“å®ç°" class="headerlink" title="ä¸‰ã€å…·ä½“å®ç°"></a>ä¸‰ã€å…·ä½“å®ç°</h3><h3 id="1ã€é¡¹ç›®ç›®å½•"><a href="#1ã€é¡¹ç›®ç›®å½•" class="headerlink" title="1ã€é¡¹ç›®ç›®å½•"></a>1ã€é¡¹ç›®ç›®å½•</h3><p><img src="/2021/07/12/shiro%E4%BD%BF%E7%94%A8-shiro%E4%BD%BF%E7%94%A8/1604471130107-03fd3901e8644ec985962a56e1d4f28d.png" alt="1604471130107.png"></p>
<h3 id="pom-xmlä¾èµ–æ–‡ä»¶"><a href="#pom-xmlä¾èµ–æ–‡ä»¶" class="headerlink" title="pom.xmlä¾èµ–æ–‡ä»¶"></a>pom.xmlä¾èµ–æ–‡ä»¶</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.shiro.version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">spring.shiro.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- shiro --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é¡µé¢æ¨¡æ¿ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--çƒ­éƒ¨ç½²ä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Permissionsæƒé™å®ä½“ç±»"><a href="#Permissionsæƒé™å®ä½“ç±»" class="headerlink" title="Permissionsæƒé™å®ä½“ç±»"></a>Permissionsæƒé™å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Permissions</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String permissionsName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Roleè§’è‰²å®ä½“"><a href="#Roleè§’è‰²å®ä½“" class="headerlink" title="Roleè§’è‰²å®ä½“"></a>Roleè§’è‰²å®ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§’è‰²å¯¹åº”æƒé™é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Permissions&gt; permissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Userå®ä½“"><a href="#Userå®ä½“" class="headerlink" title="Userå®ä½“"></a>Userå®ä½“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Role&gt; roles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“"><a href="#ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“" class="headerlink" title="ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“"></a>ä¸šåŠ¡å±‚ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.Permissions;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.Role;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.example.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByName</span><span class="params">(String getMapByName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getMapByName(getMapByName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> User</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">getMapByName</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="type">Permissions</span> <span class="variable">permissions1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Permissions</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;query&quot;</span>);</span><br><span class="line">        <span class="type">Permissions</span> <span class="variable">permissions2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Permissions</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">        Set&lt;Permissions&gt; permissionsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        permissionsSet.add(permissions1);</span><br><span class="line">        permissionsSet.add(permissions2);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">role</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Role</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;admin&quot;</span>, permissionsSet);</span><br><span class="line">        Set&lt;Role&gt; roleSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        roleSet.add(role);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;wsl&quot;</span>, <span class="string">&quot;123456&quot;</span>, roleSet);</span><br><span class="line">        Map&lt;String, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        map.put(user.getUserName(), user);</span><br><span class="line"></span><br><span class="line">        Set&lt;Permissions&gt; permissionsSet1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        permissionsSet1.add(permissions1);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">role1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Role</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;user&quot;</span>, permissionsSet1);</span><br><span class="line">        Set&lt;Role&gt; roleSet1 = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        roleSet1.add(role1);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;123456&quot;</span>, roleSet1);</span><br><span class="line">        map.put(user1.getUserName(), user1);</span><br><span class="line">        <span class="keyword">return</span> map.get(userName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»"><a href="#CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»" class="headerlink" title="CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»"></a>CustomRealmç”¨æˆ·æƒé™é…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.example.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æƒé™æ§åˆ¶ä»¥åŠæƒé™è®¤è¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™é…ç½®ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principalCollection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰ç™»å½•ç”¨æˆ·å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> principalCollection.getPrimaryPrincipal().toString();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginService.getUserByName(userName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ·»åŠ è§’è‰²å’Œæƒé™</span></span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">simpleAuthorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        user.getRoles().forEach(role -&gt; &#123;</span><br><span class="line">            simpleAuthorizationInfo.addRole(role.getRoleName());</span><br><span class="line">            role.getPermissions().forEach(permission -&gt; simpleAuthorizationInfo.addStringPermission(permission.getPermissionsName()));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™è®¤è¯ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">username</span> <span class="operator">=</span> authenticationToken.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> username.toString();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginService.getUserByName(name);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œè¿”å›åä¼šæŠ¥å‡ºå¯¹åº”å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡ŒéªŒè¯authenticationTokenå’ŒsimpleAuthenticationInfoçš„ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(name, user.getPassword(), getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="shiroé…ç½®ç±»"><a href="#shiroé…ç½®ç±»" class="headerlink" title="shiroé…ç½®ç±»"></a>shiroé…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.example.shiro.CustomRealm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shiroå…·ä½“é…ç½®ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">defaultAAP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">        defaultAAP.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAAP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†è‡ªå·±çš„éªŒè¯æ–¹å¼åŠ å…¥å®¹å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomRealm <span class="title function_">myShiroRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomRealm</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™ç®¡ç†ï¼Œé…ç½®ä¸»è¦æ˜¯Realmçš„ç®¡ç†è®¤è¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Filterå·¥å‚ï¼Œè®¾ç½®å¯¹åº”çš„è¿‡æ»¤æ¡ä»¶å’Œè·³è½¬æ¡ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//ç™»å‡º</span></span><br><span class="line">        map.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">        <span class="comment">//å¯¹æ‰€æœ‰ç”¨æˆ·è®¤è¯</span></span><br><span class="line">        map.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        <span class="comment">//ç™»å½•</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="comment">//é¦–é¡µ</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="comment">//é”™è¯¯é¡µé¢ï¼Œè®¤è¯ä¸é€šè¿‡è·³è½¬</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/error&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(map);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">authorizationAttributeSourceAdvisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»"><a href="#ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»" class="headerlink" title="ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»"></a>ExceptionHandlerç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ErrorHandler</span><span class="params">(AuthorizationException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ²¡æœ‰é€šè¿‡æƒé™éªŒè¯ï¼&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ²¡æœ‰é€šè¿‡æƒé™éªŒè¯ï¼&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresPermissions;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresRoles;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.example.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(user.getUserName()) || StringUtils.isEmpty(user.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç”¨æˆ·è®¤è¯ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">usernamePasswordToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(</span><br><span class="line">                user.getUserName(),</span><br><span class="line">                user.getPassword()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è¿›è¡ŒéªŒè¯ï¼Œè¿™é‡Œå¯ä»¥æ•è·å¼‚å¸¸ï¼Œç„¶åè¿”å›å¯¹åº”ä¿¡æ¯</span></span><br><span class="line">            subject.login(usernamePasswordToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç”¨æˆ·åä¸å­˜åœ¨ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ç”¨æˆ·åä¸å­˜åœ¨ï¼&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯ï¼&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthorizationException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æ²¡æœ‰æƒé™ï¼&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;æ²¡æœ‰æƒé™&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresRoles(&quot;admin&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;query&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;add&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;add success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æƒé™</category>
      </categories>
      <tags>
        <tag>æƒé™</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†</title>
    <url>/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/</url>
    <content><![CDATA[<h1 id="springboot-ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†"><a href="#springboot-ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†" class="headerlink" title="springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†"></a>springboot ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å¤„ç†</h1><p>å‰è¨€ï¼šéšç€å‰åç«¯åˆ†ç¦»è¿™ç§æ¨¡å¼çš„è¶‹åŠ¿ä¸‹ï¼Œåç«¯å¼€å‘äººå‘˜æ›´æ³¨é‡åç«¯æ–¹é¢çš„ä»£ç ï¼Œä½†æ˜¯å¯¹åç«¯äººå‘˜åœ¨ä»£ç ç¼–å†™çš„è¿‡ç¨‹å½“ä¸­éœ€è¦è¶Šæ¥è¶Šè§„èŒƒï¼Œè¿™æ ·ä¸ä»…å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œæ›´å¯ä»¥è®©ä»£ç åæœŸç»´æŠ¤èµ·æ¥æ›´åŠ çš„æ–¹ä¾¿ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å½“æ¥å£è¿”å›çš„ç»Ÿä¸€å¤„ç†ï¼Œèƒ½å¤Ÿè®©å‰ç«¯äººå‘˜æœ‰ä¸ªç»Ÿä¸€çš„æ¥æ”¶åå°çš„æ¥å£è¿”å›ã€‚</p>
<h2 id="1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç "><a href="#1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç " class="headerlink" title="1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç "></a>1ã€è‡ªå®šä¹‰å¸¸ç”¨çš„çŠ¶æ€ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰çŠ¶æ€ç æšä¸¾</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultCode</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC200(<span class="number">200</span>, <span class="string">&quot;æ“ä½œæˆåŠŸ&quot;</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ“ä½œå¤±è´¥</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC900(<span class="number">900</span>, <span class="string">&quot;æ“ä½œå¤±è´¥&quot;</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    RC500(<span class="number">500</span>, <span class="string">&quot;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰æè¿°</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultCode(<span class="type">int</span> code, String message) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å¯ä»¥å®šä¹‰å®šä¹‰ä¸€äº›å…¶ä»–çŠ¶æ€ç ï¼Œå¯ä»¥è®©å‰ç«¯æ ¹æ®ä¸åŒçš„çŠ¶æ€ç è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œè¿™é‡Œåªå®šä¹‰éƒ¨åˆ†å¸¸ç”¨çŠ¶æ€ç ã€‚</p>
<h2 id="2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»"><a href="#2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»" class="headerlink" title="2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»"></a>2ã€ç»Ÿä¸€ç»“æœè¿”å›åŒ…è£…ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ç»“æœåŒ…è£…ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResultData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›çš„ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰ç»“æœè¿”å›å€¼æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC200.getCode());</span><br><span class="line">        resultData.setMessage(ResultCode.RC200.getMessage());</span><br><span class="line">        resultData.setData(data);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— ç»“æœè¿”å›å€¼æ“ä½œæˆåŠŸ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC200.getCode());</span><br><span class="line">        resultData.setMessage(ResultCode.RC200.getMessage());</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰çŠ¶æ€ç çš„å¤±è´¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    çŠ¶æ€ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message å¤±è´¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">fail</span><span class="params">(<span class="type">int</span> code, String message)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(code);</span><br><span class="line">        resultData.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ— çŠ¶æ€ç çš„å¤±è´¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message å¤±è´¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;     æ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åŒ…è£…å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResultData&lt;T&gt; <span class="title function_">fail</span><span class="params">( String message)</span> &#123;</span><br><span class="line">        ResultData&lt;T&gt; resultData = <span class="keyword">new</span> <span class="title class_">ResultData</span>&lt;&gt;();</span><br><span class="line">        resultData.setStatus(ResultCode.RC999.getCode());</span><br><span class="line">        resultData.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªå°è£…çš„éƒ¨åˆ†æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å°è£…ä¸åŒæ–¹æ³•ã€‚</p>
<p><strong>å†™ä¸€ä¸ªç®€å•çš„è¯·æ±‚demo</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getHi&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">getHi</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ResultData.success(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›ç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/1.png"></p>
<p><strong>æ¨¡æ‹Ÿä¸€ä¸ªæœåŠ¡å™¨çš„å¼‚å¸¸</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getHi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">getHi</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/2.png" alt="2"></p>
<p>è¿™ç§è¿”å›ç»“æœè‚¯å®šä¸æ˜¯å‰ç«¯å¼€å‘äººå‘˜æƒ³å¤„ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å¯¹æœåŠ¡ç«¯å¦‚æœå‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¹Ÿéœ€è¦å¤„ç†ç»Ÿä¸€çš„è¿”å›æ ¼å¼ã€‚</p>
<h2 id="3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†"><a href="#3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†" class="headerlink" title="3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†"></a>3ã€è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼Œä»¥åŠå…¨å±€å¼‚å¸¸å¤„ç†</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ä¹‰åŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BizException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResultCode resultCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BizException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BizException</span><span class="params">(ResultCode resultCode)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(resultCode.getMessage());</span><br><span class="line">        <span class="built_in">this</span>.resultCode = resultCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultData;</span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.exception.BizException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¨å±€ç»Ÿä¸€å¼‚å¸¸å¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResultData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(BizException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.EXPECTATION_FAILED)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">exception</span><span class="params">(BizException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å…¨å±€å¼‚å¸¸ä¿¡æ¯ e=&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResultData.fail(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é»˜è®¤å…¨å±€å¼‚å¸¸å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e the e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResultData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> ResultData&lt;String&gt; <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;å…¨å±€å¼‚å¸¸ä¿¡æ¯ e=&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResultData.fail(ResultCode.RC500.getCode(),e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿è¡Œç»“æœ</strong></p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/3.png" alt="3"></p>
<p>èƒ½å¤Ÿæ­£ç¡®çš„è¿”å›ã€‚</p>
<p>å½“æ—¶å›å¤´ä¸€æƒ³ï¼Œç»Ÿä¸€å¤„ç†ä½†æ˜¯æ¯æ¬¡è¿”å›ç»“æœçš„æ—¶å€™è‡ªå·±éƒ½å¾—é‡å¤æ‰‹åŠ¨åŒ…è£…ä¸€ä¸‹è‡ªå®šä¹‰çš„ç±»ï¼Œè¿™æ ·å¯ä»¥ç”¨ä»£ç æ¥å¤„ç†ï¼Œæ‰€ä»¥ä¸‹é¢å®ç°è‡ªåŠ¨åŒ…è£…è¿”å›çš„ç»“æœã€‚</p>
<h2 id="4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»"><a href="#4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»" class="headerlink" title="4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»"></a>4ã€è‡ªå®šä¹‰è‡ªåŠ¨åŒ…è£…ç»Ÿä¸€è¿”å›ç±»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spring.response.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spring.response.constant.ResultData;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿä¸€åŒ…è£…è¿”å›ç»“æœ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseAdvice</span> <span class="keyword">implements</span> <span class="title class_">ResponseBodyAdvice</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(MethodParameter methodParameter, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="comment">//è¿”å›trueåˆ™å¯¹è¿”å›å€¼éœ€è¦å¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥å£è¿”å›å‰åŒ…è£…ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">beforeBodyWrite</span><span class="params">(Object o, MethodParameter methodParameter, MediaType mediaType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse)</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯Stringç±»å‹ï¼Œè½¬ä¸ºjson</span></span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.writeValueAsString(ResultData.success(o));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå¼‚å¸¸ã€æ–‡ä»¶å½¢å¼ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ResultData || o <span class="keyword">instanceof</span> Resource ) &#123;</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResultData.success(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†™ä¸ªdemoæµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;getWorld&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Order <span class="title function_">getWorld</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>,<span class="string">&quot;è´­ç‰©è½¦&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/getError&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Order <span class="title function_">getError</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizException</span>(<span class="string">&quot;å¤±è´¥äº†&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›ç»“æœï¼š</p>
<p><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/5.png" alt="5"><img src="/2021/08/17/springboot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86-springbootyou-ya-de-shi-xian-tong-yi-fan-hui-chu-li/6.png" alt="6"></p>
<p>è¿™æ ·å°±å¯ä»¥ä¼˜é›…çš„å®ç°ç»Ÿä¸€è¿”å›å€¼çš„å¤„ç†ã€‚</p>
<h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„:"></a>æ³¨æ„:</h3><p>ç‰¹åˆ«æ³¨æ„è¿™ä¸ªç±»çš„åˆ¤æ–­ï¼ï¼ï¼</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>hashmapåº•å±‚æ•°æ®ç»“æ„</title>
    <url>/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<h2 id="ä¸€ã€HashMapç®€ä»‹"><a href="#ä¸€ã€HashMapç®€ä»‹" class="headerlink" title="ä¸€ã€HashMapç®€ä»‹"></a>ä¸€ã€HashMapç®€ä»‹</h2><p>1ã€å®ƒæ˜¯ä¸€ä¸ªé€šè¿‡Mapæ¥å£å®ç°çš„ä¸€ä¸ªåŒåˆ—é›†åˆï¼Œä¸»è¦æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹éƒ½æœ‰ä¸€ä¸ªé”®å’Œä¸€ä¸ªå€¼ã€‚</p>
<p>2ã€æ¯ä¸€ä¸ªé”®éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå€¼å¯ä»¥é‡å¤ï¼Œåé¢æ·»åŠ çš„é”®ä¼šè¦†ç›–å‰é¢ç›¸åŒçš„é”®ã€‚</p>
<p>3ã€HashMapå­˜å‚¨ç»“æ„é‡‡ç”¨çš„æ˜¯å“ˆå¸Œè¡¨çš„ç»“æ„ï¼Œå…ƒç´ çš„å­˜å‚¨é¡ºåºä¸èƒ½ä¿å­˜ä¸€è‡´ï¼Œå¦‚æœé”®æ˜¯è‡ªå®šä¹‰çš„å¯¹è±¡çš„è¯ï¼Œéœ€è¦é‡å†™hashcodeæ–¹æ³•ä¸equalsæ–¹æ³•ï¼Œæ‰èƒ½ä¿è¯é”®çš„å”¯ä¸€ã€‚</p>
<h2 id="äºŒã€HashMapå­˜å‚¨çš„åŸç†"><a href="#äºŒã€HashMapå­˜å‚¨çš„åŸç†" class="headerlink" title="äºŒã€HashMapå­˜å‚¨çš„åŸç†"></a>äºŒã€HashMapå­˜å‚¨çš„åŸç†</h2><h3 id="1ã€ç‰ˆæœ¬åŒºåˆ«"><a href="#1ã€ç‰ˆæœ¬åŒºåˆ«" class="headerlink" title="1ã€ç‰ˆæœ¬åŒºåˆ«"></a>1ã€ç‰ˆæœ¬åŒºåˆ«</h3><p><strong>jdk8ä»¥å‰ï¼š</strong></p>
<p>åœ¨jdk1.7ä¸­ï¼Œé¦–å…ˆæ˜¯æŠŠå…ƒç´ æ”¾åœ¨ä¸€ä¸ªä¸ªæ•°ç»„é‡Œé¢ï¼Œåæ¥å­˜æ”¾çš„æ•°æ®å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œäºæ˜¯å°±å‡ºç°äº†é“¾è¡¨ï¼Œå¯¹äºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½å¯ä»¥æœ‰ä¸€æ¡é“¾è¡¨æ¥å­˜å‚¨å…ƒç´ ã€‚è¿™å°±æ˜¯æœ‰åçš„â€œæ‹‰é“¾å¼â€å­˜å‚¨æ–¹æ³•ã€‚<br><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-840e869c0ea34c8cad5655d3d316d8e4.png" alt="image.png"></p>
<p><strong>jdk8ä»¥åï¼š</strong></p>
<p>ç”±äºå­˜å‚¨çš„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œé“¾è¡¨ä¹Ÿè¶Šæ¥è¶Šé•¿ï¼Œåœ¨æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ æ—¶å€™æ•ˆç‡ä¸ä»…æ²¡æœ‰æé«˜ï¼ˆé“¾è¡¨ä¸é€‚åˆæŸ¥æ‰¾ï¼Œé€‚åˆå¢åˆ ï¼‰ï¼Œåå€’æ˜¯ä¸‹é™äº†ä¸å°‘ï¼Œäºæ˜¯å°±å¯¹è¿™æ¡é“¾è¡¨è¿›è¡Œäº†ä¸€ä¸ªæ”¹è¿›ã€‚å¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿå°±æ˜¯æŠŠè¿™æ¡é“¾è¡¨å˜æˆä¸€ä¸ªé€‚åˆæŸ¥æ‰¾çš„æ ‘å½¢ç»“æ„ï¼Œæ²¡é”™å°±æ˜¯çº¢é»‘æ ‘ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºéœ€è¦ä¸ºäº†é€€åŒ–æˆé“¾è¡¨å’Œéå†åšå‡†å¤‡ï¼Œè¿™ä¸ªçº¢é»‘æ ‘å¹¶ä¸æ˜¯çº¯çº¢é»‘æ ‘ï¼Œè€Œæ˜¯çº¢é»‘æ ‘å’ŒåŒå‘é“¾è¡¨çš„å åŠ ç»“æ„ã€‚</p>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-ab9163a96dc44373910d0ef343bc8db6.png" alt="image.png"></p>
<h3 id="2ã€å­˜å‚¨çš„æµç¨‹"><a href="#2ã€å­˜å‚¨çš„æµç¨‹" class="headerlink" title="2ã€å­˜å‚¨çš„æµç¨‹"></a>2ã€å­˜å‚¨çš„æµç¨‹</h3><p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-e3c1b70070d14acf9a3d26733f1a2de3.png" alt="image.png"></p>
<h3 id><a href="#" class="headerlink" title></a></h3><h2 id="ä¸‰ã€HashMapæ•°æ®ç»“æ„"><a href="#ä¸‰ã€HashMapæ•°æ®ç»“æ„" class="headerlink" title="ä¸‰ã€HashMapæ•°æ®ç»“æ„"></a>ä¸‰ã€HashMapæ•°æ®ç»“æ„</h2><h3 id="1ã€hashè¡¨æ•°æ®ç»“æ„"><a href="#1ã€hashè¡¨æ•°æ®ç»“æ„" class="headerlink" title="1ã€hashè¡¨æ•°æ®ç»“æ„"></a>1ã€hashè¡¨æ•°æ®ç»“æ„</h3><h4 id="1ï¼‰ç®€ä»‹"><a href="#1ï¼‰ç®€ä»‹" class="headerlink" title="1ï¼‰ç®€ä»‹"></a>1ï¼‰ç®€ä»‹</h4><p>å“ˆå¸Œè¡¨æ˜¯ä¸€ä¸ªé€šè¿‡æ•°ç»„å’Œé“¾è¡¨ç›¸ç»“åˆè€Œæˆçš„æ•°æ®ç»“æ„ï¼Œæ—¢é¿å…äº†æ•°ç»„çš„å¢åˆ æ…¢ï¼Œä¹Ÿé¿å…äº†é“¾è¡¨æŸ¥è¯¢æŸ¥è¯¢æ…¢çš„çš„ç¼ºé™·ã€‚</p>
<p><strong>æ•°ç»„</strong> ï¼š</p>
<p>æ•°ç»„çš„å­˜å‚¨åŒºæ˜¯è¿ç»­çš„ï¼Œå ç”¨å†…å­˜ä¸¥é‡ï¼Œæ•…ç©ºé—´å¤æ‚åº¦å¾ˆå¤§ã€‚ä½†æ•°ç»„çš„äºŒåˆ†æŸ¥æ‰¾æ—¶é—´åº¦å°ï¼›æ•°ç»„çš„ç‰¹ç‚¹ï¼šå¯»å€å®¹æ˜“ï¼Œæ’å…¥å’Œåˆ é™¤å›°éš¾ã€‚</p>
<p><strong>é“¾è¡¨</strong> ï¼š</p>
<p>é“¾è¡¨çš„å‚¨å­˜åŒºç¦»æ•£ï¼Œå ç”¨å†…å­˜æ¯”è¾ƒå®½æ¾ï¼Œæ•…ç©ºé—´å¤æ‚åº¦å¾ˆå°ï¼Œä½†æ—¶é—´å¤æ‚åº¦å¤§ï¼›</p>
<p>é“¾è¡¨çš„ç‰¹ç‚¹ï¼šå¯»å€å›°éš¾ï¼Œæ’å…¥å’Œåˆ é™¤å®¹æ˜“ã€‚</p>
<h4 id="2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†"><a href="#2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†" class="headerlink" title="2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†"></a>2ï¼‰ä¿è¯æ•°æ®å”¯ä¸€çš„åŸç†</h4><ol>
<li><p>å½“HashMapé›†åˆå­˜å‚¨å…ƒç´ çš„æ—¶å€™,å°±ä¼šè°ƒç”¨è¯¥å…ƒç´ çš„hashCode0æ–¹æ³•è®¡ç®—å“ˆå¸Œå€¼</p>
</li>
<li><p>åˆ¤æ–­è¯¥å“ˆå¸Œå€¼å¯¹åº”çš„ä½ç½®ä¸Šæ˜¯å¦æœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ </p>
</li>
<li><p>å¦‚æœè¯¥ä½ç½®ä¸Šæ²¡æœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ ,å°±ç›´æ¥å­˜å‚¨</p>
</li>
<li><p>å¦‚æœè¯¥ä½ç½®ä¸Šæœ‰ç›¸åŒå“ˆå¸Œå€¼çš„å…ƒç´ ,å°±è¯´æ˜äº§ç”Ÿäº†å“ˆå¸Œå†²çª</p>
</li>
<li><p>äº§ç”Ÿäº†å“ˆå¸Œå†²å®,å°±å¾—è°ƒç”¨è¯¥å…ƒç´ çš„equalsæ–¹æ³•,ä¸è¯¥å“ˆå¸Œå€¼ä½ç½®ä¸Šçš„æ‰€æœ‰å…ƒç´ è¿›è¡Œ-æ¯”è¾ƒ</p>
</li>
<li><p>å¦‚æœæ¯”è¾ƒå®Œå,æ²¡æœ‰ä¸€ä¸ªå…ƒç´ ä¸è¯¥å…ƒç´ ç›¸åŒ,å°±ç›´æ¥å­˜å‚¨</p>
</li>
<li><p>å¦‚æœæ¯”è¾ƒå®Œå,åªè¦æœ‰ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸è¯¥å…ƒç´ ç›¸åŒ,å°±ä¸å­˜å‚¨</p>
</li>
</ol>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-5e50cc4ebbdf4cd59e62ef6f41491a37.png" alt="image.png"></p>
<h3 id="3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„"><a href="#3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„" class="headerlink" title="3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„"></a>3ã€çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„</h3><h4 id="1ï¼‰ç®€ä»‹-1"><a href="#1ï¼‰ç®€ä»‹-1" class="headerlink" title="1ï¼‰ç®€ä»‹"></a>1ï¼‰ç®€ä»‹</h4><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ç”¨åˆ°çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯åœ¨1972å¹´ç”±Rudolf Bayerå‘æ˜çš„ï¼Œå½“æ—¶è¢«ç§°ä¹‹ä¸ºå¹³è¡¡äºŒå‰Bæ ‘ï¼Œåæ¥ï¼Œåœ¨1978å¹´è¢«Leoj.Guibaså’ŒRobert Sedgewickä¿®æ”¹ä¸ºå¦‚ä»Šçš„â€çº¢é»‘æ ‘â€ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œçº¢é»‘æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰å­˜å‚¨ä½è¡¨ç¤ºèŠ‚ç‚¹çš„é¢œè‰²ï¼Œå¯ä»¥æ˜¯çº¢æˆ–è€…é»‘ï¼›</p>
<p>çº¢é»‘æ ‘ä¸æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œå®ƒçš„å¹³è¡¡æ˜¯é€šè¿‡â€çº¢é»‘æ ‘çš„ç‰¹æ€§â€è¿›è¡Œå®ç°çš„ï¼›</p>
<h4 id="2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§"><a href="#2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§" class="headerlink" title="2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§"></a>2ï¼‰çº¢é»‘æ ‘ç‰¹æ€§</h4><ol>
<li><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ–æ˜¯çº¢è‰²çš„ï¼Œæˆ–è€…æ˜¯é»‘è‰²çš„ã€‚</p>
</li>
<li><p>æ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²</p>
</li>
<li><p>æ¯ä¸ªå¶èŠ‚ç‚¹(Nil)æ˜¯é»‘è‰²çš„ï¼›ï¼ˆå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹æˆ–è€…çˆ¶èŠ‚ç‚¹ï¼Œåˆ™è¯¥èŠ‚ç‚¹ç›¸åº”çš„æŒ‡é’ˆå±æ€§å€¼ä¸ºNilï¼Œè¿™äº›Nilè§†ä¸ºå¶èŠ‚ç‚¹ï¼‰</p>
</li>
<li><p>å¦‚æœæŸä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²(ä¸èƒ½å‡ºç°ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿çš„æƒ…å†µ)</p>
</li>
<li><p>å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»è¯¥èŠ‚ç‚¹åˆ°å…¶æ‰€æœ‰åä»£å¶èŠ‚ç‚¹çš„ç®€å•è·¯å¾„ä¸Šï¼Œå‡åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ï¼›</p>
</li>
<li><p>åœ¨è¿›è¡Œå…ƒç´ æ’å…¥çš„æ—¶å€™ï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼› æ¯ä¸€æ¬¡æ’å…¥å®Œæ¯•ä»¥åï¼Œä½¿ç”¨é»‘è‰²è§„åˆ™è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸æ»¡è¶³çº¢é»‘è§„åˆ™ï¼Œå°±éœ€è¦é€šè¿‡å˜è‰²ï¼Œå·¦æ—‹å’Œå³æ—‹æ¥è°ƒæ•´æ ‘ï¼Œä½¿å…¶æ»¡è¶³çº¢é»‘è§„åˆ™ï¼›</p>
</li>
</ol>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-4bf5d88b307548c7bb2a52a715858cad.png" alt="image.png"></p>
<h4 id="3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«"><a href="#3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«" class="headerlink" title="3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«"></a>3ï¼‰ä¸AVLæ ‘çš„åŒºåˆ«</h4><p> 1ã€çº¢é»‘æ ‘æ”¾å¼ƒäº†è¿½æ±‚å®Œå…¨å¹³è¡¡ï¼Œè¿½æ±‚å¤§è‡´å¹³è¡¡ï¼Œåœ¨ä¸å¹³è¡¡äºŒå‰æ ‘çš„æ—¶é—´å¤æ‚åº¦ç›¸å·®ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ¯æ¬¡æ’å…¥æœ€å¤šåªéœ€è¦ä¸‰æ¬¡æ—‹è½¬å°±èƒ½è¾¾åˆ°å¹³è¡¡ï¼Œå®ç°èµ·æ¥ä¹Ÿæ›´ä¸ºç®€å•ã€‚</p>
<p> 2ã€å¹³è¡¡äºŒå‰æ ‘è¿½æ±‚ç»å¯¹å¹³è¡¡ï¼Œæ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯æ¬¡æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åéœ€è¦æ—‹è½¬çš„æ¬¡æ•°ä¸èƒ½é¢„çŸ¥ã€‚</p>
<h2 id="å››ã€ç®—æ³•"><a href="#å››ã€ç®—æ³•" class="headerlink" title="å››ã€ç®—æ³•"></a>å››ã€ç®—æ³•</h2><h4 id="1ã€è´Ÿè½½å› å­ï¼ˆload-factorï¼‰"><a href="#1ã€è´Ÿè½½å› å­ï¼ˆload-factorï¼‰" class="headerlink" title="1ã€è´Ÿè½½å› å­ï¼ˆload factorï¼‰"></a>1ã€è´Ÿè½½å› å­ï¼ˆload factorï¼‰</h4><p>   å¦‚æœä¸€ä¸ªhashè¡¨ä¸­æ¡¶çš„ä¸ªæ•°ä¸º size , å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°ä¸ºused .åˆ™æˆ‘ä»¬ç§° used &#x2F; size ä¸ºè´Ÿè½½å› å­loadFactor . ä¸€èˆ¬çš„æƒ…å†µä¸‹ï¼Œå½“loadFactor&lt;&#x3D;1æ—¶ï¼Œhashè¡¨æŸ¥æ‰¾çš„æœŸæœ›å¤æ‚åº¦ä¸ºO(1). å› æ­¤ã€‚æ¯æ¬¡å¾€hashè¡¨ä¸­åŠ å…¥å…ƒç´ æ—¶ã€‚æˆ‘ä»¬å¿…é¡»ä¿è¯æ˜¯åœ¨loadFactor &lt;1çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä»¥åŠ å…¥ã€‚</p>
<h4 id="2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹"><a href="#2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹" class="headerlink" title="2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹"></a>2ã€åˆå§‹å®¹é‡ä¸æ‰©å®¹</h4><p>HashMapçš„åˆå§‹å®¹é‡ä¸º16ï¼ŒHashtableåˆå§‹å®¹é‡ä¸º11ï¼Œä¸¤è€…çš„è´Ÿè½½å¡«å……å› å­é»˜è®¤éƒ½æ˜¯0.75ã€‚</p>
<p>å¦‚æœsizeå¤§å°åˆ°è¾¾é˜ˆå€¼ï¼Œåˆ™æ‰©å®¹ä¸€å€ï¼Œä¾æ—§ä¸º2çš„æ•´æ¬¡å¹‚</p>
<p>æœ€å¤§å®¹é‡ï¼šå› ä¸ºè®¡ç®—é‡‡ç”¨intå€¼ï¼Œintå€¼æœ€å¤§ä¸º2çš„31æ¬¡-1ï¼Œè¾¾ä¸åˆ°2çš„31æ¬¡ï¼Œæ‰€ä»¥ä¸º2çš„30æ¬¡ã€‚</p>
<h4 id="3ã€æ‰©å®¹çš„å®ç°"><a href="#3ã€æ‰©å®¹çš„å®ç°" class="headerlink" title="3ã€æ‰©å®¹çš„å®ç°"></a>3ã€æ‰©å®¹çš„å®ç°</h4><p>å½“æˆ‘ä»¬åŠ å…¥ä¸€ä¸ªæ–°å…ƒç´ æ—¶ã€‚ä¸€æ—¦loadFactorå¤§äºç­‰äº1äº†ï¼Œæˆ‘ä»¬ä¸èƒ½å•çº¯çš„å¾€hashè¡¨é‡Œè¾¹åŠ å…¥å…ƒç´ ã€‚</p>
<p>ç”±äºåŠ å…¥å®Œä¹‹åï¼ŒloadFactorå°†å¤§äº1ï¼Œè¿™æ ·ä¹Ÿå°±ä¸èƒ½ä¿è¯æŸ¥æ‰¾çš„æœŸæœ›æ—¶é—´å¤æ‚åº¦ä¸ºå¸¸æ•°çº§äº†ã€‚è¿™æ—¶ã€‚æˆ‘ä»¬åº”è¯¥å¯¹æ¡¶æ•°ç»„è¿›è¡Œä¸€æ¬¡å®¹é‡æ‰©å¼ ï¼Œè®©sizeå¢å¤§ ã€‚</p>
<p>è¿™æ ·å°±èƒ½ä¿è¯åŠ å…¥å…ƒç´ å used &#x2F; size ä»ç„¶å°äºç­‰äº1 ï¼Œ ä»è€Œä¿è¯æŸ¥æ‰¾çš„æœŸæœ›æ—¶é—´å¤æ‚åº¦ä¸ºO(1).å¯æ˜¯ã€‚æ€æ ·è¿›è¡Œå®¹é‡æ‰©å¼ å‘¢ï¼Ÿ C++ä¸­çš„vectorçš„å®¹é‡æ‰©å¼ æ˜¯ä¸€ç§å¥½æ–¹æ³•ã€‚</p>
<p>äºæ˜¯æœ‰äº†ä¾‹å¦‚ä»¥ä¸‹æ€è·¯ ï¼šã€€Hashè¡¨ä¸­æ¯æ¬¡å‘ç°loadFactor&#x3D;&#x3D;1æ—¶ï¼Œå°±å¼€è¾Ÿä¸€ä¸ªåŸæ¥æ¡¶æ•°ç»„çš„ä¸¤å€ç©ºé—´ï¼ˆç§°ä¸ºæ–°æ¡¶æ•°ç»„ï¼‰ï¼Œç„¶åæŠŠåŸæ¥çš„æ¡¶æ•°ç»„ä¸­å…ƒç´ æ‰€æœ‰è½¬ç§»è¿‡æ¥åˆ°æ–°çš„æ¡¶æ•°ç»„ä¸­ã€‚æ³¨æ„è¿™é‡Œè½¬ç§»æ˜¯é¡»è¦å…ƒç´ ä¸€ä¸ªä¸ªåˆä¸€æ¬¡å“ˆå¸Œåˆ°æ–°æ¡¶ä¸­çš„ã€‚åŸå› åé¢ä¼šè®²åˆ°ã€‚</p>
<p>   è¿™æ ·çš„æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œå®¹é‡æ‰©å¼ æ˜¯ä¸€æ¬¡å®Œæ¯•çš„ï¼ŒæœŸé—´è¦èŠ±éå¸¸é•¿æ—¶é—´ä¸€æ¬¡è½¬ç§»hashè¡¨ä¸­çš„å…¨éƒ¨å…ƒç´ ã€‚è¿™æ ·åœ¨hashè¡¨ä¸­loadFactor&#x3D;&#x3D;1æ—¶ã€‚å¾€é‡Œè¾¹æ’å…¥ä¸€ä¸ªå…ƒç´ å°†ä¼šç­‰å€™éå¸¸é•¿çš„æ—¶é—´ã€‚</p>
<h4 id="4ã€Redisä¸­çš„å®ç°"><a href="#4ã€Redisä¸­çš„å®ç°" class="headerlink" title="4ã€Redisä¸­çš„å®ç°"></a>4ã€Redisä¸­çš„å®ç°</h4><ol>
<li><p>Redis æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ key-value ç¼“å­˜ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåŸºäºé”®å€¼å¯¹çš„æ•°æ®åº“ã€‚</p>
</li>
<li><p>Redisä¹Ÿæ˜¯é‡‡å–<strong>é“¾åœ°å€æ³•</strong>è§£å†³å“ˆå¸Œå†²çªã€‚</p>
</li>
<li><p>æˆ‘ä»¬çŸ¥é“ï¼ŒJavaå‘ç”Ÿæ‰©å®¹çš„ç¬é—´ï¼Œæ˜¯éœ€è¦å…ˆå°†åŸå“ˆå¸Œè¡¨ä¸­æ‰€æœ‰é”®å€¼å¯¹éƒ½è½¬ç§»åˆ°æ–°çš„å“ˆå¸Œè¡¨ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œæ­¤æ—¶æ’å…¥è¯¥å…ƒç´ çš„æ€§èƒ½ç›¸å½“ä½ã€‚</p>
</li>
<li><p>è€ŒRediså¯¹äºè¿™ä¸€éƒ¨åˆ†ï¼Œé‡‡å–çš„æ˜¯<strong>åˆ†æ‘Šè½¬ç§»</strong>çš„æ–¹å¼ã€‚å³å½“æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ xè§¦å‘äº†æ‰©å®¹æ—¶ï¼Œå…ˆè½¬ç§»ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„æ¡¶åˆ°æ–°çš„å“ˆå¸Œè¡¨ï¼Œç„¶åå°†è¯¥å…ƒç´ æ’å…¥ã€‚è€Œä¸‹ä¸€æ¬¡å†æ¬¡æ’å…¥æ—¶ï¼Œç»§ç»­è½¬ç§»æ—§å“ˆå¸Œè¡¨ä¸­ç¬¬ä¸€ä¸ªä¸ä¸ºç©ºçš„æ¡¶ï¼Œå†æ’å…¥å…ƒç´ ã€‚ç›´è‡³æ—§å“ˆå¸Œè¡¨ä¸ºç©ºä¸ºæ­¢ã€‚è¿™æ ·ä¸€æ¥ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæ’å…¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ã€‚</p>
</li>
<li><p>åœ¨Redisçš„å®ç°ä¸­ï¼Œæ–°æ’å…¥çš„é”®å€¼å¯¹ä¼šæ”¾åœ¨ç®±å­ä¸­é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯åœ¨å°¾éƒ¨ç»§ç»­æ’å…¥ã€‚</p>
</li>
<li><p>è¿™ç§æ–¹æ¡ˆæ˜¯åŸºäºä¸¤ç‚¹è€ƒè™‘ï¼š</p>
</li>
<li><p>ä¸€æ˜¯ç”±äºæ‰¾åˆ°é“¾è¡¨å°¾éƒ¨çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œä¸”éœ€è¦é¢å¤–çš„å†…å­˜åœ°å€æ¥ä¿å­˜é“¾è¡¨çš„å°¾éƒ¨ä½ç½®ï¼Œè€Œå¤´æ’æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p>
</li>
<li><p>äºŒæ˜¯å¤„äºRedisçš„å®é™…åº”ç”¨åœºæ™¯æ¥è€ƒè™‘ã€‚å¯¹äºä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿæ¥è¯´ï¼Œæœ€æ–°æ’å…¥çš„æ•°æ®å¾€å¾€æ›´å¯èƒ½é¢‘ç¹åœ°è¢«è·å–ï¼Œæ‰€ä»¥è¿™æ ·ä¹Ÿèƒ½èŠ‚çœæŸ¥æ‰¾çš„è€—æ—¶</p>
</li>
</ol>
<h2 id="äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«"><a href="#äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«" class="headerlink" title="äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«"></a>äº”ã€ConcurrentHashMapã€HashTableã€HashMapåŒºåˆ«</h2><h3 id="1ã€HashMap"><a href="#1ã€HashMap" class="headerlink" title="1ã€HashMap"></a>1ã€HashMap</h3><p>å› ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨Hashmapè¿›è¡Œputæ“ä½œå¯èƒ½ä¼šå¼•èµ·æ­»é”ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨HashMapã€‚ã€PSï¼šHashMap æ˜¯å…è®¸keyå€¼ä¸ºç©ºçš„ã€‘</p>
<h3 id="2ã€HashTable"><a href="#2ã€HashTable" class="headerlink" title="2ã€HashTable"></a>2ã€HashTable</h3><p>Hashtableå®¹å™¨ä½¿ç”¨synchronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹Hashtableçš„æ•ˆç‡éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®Hashtableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—®Hashtableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ã€‚å¦‚çº¿ç¨‹1ä½¿ç”¨putè¿›è¡Œæ·»åŠ å…ƒç´ ï¼Œçº¿ç¨‹2ä¸ä½†ä¸èƒ½ä½¿ç”¨putæ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ä½¿ç”¨getæ–¹æ³•æ¥è·å–å…ƒç´ ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<p><img src="/2021/08/18/hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hashmap%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/image-ba4fef5ef17740c79a373e929b5db03f.png" alt="image.png"></p>
<h3 id="3ã€ConcurrentHashMap"><a href="#3ã€ConcurrentHashMap" class="headerlink" title="3ã€ConcurrentHashMap"></a>3ã€ConcurrentHashMap</h3><p><strong>1ï¼‰jdk7ç‰ˆæœ¬</strong></p>
<p>ConcurrentHashMapå’ŒHashMapè®¾è®¡æ€è·¯å·®ä¸å¤šï¼Œä½†æ˜¯ä¸ºæ”¯æŒå¹¶å‘æ“ä½œï¼Œåšäº†ä¸€å®šçš„æ”¹è¿›ï¼ŒConcurrentHashMapå¼•å…¥Segment çš„æ¦‚å¿µï¼Œç›®çš„æ˜¯å°†mapæ‹†åˆ†æˆå¤šä¸ªSegment(é»˜è®¤16ä¸ª)ã€‚æ“ä½œConcurrentHashMapç»†åŒ–åˆ°æ“ä½œæŸä¸€ä¸ªSegmentã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸åŒçº¿ç¨‹æ“ä½œä¸åŒçš„Segmentï¼Œä»–ä»¬äº’ä¸å½±å“ï¼Œè¿™ä¾¿å¯å®ç°å¹¶å‘æ“ä½œã€‚</p>
<p><strong>2ï¼‰jdk8ç‰ˆæœ¬</strong></p>
<p>jdk8ç‰ˆæœ¬çš„ConcurrentHashMapç›¸å¯¹äºjdk7ç‰ˆæœ¬ï¼Œå‘é€äº†å¾ˆå¤§æ”¹åŠ¨ï¼Œjdk8ç›´æ¥æŠ›å¼ƒäº†Segmentçš„è®¾è®¡ï¼Œé‡‡ç”¨äº†  è¾ƒä¸ºè½»æ·çš„Node + CAS + Synchronizedè®¾è®¡ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p><strong>3ï¼‰æ€»ç»“</strong></p>
<p>1ã€getæ–¹æ³•ä¸åŠ é”ï¼›</p>
<p>2ã€putã€removeæ–¹æ³•è¦ä½¿ç”¨é”</p>
<p>jdk7ä½¿ç”¨é”åˆ†ç¦»æœºåˆ¶(Segmentåˆ†æ®µåŠ é”)</p>
<p>jdk8ä½¿ç”¨cas + synchronized å®ç°é”æ“ä½œ</p>
<p>3ã€Iteratorå¯¹è±¡çš„ä½¿ç”¨ï¼Œè¿è¡Œä¸€è¾¹æ›´æ–°ï¼Œä¸€ééå†(å¯ä»¥æ ¹æ®åŸç†è‡ªå·±æ‹“å±•)</p>
<p>4ã€å¤åˆæ“ä½œï¼Œæ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦é¢å¤–åŠ é”ä¿è¯</p>
<p>5ã€å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒConcurrentHashMap æ•ˆç‡è¾ƒCollections.synchronizedMap()æ›´é«˜</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>springboot+mybatis_pluså®ç°è¯»å†™åˆ†ç¦»</title>
    <url>/2021/10/10/springboot+mybatis_plus%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-springbootmybatisplus%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
    <content><![CDATA[<h3 id="1ã€å¼•è¨€"><a href="#1ã€å¼•è¨€" class="headerlink" title="1ã€å¼•è¨€"></a>1ã€å¼•è¨€</h3><p>è¯»å†™åˆ†ç¦»è¦åšçš„äº‹æƒ…å°±æ˜¯å¯¹äºä¸€æ¡SQLè¯¥é€‰æ‹©å“ªä¸ªæ•°æ®åº“å»æ‰§è¡Œï¼Œè‡³äºè°æ¥åšé€‰æ‹©æ•°æ®åº“è¿™ä»¶äº‹å„¿ï¼Œæ— éä¸¤ä¸ªï¼Œè¦ä¹ˆä¸­é—´ä»¶å¸®æˆ‘ä»¬åšï¼Œè¦ä¹ˆç¨‹åºè‡ªå·±åšã€‚</p>
<p>å› æ­¤ï¼Œä¸€èˆ¬æ¥è®²ï¼Œè¯»å†™åˆ†ç¦»æœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯ä¾é ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ï¼šMyCatï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´åº”ç”¨ç¨‹åºè¿æ¥åˆ°ä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶å¸®æˆ‘ä»¬åšSQLåˆ†ç¦»ï¼›ç¬¬äºŒç§æ˜¯åº”ç”¨ç¨‹åºè‡ªå·±å»åšåˆ†ç¦»ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç¨‹åºè‡ªå·±æ¥åšï¼Œä¸»è¦æ˜¯åˆ©ç”¨Springæä¾›çš„è·¯ç”±æ•°æ®æºï¼Œä»¥åŠAOP</p>
<p>ç„¶è€Œï¼Œåº”ç”¨ç¨‹åºå±‚é¢å»åšè¯»å†™åˆ†ç¦»æœ€å¤§çš„å¼±ç‚¹ï¼ˆä¸è¶³ä¹‹å¤„ï¼‰åœ¨äºæ— æ³•åŠ¨æ€å¢åŠ æ•°æ®åº“èŠ‚ç‚¹ï¼Œå› ä¸ºæ•°æ®æºé…ç½®éƒ½æ˜¯å†™åœ¨é…ç½®ä¸­çš„ï¼Œæ–°å¢æ•°æ®åº“æ„å‘³ç€æ–°åŠ ä¸€ä¸ªæ•°æ®æºï¼Œå¿…ç„¶æ”¹é…ç½®ï¼Œå¹¶é‡å¯åº”ç”¨ã€‚å½“ç„¶ï¼Œå¥½å¤„å°±æ˜¯ç›¸å¯¹ç®€å•ã€‚</p>
<h4 id="1-1é¡¹ç›®åœ°å€"><a href="#1-1é¡¹ç›®åœ°å€" class="headerlink" title="1.1é¡¹ç›®åœ°å€"></a>1.1é¡¹ç›®åœ°å€</h4><p><strong>git-hub</strong>:<a href="https://github.com/wenlinshan/wenlinshan/tree/main/master-slave-demo">https://github.com/wenlinshan/wenlinshan/tree/main/master-slave-demo</a></p>
<h3 id="2ã€AbstractRoutingDataSource"><a href="#2ã€AbstractRoutingDataSource" class="headerlink" title="2ã€AbstractRoutingDataSource"></a>2ã€AbstractRoutingDataSource</h3><p>åŸºäºç‰¹å®šçš„æŸ¥æ‰¾keyè·¯ç”±åˆ°ç‰¹å®šçš„æ•°æ®æºã€‚å®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ç»„ç›®æ ‡æ•°æ®æºï¼Œå¹¶ä¸”åšäº†è·¯ç”±keyä¸ç›®æ ‡æ•°æ®æºä¹‹é—´çš„æ˜ å°„ï¼Œæä¾›åŸºäºkeyæŸ¥æ‰¾æ•°æ®æºçš„æ–¹æ³•ã€‚</p>
<h3 id="3ã€å®è·µ"><a href="#3ã€å®è·µ" class="headerlink" title="3ã€å®è·µ"></a>3ã€å®è·µ</h3><h4 id="3-1-mavenä¾èµ–"><a href="#3-1-mavenä¾èµ–" class="headerlink" title="3.1. mavenä¾èµ–"></a>3.1. mavenä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.wenlinshan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>master-slave-demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--é©±åŠ¨--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- druid --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-2-æ•°æ®æºé…ç½®"><a href="#3-2-æ•°æ®æºé…ç½®" class="headerlink" title="3.2. æ•°æ®æºé…ç½®"></a>3.2. æ•°æ®æºé…ç½®</h4><p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#é…ç½®æ•°æ®æºï¼Œæ ¹æ®ä¸åŒåº“æ¨¡æ‹Ÿä¸»ä»åº“</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/m1?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">slave1:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/s1?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">slave2:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">wen</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/s2?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="comment"># å¦‚æœæ˜¯æ”¾åœ¨src/main/javaç›®å½•ä¸‹ classpath:/com/yourpackage/*/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="comment"># å¦‚æœæ˜¯æ”¾åœ¨resourceç›®å½• classpath:/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:/mapper/*Mapper.xml</span></span><br><span class="line">  <span class="comment">#å®ä½“æ‰«æï¼Œå¤šä¸ªpackageç”¨é€—å·æˆ–è€…åˆ†å·åˆ†éš”</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">com.seawatebt.ssm.entity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#é…ç½®è¿”å›æ•°æ®åº“(columnä¸‹åˆ’çº¿å‘½å&amp;&amp;è¿”å›javaå®ä½“æ˜¯é©¼å³°å‘½å)ï¼Œè‡ªåŠ¨åŒ¹é…æ— éœ€asï¼ˆæ²¡å¼€å¯è¿™ä¸ªï¼ŒSQLéœ€è¦å†™asï¼š select user_id as userIdï¼‰</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#é…ç½®JdbcTypeForNull, oracleæ•°æ®åº“å¿…é¡»é…ç½®</span></span><br><span class="line">    <span class="attr">jdbc-type-for-null:</span> <span class="string">&#x27;null&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-è®¾ç½®è·¯ç”±key-x2F-æŸ¥æ‰¾æ•°æ®æº"><a href="#3-3-è®¾ç½®è·¯ç”±key-x2F-æŸ¥æ‰¾æ•°æ®æº" class="headerlink" title="3.3. è®¾ç½®è·¯ç”±key &#x2F; æŸ¥æ‰¾æ•°æ®æº"></a>3.3. è®¾ç½®è·¯ç”±key &#x2F; æŸ¥æ‰¾æ•°æ®æº</h4><p>ç›®æ ‡æ•°æ®æºå°±æ˜¯é‚£å‰3ä¸ªè¿™ä¸ªæˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™æ˜¯å¦‚æœæŸ¥æ‰¾æ•°æ®æºçš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæšä¸¾æ¥ä»£è¡¨è¿™ä¸‰ä¸ªæ•°æ®æº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> æ•°æ®åº“ç±»å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DBTypeEnum</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MASTER,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SLAVE1,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SLAVE2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>æ–°å»ºDataSourceContextHolder</strong></p>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ThreadLocalå°†æ•°æ®æºè®¾ç½®åˆ°æ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.constant.DBTypeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ThreadLocalå°†æ•°æ®æºè®¾ç½®åˆ°æ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceContextHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DBTypeEnum&gt; CONTEXT_HOLDER = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">COUNTER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(DBTypeEnum dbType)</span> &#123;</span><br><span class="line">        CONTEXT_HOLDER.set(dbType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DBTypeEnum <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CONTEXT_HOLDER.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;</span><br><span class="line">        CONTEXT_HOLDER.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">master</span><span class="params">()</span> &#123;</span><br><span class="line">        set(DBTypeEnum.MASTER);</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°master&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">slave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//  è½®è¯¢</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> COUNTER.getAndIncrement() % <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (COUNTER.get() &gt; <span class="number">9999</span>) &#123;</span><br><span class="line">            COUNTER.set(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE1);</span><br><span class="line">            System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°slave1&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE2);</span><br><span class="line">            System.out.println(<span class="string">&quot;åˆ‡æ¢åˆ°slave2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®è·¯ç”±key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å£°æ˜è·¯ç”±æ•°æ®æºkey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRoutingDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceContextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>å¤šæ•°æ®æºé…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.constant.DBTypeEnum;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…³äºæ•°æ®æºé…ç½®ï¼Œå‚è€ƒSpringBootå®˜æ–¹æ–‡æ¡£ç¬¬79ç« ã€ŠData Accessã€‹</span></span><br><span class="line"><span class="comment"> * 79. Data Access</span></span><br><span class="line"><span class="comment"> * 79.1 Configure a Custom DataSource</span></span><br><span class="line"><span class="comment"> * 79.2 Configure Two DataSources</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä¸»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;master&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.master&quot; )</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;slave1&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.slave1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave1DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ä»æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;slave2&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.druid.slave2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave2DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®è·¯ç”±æ•°æ®æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> masterDataSource ä¸»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slave1DataSource ä»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slave2DataSource ä»èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">myRoutingDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;master&quot;)</span> DataSource masterDataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave1&quot;)</span> DataSource slave1DataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave2&quot;)</span> DataSource slave2DataSource)</span> &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.MASTER, masterDataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE1, slave1DataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE2, slave2DataSource);</span><br><span class="line">        <span class="type">MyRoutingDataSource</span> <span class="variable">myRoutingDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRoutingDataSource</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®é»˜è®¤æ•°æ®æº</span></span><br><span class="line">        myRoutingDataSource.setDefaultTargetDataSource(masterDataSource);</span><br><span class="line">        myRoutingDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="keyword">return</span> myRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬é…ç½®äº†4ä¸ªæ•°æ®æºï¼Œ1ä¸ªmasterï¼Œ2ä¸¤ä¸ªslaveï¼Œ1ä¸ªè·¯ç”±æ•°æ®æºã€‚å‰3ä¸ªæ•°æ®æºéƒ½æ˜¯ä¸ºäº†ç”Ÿæˆç¬¬4ä¸ªæ•°æ®æºï¼Œè€Œä¸”åç»­æˆ‘ä»¬åªç”¨è¿™æœ€åä¸€ä¸ªè·¯ç”±æ•°æ®æºã€‚</p>
<p><strong>MyBatisé…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.MybatisConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.omg.PortableInterceptor.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mybatis é…ç½®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;myRoutingDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> DataSource myRoutingDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MybatisSqlSessionFactoryBean</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlSessionFactoryBean</span>();</span><br><span class="line">        sqlSessionFactory.setDataSource(myRoutingDataSource);</span><br><span class="line">        <span class="type">MybatisConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisConfiguration</span>();</span><br><span class="line">        configuration.setJdbcTypeForNull(JdbcType.NULL);</span><br><span class="line">        configuration.setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">        configuration.setCacheEnabled(<span class="literal">false</span>);</span><br><span class="line">        sqlSessionFactory.setConfiguration(configuration);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">platformTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(myRoutingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºSpringå®¹å™¨ä¸­ç°åœ¨æœ‰4ä¸ªæ•°æ®æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºäº‹åŠ¡ç®¡ç†å™¨å’ŒMyBatisæ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªæ˜ç¡®çš„æ•°æ®æºã€‚</p>
<h4 id="3-4-ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢"><a href="#3-4-ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢" class="headerlink" title="3.4 ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢"></a>3.4 ä½¿ç”¨aopå®ç°æ•°æ®æºåˆ‡æ¢</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½èµ°ä»åº“ï¼Œæ’å…¥&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤èµ°ä¸»åº“ã€‚æˆ‘ä»¬é€šè¿‡æ–¹æ³•åæ¥åŒºåˆ†æ“ä½œç±»å‹ï¼ˆCRUDï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.config.DataSourceContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è®¾ç½®åˆ‡é¢ æ‰§è¡Œå…·ä½“æ–¹æ³•é€‰æ‹©çš„æ•°æ®æº</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAop</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éœ€è¦è¯»çš„æ–¹æ³•,åˆ‡é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;!@annotation(com.wenlinshan.masterslavedemo.annotation.Master)&quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; (execution(* com.wenlinshan.masterslavedemo.service..*.select*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.get*(..)))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readPointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†™åˆ‡é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.wenlinshan.masterslavedemo.annotation.Master) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.insert*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.save*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.add*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.update*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.edit*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.delete*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.wenlinshan.masterslavedemo.service..*.remove*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writePointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;readPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.slave();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;writePointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.master();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;readPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readAfter</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;writePointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeAfter</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€èˆ¬æƒ…å†µå°±æœ‰ç‰¹æ®Šæƒ…å†µï¼Œç‰¹æ®Šæƒ…å†µæ˜¯æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦å¼ºåˆ¶è¯»ä¸»åº“ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¸»é”®ï¼Œç”¨è¯¥æ³¨è§£æ ‡æ³¨çš„å°±è¯»ä¸»åº“</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.annotation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Master &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Goodsè¡¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;`name`&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;quantity&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_ID</span> <span class="operator">=</span> <span class="string">&quot;id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_NAME</span> <span class="operator">=</span> <span class="string">&quot;name&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_QUANTITY</span> <span class="operator">=</span> <span class="string">&quot;quantity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COL_PRICE</span> <span class="operator">=</span> <span class="string">&quot;price&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4ã€æµ‹è¯•"><a href="#4ã€æµ‹è¯•" class="headerlink" title="4ã€æµ‹è¯•"></a>4ã€æµ‹è¯•</h3><p><strong>service</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.annotation.Master;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.domain.Goods;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.mapper.GoodsMapper;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.service.GoodsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;GoodsMapper, Goods&gt; <span class="keyword">implements</span> <span class="title class_">GoodsService</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goods å•†å“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveGoods</span><span class="params">(Goods goods)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.save(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteGoods</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.removeById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Goods&gt; <span class="title function_">getGoodsAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å•ä¸ª</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å•†å“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Master</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Goods <span class="title function_">getGoodsById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>controller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wenlinshan.masterslavedemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.annotation.Master;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.domain.Goods;</span><br><span class="line"><span class="keyword">import</span> com.wenlinshan.masterslavedemo.service.GoodsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.DeleteMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> goods å•†å“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/saveGoods&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveGoods</span><span class="params">(Goods goods)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.saveGoods(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/deleteGoods&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteGoods</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.deleteGoods(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…¨éƒ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getGoodsAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Goods&gt; <span class="title function_">getGoodsAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.getGoodsAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢å•ä¸ª</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å•†å“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;getGoodsById&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Goods <span class="title function_">getGoodsById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.getGoodsById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>springboot+redissonå®ç°åˆ†å¸ƒå¼é”</title>
    <url>/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/</url>
    <content><![CDATA[<h2 id="redisson-springboot-å®ç°åˆ†å¸ƒå¼é”"><a href="#redisson-springboot-å®ç°åˆ†å¸ƒå¼é”" class="headerlink" title="redisson+springboot å®ç°åˆ†å¸ƒå¼é”"></a>redisson+springboot å®ç°åˆ†å¸ƒå¼é”</h2><p>åœ¨ä¸€äº›åœºæ™¯æ—¶ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„ä¸é‡å¤ï¼Œä»¥åŠæ•°æ®çš„å‡†ç¡®æ€§ï¼Œç‰¹åˆ«æ˜¯ç‰¹å®šä¸‹ï¼ŒæŸäº›æ•°æ®çš„å‡†ç¡®æ€§æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™è¦ä¿è¯æŸä¸ªæ–¹æ³•åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚åœ¨å•æœºæƒ…å†µä¸‹å¯ä»¥ç”¨jdkçš„ä¹è§‚é”è¿›è¡Œä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ã€‚è€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™ç§jdkçš„é”å°±æ— æ³•æ»¡è¶³è¿™ç§åœºæ™¯ã€‚</p>
<p>æ‰€ä»¥éœ€è¦ä½¿ç”¨redssionå®ç°åˆ†å¸ƒå¼é”ï¼Œå®ƒä¸ä»…å¯ä»¥å®ç°åˆ†å¸ƒå¼é”ï¼Œä¹Ÿå¯ä»¥åœ¨æŸäº›æƒ…å†µä¸‹ä¿è¯ä¸é‡å¤æäº¤ï¼Œä¿è¯æ¥å£çš„å¹‚ç­‰æ€§ã€‚</p>
<p>redissonæ˜¯åŸºäºrediså®ç°çš„åˆ†å¸ƒå¼é”ï¼Œå› ä¸ºredisæ‰§è¡Œå‘½ä»¤æ“ä½œæ—¶æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–å®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚zkï¼ŒMongoDBç­‰ã€‚</p>
<h4 id="ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹"><a href="#ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹" class="headerlink" title="ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹"></a>ç®€å•æ¥èŠä¸€ä¸‹å„è‡ªä¼˜ç¼ºç‚¹</h4><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°åŸç†</th>
<th>ä¼˜ç‚¹</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>MongoDB</td>
<td>1.åŠ é”ï¼šæ‰§è¡ŒfindAndModifyåŸå­å‘½ä»¤æŸ¥æ‰¾documentï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ–°å¢<br>2.è§£é”ï¼šåˆ é™¤document</td>
<td>å®ç°è¾ƒä¸ºç®€å•</td>
<td>1.å¤§éƒ¨åˆ†å…¬å¸æ•°æ®åº“ç”¨MySQLï¼Œå¯èƒ½ç¼ºä¹ç›¸åº”çš„MongoDBè¿ç»´ã€å¼€å‘äººå‘˜<br>2.é”æ— è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶</td>
</tr>
<tr>
<td>ZooKeepe</td>
<td>1.åŠ é”ï¼šåœ¨&#x2F;lockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼Œåˆ¤æ–­åˆ›å»ºçš„èŠ‚ç‚¹åºå·æ˜¯å¦æœ€å°ã€‚è‹¥æ˜¯ï¼Œåˆ™è¡¨ç¤ºè·å–åˆ°é”ï¼›å¦ï¼Œåˆ™åˆ™watch &#x2F;lockç›®å½•ä¸‹åºå·æ¯”è‡ªèº«å°çš„å‰ä¸€ä¸ªèŠ‚ç‚¹<br>2.è§£é”ï¼šåˆ é™¤èŠ‚ç‚¹</td>
<td>1.ç”±zkä¿éšœç³»ç»Ÿé«˜å¯ç”¨<br>2.Curatoræ¡†æ¶å·²åŸç”Ÿæ”¯æŒç³»åˆ—åˆ†å¸ƒå¼é”å‘½ä»¤ï¼Œä½¿ç”¨ç®€å•</td>
<td>éœ€å•ç‹¬ç»´æŠ¤ä¸€å¥—zké›†ç¾¤ï¼Œç»´ä¿æˆæœ¬é«˜</td>
</tr>
<tr>
<td>redis</td>
<td>1. åŠ é”ï¼šæ‰§è¡Œsetnxï¼Œè‹¥æˆåŠŸå†æ‰§è¡Œexpireæ·»åŠ è¿‡æœŸæ—¶é—´<br>2. è§£é”ï¼šæ‰§è¡Œdeleteå‘½ä»¤</td>
<td>å®ç°ç®€å•ï¼Œç›¸æ¯”æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å®ç°ï¼Œè¯¥æ–¹æ¡ˆæœ€è½»ï¼Œæ€§èƒ½æœ€å¥½</td>
<td>1.setnxå’Œexpireåˆ†2æ­¥æ‰§è¡Œï¼ŒéåŸå­æ“ä½œï¼›è‹¥setnxæ‰§è¡ŒæˆåŠŸï¼Œä½†expireæ‰§è¡Œå¤±è´¥ï¼Œå°±å¯èƒ½å‡ºç°æ­»é”<br>2.deleteå‘½ä»¤å­˜åœ¨è¯¯åˆ é™¤éå½“å‰çº¿ç¨‹æŒæœ‰çš„é”çš„å¯èƒ½<br>3.ä¸æ”¯æŒé˜»å¡ç­‰å¾…ã€ä¸å¯é‡å…¥</td>
</tr>
<tr>
<td>redis Luaè„šæœ¬èƒ½åŠ›</td>
<td>1. åŠ é”ï¼šæ‰§è¡ŒSET lock_name random_value EX seconds NX å‘½ä»¤ <br>2. è§£é”ï¼šæ‰§è¡ŒLuaè„šæœ¬ï¼Œé‡Šæ”¾é”æ—¶éªŒè¯random_value â€“ ARGV[1]ä¸ºrandom_value, KEYS[1]ä¸ºlock_name</td>
<td>åŒä¸Šï¼›å®ç°é€»è¾‘ä¸Šä¹Ÿæ›´ä¸¥è°¨ï¼Œé™¤äº†å•ç‚¹é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç”¨è¿™ç§æ–¹æ¡ˆï¼Œé—®é¢˜ä¹Ÿä¸å¤§ã€‚</td>
<td>ä¸æ”¯æŒé”é‡å…¥ï¼Œä¸æ”¯æŒé˜»å¡ç­‰å¾…</td>
</tr>
<tr>
<td>redisson</td>
<td>redissonè¿™ä¸ªæ¡†æ¶é‡åº¦ä¾èµ–äº†Luaè„šæœ¬å’ŒNettyï¼ŒåŠ é”ã€è§£é”Luaè„šæœ¬æ˜¯redissonåˆ†å¸ƒå¼é”</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶"><a href="#åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶" class="headerlink" title="åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶"></a>åˆ†å¸ƒå¼é”éœ€æ»¡è¶³å››ä¸ªæ¡ä»¶</h4><p>é¦–å…ˆï¼Œä¸ºäº†ç¡®ä¿åˆ†å¸ƒå¼é”å¯ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘è¦ç¡®ä¿é”çš„å®ç°åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>äº’æ–¥æ€§ã€‚åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚</li>
<li>ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚å³ä½¿æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æŒæœ‰é”çš„æœŸé—´å´©æºƒè€Œæ²¡æœ‰ä¸»åŠ¨è§£é”ï¼Œä¹Ÿèƒ½ä¿è¯åç»­å…¶ä»–å®¢æˆ·ç«¯èƒ½åŠ é”ã€‚</li>
<li>è§£é“ƒè¿˜é¡»ç³»é“ƒäººã€‚åŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è‡ªå·±ä¸èƒ½æŠŠåˆ«äººåŠ çš„é”ç»™è§£äº†ï¼Œå³ä¸èƒ½è¯¯è§£é”ã€‚</li>
<li>å…·æœ‰å®¹é”™æ€§ã€‚åªè¦å¤§å¤šæ•°RedisèŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œå®¢æˆ·ç«¯å°±èƒ½å¤Ÿè·å–å’Œé‡Šæ”¾é”</li>
</ol>
<h4 id="redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹"><a href="#redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹" class="headerlink" title="redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹"></a>redissonå®ç°åˆ†å¸ƒå¼é”æ¡ˆä¾‹</h4><h5 id="1ã€å¯¼å…¥ä¾èµ–"><a href="#1ã€å¯¼å…¥ä¾èµ–" class="headerlink" title="1ã€å¯¼å…¥ä¾èµ–"></a>1ã€å¯¼å…¥ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.redisson/redisson --&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;redisson&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">            &lt;version&gt;3.12.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">        &lt;/dependency&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="2ã€é…ç½®redisson-single-å•æœº"><a href="#2ã€é…ç½®redisson-single-å•æœº" class="headerlink" title="2ã€é…ç½®redisson-single(å•æœº)"></a>2ã€é…ç½®redisson-single(å•æœº)</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å•æœº</span></span><br><span class="line"><span class="attr">singleServerConfig:</span></span><br><span class="line">  <span class="attr">idleConnectionTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">pingTimeout:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">10000</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">retryAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">retryInterval:</span> <span class="number">1500</span></span><br><span class="line">  <span class="attr">reconnectionTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">failedAttempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">subscriptionsPerConnection:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">clientName:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">&quot;redis://localhost:6379&quot;</span></span><br><span class="line">  <span class="attr">subscriptionConnectionMinimumIdleSize:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">subscriptionConnectionPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">connectionMinimumIdleSize:</span> <span class="number">32</span></span><br><span class="line">  <span class="attr">connectionPoolSize:</span> <span class="number">64</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">#åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­dnsçš„æ£€æŸ¥æ“ä½œä¼šç›´æ¥æŠ¥é”™ æ‰€ä»¥æˆ‘ç›´æ¥æ³¨é‡Šæ‰äº†</span></span><br><span class="line">  <span class="comment">#dnsMonitoring: false</span></span><br><span class="line">  <span class="attr">dnsMonitoringInterval:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">threads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">nettyThreads:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">codec:</span> <span class="type">!&lt;org.redisson.codec.JsonJacksonCodec&gt;</span> &#123;&#125;</span><br><span class="line"><span class="attr">transportMode :</span> <span class="string">&quot;NIO&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="3ã€é…ç½®application"><a href="#3ã€é…ç½®application" class="headerlink" title="3ã€é…ç½®application"></a>3ã€é…ç½®application</h5><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>

<h5 id="4ã€ç¼–å†™redissoné…ç½®ç±»"><a href="#4ã€ç¼–å†™redissoné…ç½®ç±»" class="headerlink" title="4ã€ç¼–å†™redissoné…ç½®ç±»"></a>4ã€ç¼–å†™redissoné…ç½®ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod=&quot;shutdown&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redisson</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(</span><br><span class="line">                Config.fromYAML(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;redisson-single.yml&quot;</span>).getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5ã€å…·ä½“ä¸šåŠ¡å®ç°"><a href="#5ã€å…·ä½“ä¸šåŠ¡å®ç°" class="headerlink" title="5ã€å…·ä½“ä¸šåŠ¡å®ç°"></a>5ã€å…·ä½“ä¸šåŠ¡å®ç°</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;GoodsMapper, Goods&gt; <span class="keyword">implements</span> <span class="title class_">GoodsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_KEY</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº“å­˜é€’å‡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id  id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">killGoods</span><span class="params">(Long id, Integer num)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> LOCK_KEY + id;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(key);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ä¸Šé”</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">            <span class="keyword">if</span> (goods.getQuantity()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;åº“å­˜æ•°é‡======&quot;</span>+goods.getQuantity());</span><br><span class="line">            <span class="comment">//å°†åº“å­˜å‡æ“ä½œ</span></span><br><span class="line">            goods.setQuantity(goods.getQuantity()-<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">this</span>.updateById(goods);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//è§£é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="6ã€æ¥å£å®ç°"><a href="#6ã€æ¥å£å®ç°" class="headerlink" title="6ã€æ¥å£å®ç°"></a>6ã€æ¥å£å®ç°</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrderTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!goodsService.killGoods(<span class="number">1405065181720055809L</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;åˆ›å»ºè®¢å•æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·"><a href="#7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·" class="headerlink" title="7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·"></a>7ã€æµ‹è¯•ï¼Œç”¨abæµ‹è¯•å·¥å…·</h5><p>æ¨¡æ‹Ÿ200ä¸ªå¹¶å‘æµ‹è¯•</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\develop\Apache24\bin&gt;ab  -n 200 -c 200 &quot;http://localhost:8080/test&quot;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<p><img src="/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/1623922545310-b997fe37fc3c4af18ecef38b4e142ff8.png" alt="1623922545310.png"></p>
<p><img src="/2021/05/12/springboot+redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-springbootredisson-shi-xian-fen-bu-shi-suo/1623922677743-deda4b67d30e452696770467e442c5f9.png" alt="1623922677743.png"></p>
<p>æ²¡æœ‰åº“å­˜å˜æˆè´Ÿæ•°çš„æƒ…å†µï¼Œè¯´æ˜åˆ†å¸ƒå¼é”å·²ç”Ÿæ•ˆ</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼é”</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>springäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</title>
    <url>/2022/10/25/spring%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA-spring-shi-wu-de-chuan-bo-xing-wei/</url>
    <content><![CDATA[<h2 id="ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­"><a href="#ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­" class="headerlink" title="ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­"></a>ä¸€ã€å¤šä¸ªäº‹åŠ¡æ–¹æ³•ç›¸äº’è°ƒç”¨æ—¶ï¼Œäº‹åŠ¡å¦‚ä½•åœ¨è¿™äº›æ–¹æ³•é—´ä¼ æ’­</h2><p>æ–¹æ³•Aæ˜¯ä¸€ä¸ªäº‹åŠ¡çš„æ–¹æ³•ï¼Œæ–¹æ³•Aæ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº†æ–¹æ³•Bï¼Œé‚£ä¹ˆæ–¹æ³•Bæœ‰æ— äº‹åŠ¡ä»¥åŠæ–¹æ³•Bå¯¹äº‹åŠ¡çš„è¦æ±‚ä¸åŒéƒ½ä¼šå¯¹æ–¹æ³•Açš„äº‹åŠ¡å…·ä½“æ‰§è¡Œé€ æˆå½±å“ï¼ŒåŒæ—¶æ–¹æ³•Açš„äº‹åŠ¡å¯¹æ–¹æ³•Bçš„äº‹åŠ¡æ‰§è¡Œä¹Ÿæœ‰å½±å“ï¼Œè¿™ç§å½±å“å…·ä½“æ˜¯ä»€ä¹ˆå°±ç”±ä¸¤ä¸ªæ–¹æ³•æ‰€å®šä¹‰çš„äº‹åŠ¡ä¼ æ’­ç±»å‹æ‰€å†³å®šã€‚</p>
<p><strong>REQUIRED</strong>ï¼ˆSpringé»˜è®¤çš„äº‹åŠ¡ä¼ æ’­ç±»å‹ï¼‰ï¼šå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è‡ªå·±æ–°å»ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¿™ä¸ªäº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–¹æ³•Bé‡Œé¢çš„sqläº‹åŠ¡æ”¾åœ¨ä¸€èµ·ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlå°±ä¼šåŠ å…¥æ–¹æ³•Açš„sqlçš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚</p>
<p><strong>SUPPORTS</strong>:å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥éäº‹åŠ¡æ–¹æ³•æ‰§è¡Œã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bé‡Œé¢çš„sqlåˆ™ä¼šåŠ å…¥æ–¹æ³•Açš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlå°±ä¼šä»¥éäº‹åŠ¡è¿è¡Œã€‚</p>
<p><strong>MANDATORY</strong>:å½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bé‡Œé¢çš„sqlåˆ™ä¼šåŠ å…¥æ–¹æ³•Açš„äº‹åŠ¡ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><strong>REQUIRES_NEW</strong>:åˆ›å»ºä¸€ä¸ªæ–°äº‹ç‰©ï¼Œå¦‚æœå­˜åœ¨å½“å‰äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·è¯¥äº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼ŒåŒæ—¶æ–¹æ³•Bæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlä¹Ÿæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œæ–¹æ³•Aé‡Œé¢çš„äº‹åŠ¡ï¼Œå†å»æ‰§è¡Œæ–¹æ³•Bé‡Œé¢çš„äº‹åŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒAäº‹åŠ¡å›æ»šå°±åªæ˜¯å›æ»šAè‡ªå·±çš„äº‹åŠ¡ï¼ŒBäº¦æ˜¯å¦‚æ­¤ã€‚</p>
<p><strong>NOT_SUPPORTED</strong>:ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŒ‚èµ·å½“å‰äº‹åŠ¡ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„æ–¹æ³•é‡Œé¢çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Aé‡Œé¢çš„sqlå•ç‹¬åœ¨äº‹åŠ¡é‡Œæ‰§è¡Œï¼Œæ–¹æ³•Bé‡Œé¢çš„sqlä¸€å®šæ˜¯ä»¥éäº‹åŠ¡è¿è¡Œã€‚å¦‚æœæ–¹æ³•Aé‡Œé¢çš„sqlæ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Aä¸æ–¹æ³•Bé‡Œé¢çš„sqléƒ½æ˜¯ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚</p>
<p><strong>NEVER</strong>:ä¸ä½¿ç”¨äº‹åŠ¡ï¼Œå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><strong>NESTED</strong>:å¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™REQUIREDçš„æ“ä½œä¸€æ ·ï¼ˆå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼‰ã€‚ä¸¾ä¾‹è¯´æ˜:å¦‚æœæ–¹æ³•Aæ‰€åœ¨çš„sqlæœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆæ–¹æ³•Bæ‰€åœ¨çš„sqlåˆ™ä¼šåµŒå¥—åœ¨æ–¹æ³•Açš„äº‹åŠ¡ä¸­æ‰§è¡Œã€‚</p>
<p><strong>NESTED</strong>å’Œ<strong>REQUIRES_NEW</strong>çš„åŒºåˆ«:<strong>REQUIRES_NEW</strong>æ˜¯æ–°å»ºä¸€ä¸ªäº‹åŠ¡å¹¶ä¸”æ–°å¼€å¯çš„è¿™ä¸ªäº‹åŠ¡ä¸åŸäº‹åŠ¡æ— å…³ï¼Œè€Œ<strong>NESTED</strong>åˆ™æ˜¯å½“å‰å­˜åœ¨äº‹åŠ¡æ—¶ï¼ˆæˆ‘ä»¬æŠŠå½“å‰äº‹åŠ¡ç§°ä¹‹ä¸ºçˆ¶äº‹åŠ¡ï¼‰ä¼šå¼€å¯ä¸€ä¸ªåµŒå¥—äº‹åŠ¡ï¼ˆç§°ä¹‹ä¸ºä¸€ä¸ªå­äº‹åŠ¡ï¼‰ã€‚åœ¨<strong>NESTED</strong>æƒ…å†µä¸‹çˆ¶äº‹åŠ¡å›æ»šæ—¶ï¼Œå­äº‹åŠ¡ä¹Ÿä¼šå›æ»šï¼Œè€Œåœ¨<strong>REQUIRES_NEW</strong>çš„æƒ…å†µä¸‹ï¼ŒåŸæœ‰äº‹åŠ¡å›æ»šï¼Œä¸ä¼šå½±å“æ–°å¼€å¯çš„äº‹åŠ¡ã€‚</p>
<h2 id="äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"><a href="#äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§" class="headerlink" title="äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"></a>äºŒã€å…³äºspringçš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§</h2><p>1ã€why<br>ä¸ºä»€ä¹ˆä¼šæœ‰äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Ÿ</p>
<p>åœºæ™¯ä¸€ï¼š serviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä½†ä¸¤ä¸ªæ–¹æ³•éƒ½æœ‰äº‹åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœ serviceB æ–¹æ³•å¼‚å¸¸ï¼Œæ˜¯è®© serviceB æ–¹æ³•æäº¤ï¼Œè¿˜æ˜¯ä¸¤ä¸ªä¸€èµ·å›æ»šã€‚åœºæ™¯äºŒï¼šserviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ serviceA æ–¹æ³•åŠ äº†äº‹åŠ¡ï¼Œæ˜¯å¦æŠŠ serviceB ä¹ŸåŠ å…¥ serviceA çš„äº‹åŠ¡ï¼Œå¦‚æœ serviceB å¼‚å¸¸ï¼Œæ˜¯å¦å›æ»š serviceA ã€‚åœºæ™¯ä¸‰ï¼šserviceA æ–¹æ³•è°ƒç”¨äº† serviceB æ–¹æ³•ï¼Œä¸¤è€…éƒ½æœ‰äº‹åŠ¡ï¼ŒserviceB å·²ç»æ­£å¸¸æ‰§è¡Œå®Œï¼Œä½† serviceA å¼‚å¸¸ï¼Œæ˜¯å¦éœ€è¦å›æ»š serviceB çš„æ•°æ®ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æœ‰å¯¹åº”çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶æ¥æ§åˆ¶äº‹åŠ¡ã€‚</p>
<p>2ã€ä¼ æ’­æœºåˆ¶ç”Ÿæ•ˆçš„æ¡ä»¶<br>æœ‰äº†springäº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Œé‚£è¿™ç§æœºåˆ¶å­˜åœ¨çš„æ¡ä»¶å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œspringçš„äº‹åŠ¡æ˜¯åŸºäºaopçš„ï¼Œç¡®åˆ‡æ¥è¯´ï¼Œæ˜¯åŸºäºJDKåŠ¨æ€ä»£ç†çš„AOPï¼Œè¿™ç§AOPæœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ å®ƒæ˜¯åŸºäºç±»æˆ–è€…æ¥å£çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ @Transactionalå†™åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šè¢«springåŠ¨æ€ä»£ç†ï¼Œ ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œ å¯¹åŸæ–¹æ³•è¿›è¡Œä¿®é¥°å¢å¼ºï¼Œä½†æ˜¯è¦æ³¨æ„ï¼ï¼ åŸå…ˆçš„æ–¹æ³•çš„ç±»å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œå¹¶æ²¡æœ‰äº‹åŠ¡ï¼ŒspringåŠ¨æ€ä»£ç†è¿™ä¸ªç±»ç”Ÿæˆçš„ä»£ç†ç±»æ‰æœ‰äº‹åŠ¡ï¼Œæ‰æœ‰å¢å¼ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åŒä¸€ä¸ªç±»é‡Œé¢é€šè¿‡this.xx()è°ƒç”¨æœ¬ç±»çš„äº‹åŠ¡æ–¹æ³•æ—¶ï¼Œäº‹åŠ¡æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œå› ä¸ºä½ è°ƒç”¨çš„ä¸æ˜¯ä»£ç†ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; <span class="built_in">this</span>.method2(); &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">xx </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>å…³é”®åœ¨äºè·å–ç±»çš„ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡thiså»è°ƒç”¨ï¼Œæ‰€ä»¥ä»¥ä¸‹æ–¹æ³•éƒ½æ˜¯åŸºäºè¿™ä¸ªå…³é”®ç‚¹å»è§£å†³çš„ã€‚</p>
<p>1ã€æœ€ç®€å•çš„ï¼Œä¸¤ä¸ªäº‹åŠ¡æ–¹æ³•æ”¾åœ¨ä¸åŒçš„serviceé‡Œé¢ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç»™ä¾‹å­äº†ã€‚ï¼ˆæ¨èï¼‰</p>
<p>2ã€AOPä¸Šä¸‹æ–‡ã€‚springæä¾›äº†AOPä¸Šä¸‹æ–‡AopContextï¼Œå› æ­¤é€šè¿‡AopContextï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–åˆ°ä»£ç†å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myservice</span>&#123; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; </span><br><span class="line">		((Myservice)AopContext.currentProxy()).method2(); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">		xx </span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€è¿è¡Œï¼ŒæŠ¥é”™äº†ï¼Œå› ä¸ºexposeProxyé»˜è®¤ä¸ºfalseï¼Œæˆ‘ä»¬è¦æš´éœ²ä»£ç†ç±»ï¼Œå°±è¦è®¾ç½®ä¸ºtrueï¼Œå¯ä»¥åœ¨springbootå¯åŠ¨ç±»ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£</p>
<p>@EnableAspectJAutoProxy(exposeProxy &#x3D; true)<br>3ã€ApplicationContextã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myservice</span>&#123; </span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	ApplicationContext context; </span><br><span class="line"></span><br><span class="line">	Myservice service; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span> <span class="comment">//åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œä¸åŠ ä¹Ÿè¡Œ </span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> 	<span class="title function_">getMyservice</span><span class="params">()</span> &#123; </span><br><span class="line">		service = context.getBean(Myservice.class); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123; </span><br><span class="line">		service.method2(); </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123; </span><br><span class="line">		xx </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒå’Œç¬¬ä¸‰ç§çš„åŒºåˆ«å°±åœ¨äºï¼Œ2æ˜¯ç›´æ¥è·å–ä»£ç†ç±»ï¼Œ3æ˜¯é€šè¿‡è°ƒç”¨getBeané—´æ¥è·å–ä»£ç†ç±»ï¼Œæ€»çš„æ¥è¯´ï¼Œç¬¬ä¸€ç§æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œä¹Ÿæ˜¯æœ€æ¨èçš„åšæ³•ã€‚</p>
<p>3ã€ä¼ æ’­æœºåˆ¶ç±»å‹<br>ä¸‹é¢çš„ç±»å‹éƒ½æ˜¯é’ˆå¯¹äºè¢«è°ƒç”¨æ–¹æ³•æ¥è¯´çš„ï¼Œç†è§£èµ·æ¥è¦æƒ³è±¡æˆä¸¤ä¸ª service æ–¹æ³•çš„è°ƒç”¨æ‰å¯ä»¥ã€‚</p>
<p><strong>PROPAGATION_REQUIRED:</strong> (é»˜è®¤) æ”¯æŒå½“å‰äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œåˆå¹¶æˆä¸€ä¸ªäº‹åŠ¡<br><strong>REQUIRES_NEW:</strong> ï¼ˆä¸€èˆ¬ç”¨åœ¨å­æ–¹æ³•éœ€è¦å•ç‹¬äº‹åŠ¡ï¼‰ æ–°å»ºäº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·è¿™ä¸ªæ–¹æ³•ä¼šç‹¬ç«‹æäº¤äº‹åŠ¡ï¼Œä¸å—è°ƒç”¨è€…çš„äº‹åŠ¡å½±å“ï¼Œçˆ¶çº§å¼‚å¸¸ï¼Œå®ƒä¹Ÿæ˜¯æ­£å¸¸æäº¤<br>ï¼ˆä¸Šé¢ä¸¤ä¸ªç±»å‹æ˜¯å¸¸ç”¨çš„ï¼Œä¸‹é¢çš„æ¯”è¾ƒå°‘ç”¨ï¼‰</p>
<p><strong>NESTED:</strong>  å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œå®ƒå°†ä¼šæˆä¸ºçˆ¶çº§äº‹åŠ¡çš„ä¸€ä¸ªå­äº‹åŠ¡ï¼Œæ–¹æ³•ç»“æŸåå¹¶æ²¡æœ‰æäº¤ï¼Œåªæœ‰ç­‰çˆ¶äº‹åŠ¡ç»“æŸæ‰æäº¤,å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æ–°å»ºäº‹åŠ¡å¦‚æœå®ƒå¼‚å¸¸ï¼Œçˆ¶çº§å¯ä»¥æ•è·å®ƒçš„å¼‚å¸¸è€Œä¸è¿›è¡Œå›æ»šï¼Œæ­£å¸¸æäº¤,ä½†å¦‚æœçˆ¶çº§å¼‚å¸¸ï¼Œå®ƒå¿…ç„¶å›æ»šï¼Œè¿™å°±æ˜¯å’Œ  <strong>REQUIRES_NEW</strong>  çš„åŒºåˆ«<br><strong>SUPPORTS:</strong>  å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥äº‹åŠ¡å¦‚æœå½“å‰ä¸å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œè¿™ä¸ªå’Œä¸å†™æ²¡åŒºåˆ«<br><strong>NOT_SUPPORTED:</strong> ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·<br><strong>MANDATORY:</strong> å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™è¿è¡Œåœ¨å½“å‰äº‹åŠ¡ä¸­å¦‚æœå½“å‰æ— äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå³çˆ¶çº§æ–¹æ³•å¿…é¡»æœ‰äº‹åŠ¡<br><strong>NEVER:</strong> ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå³çˆ¶çº§æ–¹æ³•å¿…é¡»æ— äº‹åŠ¡</p>
]]></content>
  </entry>
  <entry>
    <title>zookeeperè‡ªå·±å®ç°åˆ†å¸ƒå¼é”</title>
    <url>/2022/08/22/zookeeper%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-zookeeper-zi-ji-shi-xian-fen-bu-shi-suo/</url>
    <content><![CDATA[<pre><code>åœ¨ä¸€äº›å¹¶å‘è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ï¼Œåœ¨åŒä¸€æ—¶åˆ»åªèƒ½å…è®¸ä¸€ä¸ªè¯·æ±‚å¯¹åŒä¸€æ¡æ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œã€‚åœ¨ä¹‹å‰çš„å•æœºåº”ç”¨å½“ä¸­ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°åˆ©ç”¨jdkçš„é”æ¥å®ç°ï¼Œä¾‹å¦‚ synchronizedæˆ–è€…lock ã€‚ä½†æ˜¯åœ¨å¦‚ä»Šä¸šåŠ¡å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­jdkçš„é”å¹¶ä¸é€‚ç”¨ï¼Œæ‰€ä»¥å¿…é¡»è¦è¦ç”¨åˆ†å¸ƒå¼é”ã€‚
</code></pre>
<p>å¸¸è§çš„å‡ ç§åˆ†å¸ƒå¼é”çš„å®ç°æ–¹æ¡ˆï¼ŒRedisã€Mysql ã€zookeeperï¼›</p>
<p>æœ¬æ–‡ä¸»è¦è®²çš„æ˜¯å¦‚ä½•ä½¿ç”¨zkå®ç°åˆ†å¸ƒå¼é”ï¼š</p>
<pre><code>     ZooKeeperæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œä»–ä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›äº†é«˜æ•ˆä¸”å¯é çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†è¯¸å¦‚ç»Ÿä¸€å‘½åç©ºé—´æœåŠ¡ï¼Œé…ç½®æœåŠ¡å’Œåˆ†å¸ƒå¼é”ç­‰åˆ†å¸ƒå¼åŸºç¡€æœåŠ¡ã€‚ 

    ZooKeeperçš„æ•°æ®æ¨¡å‹æ˜¯å†…å­˜ä¸­çš„ä¸€ä¸ªZNodeæ•°ï¼Œç”±æ–œæ (/)è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ªZNodeï¼Œæ¯ä¸ªZNodeä¸Šé™¤äº†ä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼Œè¿˜ä¿å­˜ä¸€ç³»åˆ—å±æ€§ä¿¡æ¯ã€‚

    ZooKeeperä¸­çš„æ•°æ®èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ï¼šæŒä¹…èŠ‚ç‚¹å’Œä¸´æ—¶èŠ‚ç‚¹ã€‚æ‰€è°“çš„æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦è¿™ä¸ªZNodeåˆ›å»ºæˆåŠŸï¼Œé™¤éä¸»åŠ¨è¿›è¡ŒZNodeçš„ç§»é™¤æ“ä½œï¼ŒèŠ‚ç‚¹ä¼šä¸€ç›´ä¿å­˜åœ¨ZooKeeperä¸Šï¼›è€Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿå®¢æˆ·ç«¯çš„ï¼ˆSessionï¼‰ä¼šè¯ç›¸å…³è”çš„ï¼Œä¸€æ—¦å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œè¿™ä¸ªä¼šè¯ä¸Šçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹éƒ½ä¼šè¢«è‡ªåŠ¨ç§»é™¤ã€‚
</code></pre>
<p><strong>å…·ä½“æ€è·¯ï¼š</strong></p>
<p>1ã€é¦–å…ˆzookeeperä¸­æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª&#x2F;distributed_lockæŒä¹…åŒ–èŠ‚ç‚¹<br>2ã€ç„¶åå†åœ¨&#x2F;distributed_lockèŠ‚ç‚¹ä¸‹åˆ›å»ºè‡ªå·±çš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œæ¯”å¦‚ï¼š&#x2F;distributed_lock&#x2F;task_00000000008<br>3ã€è·å–æ‰€æœ‰çš„&#x2F;distributed_lockä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¹¶æ’åº<br>4ã€åˆ¤è¯»è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æœ€å°å€¼ï¼ˆç¬¬ä¸€ä½ï¼‰<br>5ã€å¦‚æœæ˜¯ï¼Œåˆ™è·å–å¾—åˆ°é”ï¼Œæ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ€ååˆ é™¤è¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹ã€‚<br>6ã€å¦‚æœä¸æ˜¯æœ€å°å€¼ï¼Œåˆ™éœ€è¦ç›‘å¬è‡ªå·±åˆ›å»ºèŠ‚ç‚¹å‰ä¸€ä½èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–ï¼Œå¹¶é˜»å¡ã€‚<br>7ã€å½“å‰ä¸€ä½èŠ‚ç‚¹è¢«åˆ é™¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é€’å½’æ¥åˆ¤æ–­è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦åœ¨æ˜¯æœ€å°çš„ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œ5ï¼‰ï¼›å¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œ6ï¼‰ï¼ˆå°±æ˜¯é€’å½’å¾ªç¯çš„åˆ¤æ–­ï¼‰</p>
<h3 id="ä¸€ã€å¯¼å…¥ä¾èµ–"><a href="#ä¸€ã€å¯¼å…¥ä¾èµ–" class="headerlink" title="ä¸€ã€å¯¼å…¥ä¾èµ–"></a>ä¸€ã€å¯¼å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>zk_lock<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦åŒ…æ‹¬äº†zkå®¢æˆ·ç«¯çš„ä¾èµ–ï¼Œmybatis-plusçš„ä¾èµ–ã€‚</p>
<h3 id="äºŒã€æ•°æ®çš„é…ç½®"><a href="#äºŒã€æ•°æ®çš„é…ç½®" class="headerlink" title="äºŒã€æ•°æ®çš„é…ç½®"></a>äºŒã€æ•°æ®çš„é…ç½®</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®åº“</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/db3?characterEncoding=utf8&amp;verifyServerCertificate=false&amp;useSSL=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¸‰ã€å…·ä½“ä»£ç å®ç°"><a href="#ä¸‰ã€å…·ä½“ä»£ç å®ç°" class="headerlink" title="ä¸‰ã€å…·ä½“ä»£ç å®ç°"></a>ä¸‰ã€å…·ä½“ä»£ç å®ç°</h3><p>åˆ†å¸ƒå¼é”å·¥å…·ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zk_lock.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.IZkDataListener;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.ZkClient;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.ZkConnection;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.zkclient.exception.ZkNodeExistsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¸¸é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONNECTION_STRING</span> <span class="operator">=</span> <span class="string">&quot;localhost:2181&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_NODE</span> <span class="operator">=</span> <span class="string">&quot;/distributed_lock&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHILDREN_NODE</span> <span class="operator">=</span> <span class="string">&quot;/lock_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DistributedLockUtil distributedLockUtil;</span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> ZkClient zkClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºzkClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLockUtil</span><span class="params">()</span> &#123;</span><br><span class="line">        distributedLockUtil = <span class="built_in">this</span>;</span><br><span class="line">        <span class="comment">// è¿æ¥åˆ°Zookeeper</span></span><br><span class="line">        zkClient = <span class="keyword">new</span> <span class="title class_">ZkClient</span>(<span class="keyword">new</span> <span class="title class_">ZkConnection</span>(CONNECTION_STRING));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(LOCK_NODE)) &#123;</span><br><span class="line">            zkClient.create(LOCK_NODE, <span class="string">&quot;åˆ†å¸ƒå¼é”èŠ‚ç‚¹&quot;</span>, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é”åå­—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.åœ¨ZookeeperæŒ‡å®šèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">lockName</span> <span class="operator">=</span> zkClient.createEphemeralSequential(LOCK_NODE + CHILDREN_NODE, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">            acquireLock(lockName);</span><br><span class="line">            <span class="keyword">return</span> lockName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">acquireLock</span><span class="params">(String lockName)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 2.è·å–lockèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</span></span><br><span class="line">        List&lt;String&gt; childrenList = zkClient.getChildren(LOCK_NODE);</span><br><span class="line">        <span class="comment">// 3.å¯¹å­èŠ‚ç‚¹è¿›è¡Œæ’åº,è·å–æœ€å°å€¼</span></span><br><span class="line">        childrenList.sort(<span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(String o1, String o2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Integer.parseInt(o1.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]) - Integer.parseInt(o2.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦åœ¨ç¬¬ä¸€ä½</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lockPosition</span> <span class="operator">=</span> childrenList.indexOf(lockName.split(<span class="string">&quot;/&quot;</span>)[lockName.split(<span class="string">&quot;/&quot;</span>).length - <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (lockPosition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZkNodeExistsException</span>(<span class="string">&quot;ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼š&quot;</span> + lockName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lockPosition == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åˆ°é”</span></span><br><span class="line">            log.info(<span class="string">&quot;è·å–åˆ°é”ï¼š&quot;</span> + lockName);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœªè·å–åˆ°é”ï¼Œé˜»å¡</span></span><br><span class="line">        log.info(<span class="string">&quot;...... æœªè·å–åˆ°é”ï¼Œé˜»å¡ç­‰å¾… ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">        <span class="comment">// 5.å¦‚æœæœªè·å–å¾—åˆ°é”,ç›‘å¬å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹å‰ä¸€ä½çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">IZkDataListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IZkDataListener</span>() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å½“è¢«åˆ é™¤æ—¶çš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> dataPath èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span> Exception å¼‚å¸¸</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDataDeleted</span><span class="params">(String dataPath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 6.å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤,å½“ä¸ä¿è¯è½®åˆ°è‡ªå·±</span></span><br><span class="line">                log.info(<span class="string">&quot;ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤  ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">                acquireLock(lockName);</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDataChange</span><span class="params">(String dataPath, Object data)</span> &#123;</span><br><span class="line">                <span class="comment">//èŠ‚ç‚¹è¢«æ”¹å˜</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            zkClient.subscribeDataChanges(LOCK_NODE + <span class="string">&quot;/&quot;</span> + childrenList.get(lockPosition - <span class="number">1</span>), listener);</span><br><span class="line">            <span class="comment">//é˜»å¡</span></span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;ã€‚ã€‚ã€‚ã€‚ã€‚å–æ¶ˆè®¢é˜…ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">            <span class="comment">//å–æ¶ˆç›‘å¬</span></span><br><span class="line">            zkClient.unsubscribeDataChanges(LOCK_NODE + <span class="string">&quot;/&quot;</span> + childrenList.get(lockPosition - <span class="number">1</span>), listener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”ï¼ˆåˆ é™¤èŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockName é”åå­—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">releaseLock</span><span class="params">(String lockName)</span> &#123;</span><br><span class="line">        zkClient.delete(lockName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeZkClient</span><span class="params">()</span> &#123;</span><br><span class="line">        zkClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>å…·ä½“ä¸šåŠ¡å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº“å­˜é€’å‡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id  id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">killGoods</span><span class="params">(Long id, Integer num)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">lock</span> <span class="operator">=</span> DistributedLockUtil.getLock();</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(lock)) &#123;</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">            <span class="keyword">if</span> (goods.getQuantity() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//åº“å­˜æ•°é‡ä¸è¶³,é‡Šæ”¾é”</span></span><br><span class="line">                DistributedLockUtil.releaseLock(lock);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;åº“å­˜æ•°é‡======&quot;</span> + goods.getQuantity());</span><br><span class="line">            <span class="comment">//å°†åº“å­˜å‡æ“ä½œ</span></span><br><span class="line">            goods.setQuantity(goods.getQuantity() - <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">this</span>.updateById(goods);</span><br><span class="line">            DistributedLockUtil.releaseLock(lock);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">**</span><br><span class="line"> * <span class="meta">@author</span> wenlinshan</span><br><span class="line"> * <span class="meta">@version</span> <span class="number">1.0</span></span><br><span class="line"> * <span class="meta">@date</span> <span class="number">2021</span>/<span class="number">6</span>/<span class="number">16</span> <span class="number">11</span>:<span class="number">06</span></span><br><span class="line"> * <span class="meta">@desc</span></span><br><span class="line"> */</span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOrderTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!goodsService.killGoods(<span class="number">1405065181720055809L</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;åˆ›å»ºè®¢å•æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;close&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">closeZk</span><span class="params">()</span>&#123;</span><br><span class="line">        DistributedLockUtil.closeZkClient();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å…³é—­æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼é”çš„demoå·²ç»å®ç°ã€‚<br>é™¤æ­¤ä¹‹å¤–å¯ä»¥ä½¿ç”¨ç°æˆçš„æ¡†æ¶curatoræ¥ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼é”</category>
      </categories>
  </entry>
  <entry>
    <title>åˆ†äº«ä¸€ç¯‡æ–‡ç« -ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³•</title>
    <url>/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/</url>
    <content><![CDATA[<h1 id="ç¥å¥‡çš„-SQL-ä¹‹åˆ«æ ·çš„å†™æ³•-â†’-è¡Œè¡Œæ¯”è¾ƒ"><a href="#ç¥å¥‡çš„-SQL-ä¹‹åˆ«æ ·çš„å†™æ³•-â†’-è¡Œè¡Œæ¯”è¾ƒ" class="headerlink" title="ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³• â†’ è¡Œè¡Œæ¯”è¾ƒ"></a>ç¥å¥‡çš„ SQL ä¹‹åˆ«æ ·çš„å†™æ³• â†’ è¡Œè¡Œæ¯”è¾ƒ</h1><p>â€‹																							æœ¬æ–‡é“¾æ¥ï¼šcnblogs.com&#x2F;youzhibing&#x2F;p&#x2F;15101096.html</p>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>ã€€ã€€æ•°æ®åº“ç‰ˆæœ¬ï¼š MySQL 5.7.20-log </p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812093924974-1727100840-5f29462b905c4e689c2edaa5e5fd8656.png" alt="747662202108120939249741727100840.png"><br>ã€€ã€€å»ºè¡¨ SQL</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812101129712-1532849175-bbdd23d16de14dbcad4767d644ec77dd.png"><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `t_ware_sale_statistics`;</span><br><span class="line">CREATE TABLE `t_ware_sale_statistics` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®id&#x27;,</span><br><span class="line">  `business_id` bigint(20) NOT NULL COMMENT &#x27;ä¸šåŠ¡æœºæ„ç¼–ç &#x27;,</span><br><span class="line">  `ware_inside_code` bigint(20) NOT NULL COMMENT &#x27;å•†å“è‡ªç¼–ç &#x27;,</span><br><span class="line">  `weight_sale_cnt_day` double(16,4) DEFAULT NULL COMMENT &#x27;å¹³å‡æ—¥é”€é‡&#x27;,</span><br><span class="line">  `last_thirty_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘30å¤©é”€é‡&#x27;,</span><br><span class="line">  `last_sixty_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘60å¤©é”€é‡&#x27;,</span><br><span class="line">  `last_ninety_days_sales` double(16,4) DEFAULT NULL COMMENT &#x27;æœ€è¿‘90å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_thirty` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ30å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_sixty` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ60å¤©é”€é‡&#x27;,</span><br><span class="line">  `same_period_sale_qty_ninety` double(16,4) DEFAULT NULL COMMENT &#x27;å»å¹´åŒæœŸ90å¤©é”€é‡&#x27;,</span><br><span class="line">  `create_user` bigint(20) DEFAULT NULL COMMENT &#x27;åˆ›å»ºäºº&#x27;,</span><br><span class="line">  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">  `modify_user` bigint(20) DEFAULT NULL COMMENT &#x27;æœ€ç»ˆä¿®æ”¹äºº&#x27;,</span><br><span class="line">  `modify_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;æœ€ç»ˆä¿®æ”¹æ—¶é—´&#x27;,</span><br><span class="line">  `is_delete` tinyint(2) DEFAULT &#x27;2&#x27; COMMENT &#x27;æ˜¯å¦åˆ é™¤ï¼Œ1ï¼šæ˜¯ï¼Œ2ï¼šå¦&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  KEY `idx_business_ware` (`business_id`,`ware_inside_code`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT=&#x27;å•†å“é”€å”®ç»Ÿè®¡&#x27;;</span><br></pre></td></tr></table></figure>

<p>ã€€ã€€åˆå§‹åŒ–æ•°æ®</p>
<p>ã€€ã€€ã€€ã€€å‡†å¤‡äº† 769063 æ¡æ•°æ®</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/747662-20210812101326865-671080270-b45b9d3614094235ac973bbccbb533ff.png" alt="74766220210812101326865671080270.png"></p>
<h2 id="éœ€æ±‚èƒŒæ™¯"><a href="#éœ€æ±‚èƒŒæ™¯" class="headerlink" title="éœ€æ±‚èƒŒæ™¯"></a>éœ€æ±‚èƒŒæ™¯</h2><p>ã€€ã€€ä¸šåŠ¡æœºæ„ä¸‹é”€å”®å•†å“ï¼ŒåŒä¸ªä¸šåŠ¡æœºæ„å¯ä»¥é”€å”®ä¸åŒçš„å•†å“ï¼ŒåŒä¸ªå•†å“å¯ä»¥åœ¨ä¸åŒçš„ä¸šåŠ¡æœºæ„é”€å”®ï¼Œä¹Ÿå°±è¯´ï¼šä¸šåŠ¡æœºæ„ä¸å•†å“æ˜¯å¤šå¯¹å¤šçš„å…³ç³»</p>
<p>ã€€ã€€å‡è®¾ç°åœ¨æœ‰ n ä¸ªæœºæ„ï¼Œæ¯ä¸ªæœºæ„ä¸‹æœ‰å‡ ä¸ªå•†å“ï¼Œå¦‚ä½•æŸ¥è¯¢å‡ºè¿™å‡ ä¸ªé—¨åº—ä¸‹å„è‡ªå•†å“çš„é”€å”®æƒ…å†µï¼Ÿ</p>
<p>ã€€ã€€å…·ä½“ç‚¹ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-54d46ffcf96a41b1b031a9bbb6cb048f.png" alt="image.png"></p>
<p>ã€€ã€€å¦‚ä½•æŸ¥å‡º 100001 ä¸‹å•†å“ 1000ã€1001ã€1003 ã€ 100002 ä¸‹å•†å“ 1003ã€1004 ã€ 100003 ä¸‹å•†å“ 1006ã€1008ã€1009 çš„é”€å”®æƒ…å†µ</p>
<p>ã€€ã€€ç›¸å½“äºæ˜¯åŒå±‚åˆ—è¡¨ï¼ˆä¸šåŠ¡æœºæ„åˆ—è¡¨ä¸­å¥—å•†å“åˆ—è¡¨ï¼‰çš„æŸ¥è¯¢ï¼›ä¸šåŠ¡æœºæ„åˆ—è¡¨å’Œå•†å“åˆ—è¡¨éƒ½ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯åŠ¨æ€çš„</p>
<p>ã€€ã€€é‚£ä¹ˆé—®é¢˜å°±æ˜¯ï¼šå¦‚ä½•æŸ¥è¯¢å¤šä¸ªä¸šåŠ¡æœºæ„ä¸‹ï¼ŒæŸäº›å•†å“çš„é”€å”®æƒ…å†µ</p>
<p>ã€€ã€€ï¼ˆé—®é¢˜ç»æˆ‘ä¸€æè¿°ï¼Œå¯èƒ½æ›´æ¨¡ç³Šäº†ï¼Œå¤§å®¶æ˜ç™½æ„æ€äº†å°±å¥½ï¼ï¼‰</p>
<h2 id="å¾ªç¯æŸ¥è¯¢"><a href="#å¾ªç¯æŸ¥è¯¢" class="headerlink" title="å¾ªç¯æŸ¥è¯¢"></a>å¾ªç¯æŸ¥è¯¢</h2><p>ã€€ã€€è¿™ä¸ªå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œåœ¨ä»£ç å±‚é¢å¾ªç¯ä¸šåŠ¡æœºæ„åˆ—è¡¨ï¼Œæ¯ä¸ªä¸šåŠ¡æœºæ„æŸ¥ä¸€æ¬¡æ•°æ®åº“ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-a3ac667739d5455c919bcecd75f15bff.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-074d4491afe3486dac874d8d490430b2.png" alt="image.png"></p>
<p>ã€€ã€€SQL èƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-e5cf8ad05afa4ed5acd18d6e02350666.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œä¸€åˆ‡çœ‹èµ·æ¥ä¼¼ä¹å¾ˆå®Œç¾</p>
<p>ã€€ã€€ç„¶è€Œç°å®æ˜¯ï¼šéƒ¨é—¨å¼€å‘è§„èŒƒçº¦æŸï¼Œä¸èƒ½å¾ªç¯æŸ¥æ•°æ®åº“</p>
<p>ã€€ã€€å“¦è±ï¼Œè¿™ç§æ–¹å¼åªèƒ½æ”¾å¼ƒï¼Œå¦å¯»å…¶ä»–æ–¹å¼äº†</p>
<h2 id="OR-æ‹¼æ¥"><a href="#OR-æ‹¼æ¥" class="headerlink" title="OR æ‹¼æ¥"></a>OR æ‹¼æ¥</h2><p>ã€€ã€€é€šè¿‡ MyBatis çš„ åŠ¨æ€ SQL åŠŸèƒ½ï¼Œè¿›è¡Œ SQL æ‹¼æ¥ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-d29c4ea236a44e6090958ca5b928b5fe.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-0e12a2c6179a4d86b207cae587539247.png" alt="image.png"></p>
<p>ã€€ã€€SQL ä¹Ÿèƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-8d7ba0be6aba4adaa40b03c8d0c9de94.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œè²Œä¼¼å¯è¡Œ</p>
<p>ã€€ã€€å”¯ä¸€å¯æƒœçš„æ˜¯ï¼šæœ‰ç‚¹è´¹ ORï¼Œå¦‚æœä¸šåŠ¡æœºæ„æ¯”è¾ƒå¤šï¼Œé‚£ SQL ä¼šæ¯”è¾ƒé•¿</p>
<p>ã€€ã€€ä½œä¸ºå€™é€‰äººä¹‹ä¸€å§ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹</p>
<h2 id="æ··æŸ¥è¿‡æ»¤"><a href="#æ··æŸ¥è¿‡æ»¤" class="headerlink" title="æ··æŸ¥è¿‡æ»¤"></a>æ··æŸ¥è¿‡æ»¤</h2><p>ã€€ã€€åŒæ ·æ˜¯åˆ©ç”¨ Mybatis çš„ åŠ¨æ€ SQL ï¼Œå°† business_id åˆ—è¡¨æ‹¼åœ¨ä¸€èµ·ã€ ware_inside_code æ‹¼åœ¨ä¸€èµ·ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-bf46b637269849438a7714ea7b551442.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-328446ff1a134354ae9468bfe122402a.png" alt="image.png"></p>
<p>ã€€ã€€SQL ä¹Ÿèƒ½èµ°ç´¢å¼•<br><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-bee2180d1e54452a9f83faa314693d72.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼Œä¹Ÿå¥½ç†è§£ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œä¼¼ä¹å¯è¡Œ</p>
<p>ã€€ã€€ä½†æ˜¯ï¼šæŸ¥å‡ºæ¥çš„ç»“æœé›†å¤§äºç­‰äºæˆ‘ä»¬æƒ³è¦çš„ç»“æœé›†ï¼Œä½ å“ï¼Œä½ ç»†å“ï¼</p>
<p>ã€€ã€€æ‰€ä»¥è¿˜éœ€è¦å¯¹æŸ¥å‡ºæ¥çš„ç»“æœé›†è¿›è¡Œä¸€æ¬¡è¿‡æ»¤ï¼Œè¿‡æ»¤å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœé›†</p>
<p>ã€€ã€€å§‘ä¸”ä¹Ÿä½œä¸ºå€™é€‰äººä¹‹ä¸€å§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹</p>
<h2 id="è¡Œè¡Œæ¯”è¾ƒ"><a href="#è¡Œè¡Œæ¯”è¾ƒ" class="headerlink" title="è¡Œè¡Œæ¯”è¾ƒ"></a>è¡Œè¡Œæ¯”è¾ƒ</h2><p>ã€€ã€€SQL-92 ä¸­åŠ å…¥äº†è¡Œä¸è¡Œæ¯”è¾ƒçš„åŠŸèƒ½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ¯”è¾ƒè°“è¯ &#x3D; ã€&lt; ã€&gt; å’Œ IN è°“è¯çš„å‚æ•°å°±ä¸å†åªæ˜¯æ ‡é‡å€¼äº†ï¼Œè¿˜å¯ä»¥æ˜¯å€¼åˆ—è¡¨äº†</p>
<p>ã€€ã€€å½“ç„¶ï¼Œè¿˜æ˜¯å¾—ç”¨åˆ° Mybatis çš„ åŠ¨æ€ SQL ï¼Œç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-3ed941854ff448a2afca75acfb7201cf.png" alt="image.png"></p>
<p>ã€€ã€€å…·ä½“çš„ SQL ç±»ä¼¼å¦‚ä¸‹</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-e9794c1ebbf44fb3a3034de018e80e98.png" alt="image.png"></p>
<p>ã€€ã€€SQL åŒæ ·èƒ½èµ°ç´¢å¼•</p>
<p><img src="/2021/08/31/%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0-%E7%A5%9E%E5%A5%87%E7%9A%84%20SQL%20%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95-%E7%A5%9E%E5%A5%87%E7%9A%84sql%E4%B9%8B%E5%88%AB%E6%A0%B7%E7%9A%84%E5%86%99%E6%B3%95md/image-793ecb0c293c4bfabef1401a36589a15.png" alt="image.png"></p>
<p>ã€€ã€€å®ç°ç®€å•ï¼ŒSQL ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Œè€Œä¸”åªæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œæ„Ÿè§‰å¯è¡Œ</p>
<p>ã€€ã€€åªæ˜¯ï¼šæœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬å¹³æ—¶è¿™ä¹ˆç”¨çš„å°‘ï¼Œæ‰€ä»¥è¿™ç§å†™æ³•çœ‹èµ·æ¥å¾ˆé™Œç”Ÿ</p>
<p>ã€€ã€€å¦å¤–ï¼Œè¡Œè¡Œæ¯”è¾ƒæ˜¯ SQL è§„èŒƒï¼Œä¸æ˜¯æŸä¸ªå…³ç³»å‹æ•°æ®åº“çš„è§„èŒƒï¼Œä¹Ÿå°±è¯´å…³ç³»å‹æ•°æ®åº“éƒ½åº”è¯¥æ”¯æŒè¿™ç§å†™æ³•</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ã€€ã€€1ã€æœ€åé€‰æ‹©äº† è¡Œè¡Œæ¯”è¾ƒ è¿™ç§æ–¹å¼æ¥å®ç°äº†éœ€æ±‚</p>
<p>ã€€ã€€ã€€ã€€åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œé—®å°±æ˜¯é€¼æ ¼é«˜ï¼</p>
<p>ã€€ã€€2ã€æŸä¸€ä¸ªéœ€æ±‚çš„å®ç°å¾€å¾€æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆä¸šåŠ¡ä»¥åŠå„ç§çº¦æŸç»¼åˆè€ƒè™‘ï¼Œé€‰æ‹©æœ€åˆé€‚çš„é‚£ä¸ª</p>
<p>ã€€ã€€3ã€è¡Œè¡Œæ¯”è¾ƒæ˜¯ SQL-92 ä¸­å¼•å…¥çš„ï¼ŒSQL-92 æ˜¯ 1992 å¹´åˆ¶å®šçš„è§„èŒƒ</p>
<p>ã€€ã€€ã€€ã€€è¡Œè¡Œæ¯”è¾ƒä¸æ˜¯æ–°ç‰¹æ€§ï¼Œè€Œæ˜¯å¾ˆæ—©å°±å­˜åœ¨çš„åŸºç¡€åŠŸèƒ½</p>
]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£Redis</title>
    <url>/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/</url>
    <content><![CDATA[<h2 id="ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€redisçš„åŸºæœ¬æ¦‚å¿µ</h2><p>redisæ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“</p>
<h3 id="1ã€NOSQL"><a href="#1ã€NOSQL" class="headerlink" title="1ã€NOSQL"></a>1ã€NOSQL</h3><p>å³ Not-Only SQLï¼ˆ æ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼‰ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å……ã€‚</p>
<h3 id="2ã€ä¸»è¦ä½œç”¨"><a href="#2ã€ä¸»è¦ä½œç”¨" class="headerlink" title="2ã€ä¸»è¦ä½œç”¨"></a>2ã€ä¸»è¦ä½œç”¨</h3><p>ï¼ˆ1ï¼‰ä¸ºçƒ­ç‚¹æ•°æ®åŠ é€ŸæŸ¥è¯¢ï¼ˆä¸»è¦åœºæ™¯ï¼‰ã€‚å¦‚çƒ­ç‚¹å•†å“ã€çƒ­ç‚¹æ–°é—»ã€çƒ­ç‚¹èµ„è®¯ã€æ¨å¹¿ç±»ç­‰é«˜è®¿é—®é‡ä¿¡æ¯ç­‰ã€‚</p>
<p>ï¼ˆ2ï¼‰å³æ—¶ä¿¡æ¯æŸ¥è¯¢ã€‚å¦‚å„ä½æ’è¡Œæ¦œã€å„ç±»ç½‘ç«™è®¿é—®ç»Ÿè®¡ã€å…¬äº¤åˆ°ç«™ä¿¡æ¯ã€åœ¨çº¿äººæ•°ä¿¡æ¯ï¼ˆèŠå¤©å®¤ã€ç½‘ç«™ï¼‰ã€è®¾å¤‡ä¿¡å·ç­‰ã€‚</p>
<p>ï¼ˆ3ï¼‰æ—¶æ•ˆæ€§ä¿¡æ¯æ§åˆ¶ã€‚å¦‚éªŒè¯ç æ§åˆ¶ã€æŠ•ç¥¨æ§åˆ¶ç­‰ã€‚</p>
<p>ï¼ˆ4ï¼‰åˆ†å¸ƒå¼æ•°æ®å…±äº«ã€‚å¦‚åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸­çš„ session åˆ†ç¦»æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<h2 id="äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰"><a href="#äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰" class="headerlink" title="äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰"></a>äºŒã€redisåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆvalueçš„æ•°æ®ç±»å‹ï¼‰</h2><h3 id="1ã€String"><a href="#1ã€String" class="headerlink" title="1ã€String"></a>1ã€String</h3><p>ä»¥key-valueçš„æ–¹å¼è¿›è¡Œå­˜å‚¨</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-5efbb45995f141b9a9c3762d8e0f9b2a.png" alt="image.png"></p>
<h3 id="2ã€hash"><a href="#2ã€hash" class="headerlink" title="2ã€hash"></a>2ã€hash</h3><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-4c9f503efbe2476b9e2d56d7b7c105bc.png" alt="image.png"></p>
<h3 id="3ã€list"><a href="#3ã€list" class="headerlink" title="3ã€list"></a>3ã€list</h3><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-f7bd516f28f540158964f23626beef7e.png" alt="image.png"></p>
<h3 id="4ã€set"><a href="#4ã€set" class="headerlink" title="4ã€set"></a>4ã€set</h3><p>setç±»å‹ï¼šä¸hashå­˜å‚¨ç»“æ„å®Œå…¨ç›¸åŒï¼Œä»…å­˜å‚¨é”®ï¼Œä¸å­˜å‚¨å€¼ï¼ˆnilï¼‰ï¼Œå¹¶ä¸”å€¼æ˜¯ä¸å…è®¸é‡å¤çš„</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-026d5d4a5ea64ee7bdc5ef3d3fdaed9b.png" alt="image.png"><br><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-122cdbd1b2304d2792c20b26d418f633.png" alt="image.png"></p>
<h3 id="5ã€zset"><a href="#5ã€zset" class="headerlink" title="5ã€zset"></a>5ã€zset</h3><h2 id="ä¸‰ã€Jedis"><a href="#ä¸‰ã€Jedis" class="headerlink" title="ä¸‰ã€Jedis"></a>ä¸‰ã€Jedis</h2><p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-ed7ac2231b2a4fad9073ee67a62d09fe.png" alt="image.png"></p>
<h3 id="1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥"><a href="#1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥" class="headerlink" title="1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥"></a>1ã€åŸºäºè¿æ¥æ± çš„è¿æ¥</h3><p>JedisPoolï¼šJedisæä¾›çš„è¿æ¥æ± æŠ€æœ¯ </p>
<p>poolConfig:è¿æ¥æ± é…ç½®å¯¹è±¡ </p>
<p>host:redisæœåŠ¡åœ°å€</p>
<p>port:redisæœåŠ¡ç«¯å£å·</p>
<p>åˆ›å»ºjedisçš„é…ç½®æ–‡ä»¶ï¼šjedis.properties</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jedis.host=192.168.40.130  </span><br><span class="line">jedis.port=6379  </span><br><span class="line">jedis.maxTotal=50  </span><br><span class="line">jedis.maxIdle=10</span><br></pre></td></tr></table></figure>

<p> åˆ›å»ºJedisUtilsï¼Œä½¿ç”¨é™æ€ä»£ç å—åˆå§‹åŒ–èµ„æº</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class JedisUtils &#123;</span><br><span class="line">    private static int maxTotal;</span><br><span class="line">    private static int maxIdel;</span><br><span class="line">    private static String host;</span><br><span class="line">    private static int port;</span><br><span class="line">    private static JedisPoolConfig jpc;</span><br><span class="line">    private static JedisPool jp;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        ResourceBundle bundle = ResourceBundle.getBundle(&quot;redis&quot;);</span><br><span class="line">        maxTotal = Integer.parseInt(bundle.getString(&quot;redis.maxTotal&quot;));</span><br><span class="line">        maxIdel = Integer.parseInt(bundle.getString(&quot;redis.maxIdel&quot;));</span><br><span class="line">        host = bundle.getString(&quot;redis.host&quot;);</span><br><span class="line">        port = Integer.parseInt(bundle.getString(&quot;redis.port&quot;));</span><br><span class="line">        //Jedisè¿æ¥æ± é…ç½®</span><br><span class="line">        jpc = new JedisPoolConfig();</span><br><span class="line">        jpc.setMaxTotal(maxTotal);</span><br><span class="line">        jpc.setMaxIdle(maxIdel);</span><br><span class="line">        jp = new JedisPool(jpc,host,port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> å¯¹å¤–è®¿é—®æ¥å£ï¼Œæä¾›jedisè¿æ¥å¯¹è±¡ï¼Œè¿æ¥ä»è¿æ¥æ± è·å–ï¼Œåœ¨JedisUtilsä¸­æ·»åŠ ä¸€ä¸ªè·å–jedisçš„æ–¹æ³•ï¼šgetJedis</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static Jedis getJedis()&#123;</span><br><span class="line">	Jedis jedis = jedisPool.getResource();</span><br><span class="line">	return jedis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥"><a href="#å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥" class="headerlink" title="å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥"></a>å››ã€æ•°æ®åˆ é™¤æ·˜æ±°ç­–ç•¥</h2><h3 id="1ã€å®šæ—¶åˆ é™¤"><a href="#1ã€å®šæ—¶åˆ é™¤" class="headerlink" title="1ã€å®šæ—¶åˆ é™¤"></a>1ã€å®šæ—¶åˆ é™¤</h3><p>åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“keyè®¾ç½®æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸”è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±å®šæ—¶å™¨ä»»åŠ¡ç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ</p>
<ul>
<li><p><strong>ä¼˜ç‚¹</strong>ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨</p>
</li>
<li><p><strong>ç¼ºç‚¹</strong>ï¼šCPUå‹åŠ›å¾ˆå¤§ï¼Œæ— è®ºCPUæ­¤æ—¶è´Ÿè½½é‡å¤šé«˜ï¼Œå‡å ç”¨CPUï¼Œä¼šå½±å“redisæœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰</p>
</li>
</ul>
<h3 id="2ã€æƒ°æ€§åˆ é™¤"><a href="#2ã€æƒ°æ€§åˆ é™¤" class="headerlink" title="2ã€æƒ°æ€§åˆ é™¤"></a>2ã€æƒ°æ€§åˆ é™¤</h3><p>æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ï¼Œä¸åšå¤„ç†ã€‚ç­‰ä¸‹æ¬¡è®¿é—®è¯¥æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­</p>
<ol>
<li>å¦‚æœæœªè¿‡æœŸï¼Œè¿”å›æ•°æ®</li>
<li>å‘ç°å·²è¿‡æœŸï¼Œåˆ é™¤ï¼Œè¿”å›ä¸å­˜åœ¨</li>
</ol>
<ul>
<li><p><strong>ä¼˜ç‚¹</strong>ï¼šèŠ‚çº¦CPUæ€§èƒ½ï¼Œå‘ç°å¿…é¡»åˆ é™¤çš„æ—¶å€™æ‰åˆ é™¤</p>
</li>
<li><p><strong>ç¼ºç‚¹</strong>ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿ç©ºé—´æ¢æ—¶é—´ï¼‰</p>
</li>
</ul>
<h3 id="3ã€å®šæœŸåˆ é™¤"><a href="#3ã€å®šæœŸåˆ é™¤" class="headerlink" title="3ã€å®šæœŸåˆ é™¤"></a>3ã€å®šæœŸåˆ é™¤</h3><ul>
<li><p>Rediså¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½®server.hzçš„å€¼ï¼Œé»˜è®¤ä¸º10</p>
</li>
<li><p>æ¯ç§’é’Ÿæ‰§è¡Œserver.hzæ¬¡<strong>serverCron()</strong>â€”â€”â€“&gt;<strong>databasesCron()</strong>â€”â€”â€”&gt;<strong>activeExpireCycle()</strong></p>
</li>
<li><p>**activeExpireCycle()*<em>å¯¹æ¯ä¸ªexpires[</em>]é€ä¸€è¿›è¡Œæ£€æµ‹ï¼Œæ¯æ¬¡æ‰§è¡Œè€—æ—¶ï¼š250ms&#x2F;server.hz</p>
</li>
<li><p>å¯¹æŸä¸ªexpires[*]æ£€æµ‹æ—¶ï¼ŒéšæœºæŒ‘é€‰Wä¸ªkeyæ£€æµ‹</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å¦‚æœkeyè¶…æ—¶ï¼Œåˆ é™¤key</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡&gt;W*25%ï¼Œå¾ªç¯è¯¥è¿‡ç¨‹</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸€è½®ä¸­åˆ é™¤çš„keyçš„æ•°é‡â‰¤W*25%ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªexpires[*]ï¼Œ0-15å¾ªç¯</span><br><span class="line"></span><br><span class="line">Wå–å€¼=ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOPå±æ€§å€¼</span><br></pre></td></tr></table></figure>

<ul>
<li>å‚æ•°current_dbç”¨äºè®°å½•<strong>activeExpireCycle()</strong> è¿›å…¥å“ªä¸ªexpires[*] æ‰§è¡Œ</li>
<li>å¦‚æœactiveExpireCycle()æ‰§è¡Œæ—¶é—´åˆ°æœŸï¼Œä¸‹æ¬¡ä»current_dbç»§ç»­å‘ä¸‹æ‰§è¡Œ</li>
</ul>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-eaaeab2df1fa4b34a80b616ccf0e1250.png" alt="image.png"></p>
<p>æ€»çš„æ¥è¯´ï¼šå®šæœŸåˆ é™¤å°±æ˜¯å‘¨æœŸæ€§è½®è¯¢redisåº“ä¸­çš„æ—¶æ•ˆæ€§æ•°æ®ï¼Œé‡‡ç”¨éšæœºæŠ½å–çš„ç­–ç•¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦</p>
<ul>
<li><p><strong>ç‰¹ç‚¹1</strong>ï¼šCPUæ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½®</p>
</li>
<li><p><strong>ç‰¹ç‚¹2</strong>ï¼šå†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†</p>
</li>
<li><p><strong>æ€»ç»“</strong>ï¼šå‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰</p>
</li>
</ul>
<h3 id="4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰"><a href="#4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰" class="headerlink" title="4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰"></a>4ã€æ•°æ®æ·˜æ±°ç­–ç•¥ï¼ˆé€å‡ºç®—æ³•ï¼‰</h3><p>å½“æ–°æ•°æ®è¿›å…¥redisæ—¶ï¼Œå¦‚æœå†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨<strong>freeMemoryIfNeeded()<strong>æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–° åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼Œredisè¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ã€‚æ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸ºé€å‡ºç®—æ³•ã€‚</strong>ï¼ˆ3ç±»8ç§ï¼‰</strong></p>
<p><strong>ç¬¬ä¸€ç±»</strong>ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›†server.db[i].expires ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">volatile-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-lfuï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-ttlï¼šæŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</span><br><span class="line">volatile-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</span><br></pre></td></tr></table></figure>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-9d92b3d0047f4e65b66bdfce123d13bd.png" alt="image.png"></p>
<p><strong>ç¬¬äºŒç±»</strong>ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›†server.db[i].dict ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">allkeys-lruï¼šæŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span><br><span class="line">allkeLyRs-lfuï¼šï¼šæŒ‘é€‰æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span><br><span class="line">allkeys-randomï¼šä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰ç±»</strong>ï¼šæ”¾å¼ƒæ•°æ®é©±é€</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">no-envictionï¼ˆé©±é€ï¼‰ï¼šç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory)</span><br></pre></td></tr></table></figure>

<h2 id="äº”ã€redisé›†ç¾¤"><a href="#äº”ã€redisé›†ç¾¤" class="headerlink" title="äº”ã€redisé›†ç¾¤"></a>äº”ã€redisé›†ç¾¤</h2><h3 id="1ã€ä¸»ä»å¤åˆ¶"><a href="#1ã€ä¸»ä»å¤åˆ¶" class="headerlink" title="1ã€ä¸»ä»å¤åˆ¶"></a>1ã€ä¸»ä»å¤åˆ¶</h3><p>å•æœºçš„ redisï¼Œèƒ½å¤Ÿæ‰¿è½½çš„ QPS å¤§æ¦‚å°±åœ¨ä¸Šä¸‡åˆ°å‡ ä¸‡ä¸ç­‰ã€‚å¯¹äºç¼“å­˜æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘<strong>è¯»é«˜å¹¶å‘</strong>çš„ã€‚å› æ­¤æ¶æ„åšæˆä¸»ä»(master-slave)æ¶æ„ï¼Œä¸€ä¸»å¤šä»ï¼Œä¸»è´Ÿè´£å†™ï¼Œå¹¶ä¸”å°†æ•°æ®å¤åˆ¶åˆ°å…¶å®ƒçš„ slave èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»ã€‚æ‰€æœ‰çš„<strong>è¯»è¯·æ±‚å…¨éƒ¨èµ°ä»èŠ‚ç‚¹</strong>ã€‚è¿™æ ·ä¹Ÿå¯ä»¥å¾ˆè½»æ¾å®ç°æ°´å¹³æ‰©å®¹ï¼Œ<strong>æ”¯æ’‘è¯»é«˜å¹¶å‘</strong>ã€‚</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-d313f43c4d2f431196ddec6f20e08972.png" alt="image.png"></p>
<h4 id="1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨"><a href="#1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨" class="headerlink" title="1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>1ï¼‰ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h4><ul>
<li><p>è¯»å†™åˆ†ç¦»ï¼šmasterå†™ã€slaveè¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ›</p>
</li>
<li><p>è´Ÿè½½å‡è¡¡ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”±slaveåˆ†æ‹…masterè´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜slaveçš„æ•° é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜RedisæœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡</p>
</li>
<li><p>æ•…éšœæ¢å¤ï¼šå½“masterå‡ºç°é—®é¢˜æ—¶ï¼Œç”±slaveæä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤</p>
</li>
<li><p>æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</p>
</li>
<li><p>é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç°Redisçš„é«˜å¯ç”¨æ–¹æ¡ˆ</p>
</li>
</ul>
<h4 id="2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹"><a href="#2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹" class="headerlink" title="2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹"></a>2ï¼‰ä¸»ä»å¤åˆ¶å·¥ä½œæµç¨‹</h4><p>ä¸»ä»å¤åˆ¶è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µ</p>
<ul>
<li><p>å»ºç«‹è¿æ¥é˜¶æ®µï¼ˆå³å‡†å¤‡é˜¶æ®µï¼‰</p>
</li>
<li><p>æ•°æ®åŒæ­¥é˜¶æ®µ</p>
</li>
<li><p>å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼ˆåå¤åŒæ­¥ï¼‰<br><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-0b915a6d7314481b9e5f03c7eb6cf48d.png" alt="image.png"></p>
</li>
</ul>
<h5 id="é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥"><a href="#é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥" class="headerlink" title="é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥"></a>é˜¶æ®µä¸€ï¼šå»ºç«‹è¿æ¥</h5><p>å»ºç«‹slaveåˆ°masterçš„è¿æ¥ï¼Œä½¿masterèƒ½å¤Ÿè¯†åˆ«slaveï¼Œå¹¶ä¿å­˜slaveç«¯å£å·</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>æ­¥éª¤1ï¼šè®¾ç½®masterçš„åœ°å€å’Œç«¯å£ï¼Œä¿å­˜masterä¿¡æ¯</p>
</li>
<li><p>æ­¥éª¤2ï¼šå»ºç«‹socketè¿æ¥</p>
</li>
<li><p>æ­¥éª¤3ï¼šå‘é€pingå‘½ä»¤ï¼ˆå®šæ—¶å™¨ä»»åŠ¡ï¼‰</p>
</li>
<li><p>æ­¥éª¤4ï¼šèº«ä»½éªŒè¯</p>
</li>
<li><p>æ­¥éª¤5ï¼šå‘é€slaveç«¯å£ä¿¡æ¯</p>
</li>
</ol>
<p>è‡³æ­¤ï¼Œä¸»ä»è¿æ¥æˆåŠŸï¼</p>
<p>å½“å‰çŠ¶æ€ï¼š</p>
<p>slaveï¼šä¿å­˜masterçš„åœ°å€ä¸ç«¯å£</p>
<p>masterï¼šä¿å­˜slaveçš„ç«¯å£</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-5218299629984afeb49550cb754c4dcc.png" alt="image.png"></p>
<h5 id="é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥"><a href="#é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥" class="headerlink" title="é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥"></a>é˜¶æ®µäºŒï¼šæ•°æ®åŒæ­¥</h5><ul>
<li>åœ¨slaveåˆæ¬¡è¿æ¥masteråï¼Œå¤åˆ¶masterä¸­çš„æ‰€æœ‰æ•°æ®åˆ°slave</li>
<li>å°†slaveçš„æ•°æ®åº“çŠ¶æ€æ›´æ–°æˆmasterå½“å‰çš„æ•°æ®åº“çŠ¶æ€</li>
</ul>
<p>åŒæ­¥è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>æ­¥éª¤1ï¼šè¯·æ±‚åŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤2ï¼šåˆ›å»ºRDBåŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤3ï¼šæ¢å¤RDBåŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤4ï¼šè¯·æ±‚éƒ¨åˆ†åŒæ­¥æ•°æ®</p>
</li>
<li><p>æ­¥éª¤5ï¼šæ¢å¤éƒ¨åˆ†åŒæ­¥æ•°æ®</p>
</li>
</ol>
<p>è‡³æ­¤ï¼Œæ•°æ®åŒæ­¥å·¥ä½œå®Œæˆï¼</p>
<p>å½“å‰çŠ¶æ€ï¼š</p>
<p>slaveï¼šå…·æœ‰masterç«¯å…¨éƒ¨æ•°æ®ï¼ŒåŒ…å«RDBè¿‡ç¨‹æ¥æ”¶çš„æ•°æ®</p>
<p>masterï¼šä¿å­˜slaveå½“å‰æ•°æ®åŒæ­¥çš„ä½ç½®</p>
<p>æ€»ä½“ï¼šä¹‹é—´å®Œæˆäº†æ•°æ®å…‹éš†</p>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-bcd8b524679c43d2b683535ef58192f4.png" alt="image.png"></p>
<p><strong>æ•°æ®åŒæ­¥é˜¶æ®µmasterè¯´æ˜</strong></p>
<p>1ï¼šå¦‚æœmasteræ•°æ®é‡å·¨å¤§ï¼Œæ•°æ®åŒæ­¥é˜¶æ®µåº”é¿å¼€æµé‡é«˜å³°æœŸï¼Œé¿å…é€ æˆmasteré˜»å¡ï¼Œå½±å“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œ</p>
<p>2ï¼šå¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´æ•°æ®æº¢å‡ºã€‚å¦‚è¿›è¡Œå…¨é‡å¤åˆ¶å‘¨æœŸå¤ªé•¿ï¼Œè¿›è¡Œéƒ¨åˆ†å¤åˆ¶æ—¶å‘ç°æ•°æ®å·²ç»å­˜åœ¨ä¸¢å¤±çš„æƒ…å†µï¼Œå¿…é¡»è¿›è¡Œç¬¬äºŒæ¬¡å…¨é‡å¤åˆ¶ï¼Œè‡´ä½¿slaveé™·å…¥æ­»å¾ªç¯çŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">repl-backlog-size ?mb</span><br></pre></td></tr></table></figure>

<ol>
<li>masterå•æœºå†…å­˜å ç”¨ä¸»æœºå†…å­˜çš„æ¯”ä¾‹ä¸åº”è¿‡å¤§ï¼Œå»ºè®®ä½¿ç”¨50%-70%çš„å†…å­˜ï¼Œç•™ä¸‹30%-50%çš„å†…å­˜ç”¨äºæ‰§ è¡Œbgsaveå‘½ä»¤å’Œåˆ›å»ºå¤åˆ¶ç¼“å†²åŒº</li>
</ol>
<p><img src="/2021/08/18/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Redis-shen-ru-li-jie-redis/image-f80b80cac8d84ea5a6f1f9c7b5faf1a0.png" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/2396018/1599985757856-9f821705-f68d-4bf4-a7bb-b4db0ce971ab.png" alt="img"></p>
<p><strong>æ•°æ®åŒæ­¥é˜¶æ®µslaveè¯´æ˜</strong></p>
<ol>
<li>ä¸ºé¿å…slaveè¿›è¡Œå…¨é‡å¤åˆ¶ã€éƒ¨åˆ†å¤åˆ¶æ—¶æœåŠ¡å™¨å“åº”é˜»å¡æˆ–æ•°æ®ä¸åŒæ­¥ï¼Œå»ºè®®å…³é—­æ­¤æœŸé—´çš„å¯¹å¤–æœåŠ¡</li>
</ol>
<p>  slave-serve-stale-data yes|no</p>
<ol>
<li><p>æ•°æ®åŒæ­¥é˜¶æ®µï¼Œmasterå‘é€ç»™slaveä¿¡æ¯å¯ä»¥ç†è§£masteræ˜¯slaveçš„ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸»åŠ¨å‘slaveå‘é€å‘½ä»¤</p>
</li>
<li><p>å¤šä¸ªslaveåŒæ—¶å¯¹masterè¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmasterå‘é€çš„RDBæ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œå¦‚æœmasterå¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³°</p>
</li>
<li><p>slaveè¿‡å¤šæ—¶ï¼Œå»ºè®®è°ƒæ•´æ‹“æ‰‘ç»“æ„ï¼Œç”±ä¸€ä¸»å¤šä»ç»“æ„å˜ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œä¸­é—´çš„èŠ‚ç‚¹æ—¢æ˜¯masterï¼Œä¹Ÿæ˜¯ slaveã€‚æ³¨æ„ä½¿ç”¨æ ‘çŠ¶ç»“æ„æ—¶ï¼Œç”±äºå±‚çº§æ·±åº¦ï¼Œå¯¼è‡´æ·±åº¦è¶Šé«˜çš„slaveä¸æœ€é¡¶å±‚masteré—´æ•°æ®åŒæ­¥å»¶è¿Ÿ è¾ƒå¤§ï¼Œæ•°æ®ä¸€è‡´æ€§å˜å·®ï¼Œåº”è°¨æ…é€‰æ‹©</p>
</li>
</ol>
<h5 id="2-2-1-3-é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­"><a href="#2-2-1-3-é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­" class="headerlink" title="2.2.1.3 é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­"></a>2.2.1.3 é˜¶æ®µä¸‰ï¼šå‘½ä»¤ä¼ æ’­</h5><ul>
<li>å½“masteræ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹åï¼Œå¯¼è‡´ä¸»ä»æœåŠ¡å™¨æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ­¤æ—¶éœ€è¦è®©ä¸»ä»æ•°æ®åŒæ­¥åˆ°ä¸€è‡´çš„çŠ¶æ€ï¼ŒåŒæ­¥çš„åŠ¨ä½œç§°ä¸ºå‘½ä»¤ä¼ æ’­</li>
<li>masterå°†æ¥æ”¶åˆ°çš„æ•°æ®å˜æ›´å‘½ä»¤å‘é€ç»™slaveï¼Œslaveæ¥æ”¶å‘½ä»¤åæ‰§è¡Œå‘½ä»¤</li>
</ul>
<p><strong>å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„éƒ¨åˆ†å¤åˆ¶</strong></p>
<p>å‘½ä»¤ä¼ æ’­é˜¶æ®µå‡ºç°äº†æ–­ç½‘ç°è±¡ï¼š</p>
<p>ç½‘ç»œé—ªæ–­é—ªè¿ï¼šå¿½ç•¥</p>
<p>çŸ­æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šéƒ¨åˆ†å¤åˆ¶</p>
<p>é•¿æ—¶é—´ç½‘ç»œä¸­æ–­ï¼šå…¨é‡å¤åˆ¶</p>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹éƒ¨åˆ†å¤åˆ¶ï¼Œéƒ¨åˆ†å¤åˆ¶çš„ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ </p>
<ol>
<li><p>æœåŠ¡å™¨çš„è¿è¡Œ idï¼ˆrun idï¼‰</p>
</li>
<li><p>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</p>
</li>
<li><p>ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</p>
</li>
</ol>
<p><strong>æœåŠ¡å™¨è¿è¡ŒIDï¼ˆrunidï¼‰</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¦‚å¿µï¼šæœåŠ¡å™¨è¿è¡ŒIDæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œidç»„æˆï¼šè¿è¡Œidç”±40ä½å­—ç¬¦ç»„æˆï¼Œæ˜¯ä¸€ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ä¾‹å¦‚ï¼šfdc9ff13b9bbaab28db42b3d50f852bb5e3fcdceä½œç”¨ï¼šè¿è¡Œidè¢«ç”¨äºåœ¨æœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“ï¼Œè¯†åˆ«èº«ä»½å¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œå¿…é¡»æ¯æ¬¡æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œidï¼Œç”¨äºå¯¹æ–¹è¯†åˆ«å®ç°æ–¹å¼ï¼šè¿è¡Œidåœ¨æ¯å°æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œmasteråœ¨é¦–æ¬¡è¿æ¥slaveæ—¶ï¼Œä¼šå°†è‡ªå·±çš„è¿è¡ŒIDå‘é€ç»™slaveï¼Œslaveä¿å­˜æ­¤IDï¼Œé€šè¿‡info Serverå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„runid</span><br></pre></td></tr></table></figure>

<p><strong>å¤åˆ¶ç¼“å†²åŒº</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¦‚å¿µï¼šå¤åˆ¶ç¼“å†²åŒºï¼Œåˆåå¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨æœåŠ¡å™¨æ‰§è¡Œè¿‡çš„å‘½ä»¤ï¼Œæ¯æ¬¡ä¼ æ’­å‘½ä»¤ï¼Œmasteréƒ½ä¼šå°†ä¼ æ’­çš„å‘½ä»¤è®°å½•ä¸‹æ¥ï¼Œå¹¶å­˜å‚¨åœ¨å¤åˆ¶ç¼“å†²åŒº	å¤åˆ¶ç¼“å†²åŒºé»˜è®¤æ•°æ®å­˜å‚¨ç©ºé—´å¤§å°æ˜¯1M	å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œè€Œæ–°å…ƒç´ ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ä½œç”¨ï¼šç”¨äºä¿å­˜masteræ”¶åˆ°çš„æ‰€æœ‰æŒ‡ä»¤ï¼ˆä»…å½±å“æ•°æ®å˜æ›´çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚setï¼Œselectï¼‰æ•°æ®æ¥æºï¼šå½“masteræ¥æ”¶åˆ°ä¸»å®¢æˆ·ç«¯çš„æŒ‡ä»¤æ—¶ï¼Œé™¤äº†å°†æŒ‡ä»¤æ‰§è¡Œï¼Œä¼šå°†è¯¥æŒ‡ä»¤å­˜å‚¨åˆ°ç¼“å†²åŒºä¸­</span><br><span class="line">â€‹```![]()![]()</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>é»˜è®¤åˆ†ç±»</category>
      </categories>
      <tags>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼â€”â€”çŠ¶æ€æ¨¡å¼</title>
    <url>/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>åœ¨ä¸€äº›å¤æ‚çš„ä¸šåŠ¡å½“ä¸­ï¼Œæ¶‰åŠåˆ°æŸä¸ªä¸šåŠ¡æœ‰å¤šä¸ªçŠ¶æ€ï¼ŒæŒ‰ç…§ä¼ ç»Ÿå†™æ³•æ— éå°±æ˜¯<code>if else </code>ï¼Œå…¶å®è¿˜æ˜¯æœ‰ä¸€ç§æ¯”è¾ƒä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå°±æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„çŠ¶æ€æœºæ¨¡å¼ã€‚æ²¡æœ‰springä¹‹å‰è™½ç„¶ä¹Ÿèƒ½å®ç°çŠ¶æ€æœºæ¨¡å¼ï¼Œä½†æ˜¯å¹¶ä¸ä¼˜é›…ã€‚ä¸‹é¢æ¥è¯´ä¸€ä¸ªç”¨springbootæ¥å®ç°çŠ¶æ€æœºæ¨¡å¼çš„æ¡ˆä¾‹ã€‚</p>
<pre><code>  ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è®¢å•ï¼šè®¢å•å½“ä¸­æ¶‰åŠåˆ°å¤šä¸ªçŠ¶æ€çš„è·³è½¬ï¼Œæœ‰çš„æ—¶å€™è¿˜éœ€è¦å¯¹ä¿®æ”¹çŠ¶æ€å‰çš„é€»è¾‘è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™ç”¨çŠ¶æ€æœºæ¨¡å¼å°±æ˜¯å¾ˆå¥½çš„å®ç°ã€‚
</code></pre>
<h5 id="1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–"><a href="#1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–" class="headerlink" title="1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–"></a>1ã€å¼•å…¥éƒ¨åˆ†ä¾èµ–</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="ä¸»è¦çš„åŒ…ç»“æ„"><a href="#ä¸»è¦çš„åŒ…ç»“æ„" class="headerlink" title="ä¸»è¦çš„åŒ…ç»“æ„:"></a>ä¸»è¦çš„åŒ…ç»“æ„:</h5><p><img src="/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/Snipaste_2021-06-09_22-35-07-d55e4019a7c149b39de4eaa9e76a5e05.png" alt="Snipaste_20210609_223507.png"></p>
<h5 id="2ã€è®¢å•ç±»ï¼š"><a href="#2ã€è®¢å•ç±»ï¼š" class="headerlink" title="2ã€è®¢å•ç±»ï¼š"></a>2ã€è®¢å•ç±»ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:33</span></span><br><span class="line"><span class="comment"> * è®¢å•ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡‘é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çŠ¶æ€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»"><a href="#3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»" class="headerlink" title="3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»"></a>3ã€åˆ›å»ºè®¢å•çŠ¶æ€å¤„ç†è¶…ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:43</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€å¤„ç†è¶…ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderState</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸæ¥çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newOrder æ–°è®¢å•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldOrder è€è®¢å•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder,Order oldOrder)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»"><a href="#4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»" class="headerlink" title="4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»"></a>4ã€å„ä¸ªçŠ¶æ€å¤„ç†ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:46</span></span><br><span class="line"><span class="comment"> * è®¢å•å„çŠ¶æ€å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateCommon</span> <span class="keyword">implements</span> <span class="title class_">OrderState</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆæ—¥å¿—</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order è®¢å•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildOrderLog</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ä¿å­˜æ—¥å¿—è®¢å•çŠ¶æ€: &quot;</span> + order.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor1</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(oldOrder))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ä¸åšæ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:1 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor2</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:2 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:52</span></span><br><span class="line"><span class="comment"> * è®¢å•çŠ¶æ€: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(OrderStateFactory.ORDER_STATUS + 3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFor3</span> <span class="keyword">extends</span> <span class="title class_">OrderStateCommon</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Order newOrder, Order oldOrder)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¢å•çŠ¶æ€:3 å¤„ç†é€»è¾‘==&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿å­˜æ—¥å¿—</span></span><br><span class="line">        <span class="built_in">super</span>.buildOrderLog(newOrder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5ã€å·¥å‚ç±»"><a href="#5ã€å·¥å‚ç±»" class="headerlink" title="5ã€å·¥å‚ç±»"></a>5ã€å·¥å‚ç±»</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.bll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wenlinshan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStateFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰beanåå­—å‰ç¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_STATUS</span> <span class="operator">=</span> <span class="string">&quot;orderStatus&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨å…¥åˆ°å®¹å™¨é‡Œé¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Map&lt;String, OrderState&gt; states = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å¯¹åº”çŠ¶æ€çš„æ‰§è¡Œç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…·ä½“çŠ¶æ€çš„æ‰§è¡Œç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OrderState <span class="title function_">getState</span><span class="params">(Integer status)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (states.containsKey(ORDER_STATUS + status)) &#123;</span><br><span class="line">            <span class="keyword">return</span> states.get(ORDER_STATUS + status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æœªæ‰¾åˆ°æ‰§è¡ŒçŠ¶æ€çš„ç±»&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç "><a href="#6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç " class="headerlink" title="6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç "></a>6ã€ä¸»è¦çš„å…¥å£ç±»ä»£ç </h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.bll.OrderState;</span><br><span class="line"><span class="keyword">import</span> org.example.bll.OrderStateFactory;</span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.example.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 21:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IOrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderStateFactory factory;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveOrUpdateOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾å‡ºåŸæ¥çš„è®¢å•</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">oldOrder</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(order.getId());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(oldOrder)) &#123;</span><br><span class="line">            <span class="comment">//æ–°å¢</span></span><br><span class="line">            <span class="built_in">this</span>.save(order);</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(order.getStatus())) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨çŠ¶æ€æœº</span></span><br><span class="line">                factory.getState(order.getStatus()).handle(order,<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®æ”¹</span></span><br><span class="line">        <span class="type">OrderState</span> <span class="variable">orderState</span> <span class="operator">=</span> Objects.isNull(order.getStatus()) ? factory.getState(oldOrder.getStatus()) : factory.getState(order.getStatus());</span><br><span class="line">        orderState.handle(order,oldOrder);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å·²å®ç°ï¼Œä¸‹é¢å¼€å§‹æ¼”ç¤ºâ€˜</p>
<h5 id="7ã€æµ‹è¯•ç±»ï¼š"><a href="#7ã€æµ‹è¯•ç±»ï¼š" class="headerlink" title="7ã€æµ‹è¯•ç±»ï¼š"></a>7ã€æµ‹è¯•ç±»ï¼š</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.example.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 22:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOrder1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>, BigDecimal.ONE, <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        orderService.saveOrUpdateOrder(order);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="/2021/06/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/Snipaste_2021-06-09_22-44-33-75bd239201e04e57ae2fd7865222739e.png" alt="Snipaste_20210609_224433.png"></p>
]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
</search>
